<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Washportal (Alpha)</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:#121a2b;
      --muted:#91a4c7;
      --txt:#eaf2ff;
      --accent:#54d3ff;
      --ok:#36d399;
      --warn:#fbbf24;
      --bad:#fb7185;
      --line:rgba(255,255,255,.08);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 600px at 10% 10%, rgba(84,211,255,.12), transparent 60%),
                  radial-gradient(900px 500px at 90% 20%, rgba(54,211,153,.10), transparent 55%),
                  var(--bg);
      color:var(--txt);
    }
    header{
      padding:18px 16px 10px;
      border-bottom:1px solid var(--line);
      position:sticky;
      top:0;
      backdrop-filter: blur(10px);
      background: rgba(11,18,32,.78);
      z-index:10;
    }
    .wrap{max-width:980px;margin:0 auto;padding:0 16px}
    h1{margin:0;font-size:18px;font-weight:700;letter-spacing:.2px}
    .sub{margin-top:4px;color:var(--muted);font-size:13px}
    nav{
      display:flex;gap:8px;flex-wrap:wrap;
      margin-top:12px;
    }
    nav button{
      background: transparent;
      border:1px solid var(--line);
      color:var(--txt);
      padding:8px 10px;
      border-radius:12px;
      cursor:pointer;
      font-size:13px;
      transition:.15s;
    }
    nav button.active{
      border-color:rgba(84,211,255,.45);
      box-shadow:0 0 0 2px rgba(84,211,255,.14) inset;
      color:#cfefff;
    }
    main{padding:16px 0 60px}
    .grid{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap:12px;
    }
    @media (max-width: 900px){
      .grid{grid-template-columns:1fr}
    }
    .card{
      background: rgba(18,26,43,.92);
      border:1px solid var(--line);
      border-radius:18px;
      padding:14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.22);
    }
    .card h2{
      margin:0 0 10px;
      font-size:14px;
      color:#d7e6ff;
      letter-spacing:.2px;
    }
    label{display:block;color:var(--muted);font-size:12px;margin:10px 0 6px}
    input, select, textarea{
      width:100%;
      background: rgba(255,255,255,.04);
      border:1px solid var(--line);
      color:var(--txt);
      padding:10px 10px;
      border-radius:14px;
      outline:none;
      font-size:14px;
    }
    textarea{min-height:96px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .btn{
      width:100%;
      background: linear-gradient(135deg, rgba(84,211,255,.95), rgba(54,211,153,.92));
      border:none;
      color:#07101e;
      font-weight:800;
      padding:12px 12px;
      border-radius:14px;
      cursor:pointer;
      margin-top:12px;
      transition:.15s transform;
    }
    .btn:active{transform:translateY(1px)}
    .btn.secondary{
      background: transparent;
      border:1px solid var(--line);
      color:var(--txt);
      font-weight:700;
    }
    .pill{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border:1px solid var(--line);
      border-radius:999px;font-size:12px;color:var(--muted)
    }
    .small{font-size:12px;color:var(--muted);line-height:1.45}
    .list{display:flex;flex-direction:column;gap:10px}
    .item{
      padding:12px;border:1px solid var(--line);
      border-radius:16px;
      background: rgba(255,255,255,.03);
    }
    .itemTop{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .title{font-weight:800;font-size:14px}
    .meta{font-size:12px;color:var(--muted);margin-top:4px}
    .tag{
      font-size:11px;padding:4px 8px;border-radius:999px;
      border:1px solid var(--line);
      color:var(--muted);
      white-space:nowrap;
    }
    .tag.ok{border-color:rgba(54,211,153,.35);color:#aaf3d7}
    .tag.warn{border-color:rgba(251,191,36,.35);color:#ffe7a2}
    .tag.bad{border-color:rgba(251,113,133,.35);color:#ffc4cf}
    .toast{
      position:fixed;
      bottom:14px;left:50%;transform:translateX(-50%);
      background: rgba(18,26,43,.96);
      border:1px solid var(--line);
      padding:10px 12px;
      border-radius:14px;
      box-shadow: 0 10px 40px rgba(0,0,0,.35);
      max-width:min(92vw,640px);
      display:none;
      z-index:999;
      font-size:13px;
      color:#dcecff;
    }
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;}
    .split{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Washportal <span class="pill">Alpha</span></h1>
      <div class="sub">Buchen • Overbooking-Schutz • Trockner • News • Feedback</div>
      <nav id="tabs"></nav>
    </div>
  </header>

  <main class="wrap">
    <section id="view"></section>
  </main>

  <div id="toast" class="toast"></div>

<script>
/**
 * ✅ SET THIS:
 * Your worker base URL (no trailing slash)
 */
const WORKER_BASE = "https://washportal-dev-worker.schluffi1220.workers.dev";

/** Alpha machine config */
const MACHINES = {
  washer: ["W1","W2","W3","W4","W5","W6"],
  dryer: ["D1","D2"],
};

const DURATIONS = {
  washer: [30, 45, 60, 75, 90],
  dryer: [15, 30, 45, 60],
};

const $ = (sel) => document.querySelector(sel);
const el = (tag, attrs={}, children=[]) => {
  const n = document.createElement(tag);
  for (const [k,v] of Object.entries(attrs || {})) {
    if (k === "class") n.className = v;
    else if (k === "html") n.innerHTML = v;
    else if (k.startsWith("on") && typeof v === "function") n.addEventListener(k.slice(2), v);
    else n.setAttribute(k, v);
  }
  for (const c of children) n.appendChild(typeof c === "string" ? document.createTextNode(c) : c);
  return n;
};

function toast(msg){
  const t = $("#toast");
  t.textContent = msg;
  t.style.display = "block";
  clearTimeout(window.__toastTimer);
  window.__toastTimer = setTimeout(()=> t.style.display="none", 3200);
}

function pad2(n){return String(n).padStart(2,"0");}

function epochFromLocal(dateStr, timeStr){
  // local time → epoch seconds
  const d = new Date(`${dateStr}T${timeStr}:00`);
  return Math.floor(d.getTime()/1000);
}

function fmtLocal(ts){
  const d = new Date(ts*1000);
  return `${pad2(d.getDate())}.${pad2(d.getMonth()+1)}.${d.getFullYear()} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
}

async function api(path, opts={}){
  const res = await fetch(`${WORKER_BASE}${path}`, {
    ...opts,
    headers: {"Content-Type":"application/json", ...(opts.headers||{})}
  });
  const data = await res.json().catch(()=> ({}));
  if (!res.ok) {
    const err = data?.error || `HTTP_${res.status}`;
    throw {status: res.status, err, data};
  }
  return data;
}

function getName(){
  return localStorage.getItem("washportal_name") || "";
}
function setName(v){
  localStorage.setItem("washportal_name", (v||"").trim());
}

const TABS = [
  {id:"book", label:"Buchen"},
  {id:"dryer", label:"Trockner"},
  {id:"mine", label:"Meine Buchungen"},
  {id:"news", label:"News"},
  {id:"feedback", label:"Feedback"},
];

let activeTab = "book";

function renderTabs(){
  const nav = $("#tabs");
  nav.innerHTML = "";
  for (const t of TABS){
    nav.appendChild(el("button", {
      class: t.id === activeTab ? "active" : "",
      onclick: () => { activeTab = t.id; render(); }
    }, [t.label]));
  }
}

function viewCard(title, inner){
  return el("div",{class:"card"}, [
    el("h2",{},[title]),
    inner
  ]);
}

/* ------------------------------
   BOOKING UI (washer/dryer shared)
--------------------------------*/
function bookingForm(machine_type){
  const nameInput = el("input",{value:getName(), placeholder:"Dein Name (z.B. Max)"});
  const dateInput = el("input",{type:"date", value: new Date().toISOString().slice(0,10)});
  const timeInput = el("input",{type:"time", value:"18:00"});
  const machineSel = el("select",{});
  const durationSel = el("select",{});
  const notesInput = el("input",{placeholder:"Notiz (optional) z.B. 'Bettwäsche'"});

  for (const m of MACHINES[machine_type]){
    machineSel.appendChild(el("option",{value:m},[m]));
  }
  for (const mins of DURATIONS[machine_type]){
    durationSel.appendChild(el("option",{value:String(mins)},[`${mins} min`]));
  }

  const availBox = el("div",{class:"small", html:"<span class='mono'>Lade Belegung…</span>"});

  async function refreshAvail(){
    try{
      const date = dateInput.value;
      const a = await api(`/api/availability?date=${encodeURIComponent(date)}&type=${encodeURIComponent(machine_type)}`);
      const b = a.bookings?.[machineSel.value] || [];
      if (b.length === 0){
        availBox.innerHTML = `<span class="tag ok">Frei</span> <span class="mono">${machineSel.value}</span> hat heute keine Buchungen.`;
        return;
      }
      const lines = b.map(x => {
        return `<div class="mono">• ${fmtLocal(x.start_ts)} – ${fmtLocal(x.end_ts)} (${x.user_name})</div>`;
      }).join("");
      availBox.innerHTML = `<div class="tag warn">Belegt</div><div style="height:6px"></div>${lines}`;
    }catch(e){
      availBox.innerHTML = `<span class="tag bad">Fehler</span> Konnte Belegung nicht laden.`;
    }
  }

  machineSel.addEventListener("change", refreshAvail);
  dateInput.addEventListener("change", refreshAvail);

  const submit = el("button",{class:"btn"},[`Buchung speichern (${machine_type === "washer" ? "Waschmaschine" : "Trockner"})`]);

  submit.addEventListener("click", async () => {
    const user_name = nameInput.value.trim();
    if (!user_name){ toast("Bitte Name eintragen."); return; }
    setName(user_name);

    const dateStr = dateInput.value;
    const timeStr = timeInput.value;
    const start_ts = epochFromLocal(dateStr, timeStr);
    const mins = Number(durationSel.value);
    const end_ts = start_ts + mins*60;

    const payload = {
      user_name,
      machine_type,
      machine_id: machineSel.value,
      start_ts,
      end_ts,
      notes: notesInput.value.trim() || null,
    };

    submit.disabled = true;
    submit.textContent = "Speichere…";

    try{
      const r = await api("/api/bookings", {method:"POST", body: JSON.stringify(payload)});
      toast(`✅ Gespeichert! ID: ${r.id}`);
      await refreshAvail();
    }catch(e){
      if (e.status === 409 && e.data?.conflicts?.length){
        const c = e.data.conflicts[0];
        toast(`⛔ Overbooking: Konflikt mit ${c.user_name} (${fmtLocal(c.start_ts)}–${fmtLocal(c.end_ts)})`);
      }else{
        toast(`⛔ Fehler: ${e.err}`);
      }
    }finally{
      submit.disabled = false;
      submit.textContent = `Buchung speichern (${machine_type === "washer" ? "Waschmaschine" : "Trockner"})`;
    }
  });

  const left = el("div",{},[
    el("div",{class:"row"},[
      el("div",{},[el("label",{},["Name"]), nameInput]),
      el("div",{},[el("label",{},["Gerät"]), machineSel]),
    ]),
    el("div",{class:"row"},[
      el("div",{},[el("label",{},["Datum"]), dateInput]),
      el("div",{},[el("label",{},["Startzeit"]), timeInput]),
    ]),
    el("div",{class:"row"},[
      el("div",{},[el("label",{},["Dauer"]), durationSel]),
      el("div",{},[el("label",{},["Notiz"]), notesInput]),
    ]),
    submit,
    el("div",{class:"small", style:"margin-top:10px"},[
      "Hinweis: Overbooking ist blockiert (du bekommst einen Konflikt-Fehler, wenn es Überschneidungen gibt)."
    ])
  ]);

  const right = el("div",{},[
    el("div",{class:"small"},["Belegung für das ausgewählte Gerät:"]),
    el("div",{style:"height:8px"}),
    el("div",{class:"item"},[availBox]),
    el("div",{class:"split"},[
      el("button",{class:"btn secondary", onclick: refreshAvail},["Belegung aktualisieren"]),
      el("button",{class:"btn secondary", onclick: async ()=>{
        timeInput.value = "18:00";
        durationSel.value = String(DURATIONS[machine_type][0]);
        notesInput.value = "";
        await refreshAvail();
        toast("Form zurückgesetzt.");
      }},["Reset"])
    ])
  ]);

  // initial
  setTimeout(refreshAvail, 0);

  return el("div",{class:"grid"},[
    viewCard(machine_type === "washer" ? "Waschmaschine buchen" : "Trockner buchen", left),
    viewCard("Live-Belegung", right),
  ]);
}

/* ------------------------------
   MY BOOKINGS
--------------------------------*/
async function renderMine(){
  const name = getName();
  const nameInput = el("input",{value:name, placeholder:"Dein Name (gleich wie beim Buchen)"});
  const loadBtn = el("button",{class:"btn secondary"},["Laden"]);
  const list = el("div",{class:"list"});

  async function load(){
    const n = nameInput.value.trim();
    if (!n){ toast("Bitte Name eintragen."); return; }
    setName(n);
    list.innerHTML = "<div class='small mono'>Lade…</div>";

    try{
      const r = await api(`/api/my-bookings?name=${encodeURIComponent(n)}`);
      const rows = r.bookings || [];
      if (rows.length === 0){
        list.innerHTML = `<div class="item"><div class="small">Keine Buchungen gefunden.</div></div>`;
        return;
      }

      list.innerHTML = "";
      for (const b of rows){
        const tagClass = b.status === "active" ? "ok" : "bad";
        const tagText = b.status === "active" ? "aktiv" : "storniert";

        const cancelBtn = el("button",{class:"btn secondary", style:"margin-top:10px"},["Stornieren"]);
        cancelBtn.disabled = b.status !== "active";

        cancelBtn.addEventListener("click", async ()=>{
          cancelBtn.disabled = true;
          cancelBtn.textContent = "Storniere…";
          try{
            await api("/api/cancel-booking", {
              method:"POST",
              body: JSON.stringify({id: b.id, user_name: n})
            });
            toast("✅ Storniert.");
            await load();
          }catch(e){
            toast(`⛔ Fehler: ${e.err}`);
          }finally{
            cancelBtn.textContent = "Stornieren";
          }
        });

        list.appendChild(el("div",{class:"item"},[
          el("div",{class:"itemTop"},[
            el("div",{},[
              el("div",{class:"title"},[
                `${b.machine_type === "washer" ? "Waschmaschine" : "Trockner"} ${b.machine_id} `,
              ]),
              el("div",{class:"meta mono"},[
                `${fmtLocal(b.start_ts)} → ${fmtLocal(b.end_ts)}`
              ]),
              b.notes ? el("div",{class:"meta"},[`Notiz: ${b.notes}`]) : el("div",{}),
            ]),
            el("div",{class:`tag ${tagClass}`},[tagText]),
          ]),
          cancelBtn
        ]));
      }

    }catch(e){
      list.innerHTML = `<div class="item"><div class="small">Fehler: ${e.err}</div></div>`;
    }
  }

  loadBtn.addEventListener("click", load);

  return el("div",{class:"grid"},[
    viewCard("Meine Buchungen", el("div",{},[
      el("label",{},["Name"]),
      nameInput,
      loadBtn,
      el("div",{style:"height:10px"}),
      el("div",{class:"small"},[
        "Stornieren geht nur mit dem gleichen Namen, mit dem du gebucht hast."
      ]),
    ])),
    viewCard("Liste", list),
  ]);
}

/* ------------------------------
   NEWS
--------------------------------*/
async function renderNews(){
  const box = el("div",{class:"list"},[
    el("div",{class:"small mono"},["Lade News…"])
  ]);

  try{
    const r = await api("/api/news");
    const news = r.news || [];
    if (news.length === 0){
      box.innerHTML = `<div class="item"><div class="small">Keine News vorhanden.</div></div>`;
      return viewCard("News", box);
    }
    box.innerHTML = "";
    for (const n of news){
      box.appendChild(el("div",{class:"item"},[
        el("div",{class:"itemTop"},[
          el("div",{},[
            el("div",{class:"title"},[n.title]),
            el("div",{class:"meta"},[new Date(n.created_at).toLocaleString()]),
          ]),
          n.pinned ? el("div",{class:"tag warn"},["PIN"]) : el("div",{class:"tag"},[""])
        ]),
        el("div",{class:"meta", style:"margin-top:8px;white-space:pre-wrap"},[n.body])
      ]));
    }
  }catch(e){
    box.innerHTML = `<div class="item"><div class="small">Fehler: ${e.err}</div></div>`;
  }

  return viewCard("News", box);
}

/* ------------------------------
   FEEDBACK
--------------------------------*/
function renderFeedback(){
  const nameInput = el("input",{value:getName(), placeholder:"Dein Name (optional)"});
  const ratingSel = el("select",{});
  for (let i=5;i>=1;i--){
    ratingSel.appendChild(el("option",{value:String(i)},[`${i} / 5`]));
  }
  const msg = el("textarea",{placeholder:"Was läuft gut? Was nervt? Was fehlt noch?"});
  const send = el("button",{class:"btn"},["Feedback senden"]);

  send.addEventListener("click", async ()=>{
    const payload = {
      user_name: nameInput.value.trim() || null,
      rating: Number(ratingSel.value),
      message: msg.value.trim()
    };
    if (!payload.message){ toast("Bitte Nachricht schreiben."); return; }
    if (payload.user_name) setName(payload.user_name);

    send.disabled = true;
    send.textContent = "Sende…";
    try{
      const r = await api("/api/feedback",{method:"POST", body: JSON.stringify(payload)});
      toast(`✅ Danke! Feedback-ID: ${r.id}`);
      msg.value = "";
    }catch(e){
      toast(`⛔ Fehler: ${e.err}`);
    }finally{
      send.disabled = false;
      send.textContent = "Feedback senden";
    }
  });

  return el("div",{class:"grid"},[
    viewCard("Feedback", el("div",{},[
      el("label",{},["Name (optional)"]),
      nameInput,
      el("label",{},["Bewertung"]),
      ratingSel,
      el("label",{},["Nachricht"]),
      msg,
      send,
      el("div",{class:"small", style:"margin-top:10px"},[
        "Feedback landet direkt in der D1-Datenbank (Tabelle: feedback)."
      ])
    ])),
    viewCard("Was ist neu im Alpha?", el("div",{},[
      el("div",{class:"item"},[
        el("div",{class:"title"},["✅ Overbooking-Schutz"]),
        el("div",{class:"meta"},["Buchungen mit Überschneidung werden blockiert (409)."])
      ]),
      el("div",{class:"item"},[
        el("div",{class:"title"},["✅ News"]),
        el("div",{class:"meta"},["Aktuelle Infos aus der Tabelle 'news'."])
      ]),
      el("div",{class:"item"},[
        el("div",{class:"title"},["✅ Trockner integriert"]),
        el("div",{class:"meta"},["Buchen & Live-Belegung wie bei Waschmaschinen."])
      ]),
    ])),
  ]);
}

/* ------------------------------
   Main render
--------------------------------*/
async function render(){
  renderTabs();
  const v = $("#view");
  v.innerHTML = "";

  if (activeTab === "book"){
    v.appendChild(bookingForm("washer"));
    return;
  }

  if (activeTab === "dryer"){
    v.appendChild(bookingForm("dryer"));
    return;
  }

  if (activeTab === "mine"){
    v.appendChild(await renderMine());
    return;
  }

  if (activeTab === "news"){
    v.appendChild(await renderNews());
    return;
  }

  if (activeTab === "feedback"){
    v.appendChild(renderFeedback());
    return;
  }
}

(async function boot(){
  try{
    const s = await api("/api/_status?ts="+Date.now());
    console.log("Worker status:", s);
  }catch(e){
    console.warn("Worker not reachable:", e);
    toast("⚠️ Worker nicht erreichbar. Prüfe WORKER_BASE in index.html");
  }
  render();
})();
</script>
</body>
</html>
