<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Washportal DEV</title>
  <style>
    :root{
      --bg:#fff; --card:#f7f7f7; --border:#ddd; --text:#111; --muted:#666;
      --green:#22c55e; --blue:#3b82f6; --red:#ef4444; --gray:#9ca3af;
      --btn:#111; --btnText:#fff;

      --pFree: rgba(34,197,94,.18);
      --pBusy: rgba(59,130,246,.18);
      --pDef:  rgba(239,68,68,.18);
      --pNeutral: rgba(156,163,175,.12);

      --bFree: rgba(34,197,94,.55);
      --bBusy: rgba(59,130,246,.55);
      --bDef:  rgba(239,68,68,.55);
      --bNeutral: rgba(156,163,175,.45);
    }

    body{font-family:system-ui,Arial,sans-serif;margin:14px;max-width:1100px;color:var(--text);background:var(--bg)}
    h1{margin:0 0 6px 0}
    .sub{margin:0 0 12px 0;color:var(--muted)}
    .bar{border:1px solid var(--border);border-radius:14px;padding:10px;background:var(--card);margin:10px 0}
    .bar.ok{background:#eaffea;border-color:#a6e3a6}
    .bar.err{background:#ffecec;border-color:#f2b3b3}
    .card{border:1px solid var(--border);border-radius:14px;padding:12px;background:var(--card);margin:12px 0}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:700px){.row{grid-template-columns:1fr}}
    label{display:block;margin:8px 0 4px;color:var(--muted);font-size:13px}
    input,select,button,textarea{font-size:16px;padding:10px;border-radius:12px;border:1px solid var(--border);width:100%;box-sizing:border-box}
    button{cursor:pointer;background:var(--btn);color:var(--btnText);border-color:var(--btn)}
    button:disabled{opacity:.45;cursor:not-allowed}
    .muted{color:var(--muted);font-size:13px}
    .small{font-size:12px;color:var(--muted)}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .btn2{width:auto;padding:10px 14px}
    .ghost{background:#fff;color:#111;border-color:var(--border)}

    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    @media (max-width:700px){.grid{grid-template-columns:1fr}}

    .mcard{border:2px solid var(--border);border-radius:16px;padding:12px;background:#fff;}
    .mcard.free{background:var(--pFree); border-color: var(--bFree);}
    .mcard.busy{background:var(--pBusy); border-color: var(--bBusy);}
    .mcard.def{ background:var(--pDef);  border-color: var(--bDef);}
    .mcard.neutral{background:var(--pNeutral); border-color: var(--bNeutral);}

    .mhead{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:flex-start}
    .mtitle{font-weight:900}
    .badge{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);border-radius:999px;padding:4px 10px;font-size:12px;background:#fff}
    .dot{width:14px;height:14px;border-radius:999px;background:var(--gray)}
    .dot.free{background:var(--green)}
    .dot.busy{background:var(--blue)}
    .dot.def{background:var(--red)}
    .line{margin-top:8px;color:var(--muted);font-size:13px}
    .mactions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .mbtn{width:auto}
    .danger{background:var(--red);border-color:var(--red)}
    .info{background:var(--blue);border-color:var(--blue)}
    .okbtn{background:var(--green);border-color:var(--green)}

    .warn{
      display:inline-block;
      margin-top:6px;
      font-size:12px;
      font-weight:900;
      color:#8a1200;
      background:rgba(239,68,68,.18);
      border:1px solid rgba(239,68,68,.55);
      padding:3px 10px;
      border-radius:999px;
    }

    .bcard{border:2px solid var(--border);border-radius:14px;padding:12px;margin:8px 0;background:#fff;}
    .bcard.green{background:var(--pFree); border-color: var(--bFree);}
    .bcard.blue{ background:var(--pBusy); border-color: var(--bBusy);}
    .bcard.red{  background:var(--pDef);  border-color: var(--bDef);}
    .bcard.gray{ background:var(--pNeutral); border-color: var(--bNeutral);}

    .bhead{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}

    .logrow{border-top:1px solid var(--border);padding:10px 0}
    .logrow:first-child{border-top:none}
  </style>
</head>
<body>

<h1>Washportal – DEV</h1>
<p class="sub">1 Zugang → 2 Slot-Dropdown → 3 Maschinenübersicht → 4 Meine Buchungen → 5 Feedback → 6 Admin</p>

<div id="statusBox" class="bar">Bereit.</div>

<div class="card">
  <h2>1) Zugang</h2>
  <div class="row">
    <div>
      <label>Zimmernummer (0–400)</label>
      <input id="room" inputmode="numeric" placeholder="z.B. 316">
    </div>
    <div>
      <label>PIN (4–12 Ziffern)</label>
      <input id="pin" type="password" inputmode="numeric" placeholder="z.B. 1234">
    </div>
  </div>
  <label>Stations-PIN (4-stellig)</label>
  <input id="stationPin" type="password" inputmode="numeric" placeholder="z.B. 1111">
  <div class="actions">
    <button id="btnRefresh" class="btn2">Aktualisieren</button>
  </div>
</div>

<div class="card">
  <h2>2) Slots buchen</h2>
  <label>Slots (Waschmaschinen)</label>
  <select id="slotSelect">
    <option value="">Bitte erst aktualisieren…</option>
  </select>
  <div class="actions">
    <button id="btnBook" class="btn2">Buchen</button>
  </div>
</div>

<div class="card">
  <h2>3) Maschinenübersicht</h2>
  <div id="machinesHint" class="muted">Wird nach „Aktualisieren“ geladen.</div>
  <h3 style="margin:10px 0 6px 0;">Waschmaschinen</h3>
  <div id="washers" class="grid"></div>
  <h3 style="margin:12px 0 6px 0;">Trockner</h3>
  <div id="dryers" class="grid"></div>
</div>

<div class="card">
  <h2>4) Meine Buchungen</h2>
  <div class="actions">
    <button id="btnMy" class="btn2">Meine Buchungen aktualisieren</button>
  </div>
  <div id="myBookings" class="muted" style="margin-top:10px;">Noch nicht geladen.</div>
</div>

<div class="card">
  <h2>5) Feedback / Antworten</h2>
  <div class="muted">Kommt als nächster Schritt (Chat + Antworten + gelesen Status).</div>
</div>

<div class="card">
  <h2>6) Admin</h2>

  <label>Admin Passwort</label>
  <input id="adminPw" type="password" placeholder="z.B. initial">

  <div class="actions">
    <button id="btnAdminLogin" class="btn2">Admin Login</button>
    <button id="btnAdminReload" class="btn2 ghost" disabled>Admin Daten laden</button>
  </div>

  <div id="adminBox" class="muted" style="margin-top:10px;">Noch nicht eingeloggt.</div>

  <div id="adminControls" style="display:none;margin-top:12px;">
    <h3 style="margin:10px 0 6px 0;">Stations-PIN</h3>
    <label>Neue Stations-PIN (4-stellig)</label>
    <input id="adminStationPin" type="password" inputmode="numeric" placeholder="1111">
    <div class="actions">
      <button id="btnSaveStationPin" class="btn2">Stations-PIN speichern</button>
    </div>

    <h3 style="margin:14px 0 6px 0;">Tage-Fenster</h3>
    <div class="row">
      <div>
        <label>Vergangene Tage (daysPast)</label>
        <input id="daysPast" inputmode="numeric" placeholder="z.B. 1">
      </div>
      <div>
        <label>Folgende Tage (daysFuture)</label>
        <input id="daysFuture" inputmode="numeric" placeholder="z.B. 6">
      </div>
    </div>
    <div class="actions">
      <button id="btnSaveDays" class="btn2">Speichern</button>
    </div>

    <h3 style="margin:14px 0 6px 0;">Admin Passwort ändern</h3>
    <label>Neues Admin Passwort</label>
    <input id="newAdminPw" type="password" placeholder="mind. 6 Zeichen">
    <label>Neues Passwort bestätigen</label>
    <input id="newAdminPw2" type="password" placeholder="nochmal eingeben">
    <div class="actions">
      <button id="btnChangeAdminPw" class="btn2">Passwort ändern</button>
    </div>

    <h3 style="margin:14px 0 6px 0;">Logs</h3>
    <div class="actions">
      <button id="btnLoadLogs" class="btn2 ghost">Logs laden</button>
    </div>
    <div id="logsBox" class="muted" style="margin-top:10px;">Noch keine Logs geladen.</div>
  </div>
</div>

<script>
  const API_BASE = "https://washportal-dev-worker.schluffi1220.workers.dev";
  const $ = (id) => document.getElementById(id);

  let cachedWasherSlots = [];
  let cachedStatus = null;
  let adminOk = false;

  function setStatus(msg, ok=true){
    const el = $("statusBox");
    el.className = "bar " + (ok ? "ok" : "err");
    el.textContent = msg;
  }

  async function jget(path){
    const r = await fetch(API_BASE + path, { cache:"no-store" });
    const data = await r.json().catch(()=>({ok:false,error:"bad_json"}));
    return { r, data };
  }
  async function jpost(path, body){
    const r = await fetch(API_BASE + path, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(body||{}),
      cache:"no-store"
    });
    const data = await r.json().catch(()=>({ok:false,error:"bad_json"}));
    return { r, data };
  }

  function accessPayload(){
    return {
      room: $("room").value.trim(),
      pin: $("pin").value.trim(),
      stationPin: $("stationPin").value.trim()
    };
  }

  function pad(n){ return String(n).padStart(2,"0"); }
  function fmtSlot(start, end){
    const a = new Date(start), b = new Date(end);
    const ddmmyy = `${pad(a.getDate())}.${pad(a.getMonth()+1)}.${String(a.getFullYear()).slice(-2)}`;
    const t1 = `${pad(a.getHours())}:${pad(a.getMinutes())}`;
    const t2 = `${pad(b.getHours())}:${pad(b.getMinutes())}`;
    return `${ddmmyy} ${t1}–${t2}`;
  }
  function msToHMS(ms){
    const s = Math.max(0, Math.floor(ms/1000));
    const h = Math.floor(s/3600);
    const m = Math.floor((s%3600)/60);
    return h>0 ? `${h}h ${m}m` : `${m}m`;
  }
  function fmtLogTs(ts){
    const d = new Date(Number(ts));
    return `${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  function isMachineDefect(type, machine){
    const list = (cachedStatus && cachedStatus.machines) ? cachedStatus.machines : [];
    const m = list.find(x => x.type===type && Number(x.machine)===Number(machine));
    return m ? Number(m.defect)===1 : false;
  }

  function rebuildSlotDropdown(){
    const sel = $("slotSelect");
    sel.innerHTML = "";
    const now = Date.now();

    const items = [];
    for (const s of cachedWasherSlots) {
      for (const pm of (s.perMachine || [])) {
        const isPast = Number(s.end) <= now;
        const state = isPast ? "abgelaufen" : (pm.defect ? "defekt" : (pm.booked ? "belegt" : "frei"));
        const disabled = (state !== "frei");
        items.push({
          label: `${fmtSlot(s.start, s.end)} · Waschmaschine ${pm.machine} · ${state}`,
          disabled,
          payload: { start:s.start, end:s.end, machine:pm.machine }
        });
      }
    }

    if (!items.length) {
      sel.innerHTML = `<option value="">Keine Slots verfügbar</option>`;
      return;
    }

    sel.appendChild(new Option("Bitte auswählen…", ""));
    items.forEach((it, idx) => {
      const opt = new Option(it.label, String(idx));
      opt.disabled = it.disabled;
      sel.appendChild(opt);
    });
    sel._items = items;
  }

  async function bookSelected(){
    const sel = $("slotSelect");
    const idx = Number(sel.value);
    if (!sel.value || !sel._items || !sel._items[idx]) {
      alert("Bitte einen freien Slot auswählen.");
      return;
    }
    const it = sel._items[idx];
    if (it.disabled) {
      alert("Dieser Slot ist nicht buchbar.");
      return;
    }

    const p = accessPayload();
    const {data} = await jpost("/api/washer/book", { ...p, ...it.payload });

    if (!data.ok) {
      setStatus("Buchen fehlgeschlagen: " + (data.message || data.error), false);
      alert(JSON.stringify(data, null, 2));
      return;
    }

    alert(`Gebucht: Waschmaschine ${data.machine}`);
    await refreshAll();
  }

  async function cancelBooking(id){
    const p = accessPayload();
    const {data} = await jpost("/api/booking/cancel", { ...p, id });
    if (!data.ok) { alert(JSON.stringify(data,null,2)); return; }
    await refreshAll();
  }

  async function releaseBooking(id){
    const p = accessPayload();
    const {data} = await jpost("/api/booking/release", { ...p, id });
    if (!data.ok) { alert(JSON.stringify(data,null,2)); return; }
    await refreshAll();
  }

  async function setDefect(type, machine, defect){
    const p = accessPayload();
    const {data} = await jpost("/api/machine/set-defect", { ...p, type, machine, defect });
    if (!data.ok) { alert(JSON.stringify(data,null,2)); return; }
    await refreshAll();
  }

  async function loadMyBookings(){
    const p = accessPayload();
    const {data} = await jpost("/api/my-bookings", p);
    if (!data.ok) { alert(JSON.stringify(data,null,2)); return; }

    const list = data.bookings || [];

    if (!list.length) {
      $("myBookings").innerHTML = `<div class="muted">Keine aktiven Buchungen gefunden.</div>`;
      return;
    }

    const now = Date.now();

    $("myBookings").innerHTML = list.map(b=>{
      const start = Number(b.start);
      const end = Number(b.end);

      const active  = (start <= now && now < end);
      const future  = (now < start);
      const expired = (end <= now);

      const defect = isMachineDefect(b.type, b.machine);

      // ✅ HARTE Farben: rot > blau > grün > grau
      let color = "green";
      if (defect) color = "red";
      else if (active) color = "blue";
      else if (expired) color = "gray";
      else color = "green";

      const title = `${b.type==="washer"?"Waschmaschine":"Trockner"} ${b.machine}`;
      const time = fmtSlot(start, end);
      const left = active ? ` · Rest: ${msToHMS(end-now)}` : "";

      let flags = "";
      if (defect) flags = `<div class="warn">⚠️ Maschine ist defekt</div>`;

      let buttons = "";
      if (future) {
        buttons = `<button class="btn2 ghost" onclick="cancelBooking('${b.id}')">Stornieren</button>`;
      } else if (active) {
        buttons = `<button class="btn2" style="background:#3b82f6;border-color:#3b82f6" onclick="releaseBooking('${b.id}')">Freigeben</button>`;
      } else if (expired) {
        buttons = `<button class="btn2 ghost" disabled>Abgelaufen</button>`;
      }

      return `
        <div class="bcard ${color}">
          <div class="bhead">
            <div>
              <b>${title}</b>
              ${flags}
            </div>
            <div class="muted">${time}${left}</div>
          </div>
          <div class="actions">${buttons}</div>
        </div>
      `;
    }).join("");
  }

  function renderMachines(){
    if (!cachedStatus || !cachedStatus.ok) return;

    const now = Date.now();
    const machines = cachedStatus.machines || [];
    const bookings = (cachedStatus.bookings || []).filter(b => b.status === "booked");

    function activeBooking(type, machine){
      return bookings.find(b =>
        b.type===type &&
        Number(b.machine)===Number(machine) &&
        now>=Number(b.start) && now<Number(b.end)
      );
    }

    function cardHTML(m){
      const type = m.type;
      const machine = m.machine;
      const defect = Number(m.defect)===1;
      const enabled = Number(m.enabled)===1;
      const active = (!defect && enabled) ? activeBooking(type, machine) : null;

      let stateClass = "free";
      let dotCls = "dot free";
      let badgeText = "frei";

      if (!enabled) { stateClass="neutral"; dotCls="dot bus"; badgeText="gesperrt"; }
      else if (defect) { stateClass="def"; dotCls="dot def"; badgeText="defekt"; }
      else if (active) { stateClass="busy"; dotCls="dot busy"; badgeText="belegt"; }

      let line1 = "";
      if (!enabled) line1 = `Maschine gesperrt.`;
      else if (defect) line1 = `Defekt gemeldet von: ${m.defectBy || "-"}`;
      else if (active) line1 = `Belegt von Zimmer ${active.room} · Rest: ${msToHMS(Number(active.end)-now)}`;
      else line1 = `Frei · zuletzt: ${m.lastRoom ? ("Zimmer " + m.lastRoom) : "-"}`;

      const btns = [];
      if (enabled) {
        if (!defect) btns.push(`<button class="mbtn danger" onclick="setDefect('${type}',${machine},true)">Defekt melden</button>`);
        else btns.push(`<button class="mbtn okbtn" onclick="setDefect('${type}',${machine},false)">Defekt freigeben</button>`);
      }
      if (active && active.room === $("room").value.trim()) {
        btns.push(`<button class="mbtn info" onclick="releaseBooking('${active.id}')">Freigeben</button>`);
      }

      return `
        <div class="mcard ${stateClass}">
          <div class="mhead">
            <div>
              <div class="mtitle">${type==="washer"?"Waschmaschine":"Trockner"} ${machine}</div>
              <div class="line">${line1}</div>
            </div>
            <div class="badge"><span class="${dotCls}"></span>${badgeText}</div>
          </div>
          <div class="mactions">${btns.join("") || `<span class="muted">—</span>`}</div>
        </div>
      `;
    }

    $("machinesHint").textContent = "OK geladen.";
    $("washers").innerHTML = machines.filter(m=>m.type==="washer").map(cardHTML).join("") || `<div class="muted">Keine Waschmaschinen.</div>`;
    $("dryers").innerHTML  = machines.filter(m=>m.type==="dryer").map(cardHTML).join("")  || `<div class="muted">Keine Trockner.</div>`;
  }

  async function refreshAll(){
    setStatus("Aktualisiere…", true);
    const p = accessPayload();

    const a = await jpost("/api/washer/free-slots", p);
    if (!a.data.ok) { setStatus("Fehler Slots", false); alert(JSON.stringify(a.data,null,2)); return; }
    cachedWasherSlots = a.data.slots || [];
    rebuildSlotDropdown();

    const s = await jget("/api/status");
    cachedStatus = s.data;
    if (!cachedStatus.ok) { setStatus("Fehler Status", false); alert(JSON.stringify(cachedStatus,null,2)); return; }

    await loadMyBookings();
    renderMachines();
    setStatus("Bereit.", true);
  }

  // ---------- ADMIN ----------
  function adminPassword(){ return $("adminPw").value.trim(); }

  async function adminLogin(){
    const pw = adminPassword();
    const {data} = await jpost("/api/admin/login", { adminPassword: pw });
    if (!data.ok) { alert(JSON.stringify(data,null,2)); return; }
    adminOk = true;
    $("btnAdminReload").disabled = false;
    $("adminControls").style.display = "block";
    $("adminBox").innerHTML = `<b>Admin Login ok ✅</b>`;
    await adminReload();
  }

  async function adminReload(){
    if (!adminOk) return;
    const pw = adminPassword();
    const {data} = await jpost("/api/admin/get-config", { adminPassword: pw });
    if (!data.ok) { alert(JSON.stringify(data,null,2)); return; }
    $("daysPast").value = data.config.daysPast ?? 1;
    $("daysFuture").value = data.config.daysFuture ?? 6;
    $("adminBox").innerHTML = `<b>Admin Daten geladen ✅</b>`;
  }

  async function saveStationPin(){
    if (!adminOk) return alert("Bitte erst Admin Login.");
    const pw = adminPassword();
    const sp = $("adminStationPin").value.trim();
    if (!confirm("Stations-PIN wirklich speichern?")) return;
    const {data} = await jpost("/api/admin/set-station-pin", { adminPassword: pw, stationPin: sp });
    if (!data.ok) return alert(JSON.stringify(data,null,2));
    alert("Stations-PIN gespeichert ✅");
  }

  async function saveDays(){
    if (!adminOk) return alert("Bitte erst Admin Login.");
    const pw = adminPassword();
    const dp = Number($("daysPast").value);
    const df = Number($("daysFuture").value);
    if (!confirm("Tage-Fenster wirklich speichern?")) return;
    const {data} = await jpost("/api/admin/set-days-window", { adminPassword: pw, daysPast: dp, daysFuture: df });
    if (!data.ok) return alert(JSON.stringify(data,null,2));
    alert("Gespeichert ✅");
    await refreshAll();
  }

  async function changeAdminPassword(){
    if (!adminOk) return alert("Bitte erst Admin Login.");
    const pw = adminPassword();
    const n1 = $("newAdminPw").value.trim();
    const n2 = $("newAdminPw2").value.trim();
    if (n1 !== n2) return alert("Neues Passwort stimmt nicht überein.");
    if (n1.length < 6) return alert("Neues Passwort muss mindestens 6 Zeichen haben.");

    if (!confirm("Admin Passwort wirklich ändern?")) return;
    const {data} = await jpost("/api/admin/set-admin-password", { adminPassword: pw, newPassword: n1 });
    if (!data.ok) return alert(JSON.stringify(data,null,2));

    alert("Admin Passwort geändert ✅");
    $("adminPw").value = n1;
    $("newAdminPw").value = "";
    $("newAdminPw2").value = "";
  }

  async function loadLogs(){
    if (!adminOk) return alert("Bitte erst Admin Login.");
    const pw = adminPassword();
    const {data} = await jpost("/api/admin/logs", { adminPassword: pw, limit: 150 });
    if (!data.ok) return alert(JSON.stringify(data,null,2));

    const logs = data.logs || [];
    $("logsBox").innerHTML = logs.map(l=>{
      return `<div class="logrow"><b>${escapeHtml(l.action)}</b> · ${fmtLogTs(l.ts)} · ${escapeHtml(l.type)} ${escapeHtml(l.machine)} · Zimmer ${escapeHtml(l.room||"-")}</div>`;
    }).join("") || `<div class="muted">Keine Logs vorhanden.</div>`;
  }

  // Events
  $("btnRefresh").onclick = refreshAll;
  $("btnBook").onclick = bookSelected;
  $("btnMy").onclick = loadMyBookings;

  $("btnAdminLogin").onclick = adminLogin;
  $("btnAdminReload").onclick = adminReload;
  $("btnSaveStationPin").onclick = saveStationPin;
  $("btnSaveDays").onclick = saveDays;
  $("btnChangeAdminPw").onclick = changeAdminPassword;
  $("btnLoadLogs").onclick = loadLogs;

  $("adminPw").addEventListener("keydown", (e)=>{ if (e.key==="Enter") adminLogin(); });

  setStatus("Bereit. Worker: " + API_BASE, true);
</script>

</body>
</html>
