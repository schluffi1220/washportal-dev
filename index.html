<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Washportal – RBAC Dashboard (C8)</title>
  <style>
    :root{--bg:#070d18;--card:#0d172a;--muted:#9aa6b2;--txt:#e9eef5;--b:#1f2a44;--good:#3ddc97;--bad:#ff5b6c;--btn:#1b2a4a}
    *{box-sizing:border-box} body{margin:0;background:radial-gradient(1200px 600px at 30% 0%, #0d1a33 0%, var(--bg) 60%);color:var(--txt);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{max-width:1200px;margin:18px auto;padding:0 14px}
    .top{display:flex;justify-content:space-between;align-items:flex-start;gap:12px}
    h1{margin:0 0 6px 0;font-size:20px}
    .muted{color:var(--muted)}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--b);border-radius:999px;background:rgba(255,255,255,.03)}
    .pill b{font-weight:700}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));border:1px solid var(--b);border-radius:16px;padding:14px;margin:12px 0;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input,textarea{background:rgba(255,255,255,.04);border:1px solid var(--b);color:var(--txt);border-radius:10px;padding:10px 12px;outline:none}
    input{min-width:240px}
    textarea{width:100%;min-height:220px;resize:vertical;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    button{background:linear-gradient(90deg,#38bdf8,#34d399);border:0;color:#03111a;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
    button.secondary{background:var(--btn);color:var(--txt);border:1px solid var(--b)}
    button.danger{background:linear-gradient(90deg,#ff5b6c,#f59e0b);color:#1a0b0e}
    button:disabled{opacity:.5;cursor:not-allowed}
    .grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
    @media (max-width:1100px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media (max-width:640px){.grid{grid-template-columns:1fr}}
    .tile{background:rgba(0,0,0,.18);border:1px solid var(--b);border-radius:14px;padding:12px;min-height:110px}
    .tile h3{margin:0 0 6px 0;font-size:14px}
    .kv{display:flex;gap:10px;flex-wrap:wrap}
    .kv .pill{padding:4px 8px}
    .ok{color:var(--good)} .err{color:var(--bad)}
    pre{margin:0;white-space:pre-wrap;word-break:break-word;background:rgba(0,0,0,.18);border:1px solid var(--b);border-radius:12px;padding:10px;max-height:240px;overflow:auto}
    .split{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:900px){.split{grid-template-columns:1fr}}
    code{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  </style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div>
      <h1>Washportal – RBAC Dashboard <span class="muted">(C8)</span></h1>
      <div class="muted">Stabiler Grundstein: Login → Token → /auth/me → RBAC → nur erlaubte Features rendern.</div>
    </div>
    <div class="kv">
      <span class="pill">Build: <b id="build">-</b></span>
      <span class="pill">Status: <b id="st">-</b></span>
      <span class="pill">User: <b id="u">nicht eingeloggt</b></span>
      <span class="pill">Perms: <b id="pc">0</b></span>
      <span class="pill">Token: <b id="tk">-</b></span>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <input id="base" value="https://washportal-dev-worker.schluffi1220.workers.dev" />
      <button class="secondary" id="btnStatus">Status</button>
      <button class="secondary" id="btnMe">/auth/me</button>
      <button class="danger" id="btnLogout">Logout</button>
    </div>
    <div style="height:10px"></div>
    <div class="row">
      <input id="email" placeholder="E-Mail" />
      <input id="pw" placeholder="Passwort" type="password" />
      <button id="btnLogin">Login</button>
    </div>
  </div>

  <div class="card">
    <h2 style="margin:0 0 10px 0;font-size:16px">Funktionen (sichtbar nur bei passenden Rechten)</h2>
    <div id="tiles" class="grid"></div>
  </div>

  <div class="card">
    <h2 style="margin:0 0 10px 0;font-size:16px">Antwort / Debug</h2>
    <pre id="dbg">{}</pre>
  </div>

  <div id="sections"></div>
</div>

<script>
(() => {
  const byId = (id) => document.getElementById(id);

  const setText = (id, v) => { const el = byId(id); if (el) el.textContent = v; };
  const pretty = (x) => { try { return JSON.stringify(x, null, 2); } catch { return String(x); } };
  const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));

  const getToken = () => sessionStorage.getItem("wp_token") || "";
  const setToken = (t) => { if (t) sessionStorage.setItem("wp_token", t); else sessionStorage.removeItem("wp_token"); paintAuthBadge(); };

  const base = () => (byId("base").value || "").replace(/\/+$/,"");
  const hdrs = (withJson=true) => {
    const h = {};
    if (withJson) h["content-type"] = "application/json";
    const t = getToken();
    if (t) h["authorization"] = "Bearer " + t;
    return h;
  };

  function paintAuthBadge(){
    setText("tk", getToken() ? "gesetzt" : "-");
  }

  async function api(path, {method="POST", body=null, json=true} = {}) {
    const url = base() + path;
    const init = { method, headers: hdrs(json) };
    if (body !== null) init.body = (typeof body === "string") ? body : JSON.stringify(body);

    try {
      const res = await fetch(url, init);
      const text = await res.text();
      let data;
      try { data = text ? JSON.parse(text) : null; } catch { data = { raw: text }; }
      const out = { status: res.status, ok: res.ok, data, url };
      byId("dbg").textContent = pretty(out);
      return out;
    } catch (e) {
      const out = { status: 0, ok: false, data: { ok:false, error:"network", message: String(e) }, url };
      byId("dbg").textContent = pretty(out);
      return out;
    }
  }

  function hasPerm(p, ...keys){
    if (!p) return false;
    for (const k of keys) if (p[k] === true) return true;
    return false;
  }

  // FIX: war bei dir undefined → Dashboard bricht ab
  function mkSection(id, title, subtitle=""){
    const wrap = document.createElement("div");
    wrap.className = "card";
    wrap.id = id;
    const h = document.createElement("div");
    h.innerHTML = `<h2 style="margin:0 0 6px 0;font-size:16px">${title}</h2>` + (subtitle ? `<div class="muted">${subtitle}</div>` : "");
    wrap.appendChild(h);
    return wrap;
  }

  const Modules = {};

  Modules.config = {
    id: "sec-config",
    title: "Konfiguration / News",
    subtitle: "GET/SET via /api/admin/config/get und /api/admin/config/set (Bearer)",
    permsAny: ["admin.config.view","admin.config.manage","ps.config.view","admin.news.edit","news.edit"],
    async render(me){
      const p = (me && me.perms) ? me.perms : {};
      const canView = hasPerm(p, "admin.config.view", "ps.config.view");
      const canManage = hasPerm(p, "admin.config.manage");

      const sec = mkSection(this.id, this.title, this.subtitle);

      const row = document.createElement("div");
      row.className="row";
      row.innerHTML = `
        <span class="pill">view: <b class="${canView ? "ok" : "err"}">${canView ? "✓" : "×"}</b></span>
        <span class="pill">manage: <b class="${canManage ? "ok" : "err"}">${canManage ? "✓" : "×"}</b></span>
        <button class="secondary" id="btnCfgLoad">Konfig laden</button>
        <button id="btnCfgSave">Konfig speichern</button>
        <button class="secondary" id="btnCfgVerify">Verify (neu laden)</button>
      `;
      sec.appendChild(row);

      const split = document.createElement("div");
      split.className="split";
      split.style.marginTop="10px";
      split.innerHTML = `
        <div>
          <div class="muted" style="margin:0 0 6px 0">Konfig JSON (bearbeitbar)</div>
          <textarea id="cfgJson" spellcheck="false"></textarea>
        </div>
        <div>
          <div class="muted" style="margin:0 0 6px 0">Antwort</div>
          <pre id="cfgOut">{}</pre>
        </div>
      `;
      sec.appendChild(split);

      const out = sec.querySelector("#cfgOut");
      const ta = sec.querySelector("#cfgJson");
      const btnLoad = sec.querySelector("#btnCfgLoad");
      const btnSave = sec.querySelector("#btnCfgSave");
      const btnVerify = sec.querySelector("#btnCfgVerify");

      btnLoad.disabled = !canView;
      btnSave.disabled = !canManage;
      btnVerify.disabled = !canView;

      async function load(){
        const r = await api("/api/admin/config/get", { body: "{}" });
        out.textContent = pretty(r);
        if (r.ok && r.data && r.data.ok && r.data.config) ta.value = pretty(r.data.config);
      }

      async function save(){
        try{
          const cfg = JSON.parse(ta.value || "{}");
          // Wichtig: Worker erwartet Wrapper {config: {...}}
          const r = await api("/api/admin/config/set", { body: { config: cfg } });
          out.textContent = pretty(r);
          await sleep(120);
          await load();
        } catch (e){
          out.textContent = pretty({ ok:false, error:"bad_json", message:String(e) });
        }
      }

      btnLoad.addEventListener("click", load);
      btnSave.addEventListener("click", save);
      btnVerify.addEventListener("click", load);

      if (canView) load();
      return sec;
    }
  };

  Modules.protocol = {
    id: "sec-proto",
    title: "Protokoll",
    subtitle: "Als nächstes: CRUD UI + Calls (wenn Worker-Endpunkte final sind).",
    permsAny: ["protocol.view","protocol.create","protocol.edit","protocol.delete"],
    async render(){
      const sec = mkSection(this.id, this.title, this.subtitle);
      const pre = document.createElement("pre");
      pre.textContent = "Noch nicht verdrahtet (kommt als nächstes – dann SP/SV Übergabe).";
      sec.appendChild(pre);
      return sec;
    }
  };

  Modules.users = {
    id: "sec-users",
    title: "Admin-User",
    subtitle: "Noch nicht aktiv: wir verdrahten /api/admin/auth/users/* sauber sobald Worker stabil ist.",
    permsAny: ["admin.users.view","admin.users.manage","admin.users.delete"],
    async render(){
      const sec = mkSection(this.id, this.title, this.subtitle);
      const pre = document.createElement("pre");
      pre.textContent = "Noch nicht aktiv. Grund: zuletzt CORS/503 auf /api/admin/auth/users/list. Fix kommt im Worker, dann UI.";
      sec.appendChild(pre);
      return sec;
    }
  };

  function tile(title, desc, perms){
    const el = document.createElement("div");
    el.className="tile";
    el.innerHTML = `<h3>${title}</h3><div class="muted">${desc}</div><div style="height:8px"></div><div class="muted">Perms: ${perms.map(x=>`<code>${x}</code>`).join(", ")}</div>`;
    return el;
  }

  function clearSections(){ byId("sections").innerHTML = ""; }

  async function render(me){
    const p = (me && me.perms) ? me.perms : {};
    setText("u", me && me.user ? (me.user.role + " " + (me.user.email||"")) : "nicht eingeloggt");
    setText("pc", String(Object.keys(p||{}).length));

    const tiles = byId("tiles");
    tiles.innerHTML = "";

    const defs = [
      {title:"Konfiguration / News", desc:"Konfig JSON laden/speichern", perms:["admin.config.view","admin.config.manage","ps.config.view"]},
      {title:"Protokoll", desc:"Einträge ansehen + schreiben", perms:["protocol.view","protocol.create","protocol.edit","protocol.delete"]},
      {title:"Admin-User", desc:"User/Rollen/Übergabe", perms:["admin.users.view","admin.users.manage","admin.users.delete"]},
    ];

    for (const d of defs){
      if (hasPerm(p, ...d.perms)) tiles.appendChild(tile(d.title, d.desc, d.perms));
    }

    clearSections();
    for (const k of ["config","protocol","users"]){
      const m = Modules[k];
      if (!m) continue;
      if (hasPerm(p, ...m.permsAny)){
        const sec = await m.render(me);
        byId("sections").appendChild(sec);
      }
    }
  }

  async function doStatus(){
    const r = await api("/api/_status?ts=" + Date.now(), { method:"GET", body:null, json:false });
    if (r.ok && r.data && r.data.ok){
      setText("st","OK"); setText("build", r.data.build || "-");
    } else {
      setText("st","ERR"); setText("build", (r.data && r.data.build) ? r.data.build : "-");
    }
    return r;
  }

  async function doLogin(){
    const email = byId("email").value.trim();
    const password = byId("pw").value;
    const r = await api("/api/auth/login", { body: { email, password } });
    if (r.ok && r.data && r.data.ok && r.data.token){
      setToken(r.data.token);
      await doMe();
    }
  }

  async function doMe(){
    const r = await api("/api/auth/me", { body:"{}" });
    if (r.ok && r.data && r.data.ok) await render(r.data);
    else await render(null);
    return r;
  }

  function doLogout(){
    setToken("");
    setText("u","nicht eingeloggt");
    setText("pc","0");
    byId("tiles").innerHTML = "";
    clearSections();
    byId("dbg").textContent = "{}";
  }

  byId("btnStatus").addEventListener("click", doStatus);
  byId("btnLogin").addEventListener("click", doLogin);
  byId("btnMe").addEventListener("click", doMe);
  byId("btnLogout").addEventListener("click", doLogout);

  paintAuthBadge();
  doStatus();
  if (getToken()) doMe(); else render(null);
})();
</script>
</body>
</html>
