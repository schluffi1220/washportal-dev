<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Washportal (Alpha)</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Washportal</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:#121a2b;
      --muted:#91a4c7;
      --txt:#eaf2ff;
      --accent:#54d3ff;
      --ok:#36d399;
      --warn:#fbbf24;
      --bad:#fb7185;
      --line:rgba(255,255,255,.08);
      --card:#111a2b;
      --line:rgba(255,255,255,.10);
      --txt:#e9f1ff;
      --muted:#9cb0d4;
      --accent:#79d6ff;

      --pastelGreen: rgba(54, 211, 153, .18);
      --pastelBlue:  rgba(84, 211, 255, .18);
      --pastelRed:   rgba(251, 113, 133, .20);
      --pastelGray:  rgba(255,255,255,.06);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 600px at 10% 10%, rgba(84,211,255,.12), transparent 60%),
                  radial-gradient(900px 500px at 90% 20%, rgba(54,211,153,.10), transparent 55%),
      background: radial-gradient(900px 500px at 10% 10%, rgba(121,214,255,.10), transparent 60%),
                  radial-gradient(900px 500px at 90% 20%, rgba(54,211,153,.08), transparent 55%),
                  var(--bg);
      color:var(--txt);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    header{
      padding:18px 16px 10px;
      border-bottom:1px solid var(--line);
      position:sticky;
      top:0;
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(10px);
      background: rgba(11,18,32,.78);
      z-index:10;
      border-bottom: 1px solid var(--line);
      padding: 14px 14px;
    }
    .wrap{max-width:980px;margin:0 auto;padding:0 16px}
    h1{margin:0;font-size:18px;font-weight:700;letter-spacing:.2px}
    .wrap{max-width:980px;margin:0 auto;padding:0 14px}
    h1{margin:0;font-size:18px}
    .sub{margin-top:4px;color:var(--muted);font-size:13px}
    nav{
      display:flex;gap:8px;flex-wrap:wrap;
      margin-top:12px;
    }
    nav button{
      background: transparent;
      border:1px solid var(--line);
      color:var(--txt);
      padding:8px 10px;
      border-radius:12px;
      cursor:pointer;
      font-size:13px;
      transition:.15s;
    }
    nav button.active{
      border-color:rgba(84,211,255,.45);
      box-shadow:0 0 0 2px rgba(84,211,255,.14) inset;
      color:#cfefff;
    }
    main{padding:16px 0 60px}
    .grid{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap:12px;
    }
    @media (max-width: 900px){
      .grid{grid-template-columns:1fr}
    }
    main{padding:14px 0 70px}
    .card{
      background: rgba(18,26,43,.92);
      background: rgba(17,26,43,.90);
      border:1px solid var(--line);
      border-radius:18px;
      padding:14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.22);
    }
    .card h2{
      margin:0 0 10px;
      font-size:14px;
      color:#d7e6ff;
      letter-spacing:.2px;
      box-shadow: 0 12px 30px rgba(0,0,0,.20);
      margin-bottom:12px;
    }
    .card h2{margin:0 0 10px;font-size:14px;color:#d7e6ff}
    label{display:block;color:var(--muted);font-size:12px;margin:10px 0 6px}
    input, select, textarea{
    input,select,textarea{
      width:100%;
      background: rgba(255,255,255,.04);
      border:1px solid var(--line);
      color:var(--txt);
      padding:10px 10px;
      padding:10px 12px;
      border-radius:14px;
      outline:none;
      font-size:14px;
    }
    textarea{min-height:96px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:740px){ .row{grid-template-columns:1fr} }

    .btn{
      width:100%;
      background: linear-gradient(135deg, rgba(84,211,255,.95), rgba(54,211,153,.92));
      margin-top:10px;
      border:none;
      color:#07101e;
      font-weight:800;
      padding:12px 12px;
      border-radius:14px;
      cursor:pointer;
      margin-top:12px;
      transition:.15s transform;
      border-radius:14px;
      padding:12px 12px;
      font-weight:800;
      background: linear-gradient(135deg, rgba(121,214,255,.95), rgba(54,211,153,.92));
      color:#07101e;
    }
    .btn:active{transform:translateY(1px)}
    .btn.secondary{
      background: transparent;
      border:1px solid var(--line);
      color:var(--txt);
      font-weight:700;
    }
    .pill{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border:1px solid var(--line);
      border-radius:999px;font-size:12px;color:var(--muted)
    }
    .small{font-size:12px;color:var(--muted);line-height:1.45}
    .list{display:flex;flex-direction:column;gap:10px}
    .item{
      padding:12px;border:1px solid var(--line);
    .btn.inline{ width:auto; margin:0; padding:10px 12px; }

    details{
      border:1px solid var(--line);
      border-radius:16px;
      padding:10px 12px;
      background: rgba(255,255,255,.03);
    }
    .itemTop{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .title{font-weight:800;font-size:14px}
    .meta{font-size:12px;color:var(--muted);margin-top:4px}
    summary{cursor:pointer;color:#cfe3ff;font-weight:800}

    .toast{
      position:fixed; left:50%; bottom:16px; transform:translateX(-50%);
      background: rgba(17,26,43,.96);
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
      box-shadow: 0 12px 35px rgba(0,0,0,.35);
      max-width: min(92vw, 680px);
      display:none;
      z-index:9999;
      font-size:13px;
    }
    .mono{font-family: ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", monospace;}
    .small{font-size:12px;color:var(--muted);line-height:1.45}
    .gridTiles{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
    }
    @media (max-width:900px){ .gridTiles{grid-template-columns: repeat(2, 1fr);} }

    .tile{
      border:1px solid var(--line);
      border-radius:18px;
      padding:12px;
      background: var(--pastelGray);
    }
    .tile.free{ background: var(--pastelGreen); }
    .tile.busy{ background: var(--pastelBlue); }
    .tile.bad { background: var(--pastelRed); }

    .tileTop{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .title{font-weight:900;font-size:14px}
    .tag{
      font-size:11px;padding:4px 8px;border-radius:999px;
      font-size:11px;
      border:1px solid var(--line);
      padding:4px 8px;
      border-radius:999px;
      color:var(--muted);
      white-space:nowrap;
    }
    .tag.ok{border-color:rgba(54,211,153,.35);color:#aaf3d7}
    .tag.warn{border-color:rgba(251,191,36,.35);color:#ffe7a2}
    .tag.bad{border-color:rgba(251,113,133,.35);color:#ffc4cf}
    .toast{
      position:fixed;
      bottom:14px;left:50%;transform:translateX(-50%);
      background: rgba(18,26,43,.96);
    .meta{margin-top:6px;font-size:12px;color:var(--muted)}
    .tileBtns{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .tileBtns button{
      border-radius:999px;
      padding:8px 10px;
      border:1px solid var(--line);
      padding:10px 12px;
      border-radius:14px;
      box-shadow: 0 10px 40px rgba(0,0,0,.35);
      max-width:min(92vw,640px);
      display:none;
      z-index:999;
      font-size:13px;
      color:#dcecff;
      background: rgba(0,0,0,.0);
      color: var(--txt);
      cursor:pointer;
      font-size:12px;
    }
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;}
    .split{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .disabledOpt{color:#9aa9c6}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Washportal <span class="pill">Alpha</span></h1>
      <div class="sub">Buchen â€¢ Overbooking-Schutz â€¢ Trockner â€¢ News â€¢ Feedback</div>
      <nav id="tabs"></nav>
      <h1>Washportal</h1>
      <div class="sub">Alpha-Stand (Zimmer + PIN + Stations-PIN) Â· 4 WM Â· 4 TR Â· Kachel-UI</div>
    </div>
  </header>

  <main class="wrap">
    <section id="view"></section>

    <!-- 1) Zugang -->
    <div class="card" id="cardAccess">
      <h2>1) Zugang</h2>
      <div class="row">
        <div>
          <label>Zimmernummer (0â€“400)</label>
          <input id="room" inputmode="numeric" placeholder="z.B. 316" />
        </div>
        <div>
          <label>PIN (4-stellig)</label>
          <input id="pin" type="password" inputmode="numeric" placeholder="****" />
        </div>
      </div>
      <label>Stations-PIN (4-stellig)</label>
      <input id="stationPin" type="password" inputmode="numeric" placeholder="****" />

      <button class="btn" id="btnRefresh">Aktualisieren</button>
      <div class="small" style="margin-top:10px">
        Hinweis: Beim ersten Login einer Zimmernummer wird der PIN automatisch gespeichert (verschlÃ¼sselt). Danach muss er stimmen.
      </div>

      <div id="newsBoxWrap" style="margin-top:12px; display:none;"></div>
    </div>

    <!-- 2) Slots buchen -->
    <div class="card">
      <h2>2) Slots buchen</h2>
      <label>Wasch-Slot auswÃ¤hlen</label>
      <select id="slotSelect">
        <option value="">Bitte erst â€žAktualisierenâ€œ drÃ¼cken</option>
      </select>
      <button class="btn" id="btnBookWasher">Buchen</button>
      <div class="small" id="slotHint" style="margin-top:10px"></div>
    </div>

    <!-- 3) MaschinenÃ¼bersicht -->
    <div class="card">
      <h2>3) MaschinenÃ¼bersicht</h2>
      <div class="small" style="margin-bottom:10px">
        GrÃ¼n = frei Â· Blau = lÃ¤uft/gebucht Â· Rot = defekt/gesperrt
      </div>
      <div class="gridTiles" id="tiles"></div>
    </div>

    <!-- 4) Meine Buchungen -->
    <div class="card">
      <h2>4) Meine Buchungen</h2>
      <div id="myBookings"></div>
    </div>

    <!-- 5) Feedback / Antworten -->
    <div class="card">
      <h2>5) Feedback / Antworten</h2>

      <div class="small" style="margin-bottom:10px">
        Feedback ist ein Chat zwischen Zimmer & Admin. Neue Antworten erscheinen als Popup.
      </div>

      <button class="btn secondary" id="btnLoadFeedback">Feedback laden</button>

      <div id="feedbackList" style="margin-top:10px"></div>

      <label>Neue Nachricht</label>
      <textarea id="feedbackText" placeholder="Deine Nachrichtâ€¦"></textarea>
      <button class="btn" id="btnSendFeedback">Senden</button>
    </div>

    <!-- 6) Admin -->
    <div class="card">
      <h2>6) Admin</h2>

      <div id="adminLoginBox">
        <label>Admin-Passwort</label>
        <input id="adminPw" type="password" placeholder="initial (falls neu)" />
        <button class="btn" id="btnAdminLogin">Login</button>
      </div>

      <div id="adminBox" style="display:none">
        <div class="row">
          <button class="btn secondary" id="btnAdminLogout">Logout</button>
          <button class="btn secondary" id="btnAdminReload">Admin aktualisieren</button>
        </div>

        <details style="margin-top:12px" open>
          <summary>Stations-PIN setzen/Ã¤ndern</summary>
          <label>Stations-PIN (4-stellig)</label>
          <input id="adminStationPin" type="password" inputmode="numeric" placeholder="1111" />
          <button class="btn" id="btnSetStationPin">Speichern</button>
        </details>

        <details style="margin-top:12px">
          <summary>Admin-Passwort Ã¤ndern</summary>
          <label>Neues Admin-Passwort</label>
          <input id="adminNewPw" type="password" placeholder="Neues Passwort" />
          <button class="btn" id="btnChangeAdminPw">Ã„ndern</button>
        </details>

        <details style="margin-top:12px" open>
          <summary>Wasch-Slots (Uhrzeiten per Haken)</summary>
          <div class="small">Waschdauer ist fix 2 Stunden.</div>
          <div id="washerHoursBox" style="margin-top:10px"></div>
          <button class="btn" id="btnSaveWasherHours">Waschzeiten speichern</button>
        </details>

        <details style="margin-top:12px" open>
          <summary>Trockner-Dauer</summary>
          <label>Dauer</label>
          <select id="dryerMinutes">
            <option value="60">1 Stunde</option>
            <option value="90">1,5 Stunden</option>
            <option value="120">2 Stunden</option>
          </select>
          <button class="btn" id="btnSaveDryerMinutes">Speichern</button>
        </details>

        <details style="margin-top:12px">
          <summary>Tage-Fenster + Auto-Purge</summary>
          <div class="row">
            <div>
              <label>Vergangene Tage anzeigen</label>
              <input id="daysPast" inputmode="numeric" />
            </div>
            <div>
              <label>Folgende Tage anzeigen</label>
              <input id="daysFuture" inputmode="numeric" />
            </div>
          </div>
          <button class="btn" id="btnSaveDaysWindow">Speichern</button>
          <div class="small">Purge (LÃ¶schen alter Buchungen) bauen wir nach Alpha sauber ein â€“ Logs bleiben.</div>
        </details>

        <details style="margin-top:12px" open>
          <summary>News (â€žWas ist neu?â€œ)</summary>
          <label><input type="checkbox" id="newsEnabled" /> Aktiv</label>
          <label>Text</label>
          <textarea id="newsText" placeholder="Was ist neuâ€¦"></textarea>
          <label><input type="checkbox" id="bumpNewsVersion" /> Version erhÃ¶hen (Popup erneut bei allen)</label>
          <button class="btn" id="btnSaveNews">Speichern</button>
          <div class="small" id="newsSeenCount"></div>
        </details>

        <details style="margin-top:12px" open>
          <summary>Maschinen sperren/entsperren + Defekt</summary>
          <div class="small">Sperren = rot, User kann nicht buchen. Defekt = rot, Buchungen bleiben rot markiert.</div>
          <div id="adminMachines" style="margin-top:10px"></div>
          <button class="btn" id="btnSaveMachines">Maschinen speichern</button>
        </details>

        <details style="margin-top:12px" open>
          <summary>Defektmeldung durch User erlauben</summary>
          <label><input type="checkbox" id="userDefectEnabled" /> User dÃ¼rfen Defekte melden</label>
          <div id="defectAllowedBox" style="margin-top:10px"></div>
          <button class="btn" id="btnSaveDefectRules">Speichern</button>
        </details>

        <details style="margin-top:12px" open>
          <summary>Feedback (Admin-Chat)</summary>
          <div id="adminFeedbackThreads"></div>
          <div id="adminFeedbackThreadView" style="margin-top:10px"></div>
        </details>

        <details style="margin-top:12px">
          <summary>Logs</summary>
          <button class="btn secondary" id="btnLoadLogs">Logs laden</button>
          <div id="logsBox" style="margin-top:10px"></div>
        </details>
      </div>
    </div>

  </main>

  <div id="toast" class="toast"></div>

<script>
/**
 * âœ… SET THIS:
 * Your worker base URL (no trailing slash)
 */
const WORKER_BASE = "https://washportal-dev-worker.schluffi1220.workers.dev";

/** Alpha machine config */
const MACHINES = {
  washer: ["W1","W2","W3","W4","W5","W6"],
  dryer: ["D1","D2"],
};

const DURATIONS = {
  washer: [30, 45, 60, 75, 90],
  dryer: [15, 30, 45, 60],
};

const $ = (sel) => document.querySelector(sel);
const el = (tag, attrs={}, children=[]) => {
  const n = document.createElement(tag);
  for (const [k,v] of Object.entries(attrs || {})) {
    if (k === "class") n.className = v;
    else if (k === "html") n.innerHTML = v;
    else if (k.startsWith("on") && typeof v === "function") n.addEventListener(k.slice(2), v);
    else n.setAttribute(k, v);
  }
  for (const c of children) n.appendChild(typeof c === "string" ? document.createTextNode(c) : c);
  return n;
};
/*** SET THIS ***/
const API_BASE = "https://washportal-dev-worker.schluffi1220.workers.dev"; // <-- DEV Worker URL

// ---------- UI helpers ----------
const $ = (id)=>document.getElementById(id);
function toast(msg){
  const t = $("#toast");
  const t = $("toast");
  t.textContent = msg;
  t.style.display = "block";
  clearTimeout(window.__toastTimer);
  window.__toastTimer = setTimeout(()=> t.style.display="none", 3200);
  clearTimeout(window.__t);
  window.__t = setTimeout(()=> t.style.display="none", 3200);
}

function pad2(n){return String(n).padStart(2,"0");}

function epochFromLocal(dateStr, timeStr){
  // local time â†’ epoch seconds
  const d = new Date(`${dateStr}T${timeStr}:00`);
  return Math.floor(d.getTime()/1000);
function fmtDT(ms){
  const d = new Date(ms);
  return d.toLocaleString("de-DE", { timeZone: "Europe/Berlin" });
}

function fmtLocal(ts){
  const d = new Date(ts*1000);
  return `${pad2(d.getDate())}.${pad2(d.getMonth()+1)}.${d.getFullYear()} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
function fmtTime(ms){
  const d = new Date(ms);
  return d.toLocaleTimeString("de-DE", { timeZone: "Europe/Berlin", hour:"2-digit", minute:"2-digit" });
}

async function api(path, opts={}){
  const res = await fetch(`${WORKER_BASE}${path}`, {
    ...opts,
    headers: {"Content-Type":"application/json", ...(opts.headers||{})}
function fmtDate(ms){
  const d = new Date(ms);
  return d.toLocaleDateString("de-DE", { timeZone: "Europe/Berlin" });
}
function confirm2(step1, step2){
  if (!confirm(step1)) return false;
  alert(step2);
  return true;
}
async function jpost(path, body){
  const r = await fetch(API_BASE + path, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(body||{})
  });
  const data = await res.json().catch(()=> ({}));
  if (!res.ok) {
    const err = data?.error || `HTTP_${res.status}`;
    throw {status: res.status, err, data};
  }
  const data = await r.json().catch(()=> ({}));
  if (!r.ok) throw {status:r.status, data};
  return data;
}

function getName(){
  return localStorage.getItem("washportal_name") || "";
async function jget(path){
  const r = await fetch(API_BASE + path);
  const data = await r.json().catch(()=> ({}));
  if (!r.ok) throw {status:r.status, data};
  return data;
}
function setName(v){
  localStorage.setItem("washportal_name", (v||"").trim());
function getCreds(){
  return {
    room: $("room").value.trim(),
    pin: $("pin").value.trim(),
    stationPin: $("stationPin").value.trim()
  };
}

const TABS = [
  {id:"book", label:"Buchen"},
  {id:"dryer", label:"Trockner"},
  {id:"mine", label:"Meine Buchungen"},
  {id:"news", label:"News"},
  {id:"feedback", label:"Feedback"},
];

let activeTab = "book";

function renderTabs(){
  const nav = $("#tabs");
  nav.innerHTML = "";
  for (const t of TABS){
    nav.appendChild(el("button", {
      class: t.id === activeTab ? "active" : "",
      onclick: () => { activeTab = t.id; render(); }
    }, [t.label]));
  }
function getAdminSession(){
  try{
    const raw = sessionStorage.getItem("wp_admin");
    if (!raw) return null;
    const o = JSON.parse(raw);
    if (!o.pw || !o.exp) return null;
    if (Date.now() > o.exp) return null;
    return o;
  }catch{ return null; }
}
function setAdminSession(pw){
  sessionStorage.setItem("wp_admin", JSON.stringify({pw, exp: Date.now()+5*60*1000}));
}
function clearAdminSession(){
  sessionStorage.removeItem("wp_admin");
}

function viewCard(title, inner){
  return el("div",{class:"card"}, [
    el("h2",{},[title]),
    inner
  ]);
// ---------- state ----------
let STATE = {
  ok:false,
  build:"",
  now: Date.now(),
  config:null,
  machines:[],
  bookings:[],
  feedback:{hasThread:false,userUnread:false,allowUserView:true},
  news:{enabled:false,text:"",version:0,seen:true},
  window:{from:0,to:0}
};

// ---------- compute slots client-side ----------
function berlinMidnightMs(dayOffset){
  const now = new Date();
  // Berlin local date today:
  const parts = new Intl.DateTimeFormat("de-DE", { timeZone:"Europe/Berlin", year:"numeric", month:"2-digit", day:"2-digit" }).formatToParts(now);
  const y = Number(parts.find(p=>p.type==="year").value);
  const m = Number(parts.find(p=>p.type==="month").value);
  const d = Number(parts.find(p=>p.type==="day").value);
  const base = new Date(y, m-1, d, 0,0,0); // local browser is Berlin in your use-case
  base.setDate(base.getDate() + dayOffset);
  return base.getTime();
}

/* ------------------------------
   BOOKING UI (washer/dryer shared)
--------------------------------*/
function bookingForm(machine_type){
  const nameInput = el("input",{value:getName(), placeholder:"Dein Name (z.B. Max)"});
  const dateInput = el("input",{type:"date", value: new Date().toISOString().slice(0,10)});
  const timeInput = el("input",{type:"time", value:"18:00"});
  const machineSel = el("select",{});
  const durationSel = el("select",{});
  const notesInput = el("input",{placeholder:"Notiz (optional) z.B. 'BettwÃ¤sche'"});
function buildWasherOptions(){
  const cfg = STATE.config;
  const machines = [1,2,3,4];
  const hours = (cfg?.washerHours || []).slice();
  const durMs = 120*60*1000; // fixed 2h
  const now = Date.now();

  for (const m of MACHINES[machine_type]){
    machineSel.appendChild(el("option",{value:m},[m]));
  const daysPast = cfg.daysPast || 1;
  const daysFuture = cfg.daysFuture || 6;

  // map bookings by machine for washers
  const washerBookings = (STATE.bookings || []).filter(b => b.type==="washer" && b.status==="booked");
  const byM = {1:[],2:[],3:[],4:[]};
  for (const b of washerBookings){
    if (byM[b.machine]) byM[b.machine].push(b);
  }
  for (const mins of DURATIONS[machine_type]){
    durationSel.appendChild(el("option",{value:String(mins)},[`${mins} min`]));

  // machine status map
  const machineMap = {};
  for (const m of STATE.machines){
    if (m.type==="washer") machineMap[m.machine] = m;
  }

  const availBox = el("div",{class:"small", html:"<span class='mono'>Lade Belegungâ€¦</span>"});
  const options = [];
  for (let day = -daysPast; day <= daysFuture; day++){
    const day0 = berlinMidnightMs(day);
    for (const h of hours){
      const start = day0 + h*60*60*1000;
      const end = start + durMs;

  async function refreshAvail(){
    try{
      const date = dateInput.value;
      const a = await api(`/api/availability?date=${encodeURIComponent(date)}&type=${encodeURIComponent(machine_type)}`);
      const b = a.bookings?.[machineSel.value] || [];
      if (b.length === 0){
        availBox.innerHTML = `<span class="tag ok">Frei</span> <span class="mono">${machineSel.value}</span> hat heute keine Buchungen.`;
        return;
      for (const mac of machines){
        const ms = machineMap[mac];
        const disabledMachine = !ms || ms.enabled===0;
        const defect = !!(ms && ms.defect===1);

        // past slots cannot be booked if end<=now (per spec)
        const pastNotBookable = !(end > now);

        // overlap?
        let booked = false;
        for (const b of (byM[mac]||[])){
          if (!(b.end <= start || b.start >= end)){
            booked = true; break;
          }
        }

        const labelBase = `${fmtDate(start)} ${fmtTime(start)}â€“${fmtTime(end)} â€“ Waschmaschine ${mac}`;
        let label = labelBase;
        let disabled = false;

        if (disabledMachine){
          label += " (gesperrt)";
          disabled = true;
        } else if (defect){
          label += " (defekt)";
          disabled = true;
        } else if (pastNotBookable){
          label += " (vergangen)";
          disabled = true;
        } else if (booked){
          label += " (belegt)";
          disabled = true;
        } else {
          // free
          // show nothing extra
        }

        options.push({type:"washer", machine:mac, start, end, label, disabled});
      }
      const lines = b.map(x => {
        return `<div class="mono">â€¢ ${fmtLocal(x.start_ts)} â€“ ${fmtLocal(x.end_ts)} (${x.user_name})</div>`;
      }).join("");
      availBox.innerHTML = `<div class="tag warn">Belegt</div><div style="height:6px"></div>${lines}`;
    }catch(e){
      availBox.innerHTML = `<span class="tag bad">Fehler</span> Konnte Belegung nicht laden.`;
    }
  }

  machineSel.addEventListener("change", refreshAvail);
  dateInput.addEventListener("change", refreshAvail);

  const submit = el("button",{class:"btn"},[`Buchung speichern (${machine_type === "washer" ? "Waschmaschine" : "Trockner"})`]);

  submit.addEventListener("click", async () => {
    const user_name = nameInput.value.trim();
    if (!user_name){ toast("Bitte Name eintragen."); return; }
    setName(user_name);
  // sort by start then machine
  options.sort((a,b)=> a.start-b.start || a.machine-b.machine);
  return options;
}

    const dateStr = dateInput.value;
    const timeStr = timeInput.value;
    const start_ts = epochFromLocal(dateStr, timeStr);
    const mins = Number(durationSel.value);
    const end_ts = start_ts + mins*60;
function bookingForMachineRunning(type, machine){
  const now = Date.now();
  const bs = (STATE.bookings||[]).filter(b=>b.type===type && b.machine===machine && b.status==="booked");
  // running = start<=now<end
  return bs.find(b=> b.start <= now && b.end > now) || null;
}

    const payload = {
      user_name,
      machine_type,
      machine_id: machineSel.value,
      start_ts,
      end_ts,
      notes: notesInput.value.trim() || null,
    };
// ---------- render ----------
function renderNewsBox(){
  const wrap = $("newsBoxWrap");
  const n = STATE.news;
  if (!n.enabled || !n.text){
    wrap.style.display="none";
    wrap.innerHTML="";
    return;
  }
  wrap.style.display="block";

    submit.disabled = true;
    submit.textContent = "Speichereâ€¦";
  const details = document.createElement("details");
  details.open = !n.seen; // open only when unseen
  const sum = document.createElement("summary");
  sum.textContent = "Was ist neu?";
  const txt = document.createElement("div");
  txt.className="small";
  txt.style.marginTop="8px";
  txt.style.whiteSpace="pre-wrap";
  txt.textContent = n.text;

  const btn = document.createElement("button");
  btn.className="btn secondary";
  btn.style.marginTop="10px";
  btn.textContent = "Gelesen";
  btn.onclick = async ()=>{
    try{
      const r = await api("/api/bookings", {method:"POST", body: JSON.stringify(payload)});
      toast(`âœ… Gespeichert! ID: ${r.id}`);
      await refreshAvail();
      const c = getCreds();
      await jpost("/api/news/seen", c);
      STATE.news.seen = true;
      details.open = false;
      toast("âœ… Als gelesen markiert");
    }catch(e){
      if (e.status === 409 && e.data?.conflicts?.length){
        const c = e.data.conflicts[0];
        toast(`â›” Overbooking: Konflikt mit ${c.user_name} (${fmtLocal(c.start_ts)}â€“${fmtLocal(c.end_ts)})`);
      }else{
        toast(`â›” Fehler: ${e.err}`);
      }
    }finally{
      submit.disabled = false;
      submit.textContent = `Buchung speichern (${machine_type === "washer" ? "Waschmaschine" : "Trockner"})`;
      toast("â›” Konnte nicht speichern");
    }
  });
  };

  details.appendChild(sum);
  details.appendChild(txt);
  details.appendChild(btn);
  wrap.innerHTML="";
  wrap.appendChild(details);

  const left = el("div",{},[
    el("div",{class:"row"},[
      el("div",{},[el("label",{},["Name"]), nameInput]),
      el("div",{},[el("label",{},["GerÃ¤t"]), machineSel]),
    ]),
    el("div",{class:"row"},[
      el("div",{},[el("label",{},["Datum"]), dateInput]),
      el("div",{},[el("label",{},["Startzeit"]), timeInput]),
    ]),
    el("div",{class:"row"},[
      el("div",{},[el("label",{},["Dauer"]), durationSel]),
      el("div",{},[el("label",{},["Notiz"]), notesInput]),
    ]),
    submit,
    el("div",{class:"small", style:"margin-top:10px"},[
      "Hinweis: Overbooking ist blockiert (du bekommst einen Konflikt-Fehler, wenn es Ãœberschneidungen gibt)."
    ])
  ]);

  const right = el("div",{},[
    el("div",{class:"small"},["Belegung fÃ¼r das ausgewÃ¤hlte GerÃ¤t:"]),
    el("div",{style:"height:8px"}),
    el("div",{class:"item"},[availBox]),
    el("div",{class:"split"},[
      el("button",{class:"btn secondary", onclick: refreshAvail},["Belegung aktualisieren"]),
      el("button",{class:"btn secondary", onclick: async ()=>{
        timeInput.value = "18:00";
        durationSel.value = String(DURATIONS[machine_type][0]);
        notesInput.value = "";
        await refreshAvail();
        toast("Form zurÃ¼ckgesetzt.");
      }},["Reset"])
    ])
  ]);

  // initial
  setTimeout(refreshAvail, 0);

  return el("div",{class:"grid"},[
    viewCard(machine_type === "washer" ? "Waschmaschine buchen" : "Trockner buchen", left),
    viewCard("Live-Belegung", right),
  ]);
  if (!n.seen){
    alert("ðŸ“¢ Neue Info:\n\n" + n.text);
  }
}

/* ------------------------------
   MY BOOKINGS
--------------------------------*/
async function renderMine(){
  const name = getName();
  const nameInput = el("input",{value:name, placeholder:"Dein Name (gleich wie beim Buchen)"});
  const loadBtn = el("button",{class:"btn secondary"},["Laden"]);
  const list = el("div",{class:"list"});

  async function load(){
    const n = nameInput.value.trim();
    if (!n){ toast("Bitte Name eintragen."); return; }
    setName(n);
    list.innerHTML = "<div class='small mono'>Ladeâ€¦</div>";
function renderSlotDropdown(){
  const sel = $("slotSelect");
  sel.innerHTML = "";
  const opts = buildWasherOptions();
  if (opts.length===0){
    sel.appendChild(new Option("Keine Slots verfÃ¼gbar", ""));
    return;
  }

    try{
      const r = await api(`/api/my-bookings?name=${encodeURIComponent(n)}`);
      const rows = r.bookings || [];
      if (rows.length === 0){
        list.innerHTML = `<div class="item"><div class="small">Keine Buchungen gefunden.</div></div>`;
        return;
      }
  sel.appendChild(new Option("Bitte auswÃ¤hlenâ€¦", ""));
  for (const o of opts){
    const opt = new Option(o.label, JSON.stringify({machine:o.machine,start:o.start,end:o.end}));
    opt.disabled = !!o.disabled;
    if (o.disabled) opt.className = "disabledOpt";
    sel.appendChild(opt);
  }

  const freeCount = opts.filter(o=>!o.disabled).length;
  $("slotHint").textContent = `Freie Wasch-Slots: ${freeCount} (grau = belegt/defekt/gesperrt/vergangen)`;
}

function tileStatus(type, machine){
  const m = STATE.machines.find(x=>x.type===type && x.machine===machine);
  if (!m) return {cls:"bad", tag:"FEHLT", text:"Nicht vorhanden"};
  if (m.enabled===0) return {cls:"bad", tag:"GESPERRT", text:"Maschine gesperrt"};
  if (m.defect===1) return {cls:"bad", tag:"DEFEKT", text:`Defekt gemeldet von ${m.defectBy || "?"}`};
  const running = bookingForMachineRunning(type, machine);
  if (running) return {cls:"busy", tag:"LÃ„UFT", text:`Zimmer ${running.room} bis ${fmtTime(running.end)}`};
  return {cls:"free", tag:"FREI", text:"Frei"};
}

function renderTiles(){
  const box = $("tiles");
  box.innerHTML = "";

  const types = [
    {type:"washer", title:"Waschmaschine", machines:[1,2,3,4]},
    {type:"dryer",  title:"Trockner",      machines:[1,2,3,4]},
  ];

  for (const group of types){
    for (const m of group.machines){
      const st = tileStatus(group.type, m);
      const tile = document.createElement("div");
      tile.className = "tile " + st.cls;

      const top = document.createElement("div");
      top.className = "tileTop";
      const title = document.createElement("div");
      title.innerHTML = `<div class="title">${group.title} ${m}</div><div class="meta">${st.text}</div>`;
      const tag = document.createElement("div");
      tag.className = "tag";
      tag.textContent = st.tag;
      top.appendChild(title);
      top.appendChild(tag);

      list.innerHTML = "";
      for (const b of rows){
        const tagClass = b.status === "active" ? "ok" : "bad";
        const tagText = b.status === "active" ? "aktiv" : "storniert";
      const btns = document.createElement("div");
      btns.className = "tileBtns";

        const cancelBtn = el("button",{class:"btn secondary", style:"margin-top:10px"},["Stornieren"]);
        cancelBtn.disabled = b.status !== "active";
      // Buttons depending on state
      const creds = getCreds();
      const running = bookingForMachineRunning(group.type, m);

        cancelBtn.addEventListener("click", async ()=>{
          cancelBtn.disabled = true;
          cancelBtn.textContent = "Storniereâ€¦";
      if (group.type === "washer") {
        if (running && creds.room && running.room === creds.room) {
          const b = document.createElement("button");
          b.textContent = "Freigeben";
          b.onclick = async ()=>{
            try{
              await jpost("/api/booking/release", {room:creds.room, pin:creds.pin, id: running.id});
              toast("âœ… Freigegeben");
              await refreshAll();
            }catch(e){
              toast("â›” Freigeben fehlgeschlagen");
            }
          };
          btns.appendChild(b);
        }
      } else {
        // dryer
        if (!running) {
          const b = document.createElement("button");
          b.textContent = "Jetzt buchen";
          b.onclick = async ()=>{
            try{
              await jpost("/api/dryer/book", {room:creds.room, pin:creds.pin, stationPin:creds.stationPin, machine:m});
              toast("âœ… Trockner gebucht");
              await refreshAll();
            }catch(e){
              toast("â›” Buchen fehlgeschlagen");
            }
          };
          btns.appendChild(b);
        } else {
          if (creds.room && running.room === creds.room) {
            const b = document.createElement("button");
            b.textContent = "Fertig (Freigeben)";
            b.onclick = async ()=>{
              try{
                await jpost("/api/booking/release", {room:creds.room, pin:creds.pin, id: running.id});
                toast("âœ… Freigegeben");
                await refreshAll();
              }catch(e){
                toast("â›” Freigeben fehlgeschlagen");
              }
            };
            btns.appendChild(b);
          } else {
            // allow overbook with confirm
            const b = document.createElement("button");
            b.textContent = "Ãœberbuchen";
            b.onclick = async ()=>{
              const ok = confirm("Ãœberbuchen nur wenn bestÃ¤tigt:\n\nDie WÃ¤sche vom VorgÃ¤nger ist sauber und vorsichtig im Korb oben/nebendran abgelegt.");
              if (!ok) return;
              try{
                await jpost("/api/dryer/book", {room:creds.room, pin:creds.pin, stationPin:creds.stationPin, machine:m, force:true, confirmed:true});
                toast("âœ… Ãœberbucht & gebucht");
                await refreshAll();
              }catch(e){
                toast("â›” Ãœberbuchen fehlgeschlagen");
              }
            };
            btns.appendChild(b);
          }
        }
      }

      // Defekt melden / freigeben (user rule)
      const cfg = STATE.config || {};
      const allowDef = cfg.userDefectEnabled && cfg.userDefectAllowed && cfg.userDefectAllowed[group.type] && cfg.userDefectAllowed[group.type][String(m)];
      if (allowDef) {
        const mm = STATE.machines.find(x=>x.type===group.type && x.machine===m);
        const isDef = mm && mm.defect===1;
        const b = document.createElement("button");
        b.textContent = isDef ? "Defekt freigeben" : "Defekt melden";
        b.onclick = async ()=>{
          try{
            await api("/api/cancel-booking", {
              method:"POST",
              body: JSON.stringify({id: b.id, user_name: n})
            });
            toast("âœ… Storniert.");
            await load();
            await jpost("/api/defect/report", {room:creds.room, pin:creds.pin, stationPin:creds.stationPin, type:group.type, machine:m, defect: !isDef});
            toast("âœ… Gespeichert");
            await refreshAll();
          }catch(e){
            toast(`â›” Fehler: ${e.err}`);
          }finally{
            cancelBtn.textContent = "Stornieren";
            toast("â›” Nicht mÃ¶glich");
          }
        });

        list.appendChild(el("div",{class:"item"},[
          el("div",{class:"itemTop"},[
            el("div",{},[
              el("div",{class:"title"},[
                `${b.machine_type === "washer" ? "Waschmaschine" : "Trockner"} ${b.machine_id} `,
              ]),
              el("div",{class:"meta mono"},[
                `${fmtLocal(b.start_ts)} â†’ ${fmtLocal(b.end_ts)}`
              ]),
              b.notes ? el("div",{class:"meta"},[`Notiz: ${b.notes}`]) : el("div",{}),
            ]),
            el("div",{class:`tag ${tagClass}`},[tagText]),
          ]),
          cancelBtn
        ]));
        };
        btns.appendChild(b);
      }

    }catch(e){
      list.innerHTML = `<div class="item"><div class="small">Fehler: ${e.err}</div></div>`;
      tile.appendChild(top);
      tile.appendChild(btns);
      box.appendChild(tile);
    }
  }
}

function myBookingState(b){
  const m = STATE.machines.find(x=>x.type===b.type && x.machine===b.machine);
  if (m && (m.enabled===0 || m.defect===1)) return "bad";
  const now = Date.now();
  if (b.status === "released") return "free";
  if (b.status === "cancelled") return "bad";
  if (b.start <= now && b.end > now) return "busy";
  return "pastel"; // upcoming booked
}

function renderMyBookings(){
  const box = $("myBookings");
  const c = getCreds();
  const room = c.room;
  if (!room){
    box.innerHTML = `<div class="small">Bitte erst Zugang eingeben und Aktualisieren.</div>`;
    return;
  }

  const list = (STATE.bookings||[]).filter(b=> b.room===room);
  if (list.length===0){
    box.innerHTML = `<div class="small">Keine Buchungen.</div>`;
    return;
  }

  loadBtn.addEventListener("click", load);

  return el("div",{class:"grid"},[
    viewCard("Meine Buchungen", el("div",{},[
      el("label",{},["Name"]),
      nameInput,
      loadBtn,
      el("div",{style:"height:10px"}),
      el("div",{class:"small"},[
        "Stornieren geht nur mit dem gleichen Namen, mit dem du gebucht hast."
      ]),
    ])),
    viewCard("Liste", list),
  ]);
  const now = Date.now();
  const html = [];
  for (const b of list.sort((a,b)=>a.start-b.start)){
    const state = myBookingState(b);
    const cls = state==="bad" ? "bad" : state==="busy" ? "busy" : state==="free" ? "free" : "";
    const title = `${b.type==="washer" ? "Waschmaschine" : "Trockner"} ${b.machine}`;
    const line = `${fmtDate(b.start)} ${fmtTime(b.start)}â€“${fmtTime(b.end)}`;
    let statusTxt = b.status;
    if (b.status==="booked") statusTxt = (b.start<=now && b.end>now) ? "lÃ¤uft" : "gebucht";
    if (b.status==="released") statusTxt = "freigegeben";
    if (b.status==="cancelled") statusTxt = "storniert";

    html.push(`
      <div class="tile ${cls}" style="margin-bottom:10px">
        <div class="tileTop">
          <div>
            <div class="title">${title}</div>
            <div class="meta mono">${line}</div>
            <div class="meta">${statusTxt}</div>
          </div>
          <div class="tag">${statusTxt}</div>
        </div>
        <div class="tileBtns">
          ${renderMyBookingButtons(b, now)}
        </div>
      </div>
    `);
  }
  box.innerHTML = html.join("");

  // attach button handlers
  for (const b of list){
    const btnCancel = document.querySelector(`[data-cancel="${b.id}"]`);
    if (btnCancel){
      btnCancel.onclick = async ()=>{
        try{
          await jpost("/api/booking/cancel", {room:c.room, pin:c.pin, id:b.id});
          toast("âœ… Storniert");
          await refreshAll();
        }catch(e){
          toast("â›” Storno nicht mÃ¶glich");
        }
      };
    }
    const btnRel = document.querySelector(`[data-release="${b.id}"]`);
    if (btnRel){
      btnRel.onclick = async ()=>{
        try{
          await jpost("/api/booking/release", {room:c.room, pin:c.pin, id:b.id});
          toast("âœ… Freigegeben");
          await refreshAll();
        }catch(e){
          toast("â›” Freigeben nicht mÃ¶glich");
        }
      };
    }
  }
}

/* ------------------------------
   NEWS
--------------------------------*/
async function renderNews(){
  const box = el("div",{class:"list"},[
    el("div",{class:"small mono"},["Lade Newsâ€¦"])
  ]);
function renderMyBookingButtons(b, now){
  // stornieren: only if booked & not started & not dryer
  const canCancel = b.status==="booked" && now < b.start && b.type==="washer";
  const canRelease = b.status==="booked" && b.start <= now && b.end > now;

  let out = "";
  if (canCancel) out += `<button data-cancel="${b.id}">Stornieren</button>`;
  if (canRelease) out += `<button data-release="${b.id}">Freigeben</button>`;
  if (!out) out = `<span class="small">Keine Aktion mÃ¶glich.</span>`;
  return out;
}

// ---------- Feedback ----------
async function loadFeedback(showPopup=false){
  const c = getCreds();
  try{
    const r = await api("/api/news");
    const news = r.news || [];
    if (news.length === 0){
      box.innerHTML = `<div class="item"><div class="small">Keine News vorhanden.</div></div>`;
      return viewCard("News", box);
    const r = await jpost("/api/feedback/load", c);
    const box = $("feedbackList");
    if (!r.hasThread){
      box.innerHTML = `<div class="small">Noch kein Feedback vorhanden.</div>`;
      return;
    }
    if (!r.allowUserView){
      box.innerHTML = `<div class="small">Admin hat den Thread aktuell nicht fÃ¼r User freigegeben.</div>`;
      return;
    }
    box.innerHTML = "";
    for (const n of news){
      box.appendChild(el("div",{class:"item"},[
        el("div",{class:"itemTop"},[
          el("div",{},[
            el("div",{class:"title"},[n.title]),
            el("div",{class:"meta"},[new Date(n.created_at).toLocaleString()]),
          ]),
          n.pinned ? el("div",{class:"tag warn"},["PIN"]) : el("div",{class:"tag"},[""])
        ]),
        el("div",{class:"meta", style:"margin-top:8px;white-space:pre-wrap"},[n.body])
      ]));
    const msgs = r.messages || [];
    box.innerHTML = msgs.map(m=>{
      const who = m.sender==="admin" ? "Admin" : "Du";
      return `<div class="tile ${m.sender==="admin" ? "busy" : "free"}" style="margin-bottom:10px">
        <div class="title">${who}</div>
        <div class="meta mono">${fmtDT(m.ts)}</div>
        <div style="margin-top:6px;white-space:pre-wrap">${escapeHtml(m.message)}</div>
      </div>`;
    }).join("");

    if (showPopup){
      alert("ðŸ’¬ Neue Nachricht im Feedback vorhanden.");
    }
  }catch(e){
    box.innerHTML = `<div class="item"><div class="small">Fehler: ${e.err}</div></div>`;
    toast("â›” Feedback laden fehlgeschlagen");
  }
}

  return viewCard("News", box);
function escapeHtml(s){
  return String(s||"").replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
}

/* ------------------------------
   FEEDBACK
--------------------------------*/
function renderFeedback(){
  const nameInput = el("input",{value:getName(), placeholder:"Dein Name (optional)"});
  const ratingSel = el("select",{});
  for (let i=5;i>=1;i--){
    ratingSel.appendChild(el("option",{value:String(i)},[`${i} / 5`]));
  }
  const msg = el("textarea",{placeholder:"Was lÃ¤uft gut? Was nervt? Was fehlt noch?"});
  const send = el("button",{class:"btn"},["Feedback senden"]);

  send.addEventListener("click", async ()=>{
    const payload = {
      user_name: nameInput.value.trim() || null,
      rating: Number(ratingSel.value),
      message: msg.value.trim()
    };
    if (!payload.message){ toast("Bitte Nachricht schreiben."); return; }
    if (payload.user_name) setName(payload.user_name);
// ---------- Admin UI ----------
async function adminLogin(){
  const pw = $("adminPw").value.trim();
  if (!pw) return toast("Admin Passwort fehlt");
  try{
    await jpost("/api/admin/login", {adminPassword: pw});
    setAdminSession(pw);
    $("adminLoginBox").style.display = "none";
    $("adminBox").style.display = "block";
    toast("âœ… Admin Login OK");
    await adminReload();
  }catch(e){
    toast("â›” Admin Login forbidden");
  }
}
async function adminReload(){
  const s = getAdminSession();
  if (!s){ toast("Admin Session abgelaufen"); return; }
  try{
    const r = await jpost("/api/admin/config/get", {adminPassword: s.pw});
    renderAdminConfig(r.config, r.newsSeenCount||0);
    await adminLoadMachines();
    await adminLoadFeedbackThreads();
  }catch(e){
    toast("â›” Admin Daten laden fehlgeschlagen");
  }
}
function renderAdminConfig(cfg, newsSeenCount){
  // washer hours
  const box = $("washerHoursBox");
  box.innerHTML = "";
  const selected = new Set((cfg.washerHours||[]).map(String));
  for (let h=0; h<=23; h++){
    const id = `wh_${h}`;
    const div = document.createElement("div");
    div.style.display="inline-block";
    div.style.margin="4px 8px 4px 0";
    div.innerHTML = `<label style="display:inline-flex;gap:8px;align-items:center">
      <input type="checkbox" id="${id}" ${selected.has(String(h)) ? "checked":""} />
      <span class="mono">${String(h).padStart(2,"0")}:00</span>
    </label>`;
    box.appendChild(div);
  }

    send.disabled = true;
    send.textContent = "Sendeâ€¦";
    try{
      const r = await api("/api/feedback",{method:"POST", body: JSON.stringify(payload)});
      toast(`âœ… Danke! Feedback-ID: ${r.id}`);
      msg.value = "";
    }catch(e){
      toast(`â›” Fehler: ${e.err}`);
    }finally{
      send.disabled = false;
      send.textContent = "Feedback senden";
    }
  });
  // dryer minutes
  $("dryerMinutes").value = String(cfg.dryerMinutes || 120);

  // days window
  $("daysPast").value = String(cfg.daysPast ?? 1);
  $("daysFuture").value = String(cfg.daysFuture ?? 6);

  // news
  $("newsEnabled").checked = !!cfg.newsEnabled;
  $("newsText").value = cfg.newsText || "";
  $("bumpNewsVersion").checked = false;
  $("newsSeenCount").textContent = cfg.newsEnabled
    ? `Gelesen-ZÃ¤hler (aktuelle Version ${cfg.newsVersion||0}): ${newsSeenCount}`
    : `News ist aktuell deaktiviert.`;
  // defect
  $("userDefectEnabled").checked = !!cfg.userDefectEnabled;

  return el("div",{class:"grid"},[
    viewCard("Feedback", el("div",{},[
      el("label",{},["Name (optional)"]),
      nameInput,
      el("label",{},["Bewertung"]),
      ratingSel,
      el("label",{},["Nachricht"]),
      msg,
      send,
      el("div",{class:"small", style:"margin-top:10px"},[
        "Feedback landet direkt in der D1-Datenbank (Tabelle: feedback)."
      ])
    ])),
    viewCard("Was ist neu im Alpha?", el("div",{},[
      el("div",{class:"item"},[
        el("div",{class:"title"},["âœ… Overbooking-Schutz"]),
        el("div",{class:"meta"},["Buchungen mit Ãœberschneidung werden blockiert (409)."])
      ]),
      el("div",{class:"item"},[
        el("div",{class:"title"},["âœ… News"]),
        el("div",{class:"meta"},["Aktuelle Infos aus der Tabelle 'news'."])
      ]),
      el("div",{class:"item"},[
        el("div",{class:"title"},["âœ… Trockner integriert"]),
        el("div",{class:"meta"},["Buchen & Live-Belegung wie bei Waschmaschinen."])
      ]),
    ])),
  ]);
  // defect allowed matrix
  const da = cfg.userDefectAllowed || {washer:{},dryer:{}};
  const target = $("defectAllowedBox");
  target.innerHTML = "";
  target.appendChild(document.createElement("div")).innerHTML = `<div class="small">Pro Maschine aktivieren:</div>`;
  for (const t of ["washer","dryer"]){
    const title = document.createElement("div");
    title.style.marginTop="8px";
    title.innerHTML = `<div class="title">${t==="washer"?"Waschmaschinen":"Trockner"}</div>`;
    target.appendChild(title);
    for (let i=1;i<=4;i++){
      const id = `da_${t}_${i}`;
      const on = !!(da[t] && da[t][String(i)]);
      const row = document.createElement("div");
      row.style.display="inline-block";
      row.style.margin="4px 8px 4px 0";
      row.innerHTML = `<label style="display:inline-flex;gap:8px;align-items:center">
        <input type="checkbox" id="${id}" ${on?"checked":""} />
        <span>${t==="washer"?"WM":"TR"} ${i}</span>
      </label>`;
      target.appendChild(row);
    }
  }
}

/* ------------------------------
   Main render
--------------------------------*/
async function render(){
  renderTabs();
  const v = $("#view");
  v.innerHTML = "";
async function adminLoadMachines(){
  // use current STATE from last refresh for display if possible; else refresh via user refresh is not admin
  // For simplicity: use STATE.machines (must have been loaded at least once)
  const m = STATE.machines || [];
  const box = $("adminMachines");
  box.innerHTML = "";

  if (activeTab === "book"){
    v.appendChild(bookingForm("washer"));
    return;
  const groups = [
    {type:"washer", label:"Waschmaschinen"},
    {type:"dryer", label:"Trockner"},
  ];

  for (const g of groups){
    const title = document.createElement("div");
    title.innerHTML = `<div class="title">${g.label}</div>`;
    title.style.margin="8px 0";
    box.appendChild(title);

    for (let i=1;i<=4;i++){
      const mm = m.find(x=>x.type===g.type && x.machine===i) || {enabled:1, defect:0};
      const idEn = `m_${g.type}_${i}_en`;
      const idDe = `m_${g.type}_${i}_de`;

      const row = document.createElement("div");
      row.style.border="1px solid var(--line)";
      row.style.borderRadius="14px";
      row.style.padding="10px";
      row.style.marginBottom="8px";
      row.innerHTML = `
        <div style="display:flex;justify-content:space-between;gap:10px;align-items:center">
          <div><b>${g.type==="washer"?"WM":"TR"} ${i}</b></div>
          <div class="small">letztes Zimmer: ${mm.lastRoom || "-"}</div>
        </div>
        <div style="margin-top:8px;display:flex;gap:12px;flex-wrap:wrap">
          <label style="display:inline-flex;gap:8px;align-items:center">
            <input type="checkbox" id="${idEn}" ${mm.enabled? "checked":""}/>
            <span>aktiv (nicht gesperrt)</span>
          </label>
          <label style="display:inline-flex;gap:8px;align-items:center">
            <input type="checkbox" id="${idDe}" ${mm.defect? "checked":""}/>
            <span>defekt</span>
          </label>
        </div>
      `;
      box.appendChild(row);
    }
  }
}

  if (activeTab === "dryer"){
    v.appendChild(bookingForm("dryer"));
    return;
async function adminLoadFeedbackThreads(){
  const s = getAdminSession(); if (!s) return;
  const box = $("adminFeedbackThreads");
  box.innerHTML = `<div class="small mono">Ladeâ€¦</div>`;
  try{
    const r = await jpost("/api/admin/feedback/list", {adminPassword: s.pw});
    const threads = r.threads || [];
    if (threads.length===0){
      box.innerHTML = `<div class="small">Keine Feedbacks.</div>`;
      return;
    }
    box.innerHTML = threads.map(t=>{
      const unread = t.adminUnread ? " (NEU)" : "";
      return `<div class="tile ${t.adminUnread? "busy":"free"}" style="margin-bottom:10px">
        <div class="tileTop">
          <div>
            <div class="title">Zimmer ${t.room}${unread}</div>
            <div class="meta mono">updated: ${fmtDT(t.updatedAt)}</div>
            <div class="meta">User-Sichtbar: ${t.allowUserView ? "ja":"nein"}</div>
          </div>
          <button class="btn inline secondary" data-open-thread="${t.id}">Ã–ffnen</button>
        </div>
      </div>`;
    }).join("");

    document.querySelectorAll("[data-open-thread]").forEach(btn=>{
      btn.onclick = ()=> adminOpenThread(btn.getAttribute("data-open-thread"));
    });

  }catch(e){
    box.innerHTML = `<div class="small">Fehler beim Laden.</div>`;
  }
}

  if (activeTab === "mine"){
    v.appendChild(await renderMine());
    return;
async function adminOpenThread(threadId){
  const s = getAdminSession(); if (!s) return;
  const view = $("adminFeedbackThreadView");
  view.innerHTML = `<div class="small mono">Lade Threadâ€¦</div>`;
  try{
    const r = await jpost("/api/admin/feedback/thread", {adminPassword:s.pw, threadId});
    const t = r.thread;
    const msgs = r.messages || [];

    const allowId = "allowUserViewToggle";
    view.innerHTML = `
      <div class="tile busy">
        <div class="title">Thread Zimmer ${t.room}</div>
        <div class="meta mono">created: ${fmtDT(t.createdAt)} Â· updated: ${fmtDT(t.updatedAt)}</div>
        <div style="margin-top:8px">
          <label style="display:inline-flex;gap:8px;align-items:center">
            <input type="checkbox" id="${allowId}" ${t.allowUserView? "checked":""}/>
            <span>User darf Antworten sehen</span>
          </label>
        </div>
      </div>
      <div style="margin-top:10px">
        ${msgs.map(m=>`
          <div class="tile ${m.sender==="admin" ? "busy":"free"}" style="margin-bottom:10px">
            <div class="tileTop">
              <div>
                <div class="title">${m.sender==="admin" ? "Admin" : "User"}</div>
                <div class="meta mono">${fmtDT(m.ts)}</div>
              </div>
              <div class="tag">sichtbar: ${m.visibleToUser? "ja":"nein"}</div>
            </div>
            <div style="margin-top:6px;white-space:pre-wrap">${escapeHtml(m.message)}</div>
          </div>
        `).join("")}
      </div>

      <label>Antwort</label>
      <textarea id="adminReplyText" placeholder="Antwort an Userâ€¦"></textarea>

      <label style="display:inline-flex;gap:8px;align-items:center;margin-top:8px">
        <input type="checkbox" id="adminVisibleToUser" checked />
        <span>Antwort fÃ¼r User sichtbar</span>
      </label>

      <button class="btn" id="btnAdminSendReply">Antwort senden</button>
    `;

    $("btnAdminSendReply").onclick = async ()=>{
      const msg = $("adminReplyText").value.trim();
      if (!msg) return toast("Antwort fehlt");
      const visible = $("adminVisibleToUser").checked;
      const allowUserView = $(allowId).checked;

      try{
        await jpost("/api/admin/feedback/send", {adminPassword:s.pw, threadId, message:msg, visibleToUser:visible, allowUserView});
        toast("âœ… Antwort gesendet");
        await adminOpenThread(threadId);
        await adminLoadFeedbackThreads();
      }catch(e){
        toast("â›” Senden fehlgeschlagen");
      }
    };

  }catch(e){
    view.innerHTML = `<div class="small">Fehler beim Thread laden.</div>`;
  }
}

  if (activeTab === "news"){
    v.appendChild(await renderNews());
// ---------- main refresh ----------
async function refreshAll(){
  const c = getCreds();
  if (!c.room || !c.pin || !c.stationPin){
    toast("Bitte Zugang vollstÃ¤ndig eingeben");
    return;
  }
  $("btnRefresh").disabled = true;
  $("btnRefresh").textContent = "Ladeâ€¦";

  if (activeTab === "feedback"){
    v.appendChild(renderFeedback());
    return;
  try{
    const r = await jpost("/api/user/refresh", c);
    STATE = r;

    renderNewsBox();
    renderSlotDropdown();
    renderTiles();
    renderMyBookings();

    // feedback popup if new
    if (r.feedback && r.feedback.userUnread) {
      alert("ðŸ’¬ Neues Feedback vom Admin vorhanden.");
    }

    toast("âœ… Bereit");
  }catch(e){
    const msg = e?.data?.message || e?.data?.error || "Fehler";
    toast("â›” " + msg);
  }finally{
    $("btnRefresh").disabled = false;
    $("btnRefresh").textContent = "Aktualisieren";
  }
}

// ---------- events ----------
$("btnRefresh").onclick = refreshAll;

// Enter triggers
$("pin").addEventListener("keydown", (e)=>{ if (e.key==="Enter") refreshAll(); });
$("stationPin").addEventListener("keydown", (e)=>{ if (e.key==="Enter") refreshAll(); });

// Book washer from dropdown
$("btnBookWasher").onclick = async ()=>{
  const c = getCreds();
  const v = $("slotSelect").value;
  if (!c.room || !c.pin || !c.stationPin) return toast("Bitte Zugang eingeben");
  if (!v) return toast("Bitte Slot auswÃ¤hlen");

  const slot = JSON.parse(v);
  try{
    const r = await jpost("/api/washer/book", {
      room: c.room, pin: c.pin, stationPin: c.stationPin,
      machine: slot.machine,
      start: slot.start,
      end: slot.end
    });
    alert("âœ… Gebucht!");
    await refreshAll();
  }catch(e){
    const msg = e?.data?.message || e?.data?.error || "Fehler";
    alert("â›” " + msg);
  }
};

// Feedback
$("btnLoadFeedback").onclick = ()=> loadFeedback(false);
$("btnSendFeedback").onclick = async ()=>{
  const c = getCreds();
  const msg = $("feedbackText").value.trim();
  if (!c.room || !c.pin || !c.stationPin) return toast("Bitte Zugang eingeben");
  if (!msg) return toast("Nachricht fehlt");
  try{
    await jpost("/api/feedback/send", {...c, message: msg});
    $("feedbackText").value = "";
    toast("âœ… Gesendet");
    await loadFeedback(false);
    await refreshAll();
  }catch(e){
    toast("â›” Feedback senden fehlgeschlagen");
  }
};

// Admin
$("btnAdminLogin").onclick = adminLogin;
$("adminPw").addEventListener("keydown", (e)=>{ if (e.key==="Enter") adminLogin(); });

$("btnAdminLogout").onclick = ()=>{
  clearAdminSession();
  $("adminBox").style.display = "none";
  $("adminLoginBox").style.display = "block";
  toast("âœ… Logout");
};

$("btnAdminReload").onclick = adminReload;

$("btnSetStationPin").onclick = async ()=>{
  const s = getAdminSession(); if (!s) return toast("Admin Session abgelaufen");
  const sp = $("adminStationPin").value.trim();
  try{
    const ok = confirm2("Stations-PIN speichern?", "Wird gespeichertâ€¦");
    if (!ok) return;
    await jpost("/api/admin/set-station-pin", {adminPassword:s.pw, stationPin: sp});
    toast("âœ… Stations-PIN gespeichert");
  }catch(e){
    toast("â›” Fehler beim Speichern");
  }
};

$("btnChangeAdminPw").onclick = async ()=>{
  const s = getAdminSession(); if (!s) return toast("Admin Session abgelaufen");
  const npw = $("adminNewPw").value.trim();
  if (!npw) return toast("Neues Passwort fehlt");
  try{
    const ok = confirm2("Admin-Passwort Ã¤ndern?", "Wird geÃ¤ndertâ€¦");
    if (!ok) return;
    await jpost("/api/admin/change-password", {adminPassword:s.pw, newPassword: npw});
    toast("âœ… Admin Passwort geÃ¤ndert");
    // keep session but update stored pw to new
    setAdminSession(npw);
  }catch(e){
    toast("â›” Fehler beim Ã„ndern");
  }
};

$("btnSaveWasherHours").onclick = async ()=>{
  const s = getAdminSession(); if (!s) return toast("Admin Session abgelaufen");
  try{
    const ok = confirm2("Waschzeiten speichern?", "Gespeichert.");
    if (!ok) return;

    const hours = [];
    for (let h=0; h<=23; h++){
      const cb = document.getElementById(`wh_${h}`);
      if (cb && cb.checked) hours.push(h);
    }
    await jpost("/api/admin/config/set", {adminPassword:s.pw, washerHours: hours});
    toast("âœ… Waschzeiten gespeichert");
    await adminReload();
    await refreshAll();
  }catch(e){
    toast("â›” Fehler beim Speichern");
  }
};

$("btnSaveDryerMinutes").onclick = async ()=>{
  const s = getAdminSession(); if (!s) return toast("Admin Session abgelaufen");
  try{
    const ok = confirm2("Trockner-Dauer speichern?", "Gespeichert.");
    if (!ok) return;
    await jpost("/api/admin/config/set", {adminPassword:s.pw, dryerMinutes: Number($("dryerMinutes").value)});
    toast("âœ… Trockner-Dauer gespeichert");
    await adminReload();
    await refreshAll();
  }catch(e){
    toast("â›” Fehler beim Speichern");
  }
};

$("btnSaveDaysWindow").onclick = async ()=>{
  const s = getAdminSession(); if (!s) return toast("Admin Session abgelaufen");
  try{
    const ok = confirm2("Tage-Fenster speichern?", "Gespeichert.");
    if (!ok) return;
    await jpost("/api/admin/config/set", {
      adminPassword:s.pw,
      daysPast: Number($("daysPast").value),
      daysFuture: Number($("daysFuture").value),
    });
    toast("âœ… Tage-Fenster gespeichert");
    await adminReload();
    await refreshAll();
  }catch(e){
    toast("â›” Fehler beim Speichern");
  }
};

$("btnSaveNews").onclick = async ()=>{
  const s = getAdminSession(); if (!s) return toast("Admin Session abgelaufen");
  try{
    const ok = confirm2("News speichern?", "Gespeichert.");
    if (!ok) return;
    await jpost("/api/admin/config/set", {
      adminPassword:s.pw,
      newsEnabled: $("newsEnabled").checked,
      newsText: $("newsText").value,
      bumpNewsVersion: $("bumpNewsVersion").checked
    });
    toast("âœ… News gespeichert");
    await adminReload();
    await refreshAll();
  }catch(e){
    toast("â›” Fehler beim Speichern");
  }
};

$("btnSaveMachines").onclick = async ()=>{
  const s = getAdminSession(); if (!s) return toast("Admin Session abgelaufen");
  try{
    const ok = confirm2("Maschinen speichern?", "Gespeichert.");
    if (!ok) return;

    const updates = [];
    for (const type of ["washer","dryer"]){
      for (let i=1;i<=4;i++){
        const en = document.getElementById(`m_${type}_${i}_en`)?.checked ? 1 : 0;
        const de = document.getElementById(`m_${type}_${i}_de`)?.checked ? 1 : 0;
        updates.push({type, machine:i, enabled: en, defect: de});
      }
    }
    await jpost("/api/admin/machines/set", {adminPassword:s.pw, updates});
    toast("âœ… Maschinen gespeichert");
    await refreshAll();
    await adminReload();
  }catch(e){
    toast("â›” Fehler beim Speichern");
  }
};

$("btnSaveDefectRules").onclick = async ()=>{
  const s = getAdminSession(); if (!s) return toast("Admin Session abgelaufen");
  try{
    const ok = confirm2("Defekt-Regeln speichern?", "Gespeichert.");
    if (!ok) return;

    const allowed = { washer:{}, dryer:{} };
    for (const t of ["washer","dryer"]){
      for (let i=1;i<=4;i++){
        const id = `da_${t}_${i}`;
        allowed[t][String(i)] = !!document.getElementById(id)?.checked;
      }
    }

    await jpost("/api/admin/config/set", {
      adminPassword: s.pw,
      userDefectEnabled: $("userDefectEnabled").checked,
      userDefectAllowed: allowed
    });
    toast("âœ… Defekt-Regeln gespeichert");
    await adminReload();
    await refreshAll();
  }catch(e){
    toast("â›” Fehler beim Speichern");
  }
};

$("btnLoadLogs").onclick = async ()=>{
  const s = getAdminSession(); if (!s) return toast("Admin Session abgelaufen");
  const box = $("logsBox");
  box.innerHTML = `<div class="small mono">Ladeâ€¦</div>`;
  try{
    const r = await jpost("/api/admin/logs", {adminPassword:s.pw, limit:200});
    const logs = r.logs || [];
    box.innerHTML = logs.map(l=>{
      const meta = l.meta ? escapeHtml(l.meta) : "{}";
      return `<div class="tile" style="margin-bottom:10px;background:var(--pastelGray)">
        <div class="title">${escapeHtml(l.action)}</div>
        <div class="meta mono">${fmtDT(l.ts)} Â· ${escapeHtml(l.actor)} Â· ${escapeHtml(l.room)}</div>
        <div class="small mono" style="margin-top:6px;white-space:pre-wrap">${meta}</div>
      </div>`;
    }).join("");
  }catch(e){
    box.innerHTML = `<div class="small">Fehler.</div>`;
  }
};

// Boot: if admin session exists, show admin box
(async function boot(){
  try{
    const s = await api("/api/_status?ts="+Date.now());
    console.log("Worker status:", s);
    const s = await jget("/api/_status?ts="+Date.now());
    console.log("status", s);
  }catch(e){
    console.warn("Worker not reachable:", e);
    toast("âš ï¸ Worker nicht erreichbar. PrÃ¼fe WORKER_BASE in index.html");
    toast("âš ï¸ Worker nicht erreichbar â€“ API_BASE prÃ¼fen");
  }

  const sess = getAdminSession();
  if (sess){
    $("adminLoginBox").style.display="none";
    $("adminBox").style.display="block";
    await adminReload();
  }
  render();
})();
</script>
</body>
