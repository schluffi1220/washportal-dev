<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Washportal DEV</title>
  <style>
    :root{
      --bg:#ffffff;
      --text:#0b0b0b;
      --muted:#666;
      --border:#ddd;
      --card:#f7f7f7;

      --freeBg:#e9f7ec;
      --bookedBg:#e8f2ff;
      --defectBg:#ffe8ea;
      --blockedBg:#fff1db;

      --freeDot:#1e8e3e;
      --bookedDot:#1a73e8;
      --defectDot:#d93025;
      --blockedDot:#f29900;
    }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--text); margin:0; padding:14px;}
    .wrap{max-width:980px; margin:0 auto;}
    h1{margin:0 0 4px 0;}
    .sub{color:var(--muted); margin-bottom:10px;}
    .box{border:1px solid var(--border); border-radius:14px; padding:12px; background:#fff; margin-bottom:12px;}
    .status{padding:10px; background:var(--card); border-radius:12px; border:1px solid var(--border); margin-bottom:12px;}
    label{display:block; font-weight:700; margin:8px 0 4px;}
    input,select,textarea{width:100%; padding:10px; border:1px solid var(--border); border-radius:10px; font-size:16px;}
    input[type=password]{letter-spacing:2px;}
    button{padding:10px 14px; border-radius:10px; border:0; background:#111; color:#fff; font-size:16px; cursor:pointer;}
    button.secondary{background:#eee; color:#111; border:1px solid var(--border);}
    button:disabled{opacity:.5; cursor:not-allowed;}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .grid{display:grid; grid-template-columns:1fr; gap:10px;}
    @media(min-width:720px){ .grid{grid-template-columns:1fr 1fr;} }

    .tile{border:1px solid var(--border); border-radius:16px; padding:12px; display:flex; justify-content:space-between; gap:10px; align-items:flex-start;}
    .left{display:flex; gap:10px; align-items:flex-start;}
    .dot{width:16px;height:16px;border-radius:50%; margin-top:4px;}
    .title{font-weight:900;}
    .small{color:var(--muted); font-size:13px;}
    .pill{display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid var(--border); font-size:12px; margin-left:6px;}
    .bg-free{background:var(--freeBg);}
    .bg-booked{background:var(--bookedBg);}
    .bg-defect{background:var(--defectBg);}
    .bg-blocked{background:var(--blockedBg);}

    details summary{cursor:pointer; font-weight:900;}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-size:12px;}
    .timeGrid{display:grid; grid-template-columns:repeat(6, minmax(0,1fr)); gap:8px; margin-top:8px;}
    .timeChip{display:flex; align-items:center; gap:8px; padding:10px; border-radius:12px; border:1px solid rgba(0,0,0,.12); background:rgba(255,255,255,.85);}
    .timeChip input{transform:scale(1.15);}
    .chatMsg{border:1px solid var(--border); border-radius:12px; padding:10px; margin:8px 0;}
    .chatUser{background:var(--bookedBg);}
    .chatAdmin{background:#f3f3ff;}
    .chatMeta{display:flex; gap:8px; align-items:center; justify-content:space-between;}
  </style>
</head>
<body>
<div class="wrap">

  <h1>Washportal DEV</h1>
  <div class="sub">Build stabil â€¢ Slots Dropdown â€¢ Freigeben/Storno â€¢ News â€¢ Feedback</div>

  <div id="status" class="status">Ladeâ€¦</div>

  <!-- Version Info (User) -->
  <div class="box">
    <details id="newsDetails">
      <summary>Was ist neu?</summary>
      <div id="newsText" class="small" style="margin-top:8px; white-space:pre-wrap;"></div>
    </details>
  </div>

  <!-- 1) Zugang -->
  <div class="box">
    <h2>1) Zugang</h2>

    <label>Zimmernummer (0â€“400)</label>
    <input id="room" inputmode="numeric" placeholder="z.B. 316"/>

    <label>PIN (4-stellig)</label>
    <input id="pin" type="password" inputmode="numeric" placeholder="****"/>

    <label>Stations-PIN</label>
    <input id="stationPin" type="password" inputmode="numeric" placeholder="****"/>

    <div class="row" style="margin-top:10px">
      <button onclick="refreshAll()">Aktualisieren</button>
      <button class="secondary" onclick="clearAccess()">Leeren</button>
    </div>
  </div>

  <!-- 2) Slots buchen -->
  <div class="box">
    <h2>2) Slots buchen</h2>
    <label>Freier Slot (Dropdown)</label>
    <select id="slotSelect"></select>

    <div class="row" style="margin-top:10px">
      <button onclick="bookSelected()">Buchen</button>
    </div>
    <div class="small" style="margin-top:8px">
      Belegte/defekte/gesperrte Slots sind sichtbar aber nicht buchbar (grau).
    </div>
  </div>

  <!-- 3) MaschinenÃ¼bersicht -->
  <div class="box">
    <h2>3) MaschinenÃ¼bersicht</h2>
    <div id="machinesGrid" class="grid"></div>
  </div>

  <!-- 4) Meine Buchungen -->
  <div class="box">
    <h2>4) Meine Buchungen</h2>
    <div class="row">
      <button class="secondary" onclick="loadMyBookings()">Meine Buchungen aktualisieren</button>
    </div>
    <div id="myBookings" style="margin-top:10px"></div>
  </div>

  <!-- 5) Feedback / Antworten -->
  <div class="box">
    <h2>5) Feedback / Antworten</h2>
    <div id="feedbackBox"></div>

    <label>Nachricht</label>
    <textarea id="fbText" rows="3" placeholder="Dein Feedback..."></textarea>
    <div class="row" style="margin-top:8px">
      <button onclick="sendFeedback()">Absenden</button>
      <button class="secondary" onclick="loadFeedback()">Neu laden</button>
    </div>
  </div>

  <!-- 6) Admin -->
  <div class="box">
    <h2>6) Admin</h2>

    <div class="row">
      <div style="flex:1; min-width:240px">
        <label>Admin-Passwort</label>
        <input id="adminPw" type="password" placeholder="z.B. initial" onkeydown="if(event.key==='Enter'){adminLogin()}"/>
        <div class="row" style="margin-top:8px">
          <button onclick="adminLogin()">Login</button>
          <button class="secondary" onclick="adminLogout()">Logout</button>
        </div>
        <div id="adminState" class="small" style="margin-top:6px;"></div>
      </div>

      <div style="flex:1; min-width:240px">
        <label>Stations-PIN setzen/Ã¤ndern</label>
        <input id="adminStationPin" type="password" placeholder="z.B. 1111" inputmode="numeric"/>
        <button style="margin-top:8px" onclick="adminSetStationPin()">Stations-PIN speichern</button>
      </div>
    </div>

    <hr style="border:0; height:1px; background:var(--border); margin:12px 0;"/>

    <details>
      <summary>Admin-Passwort Ã¤ndern</summary>
      <label>Neues Admin-Passwort (min. 8 Zeichen)</label>
      <input id="adminPwNew" type="password" placeholder="Neues Passwort"/>
      <button style="margin-top:8px" onclick="adminChangePw()">Passwort Ã¤ndern</button>
    </details>

    <hr style="border:0; height:1px; background:var(--border); margin:12px 0;"/>

    <details open>
      <summary>Tage-Fenster</summary>
      <div class="row">
        <div style="flex:1; min-width:140px">
          <label>Vergangene Tage</label>
          <input id="daysPast" inputmode="numeric" placeholder="1"/>
        </div>
        <div style="flex:1; min-width:140px">
          <label>ZukÃ¼nftige Tage</label>
          <input id="daysFuture" inputmode="numeric" placeholder="6"/>
        </div>
      </div>
      <button style="margin-top:8px" onclick="adminSaveDays()">Speichern</button>
    </details>

    <hr style="border:0; height:1px; background:var(--border); margin:12px 0;"/>

    <details open>
      <summary>Waschzeiten (Haken 0â€“23)</summary>
      <div id="washerTimesGrid" class="timeGrid"></div>
      <button style="margin-top:8px" onclick="adminSaveWasherTimes()">Speichern</button>
    </details>

    <hr style="border:0; height:1px; background:var(--border); margin:12px 0;"/>

    <details>
      <summary>User darf Defekt melden?</summary>
      <div class="row" style="margin-top:8px">
        <label style="display:flex; gap:8px; align-items:center; font-weight:700;">
          <input id="userDefectEnabled" type="checkbox"/>
          Defekt melden erlaubt
        </label>
        <button onclick="adminSaveUserDefect()">Speichern</button>
      </div>
      <div class="small">ZusÃ¤tzlich pro Maschine sperrbar Ã¼ber die Maschinenkacheln (Admin).</div>
    </details>

    <hr style="border:0; height:1px; background:var(--border); margin:12px 0;"/>

    <details>
      <summary>Versionsinfo (Was ist neu?)</summary>
      <label>Text (fÃ¼r User sichtbar)</label>
      <textarea id="adminNewsText" rows="3" placeholder="Was ist neu..."></textarea>
      <div class="row" style="margin-top:8px">
        <button onclick="adminSaveNews()">Speichern</button>
        <button class="secondary" onclick="adminNewsSeen()">Gesehen-ZÃ¤hler</button>
      </div>
      <div id="newsSeenInfo" class="small" style="margin-top:6px;"></div>
    </details>

    <hr style="border:0; height:1px; background:var(--border); margin:12px 0;"/>

    <details>
      <summary>Feedback (Admin)</summary>
      <div class="row" style="margin-top:8px">
        <button class="secondary" onclick="adminLoadThreads()">Threads laden</button>
      </div>
      <div id="adminThreads" class="small" style="margin-top:8px;"></div>

      <div id="adminChat" style="margin-top:10px; display:none;">
        <div class="small" id="adminChatTitle"></div>
        <div id="adminChatMsgs"></div>

        <label>Antwort</label>
        <textarea id="adminReplyText" rows="3" placeholder="Admin Antwort..."></textarea>

        <label style="display:flex; gap:8px; align-items:center; font-weight:700;">
          <input id="adminReplyVisible" type="checkbox" checked/>
          FÃ¼r User sichtbar
        </label>

        <div class="row" style="margin-top:8px">
          <button onclick="adminSendReply()">Senden</button>
          <button class="secondary" onclick="adminReloadRoom()">Neu laden</button>
        </div>
      </div>
    </details>

  </div>

</div>

<script>
/* ====== API BASE ====== */
const API_BASE = "https://washportal-dev-worker.schluffi1220.workers.dev";

/* ====== State ====== */
let statusCache = null;
let isAdmin = false;
let adminLast = 0;
let currentNewsVer = 0;
let currentRoomInAdminChat = "";

const $ = (id)=>document.getElementById(id);

function setStatus(msg){ $("status").textContent = msg; }
function corsWarn(obj){ alert(JSON.stringify(obj,null,2)); }

async function jget(path){
  const r = await fetch(API_BASE + path, { cache:"no-store" });
  return await r.json().catch(()=>({ok:false}));
}
async function jpost(path, body){
  const r = await fetch(API_BASE + path, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(body||{})
  });
  const data = await r.json().catch(()=>({ok:false}));
  return { r, data };
}

/* ====== Formatting Berlin time ====== */
function fmtDT(ms){
  const d = new Date(ms);
  return new Intl.DateTimeFormat("de-DE", {
    timeZone:"Europe/Berlin",
    day:"2-digit", month:"2-digit", year:"numeric",
    hour:"2-digit", minute:"2-digit"
  }).format(d);
}
function fmtTime(ms){
  const d = new Date(ms);
  return new Intl.DateTimeFormat("de-DE", {
    timeZone:"Europe/Berlin",
    hour:"2-digit", minute:"2-digit"
  }).format(d);
}

function clearAccess(){
  $("room").value="";
  $("pin").value="";
  $("stationPin").value="";
}

function bgForState(state){
  if(state==="free") return "bg-free";
  if(state==="booked") return "bg-booked";
  if(state==="defect") return "bg-defect";
  return "bg-blocked";
}
function dotForState(state){
  if(state==="free") return "var(--freeDot)";
  if(state==="booked") return "var(--bookedDot)";
  if(state==="defect") return "var(--defectDot)";
  return "var(--blockedDot)";
}

/* ====== Boot ====== */
(async function boot(){
  setStatus("Lade Statusâ€¦");
  const s = await jget("/api/status");
  if(!s.ok){ setStatus("Fehler"); corsWarn(s); return; }
  statusCache = s;
  currentNewsVer = Number(s.newsVer||0);

  setStatus("Bereit â€¢ Build: " + s.build);

  $("newsText").textContent = s.newsText || "(leer)";
  // default collapsed
  $("newsDetails").open = false;

  fillAdminDefaults();
  renderWasherTimesGrid(s.config?.washerTimes || []);
  renderSlotSelect([]);
  renderMachines();

  // If user already has access filled -> try load slots (no auto)
})();

function fillAdminDefaults(){
  const cfg = statusCache?.config || {};
  $("daysPast").value = cfg.daysPast ?? 1;
  $("daysFuture").value = cfg.daysFuture ?? 6;
  $("userDefectEnabled").checked = !!cfg.userDefectEnabled;
  $("adminNewsText").value = statusCache?.newsText || "";
}

/* ====== News popup (once per version per room) ====== */
async function checkNewsPopupAfterAccess(){
  const room = $("room").value.trim();
  const pin = $("pin").value.trim();
  const stationPin = $("stationPin").value.trim();

  if(!room || !pin || !stationPin) return;

  // ask worker what room has already seen
  const {data} = await jpost("/api/news/seen-version", { room, pin, stationPin });
  if(!data?.ok) return;

  const seenVer = Number(data.seenVer||0);
  if(currentNewsVer > seenVer && (statusCache?.newsText||"").trim()){
    // show once
    alert("ðŸ†• Was ist neu?\n\n" + (statusCache.newsText||""));
    // mark seen
    await jpost("/api/news/mark-seen", { room, pin, stationPin });
    $("newsDetails").open = true;
  }
}

/* ====== Slots ====== */
function renderSlotSelect(slots){
  const sel = $("slotSelect");
  sel.innerHTML="";
  if(!slots || slots.length===0){
    const o=document.createElement("option");
    o.value=""; o.textContent="Bitte auswÃ¤hlen";
    sel.appendChild(o);
    sel.disabled=true;
    return;
  }
  sel.disabled=false;
  for(const s of slots){
    const label = `${fmtDT(s.start)}â€“${fmtTime(s.end)} â€¢ Waschmaschine ${s.machine} â€¢ ${s.state}${s.reason?(" ("+s.reason+")"):""}`;
    const opt=document.createElement("option");
    opt.value=JSON.stringify({start:s.start, machine:s.machine});
    opt.textContent=label;

    const disabled = (s.state!=="free");
    opt.disabled=disabled;
    if(disabled) opt.style.color="#777";
    sel.appendChild(opt);
  }
  // auto-select first free
  const idx = slots.findIndex(x=>x.state==="free");
  if(idx>=0) sel.selectedIndex=idx;
}

async function refreshAll(){
  const room = $("room").value.trim();
  const pin = $("pin").value.trim();
  const stationPin = $("stationPin").value.trim();

  if(!room || !pin || !stationPin){
    alert("Bitte Zimmernummer, PIN und Stations-PIN eingeben.");
    return;
  }

  const {data:slotRes} = await jpost("/api/washer/free-slots", { room, pin, stationPin });
  if(!slotRes.ok){
    setStatus("Fehler beim Laden der Slots.");
    corsWarn(slotRes);
  }else{
    renderSlotSelect(slotRes.slots||[]);
    setStatus("Bereit.");
  }

  // refresh status for machines + news
  const s = await jget("/api/status");
  if(s.ok){
    statusCache=s;
    currentNewsVer=Number(s.newsVer||0);
    $("newsText").textContent = s.newsText || "(leer)";
    renderMachines();
    renderWasherTimesGrid(s.config?.washerTimes || []);
    $("userDefectEnabled").checked = !!s.config?.userDefectEnabled;
  }

  // News popup once after valid access
  await checkNewsPopupAfterAccess();

  // Feedback popup check
  await feedbackPopupCheck();
}

async function bookSelected(){
  const room = $("room").value.trim();
  const pin = $("pin").value.trim();
  const stationPin = $("stationPin").value.trim();

  if(!room || !pin || !stationPin){
    alert("Bitte Zimmernummer, PIN und Stations-PIN eingeben.");
    return;
  }

  const raw = $("slotSelect").value;
  if(!raw){ alert("Bitte Slot auswÃ¤hlen"); return; }

  const sel = JSON.parse(raw);
  const start = Number(sel.start);
  const machine = Number(sel.machine);

  if(!confirm("Buchung ausfÃ¼hren?\n\nWaschmaschine "+machine+"\n"+fmtDT(start)+"â€“"+fmtTime(start+2*60*60*1000))){
    return;
  }

  const {data} = await jpost("/api/washer/book", { room, pin, stationPin, start, machine });
  if(!data.ok){ corsWarn(data); return; }

  alert("âœ… Gebucht!");
  await refreshAll();
  await loadMyBookings();
}

/* ====== Machines ====== */
function renderMachines(){
  const grid = $("machinesGrid");
  grid.innerHTML="";

  if(!statusCache) return;

  const machines = statusCache.machines || [];
  const bookings = statusCache.bookings || [];
  const now = Date.now();
  const cfg = statusCache.config || {};

  for(const m of machines){
    const type=m.type;
    const machine=Number(m.machine);
    let state="free";
    let line="Frei";
    let activeBooking=null;

    if(Number(m.enabled)!==1){ state="blocked"; line="Gesperrt"; }
    else if(Number(m.defect)===1){ state="defect"; line="Defekt"; }
    else{
      const b = bookings.find(x=>x.type===type && Number(x.machine)===machine && x.status==="booked" && Number(x.end)>now);
      if(b && Number(b.start)<Number(b.end)){
        state="booked";
        activeBooking=b;
        line = `Belegt bis ${fmtTime(Number(b.end))} (Zimmer ${b.room})`;
      }
    }

    const tile=document.createElement("div");
    tile.className="tile "+bgForState(state);

    const left=document.createElement("div");
    left.className="left";
    const dot=document.createElement("div");
    dot.className="dot";
    dot.style.background=dotForState(state);

    const txt=document.createElement("div");
    const t=document.createElement("div");
    t.className="title";
    t.textContent=(type==="washer"?"Waschmaschine ":"Trockner ")+machine;

    const s=document.createElement("div");
    s.className="small";
    s.textContent=line;

    txt.appendChild(t);
    txt.appendChild(s);

    left.appendChild(dot);
    left.appendChild(txt);

    const right=document.createElement("div");

    // Admin controls (enable/defect)
    if(isAdminActive()){
      const btnBlock=document.createElement("button");
      btnBlock.className="secondary";
      btnBlock.textContent = Number(m.enabled)===1 ? "Sperren" : "Freigeben";
      btnBlock.onclick = ()=>adminToggleEnabled(type, machine, Number(m.enabled)!==1);

      const btnDef=document.createElement("button");
      btnDef.className="secondary";
      btnDef.textContent = Number(m.defect)===1 ? "Defekt frei" : "Defekt";
      btnDef.onclick = ()=>adminToggleDefect(type, machine, Number(m.defect)!==1);

      right.appendChild(btnBlock);
      right.appendChild(document.createElement("div")).style.height="8px";
      right.appendChild(btnDef);
    }else{
      // User defect report (if allowed)
      const canDef = cfg.userDefectEnabled && (cfg.userDefectAllowed?.[type]?.[String(machine)]===true);
      if(canDef && state!=="defect"){
        const btn=document.createElement("button");
        btn.className="secondary";
        btn.textContent="Defekt melden";
        btn.onclick = ()=>userReportDefect(type, machine);
        right.appendChild(btn);
      }
    }

    tile.appendChild(left);
    tile.appendChild(right);
    grid.appendChild(tile);
  }
}

async function userReportDefect(type, machine){
  const room = $("room").value.trim();
  const pin = $("pin").value.trim();
  const stationPin = $("stationPin").value.trim();

  if(!room || !pin || !stationPin){
    alert("Bitte Zimmernummer, PIN und Stations-PIN eingeben.");
    return;
  }

  if(!confirm("Wirklich als DEFECT melden?\n\n"+(type==="washer"?"Waschmaschine ":"Trockner ")+machine)) return;

  const {data} = await jpost("/api/machine/report-defect", { room, pin, stationPin, type, machine });
  if(!data?.ok){ corsWarn(data); return; }

  alert("âœ… Defekt gemeldet");
  await refreshAll();
}

/* ====== My bookings ====== */
async function loadMyBookings(){
  const room = $("room").value.trim();
  const pin = $("pin").value.trim();

  if(!room || !pin){
    alert("Bitte Zimmernummer und PIN eingeben.");
    return;
  }

  const {data} = await jpost("/api/my-bookings", { room, pin });
  const box = $("myBookings");
  box.innerHTML="";

  if(!data.ok){ corsWarn(data); return; }

  const st = await jget("/api/status");
  if(st.ok) statusCache=st;

  const mMap = new Map();
  for(const m of (statusCache.machines||[])){
    mMap.set(m.type+"#"+Number(m.machine), m);
  }

  const now = Date.now();
  const list = data.bookings || [];
  if(list.length===0){
    box.textContent="Keine Buchungen.";
    return;
  }

  for(const b of list){
    const key = b.type+"#"+Number(b.machine);
    const m = mMap.get(key);
    const isDef = m && Number(m.defect)===1;
    const isBlocked = m && Number(m.enabled)!==1;

    const running = (now >= Number(b.start) && now < Number(b.end));
    const expired = (now >= Number(b.end));

    let state = "booked";
    if(isDef) state="defect";
    else if(isBlocked) state="blocked";

    const card=document.createElement("div");
    card.className="box "+bgForState(state);
    card.style.marginBottom="10px";

    const title=document.createElement("div");
    title.className="title";
    title.textContent=(b.type==="washer"?"Waschmaschine ":"Trockner ")+b.machine;

    if(isDef){
      const p=document.createElement("span");
      p.className="pill";
      p.textContent="Defekt";
      title.appendChild(p);
    }
    if(isBlocked){
      const p=document.createElement("span");
      p.className="pill";
      p.textContent="Gesperrt";
      title.appendChild(p);
    }

    const t=document.createElement("div");
    t.className="small";
    t.textContent = `${fmtDT(Number(b.start))}â€“${fmtTime(Number(b.end))}` + (running ? " â€¢ lÃ¤uft" : expired ? " â€¢ vorbei" : " â€¢ geplant");

    const btnRow=document.createElement("div");
    btnRow.className="row";
    btnRow.style.marginTop="10px";

    const btnCancel=document.createElement("button");
    btnCancel.className="secondary";
    btnCancel.textContent="Storno";
    btnCancel.disabled = expired;
    btnCancel.onclick = ()=>cancelBooking(b.id);

    const btnRelease=document.createElement("button");
    btnRelease.className="secondary";
    btnRelease.textContent="Freigeben";
    btnRelease.disabled = (!running);
    btnRelease.onclick = ()=>releaseBooking(b.id);

    btnRow.appendChild(btnCancel);
    btnRow.appendChild(btnRelease);

    card.appendChild(title);
    card.appendChild(t);
    card.appendChild(btnRow);
    box.appendChild(card);
  }
}

async function cancelBooking(id){
  const room = $("room").value.trim();
  const pin = $("pin").value.trim();

  if(!room || !pin){ alert("Zimmernummer + PIN fehlt"); return; }

  if(!confirm("Storno wirklich ausfÃ¼hren?")) return;

  const {data} = await jpost("/api/booking/cancel", { room, pin, id });
  if(!data.ok){ corsWarn(data); return; }

  alert("âœ… Storniert");
  await refreshAll();
  await loadMyBookings();
}

async function releaseBooking(id){
  const room = $("room").value.trim();
  const pin = $("pin").value.trim();
  const stationPin = $("stationPin").value.trim();

  if(!room || !pin || !stationPin){
    alert("Bitte Zimmernummer, PIN und Stations-PIN eingeben.");
    return;
  }

  if(!confirm("Maschine wirklich FREIGEBEN?\n\nSlot lÃ¤uft weiter, aber andere dÃ¼rfen buchen.")) return;

  const {data} = await jpost("/api/booking/release", { room, pin, stationPin, id });
  if(!data.ok){ corsWarn(data); return; }

  alert("âœ… Freigegeben");
  await refreshAll();
  await loadMyBookings();
}

/* ====== Admin session ====== */
function isAdminActive(){
  return isAdmin && (Date.now() - adminLast) < (5*60*1000);
}
function adminTouch(){
  if(!isAdminActive()){
    isAdmin=false;
    $("adminState").textContent="Admin: ausgeloggt (Timeout)";
    return false;
  }
  adminLast=Date.now();
  return true;
}

async function adminLogin(){
  const pw = $("adminPw").value.trim();
  const {data} = await jpost("/api/admin/login", { adminPassword: pw });
  if(!data.ok){ corsWarn(data); isAdmin=false; $("adminState").textContent="Admin: Login fehlgeschlagen"; return; }
  isAdmin=true;
  adminLast=Date.now();
  $("adminState").textContent="Admin: eingeloggt âœ… (5 Min Timeout)";
  await refreshAll();
}

function adminLogout(){
  isAdmin=false;
  adminLast=0;
  $("adminState").textContent="Admin: ausgeloggt";
  alert("Logout âœ…");
  renderMachines();
}

async function adminSetStationPin(){
  if(!adminTouch()) { alert("Bitte neu einloggen."); return; }

  const pw = $("adminPw").value.trim();
  const stationPin = $("adminStationPin").value.trim();

  if(!pw){ alert("Bitte Admin-Passwort im Feld eintragen."); return; }

  const {data} = await jpost("/api/admin/set-station-pin", { adminPassword: pw, stationPin });
  if(!data.ok){ corsWarn(data); return; }
  alert("âœ… Stations-PIN gespeichert");
}

async function adminChangePw(){
  if(!adminTouch()) { alert("Bitte neu einloggen."); return; }

  const pw = $("adminPw").value.trim();
  const newPw = $("adminPwNew").value.trim();

  const {data} = await jpost("/api/admin/change-password", { adminPassword: pw, newPassword: newPw });
  if(!data.ok){ corsWarn(data); return; }
  alert("âœ… Admin-Passwort geÃ¤ndert");
}

async function adminSaveDays(){
  if(!adminTouch()) { alert("Bitte neu einloggen."); return; }

  if(!confirm("Tage-Fenster speichern?")) return;

  const pw = $("adminPw").value.trim();
  const daysPast = $("daysPast").value.trim();
  const daysFuture = $("daysFuture").value.trim();

  const {data} = await jpost("/api/admin/set-days-window", { adminPassword: pw, daysPast, daysFuture });
  if(!data.ok){ corsWarn(data); return; }
  alert("âœ… Gespeichert");
  await refreshAll();
}

/* ====== Washer times grid ====== */
function renderWasherTimesGrid(selectedTimes){
  const grid = $("washerTimesGrid");
  if(!grid) return;
  const selected = new Set((selectedTimes||[]).map(String));
  grid.innerHTML="";

  for(let h=0; h<24; h++){
    const hh = String(h).padStart(2,"0")+":00";
    const lab=document.createElement("label");
    lab.className="timeChip";
    const cb=document.createElement("input");
    cb.type="checkbox";
    cb.value=hh;
    cb.checked = selected.has(hh);
    const sp=document.createElement("span");
    sp.textContent=hh;
    lab.appendChild(cb); lab.appendChild(sp);
    grid.appendChild(lab);
  }
}
function getWasherTimesFromGrid(){
  const grid = $("washerTimesGrid");
  const cbs = [...grid.querySelectorAll("input[type=checkbox]")];
  return cbs.filter(x=>x.checked).map(x=>x.value).sort();
}
async function adminSaveWasherTimes(){
  if(!adminTouch()) { alert("Bitte neu einloggen."); return; }
  if(!confirm("Waschzeiten speichern?")) return;

  const pw = $("adminPw").value.trim();
  const washerTimes = getWasherTimesFromGrid();

  const {data} = await jpost("/api/admin/set-washer-times", { adminPassword: pw, washerTimes });
  if(!data.ok){ corsWarn(data); return; }
  alert("âœ… Waschzeiten gespeichert");
  await refreshAll();
}

/* ====== Admin defect enable ====== */
async function adminSaveUserDefect(){
  if(!adminTouch()) { alert("Bitte neu einloggen."); return; }
  const pw = $("adminPw").value.trim();
  const userDefectEnabled = $("userDefectEnabled").checked;

  const {data} = await jpost("/api/admin/set-user-defect-enabled", { adminPassword: pw, userDefectEnabled });
  if(!data.ok){ corsWarn(data); return; }
  alert("âœ… Gespeichert");
  await refreshAll();
}

/* ====== Admin machine toggles ====== */
async function adminToggleEnabled(type, machine, enable){
  if(!adminTouch()) return;
  const pw = $("adminPw").value.trim();

  const {data} = await jpost("/api/admin/set-machine-flags", { adminPassword: pw, type, machine, enabled: enable });
  if(!data.ok){ corsWarn(data); return; }
  await refreshAll();
}

async function adminToggleDefect(type, machine, makeDefect){
  if(!adminTouch()) return;
  const pw = $("adminPw").value.trim();

  const {data} = await jpost("/api/admin/set-machine-flags", { adminPassword: pw, type, machine, defect: makeDefect });
  if(!data.ok){ corsWarn(data); return; }
  await refreshAll();
}

/* ====== Admin news ====== */
async function adminSaveNews(){
  if(!adminTouch()) { alert("Bitte neu einloggen."); return; }
  if(!confirm("Versionsinfo speichern? (User bekommen einmal Pop-Up)")) return;

  const pw = $("adminPw").value.trim();
  const text = $("adminNewsText").value;

  const {data} = await jpost("/api/admin/set-news", { adminPassword: pw, text });
  if(!data.ok){ corsWarn(data); return; }

  alert("âœ… Versionsinfo gespeichert");
  await refreshAll();
}

async function adminNewsSeen(){
  if(!adminTouch()) { alert("Bitte neu einloggen."); return; }
  const pw = $("adminPw").value.trim();

  const {data} = await jpost("/api/admin/news-seen-count", { adminPassword: pw });
  if(!data.ok){ corsWarn(data); return; }

  $("newsSeenInfo").textContent = `News-Version ${data.ver} â€¢ gesehen von ${data.seenCount} Usern`;
}

/* ====== Feedback user ====== */
function renderFeedback(messages){
  const box = $("feedbackBox");
  box.innerHTML="";

  if(!messages || messages.length===0){
    box.innerHTML = `<div class="small">Noch keine Nachrichten.</div>`;
    return;
  }

  for(const m of messages){
    const div = document.createElement("div");
    div.className = "chatMsg " + (m.sender==="user" ? "chatUser" : "chatAdmin");

    const meta=document.createElement("div");
    meta.className="chatMeta small";
    meta.innerHTML = `<span><b>${m.sender==="user"?"Du":"Admin"}</b> â€¢ ${fmtDT(m.ts)}</span>
                      <span>${m.sender==="admin" ? (m.readByUser? "âœ“ gelesen" : "â€¢ ungelesen") : ""}</span>`;

    const txt=document.createElement("div");
    txt.style.whiteSpace="pre-wrap";
    txt.textContent = m.text;

    div.appendChild(meta);
    div.appendChild(txt);
    box.appendChild(div);
  }
}

async function loadFeedback(){
  const room = $("room").value.trim();
  const pin = $("pin").value.trim();
  const stationPin = $("stationPin").value.trim();

  if(!room || !pin || !stationPin){
    alert("Bitte Zimmernummer, PIN und Stations-PIN eingeben.");
    return;
  }

  const {data} = await jpost("/api/feedback/messages", { room, pin, stationPin });
  if(!data.ok){ corsWarn(data); return; }

  renderFeedback(data.messages||[]);
  // update last seen for popup
  const lastTs = (data.messages||[]).length ? data.messages[data.messages.length-1].ts : 0;
  localStorage.setItem("fb_last_ts_"+room, String(lastTs));
}

async function sendFeedback(){
  const room = $("room").value.trim();
  const pin = $("pin").value.trim();
  const stationPin = $("stationPin").value.trim();
  const text = $("fbText").value.trim();

  if(!room || !pin || !stationPin){
    alert("Bitte Zimmernummer, PIN und Stations-PIN eingeben.");
    return;
  }
  if(!text){
    alert("Bitte Nachricht eingeben.");
    return;
  }

  const {data} = await jpost("/api/feedback/send", { room, pin, stationPin, text });
  if(!data.ok){ corsWarn(data); return; }

  $("fbText").value="";
  alert("âœ… Feedback gesendet");
  await loadFeedback();
}

// popup once if new message since last load
async function feedbackPopupCheck(){
  const room = $("room").value.trim();
  const pin = $("pin").value.trim();
  const stationPin = $("stationPin").value.trim();
  if(!room || !pin || !stationPin) return;

  // load messages silently
  const {data} = await jpost("/api/feedback/messages", { room, pin, stationPin });
  if(!data?.ok) return;

  const msgs = data.messages||[];
  const lastTs = msgs.length ? msgs[msgs.length-1].ts : 0;

  const key = "fb_last_ts_"+room;
  const prev = Number(localStorage.getItem(key)||"0");

  if(lastTs > prev){
    // Only popup if actually a NEW admin-visible message exists
    const newAdmin = msgs.some(m => m.sender==="admin" && m.ts > prev);
    const newUser = msgs.some(m => m.sender==="user" && m.ts > prev);

    if(newAdmin){
      alert("ðŸ“© Neue Antwort vom Admin im Feedback!");
      $("feedbackBox").scrollIntoView({behavior:"smooth"});
    }
    // update last seen marker
    localStorage.setItem(key, String(lastTs));
  }
}

/* ====== Admin feedback ====== */
async function adminLoadThreads(){
  if(!adminTouch()) { alert("Bitte neu einloggen."); return; }
  const pw = $("adminPw").value.trim();

  const {data} = await jpost("/api/admin/feedback/threads", { adminPassword: pw });
  if(!data.ok){ corsWarn(data); return; }

  const el = $("adminThreads");
  el.innerHTML = "";
  if(!data.threads || data.threads.length===0){
    el.textContent="Keine Threads.";
    return;
  }

  for(const t of data.threads){
    const div=document.createElement("div");
    div.style.padding="8px 0";
    const btn=document.createElement("button");
    btn.className="secondary";
    btn.textContent = `Zimmer ${t.room} â€¢ ungelesen: ${t.unreadForAdmin}`;
    btn.onclick = ()=>adminOpenRoom(t.room);
    div.appendChild(btn);
    el.appendChild(div);
  }
}

async function adminOpenRoom(room){
  currentRoomInAdminChat = room;
  $("adminChat").style.display="block";
  $("adminChatTitle").textContent = "Chat: Zimmer "+room;
  await adminReloadRoom();
}

async function adminReloadRoom(){
  if(!adminTouch()) return;
  const pw = $("adminPw").value.trim();

  const {data} = await jpost("/api/admin/feedback/messages", { adminPassword: pw, room: currentRoomInAdminChat });
  if(!data.ok){ corsWarn(data); return; }

  const box = $("adminChatMsgs");
  box.innerHTML = "";

  for(const m of (data.messages||[])){
    const div=document.createElement("div");
    div.className="chatMsg "+(m.sender==="user"?"chatUser":"chatAdmin");

    const meta=document.createElement("div");
    meta.className="chatMeta small";
    meta.innerHTML = `<span><b>${m.sender==="user"?"User":"Admin"}</b> â€¢ ${fmtDT(m.ts)}</span>
                      <span>${m.sender==="user" ? (m.readByAdmin? "âœ“ gelesen" : "â€¢ ungelesen") : ""}</span>`;

    const txt=document.createElement("div");
    txt.style.whiteSpace="pre-wrap";
    txt.textContent=m.text;

    const extra=document.createElement("div");
    extra.className="small";
    if(m.sender==="admin"){
      extra.textContent = "Sichtbar fÃ¼r User: " + (m.visibleToUser ? "JA" : "NEIN");
    }

    div.appendChild(meta);
    div.appendChild(txt);
    div.appendChild(extra);
    box.appendChild(div);
  }
}

async function adminSendReply(){
  if(!adminTouch()) return;
  const pw = $("adminPw").value.trim();
  const text = $("adminReplyText").value.trim();
  const visibleToUser = $("adminReplyVisible").checked;

  if(!currentRoomInAdminChat){ alert("Kein Zimmer gewÃ¤hlt"); return; }
  if(!text){ alert("Bitte Text eingeben"); return; }

  const {data} = await jpost("/api/admin/feedback/send", {
    adminPassword: pw,
    room: currentRoomInAdminChat,
    text,
    visibleToUser
  });

  if(!data.ok){ corsWarn(data); return; }
  $("adminReplyText").value="";
  alert("âœ… Antwort gesendet");
  await adminReloadRoom();
}
</script>
</body>
</html>
