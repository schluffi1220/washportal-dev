<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Washportal – Login/Config (stabil)</title>
<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#0b1220;color:#e9f1ff;margin:0;padding:20px}
.card{max-width:720px;margin:0 auto 16px auto;background:#111a2b;border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:16px}
.row{display:flex;gap:10px;flex-wrap:wrap}
input,button,textarea{font:inherit;border-radius:10px;border:1px solid rgba(255,255,255,.16);background:#0f1728;color:#e9f1ff;padding:10px}
input{flex:1;min-width:180px}
button{cursor:pointer}
.small{opacity:.8;font-size:13px}
pre{white-space:pre-wrap;word-break:break-word;background:#0f1728;border:1px solid rgba(255,255,255,.12);padding:12px;border-radius:10px;overflow:auto}
.hidden{display:none}
</style>
</head>
<body>
<div class="card">
  <h2>Login</h2>
  <div class="row">
    <input id="email" placeholder="E-Mail" autocomplete="username"/>
    <input id="password" placeholder="Passwort" type="password" autocomplete="current-password"/>
    <button id="btnLogin" type="button">Login</button>
    <button id="btnLogout" type="button">Logout</button>
  </div>
  <div class="small" id="statusLine">Status: –</div>
  <pre id="meBox">nicht eingeloggt</pre>
</div>

<div class="card">
  <h2>Konfiguration</h2>
  <div class="row">
    <button id="btnLoadCfg" type="button">Konfig laden</button>
    <button id="btnSaveCfg" type="button">Konfig speichern</button>
  </div>
  <div class="small">Hinweis: Speichern nutzt <code>/api/admin/config/set</code> mit Bearer-Token.</div>
  <pre id="cfgBox">–</pre>
</div>

<script>
/** === CONFIG === */
const API_BASE = "https://washportal-dev-worker.schluffi1220.workers.dev";

/** === AUTH STORAGE === */
const AUTH_KEY = "wp_token";
function setAuth(token){
  if(token) sessionStorage.setItem(AUTH_KEY, token);
  else sessionStorage.removeItem(AUTH_KEY);
}
function getToken(){ return sessionStorage.getItem(AUTH_KEY) || ""; }

async function apiPost(path, body){
  const token = getToken();
  const r = await fetch(API_BASE + path, {
    method:"POST",
    headers:{
      "content-type":"application/json",
      ...(token ? {"authorization":"Bearer "+token} : {})
    },
    body: JSON.stringify(body||{})
  });
  const t = await r.text();
  let j=null;
  try{ j = JSON.parse(t); }catch(e){}
  if(!r.ok) throw {status:r.status, text:t, data:j};
  return j ?? {raw:t};
}

function setStatus(txt){ document.getElementById("statusLine").textContent = "Status: " + txt; }
function show(obj, elId){ document.getElementById(elId).textContent = typeof obj==="string" ? obj : JSON.stringify(obj,null,2); }

async function refreshMe(){
  try{
    const j = await apiPost("/api/auth/me", {});
    show(j, "meBox");
    setStatus(`OK (build ${j.build || "?"}) role=${j.user?.role || j.user?.role2 || "?"} perms=${Object.keys(j.perms||{}).length}`);
    return j;
  }catch(e){
    show(e.data || e.text || e, "meBox");
    setStatus(`NICHT eingeloggt / Fehler (HTTP ${e.status||"?"})`);
    return null;
  }
}

async function doLogin(){
  const email = (document.getElementById("email").value||"").trim().toLowerCase();
  const password = (document.getElementById("password").value||"").trim();
  if(!email || !password){ alert("E-Mail und Passwort erforderlich"); return; }
  // login without bearer
  const r = await fetch(API_BASE + "/api/auth/login", {
    method:"POST",
    headers:{"content-type":"application/json"},
    body: JSON.stringify({email, password})
  });
  const t = await r.text();
  let j=null; try{ j=JSON.parse(t);}catch(e){}
  if(!r.ok || !j?.ok){
    alert("Login fehlgeschlagen: " + (j?.message || j?.error || ("HTTP "+r.status)));
    console.warn("login raw:", t);
    return;
  }
  setAuth(j.token);
  await refreshMe();
}

function doLogout(){
  setAuth("");
  show("nicht eingeloggt", "meBox");
  show("–", "cfgBox");
  setStatus("ausgeloggt");
}

async function loadCfg(){
  try{
    const j = await apiPost("/api/admin/config/get", {});
    show(j, "cfgBox");
    alert("Konfiguration geladen");
  }catch(e){
    console.warn("cfg/get fail:", e);
    alert("Konfig laden fehlgeschlagen: " + (e.data?.message || e.data?.error || e.status));
    show(e.data || e.text || e, "cfgBox");
  }
}

async function saveCfg(){
  // Nimmt den aktuellen JSON aus cfgBox, wenn parsbar, sonst speichert es nichts.
  let cfg=null;
  try{
    const txt = document.getElementById("cfgBox").textContent || "{}";
    const j = JSON.parse(txt);
    cfg = j.config || j; // akzeptiert response-form oder config-only
  }catch(e){
    alert("cfgBox enthält kein JSON. Bitte erst 'Konfig laden' und dann speichern.");
    return;
  }
  try{
    const j = await apiPost("/api/admin/config/set", { config: cfg });
    show(j, "cfgBox");
    alert("Konfiguration gespeichert");
  }catch(e){
    console.warn("cfg/set fail:", e);
    alert("Konfig speichern fehlgeschlagen: " + (e.data?.message || e.data?.error || e.status));
    show(e.data || e.text || e, "cfgBox");
  }
}

document.getElementById("btnLogin").addEventListener("click", (ev)=>{ ev.preventDefault(); doLogin(); });
document.getElementById("btnLogout").addEventListener("click", (ev)=>{ ev.preventDefault(); doLogout(); });
document.getElementById("btnLoadCfg").addEventListener("click", (ev)=>{ ev.preventDefault(); loadCfg(); });
document.getElementById("btnSaveCfg").addEventListener("click", (ev)=>{ ev.preventDefault(); saveCfg(); });

(async ()=>{
  try{
    const s = await fetch(API_BASE + "/api/_status?ts="+Date.now()).then(r=>r.json());
    setStatus(`Worker erreichbar (build ${s.build})`);
  }catch(e){
    setStatus("Worker nicht erreichbar");
  }
  await refreshMe();
})();
</script>
</body>
</html>
