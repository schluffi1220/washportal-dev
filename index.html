<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Wash-Portal (DEV)</title>
  <style>
    :root{
      --bg:#ffffff; --fg:#111; --muted:#666; --card:#f6f6f6; --line:#e6e6e6;
      --free:#2e7d32; --busy:#1565c0; --def:#c62828;
      --pFree:#e9f7ee; --pBusy:#e8f2ff; --pDef:#ffe9ea;
      --btn:#111; --btnfg:#fff;
    }
    [data-theme="highcontrast"]{
      --free:#00c853; --busy:#00b0ff; --def:#ff00ff; /* magenta */
      --pDef:#ffe6ff;
    }
    body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{max-width:920px;margin:0 auto;padding:18px}
    h1{margin:6px 0 2px;font-size:34px}
    .sub{color:var(--muted);margin:0 0 16px}
    .status{padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:#fff;margin:10px 0}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .col{flex:1;min-width:220px}
    label{display:block;font-weight:600;margin:10px 0 6px}
    input,select,textarea,button{
      width:100%;box-sizing:border-box;border:1px solid var(--line);
      border-radius:12px;padding:12px;font-size:16px;background:#fff;
    }
    input[type="password"]{letter-spacing:2px}
    button{background:var(--btn);color:var(--btnfg);border:none;cursor:pointer;font-weight:700}
    button:disabled{opacity:.5;cursor:not-allowed}
    details{border:1px solid var(--line);border-radius:12px;background:#fff;margin:10px 0}
    summary{padding:12px 14px;font-weight:800;cursor:pointer}
    .sec{padding:0 14px 14px}
    .pill{display:inline-block;padding:3px 10px;border-radius:999px;border:1px solid var(--line);font-size:12px;color:var(--muted)}
    .grid{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:740px){.grid{grid-template-columns:1fr 1fr}}
    .card{border:1px solid var(--line);border-radius:14px;padding:12px;background:var(--card)}
    .card.free{background:var(--pFree)}
    .card.busy{background:var(--pBusy)}
    .card.def{background:var(--pDef)}
    .title{display:flex;align-items:center;gap:10px;font-weight:900}
    .dot{width:14px;height:14px;border-radius:999px;display:inline-block}
    .dot.free{background:var(--free)}
    .dot.busy{background:var(--busy)}
    .dot.def{background:var(--def)}
    .muted{color:var(--muted)}
    .btnrow{display:flex;gap:8px;margin-top:10px}
    .btnrow button{width:auto;padding:10px 12px;border-radius:12px}
    .btnGhost{background:#fff;color:#111;border:1px solid var(--line)}
    .selHint{font-size:13px;color:var(--muted);margin-top:6px}
    .adminBox{border:1px dashed var(--line);border-radius:14px;padding:12px;margin-top:10px}
    .small{font-size:13px;color:var(--muted)}
    .chatMsg{border:1px solid var(--line);border-radius:12px;padding:10px;margin:8px 0;background:#fff}
    .chatMsg.admin{background:#f8fbff}
    .chatMsg .head{display:flex;justify-content:space-between;gap:10px;font-weight:800}
    .chip{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid var(--line);color:var(--muted)}
  </style>
</head>
<body>
<div class="wrap" id="app" data-theme="standard">
  <h1>Wasch-Portal (DEV)</h1>
  <p class="sub">Cloudflare Worker + D1</p>

  <div class="status" id="status">Ladeâ€¦</div>

  <!-- 1) Zugang -->
  <details open>
    <summary>1) Zugang</summary>
    <div class="sec">
      <div class="row">
        <div class="col">
          <label for="room">Zimmernummer</label>
          <input id="room" inputmode="numeric" placeholder="z. B. 316">
        </div>
        <div class="col">
          <label for="pin">PersÃ¶nlicher PIN</label>
          <input id="pin" type="password" inputmode="numeric" placeholder="4-stellig">
        </div>
      </div>
      <div class="row">
        <div class="col">
          <label for="stationPin">Stations-PIN (fÃ¼r Buchen erforderlich)</label>
          <input id="stationPin" type="password" inputmode="numeric" placeholder="Stations-PIN">
        </div>
        <div class="col">
          <label>&nbsp;</label>
          <button id="btnRefresh" onclick="refreshAll()">Aktualisieren</button>
          <div class="selHint" id="readyHint"></div>
        </div>
      </div>
    </div>
  </details>

  <!-- 2) Slots buchen -->
  <details open>
    <summary>2) Slots buchen</summary>
    <div class="sec">
      <label for="slotSelect">Slot (Waschmaschine)</label>
      <select id="slotSelect"></select>
      <div class="selHint">Im Dropdown stehen auch belegte/defekte Slots â€“ die sind grau und nicht buchbar.</div>
      <div class="btnrow">
        <button onclick="bookSelected()">Buchen</button>
      </div>
    </div>
  </details>

  <!-- 3) MaschinenÃ¼bersicht -->
  <details open>
    <summary>3) MaschinenÃ¼bersicht</summary>
    <div class="sec">
      <div class="grid" id="machineGrid"></div>

      <details style="margin-top:10px">
        <summary>Maschine als defekt melden / freigeben (mit Stations-PIN)</summary>
        <div class="sec">
          <div class="row">
            <div class="col">
              <label>Typ</label>
              <select id="defType">
                <option value="washer">Waschmaschine</option>
                <option value="dryer">Trockner</option>
              </select>
            </div>
            <div class="col">
              <label>Maschine</label>
              <select id="defMachine">
                <option>1</option><option>2</option><option>3</option><option>4</option>
              </select>
            </div>
          </div>
          <div class="btnrow">
            <button class="btnGhost" onclick="setDefect(true)">Defekt</button>
            <button class="btnGhost" onclick="setDefect(false)">Freigeben</button>
          </div>
        </div>
      </details>

    </div>
  </details>

  <!-- 4) Meine Buchungen -->
  <details open>
    <summary>4) Meine Buchungen</summary>
    <div class="sec">
      <button class="btnGhost" onclick="loadMyBookings()">Meine Buchungen aktualisieren</button>
      <div id="myBookings"></div>
    </div>
  </details>

  <!-- 5) Feedback -->
  <details>
    <summary>5) Feedback / Antworten</summary>
    <div class="sec">
      <label>Nachricht</label>
      <textarea id="fbText" rows="4" placeholder="Problem/Beschreibungâ€¦"></textarea>
      <div class="btnrow">
        <button onclick="sendFeedback()">Senden</button>
        <button class="btnGhost" onclick="loadFeedback()">Verlauf laden</button>
      </div>
      <div id="fbThread"></div>
    </div>
  </details>

  <!-- 6) Admin -->
  <details>
    <summary>6) Admin</summary>
    <div class="sec">
      <div class="adminBox">
        <div class="row">
          <div class="col">
            <label>Admin-Passwort</label>
            <input id="adminPw" type="password" placeholder="initial beim ersten Mal">
          </div>
          <div class="col">
            <label>&nbsp;</label>
            <div class="btnrow">
              <button onclick="adminLogin()">Login</button>
              <button class="btnGhost" onclick="adminLogout()">Logout</button>
            </div>
            <div class="small" id="adminState">Nicht eingeloggt.</div>
          </div>
        </div>

        <details style="margin-top:10px">
          <summary>Stations-PIN setzen/Ã¤ndern</summary>
          <div class="sec">
            <label>Stations-PIN (4-stellig)</label>
            <input id="adminStationPin" type="password" inputmode="numeric" placeholder="z. B. 1111">
            <button style="margin-top:10px" onclick="adminSetStationPin()">Stations-PIN speichern</button>
            <div class="small">Wird als Hash gespeichert (nicht Klartext).</div>
          </div>
        </details>

        <details style="margin-top:10px">
          <summary>Admin-Passwort Ã¤ndern</summary>
          <div class="sec">
            <label>Neues Admin-Passwort</label>
            <input id="adminNewPw" type="password" placeholder="mind. 4 Zeichen">
            <button style="margin-top:10px" onclick="adminSetAdminPw()">Passwort Ã¤ndern</button>
          </div>
        </details>

        <details style="margin-top:10px">
          <summary>Konfiguration (Tage-Fenster / Zeiten / Design)</summary>
          <div class="sec">
            <div class="row">
              <div class="col">
                <label>Vergangene Tage</label>
                <input id="cfgDaysPast" inputmode="numeric">
              </div>
              <div class="col">
                <label>ZukÃ¼nftige Tage</label>
                <input id="cfgDaysFuture" inputmode="numeric">
              </div>
            </div>

            <div class="row">
              <div class="col">
                <label>Trockner-Laufzeit</label>
                <select id="cfgDryerMinutes">
                  <option value="60">1 Stunde</option>
                  <option value="90">1,5 Stunden</option>
                  <option value="120">2 Stunden</option>
                </select>
              </div>
              <div class="col">
                <label>Design</label>
                <select id="cfgTheme">
                  <option value="standard">Standard</option>
                  <option value="highcontrast">High-Contrast (Magenta)</option>
                </select>
              </div>
            </div>

            <label>Wasch-Zeiten (0â€“23 Uhr, Haken setzen)</label>
            <div class="grid" id="hourGrid"></div>

            <div class="row">
              <div class="col">
                <label>User darf Defekt melden?</label>
                <select id="cfgUserDefect">
                  <option value="true">Ja</option>
                  <option value="false">Nein</option>
                </select>
              </div>
              <div class="col">
                <label>&nbsp;</label>
                <button onclick="adminSaveConfig()">Speichern (mit BestÃ¤tigung)</button>
              </div>
            </div>
          </div>
        </details>

        <details style="margin-top:10px">
          <summary>Neu-Text (User-Anzeige)</summary>
          <div class="sec">
            <label>Text</label>
            <textarea id="newsText" rows="3"></textarea>
            <label style="margin-top:10px;font-weight:700">
              <input id="newsEnabled" type="checkbox" style="width:auto;margin-right:8px"> FÃ¼r User anzeigen
            </label>
            <button style="margin-top:10px" onclick="adminSaveNews()">Speichern</button>
          </div>
        </details>

        <details style="margin-top:10px">
          <summary>Logs (letzte 500)</summary>
          <div class="sec">
            <button class="btnGhost" onclick="adminLoadLogs()">Logs laden</button>
            <div id="adminLogs"></div>
          </div>
        </details>

        <details style="margin-top:10px">
          <summary>Feedback (Admin)</summary>
          <div class="sec">
            <button class="btnGhost" onclick="adminLoadFeedback()">Feedback laden</button>
            <div id="adminFeedback"></div>
          </div>
        </details>
      </div>
    </div>
  </details>

</div>

<script>
  /* WICHTIG: HIER Worker-URL eintragen */
  const API_BASE = "https://washportal-dev-worker.schluffi1220.workers.dev";

  const $ = (id)=>document.getElementById(id);
  const ls = window.localStorage;

  function setStatus(msg){ $("status").textContent = msg; }

  async function jget(path){
    const r = await fetch(API_BASE + path, { cache:"no-store" });
    return await r.json().catch(()=>({ok:false}));
  }
  async function jpost(path, body){
    const r = await fetch(API_BASE + path, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(body||{})
    });
    const data = await r.json().catch(()=>({ok:false}));
    return { r, data };
  }

  function getAccess(){
    return {
      room: $("room").value.trim(),
      pin: $("pin").value.trim(),
      stationPin: $("stationPin").value.trim(),
    };
  }

  // ---------- Admin session ----------
  function getAdminToken(){ return ls.getItem("adminToken") || ""; }
  function setAdminToken(t){ if(t) ls.setItem("adminToken", t); else ls.removeItem("adminToken"); }

  function adminIsOn(){
    return !!getAdminToken();
  }
  function showAdminState(){
    $("adminState").textContent = adminIsOn() ? "Eingeloggt (Auto-Timeout ~5 Min)" : "Nicht eingeloggt.";
  }

  // ---------- init hours checkboxes ----------
  function buildHourGrid(selectedTimes){
    const wrap = $("hourGrid");
    wrap.innerHTML = "";
    const selected = new Set((selectedTimes||[]).map(String));
    for(let h=0; h<24; h++){
      const hh = String(h).padStart(2,"0");
      const t = `${hh}:00`;
      const div = document.createElement("div");
      div.className = "card";
      div.style.padding = "10px";
      div.innerHTML = `
        <label style="display:flex;align-items:center;gap:10px;font-weight:800;margin:0">
          <input type="checkbox" ${selected.has(t) ? "checked":""} data-hour="${t}" style="width:auto">
          ${t}
        </label>
      `;
      wrap.appendChild(div);
    }
  }
  function readHourGrid(){
    const times = [];
    document.querySelectorAll("#hourGrid input[type=checkbox]").forEach(cb=>{
      if(cb.checked) times.push(cb.getAttribute("data-hour"));
    });
    times.sort();
    return times;
  }

  // ---------- date/time formatting ----------
  function fmtDT(ms){
    const d = new Date(ms);
    const dd = String(d.getDate()).padStart(2,"0");
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const yy = String(d.getFullYear()).slice(-2);
    const hh = String(d.getHours()).padStart(2,"0");
    const mi = String(d.getMinutes()).padStart(2,"0");
    return `${dd}.${mm}.${yy} ${hh}:${mi}`;
  }
  function fmtTime(ms){
    const d = new Date(ms);
    const hh = String(d.getHours()).padStart(2,"0");
    const mi = String(d.getMinutes()).padStart(2,"0");
    return `${hh}:${mi}`;
  }

  // ---------- global cached state ----------
  let CACHE = { status:null, slotModel:null, machines:[], bookings:[] };

  async function refreshAll(){
    setStatus("Ladeâ€¦");
    const st = await jget("/api/status");
    CACHE.status = st;
    if(!st.ok){ setStatus("Fehler beim Laden."); alert(JSON.stringify(st,null,2)); return; }

    // apply theme
    $("app").setAttribute("data-theme", st.config?.uiTheme || "standard");
    $("readyHint").textContent = "Bereit.";

    renderMachineOverview(st);
    await loadSlotOptions();
    await loadMyBookings(true);
    await maybeShowNews(st);
    setStatus("Bereit.");
  }

  async function loadSlotOptions(){
    const a = getAccess();
    const { data } = await jpost("/api/washer/slot-options", a);
    if(!data.ok){
      // show brief
      console.warn("slot-options", data);
      $("slotSelect").innerHTML = `<option>Keine Slots (Stations-PIN prÃ¼fen)</option>`;
      return;
    }

    CACHE.slotModel = data;

    // Build dropdown options with local timezone dates
    const cfg = data.config || {};
    const times = (cfg.washerTimes || []).map(String);
    const daysPast = Number(cfg.daysPast || 1);
    const daysFuture = Number(cfg.daysFuture || 6);

    // machine list and defects
    const machines = (data.machines || []).map(m=>({
      machine:Number(m.machine), defect:Number(m.defect)===1, enabled:Number(m.enabled)===1
    }));

    // active bookings (booked)
    const active = (data.activeBookings || []).filter(b=>b.status==="booked");

    // helper: check overlap
    const overlaps = (machine, start, end) => {
      return active.some(b=>{
        if(Number(b.machine)!==machine) return false;
        const bs = Number(b.start), be = Number(b.end);
        return !(be<=start || bs>=end);
      });
    };

    // for each day, each time, each machine
    const opts = [];
    const now = Date.now();
    const today = new Date();
    today.setHours(0,0,0,0);

    for(let d=-daysPast; d<=daysFuture; d++){
      const day = new Date(today.getTime() + d*24*3600*1000);
      for(const t of times){
        const [hh,mm] = t.split(":").map(Number);
        const start = new Date(day.getTime());
        start.setHours(hh, mm||0, 0, 0);
        const startMs = start.getTime();
        const endMs = startMs + 2*60*60*1000; // washer fixed 2h

        // cannot book if slot ended
        const ended = endMs <= now;

        for(const m of machines){
          if(!m.enabled) continue;

          const isDef = m.defect;
          const isBooked = overlaps(m.machine, startMs, endMs);
          const free = !isDef && !isBooked;

          const label = `${fmtDT(startMs)}â€“${fmtTime(endMs)}  Waschmaschine ${m.machine}` +
                        (isDef ? " (defekt)" : isBooked ? " (belegt)" : "");

          opts.push({
            value: JSON.stringify({ start:startMs, end:endMs, machine:m.machine }),
            label,
            disabled: ended || !free,
            ended, isDef, isBooked
          });
        }
      }
    }

    const sel = $("slotSelect");
    sel.innerHTML = "";

    if(opts.length === 0){
      sel.innerHTML = `<option>Keine Slots</option>`;
      return;
    }

    // add options
    for(const o of opts){
      const opt = document.createElement("option");
      opt.value = o.value;
      opt.textContent = o.label;
      opt.disabled = !!o.disabled;
      if(o.disabled) opt.style.color = "#888";
      sel.appendChild(opt);
    }
  }

  async function bookSelected(){
    const a = getAccess();
    if(!a.room || !a.pin || !a.stationPin){
      alert("Bitte Zimmernummer, PIN und Stations-PIN eingeben.");
      return;
    }

    const raw = $("slotSelect").value;
    if(!raw) return;

    let payload = null;
    try{ payload = JSON.parse(raw); }catch{ payload=null; }
    if(!payload) return;

    const res = await jpost("/api/washer/book", {
      ...a,
      start: payload.start,
      end: payload.end,
      machine: payload.machine
    });

    if(!res.data.ok){
      alert(JSON.stringify(res.data,null,2));
      return;
    }

    await refreshAll();
    alert("âœ… Gebucht.");
  }

  // ---------- machine overview ----------
  function renderMachineOverview(st){
    const grid = $("machineGrid");
    grid.innerHTML = "";

    const machines = (st.machines||[]);
    const bookings = (st.bookings||[]);
    const now = Date.now();

    // find active booking for each machine (booked and not ended)
    const activeBy = new Map();
    for(const b of bookings){
      if(b.status !== "booked") continue;
      const end = Number(b.end);
      const start = Number(b.start);
      if(end <= now) continue;
      const key = `${b.type}:${b.machine}`;
      // choose booking with earliest end if multiple (shouldn't)
      if(!activeBy.has(key) || Number(activeBy.get(key).end) > end){
        activeBy.set(key, b);
      }
    }

    // make cards
    for(const m of machines){
      const key = `${m.type}:${m.machine}`;
      const active = activeBy.get(key);
      const isDef = Number(m.defect) === 1;
      const isBusy = !!active && !isDef;
      const isFree = !isDef && !active;

      const cls = isDef ? "def" : isBusy ? "busy" : "free";
      const dot = cls;

      let sub = "";
      let btns = "";

      if(isDef){
        sub = `<div class="muted">Defekt</div>`;
      } else if(isBusy){
        const end = Number(active.end);
        sub = `<div class="muted">Belegt bis ${fmtTime(end)} (Zimmer ${active.room})</div>`;
      } else {
        sub = `<div class="muted">Frei</div>`;
      }

      // buttons: dryer free -> book now, dryer busy by your room -> fertig (release)
      // washer busy by your room -> freigeben
      const a = getAccess();
      const myRoom = a.room;

      if(m.type === "dryer"){
        if(isFree){
          btns = `<button onclick="dryerBookNow(${m.machine})">Buchen</button>`;
        } else if(active && String(active.room) === String(myRoom)){
          btns = `<button onclick="releaseBooking('${active.id}')">FERTIG</button>`;
        } else {
          btns = `<button disabled>â€”</button>`;
        }
      } else {
        if(active && String(active.room) === String(myRoom)){
          btns = `<button onclick="releaseBooking('${active.id}')">Freigeben</button>`;
        } else {
          btns = `<button disabled>â€”</button>`;
        }
      }

      const card = document.createElement("div");
      card.className = `card ${cls}`;
      card.innerHTML = `
        <div class="title">
          <span class="dot ${dot}"></span>
          ${m.type === "dryer" ? "Trockner" : "Waschmaschine"} ${m.machine}
          ${isDef ? `<span class="pill">Defekt</span>` : ""}
        </div>
        ${sub}
        <div class="btnrow" style="justify-content:flex-end">
          ${btns}
        </div>
      `;
      grid.appendChild(card);
    }
  }

  async function releaseBooking(id){
    const a = getAccess();
    const res = await jpost("/api/booking/release", { room:a.room, pin:a.pin, bookingId:id });
    if(!res.data.ok){ alert(JSON.stringify(res.data,null,2)); return; }
    await refreshAll();
  }

  async function dryerBookNow(machine){
    const a = getAccess();
    const res = await jpost("/api/dryer/book-now", { ...a, machine });
    if(!res.data.ok){ alert(JSON.stringify(res.data,null,2)); return; }
    await refreshAll();
  }

  async function setDefect(on){
    const a = getAccess();
    const type = $("defType").value;
    const machine = Number($("defMachine").value);
    const res = await jpost("/api/machine/defect", {
      stationPin: a.stationPin,
      room: a.room,
      type, machine,
      action: on ? "set" : "clear"
    });
    if(!res.data.ok){ alert(JSON.stringify(res.data,null,2)); return; }
    await refreshAll();
  }

  // ---------- my bookings ----------
  async function loadMyBookings(silent=false){
    const a = getAccess();
    if(!a.room || !a.pin){
      $("myBookings").innerHTML = `<div class="muted" style="margin-top:10px">Bitte Zimmernummer und PIN eingeben.</div>`;
      return;
    }

    const { data } = await jpost("/api/my-bookings", { room:a.room, pin:a.pin });
    if(!data.ok){
      if(!silent) alert(JSON.stringify(data,null,2));
      return;
    }

    // map defect for display
    const mMap = new Map();
    (data.machines||[]).forEach(m=>{
      mMap.set(`${m.type}:${m.machine}`, Number(m.defect)===1);
    });

    const now = Date.now();
    const wrap = $("myBookings");
    wrap.innerHTML = "";

    const rows = (data.bookings||[]);

    if(rows.length===0){
      wrap.innerHTML = `<div class="muted" style="margin-top:10px">Keine Buchungen.</div>`;
      return;
    }

    for(const b of rows){
      const start = Number(b.start), end = Number(b.end);
      const isDef = mMap.get(`${b.type}:${b.machine}`) === true;

      let state = "free";
      if(isDef) state = "def";
      else if(b.status==="booked" && end>now) state="busy";
      else state="free";

      const card = document.createElement("div");
      card.className = `card ${state}`;

      const canCancel = end > now; // ended => cannot cancel
      const cancelDisabled = !canCancel;

      card.innerHTML = `
        <div class="title">
          <span class="dot ${state==="def"?"def":state==="busy"?"busy":"free"}"></span>
          ${b.type==="dryer"?"Trockner":"Waschmaschine"} ${b.machine}
          ${isDef ? `<span class="pill">Defekt</span>` : ""}
          <span class="pill">${b.status}</span>
        </div>
        <div class="muted">${fmtDT(start)}â€“${fmtTime(end)}</div>
        <div class="btnrow" style="justify-content:flex-end">
          <button class="btnGhost" ${cancelDisabled?"disabled":""} onclick="cancelBooking('${b.id}')">
            ${cancelDisabled ? "Storno nicht mÃ¶glich" : "Stornieren"}
          </button>
        </div>
      `;
      wrap.appendChild(card);
    }
  }

  async function cancelBooking(id){
    const a = getAccess();
    const res = await jpost("/api/booking/cancel", { room:a.room, pin:a.pin, bookingId:id });
    if(!res.data.ok){ alert(JSON.stringify(res.data,null,2)); return; }
    await refreshAll();
  }

  // ---------- news ----------
  async function maybeShowNews(st){
    const enabled = st.newsEnabled;
    const text = st.newsText || "";
    if(!enabled || !text) return;

    // show once per new content
    const key = "newsSeenHash";
    const hash = text.length + ":" + text.slice(0,30);
    if(ls.getItem(key) !== hash){
      alert("ðŸ“¢ Hinweis:\n\n" + text);
      ls.setItem(key, hash);
    }
  }

  // ---------- feedback user ----------
  async function sendFeedback(){
    const a = getAccess();
    const text = $("fbText").value.trim();
    if(!a.room || !a.pin) return alert("Bitte Zimmernummer & PIN eingeben.");
    if(!text) return alert("Bitte Text eingeben.");

    const res = await jpost("/api/feedback/send", { room:a.room, pin:a.pin, text });
    if(!res.data.ok){ alert(JSON.stringify(res.data,null,2)); return; }

    $("fbText").value = "";
    await loadFeedback();
  }

  async function loadFeedback(){
    const a = getAccess();
    if(!a.room || !a.pin) return alert("Bitte Zimmernummer & PIN eingeben.");

    const res = await jpost("/api/feedback/thread", { room:a.room, pin:a.pin });
    if(!res.data.ok){ alert(JSON.stringify(res.data,null,2)); return; }

    const wrap = $("fbThread");
    wrap.innerHTML = "";
    const msgs = res.data.messages || [];

    if(msgs.length===0){
      wrap.innerHTML = `<div class="muted">Kein Verlauf.</div>`;
      return;
    }

    // popup once if new admin msg
    const lastAdmin = [...msgs].reverse().find(m=>m.sender==="admin");
    if(lastAdmin){
      const seen = Number(ls.getItem("lastAdminTsSeen")||"0");
      if(Number(lastAdmin.ts) > seen){
        alert("ðŸ’¬ Neue Admin-Antwort vorhanden.");
        ls.setItem("lastAdminTsSeen", String(lastAdmin.ts));
      }
    }

    for(const m of msgs){
      const div = document.createElement("div");
      div.className = "chatMsg " + (m.sender==="admin" ? "admin" : "user");
      div.innerHTML = `
        <div class="head">
          <span>${m.sender==="admin"?"Admin":"Du"}</span>
          <span class="chip">${fmtDT(Number(m.ts))}</span>
        </div>
        <div style="margin-top:6px">${escapeHtml(m.text||"")}</div>
      `;
      wrap.appendChild(div);
    }
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, c=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  // ---------- admin ----------
  async function adminLogin(){
    const pw = $("adminPw").value.trim();
    const res = await jpost("/api/admin/login", { adminPassword: pw });
    if(!res.data.ok){ alert(JSON.stringify(res.data,null,2)); return; }
    setAdminToken(res.data.token);
    showAdminState();
    await adminLoadConfig();
    alert("âœ… Admin Login ok");
  }

  async function adminLogout(){
    const token = getAdminToken();
    if(!token){ setAdminToken(""); showAdminState(); return; }
    await jpost("/api/admin/logout", { token });
    setAdminToken("");
    showAdminState();
    alert("Logout");
  }

  async function adminSetStationPin(){
    const token = getAdminToken();
    if(!token) return alert("Bitte erst Admin Login.");
    const stationPin = $("adminStationPin").value.trim();

    const res = await jpost("/api/admin/set-station-pin", { token, stationPin });
    if(!res.data.ok){ alert(JSON.stringify(res.data,null,2)); return; }
    alert("âœ… Stations-PIN gespeichert");
  }

  async function adminSetAdminPw(){
    const token = getAdminToken();
    if(!token) return alert("Bitte erst Admin Login.");
    const newPassword = $("adminNewPw").value.trim();
    const res = await jpost("/api/admin/set-admin-password", { token, newPassword });
    if(!res.data.ok){ alert(JSON.stringify(res.data,null,2)); return; }
    alert("âœ… Admin-Passwort geÃ¤ndert");
  }

  async function adminLoadConfig(){
    const token = getAdminToken();
    if(!token) return;

    const cfgRes = await jget("/api/admin/config?token=" + encodeURIComponent(token));
    if(!cfgRes.ok){
      console.warn(cfgRes);
      return;
    }

    const cfg = cfgRes.config || {};
    $("cfgDaysPast").value = cfg.daysPast ?? 1;
    $("cfgDaysFuture").value = cfg.daysFuture ?? 6;
    $("cfgDryerMinutes").value = String(cfg.dryerMinutes ?? 120);
    $("cfgTheme").value = cfg.uiTheme ?? "standard";
    $("cfgUserDefect").value = String(cfg.userDefectEnabled ? "true" : "false");

    buildHourGrid(cfg.washerTimes || []);
  }

  async function adminSaveConfig(){
    const token = getAdminToken();
    if(!token) return alert("Bitte erst Admin Login.");

    if(!confirm("Wirklich speichern?")) return;

    const washerTimes = readHourGrid(); // HH:00 list
    const payload = {
      token,
      daysPast: Number($("cfgDaysPast").value || 1),
      daysFuture: Number($("cfgDaysFuture").value || 6),
      dryerMinutes: Number($("cfgDryerMinutes").value || 120),
      uiTheme: $("cfgTheme").value,
      washerTimes,
      userDefectEnabled: $("cfgUserDefect").value === "true"
    };

    const res = await jpost("/api/admin/save-config", payload);
    if(!res.data.ok){ alert(JSON.stringify(res.data,null,2)); return; }

    alert("âœ… Gespeichert.");
    await refreshAll();
  }

  async function adminSaveNews(){
    const token = getAdminToken();
    if(!token) return alert("Bitte erst Admin Login.");

    const res = await jpost("/api/admin/save-news", {
      token,
      text: $("newsText").value,
      enabled: $("newsEnabled").checked
    });
    if(!res.data.ok){ alert(JSON.stringify(res.data,null,2)); return; }
    alert("âœ… News gespeichert");
  }

  async function adminLoadLogs(){
    const token = getAdminToken();
    if(!token) return alert("Bitte erst Admin Login.");

    const res = await jget("/api/admin/logs?token=" + encodeURIComponent(token));
    if(!res.ok){ alert(JSON.stringify(res,null,2)); return; }

    const wrap = $("adminLogs");
    wrap.innerHTML = "";

    for(const l of (res.logs||[])){
      const div = document.createElement("div");
      div.className = "chatMsg";
      let meta = "";
      try{ meta = JSON.stringify(JSON.parse(l.meta||"{}")); }catch{ meta = l.meta||""; }
      div.innerHTML = `
        <div class="head">
          <span>${escapeHtml(l.action)} ${l.type?`(${l.type} ${l.machine})`:""}</span>
          <span class="chip">${fmtDT(Number(l.ts))}</span>
        </div>
        <div class="small">Room: ${escapeHtml(l.room||"")}</div>
        <div class="small">Meta: ${escapeHtml(meta)}</div>
      `;
      wrap.appendChild(div);
    }
  }

  async function adminLoadFeedback(){
    const token = getAdminToken();
    if(!token) return alert("Bitte erst Admin Login.");

    const res = await jget("/api/admin/feedback?token=" + encodeURIComponent(token));
    if(!res.ok){ alert(JSON.stringify(res,null,2)); return; }

    const wrap = $("adminFeedback");
    wrap.innerHTML = "";

    const msgs = res.messages || [];
    if(msgs.length===0){
      wrap.innerHTML = `<div class="muted">Keine Nachrichten.</div>`;
      return;
    }

    // show grouped by room
    const byRoom = new Map();
    for(const m of msgs){
      if(!byRoom.has(m.room)) byRoom.set(m.room, []);
      byRoom.get(m.room).push(m);
    }

    for(const [room, arr] of byRoom.entries()){
      const block = document.createElement("div");
      block.className = "card";
      block.innerHTML = `<div class="title">Zimmer ${escapeHtml(room)}</div>`;
      const inner = document.createElement("div");

      for(const m of arr.slice(0,30)){
        const div = document.createElement("div");
        div.className = "chatMsg " + (m.sender==="admin"?"admin":"user");
        div.innerHTML = `
          <div class="head">
            <span>${m.sender}</span>
            <span class="chip">${fmtDT(Number(m.ts))}</span>
          </div>
          <div style="margin-top:6px">${escapeHtml(m.text||"")}</div>
          <div class="small">visibleToUser: ${m.visibleToUser}</div>
        `;
        inner.appendChild(div);
      }

      // reply form
      const form = document.createElement("div");
      form.className = "chatMsg";
      form.innerHTML = `
        <label style="margin:0 0 6px;font-weight:800">Antwort</label>
        <textarea rows="3" id="reply_${room}" placeholder="Antwort an Zimmer ${room}â€¦"></textarea>
        <label style="margin-top:8px;font-weight:700">
          <input type="checkbox" id="vis_${room}" style="width:auto;margin-right:8px" checked>
          FÃ¼r User sichtbar
        </label>
        <div class="btnrow">
          <button onclick="adminReply('${room}')">Senden</button>
        </div>
      `;
      inner.appendChild(form);

      block.appendChild(inner);
      wrap.appendChild(block);
    }
  }

  async function adminReply(room){
    const token = getAdminToken();
    const text = document.getElementById("reply_"+room).value.trim();
    const visibleToUser = document.getElementById("vis_"+room).checked;
    if(!text) return;

    const res = await jpost("/api/admin/feedback/reply", { token, room, text, visibleToUser });
    if(!res.data.ok){ alert(JSON.stringify(res.data,null,2)); return; }

    alert("âœ… Gesendet");
    await adminLoadFeedback();
  }

  // bootstrap
  (async ()=>{
    showAdminState();
    setStatus("Starteâ€¦");
    // prepare hour grid placeholder
    buildHourGrid(["06:00","08:00","10:00","12:00","14:00","16:00","18:00","20:00","22:00"]);
    await refreshAll();
  })();
</script>
</body>
</html>
