<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Washportal</title>
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <style>
    :root{
      --bg:#08111f; --panel:#0f1c2f; --panel2:#10243b; --line:rgba(255,255,255,.08);
      --text:#eaf1ff; --muted:rgba(234,241,255,.70);
      --ok:#2dd4bf; --bad:#ef4444; --warn:#f59e0b; --blue:#60a5fa;
      --btn:#1f2d44; --btn2:#263a59;
      --shadow: 0 18px 50px rgba(0,0,0,.45);
      --radius:18px;

      /* pastel tiles (intensiver) */
      --tile-free: rgba(45,212,191,.22);
      --tile-busy: rgba(96,165,250,.18);
      --tile-defect: rgba(239,68,68,.22);
      --tile-locked: rgba(148,163,184,.18);
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: radial-gradient(1200px 600px at 30% 10%, rgba(45,212,191,.18), transparent 55%),
                  radial-gradient(900px 500px at 85% 35%, rgba(96,165,250,.16), transparent 50%),
                  linear-gradient(180deg, #061022, var(--bg));
      color:var(--text);
    }
    .wrap{max-width:760px; margin:14px auto 90px; padding:0 12px;}
    .topbar{position:sticky; top:0; z-index:10; padding:10px 0 8px; background:linear-gradient(180deg, rgba(8,17,31,.94), rgba(8,17,31,.72)); backdrop-filter: blur(10px);}
    .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .brand{display:flex; gap:10px; align-items:center; margin-bottom:8px}
    .dot{width:10px; height:10px; border-radius:99px; background:var(--ok); box-shadow:0 0 0 4px rgba(45,212,191,.14)}
    .title{font-weight:900; letter-spacing:.2px}
    .pill{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; border:1px solid var(--line); background:rgba(255,255,255,.04); font-size:12px; color:var(--muted)}
    .pill strong{color:var(--text)}
    .err{display:none; margin:10px 0 12px; padding:10px 12px; border-radius:14px; border:1px solid rgba(239,68,68,.35); background:rgba(239,68,68,.10); color:#ffd5d5}

    .card{background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02)); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); padding:14px;}
    h2{margin:0 0 10px; font-size:16px}
    .muted{color:var(--muted); font-size:12px; line-height:1.35}

    input, select, button, textarea{
      width:100%; box-sizing:border-box; border-radius:14px; border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04); color:var(--text); padding:11px 12px; font-size:14px;
    }
    textarea{min-height:72px; resize:vertical}
    button{cursor:pointer; font-weight:800; background:linear-gradient(90deg, rgba(96,165,250,.75), rgba(45,212,191,.75)); border:0}
    button.secondary{background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.14); font-weight:700}
    button.danger{background:rgba(239,68,68,.18); border:1px solid rgba(239,68,68,.40)}
    button:disabled{opacity:.55; cursor:not-allowed}

    .grid2{display:grid; grid-template-columns:1fr; gap:10px}
    @media(min-width:680px){ .grid2{grid-template-columns:1fr 1fr;} }

    .tiles{display:grid; grid-template-columns:1fr; gap:10px}
    @media(min-width:620px){ .tiles{grid-template-columns:1fr 1fr;} }

    .tile{border-radius:18px; border:1px solid rgba(255,255,255,.10); padding:12px; background:rgba(255,255,255,.03)}
    .tile.free{background:linear-gradient(180deg, var(--tile-free), rgba(255,255,255,.02));}
    .tile.busy{background:linear-gradient(180deg, var(--tile-busy), rgba(255,255,255,.02));}
    .tile.defect{background:linear-gradient(180deg, var(--tile-defect), rgba(255,255,255,.02));}
    .tile.locked{background:linear-gradient(180deg, var(--tile-locked), rgba(255,255,255,.02));}

    .tileHead{display:flex; justify-content:space-between; gap:10px; align-items:flex-start}
    .tileHead .name{font-weight:900}
    .badge{font-size:11px; padding:4px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.14); color:var(--muted)}
    .badge.ok{border-color:rgba(45,212,191,.35); color:#bff7ef}
    .badge.bad{border-color:rgba(239,68,68,.40); color:#ffd5d5}
    .badge.lock{border-color:rgba(148,163,184,.35); color:#e2e8f0}
    .tile .line{height:1px; background:rgba(255,255,255,.08); margin:10px 0}

    .tileActions{display:grid; grid-template-columns: 1fr; gap:8px}
    .tileActions .row2{display:flex; gap:8px}
    .tileActions .row2 > *{flex:1}

    .small{font-size:12px; color:var(--muted)}

    .toggle{display:flex; gap:10px; align-items:center; user-select:none}
    .toggle input{width:auto}

    .footerSpace{height:14px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <span class="dot"></span>
        <div class="title">Washportal</div>
        <div class="pill"><strong id="buildPill">BUILD:</strong>&nbsp;<span id="buildTxt">—</span></div>
        <div class="pill"><strong>Zimmer:</strong>&nbsp;<span id="roomPill">—</span></div>
      </div>

      <div id="err" class="err"></div>

      <div class="card">
        <h2>Login</h2>
        <div class="grid2">
          <div>
            <div class="muted">Zimmer</div>
            <input id="room" inputmode="numeric" placeholder="z.B. 316" />
          </div>
          <div>
            <div class="muted">Persönlicher PIN</div>
            <input id="pin" inputmode="numeric" placeholder="z.B. 1711" />
          </div>
          <div>
            <div class="muted">Stations‑PIN</div>
            <input id="stationPin" inputmode="numeric" placeholder="z.B. 1111" />
          </div>
          <div class="row" style="align-items:end">
            <button id="saveBtn" class="secondary">Speichern</button>
            <button id="refreshBtn">Aktualisieren</button>
          </div>
        </div>
        <div class="muted" style="margin-top:8px">Hinweis: Es werden nur Slots angezeigt, die noch laufen oder in der Zukunft liegen. Vergangene Slots können nicht storniert werden.</div>
      </div>
    </div>

    <div style="height:12px"></div>

    <div id="slotsAll" class="card">
      <h2>Slots buchen (Waschmaschinen)</h2>
      <div class="muted" style="margin-bottom:10px">Hier kannst du jeden sichtbaren Slot direkt buchen (auch wenn er schon läuft). Start‑ und Endzeit werden angezeigt.</div>
      <div class="grid2">
        <div>
          <div class="muted">Maschine</div>
          <select id="allMachine"></select>
        </div>
        <div>
          <div class="muted">Slot</div>
          <select id="allSlot"></select>
        </div>
        <div class="row" style="align-items:end">
          <button id="allBookBtn">Buchen</button>
        </div>
      </div>
    </div>

    <div style="height:12px"></div>

    <div class="card">
      <div class="row" style="justify-content:space-between; gap:12px">
        <div>
          <h2 style="margin-bottom:6px">Maschinenübersicht</h2>
          <div class="muted">Waschmaschinen oben, Trockner unten. <span style="color:#ffd5d5">Rot = defekt</span>, <span style="color:#e2e8f0">Grau = admin‑gesperrt</span>.</div>
        </div>
        <label id="whitecardWrap" class="toggle" style="display:none">
          <input id="whitecard" type="checkbox" />
          <span class="muted" style="font-size:12px">Whitecard (Wäsche darf raus)</span>
        </label>
      </div>

      <div class="footerSpace"></div>

      <h2>Waschmaschinen</h2>
      <div id="washTiles" class="tiles"></div>

      <div style="height:14px"></div>

      <h2>Trockner</h2>
      <div id="dryTiles" class="tiles"></div>
    </div>

    <div style="height:12px"></div>

    <div id="myBookingsCard" class="card">
      <h2>Meine Buchungen</h2>
      <div class="muted" style="margin-bottom:10px">Freigeben ist nur für Buchungen mit deinem PIN möglich.</div>
      <div id="myBookings"></div>
    </div>

  </div>

<script>
(() => {
  const API = 'https://washportal-dev-worker.schluffi1220.workers.dev';
  const $ = (id) => document.getElementById(id);

  const state = {
    config: null,
    machines: [],
    bookings: [],
    myBookings: [],
  };

  function showErr(msg){
    const el = $('err');
    el.style.display = msg ? 'block' : 'none';
    el.textContent = msg || '';
  }

  function pad2(n){ return String(n).padStart(2,'0'); }
  function fmtDate(ts){
    const d = new Date(Number(ts||0));
    if (Number.isNaN(d.getTime())) return 'Invalid Date';
    return `${pad2(d.getDate())}.${pad2(d.getMonth()+1)}.${d.getFullYear()} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
  }

  function loadCreds(){
    try{
      const v = JSON.parse(localStorage.getItem('wp_creds')||'{}');
      $('room').value = v.room || '316';
      $('pin').value = v.pin || '1711';
      $('stationPin').value = v.stationPin || '1111';
    }catch{}
  }

  function saveCreds(){
    const v = { room: $('room').value.trim(), pin: $('pin').value.trim(), stationPin: $('stationPin').value.trim() };
    localStorage.setItem('wp_creds', JSON.stringify(v));
    $('roomPill').textContent = v.room || '—';
    return v;
  }

  async function jpost(path, body){
    const res = await fetch(API+path, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(body||{})
    });
    const txt = await res.text();
    let data = {};
    try{ data = JSON.parse(txt || '{}'); }catch{ data = { ok:false, error:'bad_json', message:txt }; }
    if(!res.ok || data.ok === false){
      const m = data?.message || data?.error || `HTTP_${res.status}`;
      throw new Error(m);
    }
    return data;
  }

  function machineName(kind, label){
    return (kind === 'washer' ? 'Waschmaschine ' : 'Trockner ') + label;
  }

  function getActiveBookingsFor(kind, machineId){
    const now = Date.now();
    return state.bookings.filter(b => String(b.kind)===kind && String(b.machineId)===String(machineId) && (b.status==='booked' || b.status==='active') && Number(b.endAt) > now);
  }

  function pickPrevNext(kind, machineId){
    const now = Date.now();
    const all = state.bookings
      .filter(b => String(b.kind)===kind && String(b.machineId)===String(machineId))
      .sort((a,b)=>Number(a.startAt)-Number(b.startAt));

    const prev = [...all].reverse().find(b => Number(b.endAt) <= now);
    const next = all.find(b => Number(b.startAt) >= now && (b.status==='booked' || b.status==='active'));
    return { prev, next };
  }

  function tileClass(m){
    if (!m.enabled) return 'tile locked';
    if (m.defective) return 'tile defect';
    const busy = getActiveBookingsFor(m.kind, m.machineId).length > 0;
    return busy ? 'tile busy' : 'tile free';
  }

  function tileBadge(m){
    if (!m.enabled) return `<span class="badge lock">ADMIN‑GESPERRT</span>`;
    if (m.defective) return `<span class="badge bad">DEFEKT</span>`;
    const busy = getActiveBookingsFor(m.kind, m.machineId).length > 0;
    return busy ? `<span class="badge">BELEGT</span>` : `<span class="badge ok">FREI</span>`;
  }

  function buildWasherSlots(){
    const cfg = state.config;
    const hours = Array.isArray(cfg?.washerHours) ? cfg.washerHours : [6,8,10,12,14,16,18,20];

    const now = Date.now();
    const daysFuture = Number(cfg?.daysFuture ?? 6);
    const daysPast = Number(cfg?.daysPast ?? 7);
    const startDay = startOfDay(now - daysPast*86400000);
    const endDay = startOfDay(now + daysFuture*86400000);

    const slots = [];
    for (let t = startDay; t <= endDay; t += 86400000){
      for (const h of hours){
        const s = t + Number(h)*3600000;
        const e = s + 60*60000; // default 60 min
        // show running or future
        if (e > now) slots.push({ startAt: s, endAt: e });
      }
    }
    // unique
    const seen = new Set();
    const out = [];
    for (const s of slots){
      const k = `${s.startAt}`;
      if(seen.has(k)) continue;
      seen.add(k);
      out.push(s);
    }
    out.sort((a,b)=>a.startAt-b.startAt);
    return out;
  }

  function startOfDay(ts){
    const d = new Date(ts);
    d.setHours(0,0,0,0);
    return d.getTime();
  }

  function renderAllSlotsBooking(){
    const washers = state.machines.filter(m => m.kind==='washer');
    const allMachine = $('allMachine');
    const allSlot = $('allSlot');
    allMachine.innerHTML = '';

    if (washers.length === 0){
      allMachine.innerHTML = `<option value="">Keine Waschmaschinen aktiv.</option>`;
      allSlot.innerHTML = `<option value="">—</option>`;
      $('allBookBtn').disabled = true;
      return;
    }

    for (const m of washers){
      const dis = (!m.enabled || m.defective) ? 'disabled' : '';
      const tag = m.defective ? ' (defekt)' : (!m.enabled ? ' (gesperrt)' : '');
      allMachine.innerHTML += `<option value="${m.machineId}" ${dis}>Waschmaschine ${m.label}${tag}</option>`;
    }

    const slots = buildWasherSlots();
    function refreshSlots(){
      const machineId = allMachine.value;
      const m = washers.find(x => String(x.machineId)===String(machineId));
      const locked = !m || !m.enabled || m.defective;
      allSlot.innerHTML = '';

      for (const s of slots){
        const taken = state.bookings.some(b => b.kind==='washer' && String(b.machineId)===String(machineId) && (b.status==='booked' || b.status==='active') && Number(b.startAt)===Number(s.startAt));
        const label = `${fmtDate(s.startAt)} – ${pad2(new Date(s.endAt).getHours())}:${pad2(new Date(s.endAt).getMinutes())}`;
        const suffix = taken ? ' (belegt)' : '';
        allSlot.innerHTML += `<option value="${s.startAt}" ${taken?'disabled':''}>${label}${suffix}</option>`;
      }

      $('allBookBtn').disabled = locked;
    }

    allMachine.onchange = refreshSlots;
    refreshSlots();
  }

  function renderTiles(){
    const wash = state.machines.filter(m => m.kind==='washer');
    const dry = state.machines.filter(m => m.kind==='dryer');

    const washWrap = $('washTiles');
    const dryWrap = $('dryTiles');
    washWrap.innerHTML = '';
    dryWrap.innerHTML = '';

    for (const m of wash){ washWrap.appendChild(renderTile(m)); }
    for (const m of dry){ dryWrap.appendChild(renderTile(m)); }

    // Whitecard visible only if enabled in config
    $('whitecardWrap').style.display = state.config?.whitecardEnabled ? 'flex' : 'none';
  }

  function renderTile(m){
    const el = document.createElement('div');
    el.className = tileClass(m);

    const { prev, next } = pickPrevNext(m.kind, m.machineId);
    const prevTxt = prev ? `${prev.room} bis ${fmtDate(prev.endAt).split(' ')[1]}` : '—';
    const nextTxt = next ? `${next.room} ab ${fmtDate(next.startAt).split(' ')[1]}` : '—';

    const canDefect = Boolean(state.config?.defectReportEnabled);

    el.innerHTML = `
      <div class="tileHead">
        <div>
          <div class="name">${machineName(m.kind, m.label)}</div>
          <div class="small">Zuletzt: ${prevTxt}</div>
          <div class="small">Nächster: ${nextTxt}</div>
        </div>
        ${tileBadge(m)}
      </div>
      <div class="line"></div>
      <div class="tileActions"></div>
    `;

    const actions = el.querySelector('.tileActions');

    if (m.kind === 'washer') {
      const sel = document.createElement('select');
      sel.innerHTML = `<option value="">Slot wählen…</option>`;
      const slots = buildWasherSlots();
      for (const s of slots){
        const taken = state.bookings.some(b => b.kind==='washer' && String(b.machineId)===String(m.machineId) && (b.status==='booked' || b.status==='active') && Number(b.startAt)===Number(s.startAt));
        const label = `${fmtDate(s.startAt)} – ${pad2(new Date(s.endAt).getHours())}:${pad2(new Date(s.endAt).getMinutes())}`;
        const suffix = taken ? ' (belegt)' : '';
        sel.innerHTML += `<option value="${s.startAt}" ${taken?'disabled':''}>${label}${suffix}</option>`;
      }

      const bookBtn = document.createElement('button');
      bookBtn.textContent = 'Buchen';

      const relBtn = document.createElement('button');
      relBtn.textContent = 'Freigeben';
      relBtn.className = 'secondary';

      const defectBtn = document.createElement('button');
      defectBtn.textContent = 'Defekt';
      defectBtn.className = 'danger';
      defectBtn.style.display = canDefect ? 'block' : 'none';

      const row2 = document.createElement('div');
      row2.className = 'row2';
      row2.appendChild(bookBtn);
      row2.appendChild(relBtn);
      row2.appendChild(defectBtn);

      actions.appendChild(sel);
      actions.appendChild(row2);

      // Disable logic
      const disabled = (!m.enabled || m.defective);
      sel.disabled = disabled;
      bookBtn.disabled = disabled;
      relBtn.disabled = disabled;
      defectBtn.disabled = disabled;

      bookBtn.onclick = async () => {
        try{
          showErr('');
          const startAt = Number(sel.value || 0);
          if(!startAt) return showErr('Bitte Slot auswählen.');
          const creds = saveCreds();
          const slot = buildWasherSlots().find(s=>Number(s.startAt)===startAt);
          const minutes = slot ? Math.round((slot.endAt-slot.startAt)/60000) : 60;
          await jpost('/api/washer/book', { ...creds, machineId: m.machineId, startAt, minutes, whitecard: $('whitecard').checked });
          await refreshAll();
        }catch(e){ showErr(`⛔ ${e.message}`); }
      };

      relBtn.onclick = async () => {
        try{
          showErr('');
          // release the next future booking of mine for this machine
          const now = Date.now();
          const mine = state.myBookings
            .filter(b => b.kind==='washer' && String(b.machineId)===String(m.machineId) && (b.status==='booked' || b.status==='active'))
            .sort((a,b)=>a.startAt-b.startAt);
          const b = mine.find(x=>Number(x.endAt)>now);
          if(!b) return showErr('Keine aktive/gebuchte Buchung für diese Maschine (mit deinem PIN).');
          const creds = saveCreds();
          await jpost('/api/booking/release', { ...creds, bookingId: b.id });
          await refreshAll();
        }catch(e){ showErr(`⛔ ${e.message}`); }
      };

      defectBtn.onclick = async () => {
        try{
          showErr('');
          const ok = confirm(`${machineName(m.kind, m.label)} als defekt markieren? Die Maschine wird sofort gesperrt (bestehende Buchungen bleiben).`);
          if(!ok) return;
          const creds = saveCreds();
          await jpost('/api/defect/report', { ...creds, kind: m.kind, machineId: m.machineId, text: '' });
          await refreshAll();
        }catch(e){ showErr(`⛔ ${e.message}`); }
      };

    } else {
      const bookBtn = document.createElement('button');
      bookBtn.textContent = 'Jetzt buchen';

      const relBtn = document.createElement('button');
      relBtn.textContent = 'Freigeben';
      relBtn.className = 'secondary';

      const defectBtn = document.createElement('button');
      defectBtn.textContent = 'Defekt';
      defectBtn.className = 'danger';
      defectBtn.style.display = canDefect ? 'block' : 'none';

      const row2 = document.createElement('div');
      row2.className = 'row2';
      row2.appendChild(bookBtn);
      row2.appendChild(relBtn);
      row2.appendChild(defectBtn);
      actions.appendChild(row2);

      const disabled = (!m.enabled || m.defective);
      bookBtn.disabled = disabled;
      relBtn.disabled = disabled;
      defectBtn.disabled = disabled;

      bookBtn.onclick = async () => {
        try{
          showErr('');
          const creds = saveCreds();
          await jpost('/api/dryer/book', { ...creds, machineId: m.machineId, minutes: state.config?.dryerMinutes, whitecard: $('whitecard').checked });
          await refreshAll();
        }catch(e){ showErr(`⛔ ${e.message}`); }
      };

      relBtn.onclick = async () => {
        try{
          showErr('');
          const now = Date.now();
          const mine = state.myBookings
            .filter(b => b.kind==='dryer' && String(b.machineId)===String(m.machineId) && (b.status==='booked' || b.status==='active'))
            .sort((a,b)=>a.startAt-b.startAt);
          const b = mine.find(x=>Number(x.endAt)>now);
          if(!b) return showErr('Keine aktive/gebuchte Buchung für diesen Trockner (mit deinem PIN).');
          const creds = saveCreds();
          await jpost('/api/booking/release', { ...creds, bookingId: b.id });
          await refreshAll();
        }catch(e){ showErr(`⛔ ${e.message}`); }
      };

      defectBtn.onclick = async () => {
        try{
          showErr('');
          const ok = confirm(`${machineName(m.kind, m.label)} als defekt markieren? Die Maschine wird sofort gesperrt (bestehende Buchungen bleiben).`);
          if(!ok) return;
          const creds = saveCreds();
          await jpost('/api/defect/report', { ...creds, kind: m.kind, machineId: m.machineId, text: '' });
          await refreshAll();
        }catch(e){ showErr(`⛔ ${e.message}`); }
      };
    }

    return el;
  }

  function renderMyBookings(){
    const wrap = $('myBookings');
    wrap.innerHTML = '';
    const now = Date.now();

    const list = (state.myBookings || []).slice().sort((a,b)=>a.startAt-b.startAt);
    if (list.length === 0){
      wrap.innerHTML = `<div class="muted">Keine Buchungen.</div>`;
      return;
    }

    for (const b of list){
      const past = Number(b.endAt) <= now;
      const card = document.createElement('div');
      card.className = 'tile ' + (past ? '' : '');
      card.style.background = 'rgba(255,255,255,.03)';

      const name = (b.kind==='washer'?'Waschmaschine ':'Trockner ') + b.machineId;
      const line1 = `${fmtDate(b.startAt)} – ${pad2(new Date(b.endAt).getHours())}:${pad2(new Date(b.endAt).getMinutes())} (${b.durationMinutes||b.duration||'?'} min)`;

      card.innerHTML = `
        <div class="tileHead">
          <div>
            <div class="name">${name}</div>
            <div class="small">${line1}</div>
          </div>
          <span class="badge">${b.status}</span>
        </div>
        <div class="line"></div>
        <div class="row" style="justify-content:space-between; gap:10px">
          <div class="small">${past ? 'Vergangen — keine Aktion möglich' : 'Aktionen: Freigeben möglich'}</div>
          <button class="secondary" ${past?'disabled':''}>Freigeben</button>
        </div>
      `;

      const btn = card.querySelector('button');
      btn.onclick = async () => {
        try{
          showErr('');
          const creds = saveCreds();
          await jpost('/api/booking/release', { ...creds, bookingId: b.id });
          await refreshAll();
        }catch(e){ showErr(`⛔ ${e.message}`); }
      };

      wrap.appendChild(card);
    }
  }

  async function refreshAll(){
    const creds = saveCreds();
    if(!creds.room || !creds.pin || !creds.stationPin) return showErr('Bitte Zimmer, PIN und Stations‑PIN eingeben.');

    try{
      showErr('');

      // check lock (optional)
      try{
        const lock = await jpost('/api/room/control/check', { room: creds.room });
        if (lock.blocked) showErr(`⛔ ${lock.message || 'Zimmer ist gesperrt.'}`);
      } catch { /* ignore */ }

      const data = await jpost('/api/user/refresh', creds);

      $('buildTxt').textContent = data.build || '—';
      $('roomPill').textContent = creds.room;

      state.config = data.config || {};
      state.machines = (data.machines || []).map(m => ({
        machineId: String(m.machineId),
        kind: String(m.kind),
        label: String(m.label ?? m.machineId),
        enabled: !!m.enabled,
        minutes: Number(m.minutes||0),
        defective: !!m.defective,
      }));
      state.bookings = data.bookings || [];
      state.myBookings = data.myBookings || data.bookings?.filter(b=>String(b.room)===String(creds.room)) || [];

      // Keep washers on top, dryers bottom
      state.machines.sort((a,b)=> (a.kind===b.kind ? Number(a.machineId)-Number(b.machineId) : (a.kind==='washer'?-1:1)));

      renderAllSlotsBooking();
      renderTiles();
      renderMyBookings();

      // global slots booking button
      $('allBookBtn').onclick = async () => {
        try{
          showErr('');
          const machineId = $('allMachine').value;
          const startAt = Number($('allSlot').value || 0);
          if(!machineId || !startAt) return showErr('Bitte Maschine und Slot auswählen.');
          const slot = buildWasherSlots().find(s=>Number(s.startAt)===startAt);
          const minutes = slot ? Math.round((slot.endAt-slot.startAt)/60000) : 60;
          await jpost('/api/washer/book', { ...creds, machineId, startAt, minutes, whitecard: $('whitecard').checked });
          await refreshAll();
        }catch(e){ showErr(`⛔ ${e.message}`); }
      };

    } catch(e){
      showErr(`⛔ ${e.message}`);
    }
  }

  // Wire buttons
  $('saveBtn').onclick = () => { saveCreds(); showErr('Gespeichert.'); setTimeout(()=>showErr(''), 900); };
  $('refreshBtn').onclick = refreshAll;

  loadCreds();
  saveCreds();

  // Auto boot
  refreshAll();
})();
</script>
</body>
</html>
