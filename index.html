<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Washportal</title>
  <style>
    :root{
      --bg:#08111f; --panel:#0f1c2f; --panel2:#10243b; --line:rgba(255,255,255,.08);
      --text:#eaf1ff; --muted:rgba(234,241,255,.72);
      --ok:#2ee59d; --warn:#ffd166; --bad:#ff5d6c; --info:#6ea8ff; --white:#ffffff;
      --pFree:rgba(46,229,157,.26);
      --pBooked:rgba(255,209,102,.28);
      --pActive:rgba(110,168,255,.30);
      --pReleased:rgba(167,199,231,.18);
      --pDefect:rgba(255,93,108,.42);
      --pLocked:rgba(160,160,160,.32);
      --shadow:0 10px 28px rgba(0,0,0,.35);
      --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 600px at 20% 0%, #112a54 0%, transparent 55%),
                  radial-gradient(900px 600px at 90% 20%, #1b3a5f 0%, transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:20;
      backdrop-filter: blur(10px);
      background: rgba(8,17,31,.72);
      border-bottom:1px solid var(--line);
    }
    .wrap{max-width:1100px; margin:0 auto; padding:16px;}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .brand{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.2px}
    .pill{padding:6px 10px; border:1px solid var(--line); border-radius:999px; color:var(--muted); font-size:12px}
    input, select, button, textarea{
      border-radius:12px; border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color:var(--text);
      padding:10px 12px;
      outline:none;
    }
    input::placeholder, textarea::placeholder{color:rgba(234,241,255,.45)}
    button{
      cursor:pointer; font-weight:700;
      background: linear-gradient(180deg, rgba(110,168,255,.22), rgba(110,168,255,.08));
    }
    button.secondary{background: rgba(255,255,255,.06)}
    button.danger{background: linear-gradient(180deg, rgba(255,93,108,.22), rgba(255,93,108,.08))}
    button.ok{background: linear-gradient(180deg, rgba(46,229,157,.22), rgba(46,229,157,.08))}
    button:disabled{opacity:.45; cursor:not-allowed}
    .grid{display:grid; gap:14px}
    .grid2{grid-template-columns:1fr;}
    .panel{
      background: linear-gradient(180deg, rgba(16,36,59,.96), rgba(15,28,47,.92));
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      padding:14px;
    }
    .title{font-weight:900; margin:0 0 8px 0; font-size:15px}
    .muted{color:var(--muted)}
    .small{font-size:12px}
    .hr{height:1px; background:var(--line); margin:10px 0}
    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:18px; z-index:50;
      padding:10px 12px; border-radius:14px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.55);
      box-shadow: var(--shadow);
      display:none;
      max-width:min(560px, calc(100vw - 24px));
      white-space:pre-wrap;
    }
    .banner{
      position:fixed; left:14px; bottom:14px; z-index:45;
      background: rgba(0,0,0,.55);
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
      max-width:min(520px, calc(100vw - 28px));
      display:none;
      white-space:pre-wrap;
    }
    .machineGrid{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap:12px;
    }
    @media (max-width: 900px){
      .grid2{grid-template-columns:1fr;}
      .machineGrid{grid-template-columns: repeat(2, minmax(0,1fr));}
    }
    .card{
      border-radius: 18px;
      border:1px solid var(--line);
      padding:12px;
      background: rgba(255,255,255,.04);
      position:relative;
      overflow:hidden;
      min-height:132px;
    }
    .card::before{
      content:"";
      position:absolute; inset:0;
      background: var(--pFree);
      opacity:1;
      pointer-events:none;
    }
    .card > *{position:relative}
    .card.defect::before{background: var(--pDefect)}
    .card.locked::before{background: var(--pLocked)}
    .card.booked::before{background: var(--pBooked)}
    .card.active::before{background: var(--pActive)}
    .card.released::before{background: var(--pReleased)}
    .kicker{font-size:12px; color:var(--muted)}
    .big{font-size:20px; font-weight:900}
    .btnRow{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .slotGrid{
      display:grid; gap:10px;
      grid-template-columns: repeat(4, minmax(0,1fr));
    }
    @media (max-width: 900px){ .slotGrid{grid-template-columns: repeat(2, minmax(0,1fr));} }
    .slotBox{
      border:1px solid var(--line);
      border-radius:16px;
      background: rgba(255,255,255,.04);
      padding:10px;
    }
    .slotBox .hdr{display:flex; justify-content:space-between; gap:10px; align-items:center}
    .slotBox .hdr b{font-size:13px}
    .slotBox .actions{display:flex; gap:6px; flex-wrap:wrap; margin-top:10px}
    .pop{
      position:fixed; inset:0; z-index:60;
      display:none; align-items:center; justify-content:center;
      background: rgba(0,0,0,.55);
      padding:18px;
    }
    .pop .box{
      width:min(520px, 100%);
      border-radius: 18px;
      border:1px solid var(--line);
      background: rgba(15,28,47,.98);
      box-shadow: var(--shadow);
      padding:14px;
    }
    .pop .box h3{margin:0 0 6px 0}
    .pop .box p{margin:0; color:var(--muted)}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="row" style="justify-content:space-between">
      <div class="brand">
        <span style="display:inline-block;width:12px;height:12px;border-radius:999px;background:var(--info)"></span>
        <span>Washportal</span>
        <span id="buildPill" class="pill">BUILD: â€“</span>
      </div>
      <div class="row">
        <span id="statusPill" class="pill">offline</span>
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <input id="room" placeholder="Zimmer" style="width:110px" inputmode="numeric" />
      <input id="pin" placeholder="PersÃ¶nlicher PIN" style="width:170px" inputmode="numeric" />
      <input id="stationPin" placeholder="Stationsâ€‘PIN" style="width:170px" inputmode="numeric" />
      <button id="btnSave" class="secondary">Speichern</button>
      <button id="btnRefresh" class="">Aktualisieren</button>
      <span class="pill" id="lockState">â€”</span>
    </div>

    <div id="newsBox" class="panel" style="margin-top:12px; display:none">
      <div class="title">News</div>
      <div id="newsText" class="muted"></div>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="grid">
    <div class="panel">
      <div class="title">Slots (Waschmaschinen)</div>
      <div class="muted small">Alle Slots, die noch laufen oder in der Zukunft liegen, sind sichtbar. Freie Slots sind buchbar.</div>
      <div class="hr"></div>
      <div id="slotsAll" class="slotGrid"></div>
    </div>

    
  </div>

  <div class="panel" style="margin-top:14px">
    <div class="row" style="justify-content:space-between; align-items:flex-end">
      <div>
        <div class="title">MaschinenÃ¼bersicht</div>
        <div class="muted small">Waschmaschinen oben, Trockner unten. Rot = defekt, Grau = adminâ€‘gesperrt.</div>
      </div>
      <div class="row">
        <label class="pill" style="display:flex; gap:8px; align-items:center">
          <input id="whitecard" type="checkbox" style="margin:0" />
          Whitecard (WÃ¤sche darf raus)
        </label>
      </div>
    </div>
    <div class="hr"></div>

    <div class="title" style="margin-top:0">Waschmaschinen</div>
    <div id="washers" class="machineGrid"></div>

    <div class="hr"></div>

    <div class="title" style="margin-top:0">Trockner</div>
    <div id="dryers" class="machineGrid"></div>
  </div>
</div>

  <div class="panel">
      <div class="title">Meine Buchungen</div>
      <div class="muted small">Freigeben ist nur fÃ¼r Buchungen mit deinem PIN mÃ¶glich. Vergangene Slots kÃ¶nnen nicht storniert werden.</div>
      <div class="hr"></div>
      <div id="myBookings"></div>
    </div>

<div id="toast" class="toast"></div>
<div id="errBanner" class="banner"></div>

<div id="lockPop" class="pop">
  <div class="box">
    <h3>Zimmer gesperrt</h3>
    <p id="lockMsg"></p>
    <div class="btnRow" style="justify-content:flex-end">
      <button class="secondary" onclick="hideLockPopup()">OK</button>
    </div>
  </div>
</div>

<script>
(() => {
  "use strict";
  const API = "https://washportal-dev-worker.schluffi1220.workers.dev";

  const $ = (id) => document.getElementById(id);

  function showToast(msg){
    const el = $("toast");
    el.textContent = msg;
    el.style.display = "block";
    clearTimeout(showToast._t);
    showToast._t = setTimeout(() => el.style.display = "none", 2600);
  }
  function showErrBanner(msg){
    const el = $("errBanner");
    el.textContent = msg;
    el.style.display = "block";
  }
  function hideErrBanner(){ $("errBanner").style.display = "none"; }

  window.hideLockPopup = function hideLockPopup(){
    $("lockPop").style.display = "none";
  };

  async function jget(path){
    const r = await fetch(API + path, { method:"GET", mode:"cors", credentials:"omit" });
    const txt = await r.text();
    let data = {};
    try{ data = JSON.parse(txt); }catch{ data = { ok:false, error:"bad_json", message:txt }; }
    if(!r.ok || data.ok === false) throw new Error(data.message || ("HTTP " + r.status));
    return data;
  }
  async function jpost(path, body){
    const r = await fetch(API + path, {
      method:"POST",
      mode:"cors",
      credentials:"omit",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(body || {})
    });
    const txt = await r.text();
    let data = {};
    try{ data = JSON.parse(txt); }catch{ data = { ok:false, error:"bad_json", message:txt }; }
    if(!r.ok || data.ok === false) {
      const msg = data.message || data.error || ("HTTP " + r.status);
      throw new Error(msg);
    }
    return data;
  }

  function pad2(n){ return String(n).padStart(2,"0"); }
  function fmtTime(ts){
    const d = new Date(Number(ts));
    return pad2(d.getHours()) + ":" + pad2(d.getMinutes());
  }
  function fmtDate(ts){
    const d = new Date(Number(ts));
    return pad2(d.getDate()) + "." + pad2(d.getMonth()+1) + "." + d.getFullYear();
  }
  function startOfDay(ts){
    const d = new Date(Number(ts));
    d.setHours(0,0,0,0);
    return d.getTime();
  }

  function normalizeState(s){
    s = s || {};
    s.config = s.config || {};
    s.machines = Array.isArray(s.machines) ? s.machines : [];
    s.machines.sort((a,b)=> (a.kind===b.kind? (Number(a.machineId)-Number(b.machineId)) : (a.kind==='washer'?-1:1)) );
    s.bookings = Array.isArray(s.bookings) ? s.bookings : [];
    s.myBookings = Array.isArray(s.myBookings) ? s.myBookings : [];
    return s;
  }

  function getAuthBody(){
    return {
      room: String($("room").value || "").trim(),
      pin: String($("pin").value || "").trim(),
      stationPin: String($("stationPin").value || "").trim()
    };
  }

  function saveCreds(){
    const a = getAuthBody();
    localStorage.setItem("wp_room", a.room);
    localStorage.setItem("wp_pin", a.pin);
    localStorage.setItem("wp_stationPin", a.stationPin);
    showToast("âœ… Gespeichert");
  }
  function loadCreds(){
    $("room").value = localStorage.getItem("wp_room") || "";
    $("pin").value = localStorage.getItem("wp_pin") || "";
    $("stationPin").value = localStorage.getItem("wp_stationPin") || "";
  }

  function renderNewsBox(cfg){
    const enabled = !!(cfg && cfg.newsEnabled);
    const text = (cfg && cfg.newsText) ? String(cfg.newsText) : "";
    if(enabled && text.trim()){
      $("newsText").textContent = text;
      $("newsBox").style.display = "block";
    } else {
      $("newsBox").style.display = "none";
    }
  }

  function bookingWindow(cfg){
    const now = Date.now();
    const daysPast = Number(cfg.daysPast ?? 7);
    const daysFuture = Number(cfg.daysFuture ?? 6);
    return {
      t0: now - daysPast * 86400000,
      t1: now + daysFuture * 86400000
    };
  }

  function buildSlots(cfg){
    // Show slots for today (and next daysFuture days) but only those not finished yet.
    const hours = Array.isArray(cfg.washerHours) && cfg.washerHours.length ? cfg.washerHours : [6,8,10,12,14,16,18,20];
    const now = Date.now();
    const { t1 } = bookingWindow(cfg);
    const slots = [];
    for(let dayTs = startOfDay(now); dayTs <= startOfDay(t1); dayTs += 86400000){
      for(const h of hours){
        const start = dayTs + Number(h)*3600000;
        const end = start + 60*60000;
        // show if running or future
        if(end > now) slots.push({ startAt:start, endAt:end });
      }
    }
    return slots;
  }

  function findBookingsFor(machineKind, machineId, bookings){
    return bookings.filter(b => String(b.kind)===String(machineKind) && String(b.machineId)===String(machineId));
  }

  function summarizeMachine(machineKind, machineId, bookings){
    const list = findBookingsFor(machineKind, machineId, bookings)
      .slice()
      .sort((a,b) => Number(a.startAt)-Number(b.startAt));
    const now = Date.now();
    let last = null;
    let next = null;
    let active = null;
    for(const b of list){
      const st = Number(b.startAt), en = Number(b.endAt);
      if(en <= now) last = b;
      if(st <= now && en > now && (b.status==="booked" || b.status==="active")) active = b;
      if(st > now && !next && b.status==="booked") next = b;
    }
    return { last, next, active };
  }

  function cardClassFor(machine, summary, defectSet){
    if(machine.enabled === false) return "locked"; // treat disabled as locked for UI
    if(defectSet.has(machine.kind + ":" + machine.machineId)) return "defect";
    if(summary.active) return "active";
    if(summary.next) return "booked";
    return "";
  }

  async function bookWasher(machineId, startAt){
    const cfg = window.__state?.config || {};
    const minutes = 60;
    const body = { ...getAuthBody(), machineId:String(machineId), minutes, startAt:Number(startAt) };
    // whitecard is front-end flag for later (kept for future worker support)
    body.whitecard = !!$("whitecard").checked;
    await jpost("/api/washer/book", body);
    showToast("âœ… Gebucht");
    await refreshAll();
  }
  async function bookDryer(machineId){
    const body = { ...getAuthBody(), machineId:String(machineId), minutes:0 };
    body.whitecard = !!$("whitecard").checked;
    await jpost("/api/dryer/book", body);
    showToast("âœ… Trockner gestartet");
    await refreshAll();
  }
  async function releaseBooking(id){
    const body = { ...getAuthBody(), bookingId:String(id) };
    await jpost("/api/booking/release", body);
    showToast("âœ… Freigegeben");
    await refreshAll();
  }
  async function reportDefect(kind, machineId){
    // description is optional
    const text = (prompt("Optional: Beschreibung (leer lassen = nur Defekt melden)") || "").trim();
    const body = { ...getAuthBody(), machineId: `${kind}:${machineId}`, text };
    await jpost("/api/defect/report", body);
    showToast("âœ… Defekt gemeldet");
    await refreshAll();
  }

  function renderMyBookings(state){
    const list = (state.myBookings || []).slice().sort((a,b)=>Number(a.startAt)-Number(b.startAt));
    const root = $("myBookings");
    root.innerHTML = "";
    if(!list.length){
      root.innerHTML = `<div class="muted small">Keine eigenen Buchungen.</div>`;
      return;
    }
    const now = Date.now();
    for(const b of list){
      const div = document.createElement("div");
      div.className = "slotBox";
      const past = Number(b.endAt) <= now;
      const canRelease = !past && String(b.status)==="booked";
      div.innerHTML = `
        <div class="hdr">
          <b>${b.kind === "washer" ? "Waschmaschine" : "Trockner"} ${b.machineId}</b>
          <span class="pill">${b.status}</span>
        </div>
        <div class="muted small" style="margin-top:6px">
          ${fmtDate(b.startAt)} Â· ${fmtTime(b.startAt)} â€“ ${fmtTime(b.endAt)} (${b.durationMinutes || Math.max(1, Math.round((b.endAt-b.startAt)/60000))} min)
        </div>
      `;
      const actions = document.createElement("div");
      actions.className = "actions";
      if(canRelease){
        const btn = document.createElement("button");
        btn.className = "ok";
        btn.textContent = "Freigeben";
        btn.onclick = () => releaseBooking(b.id).catch(e=>showToast("â›” " + e.message));
        actions.appendChild(btn);
      } else {
        const info = document.createElement("span");
        info.className = "muted small";
        info.textContent = past ? "Vergangen â€” keine Aktion mÃ¶glich" : "â€”";
        actions.appendChild(info);
      }
      div.appendChild(actions);
      root.appendChild(div);
    }
  }

  function renderSlotsAll(state){
    const cfg = state.config || {};
    const slots = buildSlots(cfg);
    const washers = state.machines.filter(m => m.kind === "washer" && m.enabled);
    const bookings = state.bookings || [];

    const root = $("slotsAll");
    root.innerHTML = "";
    if(!washers.length){
      root.innerHTML = `<div class="muted small">Keine Waschmaschinen aktiv.</div>`;
      return;
    }
    // For each slot show buttons for each washer that is free at that time.
    for(const s of slots){
      const div = document.createElement("div");
      div.className = "slotBox";
      div.innerHTML = `
        <div class="hdr">
          <b>${fmtDate(s.startAt)} Â· ${fmtTime(s.startAt)} â€“ ${fmtTime(s.endAt)}</b>
          <span class="pill">60 min</span>
        </div>
        <div class="actions" id="act_${s.startAt}"></div>
      `;
      const act = div.querySelector(".actions");
      for(const w of washers){
        const conflict = bookings.some(b =>
          b.kind === "washer" &&
          String(b.machineId) === String(w.machineId) &&
          (b.status === "booked" || b.status === "active") &&
          (Number(b.startAt) < s.endAt && Number(b.endAt) > s.startAt)
        );
        const btn = document.createElement("button");
        btn.textContent = `W${w.machineId}`;
        btn.disabled = conflict;
        btn.onclick = () => bookWasher(w.machineId, s.startAt).catch(e=>showToast("â›” " + e.message));
        act.appendChild(btn);
      }
      root.appendChild(div);
    }
  }

  function renderMachines(state){
    const bookings = state.bookings || [];
    const machines = state.machines || [];
    const defectSet = new Set(); // future: derive from admin config; for now, none (worker stores defects separately)
    // We can at least mark machines as defect if there is a recent defect report matching machineId prefix
    // (No endpoint yet -> keep empty).

    function renderGroup(kind, targetId){
      const root = $(targetId);
      root.innerHTML = "";
      const list = machines.filter(m => m.kind === kind);
      for(const m of list){
        const summary = summarizeMachine(kind, m.machineId, bookings);
        const cls = cardClassFor(m, summary, defectSet);
        const card = document.createElement("div");
        card.className = "card " + cls;

        const lastTxt = summary.last ? (`Zuletzt: Zimmer ${summary.last.room} bis ${fmtTime(summary.last.endAt)}`) : "Zuletzt: â€”";
        const nextTxt = summary.next ? (`NÃ¤chste: Zimmer ${summary.next.room} ab ${fmtTime(summary.next.startAt)}`) : "NÃ¤chste: â€”";

        card.innerHTML = `
          <div class="kicker">${kind === "washer" ? "Waschmaschine" : "Trockner"}</div>
          <div class="big">${m.label}</div>
          <div class="muted small" style="margin-top:4px">${lastTxt}</div>
          <div class="muted small">${nextTxt}</div>
        `;

        const btnRow = document.createElement("div");
        btnRow.className = "btnRow";

        if(kind === "dryer"){
          const b = document.createElement("button");
          b.textContent = "Starten";
          b.onclick = () => bookDryer(m.machineId).catch(e=>showToast("â›” " + e.message));
          btnRow.appendChild(b);
        } else {
          const hint = document.createElement("span");
          hint.className = "muted small";
          hint.textContent = "Buchen oben in der Slotliste";
          btnRow.appendChild(hint);
        }

        const d = document.createElement("button");
        d.className = "danger";
        d.textContent = "Defekt";
        d.onclick = () => reportDefect(kind, m.machineId).catch(e=>showToast("â›” " + e.message));
        btnRow.appendChild(d);

        card.appendChild(btnRow);
        root.appendChild(card);
      }
    }

    renderGroup("washer", "washers");
    renderGroup("dryer", "dryers");
  }

  async function refreshAll(){
    hideErrBanner();
    const auth = getAuthBody();
    if(!auth.room || !auth.pin || !auth.stationPin){
      showToast("â›” Bitte Zimmer, PIN und Stationsâ€‘PIN eingeben.");
      return;
    }
    try{
      const st = await jget("/api/_status?ts=" + Date.now());
      $("buildPill").textContent = "BUILD: " + (st.build || "â€“");
      $("statusPill").textContent = "online";
    }catch{ $("statusPill").textContent = "offline"; }

    try{
      const lock = await jpost("/api/room/control/check", { room:auth.room, pin:auth.pin, stationPin:auth.stationPin }).catch(()=>null);
      if(lock){
        $("lockState").textContent = lock.blocked ? "ðŸ”’ Zimmer gesperrt" : "âœ… Zimmer frei";
        if(lock.blocked){
          $("lockMsg").textContent = lock.message || "Bitte wende dich an PS/SV.";
          $("lockPop").style.display = "flex";
        }
      }
      const state = normalizeState(await jpost("/api/user/refresh", auth));
      window.__state = state;

      renderNewsBox(state.config);
      renderSlotsAll(state);
      renderMyBookings(state);
      renderMachines(state);

      if(state.blocked){
        $("lockState").textContent = "ðŸ”’ Zimmer gesperrt";
      }
    }catch(e){
      showErrBanner("â›” " + (e.message || String(e)));
      showToast("â›” Fehler");
      console.error("refreshAll failed:", e);
    }
  }

  function wire(){
    $("btnSave").onclick = () => saveCreds();
    $("btnRefresh").onclick = () => refreshAll();
    $("room").addEventListener("keydown", (e)=>{ if(e.key==="Enter") refreshAll(); });
    $("pin").addEventListener("keydown", (e)=>{ if(e.key==="Enter") refreshAll(); });
    $("stationPin").addEventListener("keydown", (e)=>{ if(e.key==="Enter") refreshAll(); });
  }

  async function boot(){
    loadCreds();
    wire();
    try{
      const st = await jget("/api/_status?ts=" + Date.now());
      $("buildPill").textContent = "BUILD: " + (st.build || "â€“");
      $("statusPill").textContent = "online";
    }catch{}
    if(($("room").value || "").trim()){
      refreshAll();
    }
  }

  boot();
})();
</script>
</body>
</html>
