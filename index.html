<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Wasch-Portal (DEV)</title>
  <style>
    :root{
      --bg:#ffffff;
      --text:#0a0a0a;
      --muted:#666;
      --card:#f6f6f6;
      --border:#ddd;
      --btn:#111;
      --btnText:#fff;

      --freeBg:#e9f7ec;
      --bookedBg:#e8f2ff;
      --defectBg:#ffe8ea;
      --blockedBg:#fff1db;

      --freeDot:#1e8e3e;
      --bookedDot:#1a73e8;
      --defectDot:#d93025;
      --blockedDot:#f29900;
    }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--text); margin:0; padding:16px;}
    h1{margin:0 0 4px 0;}
    .sub{color:var(--muted); margin-bottom:12px;}
    .wrap{max-width:900px; margin:0 auto;}
    .box{border:1px solid var(--border); border-radius:12px; padding:12px; background:#fff; margin-bottom:12px;}
    .row{display:flex; gap:10px; flex-wrap:wrap;}
    label{display:block; font-weight:600; margin:8px 0 4px;}
    input,select,textarea{width:100%; padding:10px; border:1px solid var(--border); border-radius:10px; font-size:16px;}
    input[type="password"]{font-family:inherit;}
    button{padding:10px 14px; border-radius:10px; border:0; background:var(--btn); color:var(--btnText); font-size:16px; cursor:pointer;}
    button.secondary{background:#eee; color:#111; border:1px solid var(--border);}
    button:disabled{opacity:.5; cursor:not-allowed;}
    .status{padding:10px; background:var(--card); border-radius:10px; border:1px solid var(--border); margin-bottom:10px;}
    details summary{cursor:pointer; font-weight:700;}
    .grid{display:grid; grid-template-columns:1fr; gap:10px; margin-top:10px;}
    @media(min-width:700px){ .grid{grid-template-columns:1fr 1fr;} }
    .tile{border:1px solid var(--border); border-radius:14px; padding:12px; background:#fff; display:flex; justify-content:space-between; align-items:center; gap:10px;}
    .tile.left{display:block;}
    .dot{width:14px;height:14px;border-radius:50%;}
    .title{font-weight:800;}
    .small{font-size:13px;color:var(--muted);}
    .pill{display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid var(--border); font-size:12px; margin-left:6px;}
    .bg-free{background:var(--freeBg);}
    .bg-booked{background:var(--bookedBg);}
    .bg-defect{background:var(--defectBg);}
    .bg-blocked{background:var(--blockedBg);}
    .hr{height:1px; background:var(--border); margin:12px 0;}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size:12px;}
  </style>
</head>
<body>
<div class="wrap">

  <h1>Wasch-Portal (DEV)</h1>
  <div class="sub">Cloudflare Worker + D1</div>

  <div id="status" class="status">Lade…</div>

  <!-- 1) Zugang -->
  <div class="box">
    <h2>1) Zugang</h2>

    <label>Zimmernummer</label>
    <input id="room" placeholder="z. B. 316" inputmode="numeric" />

    <label>Persönlicher PIN (4-stellig)</label>
    <input id="pin" type="password" placeholder="****" inputmode="numeric" />

    <label>Stations-PIN (für Buchen erforderlich)</label>
    <input id="stationPin" type="password" placeholder="****" inputmode="numeric" />

    <div class="row" style="margin-top:10px">
      <button onclick="refreshAll()">Aktualisieren</button>
      <button class="secondary" onclick="clearAccess()">Leeren</button>
    </div>
  </div>

  <!-- 2) Slots buchen -->
  <div class="box">
    <h2>2) Slots buchen</h2>

    <label>Freier Slot (Waschmaschine)</label>
    <select id="slotSelect"></select>

    <div class="row" style="margin-top:10px">
      <button onclick="bookSelected()">Buchen</button>
    </div>

    <div class="small" style="margin-top:8px">
      Hinweis: Belegte/defekte/abgelaufene Slots sind sichtbar, aber nicht buchbar.
    </div>
  </div>

  <!-- 3) Maschinenübersicht -->
  <div class="box">
    <h2>3) Maschinenübersicht</h2>
    <div id="machinesGrid" class="grid"></div>
  </div>

  <!-- 4) Meine Buchungen -->
  <div class="box">
    <h2>4) Meine Buchungen</h2>
    <button class="secondary" onclick="loadMyBookings()">Meine Buchungen aktualisieren</button>
    <div id="myBookings" style="margin-top:10px"></div>
  </div>

  <!-- 5) Feedback (später) -->
  <div class="box">
    <h2>5) Feedback / Antworten</h2>
    <div class="small">Kommt als nächster Schritt (Chat mit Admin, gelesen/visible).</div>
  </div>

  <!-- 6) Admin -->
  <div class="box">
    <h2>6) Admin</h2>

    <div class="row">
      <div style="flex:1; min-width:240px">
        <label>Admin-Passwort</label>
        <input id="adminPw" type="password" placeholder="z.B. initial" onkeydown="if(event.key==='Enter')adminLogin()">
        <div class="row" style="margin-top:8px">
          <button onclick="adminLogin()">Login</button>
          <button class="secondary" onclick="adminLogout()">Logout</button>
        </div>
      </div>

      <div style="flex:1; min-width:240px">
        <label>Stations-PIN setzen/ändern</label>
        <input id="adminStationPin" type="password" placeholder="z.B. 1111" inputmode="numeric">
        <button style="margin-top:8px" onclick="adminSetStationPin()">Stations-PIN speichern</button>
        <div class="small">Wird als Hash gespeichert (nicht Klartext).</div>
      </div>
    </div>

    <div class="hr"></div>

    <details>
      <summary>Admin-Passwort ändern</summary>
      <label>Neues Admin-Passwort (min. 8 Zeichen)</label>
      <input id="adminPwNew" type="password" placeholder="Neues Passwort">
      <button style="margin-top:8px" onclick="adminChangePw()">Passwort ändern</button>
    </details>

    <div class="hr"></div>

    <details open>
      <summary>Tage-Fenster</summary>
      <div class="row">
        <div style="flex:1; min-width:140px">
          <label>Vergangene Tage</label>
          <input id="daysPast" inputmode="numeric" placeholder="1">
        </div>
        <div style="flex:1; min-width:140px">
          <label>Zukünftige Tage</label>
          <input id="daysFuture" inputmode="numeric" placeholder="6">
        </div>
      </div>
      <button style="margin-top:8px" onclick="adminSaveDays()">Speichern (mit Bestätigung)</button>
    </details>

    <div class="hr"></div>

    <details open>
      <summary>Wasch-Zeiten (0–23 Uhr)</summary>
      <div id="hourChecks" style="display:flex; flex-wrap:wrap; gap:8px; margin-top:8px"></div>
      <button style="margin-top:10px" onclick="adminSaveWasherTimes()">Speichern (mit Bestätigung)</button>
    </details>

    <div class="hr"></div>

    <details>
      <summary>Logs</summary>
      <button style="margin-top:8px" class="secondary" onclick="adminLoadLogs()">Logs laden</button>
      <div id="logsBox" class="mono" style="margin-top:10px; white-space:pre-wrap"></div>
    </details>

  </div>

</div>

<script>
/* ✅ WICHTIG: WORKER URL EINTRAGEN */
const API_BASE = "https://washportal-dev-worker.schluffi1220.workers.dev";

const $ = (id)=>document.getElementById(id);
let statusCache = null;
let adminLoggedIn = false;
let adminLast = 0;

function setStatus(msg){ $("status").textContent = msg; }

async function jget(path){
  const r = await fetch(API_BASE + path, { cache:"no-store" });
  return await r.json().catch(()=>({ok:false}));
}
async function jpost(path, body){
  const r = await fetch(API_BASE + path, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(body||{})
  });
  const data = await r.json().catch(()=>({ok:false}));
  return { r, data };
}

function clearAccess(){
  $("room").value = "";
  $("pin").value = "";
  $("stationPin").value = "";
}

function fmtDT(ms){
  const d = new Date(ms);
  return new Intl.DateTimeFormat("de-DE", {
    timeZone:"Europe/Berlin",
    day:"2-digit", month:"2-digit", year:"numeric",
    hour:"2-digit", minute:"2-digit"
  }).format(d);
}
function fmtTime(ms){
  const d = new Date(ms);
  return new Intl.DateTimeFormat("de-DE", {
    timeZone:"Europe/Berlin",
    hour:"2-digit", minute:"2-digit"
  }).format(d);
}
function stateToBg(state){
  if(state==="free") return "bg-free";
  if(state==="booked") return "bg-booked";
  if(state==="defect") return "bg-defect";
  if(state==="blocked") return "bg-blocked";
  if(state==="past") return "bg-blocked";
  return "";
}
function stateToDot(state){
  if(state==="free") return "var(--freeDot)";
  if(state==="booked") return "var(--bookedDot)";
  if(state==="defect") return "var(--defectDot)";
  if(state==="blocked"||state==="past") return "var(--blockedDot)";
  return "#999";
}

async function boot(){
  setStatus("Lade Status…");
  const s = await jget("/api/status");
  if(!s.ok){
    setStatus("Fehler beim Laden.");
    alert(JSON.stringify(s,null,2));
    return;
  }
  statusCache = s;
  setStatus("Bereit. Build: " + s.build);
  buildHoursUI();
  fillAdminDefaults(s.config);
  renderMachines();
  renderSlotSelect([]); // empty until refreshAll
}
boot();

function fillAdminDefaults(cfg){
  $("daysPast").value = cfg.daysPast ?? 1;
  $("daysFuture").value = cfg.daysFuture ?? 6;
}

function buildHoursUI(){
  const wrap = $("hourChecks");
  wrap.innerHTML = "";
  for(let h=0; h<24; h++){
    const id = "h_"+h;
    const lab = document.createElement("label");
    lab.style.display="flex";
    lab.style.alignItems="center";
    lab.style.gap="6px";
    lab.style.border="1px solid #ddd";
    lab.style.borderRadius="10px";
    lab.style.padding="6px 10px";
    lab.style.background="#fff";
    const cb = document.createElement("input");
    cb.type="checkbox";
    cb.id=id;
    cb.dataset.hour=String(h);
    lab.appendChild(cb);
    const txt = document.createElement("span");
    txt.textContent = String(h).padStart(2,"0")+":00";
    lab.appendChild(txt);
    wrap.appendChild(lab);
  }
}

function setHoursChecked(times){
  // times like ["06:00","08:00"]
  const set = new Set(times.map(t=>t.slice(0,2)));
  for(let h=0; h<24; h++){
    const cb = $("h_"+h);
    if(cb) cb.checked = set.has(String(h).padStart(2,"0"));
  }
}

function renderMachines(){
  if(!statusCache) return;
  const machines = statusCache.machines || [];
  const bookings = statusCache.bookings || [];
  const now = Date.now();

  const grid = $("machinesGrid");
  grid.innerHTML = "";

  for(const m of machines){
    const type = m.type;
    const machine = Number(m.machine);
    const key = type+"#"+machine;

    // state
    let state = "free";
    let line = "Frei";
    let until = null;
    let bookedRoom = "";

    if(Number(m.enabled)!==1){
      state="blocked"; line="Gesperrt";
    }else if(Number(m.defect)===1){
      state="defect"; line="Defekt";
    }else{
      // active booking?
      const b = bookings.find(x => x.type===type && Number(x.machine)===machine && x.status==="booked" && Number(x.end)>now && Number(x.start)<Number(x.end));
      if(b && Number(b.end)>now && Number(b.start)<Number(b.end)){
        state="booked";
        until = Number(b.end);
        bookedRoom = b.room || "";
        line = "Belegt bis " + fmtTime(until) + " (Zimmer "+bookedRoom+")";
      }
    }

    const tile = document.createElement("div");
    tile.className = "tile " + stateToBg(state);

    const left = document.createElement("div");
    left.style.display="flex";
    left.style.gap="10px";
    left.style.alignItems="flex-start";

    const dot = document.createElement("div");
    dot.className="dot";
    dot.style.background = stateToDot(state);
    dot.style.marginTop="4px";

    const text = document.createElement("div");
    const t = document.createElement("div");
    t.className="title";
    t.textContent = (type==="washer" ? "Waschmaschine " : "Trockner ") + machine;
    const s = document.createElement("div");
    s.className="small";
    s.textContent = line;

    text.appendChild(t);
    text.appendChild(s);

    left.appendChild(dot);
    left.appendChild(text);

    const right = document.createElement("div");

    // (release/finish buttons for later - coming next step)
    right.innerHTML = "";

    tile.appendChild(left);
    tile.appendChild(right);
    grid.appendChild(tile);
  }

  // hours UI sync
  setHoursChecked((statusCache.config && statusCache.config.washerTimes) ? statusCache.config.washerTimes : []);
}

function renderSlotSelect(slots){
  const sel = $("slotSelect");
  sel.innerHTML = "";

  if(!slots || slots.length===0){
    const o = document.createElement("option");
    o.value="";
    o.textContent="Keine Slots";
    sel.appendChild(o);
    sel.disabled = true;
    return;
  }

  sel.disabled = false;

  for(const s of slots){
    const start = Number(s.start);
    const end = Number(s.end);
    const label = `${fmtDT(start)}–${fmtTime(end)} • Waschmaschine ${s.machine} • ${slotStateText(s)}`;

    const opt = document.createElement("option");
    opt.value = JSON.stringify({ start, machine: s.machine });
    opt.textContent = label;

    const disabled = (s.state!=="free");
    opt.disabled = disabled;
    if(disabled) opt.style.color="#777";

    sel.appendChild(opt);
  }

  // if first option disabled, browser selects it -> we try find first free
  const firstFreeIndex = slots.findIndex(x=>x.state==="free");
  if(firstFreeIndex>=0) sel.selectedIndex = firstFreeIndex;
}

function slotStateText(s){
  if(s.state==="free"){
    const now = Date.now();
    if(Number(s.start) <= now && Number(s.end) > now) return "frei (läuft schon)";
    return "frei";
  }
  if(s.state==="booked") return "belegt";
  if(s.state==="defect") return "defekt";
  if(s.state==="blocked") return "gesperrt";
  if(s.state==="past") return "abgelaufen";
  return s.state;
}

async function refreshAll(){
  const room = $("room").value.trim();
  const pin = $("pin").value.trim();
  const stationPin = $("stationPin").value.trim();

  // load slots
  const {data:slotRes} = await jpost("/api/washer/free-slots", { room, pin, stationPin });
  if(!slotRes.ok){
    setStatus("Fehler beim Laden der Slots.");
    alert(JSON.stringify(slotRes,null,2));
  }else{
    renderSlotSelect(slotRes.slots || []);
    setStatus("Bereit.");
  }

  // reload status
  const st = await jget("/api/status");
  if(st.ok){
    statusCache = st;
    renderMachines();
  }
}

async function bookSelected(){
  const room = $("room").value.trim();
  const pin = $("pin").value.trim();
  const stationPin = $("stationPin").value.trim();

  const raw = $("slotSelect").value;
  if(!raw){ alert("Bitte Slot auswählen."); return; }

  const sel = JSON.parse(raw);
  const start = Number(sel.start);
  const machine = Number(sel.machine);

  const {data} = await jpost("/api/washer/book", { room, pin, stationPin, start, machine });
  if(!data.ok){
    alert(JSON.stringify(data,null,2));
    return;
  }
  alert("✅ Gebucht!");
  await refreshAll();
  await loadMyBookings();
}

async function loadMyBookings(){
  const room = $("room").value.trim();
  const pin = $("pin").value.trim();

  const {data} = await jpost("/api/my-bookings", { room, pin });
  const box = $("myBookings");
  box.innerHTML = "";

  if(!data.ok){
    box.textContent = "Fehler";
    alert(JSON.stringify(data,null,2));
    return;
  }

  const st = await jget("/api/status");
  if(st.ok) statusCache = st;

  const machines = (statusCache && statusCache.machines) ? statusCache.machines : [];
  const mMap = new Map();
  for(const m of machines) mMap.set(m.type+"#"+Number(m.machine), m);

  if(!data.bookings || data.bookings.length===0){
    box.textContent = "Keine Buchungen.";
    return;
  }

  for(const b of data.bookings){
    const m = mMap.get(b.type+"#"+Number(b.machine));
    const defect = m && Number(m.defect)===1;

    const card = document.createElement("div");
    card.className = "box " + (defect ? "bg-defect" : "bg-booked");
    card.style.marginBottom="10px";

    const title = document.createElement("div");
    title.className="title";
    title.textContent = (b.type==="washer"?"Waschmaschine ":"Trockner ") + b.machine;
    if(defect){
      const pill = document.createElement("span");
      pill.className="pill";
      pill.textContent="Defekt";
      title.appendChild(pill);
    }

    const t = document.createElement("div");
    t.className="small";
    t.textContent = `${fmtDT(b.start)}–${fmtTime(b.end)}`;

    const row = document.createElement("div");
    row.className="row";
    row.style.marginTop="10px";

    const btnCancel = document.createElement("button");
    btnCancel.className="secondary";
    btnCancel.textContent="Storno";
    btnCancel.onclick = ()=>cancelBooking(b.id);

    const btnRelease = document.createElement("button");
    btnRelease.className="secondary";
    btnRelease.textContent="Freigeben";
    btnRelease.onclick = ()=>releaseBooking(b.id);

    row.appendChild(btnCancel);
    row.appendChild(btnRelease);

    card.appendChild(title);
    card.appendChild(t);
    card.appendChild(row);
    box.appendChild(card);
  }
}

async function cancelBooking(id){
  const room = $("room").value.trim();
  const pin = $("pin").value.trim();
  const {data} = await jpost("/api/booking/cancel", { id, room, pin });
  if(!data.ok){ alert(JSON.stringify(data,null,2)); return; }
  alert("✅ Storniert");
  await refreshAll();
  await loadMyBookings();
}

async function releaseBooking(id){
  const room = $("room").value.trim();
  const pin = $("pin").value.trim();
  const {data} = await jpost("/api/booking/release", { id, room, pin });
  if(!data.ok){ alert(JSON.stringify(data,null,2)); return; }
  alert("✅ Freigegeben");
  await refreshAll();
  await loadMyBookings();
}

/* ---------------- ADMIN ---------------- */

function adminIsActive(){
  return adminLoggedIn && (Date.now() - adminLast) < (5*60*1000);
}

async function adminLogin(){
  const pw = $("adminPw").value.trim();
  const {data} = await jpost("/api/admin/login", { adminPassword: pw });
  if(!data.ok){ alert(JSON.stringify(data,null,2)); adminLoggedIn=false; return; }
  adminLoggedIn=true;
  adminLast=Date.now();
  alert("✅ Admin Login OK");
  await refreshAll();
}

function adminLogout(){
  adminLoggedIn=false;
  adminLast=0;
  alert("✅ Logout");
}

function adminTouch(){
  adminLast=Date.now();
  if(!adminIsActive()){
    adminLoggedIn=false;
    alert("Admin-Session abgelaufen. Bitte neu einloggen.");
    return false;
  }
  return true;
}

async function adminSetStationPin(){
  if(!adminTouch()) return;
  const pw = $("adminPw").value.trim();
  const stationPin = $("adminStationPin").value.trim();
  const {data} = await jpost("/api/admin/set-station-pin", { adminPassword: pw, stationPin });
  if(!data.ok){ alert(JSON.stringify(data,null,2)); return; }
  alert("✅ Stations-PIN gespeichert");
}

async function adminChangePw(){
  if(!adminTouch()) return;
  const pw = $("adminPw").value.trim();
  const newPw = $("adminPwNew").value.trim();
  const {data} = await jpost("/api/admin/change-password", { adminPassword: pw, newPassword: newPw });
  if(!data.ok){ alert(JSON.stringify(data,null,2)); return; }
  alert("✅ Admin-Passwort geändert");
}

async function adminSaveDays(){
  if(!adminTouch()) return;
  if(!confirm("Sicher speichern?")) return;

  const pw = $("adminPw").value.trim();
  const daysPast = $("daysPast").value.trim();
  const daysFuture = $("daysFuture").value.trim();

  const {data} = await jpost("/api/admin/set-days-window", { adminPassword: pw, daysPast, daysFuture });
  if(!data.ok){ alert(JSON.stringify(data,null,2)); return; }

  alert("✅ Gespeichert");
  await refreshAll();
}

async function adminSaveWasherTimes(){
  if(!adminTouch()) return;
  if(!confirm("Sicher speichern?")) return;

  const pw = $("adminPw").value.trim();
  const hours = [];
  for(let h=0; h<24; h++){
    const cb = $("h_"+h);
    if(cb && cb.checked) hours.push(h);
  }

  const {data} = await jpost("/api/admin/set-washer-times", { adminPassword: pw, hours });
  if(!data.ok){ alert(JSON.stringify(data,null,2)); return; }

  alert("✅ Waschzeiten gespeichert");
  await refreshAll();
}

async function adminLoadLogs(){
  if(!adminTouch()) return;
  const pw = $("adminPw").value.trim();
  const {data} = await jpost("/api/admin/logs", { adminPassword: pw, limit: 200 });
  if(!data.ok){ alert(JSON.stringify(data,null,2)); return; }

  const lines = [];
  for(const l of (data.logs||[])){
    const ts = fmtDT(Number(l.ts||0));
    const action = l.action || "";
    const room = l.room ? ` Zimmer ${l.room}` : "";
    const tm = (l.type && l.machine) ? ` ${l.type}#${l.machine}` : "";
    lines.push(`${ts}  ${action}${room}${tm}`);
  }

  $("logsBox").textContent = lines.join("\n");
}
</script>
</body>
</html>
