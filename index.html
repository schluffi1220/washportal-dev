<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Washportal (Minimal)</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0;padding:24px;background:#0b1220;color:#e6eefc}
    .card{max-width:760px;margin:0 auto;background:#111b2e;border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:18px}
    label{display:block;margin:10px 0 6px}
    input{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:#0b1220;color:#e6eefc}
    button{margin-top:12px;padding:10px 14px;border-radius:10px;border:0;background:#37d0a8;color:#072016;font-weight:700;cursor:pointer}
    pre{white-space:pre-wrap;word-break:break-word;background:#0b1220;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:12px}
    .row{display:flex;gap:10px}
    .row>*{flex:1}
    small{opacity:.75}
  </style>
</head>
<body>
  <div class="card">
    <h2 style="margin:0 0 8px">Washportal – Login (Minimal)</h2>
    <small>Wichtig: API läuft auf dem Worker – nicht auf GitHub Pages.</small>

    <label>API Base (Worker URL)</label>
    <input id="apiBase" value="https://washportal-dev-worker.schluffi1220.workers.dev" />

    <div class="row">
      <div>
        <label>E‑Mail</label>
        <input id="email" autocomplete="username" />
      </div>
      <div>
        <label>Passwort</label>
        <input id="pass" type="password" autocomplete="current-password" />
      </div>
    </div>

    <button id="btnLogin">Login</button>
    <button id="btnMe" style="background:#5aa7ff;color:#061225">/api/auth/me testen</button>

    <h3 style="margin:14px 0 8px">Output</h3>
    <pre id="out">–</pre>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);
  const out = (x) => $("out").textContent = (typeof x === "string") ? x : JSON.stringify(x, null, 2);

  function apiBase() {
    return ($("apiBase").value || "").replace(/\/+$/,"");
  }

  async function jpost(path, body, opts={}) {
    const url = apiBase() + path;
    const res = await fetch(url, {
      method: "POST",
      headers: { "content-type":"application/json" },
      body: JSON.stringify(body || {}),
      // Wenn du Cookie-basierte Session nutzt: credentials:"include"
      // Wenn du Bearer Token nutzt: weglassen.
      credentials: "include",
      ...opts
    });
    const text = await res.text();
    let data;
    try { data = JSON.parse(text); }
    catch { data = { ok:false, error:"bad_json", raw:text.slice(0,400) }; }
    if(!res.ok) throw { status: res.status, data };
    return data;
  }

  async function login() {
    const email = $("email").value.trim();
    const pass  = $("pass").value;
    const data = await jpost("/api/auth/login", { email, password: pass });
    out({ step:"login_ok", data });
    return data;
  }

  async function me() {
    const data = await jpost("/api/auth/me", {});
    out({ step:"me_ok", data });
    return data;
  }

  $("btnLogin").addEventListener("click", async () => {
    try { await login(); await me(); }
    catch (e) { out({ step:"error", e }); console.error(e); }
  });

  $("btnMe").addEventListener("click", async () => {
    try { await me(); }
    catch (e) { out({ step:"error", e }); console.error(e); }
  });
})();
</script>
</body>
</html>
