<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Washportal – BUILD 2026-02-14 FINAL</title>

  <!-- CSP blockiert ALLE externen <script src="..."> Dateien (auch gleiche Domain).
       Es sind nur Inline-Skripte erlaubt, damit keine alten Bundles das Portal brechen. -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 base-uri 'self';
                 object-src 'none';
                 frame-ancestors 'none';
                 img-src 'self' data:;
                 style-src 'self' 'unsafe-inline';
                 script-src 'unsafe-inline';
                 connect-src https://washportal-dev-worker.schluffi1220.workers.dev;
                 form-action 'self';">

  <style>
    body{margin:0;font-family:system-ui;background:#07111f;color:#eaf2ff}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    .top{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
    .badge{padding:6px 10px;border:1px solid rgba(255,255,255,.15);border-radius:999px;background:rgba(255,255,255,.06);font-size:12px}
    .card{border:1px solid rgba(255,255,255,.12);border-radius:16px;background:rgba(255,255,255,.05);padding:14px;margin:12px 0}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:end}
    label{font-size:12px;opacity:.8}
    input,select{padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.06);color:#eaf2ff}
    button{padding:10px 14px;border-radius:14px;border:0;cursor:pointer;font-weight:900}
    .btn{background:linear-gradient(90deg,#6bdcff,#30d28a);color:#00121f}
    .btn2{background:rgba(255,255,255,.08);color:#eaf2ff;border:1px solid rgba(255,255,255,.15)}
    .err{display:none;white-space:pre-wrap;margin:10px 0;padding:10px 12px;border-radius:14px;border:1px solid rgba(243,18,96,.35);background:rgba(243,18,96,.12)}
    .ok{border-color:rgba(23,201,100,.3);background:rgba(23,201,100,.12)}
    .machines{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    @media(max-width:950px){.machines{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:520px){.machines{grid-template-columns:1fr}}
    .m{border:1px solid rgba(255,255,255,.12);border-radius:16px;background:rgba(255,255,255,.05);padding:12px;min-height:120px}
    .mh{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
    .tag{font-size:11px;padding:4px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.15);opacity:.9}
    .tag.ok{border-color:rgba(23,201,100,.35);background:rgba(23,201,100,.14)}
    .tag.bad{border-color:rgba(243,18,96,.35);background:rgba(243,18,96,.14)}
    .small{opacity:.8;font-size:12px;line-height:1.35}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .mini{padding:8px 10px;border-radius:12px;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.07);color:#eaf2ff;font-weight:900;cursor:pointer}
    .mini:disabled{opacity:.45;cursor:not-allowed}
    .lock{display:none;margin-top:10px;padding:10px 12px;border-radius:14px;border:1px solid rgba(245,165,36,.35);background:rgba(245,165,36,.14)}
    .muted{opacity:.75}
  </style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div class="badge">✅ PORTAL BUILD: 2026-02-14 FINAL (OHNE duration)</div>
    <div class="badge" id="buildBadge">Worker: -</div>
    <div class="badge" id="roomBadge">Zimmer: -</div>
  </div>

  <div id="err" class="err"></div>

  <div class="card">
    <h3 style="margin:0 0 10px">Login</h3>
    <div class="row">
      <div><label>Zimmer</label><br><input id="room" placeholder="316" inputmode="numeric"></div>
      <div><label>Persönlicher PIN</label><br><input id="pin" placeholder="PIN" inputmode="numeric"></div>
      <div><label>Stations-PIN</label><br><input id="stationPin" placeholder="Stations-PIN" inputmode="numeric"></div>
      <div>
        <button class="btn" id="save">Speichern</button>
        <button class="btn2" id="refresh" style="margin-left:8px">Aktualisieren</button>
      </div>
    </div>
    <div class="muted" style="margin-top:8px">Hinweis: Externe Skripte sind absichtlich blockiert (CSP), damit keine alten Dateien das Portal kaputt machen.</div>
    <div id="lock" class="lock"></div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 10px">Maschinen</h3>
    <div class="machines" id="machines"></div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 10px">Defekt melden</h3>
    <div class="row">
      <div style="min-width:220px">
        <label>Maschine (optional)</label><br>
        <select id="defMachine"></select>
      </div>
      <div style="flex:1;min-width:260px">
        <label>Beschreibung</label><br>
        <input id="defText" placeholder="Was ist defekt?">
      </div>
      <div><button class="btn" id="defSend">Senden</button></div>
    </div>
  </div>
</div>

<script>
  const API = "https://washportal-dev-worker.schluffi1220.workers.dev";
  const $ = (id)=>document.getElementById(id);

  // Fehler IMMER sichtbar machen
  window.addEventListener("error", (ev)=>{
    try{
      const el = $("err");
      el.style.display="block";
      el.textContent = "⛔ JS Fehler: " + (ev.message || "unbekannt");
    }catch{}
  }, true);
  window.addEventListener("unhandledrejection", (ev)=>{
    try{
      const el = $("err");
      el.style.display="block";
      el.textContent = "⛔ Promise Fehler: " + (ev?.reason?.message || String(ev.reason||"unbekannt"));
    }catch{}
  });

  let STATE = { config:{}, machines:[], bookings:[], myBookings:[], blocked:false, message:"" };

  function show(msg, ok=false){
    const el = $("err");
    el.style.display = msg ? "block" : "none";
    el.textContent = msg || "";
    el.classList.toggle("ok", !!ok);
  }

  function creds(){
    return {
      room: String($("room").value||"").trim(),
      pin: String($("pin").value||"").trim(),
      stationPin: String($("stationPin").value||"").trim()
    };
  }
  function saveCreds(){
    localStorage.setItem("wp_room", $("room").value||"");
    localStorage.setItem("wp_pin", $("pin").value||"");
    localStorage.setItem("wp_stationPin", $("stationPin").value||"");
  }
  function loadCreds(){
    $("room").value = localStorage.getItem("wp_room")||"";
    $("pin").value = localStorage.getItem("wp_pin")||"";
    $("stationPin").value = localStorage.getItem("wp_stationPin")||"";
  }

  async function jpost(path, body){
    const res = await fetch(API + path, {method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body||{})});
    let data={}; try{ data = await res.json(); }catch{}
    if(!res.ok || !data.ok) throw new Error(data.message || data.error || ("HTTP_"+res.status));
    return data;
  }

  function washerSlots(){
    const cfg = STATE.config||{};
    const hours = Array.isArray(cfg.washerHours)&&cfg.washerHours.length ? cfg.washerHours : [6,8,10,12,14,16,18,20];
    const daysFuture = Number(cfg.daysFuture ?? 6);
    const out = [];
    const base = new Date(); base.setMinutes(0,0,0);
    for(let d=0; d<=daysFuture; d++){
      const day = new Date(base.getTime()+d*86400000);
      for(const h of hours){
        const dt = new Date(day.getTime());
        dt.setHours(Number(h),0,0,0);
        if(dt.getTime() >= Date.now()-60000){
          out.push({ ts: dt.getTime(), label: dt.toLocaleDateString("de-DE",{weekday:"short",day:"2-digit",month:"2-digit"})+" "+String(h).padStart(2,"0")+":00" });
        }
      }
    }
    return out;
  }

  function render(){
    $("buildBadge").textContent = "Worker: " + (STATE.build || "-");
    $("roomBadge").textContent = "Zimmer: " + (STATE.room || "-");

    const lock = $("lock");
    if(STATE.blocked){
      lock.style.display="block";
      lock.textContent = "⚠️ Zimmer gesperrt: " + (STATE.message||"") + " — Buchungen gesperrt, Defekt melden geht.";
    } else {
      lock.style.display="none";
      lock.textContent="";
    }

    const dm = $("defMachine");
    dm.innerHTML = `<option value="">(optional) keine Auswahl</option>` + (STATE.machines||[]).map(m=>{
      const k = String(m.kind||"washer").toLowerCase().includes("dry") ? "Trockner":"Waschmaschine";
      return `<option value="${m.machineId}">${k} ${m.label||m.machineId}</option>`;
    }).join("");

    const el = $("machines");
    el.innerHTML = "";
    const slots = washerSlots();
    const dryerMinutes = Number((STATE.config||{}).dryerMinutes ?? 150);

    for(const m of (STATE.machines||[])){
      const kind = String(m.kind||"washer").toLowerCase().includes("dry") ? "dryer":"washer";
      const enabled = !!m.enabled;
      const mid = String(m.machineId||"");
      const label = String(m.label||mid);

      const box = document.createElement("div");
      box.className="m";

      const title = kind==="dryer" ? "Trockner" : "Waschmaschine";
      box.innerHTML = `
        <div class="mh">
          <div style="font-weight:900">${title} ${label}</div>
          <div class="tag ${enabled ? "ok":"bad"}">${enabled ? "AKTIV":"GESPERRT"}</div>
        </div>
        <div class="small">ID: ${mid}</div>
      `;

      const actions = document.createElement("div");
      actions.className="actions";

      if(kind==="washer"){
        const sel = document.createElement("select");
        sel.innerHTML = `<option value="">Slot wählen…</option>` + slots.map(s=>`<option value="${s.ts}">${s.label}</option>`).join("");
        sel.style.minWidth="160px";

        const btn = document.createElement("button");
        btn.className="mini";
        btn.textContent="Buchen";
        btn.disabled = !enabled || STATE.blocked;
        btn.onclick = async ()=>{
          try{
            show("");
            const c = creds();
            if(!c.room || !c.pin || !c.stationPin) throw new Error("Bitte Zimmer, PIN und Stations-PIN eingeben.");
            if(!sel.value) throw new Error("Bitte Slot auswählen.");
            await jpost("/api/washer/book", { ...c, machineId: mid, minutes: 60, startAt: Number(sel.value) });
            await refreshAll();
          }catch(e){ show("⛔ "+e.message); }
        };

        actions.appendChild(sel);
        actions.appendChild(btn);
      } else {
        const btn = document.createElement("button");
        btn.className="mini";
        btn.textContent="Jetzt buchen";
        btn.disabled = !enabled || STATE.blocked;
        btn.onclick = async ()=>{
          try{
            show("");
            const c = creds();
            if(!c.room || !c.pin || !c.stationPin) throw new Error("Bitte Zimmer, PIN und Stations-PIN eingeben.");
            await jpost("/api/dryer/book", { ...c, machineId: mid, minutes: dryerMinutes });
            await refreshAll();
          }catch(e){ show("⛔ "+e.message); }
        };
        actions.appendChild(btn);
      }

      box.appendChild(actions);
      el.appendChild(box);
    }
  }

  async function refreshAll(){
    try{
      show("");
      const c = creds();
      if(!c.room || !c.pin || !c.stationPin){
        show("Bitte Zimmer, PIN und Stations-PIN eingeben.", false);
        return;
      }
      const data = await jpost("/api/user/refresh", c);
      STATE = {
        ...STATE,
        build: data.build || "",
        room: data.room || c.room,
        blocked: !!data.blocked,
        message: String(data.message || ""),
        config: data.config || {},
        machines: data.machines || [],
        bookings: data.bookings || [],
        myBookings: data.myBookings || []
      };
      render();
    }catch(e){
      show("⛔ " + e.message);
    }
  }

  $("save").onclick = ()=>{ saveCreds(); show("Gespeichert ✅", true); refreshAll(); };
  $("refresh").onclick = ()=>refreshAll();

  $("defSend").onclick = async ()=>{
    try{
      show("");
      const c = creds();
      if(!c.room || !c.pin || !c.stationPin) throw new Error("Bitte zuerst Zimmer, PIN und Stations-PIN eingeben.");
      const text = String($("defText").value||"").trim();
      if(!text) throw new Error("Bitte Beschreibung eingeben.");
      const machineId = String($("defMachine").value||"").trim();
      await jpost("/api/defect/report", { ...c, machineId, text });
      $("defText").value="";
      show("Defektmeldung gesendet ✅", true);
    }catch(e){ show("⛔ "+e.message); }
  };

  loadCreds();
  refreshAll();
</script>
</body>
</html>
