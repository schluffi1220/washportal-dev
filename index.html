<!doctype html>
<html lang="de">
<head>
  <link rel="icon" href="./icon.ico">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Washportal</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:#111a2b;
      --line:rgba(255,255,255,.10);
      --txt:#e9f1ff;
      --muted:#9cb0d4;
      --accent:#79d6ff;

      --pastelGreen: rgba(54, 211, 153, .18);
      --pastelBlue:  rgba(84, 211, 255, .18);
      --pastelRed:   rgba(251, 113, 133, .20);
      --pastelGray:  rgba(255,255,255,.06);
    }

/* Slot-Dropdown: lesbar (freie Slots schwarz) */
#slotSelect{
  background: rgba(255,255,255,.92);
  color:#000;
  border-color: rgba(255,255,255,.25);
}
#slotSelect option{ color:#000; }

/* deaktivierte Slots bleiben grau */
#slotSelect option.disabledOpt,
#slotSelect option:disabled{
  color:#8a94a8;
}

    
    *{box-sizing:border-box}
    body{
      margin:0;
      background: radial-gradient(900px 500px at 10% 10%, rgba(121,214,255,.10), transparent 60%),
                  radial-gradient(900px 500px at 90% 20%, rgba(54,211,153,.08), transparent 55%),
                  var(--bg);
      color:var(--txt);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(10px);
      background: rgba(11,18,32,.78);
      border-bottom: 1px solid var(--line);
      padding: 14px 14px;
    }
    .wrap{max-width:980px;margin:0 auto;padding:0 14px}
    h1{margin:0;font-size:18px}
    .sub a{color:inherit;text-decoration:underline;}
    .sub{margin-top:4px;color:var(--muted);font-size:13px}
    main{padding:14px 0 70px}
    .card{
      background: rgba(17,26,43,.90);
      border:1px solid var(--line);
      border-radius:18px;
      padding:14px;
      box-shadow: 0 12px 30px rgba(0,0,0,.20);
      margin-bottom:12px;
    }
    .card h2{margin:0 0 10px;font-size:14px;color:#d7e6ff}
    label{display:block;color:var(--muted);font-size:12px;margin:10px 0 6px}
    input,select,textarea{
      width:100%;
      background: rgba(255,255,255,.04);
      border:1px solid var(--line);
      color:var(--txt);
      padding:10px 12px;
      border-radius:14px;
      outline:none;
      font-size:14px;
    }
    textarea{min-height:96px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:740px){ .row{grid-template-columns:1fr} }

    .btn{
      width:100%;
      margin-top:10px;
      border:none;
      cursor:pointer;
      border-radius:14px;
      padding:12px 12px;
      font-weight:800;
      background: linear-gradient(135deg, rgba(121,214,255,.95), rgba(54,211,153,.92));
      color:#07101e;
    }
    .btn.secondary{
      background: transparent;
      border:1px solid var(--line);
      color:var(--txt);
      font-weight:700;
    }
    .btn.inline{ width:auto; margin:0; padding:10px 12px; }

    details{
      border:1px solid var(--line);
      border-radius:16px;
      padding:10px 12px;
      background: rgba(255,255,255,.03);
    }
    summary{cursor:pointer;color:#cfe3ff;font-weight:800}

    .toast{
      position:fixed; left:50%; bottom:16px; transform:translateX(-50%);
      background: rgba(17,26,43,.96);
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
      box-shadow: 0 12px 35px rgba(0,0,0,.35);
      max-width: min(92vw, 680px);
      display:none;
      z-index:9999;
      font-size:13px;
    }
    .mono{font-family: ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", monospace;}
    .small{font-size:12px;color:var(--muted);line-height:1.45}
    .gridTiles{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
    }
    @media (max-width:900px){ .gridTiles{grid-template-columns: repeat(2, 1fr);} }

    .tile{
      border:1px solid var(--line);
      border-radius:18px;
      padding:12px;
      background: var(--pastelGray);
    }
    .tile.free{ background: var(--pastelGreen); }
    .tile.busy{ background: var(--pastelBlue); }
    .tile.bad { background: var(--pastelRed); }

    .tileTop{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .title{font-weight:900;font-size:14px}
    .tag{
      font-size:11px;
      border:1px solid var(--line);
      padding:4px 8px;
      border-radius:999px;
      color:var(--muted);
      white-space:nowrap;
    }
    .meta{margin-top:6px;font-size:12px;color:var(--muted)}
    .tileBtns{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .tileBtns button{
      border-radius:999px;
      padding:8px 10px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.0);
      color: var(--txt);
      cursor:pointer;
      font-size:12px;
    }
    .disabledOpt{color:#9aa9c6}
  
/* Ensure dropdown text is readable */
.tileBtns select, .tile select{
  color:#000 !important;
  background:#fff !important;
}

/* hide legacy small login row */
/* #btnPsLogin,#btnPsLogout,#psLoginState{display:none !important;} */

.auth-only{display:none}
body[data-authed="1"] .auth-only{display:block}

.hide-on-auth{display:block}
body[data-authed="1"] .hide-on-auth{display:none}
</style>
</head>
<body data-authed="0">
  <header>
    <div class="wrap">
      <h1>Washportal</h1>
      <div style="font-size:13px; opacity:.9;">
  <a href="/washportal-dev/admin-users/"
     style="color:inherit; font-weight:700;">
    DEV-Stand
  </a>
  ‚Äì Mit der Benutzung der Seite erkl√§rst du dich mit den
  <a href="/washportal-dev/privacy/"
     style="color:inherit; text-decoration:underline; font-weight:700;">
    Datenschutzbestimmungen
  </a>
  einverstanden.
</div>

    </div>
  </header>

  <main class="wrap">

    <!-- 1) Zugang -->
    <div class="card" id="cardAccess">
      <h2>1) Zugang</h2>
      <div class="row">
        <div>
          <label>Zimmernummer (0‚Äì400)</label>
          <input id="room" inputmode="numeric" placeholder="z.B. 316" />
        </div>
        <div>
          <label>PIN (4-stellig)</label>
          <input id="pin" type="password" inputmode="numeric" placeholder="****" />
        </div>
      </div>
      <label>Stations-PIN (4-stellig)</label>
      <input id="stationPin" type="password" inputmode="numeric" placeholder="****" />

      <button class="btn" id="btnRefresh">Aktualisieren</button>
      <div class="small" style="margin-top:10px">
        Hinweis: Beim ersten Login einer Zimmernummer wird der PIN automatisch gespeichert (verschl√ºsselt). Danach muss er stimmen.
      </div>

      <div id="newsBoxWrap" style="margin-top:12px; display:none;"></div>
    </div>

    <!-- 2) Slots buchen -->
    <div class="card">
      <h2>2) Slots buchen</h2>
      <label>Wasch-Slot ausw√§hlen</label>
      <select id="slotSelect">
        <option value="">Bitte erst ‚ÄûAktualisieren‚Äú dr√ºcken</option>
      </select>
      <button class="btn" id="btnBookWasher">Buchen</button>
      <div class="small" id="slotHint" style="margin-top:10px"></div>
    </div>

    <!-- 3) Maschinen√ºbersicht -->
    <div class="card">
      <h2>3) Maschinen√ºbersicht</h2>
      <div class="small" style="margin-bottom:10px">
        Gr√ºn = frei ¬∑ Blau = l√§uft/gebucht ¬∑ Rot = defekt/gesperrt
      </div>
      <div class="gridTiles" id="tiles"></div>
    </div>

    <!-- 4) Meine Buchungen -->
    <div class="card">
      <h2>4) Meine Buchungen</h2>
      <div id="myBookings"></div>
    </div>

    <!-- 5) Feedback / Antworten -->
    <div class="card">
      <h2>5) Feedback / Antworten</h2>

      <div class="small" style="margin-bottom:10px">
        Feedback ist ein Chat zwischen Zimmer & Admin. Neue Antworten erscheinen als Popup.
      </div>

      <button class="btn secondary" id="btnLoadFeedback">Feedback laden</button>

      <div id="feedbackList" style="margin-top:10px"></div>

      <label>Neue Nachricht</label>
      <textarea id="feedbackText" placeholder="Deine Nachricht‚Ä¶"></textarea>
      <button class="btn" id="btnSendFeedback">Senden</button>
    </div>

    <!-- 6) Admin -->
    <div class="card hide-on-auth">
      <h2>6) Admin</h2>

      <div id="adminLoginBox">
        <label>Admin-Passwort</label>
        <input id="adminPw" type="password" placeholder="initial (falls neu)" />
        <button class="btn" id="btnAdminLogin">Login</button>
      </div>

      <div id="adminBox" style="display:none">
        <div class="row">
          <button class="btn secondary" id="btnAdminLogout">Logout</button>
          <button class="btn secondary" id="btnAdminReload">Admin aktualisieren</button>
        </div>

        <details style="margin-top:12px" open>
          <summary>Stations-PIN setzen/√§ndern</summary>
          <label>Stations-PIN (4-stellig)</label>
          <input id="adminStationPin" type="password" inputmode="numeric" placeholder="1111" />
          <button class="btn" id="btnSetStationPin">Speichern</button>
        </details>

        <details style="margin-top:12px">
          <summary>Admin-Passwort √§ndern</summary>
          <label>Neues Admin-Passwort</label>
          <input id="adminNewPw" type="password" placeholder="Neues Passwort" />
          <label>Neues Admin-Passwort (Best√§tigung)</label>
          <input id="adminNewPw2" type="password" placeholder="Neues Passwort wiederholen" />
          <button class="btn" id="btnChangeAdminPw">√Ñndern</button>
        </details>

        <details style="margin-top:12px" open>
          <summary>Wasch-Slots (Uhrzeiten per Haken)</summary>
          <div class="small">Waschdauer ist fix 2 Stunden.</div>
          <div id="washerHoursBox" style="margin-top:10px"></div>
          <button class="btn" id="btnSaveWasherHours">Waschzeiten speichern</button>
        </details>

        <details style="margin-top:12px" open>
          <summary>Trockner-Dauer</summary>
          <label>Dauer</label>
          <select id="dryerMinutes">
            <option value="60">1 Stunde</option>
            <option value="90">1,5 Stunden</option>
            <option value="120">2 Stunden</option>
          </select>
          <button class="btn" id="btnSaveDryerMinutes">Speichern</button>
        </details>

        <details style="margin-top:12px">
          <summary>Tage-Fenster + Auto-Purge</summary>
          <div class="row">
            <div>
              <label>Vergangene Tage anzeigen</label>
              <input id="daysPast" inputmode="numeric" />
            </div>
            <div>
              <label>Folgende Tage anzeigen</label>
              <input id="daysFuture" inputmode="numeric" />
            </div>
          </div>
          <button class="btn" id="btnSaveDaysWindow">Speichern</button>
          <div class="small">Purge (L√∂schen alter Buchungen) bauen wir nach Alpha sauber ein ‚Äì Logs bleiben.</div>
        </details>

        <details style="margin-top:12px" open>
          <summary>News (‚ÄûWas ist neu?‚Äú)</summary>
          <label><input type="checkbox" id="newsEnabled" /> Aktiv</label>
          <label>Text</label>
          <textarea id="newsText" placeholder="Was ist neu‚Ä¶"></textarea>
          <label><input type="checkbox" id="bumpNewsVersion" /> Version erh√∂hen (Popup erneut bei allen)</label>
          <button class="btn" id="btnSaveNews">Speichern</button>
          <div class="small" id="newsSeenCount"></div>
        </details>

        <details style="margin-top:12px" open>
          <summary>Maschinen sperren/entsperren + Defekt</summary>
          <div class="small">Sperren = rot, User kann nicht buchen. Defekt = rot, Buchungen bleiben rot markiert.</div>
          <div id="adminMachines" style="margin-top:10px"></div>
          <button class="btn" id="btnSaveMachines">Maschinen speichern</button>
        </details>

        <details style="margin-top:12px" open>
          <summary>Defektmeldung durch User erlauben</summary>
          <label><input type="checkbox" id="userDefectEnabled" /> User d√ºrfen Defekte melden</label>
          <div id="defectAllowedBox" style="margin-top:10px"></div>
          <button class="btn" id="btnSaveDefectRules">Speichern</button>
        </details>

        <details style="margin-top:12px" open>
          <summary>Feedback (Admin-Chat)</summary>
          <div class="row" style="gap:8px;flex-wrap:wrap;margin:8px 0">
            <input id="adminThreadFilter" placeholder="Filter (Zimmer/Text)..." style="flex:1;min-width:180px" />
            <button class="btn danger" id="btnAdminDeleteSelectedThreads">Ausgew√§hlte l√∂schen</button>
            <button class="btn secondary" id="btnAdminExportThreadsCSV">Threads CSV</button>
          </div>
          <div id="adminFeedbackThreads"></div>
          <div id="adminFeedbackThreadView" style="margin-top:10px"></div>
        <hr style="border:0;border-top:1px solid rgba(255,255,255,.12);margin:12px 0">

        <div class="row" style="gap:8px;align-items:center;flex-wrap:wrap">
  <div class="pill">Admin Tools</div>
  <button class="btn" id="btnAdminLoadLogs">Logs laden</button>
  <button class="btn secondary" id="btnAdminExportLogsCSV">Logs CSV</button>
  <input id="adminLogsFilter" placeholder="Logs filtern (Zimmer/Text)‚Ä¶" style="flex:1;min-width:220px" />
</div>

<details id="adminLogsDetails" style="margin-top:10px" open>
  <summary>Logs</summary>
  <div class="card" style="margin-top:10px">
    <div id="adminLogsBox" class="small" style="margin-top:8px"></div>
  </div>
</details>

<div class="row" style="gap:8px;align-items:center;flex-wrap:wrap;margin-top:10px">
  <button class="btn" id="btnAdminLoadBookings">Buchungen laden</button>
  <button class="btn secondary" id="btnAdminExportBookingsCSV">Buchungen CSV</button>
  <input id="adminBookingsFilter" placeholder="Buchungen filtern (Zimmer/Maschine)‚Ä¶" style="flex:1;min-width:220px" />
</div>

<details id="adminBookingsDetails" style="margin-top:10px" open>
  <summary>Buchungen (Admin)</summary>
  <div class="card" style="margin-top:10px">
    <div id="adminBookingsBox" class="small" style="margin-top:8px"></div>
  </div>
</details>

        </details>
      </div>
    </div>
<div class="card hide-on-auth" id="psLoginCard" style="margin-top:20px">
  <h3>PS / VS / Admin Login (E-Mail + Passwort)</h3>

  <div class="row">
    <input id="psEmail" placeholder="E-Mail" style="width:100%">
    <input id="psCode" type="password" autocomplete="current-password" placeholder="Passwort" style="width:100%">
  </div>

  <div class="row" style="margin-top:10px; align-items:center">
<button id="btnPsDashReload" class="btn secondary">Aktualisieren</button>
</div>

  <div class="small" id="psDashInfo" style="margin-top:8px; opacity:.9">‚Äî</div>
  <div class="gridTiles" id="psDashTiles" style="margin-top:12px"></div>
<details id="authConfigDetails" class="auth-only" style="display:none; margin-top:12px">
  <summary><b>Konfiguration / News</b></summary>
  <div class="small" style="margin-top:8px; opacity:.85">
    Diese Einstellungen entsprechen dem Super-Admin Bereich, laufen aber √ºber deinen Token und die gesetzten Haken (Permissions).
  </div>

  <div class="row" style="margin-top:10px; flex-wrap:wrap">
    <button id="btnAuthConfigLoad" class="btn secondary">Konfig laden</button>
    <button id="btnAuthConfigSave" class="btn">Konfig speichern</button>
    <label class="small" style="display:flex; align-items:center; gap:8px; margin-left:auto">
      <input id="authBumpNewsVersion" type="checkbox" />
      News-Version erh√∂hen (Popup f√ºr User)
    </label>
  </div>

  <div id="authConfigMsg" class="small" style="margin-top:10px"></div>

  <div class="grid2" style="margin-top:12px; gap:12px">
    <div class="card" style="padding:12px">
      <div class="small" style="opacity:.8; margin-bottom:8px"><b>Zeitraum</b></div>
      <div class="row" style="gap:10px; align-items:center; flex-wrap:wrap">
        <label class="small">Tage zur√ºck:
          <input id="authDaysPast" type="number" min="0" max="30" style="width:90px; margin-left:6px">
        </label>
        <label class="small">Tage voraus:
          <input id="authDaysFuture" type="number" min="0" max="30" style="width:90px; margin-left:6px">
        </label>
      </div>
    </div>

    <div class="card" style="padding:12px">
      <div class="small" style="opacity:.8; margin-bottom:8px"><b>Trockner</b></div>
      <label class="small">Standarddauer:
        <select id="authDryerMinutes" style="margin-left:6px">
          <option value="60">60 Minuten</option>
          <option value="90">90 Minuten</option>
          <option value="120">120 Minuten</option>
        </select>
      </label>
    </div>
  </div>

  <div class="card" style="padding:12px; margin-top:12px">
    <div class="small" style="opacity:.8; margin-bottom:8px"><b>Waschzeiten (Slots)</b></div>
    <div id="authWasherHoursWrap" class="small" style="display:grid; grid-template-columns: repeat(6, minmax(0,1fr)); gap:6px"></div>
  </div>

  <div class="grid2" style="margin-top:12px; gap:12px">
    <div class="card" style="padding:12px">
      <div class="small" style="opacity:.8; margin-bottom:8px"><b>Defektmeldung durch User</b></div>
      <label class="small" style="display:flex; align-items:center; gap:8px">
        <input id="authUserDefectEnabled" type="checkbox">
        User d√ºrfen Defekt melden
      </label>

      <div class="small" style="opacity:.8; margin-top:10px"><b>Erlaubte Maschinen</b></div>
      <div class="small" style="margin-top:6px">
        <div style="opacity:.75; margin-bottom:4px">Waschmaschinen</div>
        <div id="authAllowWasher" style="display:flex; gap:10px; flex-wrap:wrap"></div>
      </div>
      <div class="small" style="margin-top:8px">
        <div style="opacity:.75; margin-bottom:4px">Trockner</div>
        <div id="authAllowDryer" style="display:flex; gap:10px; flex-wrap:wrap"></div>
      </div>
    </div>

    <div class="card" style="padding:12px">
      <div class="small" style="opacity:.8; margin-bottom:8px"><b>News</b></div>
      <label class="small" style="display:flex; align-items:center; gap:8px">
        <input id="authNewsEnabled" type="checkbox">
        News aktiv
      </label>
      <div class="small" style="margin-top:8px; opacity:.75">Text (wird den Usern im Portal angezeigt)</div>
      <textarea id="authNewsText" rows="10" style="width:100%; margin-top:6px"></textarea>
    </div>
  </div>
</details>

  <details id="authMachinesDetails" style="display:none; margin-top:12px">
    <summary><b>Maschinen verwalten</b></summary>
    <div class="row" style="margin-top:10px">
      <button id="btnAuthMachinesLoad" class="btn secondary">Maschinen laden</button>
      <button id="btnAuthMachinesSave" class="btn">√Ñnderungen speichern</button>
    </div>
    <div id="authMachinesBox" class="small" style="margin-top:10px"></div>
  </details>

  

  <details id="authRoomControlDetails" class="auth-only" style="display:none; margin-top:12px">
  <summary><b>Zimmer sperren / Hinweis</b></summary>

  <div class="small" style="margin-top:8px; opacity:.85">
    Sperre/Hinweis gilt unabh√§ngig von der Zimmer-PIN. Du kannst Zimmer direkt anschreiben oder tempor√§r sperren.
  </div>

  <div class="row" style="margin-top:10px; flex-wrap:wrap; gap:10px">
    <button id="btnAuthRcList" class="btn secondary">√úbersicht laden</button>
    <input id="authRcSearch" placeholder="Suche Zimmer" style="flex:1; min-width:220px">
    <button id="btnAuthRcRefresh" class="btn secondary">Aktualisieren</button>
  </div>

  <div class="grid" style="margin-top:10px; grid-template-columns: 1fr 1fr; gap:12px">
    <div class="card">
      <div class="small" style="opacity:.8">Aktion</div>
      <div class="row" style="margin-top:10px; flex-wrap:wrap; gap:10px">
        <input id="authRcRoom" placeholder="Zimmer (z.B. 101)" style="flex:1; min-width:180px">
        <label class="small" style="display:flex;align-items:center;gap:8px">
          <input type="checkbox" id="authRcBlocked" />
          gesperrt
        </label>
      </div>
      <textarea id="authRcMsg" placeholder="Hinweis / Nachricht an das Zimmer (optional)" style="width:100%; min-height:90px; margin-top:10px"></textarea>
      <div class="row" style="margin-top:10px; justify-content:flex-end; gap:10px; flex-wrap:wrap">
        <button id="btnAuthRcSave" class="btn">Speichern</button>
        <button id="btnAuthRcClear" class="btn secondary">Freigeben & Nachricht l√∂schen</button>
      </div>
      <div class="small" id="authRcHint" style="margin-top:8px; opacity:.75"></div>
    </div>

    <div class="card">
      <div class="small" style="opacity:.8">Gesperrte / Nachrichten</div>
      <div id="authRcListBox" class="small" style="margin-top:10px; max-height:420px; overflow:auto"></div>
    </div>
  </div>
</details>

<details id="authFeedbackDetails" class="auth-only" style="display:none; margin-top:12px">
  <summary><b>Feedback / Nachrichten</b></summary>

  <div class="row" style="margin-top:10px; flex-wrap:wrap">
    <button id="btnAuthFbList" class="btn secondary">Threads laden</button>
    <input id="authFbSearch" placeholder="Suche Zimmer / Thread-ID" style="flex:1; min-width:220px">
    <button id="btnAuthFbRefresh" class="btn secondary">Aktualisieren</button>
  </div>

  <div class="grid" style="margin-top:10px; grid-template-columns: 1fr 2fr; gap:12px">
    <div class="card">
      <div class="small" style="opacity:.8">Threads</div>
      <div id="authFbThreadsBox" class="small" style="margin-top:8px; max-height:420px; overflow:auto"></div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap">
        <div>
          <div id="authFbActiveTitle"><b>Thread</b></div>
          <div id="authFbActiveMeta" class="small" style="opacity:.8"></div>
        </div>
        <div class="row" style="gap:8px">
          <label class="small" style="display:flex;align-items:center;gap:8px">
            <input type="checkbox" id="authFbVisibleToUser" checked />
            sichtbar f√ºr Zimmer
          </label>
        </div>
      </div>

      <div id="authFbMsgsBox" class="small" style="margin-top:10px; max-height:360px; overflow:auto; padding-right:6px"></div>

      <div style="margin-top:10px">
        <textarea id="authFbMsg" placeholder="Antwort schreiben‚Ä¶" style="width:100%; min-height:90px"></textarea>
        <div class="row" style="margin-top:8px; justify-content:space-between; align-items:center; flex-wrap:wrap">
          <div class="small" style="opacity:.75">Tipp: ‚ÄûZimmer anschreiben‚Äú geht hier ‚Äì Admins sehen es immer.</div>
          <button id="btnAuthFbSend" class="btn">Senden</button>
        </div>
      </div>
    </div>
  </div>
</details>
</div>
<!-- Auth-Dashboard Panels -->
  <details id="authUsersDetails" class="auth-only" style="display:none; margin-top:12px">
  <summary><b>Benutzer & Berechtigungen</b></summary>

  <div class="small" style="margin-top:8px; opacity:.85">
    RBAC: Rechte kommen ausschlie√ülich √ºber Haken (Permissions). <span class="small" style="opacity:.75">Hinweis: Haken erscheinen nach ‚ÄûNeu laden‚Äú (Snapshot).</span> Rolle ist nur ein Label + PS/VS Logik. √Ñnderungen sind nur f√ºr Admins m√∂glich.
  </div>

  <div class="grid" style="margin-top:12px; grid-template-columns: 360px 1fr; gap:12px">
    <div class="card">
      <div class="row" style="gap:10px; flex-wrap:wrap">
        <button id="btnRbacLoad" class="btn secondary">Neu laden</button>
        <input id="rbacUserSearch" placeholder="Suche Name/Email" style="flex:1; min-width:200px">
      </div>
      <div id="rbacUserList" class="small" style="margin-top:10px; max-height:520px; overflow:auto"></div>
    </div>

    <div class="card">
      <div class="row" style="align-items:flex-start; gap:12px; flex-wrap:wrap">
        <div style="flex:1; min-width:260px">
          <div class="small" style="opacity:.8">Ausgew√§hlter Benutzer</div>
          <div id="rbacSelHeader" style="margin-top:6px; font-weight:700">‚Äì</div>
          <div class="row" style="margin-top:10px; gap:10px; flex-wrap:wrap">
            <input id="rbacFirstName" placeholder="Vorname" style="flex:1; min-width:160px">
            <input id="rbacLastName" placeholder="Nachname" style="flex:1; min-width:160px">
          </div>
          <div class="row" style="margin-top:10px; gap:10px; flex-wrap:wrap">
            <select id="rbacStatus" style="min-width:200px">
              <option value="">Status (unver√§ndert)</option>
              <option value="pending">pending</option>
              <option value="active">active</option>
              <option value="disabled">disabled</option>
              <option value="pending_delete">pending_delete</option>
            </select>

            <label class="small" style="display:flex; align-items:center; gap:8px">
              <input type="checkbox" id="rbacIsAdmin2" />
              Admin-Zweitrolle (role2)
            </label>
          </div>

          <div class="row" style="margin-top:10px; gap:10px; flex-wrap:wrap">
            <button id="btnSetPS" class="btn secondary">Als PS setzen</button>
            <button id="btnSetVS" class="btn secondary">Als VS setzen</button>
            <button id="btnSaveUser" class="btn">Speichern</button>
          </div>

          <div id="rbacUserHint" class="small" style="margin-top:8px; opacity:.75"></div>
        </div>

        <div style="flex:2; min-width:320px">
          <div class="row" style="gap:10px; flex-wrap:wrap">
            <input id="rbacPermSearch" placeholder="Suche Berechtigung" style="flex:1; min-width:220px">
            <button id="btnPermAllOn" class="btn secondary">Alle an</button>
            <button id="btnPermAllOff" class="btn secondary">Alle aus</button>
          </div>
          <div id="rbacPermBox" class="small" style="margin-top:10px; max-height:520px; overflow:auto"></div>
        </div>
      </div>
    </div>
  </div>
</details><details id="authLogsDetails" class="auth-only" style="margin-top:12px; display:none" open>
    <summary>Logs</summary>
    <div class="card" style="margin-top:10px">
<div class="row" style="flex-wrap:wrap; gap:10px">
  <button id="btnAuthLogsReload" class="btn secondary">Neu laden</button>
  <input id="authLogsSearch" placeholder="Suche: Zimmer / Aktion / Actor / Maschine" style="flex:1; min-width:260px">
  <select id="authLogsAction" style="min-width:200px">
    <option value="">Alle Aktionen</option>
  </select>
  <button id="btnAuthLogsExport" class="btn">CSV Export</button>
</div>
<div class="row" style="margin-top:10px; flex-wrap:wrap; gap:10px; align-items:center">
  <label class="small" style="display:flex; gap:8px; align-items:center">
    <span>Zeitraum</span>
    <select id="authLogsRange">
      <option value="1">1 Tag</option>
      <option value="3">3 Tage</option>
      <option value="7" selected>7 Tage</option>
      <option value="14">14 Tage</option>
      <option value="30">30 Tage</option>
      <option value="90">90 Tage</option>
      <option value="365">365 Tage</option>
    </select>
  </label>
  <span class="small" id="authLogsCount" style="opacity:.8"></span>
</div>
<div id="authLogsBox" class="small" style="margin-top:10px"></div>
  </div>
  </details>

  <div class="row">
    <button class="btn" class="hide-on-auth" id="btnPsLogin">Anmelden</button>
    <button class="btn inline" class="hide-on-auth" id="btnPsLogout" style="display:none">Abmelden</button>
    <div id="psLoginState" class="muted"></div>
  </div>
  <div class="card" id="psOnly" style="display:none; margin-top:20px">
  <h3>Patientensprecher Bereich</h3>

  <div class="muted">
    ‚úÖ Login erkannt ‚Äì dieser Bereich erscheint nur f√ºr Patientensprecher / Stellvertreter.
  </div>

  <button class="btn" onclick="alert('PS Funktion aktiv')">
    Test-Button
  </button>
</div>
</div>
<script>
// API base (global)
var API_BASE = "https://washportal-dev-worker.schluffi1220.workers.dev";

// Auth storage keys (guarded against accidental double-includes)
var AUTH_KEY   = window.AUTH_KEY   || "wp_token";
var AUTH_ROLE  = window.AUTH_ROLE  || "wp_role";
var AUTH_EMAIL = window.AUTH_EMAIL || "wp_email";
var AUTH_EXP   = window.AUTH_EXP   || "wp_exp"; // expiresAt (ms)
window.AUTH_KEY = AUTH_KEY;
window.AUTH_ROLE = AUTH_ROLE;
window.AUTH_EMAIL = AUTH_EMAIL;
window.AUTH_EXP = AUTH_EXP;

function setAuth(t,r,e,exp){
  sessionStorage.setItem(AUTH_KEY, t || "");
  localStorage.setItem(AUTH_ROLE, r || "");
  localStorage.setItem(AUTH_EMAIL, e || "");
  localStorage.setItem(AUTH_EXP, String(exp || 0));
  document.body.setAttribute("data-authed", t ? "1" : "0");
}
  function clearAuth(){
  sessionStorage.removeItem(AUTH_KEY);
  localStorage.removeItem(AUTH_ROLE);
  localStorage.removeItem(AUTH_EMAIL);
  localStorage.removeItem(AUTH_EXP);
  document.body.setAttribute("data-authed","0");
}

function getAuth(){
  return {
    token: sessionStorage.getItem(AUTH_KEY) || "",
    role:  localStorage.getItem(AUTH_ROLE) || "",
    email: localStorage.getItem(AUTH_EMAIL) || "",
    exp:   Number(localStorage.getItem(AUTH_EXP) || 0)
  };
}
function roleLabel(r){
  if (r === "admin") return "Admin";
  if (r === "ps") return "Patientensprecher";
  if (r === "ps_deputy") return "Stellvertretender Patientensprecher";
  return r || "";
}

function renderAuth(){
  const a=getAuth();
  const st=document.getElementById("psLoginState");
  const out=document.getElementById("btnPsLogout");

  if(a.token){
    st.textContent="Angemeldet als "+roleLabel(a.role)+" ("+a.email+")";
    out.style.display="";
  }else{
    st.textContent="Nicht angemeldet";
    out.style.display="none";
  }

  try{ applyRoleVisibility(); }catch(e){}
  try{ updatePsDashUI(); }catch(e){}
}

// Backwards-compat alias (older patches referenced renderAuthState)
function renderAuthState(){
  return document.body.setAttribute("data-authed", getAuth().token ? "1" : "0");
  renderAuth();
}
window.renderAuthState = renderAuthState;

let __logoutTimer = null;

function scheduleAutoLogout(){
  if (__logoutTimer) clearTimeout(__logoutTimer);

  const a = getAuth();
  if (!a.token || !a.exp) return;

  const msLeft = a.exp - Date.now();

  __logoutTimer = setTimeout(()=>{
    clearAuth();
    renderAuth();
    alert("Session abgelaufen ‚Äì bitte neu anmelden");
  }, msLeft);
}
function roleLabel(r){
  if (r === "admin") return "Admin";
  if (r === "ps") return "Patientensprecher";
  if (r === "ps_deputy") return "Stellvertretender Patientensprecher";
  return r || "";
}

function applyRoleVisibility(){
  const a = getAuth();

  // Diese IDs kannst du sp√§ter f√ºr Bereiche nutzen, die nur PS/Admin sehen sollen
  const psOnly = document.getElementById("psOnly");
  const adminOnly = document.getElementById("adminOnly");

  const logged = !!a.token;
  const isAdmin = logged && a.role === "admin";
  const isPS = logged && (a.role === "ps" || a.role === "ps_deputy");

  if (psOnly) psOnly.style.display = "none"; // Bereich unten deaktiviert (Dashboard nutzt Kacheln)
  if (adminOnly) adminOnly.style.display = isAdmin ? "" : "none";
}

function updatePsDashUI(){
  const a = getAuth();
  const info = document.getElementById("psDashInfo");
  const logout2 = document.getElementById("btnPsLogout2");
  const reloadBtn = document.getElementById("btnPsDashReload");

  if (info){
    if (a.token && (a.role==="ps" || a.role==="ps_deputy")){
      info.textContent = "Angemeldet als " + roleLabel(a.role) + " (" + a.email + ")";
    } else {
      info.textContent = "‚Äî";
    }
  }

  // wire buttons once
  if (logout2 && !logout2._wired){
    logout2._wired = true;
    logout2.onclick = ()=>{
      const btn = document.getElementById("btnPsLogout");
      if (btn && typeof btn.onclick === "function") return btn.onclick();
      // fallback
      clearAuth();
      renderAuth();
      applyRoleVisibility();
      updatePsDashUI();
    };
  }
  if (reloadBtn && !reloadBtn._wired){
    reloadBtn._wired = true;
    reloadBtn.onclick = ()=>{
      // for now just refresh role visibility + info
      applyRoleVisibility();
      updatePsDashUI();
      toast("‚úÖ Aktualisiert");
    };
  }
}


document.addEventListener("DOMContentLoaded",()=>{
  applyRoleVisibility();
  scheduleAutoLogout();
  renderAuth();

  document.getElementById("btnPsLogin").onclick=async()=>{
    try{
      const email = psEmail.value.trim().toLowerCase();
      const password = psCode.value.trim();

      if(!email || !password){
        toast("‚õî E-Mail und Passwort erforderlich");
        return;
      }

      const r=await fetch(API_BASE+"/api/ps/login",{
        method:"POST",
        headers:{"content-type":"application/json"},
        body:JSON.stringify({email,password})
      });

      const j = await r.json();

      if (j.ok) {
        setAuth(j.token,j.role,email,j.expiresAt);
        renderAuth();
        applyRoleVisibility();
        scheduleAutoLogout();
        toast("‚úÖ Login erfolgreich");
      } else {
        const m = j.message || j.error || "Login fehlgeschlagen";
        toast("‚õî " + m);
      }
    }catch(e){
      console.error(e);
      toast("‚õî Login fehlgeschlagen");
    }
  };

  
  // Enter im Passwortfeld = Anmelden
  const psPwEl = document.getElementById("psCode");
  if (psPwEl){
    psPwEl.addEventListener("keydown", (e)=>{
      if (e.key === "Enter") document.getElementById("btnPsLogin").click();
    });
  }

document.getElementById("btnPsLogout").onclick=()=>{
    clearAuth();
    applyRoleVisibility(); 
    renderAuth();
  };

});
</script>

  </main>

  <div id="toast" class="toast"></div>

<script>
/*** SET THIS ***/
var API_BASE = "https://washportal-dev-worker.schluffi1220.workers.dev"; // <-- DEV Worker URL

// ---------- UI helpers ----------
const $ = (id)=>document.getElementById(id);
function toast(msg){
  const t = $("toast");
  t.textContent = msg;
  t.style.display = "block";
  clearTimeout(window.__t);
  window.__t = setTimeout(()=> t.style.display="none", 3200);
}
function fmtDT(ms){
  const dt = new Date(ms);
  return dt.toLocaleString("de-DE", { timeZone: "Europe/Berlin" });
}

function esc(v){
  return String(v ?? "")
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;")
    .replace(/'/g,"&#39;");
}

function fmtTime(ms){
  const dt = new Date(ms);
  return dt.toLocaleTimeString("de-DE", { timeZone: "Europe/Berlin", hour:"2-digit", minute:"2-digit" });
}
function fmtDate(ms){
  const dt = new Date(ms);
  return dt.toLocaleDateString("de-DE", { timeZone: "Europe/Berlin" });
}
function confirm2(step1, step2){
  if (!confirm(step1)) return false;
  alert(step2);
  return true;
}
async function jpost(path, body){
  const r = await fetch(API_BASE + path, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(body||{})
  });
  const data = await r.json().catch(()=> ({}));
  if (!r.ok) throw {status:r.status, data};
  return data;
}

async function jpostAuth(path, body){
  const a = (typeof getAuth === "function") ? getAuth() : null;
  const token = a && a.token ? a.token : "";
  const r = await fetch(API_BASE + path, {
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      ...(token ? {"Authorization":"Bearer "+token} : {})
    },
    body: JSON.stringify(body||{})
  });

  // read as text first (some workers return non-json on 404)
  const t = await r.text();
  let data = {};
  try{ data = t ? JSON.parse(t) : {}; }catch(_e){ data = { raw: t }; }

  if (!r.ok){
    // 404 usually means: backend worker not updated to the version this UI expects
    if (r.status === 404){
      throw { status:r.status, data:{...data, message:"endpoint_not_found", hint:"Backend/Worker ist nicht auf dem Stand der UI (fehlender Endpoint: "+path+"). Bitte Worker aktualisieren/deployen."} };
    }
    throw { status:r.status, data };
  }
  return data;
}

async function jget(path){
  const r = await fetch(API_BASE + path);
  const data = await r.json().catch(()=> ({}));
  if (!r.ok) throw {status:r.status, data};
  return data;
}
function getCreds(){
  return {
    room: $("room").value.trim(),
    pin: $("pin").value.trim(),
    stationPin: $("stationPin").value.trim()
  };
}
function getAdminSession(){
  try{
    const raw = sessionStorage.getItem("wp_admin");
    if (!raw) return null;
    const o = JSON.parse(raw);
    if (!o.pw || !o.exp) return null;
    if (Date.now() > o.exp) return null;
    return o;
  }catch{ return null; }
}
function setAdminSession(pw){
  sessionStorage.setItem("wp_admin", JSON.stringify({pw, exp: Date.now()+5*60*1000}));
}
function clearAdminSession(){
  sessionStorage.removeItem("wp_admin");
}

// ---------- state ----------
let STATE = {
  ok:false,
  build:"",
  now: Date.now(),
  config:null,
  machines:[],
  bookings:[],
  feedback:{hasThread:false,userUnread:false,allowUserView:true},
  news:{enabled:false,text:"",version:0,seen:true},
  window:{from:0,to:0}
};

// ---------- compute slots client-side ----------
function berlinMidnightMs(dayOffset){
  const now = new Date();
  // Berlin local date today:
  const parts = new Intl.DateTimeFormat("de-DE", { timeZone:"Europe/Berlin", year:"numeric", month:"2-digit", day:"2-digit" }).formatToParts(now);
  const y = Number(parts.find(p=>p.type==="year").value);
  const m = Number(parts.find(p=>p.type==="month").value);
  const d = Number(parts.find(p=>p.type==="day").value);
  const base = new Date(y, m-1, d, 0,0,0); // local browser is Berlin in your use-case
  base.setDate(base.getDate() + dayOffset);
  return base.getTime();
}

function buildWasherOptions(){
  const now = Date.now();
  const cfg = STATE.config || {};
  const machines = [1,2,3,4];
  const hours = (cfg.washerHours || []).slice();
  const durMs = 120*60*1000; // 2h fix

  // Nur gebuchte Washer-Buchungen
  const washerBookings = (STATE.bookings || []).filter(b => b.type==="washer" && b.status==="booked");

  // Buchungen nach Maschine
  const byM = {1:[],2:[],3:[],4:[]};
  for (const b of washerBookings){
    if (byM[b.machine]) byM[b.machine].push(b);
  }

  // Maschinenstatus Map
  const machineMap = {};
  for (const m of (STATE.machines || [])){
    if (m.type==="washer") machineMap[m.machine] = m;
  }

  const options = [];

  // WICHTIG: ab HEUTE (kein vergangener Tag mehr)
  for (let dayOff = 0; dayOff <= (cfg.daysFuture ?? 6); dayOff++){
    const day0 = berlinMidnightMs(dayOff);

    for (const h of hours){
      const start = day0 + h*60*60*1000;
      const end = start + durMs;

      for (const mac of machines){
        const ms = machineMap[mac];
        const disabledMachine = !ms || ms.enabled===0;
        const defect = !!(ms && ms.defect===1);

        // Vergangenheit: nicht buchbar, wenn Slot schon vorbei ist
        const isPast = end <= now;

        // Overlap mit bestehender Buchung?
        let booked = false;
        for (const b of (byM[mac]||[])){
          if (!(b.end <= start || b.start >= end)){
            booked = true;
            break;
          }
        }

        let label = `${fmtDate(start)} ${fmtTime(start)}‚Äì${fmtTime(end)} ‚Äì Waschmaschine ${mac}`;
        let disabled = false;

        if (disabledMachine){
          label += " (gesperrt)";
          disabled = true;
        } else if (defect){
          label += " (defekt)";
          disabled = true;
        } else if (isPast){
          label += " (vergangen)";
          disabled = true;
        } else if (booked){
          label += " (belegt)";
          disabled = true;
        }

        options.push({ type:"washer", machine:mac, start, end, label, disabled });
      }
    }
  }

  options.sort((a,b)=> a.start-b.start || a.machine-b.machine);
  return options;
}

function buildWasherOptionsForMachine(machine){
  const all = buildWasherOptions();
  return all.filter(o => Number(o.machine) === Number(machine));
}

function bookingForMachineRunning(type, machine){
  const now = Date.now();
  const bs = (STATE.bookings||[]).filter(b => b.type===type && b.machine===machine && b.status==="booked");
  return bs.find(b => b.start <= now && b.end > now) || null;
}

// ---------- render ----------
function renderNewsBox(){
  const wrap = $("newsBoxWrap");
  const n = STATE.news;
  if (!n.enabled || !n.text){
    wrap.style.display="none";
    wrap.innerHTML="";
    return;
  }
  wrap.style.display="block";

  const details = document.createElement("details");
  details.open = !n.seen; // open only when unseen
  const sum = document.createElement("summary");
  sum.textContent = "Was ist neu?";
  const txt = document.createElement("div");
  txt.className="small";
  txt.style.marginTop="8px";
  txt.style.whiteSpace="pre-wrap";
  txt.textContent = n.text;

  const btn = document.createElement("button");
  btn.className="btn secondary";
  btn.style.marginTop="10px";
  btn.textContent = "Gelesen";
  btn.onclick = async ()=>{
    try{
      const c = getCreds();
      await jpost("/api/news/seen", c);
      STATE.news.seen = true;
      details.open = false;
      toast("‚úÖ Als gelesen markiert");
    }catch(e){
      toast("‚õî Konnte nicht speichern");
    }
  };

  details.appendChild(sum);
  details.appendChild(txt);
  details.appendChild(btn);
  wrap.innerHTML="";
  wrap.appendChild(details);

  if (!n.seen){
    alert("üì¢ Neue Info:\n\n" + n.text);
  }
}

function renderSlotDropdown(){
  const sel = $("slotSelect");
  sel.innerHTML = "";
  const opts = buildWasherOptions();
  if (opts.length===0){
    sel.appendChild(new Option("Keine Slots verf√ºgbar", ""));
    return;
  }

  sel.appendChild(new Option("Bitte ausw√§hlen‚Ä¶", ""));
  for (const o of opts){
    const opt = new Option(o.label, JSON.stringify({machine:o.machine,start:o.start,end:o.end}));
    opt.disabled = !!o.disabled;
    if (o.disabled) opt.className = "disabledOpt";
    sel.appendChild(opt);
  }

  const freeCount = opts.filter(o=>!o.disabled).length;
  $("slotHint").textContent = `Freie Wasch-Slots: ${freeCount} (grau = belegt/defekt/gesperrt/vergangen)`;
}

function tileStatus(type, machine){
  const m = STATE.machines.find(x=>x.type===type && x.machine===machine);
  if (!m) return {cls:"bad", tag:"FEHLT", text:"Nicht vorhanden"};
  if (m.enabled===0) return {cls:"bad", tag:"GESPERRT", text:"Maschine gesperrt"};
  if (m.defect===1) return {cls:"bad", tag:"DEFEKT", text:`Defekt gemeldet von ${m.defectBy || "?"}`};
  const running = bookingForMachineRunning(type, machine);
  if (running) return {cls:"busy", tag:"L√ÑUFT", text:`Zimmer ${running.room} bis ${fmtTime(running.end)}`};
    // last user info (when free)
  const last = (m.lastRoom && String(m.lastRoom).trim() !== "")
    ? ` ‚Ä¢ zuletzt: Zimmer ${m.lastRoom}`
    : "";
  return {cls:"free", tag:"FREI", text:"Frei" + last};
}

function renderTiles(){
  const box = $("tiles");
  box.innerHTML = "";
    // Guard: wenn STATE (noch) nicht da ist, nicht alles leer lassen
  if (!STATE || !Array.isArray(STATE.machines) || !Array.isArray(STATE.bookings)) {
    box.innerHTML = `<div class="small">Keine Daten geladen. Bitte auf ‚ÄûAktualisieren‚Äú dr√ºcken.</div>`;
    return;
  }

  const types = [
    {type:"washer", title:"Waschmaschine", machines:[1,2,3,4]},
    {type:"dryer",  title:"Trockner",      machines:[1,2,3,4]},
  ];

  for (const group of types){
    for (const m of group.machines){
      const st = tileStatus(group.type, m);
      const tile = document.createElement("div");
      tile.className = "tile " + st.cls;

      const top = document.createElement("div");
      top.className = "tileTop";
      const title = document.createElement("div");
      title.innerHTML = `<div class="title">${group.title} ${m}</div><div class="meta">${st.text}</div>`;
      const tag = document.createElement("div");
      tag.className = "tag";
      tag.textContent = st.tag;
      top.appendChild(title);
      top.appendChild(tag);

      const btns = document.createElement("div");
      btns.className = "tileBtns";

      // Buttons depending on state
      const creds = getCreds();
      const running = bookingForMachineRunning(group.type, m);

      if (group.type === "washer") {
        // Freigeben nur wenn l√§uft + geh√∂rt mir
        if (running && creds.room && running.room === creds.room) {
          const b = document.createElement("button");
          b.textContent = "Freigeben";
          b.onclick = async ()=>{
            try{
              await jpost("/api/booking/release", {room:creds.room, pin:creds.pin, id: running.id});
              toast("‚úÖ Freigegeben");
              await refreshAll();
            }catch(e){
              toast("‚õî Freigeben fehlgeschlagen");
            }
          };
          btns.appendChild(b);
        }

        // Quick-Booking UI (Dropdown + Buchen) unter den Buttons
        const bookRow = document.createElement("div");
        bookRow.className = "row";
        bookRow.style.gap = "8px";
        bookRow.style.marginTop = "8px";
        bookRow.style.width = "100%";

        const sel = document.createElement("select");
        sel.style.flex = "1";

        if (!creds.room || !creds.pin || !creds.stationPin) {
          sel.appendChild(new Option("Bitte erst Zugang eingeben", ""));
          sel.disabled = true;
        } else {
          sel.appendChild(new Option("Bitte Slot w√§hlen‚Ä¶", ""));
          const opts = buildWasherOptionsForMachine(m);
          for (const o of opts){
            const opt = new Option(o.label, `${o.start}|${o.end}|${o.machine}`);
            opt.disabled = !!o.disabled;
            sel.appendChild(opt);
          }
        }

        const bBook = document.createElement("button");
        bBook.textContent = "Buchen";
        bBook.className = "bookBtn";
        bBook.disabled = (!creds.room || !creds.pin || !creds.stationPin);

        bBook.onclick = async ()=>{
          try{
            if (!sel.value) { toast("‚õî Bitte Slot w√§hlen"); return; }
            const [startS, endS, machineS] = String(sel.value).split("|");
            const start = Number(startS);
            const end = Number(endS);
            const machine = Number(machineS);
            if (!Number.isFinite(start) || !Number.isFinite(end) || !machine){
              toast("‚õî Ung√ºltiger Slot");
              return;
            }

            await jpost("/api/washer/book", {
              room: creds.room,
              pin: creds.pin,
              stationPin: creds.stationPin,
              machine,
              start,
              end
            });

            toast("‚úÖ Gebucht");
            await refreshAll();
          }catch(e){
            toast("‚õî Buchen fehlgeschlagen");
          }
        };

        bookRow.appendChild(sel);
        bookRow.appendChild(bBook);
        btns.appendChild(bookRow);

      } else {
        // dryer
        if (!running) {
          const b = document.createElement("button");
          b.textContent = "Jetzt buchen";
          b.onclick = async ()=>{
            try{
              await jpost("/api/dryer/book", {room:creds.room, pin:creds.pin, stationPin:creds.stationPin, machine:m});
              toast("‚úÖ Trockner gebucht");
              await refreshAll();
            }catch(e){
              toast("‚õî Buchen fehlgeschlagen");
            }
          };
          btns.appendChild(b);
        } else {
          if (creds.room && running.room === creds.room) {
            const b = document.createElement("button");
            b.textContent = "Fertig (Freigeben)";
            b.onclick = async ()=>{
              try{
                await jpost("/api/booking/release", {room:creds.room, pin:creds.pin, id: running.id});
                toast("‚úÖ Freigegeben");
                await refreshAll();
              }catch(e){
                toast("‚õî Freigeben fehlgeschlagen");
              }
            };
            btns.appendChild(b);
          } else {
            const b = document.createElement("button");
            b.textContent = "√úberbuchen";
            b.onclick = async ()=>{
              const ok = confirm("√úberbuchen nur wenn best√§tigt:\n\nDie W√§sche vom Vorg√§nger ist sauber und vorsichtig im Korb oben/nebendran abgelegt.");
              if (!ok) return;
              try{
                await jpost("/api/dryer/book", {room:creds.room, pin:creds.pin, stationPin:creds.stationPin, machine:m, force:true, confirmed:true});
                toast("‚úÖ √úberbucht & gebucht");
                await refreshAll();
              }catch(e){
                toast("‚õî √úberbuchen fehlgeschlagen");
              }
            };
            btns.appendChild(b);
          }
        }
      }

// Defekt melden / freigeben (user rule)
      const cfg = STATE.config || {};
      const allowDef = cfg.userDefectEnabled && cfg.userDefectAllowed && cfg.userDefectAllowed[group.type] && cfg.userDefectAllowed[group.type][String(m)];
      if (allowDef) {
        const mm = STATE.machines.find(x=>x.type===group.type && x.machine===m);
        const isDef = mm && mm.defect===1;
        const b = document.createElement("button");
        b.textContent = isDef ? "Defekt freigeben" : "Defekt melden";
        b.onclick = async ()=>{
          try{
            await jpost("/api/defect/report", {room:creds.room, pin:creds.pin, stationPin:creds.stationPin, type:group.type, machine:m, defect: !isDef});
            toast("‚úÖ Gespeichert");
            await refreshAll();
          }catch(e){
            toast("‚õî Nicht m√∂glich");
          }
        };
        btns.appendChild(b);
      }

      tile.appendChild(top);
      tile.appendChild(btns);
      box.appendChild(tile);
    }
  }
}

function myBookingState(b){
  const m = STATE.machines.find(x=>x.type===b.type && x.machine===b.machine);
  if (m && (m.enabled===0 || m.defect===1)) return "bad";
  const now = Date.now();
  if (b.status === "released") return "free";
  if (b.status === "cancelled") return "bad";
  if (b.start <= now && b.end > now) return "busy";
  return "pastel"; // upcoming booked
}

function renderMyBookings(){
  const box = $("myBookings");
  const c = getCreds();
  const room = c.room;
  if (!room){
    box.innerHTML = `<div class="small">Bitte erst Zugang eingeben und Aktualisieren.</div>`;
    return;
  }

  const list = (STATE.myBookings || []);
  if (list.length===0){
    box.innerHTML = `<div class="small">Keine Buchungen.</div>`;
    return;
  }

  const now = Date.now();
  const html = [];
  for (const b of list.sort((a,b)=>a.start-b.start)){
    const state = myBookingState(b);
    const cls = state==="bad" ? "bad" : state==="busy" ? "busy" : state==="free" ? "free" : "";
    const title = `${b.type==="washer" ? "Waschmaschine" : "Trockner"} ${b.machine}`;
    const line = `${fmtDate(b.start)} ${fmtTime(b.start)}‚Äì${fmtTime(b.end)}`;
    let statusTxt = b.status;
    if (b.status==="booked") statusTxt = (b.start<=now && b.end>now) ? "l√§uft" : "gebucht";
    if (b.status==="released") statusTxt = "freigegeben";
    if (b.status==="cancelled") statusTxt = "storniert";

    html.push(`
      <div class="tile ${cls}" style="margin-bottom:10px">
        <div class="tileTop">
          <div>
            <div class="title">${title}</div>
            <div class="meta mono">${line}</div>
            <div class="meta">${statusTxt}</div>
          </div>
          <div class="tag">${statusTxt}</div>
        </div>
        <div class="tileBtns">
          ${renderMyBookingButtons(b, now)}
        </div>
      </div>
    `);
  }
  box.innerHTML = html.join("");

  // attach button handlers
  for (const b of list){
    const btnCancel = document.querySelector(`[data-cancel="${b.id}"]`);
    if (btnCancel){
      btnCancel.onclick = async ()=>{
        try{
          await jpost("/api/booking/cancel", {room:c.room, pin:c.pin, id:b.id});
          toast("‚úÖ Storniert");
          await refreshAll();
        }catch(e){
          toast("‚õî Storno nicht m√∂glich");
        }
      };
    }
    const btnRel = document.querySelector(`[data-release="${b.id}"]`);
    if (btnRel){
      btnRel.onclick = async ()=>{
        try{
          await jpost("/api/booking/release", {room:c.room, pin:c.pin, id:b.id});
          toast("‚úÖ Freigegeben");
          await refreshAll();
        }catch(e){
          toast("‚õî Freigeben nicht m√∂glich");
        }
      };
    }
  }
}

function renderMyBookingButtons(b, now){
  // stornieren: only if booked & not started & not dryer
  const canCancel = b.status==="booked" && now < b.start && b.type==="washer";
  const canRelease = b.status==="booked" && b.start <= now && b.end > now;

  let out = "";
  if (canCancel) out += `<button data-cancel="${b.id}">Stornieren</button>`;
  if (canRelease) out += `<button data-release="${b.id}">Freigeben</button>`;
  if (!out) out = `<span class="small">Keine Aktion m√∂glich.</span>`;
  return out;
}

// ---------- Feedback ----------
async function loadFeedback(showPopup=false){
  const c = getCreds();
  try{
    const r = await jpost("/api/feedback/load", c);
    const box = $("feedbackList");
    if (!r.hasThread){
      box.innerHTML = `<div class="small">Noch kein Feedback vorhanden.</div>`;
      return;
    }
    if (!r.allowUserView){
      box.innerHTML = `<div class="small">Admin hat den Thread aktuell nicht f√ºr User freigegeben.</div>`;
      return;
    }
    const msgs = r.messages || [];
    box.innerHTML = msgs.map(m=>{
      const who = m.sender==="admin" ? "Admin" : "Du";
      return `<div class="tile ${m.sender==="admin" ? "busy" : "free"}" style="margin-bottom:10px">
        <div class="title">${who}</div>
        <div class="meta mono">${fmtDT(m.ts)}</div>
        <div style="margin-top:6px;white-space:pre-wrap">${escapeHtml(m.message)}</div>
      </div>`;
    }).join("");

    if (showPopup){
      alert("üí¨ Neue Nachricht im Feedback vorhanden.");
    }
  }catch(e){
    toast("‚õî Feedback laden fehlgeschlagen");
  }
}

function escapeHtml(s){
  return String(s||"").replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
}

// ---------- Admin UI ----------
async function adminLogin(){
  const pw = $("adminPw").value.trim();
  if (!pw) return toast("Admin Passwort fehlt");
  try{
    await jpost("/api/admin/login", {adminPassword: pw});
    setAdminSession(pw);
    $("adminLoginBox").style.display = "none";
    $("adminBox").style.display = "block";
    toast("‚úÖ Admin Login OK");
    await adminReload();
  }catch(e){
    toast("‚õî Admin Login forbidden");
  }
}
async function adminReload(){
  const s = getAdminSession();
  if (!s){ toast("Admin Session abgelaufen"); return; }
  try{
    const r = await jpost("/api/auth/admin/config/get", {adminPassword: s.pw});
    renderAdminConfig(r.config, r.newsSeenCount||0);
    await adminLoadMachines();
    await adminLoadFeedbackThreads();
  }catch(e){
    toast("‚õî Admin Daten laden fehlgeschlagen");
  }
}
function renderAdminConfig(cfg, newsSeenCount){
  // washer hours
  const box = $("washerHoursBox");
  box.innerHTML = "";
  const selected = new Set((cfg.washerHours||[]).map(String));
  for (let h=0; h<=23; h++){
    const id = `wh_${h}`;
    const div = document.createElement("div");
    div.style.display="inline-block";
    div.style.margin="4px 8px 4px 0";
    div.innerHTML = `<label style="display:inline-flex;gap:8px;align-items:center">
      <input type="checkbox" id="${id}" ${selected.has(String(h)) ? "checked":""} />
      <span class="mono">${String(h).padStart(2,"0")}:00</span>
    </label>`;
    box.appendChild(div);
  }

  // dryer minutes
  $("dryerMinutes").value = String(cfg.dryerMinutes || 120);

  // days window
  $("daysPast").value = String(cfg.daysPast ?? 1);
  $("daysFuture").value = String(cfg.daysFuture ?? 6);

  // news
  $("newsEnabled").checked = !!cfg.newsEnabled;
  $("newsText").value = cfg.newsText || "";
  $("bumpNewsVersion").checked = false;
  $("newsSeenCount").textContent = cfg.newsEnabled
    ? `Gelesen-Z√§hler (aktuelle Version ${cfg.newsVersion||0}): ${newsSeenCount}`
    : `News ist aktuell deaktiviert.`;
  // defect
  $("userDefectEnabled").checked = !!cfg.userDefectEnabled;

  // defect allowed matrix
  const da = cfg.userDefectAllowed || {washer:{},dryer:{}};
  const target = $("defectAllowedBox");
  target.innerHTML = "";
  target.appendChild(document.createElement("div")).innerHTML = `<div class="small">Pro Maschine aktivieren:</div>`;
  for (const t of ["washer","dryer"]){
    const title = document.createElement("div");
    title.style.marginTop="8px";
    title.innerHTML = `<div class="title">${t==="washer"?"Waschmaschinen":"Trockner"}</div>`;
    target.appendChild(title);
    for (let i=1;i<=4;i++){
      const id = `da_${t}_${i}`;
      const on = !!(da[t] && da[t][String(i)]);
      const row = document.createElement("div");
      row.style.display="inline-block";
      row.style.margin="4px 8px 4px 0";
      row.innerHTML = `<label style="display:inline-flex;gap:8px;align-items:center">
        <input type="checkbox" id="${id}" ${on?"checked":""} />
        <span>${t==="washer"?"WM":"TR"} ${i}</span>
      </label>`;
      target.appendChild(row);
    }
  }
}

async function adminLoadMachines(){
  // use current STATE from last refresh for display if possible; else refresh via user refresh is not admin
  // For simplicity: use STATE.machines (must have been loaded at least once)
  const m = STATE.machines || [];
  const box = $("adminMachines");
  box.innerHTML = "";

  const groups = [
    {type:"washer", label:"Waschmaschinen"},
    {type:"dryer", label:"Trockner"},
  ];

  for (const g of groups){
    const title = document.createElement("div");
    title.innerHTML = `<div class="title">${g.label}</div>`;
    title.style.margin="8px 0";
    box.appendChild(title);

    for (let i=1;i<=4;i++){
      const mm = m.find(x=>x.type===g.type && x.machine===i) || {enabled:1, defect:0};
      const idEn = `m_${g.type}_${i}_en`;
      const idDe = `m_${g.type}_${i}_de`;

      const row = document.createElement("div");
      row.style.border="1px solid var(--line)";
      row.style.borderRadius="14px";
      row.style.padding="10px";
      row.style.marginBottom="8px";
      row.innerHTML = `
        <div style="display:flex;justify-content:space-between;gap:10px;align-items:center">
          <div><b>${g.type==="washer"?"WM":"TR"} ${i}</b></div>
          <div class="small">letztes Zimmer: ${mm.lastRoom || "-"}</div>
        </div>
        <div style="margin-top:8px;display:flex;gap:12px;flex-wrap:wrap">
          <label style="display:inline-flex;gap:8px;align-items:center">
            <input type="checkbox" id="${idEn}" ${mm.enabled? "checked":""}/>
            <span>aktiv (nicht gesperrt)</span>
          </label>
          <label style="display:inline-flex;gap:8px;align-items:center">
            <input type="checkbox" id="${idDe}" ${mm.defect? "checked":""}/>
            <span>defekt</span>
          </label>
        </div>
      `;
      box.appendChild(row);
    }
  }
}


// -----------------------------
// Admin: Logs + Bookings helpers
// -----------------------------
function fmtBerlin(ts){
  const dt = new Date(Number(ts||0));
  if (!Number.isFinite(dt.getTime())) return "";
  const parts = new Intl.DateTimeFormat("de-DE", {
    timeZone:"Europe/Berlin",
    year:"numeric", month:"2-digit", day:"2-digit",
    hour:"2-digit", minute:"2-digit"
  }).formatToParts(d);
  const get = (t)=> (parts.find(p=>p.type===t)?.value || "");
  return `${get("day")}.${get("month")}.${get("year")} ${get("hour")}:${get("minute")}`;
}

let __ADMIN_LOGS_CACHE = [];
let __ADMIN_BOOKINGS_CACHE = [];


// =====================
// Auth (PS/VS/Admin) Login + Dashboard (Bearer)
// =====================

// ---- Auth: Permissions + Dashboard ----
function canRoomControl(me){
  const role = String(me?.user?.role || me?.role || "");
  const perms = me?.perms || {};
  return !!(perms["admin.roomcontrol.manage"] || perms["ps.rooms.manage"] || ["admin","ps","ps_deputy","superadmin","super_admin","super_admin"].includes(role));
}

async function authMe(){
  const a = getAuth();
  if(!a || !a.token) return null;
  try{
    const r = await fetch(API_BASE + "/api/auth/me", {
      headers: { "Authorization": "Bearer " + a.token }
    });
    const j = await r.json().catch(()=>({}));
    if(!r.ok || !j.ok) return null;
    return j; // {ok:true, user:{...}, perms:{...}}
  }catch(_e){
    return null;
  }
}
function hasPerm(perms, key){
  return !!(perms && perms[key]);
}

async function renderPsVsAdminDash(){
  const a = getAuth();
  const tiles = document.getElementById("psDashTiles");
  const info  = document.getElementById("psDashInfo");
  if(!tiles || !info) return;

  if(!a || !a.token){
    info.textContent = "Nicht angemeldet";
    tiles.innerHTML = "";
    return;
  }

  const me = await authMe();
  const perms = me?.perms || {};
  const role = me?.user?.role || a.role || "";
  const email = me?.user?.email || a.email || "";

  info.textContent = `Angemeldet als ${roleLabel(role)} (${email})`;

  const items = [];

  // Benutzer / Rollen & Rechte
  if (hasPerm(perms,"admin.users.manage") || role === "admin"){
    items.push(`
      <div class="tile free" role="button" tabindex="0" data-act="users">
        üë•<br><b>Benutzer</b><br>
        <span class="small">Rollen & Rechte</span>
      </div>
    `);
  }

  // Logs
  if (hasPerm(perms,"admin.logs.view") || role === "admin"){
    items.push(`
      <div class="tile busy" role="button" tabindex="0" data-act="logs">
        üìã<br><b>Logs</b><br>
        <span class="small">Systemverlauf</span>
      </div>
    `);
  }

  // Buchungen
  if (hasPerm(perms,"admin.bookings.view") || role === "admin" || role === "ps" || role === "ps_deputy"){
    items.push(`
      <div class="tile free" role="button" tabindex="0" data-act="bookings">
        üìÖ<br><b>Buchungen</b><br>
        <span class="small">√úbersicht</span>
      </div>
    `);
  }

  // Konfiguration / News
  if (hasPerm(perms,"admin.config.manage") || hasPerm(perms,"admin.news.edit") || role==="admin"){
    items.push(`
      <div class="tile bad" role="button" tabindex="0" data-act="config">
        ‚öôÔ∏è<br><b>Konfiguration</b><br>
        <span class="small">News ¬∑ Regeln</span>
      </div>
    `);
  }

  // Maschinen
  if (hasPerm(perms,"admin.machines.manage") || hasPerm(perms,"ps.rooms.manage") || role==="admin"){
    items.push(`
      <div class="tile free" role="button" tabindex="0" data-act="machines">
        üß∫<br><b>Maschinen</b><br>
        <span class="small">aktiv/defekt</span>
      </div>
    `);
  }

  // Zimmer sperren
  if (hasPerm(perms,"admin.roomcontrol.manage") || hasPerm(perms,"ps.rooms.manage") || role==="admin"){
    items.push(`
      <div class="tile busy" role="button" tabindex="0" data-act="roomctrl">
        üö´<br><b>Zimmer</b><br>
        <span class="small">Sperren/Hinweis</span>
      </div>
    `);
  }

  // Feedback
  if (hasPerm(perms,"admin.feedback.view") || role==="admin"){
    items.push(`
      <div class="tile free" role="button" tabindex="0" data-act="feedback">
        üí¨<br><b>Feedback</b><br>
        <span class="small">Threads</span>
      </div>
    `);
  }
tiles.innerHTML = items.join("") || `<div class="small">Keine Funktionen freigeschaltet.</div>`;

  const wire = (sel, fn)=>{
    const el = tiles.querySelector(sel);
    if(!el) return;
    el.onclick = fn;
    el.onkeydown = (e)=>{ if(e.key==="Enter" || e.key===" ") fn(); };
  };

  wire('[data-act="users"]', ()=>{ location.href = "./admin-users/"; });
  wire('[data-act="logs"]', ()=>{ authLoadLogs(); });
  wire('[data-act="bookings"]', ()=>{ authLoadBookings(); });
  wire('[data-act="config"]', ()=>{ const d=$('authConfigDetails'); if(d){d.style.display=''; d.open=true; d.scrollIntoView({behavior:'smooth',block:'start'});} });
  wire('[data-act="machines"]', ()=>{ const d=$('authMachinesDetails'); if(d){d.style.display=''; d.open=true; d.scrollIntoView({behavior:'smooth',block:'start'});} });
  wire('[data-act="roomctrl"]', ()=>{ const d=$('authRoomControlDetails'); if(d){d.style.display=''; d.open=true; d.scrollIntoView({behavior:'smooth',block:'start'});} });
  wire('[data-act="feedback"]', ()=>{ const d=$('authFeedbackDetails'); if(d){d.style.display=''; d.open=true; d.scrollIntoView({behavior:'smooth',block:'start'});} });
}




// (auth storage helpers moved to first <script> block)

async function authLoadLogs(){
  const a=getAuth();
  if(!a.token) return toast("‚õî Bitte erst anmelden");
  const det=$("authLogsDetails"); if(det){det.style.display=""; det.open=true;}
  const box=$("authLogsBox"); if(box) box.innerHTML=`<div class="small">Lade Logs‚Ä¶</div>`;
  try{
    const r = await jpostAuth("/api/auth/logs", { limit: 300 });
    __ADMIN_LOGS_CACHE = (r.logs||[]).slice().sort((x,y)=>(y.ts||0)-(x.ts||0));
    renderAuthLogs();
    if(det) det.scrollIntoView({behavior:"smooth", block:"start"});
    toast("‚úÖ Logs geladen");
  }catch(e){
    const msg = e?.data?.message || e?.data?.error || "Fehler";
    if (box) box.innerHTML = `<div class="small">‚õî Logs laden fehlgeschlagen (${esc(msg)})</div>`;
  }
}

// ---- Auth: Bookings ----
function renderAuthBookings(){
  const box = $("authBookingsBox");
  if (!box) return;
  const list = (__ADMIN_BOOKINGS_CACHE||[]);
  if (!list.length){
    box.innerHTML = `<div class="small">Keine Buchungen.</div>`;
    return;
  }
  const now=Date.now();
  box.innerHTML = list.map(b=>{
    const title = `${b.type==="washer"?"Waschmaschine":"Trockner"} ${b.machine}`;
    const when = `${fmtBerlin(b.start)}‚Äì${fmtBerlin(b.end)}`;
    let st=b.status;
    if (st==="booked") st=(b.start<=now && b.end>now) ? "l√§uft" : "gebucht";
    if (st==="released") st="freigegeben";
    if (st==="cancelled") st="storniert";
    if (st==="admin_cancelled") st="ADMIN storniert";

    const canCancel = (b.status==="booked");
    const btn = canCancel ? `<button class="btn secondary inline" data-auth-cancel="${esc(b.id)}">Storno</button>` : `<span class="small" style="opacity:.7">‚Äî</span>`;

    return `<div style="padding:10px 0;border-bottom:1px solid rgba(255,255,255,.08);display:flex;justify-content:space-between;gap:10px;align-items:center">
      <div>
        <div><b>${esc(title)}</b> ¬∑ Zimmer ${esc(b.room||"")}</div>
        <div class="small">${esc(when)} ¬∑ <span class="pill">${esc(st)}</span></div>
      </div>
      ${btn}
    </div>`;
  }).join("");

  box.querySelectorAll("button[data-auth-cancel]").forEach(btn=>{
    btn.onclick = async ()=>{
      const id = btn.getAttribute("data-auth-cancel");
      if (!id) return;
      if (!confirm("Buchung wirklich stornieren?")) return;
      try{
        // primary endpoint
        await jpostAuth("/api/auth/bookings/cancel", { id });
        toast("‚úÖ Storniert");
        await authLoadBookings();
      }catch(e1){
        // fallback: older path
        try{
          await jpostAuth("/api/auth/bookings/cancel", { bookingId: id });
          toast("‚úÖ Storniert");
          await authLoadBookings();
        }catch(e2){
          const msg = (e2?.data?.message || e2?.data?.error || e1?.data?.message || e1?.data?.error || "Fehler");
          toast("‚õî Storno fehlgeschlagen: "+msg);
        }
      }
    };
  });
}

async function authLoadBookings(){
  const a=getAuth();
  if(!a.token) return toast("‚õî Bitte erst anmelden");
  const det=$("authBookingsDetails"); if(det){det.style.display=""; det.open=true;}
  const box=$("authBookingsBox"); if(box) box.innerHTML=`<div class="small">Lade Buchungen‚Ä¶</div>`;
  try{
    let r;
    try{
      r = await jpostAuth("/api/auth/bookings", { limit: 800 });
    }catch(e0){
      // fallback to older path
      r = await jpostAuth("/api/auth/bookings/list", { limit: 800 });
    }
    __ADMIN_BOOKINGS_CACHE = (r.bookings||[]).slice().sort((x,y)=>(y.start||0)-(x.start||0));
    renderAuthBookings();
    if(det) det.scrollIntoView({behavior:"smooth", block:"start"});
    toast("‚úÖ Buchungen geladen");
  }catch(e){
    const msg = e?.data?.message || e?.data?.error || "Fehler";
    if (box) box.innerHTML = `<div class="small">‚õî Buchungen laden fehlgeschlagen (${esc(msg)})</div>`;
  }
}

function scrollToAdminConfig(){
  const a=getAuth();
  if (!a.token) return toast("‚õî Bitte erst anmelden");
  // Admin-Konfiguration bleibt im Super-Admin Bereich (Admin-Passwort), bewusst getrennt.
  const el = $("cardAccess") || document.body;
  el.scrollIntoView({behavior:"smooth", block:"start"});
  toast("‚ÑπÔ∏è Admin-Konfiguration ist Super-Admin (Admin-Passwort) ‚Äì nicht im PS/VS/Admin-Login.");
}

function authLogout(){  document.body.setAttribute("data-authed","0");

  clearAuth();
  if (window.renderAuthState) window.renderAuthState();
  try{ renderPsVsAdminDash(); }catch(_e){}
}

// Wire auth controls
(function(){
// ---- Auth UI state (ensures available before wiring) ----
function renderAuthState(){
  try{
    if (typeof renderAuth === "function") return renderAuth();
  }catch(_e){}
  try{
    const a = (typeof getAuth === "function") ? getAuth() : {token:"",role:"",email:""};
    const st = document.getElementById("psLoginState");
    if (st){
      st.textContent = a && a.token ? "Angemeldet" : "Nicht angemeldet";
    }
  }catch(_e){}
}

function wireAuthUI(){
  const loginBtn = $("btnPsLogin");
  const emailEl = $("psEmail");
  const passEl = $("psCode");
  const logoutBtn = $("btnPsLogout");
  const reloadBtn = $("btnPsDashReload");

  const doLogin = async ()=>{
    try{
      const email = (emailEl?.value || "").trim().toLowerCase();
      const password = (passEl?.value || "").trim();
      if (!email || !password) return toast("‚õî E-Mail und Passwort erforderlich");

      const r = await fetch(API_BASE+"/api/ps/login", {
        method:"POST",
        headers:{"content-type":"application/json"},
        body: JSON.stringify({ email, password })
      });
      const j = await r.json().catch(()=>({}));
      if (!r.ok || !j.ok){
        return toast("‚õî " + (j.message || j.error || ("Login fehlgeschlagen (HTTP "+r.status+")")));
      }
      setAuth(j.token, j.role, email, j.expiresAt);
      if (window.renderAuthState) window.renderAuthState();
      scheduleAutoLogout();
      toast("‚úÖ Login erfolgreich");
    
      try{ await renderPsVsAdminDash(); }catch(_e){}
}catch(e){
      console.error(e);
      toast("‚õî Login fehlgeschlagen");
    }
  };

  if (loginBtn) loginBtn.onclick = doLogin;
  if (emailEl) emailEl.addEventListener("keydown", (e)=>{ if(e.key==="Enter") doLogin(); });
  if (passEl) passEl.addEventListener("keydown", (e)=>{ if(e.key==="Enter") doLogin(); });

  if (logoutBtn) logoutBtn.onclick = ()=>{ authLogout(); toast("‚úÖ Abgemeldet"); };

  if (reloadBtn) reloadBtn.onclick = ()=>{
    if (window.renderAuthState) window.renderAuthState();
    toast("‚úÖ Aktualisiert");
  };
  // Auth Admin-Tools (per Permissions)
  const btnCfgLoad = $("btnAuthConfigLoad");
  const btnCfgSave = $("btnAuthConfigSave");
  const btnMachLoad = $("btnAuthMachinesLoad");
  const btnMachSave = $("btnAuthMachinesSave");
  const btnRcSave = $("btnAuthRcSave");
  const btnRcList = $("btnAuthRcList");
  const btnFbList = $("btnAuthFbList");

  if (btnCfgLoad) btnCfgLoad.onclick = ()=>authLoadConfig();
  if (btnCfgSave) btnCfgSave.onclick = ()=>authSaveConfig();
  if (btnMachLoad) btnMachLoad.onclick = ()=>authLoadMachines();
  if (btnMachSave) btnMachSave.onclick = ()=>authSaveMachines();
  if (btnRcSave) btnRcSave.onclick = ()=>authSaveRoomControl();
  if (btnRcList) btnRcList.onclick = ()=>authLoadRoomControls();
  if (btnFbList) btnFbList.onclick = ()=>authLoadFeedbackThreads();


  // initial
  if (window.renderAuthState) window.renderAuthState();
  scheduleAutoLogout();
}

document.addEventListener("DOMContentLoaded", wireAuthUI);
})();


function downloadCSV(filename, rows){
  if (!rows || !rows.length){ toast("‚õî Keine Daten"); return; }
  const keys = Object.keys(rows[0]);
  const escCsv = (v)=> {
    const s = String(v ?? "");
    if (/[;"\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
    return s;
  };
  const csv = [
    keys.join(";"),
    ...rows.map(r => keys.map(k=>escCsv(r[k])).join(";"))
  ].join("\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function credsComplete(){
  const c = getCreds();
  return !!(c.room && c.pin && c.stationPin);
}

function renderAdminLogs(){
  const box = $("authLogsBox");
  if (!box) return;
  const q = ($("adminLogsFilter")?.value || "").trim().toLowerCase();

  const list = __ADMIN_LOGS_CACHE.filter(l=>{
    if (!q) return true;
    const hay = `${l.ts} ${l.actor} ${l.action} ${l.room} ${l.type} ${l.machine} ${l.meta}`.toLowerCase();
    return hay.includes(q);
  });

  if (!list.length){
    box.innerHTML = `<div class="small">Keine Logs (Filter?).</div>`;
    return;
  }

  box.innerHTML = list.map(l=>{
    let metaTxt = "";
    try{
      const meta = l.meta ? JSON.parse(l.meta) : null;
      if (meta && Number.isFinite(Number(meta.start)) && Number.isFinite(Number(meta.end))){
        metaTxt = `<div class="small" style="opacity:.85">Slot: ${esc(fmtBerlin(meta.start))} ‚Äì ${esc(fmtBerlin(meta.end))}</div>`;
      }
    }catch(_){}

    return `<div class="row" style="justify-content:space-between;gap:10px;align-items:flex-start;margin:6px 0">
      <div>
        <div><b>${esc(l.actor||"")}</b> ¬∑ ${esc(l.action||"")}</div>
        <div class="small">Zimmer ${esc(l.room||"")} ¬∑ ${esc(l.type||"")} ${Number(l.machine||0)||""}</div>
        ${metaTxt}
      </div>
      <div class="mono small" style="white-space:nowrap">${esc(fmtBerlin(l.ts))}</div>
    </div>`;
  }).join("");
}

function renderAdminBookings(){
  const box = $("authBookingsBox");
  if (!box) return;
  const q = ($("adminBookingsFilter")?.value || "").trim().toLowerCase();

  const list = __ADMIN_BOOKINGS_CACHE.filter(b=>{
    if (!q) return true;
    const hay = `${b.type} ${b.machine} ${b.room} ${b.id} ${b.status}`.toLowerCase();
    return hay.includes(q);
  });

  if (!list.length){
    box.innerHTML = `<div class="small">Keine Buchungen (Filter?).</div>`;
    return;
  }

  const now = Date.now();
  box.innerHTML = list.map(b=>{
    const title = `${b.type==="washer"?"Waschmaschine":"Trockner"} ${b.machine}`;
    const when = `${fmtBerlin(b.start)}‚Äì${fmtBerlin(b.end)}`;
    let st = b.status;
    if (st==="booked") st = (b.start<=now && b.end>now) ? "l√§uft" : "gebucht";
    if (st==="released") st="freigegeben";
    if (st==="cancelled") st="storniert";
    if (st==="admin_cancelled") st="ADMIN gel√∂scht";

    const canCancel = (b.status==="booked");
    const btn = canCancel
      ? `<button class="btn" data-bid="${esc(b.id)}">Storno (Admin)</button>`
      : `<span class="small" style="opacity:.7">‚Äî</span>`;

    return `<div class="row" style="justify-content:space-between;gap:10px;align-items:center;margin:6px 0">
      <div>
        <div><b>${esc(title)}</b> ¬∑ Zimmer ${esc(b.room||"")}</div>
        <div class="small">${esc(when)} ¬∑ <span class="pill">${esc(st)}</span></div>
      </div>
      ${btn}
    </div>`;
  }).join("");

  // wire buttons
  box.querySelectorAll("button[data-bid]").forEach(btn=>{
    btn.onclick = async ()=>{
      const id = btn.getAttribute("data-bid");
      if (!id) return;
      if (!confirm("Admin-Storno wirklich ausf√ºhren?")) return;
      try{
        const s = getAdminSession();
        await jpost("/api/admin/bookings/cancel", { adminPassword: s.pw, id });
        toast("‚úÖ Admin-Storno ausgef√ºhrt");
        await adminLoadBookings();
        if (credsComplete()) await refreshAll(); // nur wenn User-Zugang gesetzt ist
      }catch(e){
        const msg = e?.data?.message || e?.data?.error || "Fehler";
        toast("‚õî Admin-Storno: " + msg);
      }
    };
  });
}


function scrollToAdminConfig(){
  const el = document.getElementById("adminBox") || document.getElementById("cardAccess");
  if (el && typeof el.scrollIntoView === "function") el.scrollIntoView({behavior:"smooth", block:"start"});
  toast("‚ÑπÔ∏è Admin-Bereich: bitte oben im Admin-Block mit Admin-Passwort einloggen, um Einstellungen zu √§ndern.");
}

async function authLoadLogs(){
  const det = $("authLogsDetails"); if (det) det.style.display="";
  const a = getAuth();
  if (!a.token) return toast("‚õî Bitte erst anmelden");
  const box = document.getElementById("adminLogsBox");
  if (box) box.innerHTML = `<div class="small">Lade Logs‚Ä¶</div>`;
  try{
    const r = await jpostAuth("/api/auth/logs", { limit: 300 });
    __ADMIN_LOGS_CACHE = (r.logs||[]).slice().sort((x,y)=>(y.ts||0)-(x.ts||0));
    renderAdminLogs();
    const d = $("authLogsDetails"); if(d){d.open=true; d.style.display=""; d.scrollIntoView({behavior:"smooth", block:"start"});}
    const detLogs = document.getElementById("adminLogsDetails"); if (detLogs) detLogs.open = true;
    toast("‚úÖ Logs geladen");
  }catch(e){
    const msg = e?.data?.message || e?.data?.error || "Fehler";
    toast("‚õî Logs laden fehlgeschlagen: "+msg);
  }
}

async function authLoadBookings(){
  const det = $("authBookingsDetails"); if (det) det.style.display="";
  const a = getAuth();
  if (!a.token) return toast("‚õî Bitte erst anmelden");
  const box = document.getElementById("adminBookingsBox");
  if (box) box.innerHTML = `<div class="small">Lade Buchungen‚Ä¶</div>`;
  try{
    const r = await jpostAuth("/api/auth/bookings/list", { limit: 800 });
    __ADMIN_BOOKINGS_CACHE = (r.bookings||[]).slice().sort((x,y)=>(y.start||0)-(x.start||0));
    renderAdminBookings();
    const d = $("authBookingsDetails"); if(d){d.open=true; d.style.display=""; d.scrollIntoView({behavior:"smooth", block:"start"});}
    const detBookings = document.getElementById("adminBookingsDetails"); if (detBookings) detBookings.open = true;
    toast("‚úÖ Buchungen geladen");
  }catch(e){
    const msg = e?.data?.message || e?.data?.error || "Fehler";
    toast("‚õî Buchungen laden fehlgeschlagen: "+msg);
  }
}


// PS/VS/Admin (Bearer): Logs/Buchungen direkt laden (ohne Admin-Passwort)
async function authLoadLogs(){
  const box = $("authLogsBox");
  if (box) box.innerHTML = `<div class="small">Lade Logs‚Ä¶</div>`;
  try{
    const r = await jpostAuth("/api/auth/logs", { limit: 300 });
    __ADMIN_LOGS_CACHE = (r.logs||[]).slice().sort((a,b)=>(b.ts||0)-(a.ts||0));
    renderAdminLogs();
    const d = $("authLogsDetails"); if(d){d.open=true; d.style.display=""; d.scrollIntoView({behavior:"smooth", block:"start"});}
    const detLogs1 = $("adminLogsDetails"); if (detLogs1) detLogs1.open = false;
    toast("‚úÖ Logs geladen");
  }catch(e){
    const msg = e?.data?.message || e?.data?.error || "Fehler";
    toast("‚õî Logs: " + msg);
  }
}
async function authLoadBookings(){
  const box = $("authBookingsBox");
  if (box) box.innerHTML = `<div class="small">Lade Buchungen‚Ä¶</div>`;
  try{
    const r = await jpostAuth("/api/auth/bookings/list", { limit: 800 });
    __ADMIN_BOOKINGS_CACHE = (r.bookings||[]).slice().sort((a,b)=>(b.start||0)-(a.start||0));
    renderAdminBookings();
    const d = $("authBookingsDetails"); if(d){d.open=true; d.style.display=""; d.scrollIntoView({behavior:"smooth", block:"start"});}
    const detBookings1 = $("adminBookingsDetails"); if (detBookings1) detBookings1.open = false;
    toast("‚úÖ Buchungen geladen");
  }catch(e){
    const msg = e?.data?.message || e?.data?.error || "Fehler";
    toast("‚õî Buchungen: " + msg);
  }
}
async function adminLoadLogs(){
  const s = getAdminSession();
  if (!s?.pw){ toast("‚õî Bitte erst Admin-Login"); return; }
  const box = $("authLogsBox");
  if (box) box.innerHTML = `<div class="small">Lade Logs‚Ä¶</div>`;
  try{
    const r = await jpost("/api/admin/logs", { adminPassword: s.pw, limit: 300 });
    __ADMIN_LOGS_CACHE = (r.logs||[]).slice().sort((a,b)=>(b.ts||0)-(a.ts||0));
    renderAdminLogs();
    const d = $("authLogsDetails"); if(d){d.open=true; d.style.display=""; d.scrollIntoView({behavior:"smooth", block:"start"});}
    const detLogsX = $("adminLogsDetails"); if (detLogsX) detLogsX.open = false;
  }catch(e){
    const msg = e?.data?.message || e?.data?.error || "Fehler";
    if (box) box.innerHTML = `<div class="small">‚õî Logs laden fehlgeschlagen (${esc(msg)})</div>`;
  }
}

async function adminLoadBookings(){
  const s = getAdminSession();
  if (!s?.pw){ toast("‚õî Bitte erst Admin-Login"); return; }
  const box = $("authBookingsBox");
  if (box) box.innerHTML = `<div class="small">Lade Buchungen‚Ä¶</div>`;
  try{
    const r = await jpost("/api/admin/bookings/list", { adminPassword: s.pw });
    __ADMIN_BOOKINGS_CACHE = (r.bookings||[]).slice().sort((a,b)=>(b.start||0)-(a.start||0));
    renderAdminBookings();
    const d = $("authBookingsDetails"); if(d){d.open=true; d.style.display=""; d.scrollIntoView({behavior:"smooth", block:"start"});}
    const detBookingsX = $("adminBookingsDetails"); if (detBookingsX) detBookingsX.open = false;
  }catch(e){
    const msg = e?.data?.message || e?.data?.error || "Fehler";
    if (box) box.innerHTML = `<div class="small">‚õî Buchungen laden fehlgeschlagen (${esc(msg)})</div>`;
  }
}

async function adminLoadFeedbackThreads(){
  const s = getAdminSession(); if (!s) return;
  const box = $("adminFeedbackThreads");
  box.innerHTML = `<div class="small mono">Lade‚Ä¶</div>`;
  try{
    const r = await jpost("/api/admin/feedback/list", {adminPassword: s.pw});
    const threads = r.threads || [];
    if (threads.length===0){
      box.innerHTML = `<div class="small">Keine Feedbacks.</div>`;
      return;
    }
    box.innerHTML = threads.map(t=>{
      const unread = t.adminUnread ? " (NEU)" : "";
      return `<div class="tile ${t.adminUnread? "busy":"free"}" data-search="${t.room} ${t.id}" style="margin-bottom:10px">
        <div class="tileTop">
          <div>
            <div class="title">Zimmer ${t.room}${unread}</div>
            <div class="meta mono">updated: ${fmtDT(t.updatedAt)}</div>
            <div class="meta">User-Sichtbar: ${t.allowUserView ? "ja":"nein"}</div>
          </div>
          <label class="small" style="display:flex;align-items:center;gap:6px;margin-right:8px"><input type="checkbox" class="threadChk" data-thread-id="${t.id}">ausw√§hlen</label><button class="btn inline secondary" data-open-thread="${t.id}">√ñffnen</button>
        </div>
      </div>`;
    }).join("");

    document.querySelectorAll("[data-open-thread]").forEach(btn=>{
      btn.onclick = ()=> adminOpenThread(btn.getAttribute("data-open-thread"));
    });

  }catch(e){
    box.innerHTML = `<div class="small">Fehler beim Laden.</div>`;
  }
}



// Admin: thread filter + bulk delete + CSV
(function initAdminThreadTools(){
  const filter = $("adminThreadFilter");
  if (filter){
    filter.oninput = ()=>{
      const q = filter.value.trim().toLowerCase();
      document.querySelectorAll("#adminFeedbackThreads .tile").forEach(tile=>{
        const txt = tile.getAttribute("data-search") || tile.textContent || "";
        tile.style.display = txt.toLowerCase().includes(q) ? "" : "none";
      });
    };
  }

  const delSel = $("btnAdminDeleteSelectedThreads");
  if (delSel){
    delSel.onclick = async ()=>{
      const s = getAdminSession();
      if (!s?.pw) return toast("‚õî Bitte erst Admin-Login");
      const ids = Array.from(document.querySelectorAll(".threadChk:checked")).map(x=>x.getAttribute("data-thread-id"));
      if (!ids.length) return toast("‚õî Keine Threads gew√§hlt");
      if (!confirm(`Wirklich ${ids.length} Thread(s) l√∂schen?`)) return;
      try{
        for (const id of ids){
          await jpost("/api/admin/feedback/delete", { adminPassword: s.pw, threadId: id });
        }
        toast("‚úÖ Threads gel√∂scht");
        await adminLoadFeedbackThreads();
      }catch(e){
        const status = e?.status ? `HTTP ${e.status}` : "";
        const msg = e?.data?.error || e?.data?.message || "";
        toast(`‚õî L√∂schen fehlgeschlagen ${status} ${msg}`.trim());
      }
    };
  }

  const csvBtn = $("btnAdminExportThreadsCSV");
  if (csvBtn){
    csvBtn.onclick = ()=>{
      // read tiles into csv
      const rows = [];
      document.querySelectorAll("#adminFeedbackThreads [data-thread-id]").forEach(chk=>{
        const id = chk.getAttribute("data-thread-id");
        const tile = chk.closest(".tile");
        const room = (tile?.querySelector(".title")?.textContent || "").replace("Zimmer","").trim();
        const updated = tile?.querySelector(".meta.mono")?.textContent?.replace("updated:","").trim() || "";
        const allow = tile?.textContent?.includes("User-Sichtbar: ja") ? "ja" : "nein";
        const unread = tile?.textContent?.includes("(NEU)") ? "ja" : "nein";
        rows.push({id, room, updated, allowUserView:allow, adminUnread:unread});
      });
      if (!rows.length) return toast("‚õî Keine Threads zum Export");
      const keys = Object.keys(rows[0]);
      const csv = [keys.join(";"), ...rows.map(r=>keys.map(k=>String(r[k]??"")).join(";"))].join("\n");
      const blob = new Blob([csv],{type:"text/csv"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "threads.csv";
      a.click();
      URL.revokeObjectURL(url);
      toast("‚úÖ CSV exportiert");
    };
  }
})();
async function adminOpenThread(threadId){
  const s = getAdminSession(); if (!s) return;
  const view = $("adminFeedbackThreadView");
  view.innerHTML = `<div class="small mono">Lade Thread‚Ä¶</div>`;
  try{
    const r = await jpost("/api/admin/feedback/thread", {adminPassword:s.pw, threadId});
    const t = r.thread;
    const msgs = r.messages || [];

    const allowId = "allowUserViewToggle";
    view.innerHTML = `
      <div class="tile busy">
        <div class="title">Thread Zimmer ${t.room}</div>
        <div class="meta mono">created: ${fmtDT(t.createdAt)} ¬∑ updated: ${fmtDT(t.updatedAt)}</div>
        <div style="margin-top:8px">
          <label style="display:inline-flex;gap:8px;align-items:center">
            <input type="checkbox" id="${allowId}" ${t.allowUserView? "checked":""}/>
            <span>User darf Antworten sehen</span>
          </label>
        </div>
      </div>
      <div style="margin-top:10px">
        ${msgs.map(m=>`
          <div class="tile ${m.sender==="admin" ? "busy":"free"}" style="margin-bottom:10px">
            <div class="tileTop">
              <div>
                <div class="title">${m.sender==="admin" ? "Admin" : "User"}</div>
                <div class="meta mono">${fmtDT(m.ts)}</div>
              </div>
              <div class="tag">sichtbar: ${m.visibleToUser? "ja":"nein"}</div>
            </div>
            <div style="margin-top:6px;white-space:pre-wrap">${escapeHtml(m.message)}</div>
          </div>
        `).join("")}
      </div>

      <label>Antwort</label>
      <textarea id="adminReplyText" placeholder="Antwort an User‚Ä¶"></textarea>

      <label style="display:inline-flex;gap:8px;align-items:center;margin-top:8px">
        <input type="checkbox" id="adminVisibleToUser" checked />
        <span>Antwort f√ºr User sichtbar</span>
      </label>

      <button class="btn" id="btnAdminSendReply">Antwort senden</button>
              <button class="btn danger" id="btnAdminDeleteThread">Thread l√∂schen</button>
    `;

    const sendBtn = $("btnAdminSendReply");
    if (sendBtn) sendBtn.onclick = async ()=>{
      const msg = $("adminReplyText").value.trim();
      if (!msg) return toast("Antwort fehlt");
      const visible = $("adminVisibleToUser").checked;
      const allowUserView = $(allowId).checked;

      try{
        await jpost("/api/admin/feedback/send", {adminPassword:s.pw, threadId, message:msg, visibleToUser:visible, allowUserView});
        toast("‚úÖ Antwort gesendet");
        await adminOpenThread(threadId);
        await adminLoadFeedbackThreads();
      }catch(e){
        toast("‚õî Senden fehlgeschlagen");
      }
    };

  // Thread l√∂schen (Admin)
  const delBtn = $("btnAdminDeleteThread");
  if (delBtn){
    delBtn.onclick = async ()=>{
      if (!confirm("Thread wirklich l√∂schen?")) return;
      try{
        await jpost("/api/admin/feedback/delete", { adminPassword: s.pw, threadId });
        toast("‚úÖ Thread gel√∂scht");
        $("adminMsgs").innerHTML = "";
        $("adminReplyText").value = "";
        await adminLoadFeedbackThreads();
      }catch(e){
        const status = e?.status ? `HTTP ${e.status}` : "";
        const msg = e?.data?.error || e?.data?.message || "";
        toast(`‚õî Thread l√∂schen fehlgeschlagen ${status} ${msg}`.trim());
      }
    };
  }

  }catch(e){
    view.innerHTML = `<div class="small">Fehler beim Thread laden.</div>`;
  }
}

// ---------- main refresh ----------
async function refreshAll(){
  const c = getCreds();
  if (!c.room || !c.pin || !c.stationPin){
    toast("Bitte Zugang vollst√§ndig eingeben");
    return;
  }
  $("btnRefresh").disabled = true;
  $("btnRefresh").textContent = "Lade‚Ä¶";

  try{
    const r = await jpost("/api/user/refresh", c);
    STATE = r;

    renderNewsBox();
    renderSlotDropdown();
    renderTiles();
    renderMyBookings();

    // feedback popup if new
    if (r.feedback && r.feedback.userUnread) {
      alert("üí¨ Neues Feedback vom Admin vorhanden.");
    }

    toast("‚úÖ Bereit");
  }catch(e){
    const msg = e?.data?.message || e?.data?.error || "Fehler";
    toast("‚õî " + msg);
  }finally{
    $("btnRefresh").disabled = false;
    $("btnRefresh").textContent = "Aktualisieren";
  }
}

// ---------- events ----------
$("btnRefresh").onclick = refreshAll;

// Enter triggers
$("pin").addEventListener("keydown", (e)=>{ if (e.key==="Enter") refreshAll(); });
$("stationPin").addEventListener("keydown", (e)=>{ if (e.key==="Enter") refreshAll(); });

// Book washer from dropdown
$("btnBookWasher").onclick = async ()=>{
  const c = getCreds();
  const v = $("slotSelect").value;
  if (!c.room || !c.pin || !c.stationPin) return toast("Bitte Zugang eingeben");
  if (!v) return toast("Bitte Slot ausw√§hlen");

  const slot = JSON.parse(v);
  try{
    const r = await jpost("/api/washer/book", {
      room: c.room, pin: c.pin, stationPin: c.stationPin,
      machine: slot.machine,
      start: slot.start,
      end: slot.end
    });
    alert("‚úÖ Gebucht!");
    await refreshAll();
  }catch(e){
    const msg = e?.data?.message || e?.data?.error || "Fehler";
    alert("‚õî " + msg);
  }
};

// Feedback
$("btnLoadFeedback").onclick = ()=> loadFeedback(false);
$("btnSendFeedback").onclick = async ()=>{
  const c = getCreds();
  const msg = $("feedbackText").value.trim();
  if (!c.room || !c.pin || !c.stationPin) return toast("Bitte Zugang eingeben");
  if (!msg) return toast("Nachricht fehlt");
  try{
    await jpost("/api/feedback/send", { ...c, message: msg });
    $("feedbackText").value = "";
    toast("‚úÖ Gesendet");
    await loadFeedback(false);
    await refreshAll();
  }catch(e){
    toast("‚õî Feedback senden fehlgeschlagen");
  }
};

// Admin
$("btnAdminLogin").onclick = adminLogin;
$("adminPw").addEventListener("keydown", (e)=>{ if (e.key==="Enter") adminLogin(); });

$("btnAdminLogout").onclick = ()=>{
  clearAdminSession();
  $("adminBox").style.display = "none";
  $("adminLoginBox").style.display = "block";
  toast("‚úÖ Logout");
};

$("btnAdminReload").onclick = adminReload;

$("btnAdminLoadLogs").onclick = adminLoadLogs;
$("btnAdminLoadBookings").onclick = adminLoadBookings;

// Admin: Filter + CSV
if ($("adminLogsFilter")) $("adminLogsFilter").addEventListener("input", renderAdminLogs);
if ($("adminBookingsFilter")) $("adminBookingsFilter").addEventListener("input", renderAdminBookings);

if ($("btnAdminExportLogsCSV")) $("btnAdminExportLogsCSV").onclick = ()=>{
  const rows = (__ADMIN_LOGS_CACHE||[]).map(l=>({
    Zeit: fmtBerlin(l.ts),
    Actor: l.actor||"",
    Action: l.action||"",
    Room: l.room||"",
    Type: l.type||"",
    Machine: l.machine||"",
    Meta: l.meta||""
  }));
  downloadCSV("logs.csv", rows);
};

if ($("btnAdminExportBookingsCSV")) $("btnAdminExportBookingsCSV").onclick = ()=>{
  const rows = (__ADMIN_BOOKINGS_CACHE||[]).map(b=>({
    Type: b.type||"",
    Machine: b.machine||"",
    Room: b.room||"",
    Start: fmtBerlin(b.start),
    End: fmtBerlin(b.end),
    Status: b.status||"",
    Id: b.id||""
  }));
  downloadCSV("bookings.csv", rows);
};

$("btnSetStationPin").onclick = async ()=>{
  const s = getAdminSession(); if (!s) return toast("Admin Session abgelaufen");
  const sp = $("adminStationPin").value.trim();
  try{
    const ok = confirm2("Stations-PIN speichern?", "Wird gespeichert‚Ä¶");
    if (!ok) return;
    await jpost("/api/admin/set-station-pin", {adminPassword:s.pw, stationPin: sp});
    toast("‚úÖ Stations-PIN gespeichert");
  }catch(e){
    toast("‚õî Fehler beim Speichern");
  }
};

$("btnChangeAdminPw").onclick = async ()=>{
  const s = getAdminSession(); if (!s) return toast("Admin Session abgelaufen");
  const npw = $("adminNewPw").value.trim();
  const npw2 = $("adminNewPw2").value.trim();
  if (!npw) return toast("Neues Passwort fehlt");
  if (npw !== npw2) return toast("‚õî Passw√∂rter stimmen nicht √ºberein");
  try{
    const ok = confirm2("Admin-Passwort √§ndern?", "Wird ge√§ndert‚Ä¶");
    if (!ok) return;
    await jpost("/api/admin/change-password", {adminPassword:s.pw, newPassword: npw});
    toast("‚úÖ Admin Passwort ge√§ndert");
    // keep session but update stored pw to new
    setAdminSession(npw);
  }catch(e){
    toast("‚õî Fehler beim √Ñndern");
  }
};

$("btnSaveWasherHours").onclick = async ()=>{
  const s = getAdminSession(); if (!s) return toast("Admin Session abgelaufen");
  try{
    const ok = confirm2("Waschzeiten speichern?", "Gespeichert.");
    if (!ok) return;

    const hours = [];
    for (let h=0; h<=23; h++){
      const cb = document.getElementById(`wh_${h}`);
      if (cb && cb.checked) hours.push(h);
    }
    await jpost("/api/auth/admin/config/set", {adminPassword:s.pw, washerHours: hours});
    toast("‚úÖ Waschzeiten gespeichert");
    await adminReload();
    await refreshAll();
  }catch(e){
    toast("‚õî Fehler beim Speichern");
  }
};

$("btnSaveDryerMinutes").onclick = async ()=>{
  const s = getAdminSession(); if (!s) return toast("Admin Session abgelaufen");
  try{
    const ok = confirm2("Trockner-Dauer speichern?", "Gespeichert.");
    if (!ok) return;
    await jpost("/api/auth/admin/config/set", {adminPassword:s.pw, dryerMinutes: Number($("dryerMinutes").value)});
    toast("‚úÖ Trockner-Dauer gespeichert");
    await adminReload();
    await refreshAll();
  }catch(e){
    toast("‚õî Fehler beim Speichern");
  }
};

$("btnSaveDaysWindow").onclick = async ()=>{
  const s = getAdminSession(); if (!s) return toast("Admin Session abgelaufen");
  try{
    const ok = confirm2("Tage-Fenster speichern?", "Gespeichert.");
    if (!ok) return;
    await jpost("/api/auth/admin/config/set", {
      adminPassword:s.pw,
      daysPast: Number($("daysPast").value),
      daysFuture: Number($("daysFuture").value),
    });
    toast("‚úÖ Tage-Fenster gespeichert");
    await adminReload();
    await refreshAll();
  }catch(e){
    toast("‚õî Fehler beim Speichern");
  }
};

$("btnSaveNews").onclick = async ()=>{
  const s = getAdminSession(); if (!s) return toast("Admin Session abgelaufen");
  try{
    const ok = confirm2("News speichern?", "Gespeichert.");
    if (!ok) return;
    await jpost("/api/auth/admin/config/set", {
      adminPassword:s.pw,
      newsEnabled: $("newsEnabled").checked,
      newsText: $("newsText").value,
      bumpNewsVersion: $("bumpNewsVersion").checked
    });
    toast("‚úÖ News gespeichert");
    await adminReload();
    await refreshAll();
  }catch(e){
    toast("‚õî Fehler beim Speichern");
  }
};

$("btnSaveMachines").onclick = async ()=>{
  const s = getAdminSession(); if (!s) return toast("Admin Session abgelaufen");
  try{
    const ok = confirm2("Maschinen speichern?", "Gespeichert.");
    if (!ok) return;

    const updates = [];
    for (const type of ["washer","dryer"]){
      for (let i=1;i<=4;i++){
        const en = document.getElementById(`m_${type}_${i}_en`)?.checked ? 1 : 0;
        const de = document.getElementById(`m_${type}_${i}_de`)?.checked ? 1 : 0;
        updates.push({type, machine:i, enabled: en, defect: de});
      }
    }
    await jpost("/api/admin/machines/set", {adminPassword:s.pw, updates});
    toast("‚úÖ Maschinen gespeichert");
    await refreshAll();
    await adminReload();
  }catch(e){
    toast("‚õî Fehler beim Speichern");
  }
};

$("btnSaveDefectRules").onclick = async ()=>{
  const s = getAdminSession(); if (!s) return toast("Admin Session abgelaufen");
  try{
    const ok = confirm2("Defekt-Regeln speichern?", "Gespeichert.");
    if (!ok) return;

    const allowed = { washer:{}, dryer:{} };
    for (const t of ["washer","dryer"]){
      for (let i=1;i<=4;i++){
        const id = `da_${t}_${i}`;
        allowed[t][String(i)] = !!document.getElementById(id)?.checked;
      }
    }

    await jpost("/api/auth/admin/config/set", {
      adminPassword: s.pw,
      userDefectEnabled: $("userDefectEnabled").checked,
      userDefectAllowed: allowed
    });
    toast("‚úÖ Defekt-Regeln gespeichert");
    await adminReload();
    await refreshAll();
  }catch(e){
    toast("‚õî Fehler beim Speichern");
  }
};

if ($("btnLoadLogs")) {
  $("btnLoadLogs").onclick = async ()=>{
    const s = getAdminSession(); if (!s) return toast("Admin Session abgelaufen");
    const box = $("logsBox");
    box.innerHTML = `<div class="small mono">Lade‚Ä¶</div>`;
    try{
      const r = await jpost("/api/admin/logs", {adminPassword:s.pw, limit:200});
      const logs = r.logs || [];
      box.innerHTML = logs.map(l=>{
        const meta = l.meta ? escapeHtml(l.meta) : "{}";
        return `<div class="tile" style="margin-bottom:10px;background:var(--pastelGray)">
          <div class="title">${escapeHtml(l.action)}</div>
          <div class="meta mono">${fmtDT(l.ts)} ¬∑ ${escapeHtml(l.actor)} ¬∑ ${escapeHtml(l.room)}</div>
          <div class="small mono" style="margin-top:6px;white-space:pre-wrap">${meta}</div>
        </div>`;
      }).join("");
    }catch(e){
      box.innerHTML = `<div class="small">Fehler.</div>`;
    }
  };
}

// Boot: if admin session exists, show admin box
(async function boot(){
  try{
    const s = await jget("/api/_status?ts="+Date.now());
    console.log("status", s);
  }catch(e){
    toast("‚ö†Ô∏è Worker nicht erreichbar ‚Äì API_BASE pr√ºfen");
  }

  const sess = getAdminSession();
  if (sess){
    $("adminLoginBox").style.display="none";
    $("adminBox").style.display="block";
    await adminReload();

    // Realtime Logs: alle 8s neu laden, solange Admin eingeloggt ist
    if (!window.__logPoll){
      window.__logPoll = setInterval(async ()=>{
        try{
          const sess2 = getAdminSession();
          if (!sess2) return;
          // nur wenn Admin-Bereich sichtbar
          const ab = $("adminBox");
          if (ab && ab.style.display !== "none"){
            await adminLoadLogs();
          }
        }catch(e){}
      }, 8000);
    }

  }
})();
// =====================
// Auth Admin Tools (Bearer + Permissions)
// =====================

let __AUTH_CONFIG_CACHE = null;
function ensureAuthConfigOptions(){
  // washer hour checkboxes (0..23) created once
  const wrap = $("authWasherHoursWrap");
  if (wrap && !wrap.__built){
    wrap.__built = true;
    let html = "";
    for (let h=0; h<24; h++){
      const hh = String(h).padStart(2,"0")+":00";
      html += `<label class="small" style="display:flex; gap:6px; align-items:center; padding:4px 6px; border:1px solid var(--line); border-radius:10px">
        <input type="checkbox" data-hour="${h}">
        <span class="mono">${hh}</span>
      </label>`;
    }
    wrap.innerHTML = html;
  }

  const mkAllow = (id)=>{
    const el = $(id);
    if (el && !el.__built){
      el.__built = true;
      el.innerHTML = [1,2,3,4].map(n=>`
        <label class="small" style="display:flex; gap:6px; align-items:center">
          <input type="checkbox" data-n="${n}"> #${n}
        </label>
      `).join("");
    }
  };
  mkAllow("authAllowWasher");
  mkAllow("authAllowDryer");
}

function renderAuthConfigForm(cfg){
  ensureAuthConfigOptions();
  // numbers
  const daysPast = $("authDaysPast"); if (daysPast) daysPast.value = Number(cfg.daysPast ?? 1);
  const daysFuture = $("authDaysFuture"); if (daysFuture) daysFuture.value = Number(cfg.daysFuture ?? 6);

  // dryer
  const dryer = $("authDryerMinutes"); if (dryer) dryer.value = String(Number(cfg.dryerMinutes ?? 90));

  // washer hours
  const wrap = $("authWasherHoursWrap");
  const set = new Set((cfg.washerHours || []).map(Number));
  if (wrap){
    wrap.querySelectorAll('input[type="checkbox"][data-hour]').forEach(cb=>{
      const h = Number(cb.getAttribute("data-hour"));
      cb.checked = set.has(h);
    });
  }

  // defect
  const ude = $("authUserDefectEnabled"); if (ude) ude.checked = !!cfg.userDefectEnabled;

  const allowed = cfg.userDefectAllowed || { washer:{}, dryer:{} };
  const setAllow = (containerId, obj)=>{
    const el = $(containerId);
    if (!el) return;
    el.querySelectorAll('input[type="checkbox"][data-n]').forEach(cb=>{
      const n = String(cb.getAttribute("data-n"));
      cb.checked = !!(obj && obj[n]);
    });
  };
  setAllow("authAllowWasher", allowed.washer || {});
  setAllow("authAllowDryer", allowed.dryer || {});

  // news
  const ne = $("authNewsEnabled"); if (ne) ne.checked = !!cfg.newsEnabled;
  const nt = $("authNewsText"); if (nt) nt.value = String(cfg.newsText || "");
  const bump = $("authBumpNewsVersion"); if (bump) bump.checked = false;
}

function collectAuthConfigFromForm(){
  ensureAuthConfigOptions();
  const cfg = __AUTH_CONFIG_CACHE || {};

  const daysPast = clampInt($("authDaysPast")?.value, 0, 30, cfg.daysPast);
  const daysFuture = clampInt($("authDaysFuture")?.value, 0, 30, cfg.daysFuture);

  const dryerMinutes = Number($("authDryerMinutes")?.value || cfg.dryerMinutes || 90);

  const wrap = $("authWasherHoursWrap");
  let washerHours = cfg.washerHours || [];
  if (wrap){
    washerHours = Array.from(wrap.querySelectorAll('input[type="checkbox"][data-hour]'))
      .filter(cb=>cb.checked)
      .map(cb=>Number(cb.getAttribute("data-hour")))
      .filter(n=>Number.isFinite(n) && n>=0 && n<=23)
      .sort((a,b)=>a-b);
  }

  const userDefectEnabled = !!$("authUserDefectEnabled")?.checked;

  const readAllow = (containerId)=>{
    const el = $(containerId);
    const out = {};
    if (!el) return out;
    el.querySelectorAll('input[type="checkbox"][data-n]').forEach(cb=>{
      const n = String(cb.getAttribute("data-n"));
      out[n] = !!cb.checked;
    });
    return out;
  };
  const userDefectAllowed = {
    washer: readAllow("authAllowWasher"),
    dryer: readAllow("authAllowDryer"),
  };

  const newsEnabled = !!$("authNewsEnabled")?.checked;
  const newsText = String($("authNewsText")?.value || "");

  const bumpNewsVersion = !!$("authBumpNewsVersion")?.checked;

  return { daysPast, daysFuture, washerHours, dryerMinutes, userDefectEnabled, userDefectAllowed, newsEnabled, newsText, bumpNewsVersion };
}

let __AUTH_MACHINES_CACHE = null;
let __AUTH_ROOMCONTROL_CACHE = null;
let __AUTH_FB_THREADS = null;

function authHas(p){
  try{
    const me = window.__AUTH_ME_CACHE || null;
    const perms = me?.perms || {};
    const role = me?.user?.role || (getAuth()?.role||"");
    return !!(perms[p] || role==="admin");
  }catch{ return false; }
}

async function authMeCached(){
  const me = await authMe();
  if (me) window.__AUTH_ME_CACHE = me;
  return me;
}

async function authLoadConfig(){
  const det = $("authConfigDetails"); if(det){det.style.display=""; det.open=true;}
  const msg = $("authConfigMsg"); if (msg) msg.innerHTML = `<div class="small">Lade Konfiguration‚Ä¶</div>`;
  try{
    await authMeCached();
    const r = await jpostAuth("/api/auth/admin/config/get", {});
    __AUTH_CONFIG_CACHE = r.config || {};
    renderAuthConfigForm(__AUTH_CONFIG_CACHE);
    toast("‚úÖ Konfiguration geladen");
    if (msg) msg.innerHTML = `<div class="small">‚úÖ Konfiguration geladen.</div>`;
  }catch(e){
    const m = e?.data?.hint || e?.data?.message || e?.data?.error || "Fehler";
    toast("‚õî Konfig laden: "+m);
    if (msg) msg.innerHTML = `<div class="small">‚õî Laden fehlgeschlagen (${esc(m)})</div>`;
  }
}

async function authSaveConfig(){
  const msg = $("authConfigMsg");
  try{
    const payload = collectAuthConfigFromForm();
    await jpostAuth("/api/auth/admin/config/set", payload);
    toast("‚úÖ Konfiguration gespeichert");
    if (msg) msg.innerHTML = `<div class="small">‚úÖ Gespeichert.</div>`;
  }catch(e){
    const m = e?.data?.hint || e?.data?.message || e?.data?.error || "Fehler";
    toast("‚õî Speichern: "+m);
    if (msg) msg.innerHTML = `<div class="small">‚õî Speichern fehlgeschlagen (${esc(m)})</div>`;
  }
}

function renderAuthMachinesUI(list){
  const box = $("authMachinesBox");
  if (!box) return;
  const m = (list||[]);
  const groups = [
    {type:"washer", label:"Waschmaschinen"},
    {type:"dryer", label:"Trockner"},
  ];
  let html = "";
  for (const g of groups){
    html += `<div class="title" style="margin-top:10px">${g.label}</div>`;
    for (let i=1;i<=4;i++){
      const row = m.find(x=>x.type===g.type && Number(x.machine)===i) || {type:g.type, machine:i, enabled:1, defect:0};
      const enId = `auth_m_${g.type}_${i}_en`;
      const deId = `auth_m_${g.type}_${i}_de`;
      html += `
        <div style="border:1px solid var(--line); border-radius:14px; padding:10px; margin:8px 0">
          <div style="display:flex;justify-content:space-between;gap:10px;align-items:center">
            <div><b>${g.type==="washer"?"WM":"TR"} ${i}</b></div>
            <div class="small">ID: ${esc(row.id||"")}</div>
          </div>
          <div style="margin-top:8px;display:flex;gap:12px;flex-wrap:wrap">
            <label style="display:inline-flex;gap:8px;align-items:center">
              <input type="checkbox" id="${enId}" ${row.enabled? "checked":""}/>
              <span>aktiv</span>
            </label>
            <label style="display:inline-flex;gap:8px;align-items:center">
              <input type="checkbox" id="${deId}" ${row.defect? "checked":""}/>
              <span>defekt</span>
            </label>
          </div>
        </div>
      `;
    }
  }
  box.innerHTML = html || `<div class="small">Keine Maschinen.</div>`;
}

async function authLoadMachines(){
  const det = $("authMachinesDetails"); if(det){det.style.display=""; det.open=true;}
  const box = $("authMachinesBox"); if (box) box.innerHTML = `<div class="small">Lade Maschinen‚Ä¶</div>`;
  try{
    const r = await jpostAuth("/api/auth/machines/list", {});
    __AUTH_MACHINES_CACHE = r.machines || [];
    renderAuthMachinesUI(__AUTH_MACHINES_CACHE);
    toast("‚úÖ Maschinen geladen");
  }catch(e){
    const msg = e?.data?.message || e?.data?.error || "Fehler";
    if (box) box.innerHTML = `<div class="small">‚õî Maschinen laden fehlgeschlagen (${esc(msg)})</div>`;
    toast("‚õî "+msg);
  }
}

async function authSaveMachines(){
  const box = $("authMachinesBox");
  try{
    if (!__AUTH_MACHINES_CACHE) await authLoadMachines();
    const updates = [];
    for (const g of ["washer","dryer"]){
      for (let i=1;i<=4;i++){
        const en = document.getElementById(`auth_m_${g}_${i}_en`);
        const de = document.getElementById(`auth_m_${g}_${i}_de`);
        if (!en || !de) continue;
        updates.push({ type:g, machine:i, enabled: !!en.checked, defect: !!de.checked });
      }
    }
    await jpostAuth("/api/auth/machines/set", { updates });
    toast("‚úÖ Maschinen gespeichert");
  }catch(e){
    const msg = e?.data?.message || e?.data?.error || "Fehler";
    toast("‚õî Speichern fehlgeschlagen: "+msg);
    if (box) box.insertAdjacentHTML("beforeend", `<div class="small">‚õî (${esc(msg)})</div>`);
  }
}

async function authSaveRoomControl(){
  const det = $("authRoomControlDetails"); if(det){det.style.display=""; det.open=true;}
  const room = ($("authRcRoom")?.value || "").trim();
  const allRooms = !!$("authRcAll")?.checked;
  const blocked = !!$("authRcBlocked")?.checked;
  const message = ($("authRcMsg")?.value || "").trim();
  const box = $("authRoomControlBox"); if (box) box.innerHTML = `<div class="small">Speichere‚Ä¶</div>`;
  try{
    const payload = { allRooms, room, blocked, message };
    await jpostAuth("/api/auth/room/control", payload);
    toast("‚úÖ Gespeichert");
    if (box) box.innerHTML = `<div class="small">‚úÖ Gespeichert.</div>`;
  }catch(e){
    const msg = e?.data?.message || e?.data?.error || "Fehler";
    toast("‚õî "+msg);
    if (box) box.innerHTML = `<div class="small">‚õî Speichern fehlgeschlagen (${esc(msg)})</div>`;
  }
}

async function authLoadRoomControls(){
  const det = $("authRoomControlDetails"); if(det){det.style.display=""; det.open=true;}
  const box = $("authRoomControlBox"); if (box) box.innerHTML = `<div class="small">Lade‚Ä¶</div>`;
  try{
    const r = await jpostAuth("/api/auth/room/control/list", {});
    __AUTH_ROOMCONTROL_CACHE = r.rooms || [];
    if (!__AUTH_ROOMCONTROL_CACHE.length){
      if (box) box.innerHTML = `<div class="small">Keine Eintr√§ge.</div>`;
      return;
    }
    if (box) box.innerHTML = __AUTH_ROOMCONTROL_CACHE.map(x=>{
      const rr = x.room==="*" ? "*" : esc(x.room);
      return `<div style="border-bottom:1px solid rgba(255,255,255,.08); padding:8px 0">
        <div><b>Zimmer ${rr}</b> ¬∑ ${x.blocked?'<span class="pill">gesperrt</span>':'<span class="pill">frei</span>'}</div>
        <div class="small">${esc(x.message||"")}</div>
        <div class="small" style="opacity:.7">${fmtDT(x.updatedAt||0)}</div>
      </div>`;
    }).join("");
  }catch(e){
    const msg = e?.data?.message || e?.data?.error || "Fehler";
    toast("‚õî "+msg);
    if (box) box.innerHTML = `<div class="small">‚õî Laden fehlgeschlagen (${esc(msg)})</div>`;
  }
}

async function authLoadFeedbackThreads(){
  const det = $("authFeedbackDetails"); if(det){det.style.display=""; det.open=true;}
  const box = $("authFeedbackBox"); if (box) box.innerHTML = `<div class="small">Lade Threads‚Ä¶</div>`;
  try{
    const r = await jpostAuth("/api/auth/feedback/threads", { limit: 200 });
    __AUTH_FB_THREADS = r.threads || [];
    if (!__AUTH_FB_THREADS.length){
      if (box) box.innerHTML = `<div class="small">Keine Threads.</div>`;
      return;
    }
    if (box) box.innerHTML = __AUTH_FB_THREADS.map(t=>{
      const id = esc(t.id);
      const badge = t.adminUnread ? '<span class="pill">neu</span>' : '<span class="pill">‚Äî</span>';
      return `<div style="border-bottom:1px solid rgba(255,255,255,.08); padding:8px 0">
        <div style="display:flex;justify-content:space-between;gap:10px;align-items:center">
          <div><b>${esc(t.subject||"Feedback")}</b> ¬∑ Zimmer ${esc(t.room||"")}</div>
          ${badge}
        </div>
        <div class="small">${fmtDT(t.updatedAt||t.createdAt||0)}</div>
        <div class="tileBtns" style="margin-top:8px">
          <button class="btn secondary inline" data-fb-open="${id}">√ñffnen</button>
        </div>
      </div>`;
    }).join("");
    box.querySelectorAll("button[data-fb-open]").forEach(btn=>{
      btn.onclick = ()=>authOpenFeedback(btn.getAttribute("data-fb-open"));
    });
  }catch(e){
    const msg = e?.data?.message || e?.data?.error || "Fehler";
    toast("‚õî "+msg);
    if (box) box.innerHTML = `<div class="small">‚õî Laden fehlgeschlagen (${esc(msg)})</div>`;
  }
}

async function authOpenFeedback(threadId){
  const box = $("authFeedbackBox"); if (!box) return;
  try{
    const r = await jpostAuth("/api/auth/feedback/thread", { threadId });
    const thread = r.thread || {};
    const msgs = r.messages || [];
    box.innerHTML = `
      <div class="small"><button class="btn secondary inline" id="btnFbBack">‚Üê Zur√ºck</button></div>
      <div style="margin-top:8px"><b>${esc(thread.subject||"Feedback")}</b> ¬∑ Zimmer ${esc(thread.room||"")}</div>
      <div style="margin-top:10px">
        ${msgs.map(m=>{
          const who = m.sender==="admin" ? "Admin" : "User";
          const vis = (m.visibleToUser===0) ? " (intern)" : "";
          return `<div style="border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:10px; margin:8px 0">
            <div class="small" style="opacity:.8">${who}${vis} ¬∑ ${fmtDT(m.ts||0)}</div>
            <div style="margin-top:6px; white-space:pre-wrap">${esc(m.message||"")}</div>
          </div>`;
        }).join("")}
      </div>
      <div style="margin-top:10px">
        <textarea id="fbReplyMsg" rows="4" placeholder="Antwort‚Ä¶" style="width:100%; padding:10px; border-radius:12px"></textarea>
        <div class="row" style="margin-top:8px">
          <label style="display:flex;align-items:center;gap:8px">
            <input type="checkbox" id="fbVisibleToUser" checked />
            <span class="small">F√ºr User sichtbar</span>
          </label>
          <button class="btn" id="btnFbSend">Senden</button>
        </div>
      </div>
    `;
    $("btnFbBack").onclick = ()=>authLoadFeedbackThreads();
    $("btnFbSend").onclick = async ()=>{
      const message = ($("fbReplyMsg")?.value||"").trim();
      if (!message) return toast("‚õî Nachricht leer");
      const visibleToUser = !!$("fbVisibleToUser")?.checked;
      await jpostAuth("/api/auth/feedback/send", { threadId, message, visibleToUser });
      toast("‚úÖ Gesendet");
      await authOpenFeedback(threadId);
    };
  }catch(e){
    const msg = e?.data?.message || e?.data?.error || "Fehler";
    toast("‚õî "+msg);
  }
}


/* ============================
   UI v8: Logs/Bookings/Feedback/RoomControl
   ============================ */

function fmtTs(ts){
  const n = Number(ts||0);
  if (!Number.isFinite(n) || n<=0) return "";
  const d = new Date(n);
  return new Intl.DateTimeFormat("de-DE", {
    timeZone:"Europe/Berlin",
    year:"numeric", month:"2-digit", day:"2-digit",
    hour:"2-digit", minute:"2-digit", second:"2-digit"
  }).format(d);
}

function parseMeta(m){
  if (!m) return {};
  if (typeof m === "object") return m;
  try{ return JSON.parse(String(m)); }catch(_e){ return { raw: String(m) }; }
}

function logRowToView(r){
  const meta = parseMeta(r.meta);
  const type = meta.type || r.type || "";
  const machine = meta.machine || r.machine || "";
  const mTxt = (type && machine) ? `${type==="washer"?"WM":"TR"} ${machine}` : "";
  return {
    ts: Number(r.ts||0),
    time: fmtTs(r.ts),
    room: r.room || meta.room || "",
    actor: r.actor || "",
    action: r.action || "",
    machine: mTxt,
    details: meta.message || meta.reason || meta.note || meta.error || meta.raw || JSON.stringify(meta)
  };
}

function bookingToView(b){
  const now = Date.now();
  const typeTxt = b.type==="washer" ? "Waschmaschine" : (b.type==="dryer" ? "Trockner" : (b.type||""));
  let st = b.status || "";
  if (st==="booked") st = (Number(b.start)<=now && Number(b.end)>now) ? "l√§uft" : "gebucht";
  if (st==="released") st="freigegeben";
  if (st==="cancelled") st="storniert";
  if (st==="admin_cancelled") st="ADMIN storniert";
  return {
    id: b.id,
    room: b.room,
    type: b.type,
    typeTxt,
    machine: b.machine,
    when: `${fmtTs(b.start)} ‚Äì ${fmtTs(b.end)}`,
    status: st,
    rawStatus: b.status
  };
}

function applyRangeFilter(list, rangeDays, tsGetter){
  const days = Number(rangeDays||0);
  if (!Number.isFinite(days) || days<=0) return list;
  const since = Date.now() - days*24*60*60*1000;
  return list.filter(x => Number(tsGetter(x)||0) >= since);
}

/* ---- Logs UI ---- */
function renderAuthLogs(){
  const box = $("authLogsBox"); if (!box) return;
  const q = ( $("authLogsSearch")?.value || "" ).trim().toLowerCase();
  const action = $("authLogsAction")?.value || "";
  const range = $("authLogsRange")?.value || "7";

  const viewsAll = (__ADMIN_LOGS_CACHE||[]).map(logRowToView);
  let list = applyRangeFilter(viewsAll, range, x=>x.ts);

  // filter action list
  if (action) list = list.filter(x => x.action === action);

  if (q){
    list = list.filter(x =>
      (x.room||"").toLowerCase().includes(q) ||
      (x.action||"").toLowerCase().includes(q) ||
      (x.actor||"").toLowerCase().includes(q) ||
      (x.machine||"").toLowerCase().includes(q) ||
      (x.details||"").toLowerCase().includes(q)
    );
  }

  const cnt = $("authLogsCount"); if (cnt) cnt.textContent = `${list.length} Eintr√§ge`;

  if (!list.length){
    box.innerHTML = `<div class="small">Keine Logs im Filter.</div>`;
    return;
  }

  box.innerHTML = `
    <div style="overflow:auto">
      <table style="width:100%; border-collapse:collapse">
        <thead>
          <tr style="text-align:left; opacity:.85">
            <th style="padding:8px 6px; border-bottom:1px solid rgba(255,255,255,.10)">Zeit</th>
            <th style="padding:8px 6px; border-bottom:1px solid rgba(255,255,255,.10)">Zimmer</th>
            <th style="padding:8px 6px; border-bottom:1px solid rgba(255,255,255,.10)">Maschine</th>
            <th style="padding:8px 6px; border-bottom:1px solid rgba(255,255,255,.10)">Aktion</th>
            <th style="padding:8px 6px; border-bottom:1px solid rgba(255,255,255,.10)">Details</th>
          </tr>
        </thead>
        <tbody>
          ${list.slice(0, 800).map(r => `
            <tr>
              <td style="padding:8px 6px; border-bottom:1px solid rgba(255,255,255,.06); white-space:nowrap">${esc(r.time)}</td>
              <td style="padding:8px 6px; border-bottom:1px solid rgba(255,255,255,.06)">${esc(r.room||"")}</td>
              <td style="padding:8px 6px; border-bottom:1px solid rgba(255,255,255,.06)">${esc(r.machine||"‚Äî")}</td>
              <td style="padding:8px 6px; border-bottom:1px solid rgba(255,255,255,.06)"><span class="pill">${esc(r.action||"")}</span></td>
              <td style="padding:8px 6px; border-bottom:1px solid rgba(255,255,255,.06); max-width:520px">${esc(r.details||"")}</td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    </div>
  `;
}

async function authLoadLogs(){
  const a=getAuth();
  if(!a.token) return toast("‚õî Bitte erst anmelden");
  const det=$("authLogsDetails"); if(det){det.style.display=""; det.open=true;}
  const box=$("authLogsBox"); if(box) box.innerHTML=`<div class="small">Lade Logs‚Ä¶</div>`;
  try{
    const range = $("authLogsRange")?.value || 7;
    const r = await jpostAuth("/api/auth/logs", { limit: 2000, rangeDays: Number(range) });
    __ADMIN_LOGS_CACHE = (r.logs||[]).slice().sort((x,y)=>(y.ts||0)-(x.ts||0));
    // fill action dropdown
    const sel = $("authLogsAction");
    if (sel){
      const actions = Array.from(new Set(__ADMIN_LOGS_CACHE.map(x=>x.action).filter(Boolean))).sort();
      sel.innerHTML = '<option value="">Alle Aktionen</option>' + actions.map(a=>`<option value="${esc(a)}">${esc(a)}</option>`).join("");
    }
    renderAuthLogs();
    toast("‚úÖ Logs geladen");
  }catch(e){
    const msg = e?.data?.hint || e?.data?.message || e?.data?.error || "Fehler";
    if (box) box.innerHTML = `<div class="small">‚õî Logs laden fehlgeschlagen (${esc(msg)})</div>`;
    toast("‚õî Logs: "+msg);
  }
}

/* ---- Bookings UI ---- */
function renderAuthBookings(){
  const box = $("authBookingsBox"); if(!box) return;
  const q = ( $("authBookingsSearch")?.value || "" ).trim().toLowerCase();
  const st = $("authBookingsStatus")?.value || "";
  const tp = $("authBookingsType")?.value || "";
  const range = $("authBookingsRange")?.value || "7";

  const all = (__ADMIN_BOOKINGS_CACHE||[]);
  let list = applyRangeFilter(all, range, b=>b.start);
  if (st) list = list.filter(b => String(b.status||"") === st);
  if (tp) list = list.filter(b => String(b.type||"") === tp);
  if (q){
    list = list.filter(b => 
      String(b.room||"").toLowerCase().includes(q) ||
      String(b.id||"").toLowerCase().includes(q) ||
      String(b.type||"").toLowerCase().includes(q) ||
      String(b.machine||"").toLowerCase().includes(q) ||
      String(b.status||"").toLowerCase().includes(q)
    );
  }

  const cnt = $("authBookingsCount"); if (cnt) cnt.textContent = `${list.length} Buchungen`;

  if (!list.length){
    box.innerHTML = `<div class="small">Keine Buchungen im Filter.</div>`;
    return;
  }

  const views = list.map(bookingToView);
  box.innerHTML = `
    <div style="overflow:auto">
      <table style="width:100%; border-collapse:collapse">
        <thead>
          <tr style="text-align:left; opacity:.85">
            <th style="padding:8px 6px; border-bottom:1px solid rgba(255,255,255,.10)">Zeit</th>
            <th style="padding:8px 6px; border-bottom:1px solid rgba(255,255,255,.10)">Zimmer</th>
            <th style="padding:8px 6px; border-bottom:1px solid rgba(255,255,255,.10)">Maschine</th>
            <th style="padding:8px 6px; border-bottom:1px solid rgba(255,255,255,.10)">Status</th>
            <th style="padding:8px 6px; border-bottom:1px solid rgba(255,255,255,.10)">Aktion</th>
          </tr>
        </thead>
        <tbody>
          ${views.slice(0, 1200).map(v => `
            <tr>
              <td style="padding:8px 6px; border-bottom:1px solid rgba(255,255,255,.06); white-space:nowrap">${esc(v.when)}</td>
              <td style="padding:8px 6px; border-bottom:1px solid rgba(255,255,255,.06)">${esc(v.room||"")}</td>
              <td style="padding:8px 6px; border-bottom:1px solid rgba(255,255,255,.06)">${esc(v.typeTxt)} ${esc(String(v.machine||""))}</td>
              <td style="padding:8px 6px; border-bottom:1px solid rgba(255,255,255,.06)"><span class="pill">${esc(v.status)}</span></td>
              <td style="padding:8px 6px; border-bottom:1px solid rgba(255,255,255,.06)">
                ${v.rawStatus==="booked" ? `<button class="btn secondary inline" data-auth-cancel="${esc(v.id)}">Admin-Storno</button>` : `<span class="small" style="opacity:.7">‚Äî</span>`}
              </td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    </div>
  `;

  box.querySelectorAll("button[data-auth-cancel]").forEach(btn=>{
    btn.onclick = async ()=>{
      const id = btn.getAttribute("data-auth-cancel");
      if (!id) return;
      if (!confirm("Buchung wirklich admin-stornieren?")) return;
      try{
        await jpostAuth("/api/auth/bookings/cancel", { id });
        toast("‚úÖ ADMIN-Storno ok");
        await authLoadBookings();
      }catch(e){
        const msg = e?.data?.hint || e?.data?.message || e?.data?.error || "Fehler";
        toast("‚õî Storno: "+msg);
      }
    };
  });
}

async function authLoadBookings(){
  const a=getAuth();
  if(!a.token) return toast("‚õî Bitte erst anmelden");
  const det=$("authBookingsDetails"); if(det){det.style.display=""; det.open=true;}
  const box=$("authBookingsBox"); if(box) box.innerHTML=`<div class="small">Lade Buchungen‚Ä¶</div>`;
  try{
    const range = $("authBookingsRange")?.value || 7;
    let r;
    try{ r = await jpostAuth("/api/auth/bookings", { limit: 2000, rangeDays: Number(range) }); }
    catch(_e){ r = await jpostAuth("/api/auth/bookings/list", { limit: 2000, rangeDays: Number(range) }); }
    __ADMIN_BOOKINGS_CACHE = (r.bookings||[]).slice().sort((x,y)=>(y.start||0)-(x.start||0));
    renderAuthBookings();
    toast("‚úÖ Buchungen geladen");
  }catch(e){
    const msg = e?.data?.hint || e?.data?.message || e?.data?.error || "Fehler";
    if (box) box.innerHTML = `<div class="small">‚õî Buchungen laden fehlgeschlagen (${esc(msg)})</div>`;
    toast("‚õî Buchungen: "+msg);
  }
}

/* ---- Feedback UI ---- */
let __FB_THREADS = [];
let __FB_ACTIVE = null;
let __FB_MESSAGES = [];

function renderFbThreads(){
  const box = $("authFbThreadsBox"); if(!box) return;
  const q = ($("authFbSearch")?.value || "").trim().toLowerCase();
  let list = (__FB_THREADS||[]);
  if (q){
    list = list.filter(t => String(t.room||"").toLowerCase().includes(q) || String(t.id||"").toLowerCase().includes(q));
  }
  if (!list.length){
    box.innerHTML = `<div class="small">Keine Threads.</div>`;
    return;
  }
  box.innerHTML = list.map(t=>{
    const room = t.room || "‚Äî";
    const badge = (t.adminUnread ? "‚Ä¢ neu" : "");
    return `<div class="pill" style="display:block; margin-bottom:8px; cursor:pointer" data-thread="${esc(t.id)}">
      <b>Zimmer ${esc(room)}</b> <span class="small" style="opacity:.8">${esc(badge)}</span><br/>
      <span class="small" style="opacity:.8">${esc(fmtTs(t.updatedAt || t.updated_at || t.updatedAtMs || t.updatedAtTs || t.updatedAt))}</span>
    </div>`;
  }).join("");

  box.querySelectorAll("[data-thread]").forEach(el=>{
    el.onclick = async ()=>{
      const id = el.getAttribute("data-thread");
      if (!id) return;
      await authFbOpenThread(id);
    };
  });
}

function renderFbMessages(){
  const box = $("authFbMsgsBox"); if(!box) return;
  if (!__FB_ACTIVE){
    box.innerHTML = `<div class="small">Thread ausw√§hlen‚Ä¶</div>`;
    return;
  }
  const msgs = (__FB_MESSAGES||[]);
  if (!msgs.length){
    box.innerHTML = `<div class="small">Keine Nachrichten.</div>`;
    return;
  }
  box.innerHTML = msgs.map(m=>{
    const who = m.sender==="admin" ? "Admin" : "Zimmer";
    const align = m.sender==="admin" ? "flex-end" : "flex-start";
    const bg = m.sender==="admin" ? "rgba(255,255,255,.10)" : "rgba(255,255,255,.06)";
    return `<div style="display:flex;justify-content:${align}; margin-bottom:10px">
      <div style="max-width:85%; background:${bg}; padding:10px; border-radius:12px">
        <div class="small" style="opacity:.75">${esc(who)} ¬∑ ${esc(fmtTs(m.ts))}${m.visibleToUser===0 ? " ¬∑ (nicht sichtbar)" : ""}</div>
        <div style="white-space:pre-wrap">${esc(m.message||"")}</div>
      </div>
    </div>`;
  }).join("");
  box.scrollTop = box.scrollHeight;
}

async function authFbLoadThreads(){
  const a=getAuth();
  if(!a.token) return toast("‚õî Bitte erst anmelden");
  const det=$("authFeedbackDetails"); if(det){det.style.display=""; det.open=true;}
  const listBox = $("authFbThreadsBox"); if(listBox) listBox.innerHTML = `<div class="small">Lade Threads‚Ä¶</div>`;
  try{
    let r;
    try{ r = await jpostAuth("/api/auth/feedback/threads", { limit: 300 }); }
    catch(_e){ r = await jpostAuth("/api/auth/feedback/list", { limit: 300 }); }
    __FB_THREADS = (r.threads || r.items || []).slice().sort((a,b)=>(Number(b.updatedAt||b.updated_at||0)-Number(a.updatedAt||a.updated_at||0)));
    renderFbThreads();
    toast("‚úÖ Threads geladen");
  }catch(e){
    const msg = e?.data?.hint || e?.data?.message || e?.data?.error || "Fehler";
    if (listBox) listBox.innerHTML = `<div class="small">‚õî Threads laden fehlgeschlagen (${esc(msg)})</div>`;
    toast("‚õî Feedback: "+msg);
  }
}

async function authFbOpenThread(threadId){
  const a=getAuth();
  if(!a.token) return toast("‚õî Bitte erst anmelden");
  const msgsBox = $("authFbMsgsBox"); if(msgsBox) msgsBox.innerHTML = `<div class="small">Lade‚Ä¶</div>`;
  try{
    const r = await jpostAuth("/api/auth/feedback/thread", { threadId });
    __FB_ACTIVE = r.thread;
    __FB_MESSAGES = r.messages || [];
    $("authFbActiveTitle").innerHTML = `<b>Zimmer ${esc(__FB_ACTIVE.room || "")}</b>`;
    $("authFbActiveMeta").textContent = `Thread ${threadId}`;
    const vis = $("authFbVisibleToUser");
    if (vis) vis.checked = true;
    renderFbMessages();
  }catch(e){
    const msg = e?.data?.hint || e?.data?.message || e?.data?.error || "Fehler";
    if (msgsBox) msgsBox.innerHTML = `<div class="small">‚õî Thread laden fehlgeschlagen (${esc(msg)})</div>`;
    toast("‚õî Thread: "+msg);
  }
}

async function authFbSend(){
  if (!__FB_ACTIVE) return toast("‚õî Erst Thread ausw√§hlen");
  const msgEl = $("authFbMsg");
  const message = String(msgEl?.value || "").trim();
  if (!message) return toast("‚õî Nachricht leer");
  const visibleToUser = $("authFbVisibleToUser")?.checked !== false;
  try{
    await jpostAuth("/api/auth/feedback/send", { threadId: __FB_ACTIVE.id || __FB_ACTIVE.threadId || __FB_ACTIVE, message, visibleToUser });
    if (msgEl) msgEl.value = "";
    toast("‚úÖ Gesendet");
    await authFbOpenThread(__FB_ACTIVE.id || __FB_ACTIVE.threadId || __FB_ACTIVE);
    await authFbLoadThreads();
  }catch(e){
    const msg = e?.data?.hint || e?.data?.message || e?.data?.error || "Fehler";
    toast("‚õî Senden: "+msg);
  }
}

/* ---- Room control UI ---- */
let __RC_CACHE = [];
function renderRcList(){
  const box = $("authRcListBox"); if(!box) return;
  const q = ($("authRcSearch")?.value || "").trim().toLowerCase();
  let list = (__RC_CACHE||[]);
  if (q) list = list.filter(r => String(r.room||"").toLowerCase().includes(q));
  if (!list.length){
    box.innerHTML = `<div class="small">Keine Eintr√§ge.</div>`;
    return;
  }
  box.innerHTML = list.map(r=>{
    const state = r.blocked ? "GESPERRT" : "Hinweis";
    const pill = r.blocked ? "pill" : "pill";
    const msg = r.message ? `<div class="small" style="opacity:.85; white-space:pre-wrap">${esc(r.message)}</div>` : `<div class="small" style="opacity:.6">‚Äî</div>`;
    return `<div style="padding:10px 0; border-bottom:1px solid rgba(255,255,255,.08)">
      <div style="display:flex;justify-content:space-between;gap:10px;align-items:center">
        <div><b>Zimmer ${esc(r.room)}</b> ¬∑ <span class="${pill}">${esc(state)}</span></div>
        <div class="small" style="opacity:.75">${esc(fmtTs(r.updatedAt))}</div>
      </div>
      ${msg}
    </div>`;
  }).join("");
}

async function authRcLoadList(){
  const a=getAuth();
  if(!a.token) return toast("‚õî Bitte erst anmelden");
  const det=$("authRoomControlDetails"); if(det){det.style.display=""; det.open=true;}
  const box=$("authRcListBox"); if(box) box.innerHTML = `<div class="small">Lade‚Ä¶</div>`;
  try{
    let r;
    try{ r = await jpostAuth("/api/auth/room/control/list", {}); }
    catch(_e){ r = await jpostAuth("/api/auth/room/control", { list:true }); }
    __RC_CACHE = (r.rooms || r.items || []).slice().sort((a,b)=>(Number(b.updatedAt||0)-Number(a.updatedAt||0)));
    renderRcList();
    toast("‚úÖ √úbersicht geladen");
  }catch(e){
    const msg = e?.data?.hint || e?.data?.message || e?.data?.error || "Fehler";
    if (box) box.innerHTML = `<div class="small">‚õî Laden fehlgeschlagen (${esc(msg)})</div>`;
    toast("‚õî Zimmer: "+msg);
  }
}

async function authRcSave(blocked){
  const room = String($("authRcRoom")?.value || "").trim();
  const message = String($("authRcMsg")?.value || "").trim();
  if (!room) return toast("‚õî Zimmer fehlt");
  try{
    await jpostAuth("/api/auth/room/control", { room, blocked: !!blocked, message });
    $("authRcHint").textContent = "‚úÖ gespeichert";
    await authRcLoadList();
  }catch(e){
    const msg = e?.data?.hint || e?.data?.message || e?.data?.error || "Fehler";
    $("authRcHint").textContent = "‚õî "+msg;
  }
}

function wireV8UI(){
  // logs
  if ($("btnAuthLogsReload")) $("btnAuthLogsReload").onclick = authLoadLogs;
  if ($("authLogsSearch")) $("authLogsSearch").oninput = ()=>renderAuthLogs();
  if ($("authLogsAction")) $("authLogsAction").onchange = ()=>renderAuthLogs();
  if ($("authLogsRange")) $("authLogsRange").onchange = ()=>authLoadLogs();
  if ($("btnAuthLogsExport")) $("btnAuthLogsExport").onclick = ()=>{
    const views = (__ADMIN_LOGS_CACHE||[]).map(logRowToView);
    downloadCSV("logs.csv", views);
  };

  // bookings
  if ($("btnAuthBookingsReload")) $("btnAuthBookingsReload").onclick = authLoadBookings;
  if ($("authBookingsSearch")) $("authBookingsSearch").oninput = ()=>renderAuthBookings();
  if ($("authBookingsStatus")) $("authBookingsStatus").onchange = ()=>renderAuthBookings();
  if ($("authBookingsType")) $("authBookingsType").onchange = ()=>renderAuthBookings();
  if ($("authBookingsRange")) $("authBookingsRange").onchange = ()=>authLoadBookings();
  if ($("btnAuthBookingsExport")) $("btnAuthBookingsExport").onclick = ()=>{
    const rows = (__ADMIN_BOOKINGS_CACHE||[]).map(bookingToView);
    downloadCSV("bookings.csv", rows);
  };

  // feedback
  if ($("btnAuthFbList")) $("btnAuthFbList").onclick = authFbLoadThreads;
  if ($("btnAuthFbRefresh")) $("btnAuthFbRefresh").onclick = authFbLoadThreads;
  if ($("authFbSearch")) $("authFbSearch").oninput = ()=>renderFbThreads();
  if ($("btnAuthFbSend")) $("btnAuthFbSend").onclick = authFbSend;

  // room control
  if ($("btnAuthRcList")) $("btnAuthRcList").onclick = authRcLoadList;
  if ($("btnAuthRcRefresh")) $("btnAuthRcRefresh").onclick = authRcLoadList;
  if ($("authRcSearch")) $("authRcSearch").oninput = ()=>renderRcList();
  if ($("btnAuthRcSave")) $("btnAuthRcSave").onclick = ()=>authRcSave($("authRcBlocked")?.checked);
  if ($("btnAuthRcClear")) $("btnAuthRcClear").onclick = async ()=>{
    $("authRcBlocked").checked = false;
    $("authRcMsg").value = "";
    await authRcSave(false);
  };
}

document.addEventListener("DOMContentLoaded", wireV8UI);



/* ============================
   UI v9: Auth sections + Users
   ============================ */

function hasPerm(p){ try{ return !!(__AUTH_ME?.perms && __AUTH_ME.perms[p]); }catch(_e){ return false; } }
function roleIs(...rs){ const r=String(__AUTH_ME?.user?.role||""); return rs.includes(r); }

function updateAuthSections(){
  const loggedIn = !!(getAuth()?.token);
  const me = __AUTH_ME || null;

  const show = (id, ok)=>{
    const el = $(id);
    if (!el) return;
    el.style.display = (loggedIn && ok) ? "" : "none";
  };

  // Config
  show("authConfigDetails", roleIs("admin","superadmin","super_admin") || hasPerm("admin.config.manage") || hasPerm("admin.news.edit"));

  // Logs + bookings
  show("authLogsDetails", roleIs("admin","superadmin","super_admin","ps","ps_deputy") || hasPerm("admin.logs.view"));
  show("authBookingsDetails", roleIs("admin","superadmin","super_admin","ps","ps_deputy") || hasPerm("admin.bookings.view"));

  // Feedback
  show("authFeedbackDetails", roleIs("admin","superadmin","super_admin","ps","ps_deputy") || hasPerm("admin.feedback.view") || hasPerm("admin.feedback.reply"));

  // Room control
  show("authRoomControlDetails", roleIs("admin","superadmin","super_admin","ps","ps_deputy") || hasPerm("admin.roomcontrol.manage") || hasPerm("ps.rooms.manage"));

  // Users
  show("authUsersDetails", roleIs("admin","superadmin","super_admin") || hasPerm("admin.users.manage"));
}

let __AUTH_ME = null;

async function authMe(){
  const a=getAuth();
  if(!a.token) return null;
  const r = await jpostAuth("/api/auth/me", {});
  __AUTH_ME = r;
  updateAuthSections();
  return r;
}

// Patch existing renderAuth to call authMe when logged in
try{
  const _oldRenderAuth = window.renderAuth;
  window.renderAuth = async function(){
    const out = await _oldRenderAuth();
    try{ await authMe(); }catch(_e){}
    return out;
  };
}catch(_e){}

// ---- Users UI ----
const PERM_GROUPS = [
  {title:"Allgemein", keys:[
    ["admin.logs.view","Logs ansehen"],
    ["admin.bookings.view","Buchungen ansehen"],
    ["admin.bookings.cancel","Buchungen stornieren"],
  ]},
  {title:"Konfiguration / News", keys:[
    ["admin.config.manage","Konfiguration √§ndern"],
    ["admin.news.edit","News √§ndern"],
  ]},
  {title:"Feedback / Zimmer", keys:[
    ["admin.feedback.view","Feedback sehen"],
    ["admin.feedback.reply","Feedback antworten"],
    ["admin.roomcontrol.manage","Zimmer sperren/anschreiben"],
  ]},
  {title:"Benutzer", keys:[
    ["admin.users.manage","Benutzerverwaltung"],
  ]},
];

function renderUsers(list){
  const box=$("authUsersBox"); if(!box) return;
  const q = ($("authUsersSearch")?.value||"").trim().toLowerCase();
  let items = list || [];
  if(q) items = items.filter(u=>String(u.email||"").toLowerCase().includes(q));

  if(!items.length){ box.innerHTML = `<div class="small">Keine Benutzer.</div>`; return; }

  box.innerHTML = items.map(u=>{
    const role = String(u.role||"");
    const status = String(u.status||"");
    const perms = u.perms || {};

    const permHtml = PERM_GROUPS.map(g=>{
      return `<div style="margin-top:10px; padding:10px; border:1px solid rgba(255,255,255,.08); border-radius:12px">
        <div><b>${esc(g.title)}</b></div>
        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(230px, 1fr)); gap:8px; margin-top:8px">
          ${g.keys.map(([k,lab])=>`
            <label class="small" style="display:flex;gap:8px;align-items:center">
              <input type="checkbox" data-up="${esc(u.id)}" data-perm="${esc(k)}" ${perms[k] ? "checked":""} />
              ${esc(lab)} <span style="opacity:.65">(${esc(k)})</span>
            </label>
          `).join("")}
        </div>
      </div>`;
    }).join("");

    return `<div style="padding:12px 0; border-bottom:1px solid rgba(255,255,255,.10)">
      <div style="display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; align-items:center">
        <div>
          <div><b>${esc(u.email||"")}</b></div>
          <div class="small" style="opacity:.8">Rolle: ${esc(role)} ¬∑ Status: ${esc(status)}</div>
        </div>
        <div class="row" style="gap:8px; flex-wrap:wrap">
          <select data-role="${esc(u.id)}">
            ${["ps","ps_deputy","admin","super_admin","superadmin"].map(r=>`<option value="${r}" ${r===role?"selected":""}>${r}</option>`).join("")}
          </select>
          <select data-status="${esc(u.id)}">
            ${["pending","active","disabled"].map(s=>`<option value="${s}" ${s===status?"selected":""}>${s}</option>`).join("")}
          </select>
          <button class="btn" data-save="${esc(u.id)}">Speichern</button>
        </div>
      </div>
      ${permHtml}
    </div>`;
  }).join("");

  box.querySelectorAll("button[data-save]").forEach(btn=>{
    btn.onclick = async ()=>{
      const id = btn.getAttribute("data-save");
      const role = box.querySelector(`select[data-role="${CSS.escape(id)}"]`)?.value;
      const status = box.querySelector(`select[data-status="${CSS.escape(id)}"]`)?.value;

      const perms = {};
      box.querySelectorAll(`input[type="checkbox"][data-up="${CSS.escape(id)}"]`).forEach(cb=>{
        perms[cb.getAttribute("data-perm")] = cb.checked;
      });

      try{
        await jpostAuth("/api/auth/admin/users/update", { userId:id, role, status, perms });
        toast("‚úÖ Benutzer gespeichert");
        await authUsersLoad();
      }catch(e){
        const msg = e?.data?.message || e?.data?.error || "Fehler";
        toast("‚õî Benutzer: "+msg);
      }
    };
  });
}

let __USERS_CACHE = [];
async function authUsersLoad(){
  const a=getAuth(); if(!a.token) return toast("‚õî Bitte erst anmelden");
  const det=$("authUsersDetails"); if(det){det.style.display=""; det.open=true;}
  const box=$("authUsersBox"); if(box) box.innerHTML = `<div class="small">Lade‚Ä¶</div>`;
  try{
    const includePending = $("authUsersIncludePending")?.checked !== false;
    const r = await jpostAuth("/api/auth/admin/users/list", { includePending });
    __USERS_CACHE = r.users || [];
    renderUsers(__USERS_CACHE);
    toast("‚úÖ Benutzer geladen");
  }catch(e){
    const msg = e?.data?.message || e?.data?.error || "Fehler";
    if(box) box.innerHTML = `<div class="small">‚õî Laden fehlgeschlagen (${esc(msg)})</div>`;
    toast("‚õî Benutzer: "+msg);
  }
}

document.addEventListener("DOMContentLoaded", ()=>{
  if ($("btnAuthUsersLoad")) $("btnAuthUsersLoad").onclick = authUsersLoad;
  if ($("authUsersSearch")) $("authUsersSearch").oninput = ()=>renderUsers(__USERS_CACHE);
});





/* ============================
   RBAC UI (Users + Permissions)
   ============================ */
let __RBAC = { users:[], perms:[], userPerms:[] };
let __RBAC_SELECTED = null;

function canSeeUsers(me){
  const role = String(me?.user?.role || "");
  const perms = me?.perms || {};
  return !!(perms["admin.users.manage"] || ["admin","superadmin","super_admin"].includes(role));
}

function rbacUserName(u){
  const n = (String(u.firstName||"").trim()+" "+String(u.lastName||"").trim()).trim();
  return n || "(ohne Namen)";
}

function rbacPermAllowedMap(userId){
  const m = {};
  (__RBAC.userPerms||[]).forEach(p=>{
    if (String(p.userId)===String(userId)) m[p.permKey]=!!p.allowed;
  });
  return m;
}

function renderRbacUserList(){
  const box = $("rbacUserList"); if (!box) return;
  const q = ($("rbacUserSearch")?.value||"").trim().toLowerCase();
  let list = (__RBAC.users||[]);
  if (q){
    list = list.filter(u=>{
      const hay = (rbacUserName(u)+" "+(u.email||"")+" "+(u.role||"")+" "+(u.role2||"")).toLowerCase();
      return hay.includes(q);
    });
  }
  box.innerHTML = list.map(u=>{
    const sel = (__RBAC_SELECTED && String(__RBAC_SELECTED.id)===String(u.id));
    const pill = (t)=>`<span class="pill" style="margin-left:6px">${esc(t)}</span>`;
    return `
      <div class="card ${sel?"soft":""}" style="padding:10px; margin:8px 0; cursor:pointer" data-uid="${esc(u.id)}">
        <div style="font-weight:700">${esc(rbacUserName(u))}</div>
        <div class="small" style="opacity:.85">${esc(u.email||"")}</div>
        <div class="small" style="opacity:.85; margin-top:6px">
          ${pill(u.role||"user")}${u.role2?pill(u.role2):""}
          <span style="opacity:.7; margin-left:6px">${esc(u.status||"")}</span>
        </div>
      </div>
    `;
  }).join("") || `<div class="small">Keine Benutzer.</div>`;

  box.querySelectorAll("[data-uid]").forEach(el=>{
    el.onclick = ()=>{
      const id = el.getAttribute("data-uid");
      const u = (__RBAC.users||[]).find(x=>String(x.id)===String(id));
      if (!u) return;
      __RBAC_SELECTED = u;
      renderRbacSelected();
      renderRbacUserList();
    };
  });
}

function renderRbacSelected(){
  const h = $("rbacSelHeader");
  const pb = $("rbacPermBox");
  const hint = $("rbacUserHint");
  if (!h || !pb) return;

  if (!__RBAC_SELECTED){
    h.textContent = "‚Äì";
    pb.innerHTML = `<div class="small">W√§hle links einen Benutzer.</div>`;
    return;
  }

  h.textContent = `${rbacUserName(__RBAC_SELECTED)} ‚Äì ${__RBAC_SELECTED.email || ""}`;
  $("rbacFirstName").value = __RBAC_SELECTED.firstName || "";
  $("rbacLastName").value  = __RBAC_SELECTED.lastName  || "";
  $("rbacIsAdmin2").checked = String(__RBAC_SELECTED.role2||"") === "admin";
  if (hint) hint.textContent = `ID: ${__RBAC_SELECTED.id}`;

  const allowed = rbacPermAllowedMap(__RBAC_SELECTED.id);
  const q = ($("rbacPermSearch")?.value||"").trim().toLowerCase();
  let perms = (__RBAC.perms||[]);
  if (q){
    perms = perms.filter(p=>{
      const hay = ((p.permKey||"")+" "+(p.label||"")+" "+(p.category||"")).toLowerCase();
      return hay.includes(q);
    });
  }

  // group by category
  const groups = {};
  perms.forEach(p=>{
    const cat = p.category || "Allgemein";
    if (!groups[cat]) groups[cat]=[];
    groups[cat].push(p);
  });

  pb.innerHTML = Object.keys(groups).sort().map(cat=>{
    const items = groups[cat].map(p=>{
      const on = !!allowed[p.permKey];
      return `
        <label class="row" style="align-items:center; gap:10px; padding:6px 0; border-bottom:1px solid rgba(255,255,255,.06)">
          <input type="checkbox" data-perm="${esc(p.permKey)}" ${on?"checked":""}/>
          <div style="display:flex; flex-direction:column">
            <div style="font-weight:650">${esc(p.permKey)}</div>
            <div class="small" style="opacity:.8">${esc(p.label || "")}</div>
          </div>
        </label>
      `;
    }).join("");

    return `
      <details open style="margin:8px 0">
        <summary><b>${esc(cat)}</b> <span class="small" style="opacity:.7">(${groups[cat].length})</span></summary>
        <div style="margin-top:6px">${items}</div>
      </details>
    `;
  }).join("") || `<div class="small">Keine Permissions.</div>`;

  pb.querySelectorAll("input[type=checkbox][data-perm]").forEach(cb=>{
    cb.onchange = async ()=>{
      const permKey = cb.getAttribute("data-perm");
      const allowed = cb.checked;
      try{
        await jpostAuth("/api/auth/admin/users/set-perm", { userId: __RBAC_SELECTED.id, permKey, allowed });
        // update cache
        const ex = (__RBAC.userPerms||[]).find(x=>String(x.userId)===String(__RBAC_SELECTED.id) && x.permKey===permKey);
        if (ex) ex.allowed = allowed ? 1 : 0;
        else __RBAC.userPerms.push({ userId: __RBAC_SELECTED.id, permKey, allowed: allowed?1:0 });
      }catch(e){
        toast("‚õî Perm speichern fehlgeschlagen");
        cb.checked = !allowed;
      }
    };
  });
}

async function rbacLoad(){
  const box = $("rbacUserList");
  if (box) box.innerHTML = `<div class="small">Lade‚Ä¶</div>`;
  let r;
  try{
    r = await jpostAuth("/api/auth/admin/rbac/snapshot", {});
  }catch(e){
    // fallback: older workers may not have snapshot
    if (String(e?.status||"") === "404"){
      toast("‚õî RBAC Snapshot fehlt im Worker. Bitte Worker V5 deployen und /api/_routes pr√ºfen.");
      const u = await jpostAuth("/api/auth/admin/users/list", {});
      r = { users: u.users||[], permsCatalog: [], rolePerms: [], userPerms: [] };
    } else { throw e; }
  }
  __RBAC = { users: r.users||[], perms: r.perms||[], userPerms: r.userPerms||[] };
  __RBAC_SELECTED = __RBAC_SELECTED ? (__RBAC.users||[]).find(u=>String(u.id)===String(__RBAC_SELECTED.id)) : null;
  renderRbacUserList();
  renderRbacSelected();
}

async function rbacSetRole(role){
  if (!__RBAC_SELECTED) return toast("‚õî Kein Benutzer ausgew√§hlt");
  if (!confirm(`Rolle wirklich setzen: ${role}?`)) return;
  await jpostAuth("/api/auth/admin/users/set-role", { userId: __RBAC_SELECTED.id, role });
  toast("‚úÖ Rolle gesetzt");
  await rbacLoad();
}

async function rbacSaveUser(){
  if (!__RBAC_SELECTED) return toast("‚õî Kein Benutzer ausgew√§hlt");
  await jpostAuth("/api/auth/admin/users/update", {
    userId: __RBAC_SELECTED.id,
    firstName: $("rbacFirstName").value,
    lastName: $("rbacLastName").value,
    status: $("rbacStatus").value,
    role2: $("rbacIsAdmin2").checked ? "admin" : ""
  });
  toast("‚úÖ Gespeichert");
  await rbacLoad();
}

async function rbacAll(on){
  if (!__RBAC_SELECTED) return toast("‚õî Kein Benutzer ausgew√§hlt");
  const perms = (__RBAC.perms||[]).map(p=>p.permKey);
  for (const permKey of perms){
    await jpostAuth("/api/auth/admin/users/set-perm", { userId: __RBAC_SELECTED.id, permKey, allowed: !!on });
    const ex = (__RBAC.userPerms||[]).find(x=>String(x.userId)===String(__RBAC_SELECTED.id) && x.permKey===permKey);
    if (ex) ex.allowed = on?1:0;
    else __RBAC.userPerms.push({ userId: __RBAC_SELECTED.id, permKey, allowed: on?1:0 });
  }
  toast(on ? "‚úÖ Alle an" : "‚úÖ Alle aus");
  renderRbacSelected();
}

document.addEventListener("DOMContentLoaded", ()=>{
  if ($("btnRbacLoad")) $("btnRbacLoad").onclick = rbacLoad;
  if ($("rbacUserSearch")) $("rbacUserSearch").oninput = renderRbacUserList;
  if ($("rbacPermSearch")) $("rbacPermSearch").oninput = renderRbacSelected;
  if ($("btnSetPS")) $("btnSetPS").onclick = ()=>rbacSetRole("ps");
  if ($("btnSetVS")) $("btnSetVS").onclick = ()=>rbacSetRole("ps_deputy");
  if ($("btnSaveUser")) $("btnSaveUser").onclick = rbacSaveUser;
  if ($("btnPermAllOn")) $("btnPermAllOn").onclick = ()=>rbacAll(true);
  if ($("btnPermAllOff")) $("btnPermAllOff").onclick = ()=>rbacAll(false);
});



/* ============================
   RBAC Role Editor
   ============================ */
let __RBAC_ROLE_PERMS = {}; // role -> Set(keys)

function buildPermCheckboxes(permsCatalog, selectedSet, onChange){
  // group by permGroup
  const groups = {};
  for (const p of permsCatalog){
    const g = p.permGroup || "Sonstiges";
    (groups[g] ||= []).push(p);
  }
  const orderGroups = Object.keys(groups).sort();
  return orderGroups.map(g=>{
    const items = groups[g].sort((a,b)=>(a.sort||0)-(b.sort||0));
    return `
      <div class="card" style="margin-top:10px">
        <b>${esc(g)}</b>
        <div style="margin-top:8px; display:flex; flex-wrap:wrap; gap:10px">
          ${items.map(p=>{
            const key = p.permKey;
            const checked = selectedSet.has(key) ? "checked" : "";
            return `<label class="small" style="display:flex;gap:8px;align-items:center;min-width:240px">
              <input type="checkbox" data-perm="${esc(key)}" ${checked}>
              <span><span class="pill">${esc(key)}</span> ${esc(p.title||"")}</span>
            </label>`;
          }).join("")}
        </div>
      </div>
    `;
  }).join("");
}

async function rbacLoadRole(){
  const role = $("rbacRoleSelect")?.value || "ps";
  $("rbacRoleHint").textContent = "Lade‚Ä¶";
  const r = await jpostAuth("/api/auth/admin/rbac/role/get", { role });
  const set = new Set((r.perms||[]).filter(x=>x.allowed).map(x=>x.permKey));
  __RBAC_ROLE_PERMS[role] = set;
  renderRolePerms();
  $("rbacRoleHint").textContent = `geladen (${set.size})`;
}

function renderRolePerms(){
  const role = $("rbacRoleSelect")?.value || "ps";
  const box = $("rbacRolePermsBox"); if (!box) return;
  const set = __RBAC_ROLE_PERMS[role] || new Set();
  box.innerHTML = buildPermCheckboxes(__RBAC_CATALOG||[], set);
  box.querySelectorAll("input[type=checkbox][data-perm]").forEach(cb=>{
    cb.onchange = ()=>{
      const k = cb.getAttribute("data-perm");
      if (!k) return;
      if (cb.checked) set.add(k); else set.delete(k);
    };
  });
}

async function rbacSaveRole(){
  const role = $("rbacRoleSelect")?.value || "ps";
  const set = __RBAC_ROLE_PERMS[role] || new Set();
  $("rbacRoleHint").textContent = "Speichere‚Ä¶";
  await jpostAuth("/api/auth/admin/rbac/role/set", { role, permKeys: Array.from(set) });
  toast("‚úÖ Rolle gespeichert");
  $("rbacRoleHint").textContent = `gespeichert (${set.size})`;
}

// wire
document.addEventListener("DOMContentLoaded", ()=>{
  if ($("btnRbacLoadRole")) $("btnRbacLoadRole").onclick = rbacLoadRole;
  if ($("btnRbacSaveRole")) $("btnRbacSaveRole").onclick = rbacSaveRole;
  if ($("rbacRoleSelect")) $("rbacRoleSelect").onchange = ()=>{ renderRolePerms(); };
});

</script>
</body>
</html>
