<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Washportal DEV – Schritt 1 (Login + Konfig + Protokoll)</title>
  <style>
    :root{color-scheme:dark}
    body{margin:0;font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#0b1220;color:#e7eefc}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    .card{background:#0f1b33;border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:16px;margin:14px 0;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    h1{font-size:18px;margin:0 0 10px}
    h2{font-size:15px;margin:0 0 10px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    input,textarea,select,button{background:#0b1428;color:#e7eefc;border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:10px}
    input,select{min-width:240px}
    textarea{width:100%;min-height:110px;resize:vertical}
    button{cursor:pointer}
    button.primary{background:linear-gradient(90deg,#2dd4bf,#60a5fa);border:0;color:#051023;font-weight:700}
    button.danger{background:#ef4444;border:0;color:#0b1220;font-weight:700}
    .muted{opacity:.8}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:#0b1428}
    .ok{color:#34d399}
    .bad{color:#fb7185}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,.08);vertical-align:top}
    th{opacity:.85;text-align:left}
    .hidden{display:none !important;}
    pre{margin:0;white-space:pre-wrap;word-break:break-word;background:#07102a;border:1px solid rgba(255,255,255,.08);padding:10px;border-radius:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Washportal DEV – Schritt 1</h1>
      <div class="muted">Nur Grundstein, aber <b>sauber</b>: Login → Token → RBAC → (Konfig + Protokoll) sichtbar/bedienbar nur wenn Perm gesetzt.</div>
      <div style="margin-top:10px" class="row">
        <label class="muted">API Base (Worker)</label>
        <input id="apiBase" />
        <button id="btnStatus">Status</button>
        <span id="statusOut" class="pill muted">—</span>
      </div>
    </div>

    <div class="card" id="cardLogin">
      <h2>Login</h2>
      <div class="row">
        <input id="email" placeholder="E‑Mail" autocomplete="username" />
        <input id="password" placeholder="Passwort" type="password" autocomplete="current-password" />
        <button class="primary" id="btnLogin">Login</button>
        <button id="btnMe">/api/auth/me</button>
        <button id="btnLogout" class="danger">Logout</button>
      </div>
      <div style="margin-top:10px" class="grid">
        <div>
          <div class="muted">Token (sessionStorage: <code>wp_token</code>)</div>
          <pre id="tokenOut">—</pre>
        </div>
        <div>
          <div class="muted">me</div>
          <pre id="meOut">—</pre>
        </div>
      </div>
    </div>

    <div class="card hidden" id="cardConfig">
      <h2>Konfiguration</h2>
      <div class="row">
        <span class="pill" id="permConfigView">view: —</span>
        <span class="pill" id="permConfigManage">manage: —</span>
        <button id="btnConfigLoad">Konfig laden</button>
        <button class="primary" id="btnConfigSave">Konfig speichern</button>
      </div>
      <div class="grid" style="margin-top:10px">
        <div>
          <div class="muted">Konfig JSON (bearbeitbar)</div>
          <textarea id="configJson"></textarea>
        </div>
        <div>
          <div class="muted">Antwort</div>
          <pre id="configOut">—</pre>
        </div>
      </div>
    </div>

    <div class="card hidden" id="cardProtocol">
      <h2>Protokoll</h2>
      <div class="row">
        <span class="pill" id="permProtView">view: —</span>
        <span class="pill" id="permProtCreate">create: —</span>
        <span class="pill" id="permProtEdit">edit: —</span>
        <span class="pill" id="permProtDelete">delete: —</span>
      </div>

      <div class="card" style="margin-top:10px">
        <div class="row">
          <input id="protQ" placeholder="Suche…" />
          <button id="btnProtLoad">Laden</button>
        </div>
        <div style="margin-top:10px; overflow:auto">
          <table>
            <thead>
              <tr>
                <th style="width:160px">Datum</th>
                <th>Titel</th>
                <th>Text</th>
                <th style="width:160px">Aktionen</th>
              </tr>
            </thead>
            <tbody id="protTbody"></tbody>
          </table>
        </div>
      </div>

      <div class="card" style="margin-top:10px">
        <div class="muted">Neu / Bearbeiten</div>
        <div class="row" style="margin-top:8px">
          <input id="protId" placeholder="id (für Update/Delete)" />
          <input id="protTitle" placeholder="Titel" />
        </div>
        <div style="margin-top:8px">
          <textarea id="protBody" placeholder="Text…"></textarea>
        </div>
        <div class="row" style="margin-top:8px">
          <button class="primary" id="btnProtCreate">Anlegen</button>
          <button id="btnProtUpdate">Update</button>
          <button class="danger" id="btnProtDelete">Löschen</button>
        </div>
        <div style="margin-top:8px">
          <pre id="protOut">—</pre>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Debug</h2>
      <div class="muted">Wenn etwas „nicht sichtbar“ ist: es wird hier <b>nicht</b> gerendert, solange <code>me</code> nicht ok ist oder die Perm fehlt.</div>
      <pre id="debugOut">—</pre>
    </div>
  </div>

<script>
(function(){
  const DEFAULT_BASE = "https://washportal-dev-worker.schluffi1220.workers.dev";
  const $ = (id)=>document.getElementById(id);

  function nowIso(ts){
    try{ return new Date(ts).toLocaleString(); }catch(_){ return String(ts||""); }
  }

  function getBase(){
    const v = ($("apiBase").value||"").trim().replace(/\/+$/,"");
    return v || DEFAULT_BASE;
  }

  function setPill(el, ok, label){
    el.textContent = label + ": " + (ok ? "✓" : "✗");
    el.className = "pill " + (ok ? "ok" : "bad");
  }

  function getToken(){
    return sessionStorage.getItem("wp_token") || "";
  }
  function setToken(t){
    if(t) sessionStorage.setItem("wp_token", t);
    else sessionStorage.removeItem("wp_token");
    $("tokenOut").textContent = t ? t : "—";
  }

  async function apiPost(path, bodyObj){
    const base = getBase();
    const url = base + path;
    const token = getToken();
    const headers = {"content-type":"application/json"};
    if(token) headers["authorization"] = "Bearer " + token;
    const res = await fetch(url, {
      method:"POST",
      mode:"cors",
      credentials:"omit",
      headers,
      body: JSON.stringify(bodyObj || {})
    });
    const text = await res.text();
    let json=null;
    try{ json = JSON.parse(text); }catch(_){}
    if(!res.ok){
      const err = {status: res.status, text, json};
      throw err;
    }
    return json ?? {ok:true, raw:text};
  }

  async function apiGet(path){
    const base = getBase();
    const url = base + path;
    const res = await fetch(url, {method:"GET", mode:"cors", credentials:"omit"});
    const text = await res.text();
    let json=null; try{ json=JSON.parse(text);}catch(_){}
    if(!res.ok) throw {status:res.status,text,json};
    return json ?? {ok:true, raw:text};
  }

  function renderVisibility(me){
    const ok = !!(me && me.ok);
    const p = (me && (me.perms || (me.user && me.user.perms))) || {};

    // Reset: hide everything
    $("cardConfig").classList.add("hidden");
    $("cardProtocol").classList.add("hidden");

    // Pills
    setPill($("permConfigView"), !!p["admin.config.view"] || !!p["ps.config.view"] || !!p["sa.all"], "view");
    setPill($("permConfigManage"), !!p["admin.config.manage"] || !!p["sa.all"], "manage");

    setPill($("permProtView"), !!p["protocol.view"] || !!p["sa.all"], "view");
    setPill($("permProtCreate"), !!p["protocol.create"] || !!p["sa.all"], "create");
    setPill($("permProtEdit"), !!p["protocol.edit"] || !!p["sa.all"], "edit");
    setPill($("permProtDelete"), !!p["protocol.delete"] || !!p["sa.all"], "delete");

    // Show sections only if logged in + perm
    if(ok && (p["admin.config.view"] || p["ps.config.view"] || p["sa.all"])) $("cardConfig").classList.remove("hidden");
    if(ok && (p["protocol.view"] || p["sa.all"])) $("cardProtocol").classList.remove("hidden");

    // Button enable
    $("btnConfigSave").disabled = !(ok && (p["admin.config.manage"] || p["sa.all"]));
    $("btnConfigLoad").disabled = !(ok && (p["admin.config.view"] || p["ps.config.view"] || p["sa.all"]));

    $("btnProtCreate").disabled = !(ok && (p["protocol.create"] || p["sa.all"]));
    $("btnProtUpdate").disabled = !(ok && (p["protocol.edit"] || p["sa.all"]));
    $("btnProtDelete").disabled = !(ok && (p["protocol.delete"] || p["sa.all"]));

    $("debugOut").textContent = JSON.stringify({
      loggedIn: ok,
      role: me && me.user && me.user.role,
      role2: me && me.user && me.user.role2,
      permCount: Object.keys(p||{}).length,
      show: {config: !$("cardConfig").classList.contains("hidden"), protocol: !$("cardProtocol").classList.contains("hidden")}
    }, null, 2);
  }

  async function doStatus(){
    $("statusOut").textContent = "…";
    try{
      const j = await apiGet("/api/_status?ts="+Date.now());
      $("statusOut").textContent = (j.ok ? "OK" : "ERR") + " · " + (j.build||"") + " · " + nowIso(j.now);
      $("statusOut").className = "pill " + (j.ok ? "ok" : "bad");
    }catch(e){
      $("statusOut").textContent = "ERR";
      $("statusOut").className = "pill bad";
      console.error("status err", e);
    }
  }

  async function doLogin(){
    const email = ($("email").value||"").trim();
    const password = $("password").value||"";
    $("meOut").textContent = "…";
    try{
      const j = await apiPost("/api/auth/login", {email, password});
      const token = j && (j.token || (j.data && j.data.token));
      setToken(token || "");
      $("meOut").textContent = JSON.stringify(j, null, 2);
      await doMe();
    }catch(e){
      $("meOut").textContent = JSON.stringify(e.json || {status:e.status, text:e.text}, null, 2);
      renderVisibility(null);
    }
  }

  async function doMe(){
    $("meOut").textContent = "…";
    try{
      const j = await apiPost("/api/auth/me", {});
      $("meOut").textContent = JSON.stringify(j, null, 2);
      renderVisibility(j);
      return j;
    }catch(e){
      $("meOut").textContent = JSON.stringify(e.json || {status:e.status, text:e.text}, null, 2);
      renderVisibility(null);
      throw e;
    }
  }

  async function doLogout(){
    setToken("");
    $("meOut").textContent = "—";
    renderVisibility(null);
  }

  async function configLoad(){
    $("configOut").textContent = "…";
    try{
      const j = await apiPost("/api/admin/config/get", {});
      $("configOut").textContent = JSON.stringify(j, null, 2);
      if(j && j.config) $("configJson").value = JSON.stringify(j.config, null, 2);
    }catch(e){
      $("configOut").textContent = JSON.stringify(e.json || {status:e.status, text:e.text}, null, 2);
    }
  }

  async function configSave(){
    $("configOut").textContent = "…";
    let cfg;
    try{
      const raw = ($("configJson").value || "").trim() || "{}";
      cfg = JSON.parse(raw);
    }catch(e){
      $("configOut").textContent = JSON.stringify({ok:false,error:"bad_json",message:e?.message||String(e)}, null, 2);
      toast("Speichern: JSON ungültig");
      return;
    }
    try{
      // Wichtig: Worker erwartet die Felder direkt (nicht {config:{...}})
      const j = await apiPost("/api/admin/config/set", cfg);
      $("configOut").textContent = JSON.stringify(j, null, 2);
      if(j?.ok){
        // UI konsistent halten: gespeicherte Version anzeigen
        if(j.config) $("configJson").value = JSON.stringify(j.config, null, 2);
        toast("Speichern: OK");
      }else{
        toast("Speichern: Fehler");
      }
    }catch(e){
      $("configOut").textContent = JSON.stringify({ok:false,error:"network",message:String(e)}, null, 2);
      toast("Speichern: Fehler");
    }
  }
  }

  function renderProtRows(entries){
    const tb = $("protTbody");
    tb.innerHTML = "";
    for(const it of (entries||[])){
      const tr = document.createElement("tr");
      const dt = document.createElement("td");
      dt.textContent = nowIso(it.createdAt || it.updatedAt);
      const t = document.createElement("td");
      t.textContent = it.title || "";
      const b = document.createElement("td");
      b.textContent = it.body || "";
      const a = document.createElement("td");
      const btn = document.createElement("button");
      btn.textContent = "Übernehmen";
      btn.onclick = ()=>{
        $("protId").value = it.id || "";
        $("protTitle").value = it.title || "";
        $("protBody").value = it.body || "";
      };
      a.appendChild(btn);
      tr.appendChild(dt); tr.appendChild(t); tr.appendChild(b); tr.appendChild(a);
      tb.appendChild(tr);
    }
  }

  async function protLoad(){
    $("protOut").textContent = "…";
    try{
      const q = ($("protQ").value||"").trim();
      const j = await apiPost("/api/auth/protocol/list", {q});
      $("protOut").textContent = JSON.stringify(j, null, 2);
      renderProtRows(j.entries || []);
    }catch(e){
      $("protOut").textContent = JSON.stringify(e.json || {status:e.status, text:e.text}, null, 2);
    }
  }

  async function protCreate(){
    $("protOut").textContent = "…";
    try{
      const title = ($("protTitle").value||"").trim();
      const body = ($("protBody").value||"").trim();
      const j = await apiPost("/api/auth/protocol/create", {title, body});
      $("protOut").textContent = JSON.stringify(j, null, 2);
      await protLoad();
    }catch(e){
      $("protOut").textContent = JSON.stringify(e.json || {status:e.status, text:e.text}, null, 2);
    }
  }

  async function protUpdate(){
    $("protOut").textContent = "…";
    try{
      const id = ($("protId").value||"").trim();
      const title = ($("protTitle").value||"").trim();
      const body = ($("protBody").value||"").trim();
      const j = await apiPost("/api/auth/protocol/update", {id, title, body});
      $("protOut").textContent = JSON.stringify(j, null, 2);
      await protLoad();
    }catch(e){
      $("protOut").textContent = JSON.stringify(e.json || {status:e.status, text:e.text}, null, 2);
    }
  }

  async function protDelete(){
    $("protOut").textContent = "…";
    try{
      const id = ($("protId").value||"").trim();
      const j = await apiPost("/api/auth/protocol/delete", {id});
      $("protOut").textContent = JSON.stringify(j, null, 2);
      await protLoad();
    }catch(e){
      $("protOut").textContent = JSON.stringify(e.json || {status:e.status, text:e.text}, null, 2);
    }
  }

  // Wire
  $("apiBase").value = DEFAULT_BASE;
  setToken(getToken());
  renderVisibility(null);

  $("btnStatus").addEventListener("click", doStatus);
  $("btnLogin").addEventListener("click", doLogin);
  $("btnMe").addEventListener("click", doMe);
  $("btnLogout").addEventListener("click", doLogout);

  $("btnConfigLoad").addEventListener("click", configLoad);
  $("btnConfigSave").addEventListener("click", configSave);

  $("btnProtLoad").addEventListener("click", protLoad);
  $("btnProtCreate").addEventListener("click", protCreate);
  $("btnProtUpdate").addEventListener("click", protUpdate);
  $("btnProtDelete").addEventListener("click", protDelete);

  // Auto status
  doStatus().catch(()=>{});
})();
</script>
</body>
</html>
