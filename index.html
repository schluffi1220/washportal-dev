<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Washportal DEV</title>
  <style>
    :root{
      --bg:#fff; --card:#f7f7f7; --border:#ddd; --text:#111; --muted:#666;
      --green:#22c55e; --blue:#3b82f6; --red:#ef4444; --gray:#9ca3af;
      --btn:#111; --btnText:#fff;

      --pFree: rgba(34,197,94,.18);
      --pBusy: rgba(59,130,246,.18);
      --pDef:  rgba(239,68,68,.18);
      --pNeutral: rgba(156,163,175,.12);

      --bFree: rgba(34,197,94,.55);
      --bBusy: rgba(59,130,246,.55);
      --bDef:  rgba(239,68,68,.55);
      --bNeutral: rgba(156,163,175,.45);
    }

    body{font-family:system-ui,Arial,sans-serif;margin:14px;max-width:1100px;color:var(--text);background:var(--bg)}
    h1{margin:0 0 6px 0}
    .sub{margin:0 0 12px 0;color:var(--muted)}
    .bar{border:1px solid var(--border);border-radius:14px;padding:10px;background:var(--card);margin:10px 0}
    .bar.ok{background:#eaffea;border-color:#a6e3a6}
    .bar.err{background:#ffecec;border-color:#f2b3b3}
    .card{border:1px solid var(--border);border-radius:14px;padding:12px;background:var(--card);margin:12px 0}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:700px){.row{grid-template-columns:1fr}}
    label{display:block;margin:8px 0 4px;color:var(--muted);font-size:13px}
    input,select,button,textarea{font-size:16px;padding:10px;border-radius:12px;border:1px solid var(--border);width:100%;box-sizing:border-box}
    button{cursor:pointer;background:var(--btn);color:var(--btnText);border-color:var(--btn)}
    button:disabled{opacity:.45;cursor:not-allowed}
    .muted{color:var(--muted);font-size:13px}
    .small{font-size:12px;color:var(--muted)}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .btn2{width:auto;padding:10px 14px}
    .ghost{background:#fff;color:#111;border-color:var(--border)}

    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    @media (max-width:700px){.grid{grid-template-columns:1fr}}

    .mcard{border:2px solid var(--border);border-radius:16px;padding:12px;background:#fff;}
    .mcard.free{background:var(--pFree); border-color: var(--bFree);}
    .mcard.busy{background:var(--pBusy); border-color: var(--bBusy);}
    .mcard.def{ background:var(--pDef);  border-color: var(--bDef);}
    .mcard.neutral{background:var(--pNeutral); border-color: var(--bNeutral);}

    .mhead{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:flex-start}
    .mtitle{font-weight:900}
    .badge{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);border-radius:999px;padding:4px 10px;font-size:12px;background:#fff}
    .dot{width:14px;height:14px;border-radius:999px;background:var(--gray)}
    .dot.free{background:var(--green)}
    .dot.busy{background:var(--blue)}
    .dot.def{background:var(--red)}
    .line{margin-top:8px;color:var(--muted);font-size:13px}
    .mactions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .mbtn{width:auto}
    .danger{background:var(--red);border-color:var(--red)}
    .info{background:var(--blue);border-color:var(--blue)}
    .okbtn{background:var(--green);border-color:var(--green)}

    .bcard{border:2px solid var(--border);border-radius:14px;padding:12px;margin:8px 0;background:#fff;}
    .bcard.free{background:var(--pFree); border-color: var(--bFree);}
    .bcard.busy{background:var(--pBusy); border-color: var(--bBusy);}
    .bcard.def{ background:var(--pDef);  border-color: var(--bDef);}
    .bhead{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
  </style>
</head>
<body>

<h1>Washportal – DEV</h1>
<p class="sub">1 Zugang → 2 Slot-Dropdown → 3 Maschinenübersicht → 4 Meine Buchungen → 5 Feedback → 6 Admin</p>

<div id="statusBox" class="bar">Bereit.</div>

<div class="card">
  <h2>1) Zugang</h2>
  <div class="row">
    <div>
      <label>Zimmernummer (0–400)</label>
      <input id="room" inputmode="numeric" placeholder="z.B. 316">
    </div>
    <div>
      <label>PIN (4–12 Ziffern)</label>
      <input id="pin" type="password" inputmode="numeric" placeholder="z.B. 1234">
    </div>
  </div>
  <label>Stations-PIN (4-stellig)</label>
  <input id="stationPin" type="password" inputmode="numeric" placeholder="z.B. 1111">
  <div class="actions">
    <button id="btnRefresh" class="btn2">Aktualisieren</button>
  </div>
</div>

<div class="card">
  <h2>2) Slots buchen</h2>
  <label>Slots (Waschmaschinen)</label>
  <select id="slotSelect">
    <option value="">Bitte erst aktualisieren…</option>
  </select>
  <div class="actions">
    <button id="btnBook" class="btn2">Buchen</button>
  </div>
  <div class="small">Belegt/Defekt/Abgelaufen werden angezeigt, sind aber nicht auswählbar.</div>
</div>

<div class="card">
  <h2>3) Maschinenübersicht</h2>
  <div class="muted">Grün = frei · Blau = belegt · Rot = defekt</div>

  <h3 style="margin:10px 0 6px 0;">Waschmaschinen</h3>
  <div id="washers" class="grid"></div>

  <h3 style="margin:12px 0 6px 0;">Trockner</h3>
  <div id="dryers" class="grid"></div>
</div>

<div class="card">
  <h2>4) Meine Buchungen</h2>
  <div class="actions">
    <button id="btnMy" class="btn2">Meine Buchungen aktualisieren</button>
  </div>
  <div id="myBookings" class="muted" style="margin-top:10px;">Noch nicht geladen.</div>
</div>

<div class="card">
  <h2>5) Feedback / Antworten</h2>
  <div class="muted">Backend kommt als nächster Schritt.</div>
  <label>Nachricht</label>
  <textarea id="fbText" rows="3" placeholder="Feedback…"></textarea>
  <div class="actions">
    <button class="btn2" disabled>Feedback senden (kommt)</button>
  </div>
</div>

<script>
  const API_BASE = "https://washportal-dev-worker.schluffi1220.workers.dev";
  const $ = (id) => document.getElementById(id);

  let cachedWasherSlots = [];
  let cachedStatus = null;

  function setStatus(msg, ok=true){
    const el = $("statusBox");
    el.className = "bar " + (ok ? "ok" : "err");
    el.textContent = msg;
  }

  async function jget(path){
    const r = await fetch(API_BASE + path, { cache:"no-store" });
    const data = await r.json().catch(()=>({ok:false,error:"bad_json"}));
    return { r, data };
  }
  async function jpost(path, body){
    const r = await fetch(API_BASE + path, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(body||{}),
      cache:"no-store"
    });
    const data = await r.json().catch(()=>({ok:false,error:"bad_json"}));
    return { r, data };
  }

  function accessPayload(){
    return {
      room: $("room").value.trim(),
      pin: $("pin").value.trim(),
      stationPin: $("stationPin").value.trim()
    };
  }

  function pad(n){ return String(n).padStart(2,"0"); }
  function fmtSlot(start, end){
    const a = new Date(start), b = new Date(end);
    const ddmmyy = `${pad(a.getDate())}.${pad(a.getMonth()+1)}.${String(a.getFullYear()).slice(-2)}`;
    const t1 = `${pad(a.getHours())}:${pad(a.getMinutes())}`;
    const t2 = `${pad(b.getHours())}:${pad(b.getMinutes())}`;
    return `${ddmmyy} ${t1}–${t2}`;
  }
  function msToHMS(ms){
    const s = Math.max(0, Math.floor(ms/1000));
    const h = Math.floor(s/3600);
    const m = Math.floor((s%3600)/60);
    return h>0 ? `${h}h ${m}m` : `${m}m`;
  }

  function rebuildSlotDropdown(){
    const sel = $("slotSelect");
    sel.innerHTML = "";
    const now = Date.now();

    const items = [];
    for (const s of cachedWasherSlots) {
      for (const pm of (s.perMachine || [])) {
        const isPast = Number(s.end) <= now;
        const state = isPast ? "abgelaufen" : (pm.defect ? "defekt" : (pm.booked ? "belegt" : "frei"));
        const disabled = (state !== "frei");
        items.push({
          label: `${fmtSlot(s.start, s.end)} · Waschmaschine ${pm.machine} · ${state}`,
          disabled,
          payload: { start:s.start, end:s.end, machine:pm.machine }
        });
      }
    }

    if (!items.length) {
      sel.innerHTML = `<option value="">Keine Slots verfügbar</option>`;
      return;
    }

    sel.appendChild(new Option("Bitte auswählen…", ""));
    items.forEach((it, idx) => {
      const opt = new Option(it.label, String(idx));
      opt.disabled = it.disabled;
      sel.appendChild(opt);
    });
    sel._items = items;
  }

  async function bookSelected(){
    const sel = $("slotSelect");
    const idx = Number(sel.value);
    if (!sel.value || !sel._items || !sel._items[idx]) {
      alert("Bitte einen freien Slot auswählen.");
      return;
    }
    const it = sel._items[idx];
    if (it.disabled) {
      alert("Dieser Slot ist nicht buchbar.");
      return;
    }

    const p = accessPayload();
    const {data} = await jpost("/api/washer/book", { ...p, ...it.payload });

    if (!data.ok) {
      setStatus("Buchen fehlgeschlagen: " + (data.message || data.error), false);
      alert(JSON.stringify(data, null, 2));
      return;
    }

    alert(`Gebucht: Waschmaschine ${data.machine}`);
    await refreshAll();
  }

  async function cancelBooking(id){
    const p = accessPayload();
    const {data} = await jpost("/api/booking/cancel", { ...p, id });
    if (!data.ok) { alert(JSON.stringify(data,null,2)); return; }
    await refreshAll();
  }

  async function releaseBooking(id){
    const p = accessPayload();
    const {data} = await jpost("/api/booking/release", { ...p, id });
    if (!data.ok) { alert(JSON.stringify(data,null,2)); return; }
    await refreshAll();
  }

  function renderMachines(){
    if (!cachedStatus || !cachedStatus.ok) return;

    const now = Date.now();
    const machines = cachedStatus.machines || [];
    const bookings = (cachedStatus.bookings || []).filter(b => b.status === "booked");
    const myRoom = $("room").value.trim();

    function activeBooking(type, machine){
      return bookings.find(b =>
        b.type===type &&
        Number(b.machine)===Number(machine) &&
        now>=Number(b.start) && now<Number(b.end)
      );
    }

    function cardHTML(m){
      const type = m.type;
      const machine = m.machine;
      const defect = Number(m.defect)===1;
      const enabled = Number(m.enabled)===1;

      const active = (!defect && enabled) ? activeBooking(type, machine) : null;

      let stateClass = "free";
      let dotCls = "dot free";
      let badgeText = "frei";

      if (!enabled) { stateClass="neutral"; dotCls="dot.busy"; badgeText="gesperrt"; }
      else if (defect) { stateClass="def"; dotCls="dot def"; badgeText="defekt"; }
      else if (active) { stateClass="busy"; dotCls="dot busy"; badgeText="belegt"; }

      let line1 = "";
      if (!enabled) line1 = `Maschine gesperrt.`;
      else if (defect) line1 = `Defekt gemeldet von: ${m.defectBy || "-"}`;
      else if (active) line1 = `Belegt von Zimmer ${active.room} · Rest: ${msToHMS(Number(active.end)-now)}`;
      else line1 = `Frei · zuletzt: ${m.lastRoom ? ("Zimmer " + m.lastRoom) : "-"}`;

      const btns = [];

      // Defekt toggle
      if (enabled) {
        if (!defect) btns.push(`<button class="mbtn danger" onclick="setDefect('${type}',${machine},true)">Defekt melden</button>`);
        else btns.push(`<button class="mbtn okbtn" onclick="setDefect('${type}',${machine},false)">Defekt freigeben</button>`);
      }

      // ✅ Freigeben: nur wenn Slot läuft und deine Buchung aktiv ist
      if (active && String(active.room) === String(myRoom) && active.id) {
        btns.push(`<button class="mbtn info" onclick="releaseBooking('${active.id}')">Freigeben</button>`);
      }

      return `
        <div class="mcard ${stateClass}">
          <div class="mhead">
            <div>
              <div class="mtitle">${type==="washer"?"Waschmaschine":"Trockner"} ${machine}</div>
              <div class="line">${line1}</div>
            </div>
            <div class="badge"><span class="${dotCls}"></span>${badgeText}</div>
          </div>
          <div class="mactions">${btns.join("") || `<span class="muted">—</span>`}</div>
        </div>
      `;
    }

    $("washers").innerHTML = machines.filter(m=>m.type==="washer").map(cardHTML).join("") || `<div class="muted">Keine Waschmaschinen.</div>`;
    $("dryers").innerHTML  = machines.filter(m=>m.type==="dryer").map(cardHTML).join("")  || `<div class="muted">Keine Trockner.</div>`;
  }

  async function setDefect(type, machine, defect){
    const p = accessPayload();
    const {data} = await jpost("/api/machine/set-defect", { ...p, type, machine, defect });
    if (!data.ok) { alert(JSON.stringify(data,null,2)); return; }
    await refreshAll();
  }
  window.setDefect = setDefect;
  window.releaseBooking = releaseBooking;

  async function loadMyBookings(){
    const p = accessPayload();
    const {data} = await jpost("/api/my-bookings", p);
    if (!data.ok) { alert(JSON.stringify(data,null,2)); return; }

    const list = data.bookings || [];
    if (!list.length) {
      $("myBookings").innerHTML = `<div class="muted">Keine Buchungen.</div>`;
      return;
    }

    const now = Date.now();
    $("myBookings").innerHTML = list.map(b=>{
      const start = Number(b.start);
      const end = Number(b.end);
      const active = (start <= now && now < end);
      const future = (now < start);
      const expired = (end <= now);

      const state = active ? "busy" : "free";
      const title = `${b.type==="washer"?"Waschmaschine":"Trockner"} ${b.machine}`;
      const time = fmtSlot(start, end);
      const left = active ? ` · Rest: ${msToHMS(end-now)}` : "";

      let buttons = "";

      // ✅ Storno = nur vor Start
      if (future) {
        buttons = `<button class="btn2 ghost" onclick="cancelBooking('${b.id}')">Stornieren</button>`;
      }
      // ✅ Freigeben = nur während Slot läuft
      else if (active) {
        buttons = `<button class="btn2 info" onclick="releaseBooking('${b.id}')">Freigeben</button>`;
      }
      // ❌ abgelaufen = nix
      else if (expired) {
        buttons = `<button class="btn2 ghost" disabled>Abgelaufen</button>`;
      }

      return `
        <div class="bcard ${state}">
          <div class="bhead">
            <div><b>${title}</b></div>
            <div class="muted">${time}${left}</div>
          </div>
          <div class="actions">${buttons}</div>
        </div>
      `;
    }).join("");
  }

  async function refreshAll(){
    setStatus("Aktualisiere…", true);

    const p = accessPayload();

    const a = await jpost("/api/washer/free-slots", p);
    if (!a.data.ok) {
      setStatus("Fehler Slots: " + (a.data.message || a.data.error), false);
      alert(JSON.stringify(a.data,null,2));
      return;
    }
    cachedWasherSlots = a.data.slots || [];
    rebuildSlotDropdown();

    const s = await jget("/api/status");
    cachedStatus = s.data;
    if (!cachedStatus.ok) {
      setStatus("Fehler Status: " + (cachedStatus.message || cachedStatus.error), false);
      alert(JSON.stringify(cachedStatus,null,2));
      return;
    }

    renderMachines();
    await loadMyBookings();
    setStatus("Bereit.", true);
  }

  $("btnRefresh").onclick = refreshAll;
  $("btnBook").onclick = bookSelected;
  $("btnMy").onclick = loadMyBookings;

  setStatus("Bereit. Worker: " + API_BASE, true);
</script>

</body>
</html>
