<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Wash-Portal</title>
  <style>
    :root{
      --bg:#0b1020;--card:#121a33;--text:#e9eefc;--muted:#a9b4d6;
      --ok:#2ecc71;--busy:#4aa3ff;--bad:#ff4d6d;--warn:#f7b500;
      --p-ok:rgba(46,204,113,.18);
      --p-busy:rgba(74,163,255,.18);
      --p-bad:rgba(255,77,109,.22);
      --p-off:rgba(255,77,109,.14);
      --p-muted:rgba(255,255,255,.06);
      --border:rgba(255,255,255,.10);
    }
    [data-theme="contrast"]{
      --ok:#00ffb3;--busy:#00b7ff;--bad:#ff00ff;
      --p-ok:rgba(0,255,179,.22);
      --p-busy:rgba(0,183,255,.22);
      --p-bad:rgba(255,0,255,.22);
    }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#070a14,#0b1020);color:var(--text);}
    .wrap{max-width:980px;margin:0 auto;padding:16px;}
    h1{margin:8px 0 4px;font-size:22px;}
    .muted{color:var(--muted);}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;margin-top:12px;box-shadow:0 10px 24px rgba(0,0,0,.25);}
    .title{font-weight:700;margin-bottom:8px;}
    input,select,button,textarea{font:inherit;border-radius:10px;border:1px solid var(--border);background:rgba(255,255,255,.06);color:var(--text);padding:10px;}
    input::placeholder,textarea::placeholder{color:rgba(233,238,252,.55);}
    button{cursor:pointer;background:rgba(255,255,255,.10)}
    button:hover{background:rgba(255,255,255,.14)}
    button:disabled{opacity:.5;cursor:not-allowed}
    textarea{width:100%;min-height:88px;resize:vertical;}
    details summary{cursor:pointer;user-select:none}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;}
    @media (min-width:700px){.grid{grid-template-columns:repeat(4,1fr)}}
    .pill{display:inline-flex;align-items:center;gap:8px;border-radius:999px;padding:6px 10px;border:1px solid var(--border);background:rgba(255,255,255,.05);font-size:12px}
    .dot{width:12px;height:12px;border-radius:999px;display:inline-block}
    .dot.ok{background:var(--ok)} .dot.busy{background:var(--busy)} .dot.bad{background:var(--bad)}
    .kachel{border-radius:14px;padding:10px;border:1px solid var(--border);background:var(--p-muted)}
    .kachel.ok{background:var(--p-ok)} .kachel.busy{background:var(--p-busy)} .kachel.bad{background:var(--p-bad)} .kachel.off{background:var(--p-off)}
    .small{font-size:12px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .sep{height:1px;background:var(--border);margin:10px 0}
    .right{margin-left:auto}
    .badge{display:inline-flex;align-items:center;justify-content:center;min-width:22px;height:22px;border-radius:999px;background:var(--bad);color:#fff;font-size:12px;padding:0 6px}
  </style>
</head>
<body>
<div class="wrap" id="app">
  <h1>Wash-Portal</h1>
  <div class="muted small">Build: <span id="build">–</span></div>

  <div class="card">
    <div class="row">
      <div class="pill"><span class="dot ok"></span> Frei</div>
      <div class="pill"><span class="dot busy"></span> Belegt</div>
      <div class="pill"><span class="dot bad"></span> Defekt/Gesperrt</div>
      <div class="right small muted" id="status">Bereit.</div>
    </div>
  </div>

  <!-- NEWS -->
  <details class="card" id="newsDetails">
    <summary class="title">Was ist neu? <span id="newsBadge" class="badge" style="display:none;">!</span></summary>
    <div id="newsText" class="small muted">Keine News.</div>
    <div class="row" style="margin-top:10px;">
      <button onclick="dismissNews()">Als gelesen</button>
    </div>
  </details>

  <!-- 1) Zugang -->
  <div class="card">
    <div class="title">1) Zugang</div>
    <div class="row">
      <input id="room" inputmode="numeric" placeholder="Zimmer (0–400)" />
      <input id="pin" type="password" inputmode="numeric" placeholder="PIN (4-stellig)" />
      <input id="stationPin" type="password" inputmode="numeric" placeholder="Stations-PIN" />
      <button onclick="refreshAll()">Aktualisieren</button>
    </div>
    <div class="small muted" style="margin-top:8px;">Tipp: PIN/Stations-PIN werden nicht gespeichert – nur Hash im Backend.</div>
  </div>

  <!-- 2) Slots buchen -->
  <div class="card">
    <div class="title">2) Slots buchen</div>
    <div class="row">
      <select id="slotSelect" style="flex:1;min-width:240px;"></select>
      <button onclick="bookSelected()">Buchen</button>
    </div>
    <div class="small muted" style="margin-top:8px;">
      Waschmaschinen: Slot = 2h, Startzeiten per Admin. Buchung in Vergangenheit nur, wenn Slot noch läuft. Abgelaufene Slots nicht buchbar.
    </div>
  </div>

  <!-- 3) Maschinenübersicht -->
  <div class="card">
    <div class="title">3) Maschinenübersicht</div>
    <div class="grid" id="machinesGrid"></div>
    <div class="small muted" style="margin-top:10px;">
      Freigeben = Slot läuft, aber du bist fertig (Maschine wird sofort frei, "zuletzt benutzt" bleibt).
    </div>
  </div>

  <!-- 4) Meine Buchungen -->
  <div class="card">
    <div class="title">4) Meine Buchungen</div>
    <div id="myBookings"></div>
  </div>

  <!-- 5) Feedback -->
  <div class="card">
    <div class="title">5) Feedback / Antworten <span id="fbBadge" class="badge" style="display:none;">!</span></div>
    <textarea id="fbText" placeholder="Problem melden / Feedback ..."></textarea>
    <div class="row" style="margin-top:8px;">
      <button onclick="sendFeedback()">Absenden</button>
      <button onclick="loadMyFeedback()">Meine Threads laden</button>
    </div>
    <div id="fbThreads" style="margin-top:10px;"></div>
  </div>

  <!-- 6) Admin -->
  <details class="card" id="adminDetails">
    <summary class="title">6) Admin</summary>

    <div class="row" style="margin-top:10px;">
      <input id="adminPw" type="password" placeholder="Admin Passwort" />
      <button onclick="adminLogin()">Login</button>
      <button onclick="adminLogout()" id="adminLogoutBtn" style="display:none;">Logout</button>
      <span class="small muted" id="adminState">Nicht eingeloggt</span>
    </div>

    <div class="sep"></div>

    <div class="card" style="margin-top:0;">
      <div class="title">Stations-PIN setzen</div>
      <div class="row">
        <input id="adminStationPin" type="password" inputmode="numeric" placeholder="z. B. 1111" />
        <button onclick="adminSetStationPin()">Speichern</button>
      </div>
    </div>

    <div class="card">
      <div class="title">Admin-Passwort ändern</div>
      <div class="row">
        <input id="oldAdminPw" type="password" placeholder="altes Passwort" />
        <input id="newAdminPw" type="password" placeholder="neues Passwort (min. 6)" />
        <button onclick="adminChangePw()">Ändern</button>
      </div>
    </div>

    <div class="card">
      <div class="title">Wasch-Startzeiten (Haken)</div>
      <div class="small muted">0–23 Uhr – nur markierte Stunden werden angeboten.</div>
      <div id="washerHoursBox" class="row" style="margin-top:8px;gap:6px;"></div>
      <div class="row" style="margin-top:10px;">
        <button onclick="adminSaveWasherHours()">Speichern</button>
      </div>
    </div>

    <div class="card">
      <div class="title">Trockner-Laufzeit</div>
      <select id="dryerMinutes">
        <option value="60">1 Stunde</option>
        <option value="90">1,5 Stunden</option>
        <option value="120">2 Stunden</option>
      </select>
      <div class="row" style="margin-top:10px;">
        <button onclick="adminSaveDryerMinutes()">Speichern</button>
      </div>
    </div>

    <div class="card">
      <div class="title">Tage-Fenster</div>
      <div class="row">
        <input id="daysPast" inputmode="numeric" placeholder="Vergangen (Tage)" />
        <input id="daysFuture" inputmode="numeric" placeholder="Zukunft (Tage)" />
        <button onclick="adminSaveWindow()">Speichern</button>
      </div>
    </div>

    <div class="card">
      <div class="title">User darf Defekt melden?</div>
      <label>Erlaubt</label>
      <select id="userDefectEnabled">
        <option value="true">Ja</option>
        <option value="false">Nein</option>
      </select>
      <div class="row" style="margin-top:10px;">
        <button onclick="adminSaveDefectEnabled()">Speichern</button>
      </div>

      <div class="small muted" style="margin-top:8px;">Welche Geräte dürfen User als defekt/frei melden?</div>
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-top:6px;">
        <div class="small"><b>Wasch</b></div><div></div><div></div><div></div>
        <label class="small"><input type="checkbox" id="uda_w_1"> W1</label>
        <label class="small"><input type="checkbox" id="uda_w_2"> W2</label>
        <label class="small"><input type="checkbox" id="uda_w_3"> W3</label>
        <label class="small"><input type="checkbox" id="uda_w_4"> W4</label>

        <div class="small"><b>Trock</b></div><div></div><div></div><div></div>
        <label class="small"><input type="checkbox" id="uda_d_1"> T1</label>
        <label class="small"><input type="checkbox" id="uda_d_2"> T2</label>
        <label class="small"><input type="checkbox" id="uda_d_3"> T3</label>
        <label class="small"><input type="checkbox" id="uda_d_4"> T4</label>
      </div>
      <button style="margin-top:10px;" onclick="adminSaveDefectAllowed()">Geräte-Rechte speichern</button>
    </div>

    <div class="card">
      <div class="title">Design</div>
      <select id="uiTheme">
        <option value="standard">Standard</option>
        <option value="contrast">High Contrast (Magenta)</option>
      </select>
      <div class="row" style="margin-top:10px;">
        <button onclick="adminSaveTheme()">Speichern</button>
      </div>
    </div>

    <div class="card">
      <div class="title">News (Was ist neu?)</div>
      <label><input type="checkbox" id="adminNewsEnabled" /> aktiv</label>
      <textarea id="adminNewsText" placeholder="Text..."></textarea>
      <div class="row" style="margin-top:10px;">
        <button onclick="adminSaveNews()">Speichern (Version++)</button>
      </div>
      <div class="small muted" style="margin-top:8px;" id="newsStats">Zähler: –</div>
    </div>

    <div class="card">
      <div class="title">Feedback (Admin)</div>
      <div class="row">
        <button onclick="adminLoadThreads()">Threads laden</button>
      </div>
      <div id="adminThreads" style="margin-top:10px;"></div>
    </div>
  </details>
</div>

<script>
  // ========= CONFIG =========
  // Set this to your Worker base URL
  const API_BASE = "https://washportal-dev-worker.schluffi1220.workers.dev";

  const state = {
    build: "",
    cfg: null,
    machines: [],
    washerSlots: [],
    myBookings: [],
    bookings: [],
    adminToken: "",
    adminExp: 0,
    news: null,
    feedbackBadge: null
  };

  const $ = (id) => document.getElementById(id);

  function setStatus(s){ $("status").textContent = s; }

  async function jpost(path, body){
    const r = await fetch(API_BASE + path, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(body||{})
    });
    const data = await r.json().catch(()=>({ok:false,error:"bad_json"}));
    return { r, data };
  }

  async function jget(path){
    const r = await fetch(API_BASE + path);
    const data = await r.json().catch(()=>({ok:false,error:"bad_json"}));
    return { r, data };
  }

  function fmtRange(start,end){
    const s = new Date(start);
    const e = new Date(end);
    const ds = s.toLocaleDateString("de-DE");
    const ts = s.toLocaleTimeString("de-DE",{hour:"2-digit",minute:"2-digit"});
    const te = e.toLocaleTimeString("de-DE",{hour:"2-digit",minute:"2-digit"});
    return `${ds} ${ts}–${te}`;
  }

  function nowMs(){ return Date.now(); }

  function adminTokenAlive(){
    return state.adminToken && Date.now() < state.adminExp;
  }

  function applyTheme(){
    const t = state.cfg?.uiTheme || "standard";
    document.documentElement.setAttribute("data-theme", t === "contrast" ? "contrast" : "standard");
  }

  // ========= UI BUILDERS =========
  function buildWasherHoursCheckboxes(){
    const box = $("washerHoursBox");
    box.innerHTML = "";
    for(let h=0;h<=23;h++){
      const id = `wh_${h}`;
      const label = document.createElement("label");
      label.className="small";
      label.style.display="inline-flex";
      label.style.alignItems="center";
      label.style.gap="6px";
      label.innerHTML = `<input type="checkbox" id="${id}" value="${h}"> ${String(h).padStart(2,"0")}:00`;
      box.appendChild(label);
    }
  }

  function renderSlotsDropdown(){
    const sel = $("slotSelect");
    sel.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = "Bitte auswählen…";
    sel.appendChild(opt0);

    const slots = state.washerSlots || [];
    const now = nowMs();

    for(const slot of slots){
      // build per-machine entries
      for(const m of slot.machines){
        const machineTxt = `Maschine ${m.machine}`;
        let label = `${fmtRange(slot.start, slot.end)} – ${machineTxt}`;

        let disabled = false;
        let reason = "";

        if(!m.enabled){ disabled = true; reason = "gesperrt"; }
        if(m.defect){ disabled = true; reason = "defekt"; }
        if(m.taken){ disabled = true; reason = "belegt"; }
        if(now >= slot.end){ disabled = true; reason = "abgelaufen"; }

        if(reason) label += ` (${reason})`;

        const opt = document.createElement("option");
        opt.value = JSON.stringify({ start: slot.start, machine: m.machine });
        opt.textContent = label;
        opt.disabled = disabled;
        sel.appendChild(opt);
      }
    }
  }

  function machineCard(type, machine, ms, runningInfo){
    const div = document.createElement("div");
    div.className = "kachel";

    const enabled = !!ms.enabled;
    const defect = !!ms.defect;

    let status = "ok";
    let statusTxt = "Frei";
    if(!enabled){ status="off"; statusTxt="Gesperrt"; }
    else if(defect){ status="bad"; statusTxt="Defekt"; }
    else if(runningInfo?.running){ status="busy"; statusTxt="Belegt"; }

    div.classList.add(status);

    const who = runningInfo?.running ? `Zimmer ${runningInfo.room}` : (ms.lastRoom ? `zuletzt: ${ms.lastRoom}` : "zuletzt: –");
    const until = runningInfo?.running ? `bis ${new Date(runningInfo.end).toLocaleTimeString("de-DE",{hour:"2-digit",minute:"2-digit"})}` : "";

    div.innerHTML = `
      <div class="row" style="margin:0">
        <div class="title" style="margin:0">${type==="washer"?"Wasch":"Trock"} ${machine}</div>
        <div class="right pill"><span class="dot ${status==="ok"?"ok":status==="busy"?"busy":"bad"}"></span> ${statusTxt}</div>
      </div>
      <div class="small muted" style="margin-top:6px;">${who} ${until}</div>
      <div class="row" style="margin-top:10px;gap:8px;flex-wrap:wrap;">
        <button ${runningInfo?.canRelease ? "" : "disabled"} onclick="releaseBooking('${runningInfo?.id||""}')">Freigeben</button>
        <button ${type==="dryer" ? "" : "disabled"} onclick="bookDryer(${machine})">Trockner buchen</button>
        <button onclick="toggleDefect('${type}',${machine},${defect?0:1})">${defect ? "Defekt aufheben" : "Defekt melden"}</button>
      </div>
    `;
    return div;
  }

  function renderMachines(){
    const grid = $("machinesGrid");
    grid.innerHTML = "";

    const machines = state.machines || [];
    const bookings = state.bookings || [];
    const now = nowMs();

    // current running bookings by machine
    function runningFor(type, machine){
      const b = bookings.find(x => x.type===type && x.machine===machine && x.status==="booked" && x.start <= now && x.end > now);
      if(!b) return { running:false };
      // Only the same user can release
      const room = $("room").value.trim();
      const canRelease = (b.room === room);
      return { running:true, room:b.room, end:b.end, id:b.id, canRelease };
    }

    for(const ms of machines){
      const r = runningFor(ms.type, ms.machine);
      grid.appendChild(machineCard(ms.type, ms.machine, ms, r));
    }
  }

  function renderMyBookings(){
    const box = $("myBookings");
    const items = state.myBookings || [];
    if(!items.length){
      box.innerHTML = `<div class="small muted">Keine Buchungen.</div>`;
      return;
    }
    const now = nowMs();
    const machines = state.machines || [];

    const getMs = (type,machine) => machines.find(x=>x.type===type && x.machine===machine) || {enabled:1,defect:0,lastRoom:""};

    box.innerHTML = "";
    for(const b of items){
      // color
      const ms = getMs(b.type, b.machine);
      const running = b.status==="booked" && b.start<=now && b.end>now;

      let cls="kachel";
      if(!ms.enabled) cls+=" off";
      else if(ms.defect) cls+=" bad";
      else if(running) cls+=" busy";
      else cls+=" ok";

      const div = document.createElement("div");
      div.className = cls;
      div.style.marginTop="8px";

      const title = `${b.type==="washer"?"Wasch":"Trock"} ${b.machine} – ${fmtRange(b.start,b.end)}`;
      const st = b.status==="booked" ? (now>=b.end ? "abgelaufen" : (running ? "läuft" : "gebucht")) : b.status;
      const actions = [];

      // cancel only for washer and only if not ended
      if(b.type==="washer" && b.status==="booked" && now < b.end){
        actions.push(`<button onclick="cancelBooking('${b.id}')">Stornieren</button>`);
      }
      // release if running
      if(b.status==="booked" && b.start<=now && b.end>now){
        actions.push(`<button onclick="releaseBooking('${b.id}')">Freigeben</button>`);
      }

      div.innerHTML = `
        <div class="row" style="margin:0">
          <div class="title" style="margin:0">${title}</div>
          <div class="right small muted">${st}</div>
        </div>
        <div class="row" style="margin-top:10px;gap:8px;flex-wrap:wrap;">
          ${actions.join("")}
        </div>
      `;
      box.appendChild(div);
    }
  }

  function renderNews(news){
    state.news = news || null;
    if(!news || !news.text){
      $("newsText").textContent = "Keine News.";
      $("newsBadge").style.display = "none";
      return;
    }
    $("newsText").textContent = news.text;
    if(news.hasNew){
      $("newsBadge").style.display = "inline-flex";
      // open once when new
      $("newsDetails").open = true;
      // one-time popup
      alert("Neue Info im Wash-Portal (oben bei „Was ist neu?“).");
    } else {
      $("newsBadge").style.display = "none";
      $("newsDetails").open = false;
    }
  }

  function renderFeedbackBadge(badge){
    state.feedbackBadge = badge || null;
    if(badge?.hasNew){
      $("fbBadge").style.display = "inline-flex";
      alert("Neue Antwort im Feedback!");
    } else {
      $("fbBadge").style.display = "none";
    }
  }

  // ========= MAIN FLOW =========
  buildWasherHoursCheckboxes();

  async function refreshAll(){
    setStatus("Lade…");
    const room = $("room").value.trim();
    const pin = $("pin").value.trim();
    const stationPin = $("stationPin").value.trim();

    if(!room || !pin || !stationPin){
      alert("Bitte Zimmernummer, PIN und Stations-PIN eingeben.");
      setStatus("Bereit.");
      return;
    }

    const {data} = await jpost("/api/user/refresh",{room,pin,stationPin});
    if(!data.ok){
      alert(JSON.stringify(data,null,2));
      setStatus("Bereit.");
      return;
    }

    $("build").textContent = data.build;
    state.build = data.build;
    state.cfg = data.config;
    state.machines = data.machines || [];
    state.washerSlots = data.washerSlots || [];
    state.bookings = data.bookings || [];
    state.myBookings = data.myBookings || [];

    // Admin UI initial fill
    $("daysPast").value = state.cfg.daysPast;
    $("daysFuture").value = state.cfg.daysFuture;
    $("dryerMinutes").value = String(state.cfg.dryerMinutes || 120);
    $("userDefectEnabled").value = String(!!state.cfg.userDefectEnabled);
    // per-device defect allowed
    const uda = state.cfg.userDefectAllowed || {washer:{},dryer:{}};
    $("uda_w_1").checked = !!uda.washer?.["1"];
    $("uda_w_2").checked = !!uda.washer?.["2"];
    $("uda_w_3").checked = !!uda.washer?.["3"];
    $("uda_w_4").checked = !!uda.washer?.["4"];
    $("uda_d_1").checked = !!uda.dryer?.["1"];
    $("uda_d_2").checked = !!uda.dryer?.["2"];
    $("uda_d_3").checked = !!uda.dryer?.["3"];
    $("uda_d_4").checked = !!uda.dryer?.["4"];

    $("uiTheme").value = state.cfg.uiTheme || "standard";
    $("adminNewsText").value = state.cfg.newsText || "";
    $("adminNewsEnabled").checked = !!state.cfg.newsEnabled;

    // washer hours checkboxes
    for(let h=0;h<=23;h++){
      const cb = $("wh_"+h);
      cb.checked = (state.cfg.washerHours||[]).includes(h);
    }

    applyTheme();

    renderSlotsDropdown();
    renderMachines();
    renderMyBookings();
    renderNews(data.news);
    renderFeedbackBadge(data.feedbackBadge);

    setStatus("Bereit.");
  }

  async function bookSelected(){
    const v = $("slotSelect").value;
    if(!v){ alert("Bitte Slot wählen."); return; }
    const sel = JSON.parse(v);
    const room = $("room").value.trim();
    const pin = $("pin").value.trim();
    const stationPin = $("stationPin").value.trim();

    const {data} = await jpost("/api/washer/book",{
      room,pin,stationPin,
      start: sel.start,
      machine: sel.machine
    });

    if(!data.ok){ alert(JSON.stringify(data,null,2)); return; }
    alert("Gebucht.");
    await refreshAll();
  }

  async function cancelBooking(id){
    const room = $("room").value.trim();
    const pin = $("pin").value.trim();
    const {data} = await jpost("/api/booking/cancel",{room,pin,id});
    if(!data.ok){ alert(JSON.stringify(data,null,2)); return; }
    alert("Storniert.");
    await refreshAll();
  }

  async function releaseBooking(id){
    const room = $("room").value.trim();
    const pin = $("pin").value.trim();
    const {data} = await jpost("/api/booking/release",{room,pin,id});
    if(!data.ok){ alert(JSON.stringify(data,null,2)); return; }
    alert("Freigegeben.");
    await refreshAll();
  }

  async function bookDryer(machine){
    const room = $("room").value.trim();
    const pin = $("pin").value.trim();
    const stationPin = $("stationPin").value.trim();
    if(!room||!pin||!stationPin){ alert("Bitte erst Zugang eingeben."); return; }

    // first attempt without force
    let {data} = await jpost("/api/dryer/book",{room,pin,stationPin,machine});
    if(!data.ok && data.error==="conflict"){
      const ok = confirm("Trockner läuft ggf. noch. Overbooking bestätigen?\n\nBitte sicherstellen: Wäsche vom Vorgänger ist sauber & vorsichtig im Korb oben/neben die Maschine gestellt.");
      if(!ok) return;
      ({data} = await jpost("/api/dryer/book",{room,pin,stationPin,machine,force:true}));
    }
    if(!data.ok){ alert(JSON.stringify(data,null,2)); return; }
    alert("Trockner gebucht.");
    await refreshAll();
  }

  async function toggleDefect(type,machine,setDefect){
    const room = $("room").value.trim();
    const pin = $("pin").value.trim();
    const stationPin = $("stationPin").value.trim();
    if(!room||!pin||!stationPin){ alert("Bitte erst Zugang eingeben."); return; }

    const {data} = await jpost("/api/machine/defect",{room,pin,stationPin,type,machine,defect:!!setDefect});
    if(!data.ok){ alert(JSON.stringify(data,null,2)); return; }
    alert("OK.");
    await refreshAll();
  }

  // ========= NEWS =========
  async function dismissNews(){
    const room = $("room").value.trim();
    const pin = $("pin").value.trim();
    const v = state.news?.version || state.cfg?.newsVersion || 0;
    if(room && pin && v){
      await jpost("/api/news/seen",{room,pin,version:v});
    }
    $("newsDetails").open = false;
  }

  // ========= FEEDBACK (USER) =========
  async function sendFeedback(){
    const room = $("room").value.trim();
    const pin = $("pin").value.trim();
    const text = $("fbText").value.trim();
    if(!room||!pin){ alert("Bitte erst Zugang eingeben."); return; }
    if(!text){ alert("Bitte Text eingeben."); return; }
    const {data} = await jpost("/api/feedback/send",{room,pin,text});
    if(!data.ok){ alert(JSON.stringify(data,null,2)); return; }
    $("fbText").value="";
    alert("Gesendet.");
    await loadMyFeedback();
  }

  async function loadMyFeedback(){
    const room = $("room").value.trim();
    const pin = $("pin").value.trim();
    if(!room||!pin){ alert("Bitte erst Zugang eingeben."); return; }
    const {data} = await jpost("/api/feedback/list",{room,pin});
    if(!data.ok){ alert(JSON.stringify(data,null,2)); return; }
    const box = $("fbThreads");
    box.innerHTML = "";
    const threads = data.threads || [];
    if(!threads.length){ box.innerHTML = `<div class="small muted">Keine Threads.</div>`; return; }

    for(const t of threads){
      const div = document.createElement("div");
      div.className="kachel";
      div.style.marginTop="8px";
      div.innerHTML = `
        <div class="row" style="margin:0">
          <div class="title" style="margin:0">Thread ${t.id.slice(0,6)}…</div>
          <div class="right small muted">${new Date(t.updatedAt).toLocaleString("de-DE")}</div>
        </div>
        <div class="row" style="margin-top:8px;">
          <button onclick="openMyThread('${t.id}')">Öffnen</button>
        </div>
        <div id="th_${t.id}" style="margin-top:8px;"></div>
      `;
      box.appendChild(div);
    }
  }

  async function openMyThread(id){
    const room = $("room").value.trim();
    const pin = $("pin").value.trim();
    const {data} = await jpost("/api/feedback/open",{room,pin,threadId:id});
    if(!data.ok){ alert(JSON.stringify(data,null,2)); return; }

    const box = $("th_"+id);
    box.innerHTML = "";
    for(const m of (data.messages||[])){
      if(m.sender==="admin" && !m.visibleToUser) continue;
      const p = document.createElement("div");
      p.className="small";
      p.style.marginTop="6px";
      p.innerHTML = `<span class="mono muted">${new Date(m.ts).toLocaleString("de-DE")}</span> <b>${m.sender}:</b> ${escapeHtml(m.text)}`;
      box.appendChild(p);
    }
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
  }

  // ========= ADMIN =========
  async function adminLogin(){
    const pw = $("adminPw").value.trim();
    if(!pw){ alert("Passwort eingeben."); return; }
    const {data} = await jpost("/api/admin/login",{adminPassword:pw});
    if(!data.ok){ alert(JSON.stringify(data,null,2)); return; }
    state.adminToken = data.token;
    state.adminExp = data.expMs;
    $("adminState").textContent = "Eingeloggt (Token aktiv)";
    $("adminLogoutBtn").style.display = "inline-block";
    alert("Admin Login OK.");
    await adminRefreshNewsStats();
  }

  async function adminLogout(){
    if(!adminTokenAlive()){ state.adminToken=""; state.adminExp=0; $("adminState").textContent="Nicht eingeloggt"; $("adminLogoutBtn").style.display="none"; return; }
    const {data} = await jpost("/api/admin/logout",{token:state.adminToken});
    if(!data.ok){ alert(JSON.stringify(data,null,2)); return; }
    state.adminToken=""; state.adminExp=0;
    $("adminState").textContent="Nicht eingeloggt";
    $("adminLogoutBtn").style.display="none";
    alert("Logout OK.");
  }

  async function adminSetStationPin(){
    if(!adminTokenAlive()){ alert("Bitte erst Admin Login."); return; }
    const stationPin = $("adminStationPin").value.trim();
    const {data} = await jpost("/api/admin/set-station-pin",{token:state.adminToken, stationPin});
    if(!data.ok){ alert(JSON.stringify(data,null,2)); return; }
    alert("Stations-PIN gespeichert.");
  }

  async function adminChangePw(){
    if(!adminTokenAlive()){ alert("Bitte erst Admin Login."); return; }
    const oldPassword = $("oldAdminPw").value.trim();
    const newPassword = $("newAdminPw").value.trim();
    const {data} = await jpost("/api/admin/change-password",{token:state.adminToken, oldPassword, newPassword});
    if(!data.ok){ alert(JSON.stringify(data,null,2)); return; }
    alert("Passwort geändert.");
  }

  async function adminSaveWasherHours(){
    if(!adminTokenAlive()){ alert("Bitte erst Admin Login."); return; }
    const hours = [];
    for(let h=0;h<=23;h++){
      if($("wh_"+h).checked) hours.push(h);
    }
    const {data} = await jpost("/api/admin/save-config",{token:state.adminToken, patch:{washerHours:hours}});
    if(!data.ok){ alert(JSON.stringify(data,null,2)); return; }
    alert("Gespeichert.");
  }

  async function adminSaveDryerMinutes(){
    if(!adminTokenAlive()){ alert("Bitte erst Admin Login."); return; }
    const dryerMinutes = Number($("dryerMinutes").value);
    const {data} = await jpost("/api/admin/save-config",{token:state.adminToken, patch:{dryerMinutes}});
    if(!data.ok){ alert(JSON.stringify(data,null,2)); return; }
    alert("Gespeichert.");
  }

  async function adminSaveWindow(){
    if(!adminTokenAlive()){ alert("Bitte erst Admin Login."); return; }
    const daysPast = Number($("daysPast").value);
    const daysFuture = Number($("daysFuture").value);
    const {data} = await jpost("/api/admin/save-config",{token:state.adminToken, patch:{daysPast,daysFuture}});
    if(!data.ok){ alert(JSON.stringify(data,null,2)); return; }
    alert("Gespeichert.");
  }

  async function adminSaveDefectEnabled(){
    if(!adminTokenAlive()){ alert("Bitte erst Admin Login."); return; }
    const userDefectEnabled = ($("userDefectEnabled").value === "true");
    const {data} = await jpost("/api/admin/save-config",{token:state.adminToken, patch:{userDefectEnabled}});
    if(!data.ok){ alert(JSON.stringify(data,null,2)); return; }
    alert("Gespeichert.");
  }

  async function adminSaveDefectAllowed(){
    if(!adminTokenAlive()){ alert("Bitte erst Admin Login."); return; }
    const allowed = {
      washer: {
        "1": $("uda_w_1").checked,
        "2": $("uda_w_2").checked,
        "3": $("uda_w_3").checked,
        "4": $("uda_w_4").checked
      },
      dryer: {
        "1": $("uda_d_1").checked,
        "2": $("uda_d_2").checked,
        "3": $("uda_d_3").checked,
        "4": $("uda_d_4").checked
      }
    };
    const {data} = await jpost("/api/admin/save-config",{token:state.adminToken, patch:{userDefectAllowed:allowed}});
    if(!data.ok){ alert(JSON.stringify(data,null,2)); return; }
    alert("Gespeichert.");
  }

  async function adminSaveTheme(){
    if(!adminTokenAlive()){ alert("Bitte erst Admin Login."); return; }
    const uiTheme = $("uiTheme").value;
    const {data} = await jpost("/api/admin/save-config",{token:state.adminToken, patch:{uiTheme}});
    if(!data.ok){ alert(JSON.stringify(data,null,2)); return; }
    alert("Gespeichert.");
    state.cfg.uiTheme = uiTheme;
    applyTheme();
  }

  async function adminSaveNews(){
    if(!adminTokenAlive()){ alert("Bitte erst Admin Login."); return; }
    const newsEnabled = $("adminNewsEnabled").checked;
    const newsText = $("adminNewsText").value;
    const {data} = await jpost("/api/admin/save-config",{token:state.adminToken, patch:{newsEnabled,newsText}});
    if(!data.ok){ alert(JSON.stringify(data,null,2)); return; }
    alert("News gespeichert (Version erhöht).");
    await adminRefreshNewsStats();
  }

  async function adminRefreshNewsStats(){
    if(!adminTokenAlive()){ $("newsStats").textContent="Zähler: –"; return; }
    const {data} = await jget(`/api/admin/news/stats?token=${encodeURIComponent(state.adminToken)}`);
    if(!data.ok){ $("newsStats").textContent="Zähler: –"; return; }
    $("newsStats").textContent = `Zähler: Version ${data.version} – gesehen: ${data.seen}/${data.total}`;
  }

  async function adminLoadThreads(){
    if(!adminTokenAlive()){ alert("Bitte erst Admin Login."); return; }
    const {data} = await jget(`/api/admin/feedback/threads?token=${encodeURIComponent(state.adminToken)}`);
    if(!data.ok){ alert(JSON.stringify(data,null,2)); return; }

    const box = $("adminThreads");
    box.innerHTML="";
    const threads = data.threads || [];
    if(!threads.length){ box.innerHTML = `<div class="small muted">Keine Threads.</div>`; return; }

    for(const t of threads){
      const div = document.createElement("div");
      div.className="kachel";
      div.style.marginTop="8px";
      div.innerHTML = `
        <div class="row" style="margin:0">
          <div class="title" style="margin:0">Zimmer ${t.room} – ${t.id.slice(0,6)}…</div>
          <div class="right small muted">${new Date(t.updatedAt).toLocaleString("de-DE")}</div>
        </div>
        <div class="row" style="margin-top:8px;">
          <button onclick="adminOpenThread('${t.id}')">Öffnen</button>
        </div>
        <div id="ath_${t.id}" style="margin-top:8px;"></div>
      `;
      box.appendChild(div);
    }
  }

  async function adminOpenThread(id){
    if(!adminTokenAlive()){ alert("Bitte erst Admin Login."); return; }
    const {data} = await jget(`/api/admin/feedback/open?token=${encodeURIComponent(state.adminToken)}&id=${encodeURIComponent(id)}`);
    if(!data.ok){ alert(JSON.stringify(data,null,2)); return; }

    const box = $("ath_"+id);
    box.innerHTML = "";
    for(const m of (data.messages||[])){
      const p = document.createElement("div");
      p.className="small";
      p.style.marginTop="6px";
      p.innerHTML = `<span class="mono muted">${new Date(m.ts).toLocaleString("de-DE")}</span> <b>${m.sender}:</b> ${escapeHtml(m.text)} ${m.sender==="admin" ? (m.visibleToUser ? "<span class='muted'>(sichtbar)</span>" : "<span class='muted'>(versteckt)</span>") : ""}`;
      box.appendChild(p);
    }

    const hr = document.createElement("div");
    hr.className="sep";
    box.appendChild(hr);

    const ta = document.createElement("textarea");
    ta.id = "reply_"+id;
    ta.placeholder = "Antwort...";
    box.appendChild(ta);

    const row = document.createElement("div");
    row.className="row";
    row.style.marginTop="8px";
    row.innerHTML = `
      <label class="small"><input type="checkbox" id="vis_${id}" checked /> sichtbar für User</label>
      <button onclick="adminReply('${id}')">Antwort senden</button>
    `;
    box.appendChild(row);
  }

  async function adminReply(id){
    if(!adminTokenAlive()){ alert("Bitte erst Admin Login."); return; }
    const text = $("reply_"+id).value.trim();
    const visibleToUser = $("vis_"+id).checked;
    if(!text){ alert("Text fehlt."); return; }
    const {data} = await jpost("/api/admin/feedback/reply",{token:state.adminToken, threadId:id, text, visibleToUser});
    if(!data.ok){ alert(JSON.stringify(data,null,2)); return; }
    alert("Gesendet.");
    await adminOpenThread(id);
  }
</script>
</body>
</html>
