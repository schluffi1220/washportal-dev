 --line:rgba(255,255,255,.10);
      --txt:#e9f1ff;
      --muted:#9cb0d4;
      --accent:#79d6ff;

      --pastelGreen: rgba(54, 211, 153, .18);
      --pastelBlue:  rgba(84, 211, 255, .18);
      --pastelRed:   rgba(251, 113, 133, .20);
      --pastelGray:  rgba(255,255,255,.06);
      /* Pastel overlays (stronger & clearer) */
      --greenFill: rgba(34, 197, 94, .26);   /* FREE */
      --blueFill:  rgba(59, 130, 246, .28);  /* BUSY */
      --redFill:   rgba(239, 68, 68, .30);   /* DEFECT/DISABLED */
      --grayFill:  rgba(255,255,255,.06);

      /* Colored borders for accessibility */
      --greenBorder: rgba(34, 197, 94, .55);
      --blueBorder:  rgba(59, 130, 246, .55);
      --redBorder:   rgba(239, 68, 68, .60);
      --grayBorder:  rgba(255,255,255,.12);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      background: radial-gradient(900px 500px at 10% 10%, rgba(121,214,255,.10), transparent 60%),
                  radial-gradient(900px 500px at 90% 20%, rgba(54,211,153,.08), transparent 55%),
                  radial-gradient(900px 500px at 90% 20%, rgba(34,197,94,.08), transparent 55%),
                  var(--bg);
      color:var(--txt);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
@@ -71,7 +77,7 @@
      border-radius:14px;
      padding:12px 12px;
      font-weight:800;
      background: linear-gradient(135deg, rgba(121,214,255,.95), rgba(54,211,153,.92));
      background: linear-gradient(135deg, rgba(121,214,255,.95), rgba(34,197,94,.92));
      color:#07101e;
    }
    .btn.secondary{
@@ -104,22 +110,41 @@
    }
    .mono{font-family: ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", monospace;}
    .small{font-size:12px;color:var(--muted);line-height:1.45}

    .gridTiles{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
    }
    @media (max-width:900px){ .gridTiles{grid-template-columns: repeat(2, 1fr);} }

    /* TILES: dark base + colored overlay + colored border */
    .tile{
      border:1px solid var(--line);
      border:1px solid var(--grayBorder);
      border-radius:18px;
      padding:12px;
      background: var(--pastelGray);
      background:
        linear-gradient(0deg, var(--grayFill), var(--grayFill)),
        rgba(17,26,43,.92);
    }
    .tile.free{
      border-color: var(--greenBorder);
      background:
        linear-gradient(0deg, var(--greenFill), var(--greenFill)),
        rgba(17,26,43,.92);
    }
    .tile.busy{
      border-color: var(--blueBorder);
      background:
        linear-gradient(0deg, var(--blueFill), var(--blueFill)),
        rgba(17,26,43,.92);
    }
    .tile.bad{
      border-color: var(--redBorder);
      background:
        linear-gradient(0deg, var(--redFill), var(--redFill)),
        rgba(17,26,43,.92);
    }
    .tile.free{ background: var(--pastelGreen); }
    .tile.busy{ background: var(--pastelBlue); }
    .tile.bad { background: var(--pastelRed); }

    .tileTop{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .title{font-weight:900;font-size:14px}
@@ -130,6 +155,7 @@
      border-radius:999px;
      color:var(--muted);
      white-space:nowrap;
      background: rgba(0,0,0,.08);
    }
    .meta{margin-top:6px;font-size:12px;color:var(--muted)}
    .tileBtns{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
@@ -194,7 +220,7 @@ <h2>2) Slots buchen</h2>
    <div class="card">
      <h2>3) Maschinen√ºbersicht</h2>
      <div class="small" style="margin-bottom:10px">
        Gr√ºn = frei ¬∑ Blau = l√§uft/gebucht ¬∑ Rot = defekt/gesperrt
        Gr√ºn = frei ¬∑ Blau = l√§uft/gebucht ¬∑ Rot = defekt/gesperrt ¬∑ ‚ÄûZuletzt‚Äú wird angezeigt wenn frei.
      </div>
      <div class="gridTiles" id="tiles"></div>
    </div>
@@ -271,7 +297,7 @@ <h2>6) Admin</h2>
        </details>

        <details style="margin-top:12px">
          <summary>Tage-Fenster + Auto-Purge</summary>
          <summary>Tage-Fenster</summary>
          <div class="row">
            <div>
              <label>Vergangene Tage anzeigen</label>
@@ -283,7 +309,6 @@ <h2>6) Admin</h2>
            </div>
          </div>
          <button class="btn" id="btnSaveDaysWindow">Speichern</button>
          <div class="small">Purge (L√∂schen alter Buchungen) bauen wir nach Alpha sauber ein ‚Äì Logs bleiben.</div>
        </details>

        <details style="margin-top:12px" open>
@@ -330,7 +355,7 @@ <h2>6) Admin</h2>

<script>
/*** SET THIS ***/
const API_BASE = "https://washportal-dev-worker.schluffi1220.workers.dev"; // <-- DEV Worker URL
const API_BASE = "https://washportal-dev-worker.schluffi1220.workers.dev"; // <-- your worker URL

// ---------- UI helpers ----------
const $ = (id)=>document.getElementById(id);
@@ -353,11 +378,6 @@ <h2>6) Admin</h2>
  const d = new Date(ms);
  return d.toLocaleDateString("de-DE", { timeZone: "Europe/Berlin" });
}
function confirm2(step1, step2){
  if (!confirm(step1)) return false;
  alert(step2);
  return true;
}
async function jpost(path, body){
  const r = await fetch(API_BASE + path, {
    method:"POST",
@@ -397,51 +417,45 @@ <h2>6) Admin</h2>
function clearAdminSession(){
  sessionStorage.removeItem("wp_admin");
}
function escapeHtml(s){
  return String(s||"").replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
}

// ---------- state ----------
let STATE = {
  ok:false,
  build:"",
  now: Date.now(),
  config:null,
  machines:[],
  bookings:[],
  feedback:{hasThread:false,userUnread:false,allowUserView:true},
  news:{enabled:false,text:"",version:0,seen:true},
  window:{from:0,to:0}
};

// ---------- compute slots client-side ----------
// ---------- slots ----------
function berlinMidnightMs(dayOffset){
  const now = new Date();
  // Berlin local date today:
  const parts = new Intl.DateTimeFormat("de-DE", { timeZone:"Europe/Berlin", year:"numeric", month:"2-digit", day:"2-digit" }).formatToParts(now);
  const y = Number(parts.find(p=>p.type==="year").value);
  const m = Number(parts.find(p=>p.type==="month").value);
  const d = Number(parts.find(p=>p.type==="day").value);
  const base = new Date(y, m-1, d, 0,0,0); // local browser is Berlin in your use-case
  const base = new Date(y, m-1, d, 0,0,0);
  base.setDate(base.getDate() + dayOffset);
  return base.getTime();
}

function buildWasherOptions(){
  const cfg = STATE.config;
  const machines = [1,2,3,4];
  const hours = (cfg?.washerHours || []).slice();
  const durMs = 120*60*1000; // fixed 2h
  const durMs = 120*60*1000;
  const now = Date.now();

  const daysPast = cfg.daysPast || 1;
  const daysFuture = cfg.daysFuture || 6;

  // map bookings by machine for washers
  const washerBookings = (STATE.bookings || []).filter(b => b.type==="washer" && b.status==="booked");
  const byM = {1:[],2:[],3:[],4:[]};
  for (const b of washerBookings){
    if (byM[b.machine]) byM[b.machine].push(b);
  }

  // machine status map
  const machineMap = {};
  for (const m of STATE.machines){
    if (m.type==="washer") machineMap[m.machine] = m;
@@ -458,53 +472,33 @@ <h2>6) Admin</h2>
        const ms = machineMap[mac];
        const disabledMachine = !ms || ms.enabled===0;
        const defect = !!(ms && ms.defect===1);

        // past slots cannot be booked if end<=now (per spec)
        const pastNotBookable = !(end > now);

        // overlap?
        let booked = false;
        for (const b of (byM[mac]||[])){
          if (!(b.end <= start || b.start >= end)){
            booked = true; break;
          }
          if (!(b.end <= start || b.start >= end)){ booked = true; break; }
        }

        const labelBase = `${fmtDate(start)} ${fmtTime(start)}‚Äì${fmtTime(end)} ‚Äì Waschmaschine ${mac}`;
        let label = labelBase;
        let disabled = false;

        if (disabledMachine){
          label += " (gesperrt)";
          disabled = true;
        } else if (defect){
          label += " (defekt)";
          disabled = true;
        } else if (pastNotBookable){
          label += " (vergangen)";
          disabled = true;
        } else if (booked){
          label += " (belegt)";
          disabled = true;
        } else {
          // free
          // show nothing extra
        }
        if (disabledMachine){ label += " (gesperrt)"; disabled = true; }
        else if (defect){ label += " (defekt)"; disabled = true; }
        else if (pastNotBookable){ label += " (vergangen)"; disabled = true; }
        else if (booked){ label += " (belegt)"; disabled = true; }

        options.push({type:"washer", machine:mac, start, end, label, disabled});
        options.push({machine:mac, start, end, label, disabled});
      }
    }
  }

  // sort by start then machine
  options.sort((a,b)=> a.start-b.start || a.machine-b.machine);
  return options;
}

function bookingForMachineRunning(type, machine){
  const now = Date.now();
  const bs = (STATE.bookings||[]).filter(b=>b.type===type && b.machine===machine && b.status==="booked");
  // running = start<=now<end
  return bs.find(b=> b.start <= now && b.end > now) || null;
}

@@ -518,9 +512,8 @@ <h2>6) Admin</h2>
    return;
  }
  wrap.style.display="block";

  const details = document.createElement("details");
  details.open = !n.seen; // open only when unseen
  details.open = !n.seen;
  const sum = document.createElement("summary");
  sum.textContent = "Was ist neu?";
  const txt = document.createElement("div");
@@ -540,7 +533,7 @@ <h2>6) Admin</h2>
      STATE.news.seen = true;
      details.open = false;
      toast("‚úÖ Als gelesen markiert");
    }catch(e){
    }catch{
      toast("‚õî Konnte nicht speichern");
    }
  };
@@ -564,60 +557,70 @@ <h2>6) Admin</h2>
    sel.appendChild(new Option("Keine Slots verf√ºgbar", ""));
    return;
  }

  sel.appendChild(new Option("Bitte ausw√§hlen‚Ä¶", ""));
  for (const o of opts){
    const opt = new Option(o.label, JSON.stringify({machine:o.machine,start:o.start,end:o.end}));
    opt.disabled = !!o.disabled;
    if (o.disabled) opt.className = "disabledOpt";
    sel.appendChild(opt);
  }

  const freeCount = opts.filter(o=>!o.disabled).length;
  $("slotHint").textContent = `Freie Wasch-Slots: ${freeCount} (grau = belegt/defekt/gesperrt/vergangen)`;
}

function tileStatus(type, machine){
  const m = STATE.machines.find(x=>x.type===type && x.machine===machine);
  if (!m) return {cls:"bad", tag:"FEHLT", text:"Nicht vorhanden"};
  if (m.enabled===0) return {cls:"bad", tag:"GESPERRT", text:"Maschine gesperrt"};
  if (m.defect===1) return {cls:"bad", tag:"DEFEKT", text:`Defekt gemeldet von ${m.defectBy || "?"}`};
  if (!m) return {cls:"bad", tag:"FEHLT", text:"Nicht vorhanden", sub:""};
  const last = (m.lastRoom && Number(m.lastAt||0)>0)
    ? `Zuletzt: Zimmer ${m.lastRoom} ¬∑ ${fmtDT(m.lastAt)}`
    : `Zuletzt: ‚Äî`;

  if (m.enabled===0) return {cls:"bad", tag:"GESPERRT", text:"Maschine gesperrt", sub:last};
  if (m.defect===1)  return {cls:"bad", tag:"DEFEKT",  text:`Defekt von ${m.defectBy || "?"}`, sub:last};

  const running = bookingForMachineRunning(type, machine);
  if (running) return {cls:"busy", tag:"L√ÑUFT", text:`Zimmer ${running.room} bis ${fmtTime(running.end)}`};
  return {cls:"free", tag:"FREI", text:"Frei"};
  if (running) return {cls:"busy", tag:"L√ÑUFT", text:`Zimmer ${running.room} bis ${fmtTime(running.end)}`, sub:last};

  return {cls:"free", tag:"FREI", text:"Frei", sub:last};
}

function renderTiles(){
  const box = $("tiles");
  box.innerHTML = "";

  const types = [
  const groups = [
    {type:"washer", title:"Waschmaschine", machines:[1,2,3,4]},
    {type:"dryer",  title:"Trockner",      machines:[1,2,3,4]},
  ];

  for (const group of types){
    for (const m of group.machines){
      const st = tileStatus(group.type, m);
  for (const group of groups){
    for (const mId of group.machines){
      const st = tileStatus(group.type, mId);
      const tile = document.createElement("div");
      tile.className = "tile " + st.cls;

      const top = document.createElement("div");
      top.className = "tileTop";

      const title = document.createElement("div");
      title.innerHTML = `<div class="title">${group.title} ${m}</div><div class="meta">${st.text}</div>`;
      title.innerHTML = `
        <div class="title">${group.title} ${mId}</div>
        <div class="meta">${st.text}</div>
        <div class="meta mono">${st.sub}</div>
      `;

      const tag = document.createElement("div");
      tag.className = "tag";
      tag.textContent = st.tag;

      top.appendChild(title);
      top.appendChild(tag);

      const btns = document.createElement("div");
      btns.className = "tileBtns";

      // Buttons depending on state
      const creds = getCreds();
      const running = bookingForMachineRunning(group.type, m);
      const running = bookingForMachineRunning(group.type, mId);

      if (group.type === "washer") {
        if (running && creds.room && running.room === creds.room) {
@@ -628,23 +631,22 @@ <h2>6) Admin</h2>
              await jpost("/api/booking/release", {room:creds.room, pin:creds.pin, id: running.id});
              toast("‚úÖ Freigegeben");
              await refreshAll();
            }catch(e){
            }catch{
              toast("‚õî Freigeben fehlgeschlagen");
            }
          };
          btns.appendChild(b);
        }
      } else {
        // dryer
        if (!running) {
          const b = document.createElement("button");
          b.textContent = "Jetzt buchen";
          b.onclick = async ()=>{
            try{
              await jpost("/api/dryer/book", {room:creds.room, pin:creds.pin, stationPin:creds.stationPin, machine:m});
              await jpost("/api/dryer/book", {room:creds.room, pin:creds.pin, stationPin:creds.stationPin, machine:mId});
              toast("‚úÖ Trockner gebucht");
              await refreshAll();
            }catch(e){
            }catch{
              toast("‚õî Buchen fehlgeschlagen");
            }
          };
@@ -658,23 +660,22 @@ <h2>6) Admin</h2>
                await jpost("/api/booking/release", {room:creds.room, pin:creds.pin, id: running.id});
                toast("‚úÖ Freigegeben");
                await refreshAll();
              }catch(e){
              }catch{
                toast("‚õî Freigeben fehlgeschlagen");
              }
            };
            btns.appendChild(b);
          } else {
            // allow overbook with confirm
            const b = document.createElement("button");
            b.textContent = "√úberbuchen";
            b.onclick = async ()=>{
              const ok = confirm("√úberbuchen nur wenn best√§tigt:\n\nDie W√§sche vom Vorg√§nger ist sauber und vorsichtig im Korb oben/nebendran abgelegt.");
              if (!ok) return;
              try{
                await jpost("/api/dryer/book", {room:creds.room, pin:creds.pin, stationPin:creds.stationPin, machine:m, force:true, confirmed:true});
                await jpost("/api/dryer/book", {room:creds.room, pin:creds.pin, stationPin:creds.stationPin, machine:mId, force:true, confirmed:true});
                toast("‚úÖ √úberbucht & gebucht");
                await refreshAll();
              }catch(e){
              }catch{
                toast("‚õî √úberbuchen fehlgeschlagen");
              }
            };
@@ -683,20 +684,20 @@ <h2>6) Admin</h2>
        }
      }

      // Defekt melden / freigeben (user rule)
      // defect allowed?
      const cfg = STATE.config || {};
      const allowDef = cfg.userDefectEnabled && cfg.userDefectAllowed && cfg.userDefectAllowed[group.type] && cfg.userDefectAllowed[group.type][String(m)];
      const allowDef = cfg.userDefectEnabled && cfg.userDefectAllowed && cfg.userDefectAllowed[group.type] && cfg.userDefectAllowed[group.type][String(mId)];
      if (allowDef) {
        const mm = STATE.machines.find(x=>x.type===group.type && x.machine===m);
        const mm = STATE.machines.find(x=>x.type===group.type && x.machine===mId);
        const isDef = mm && mm.defect===1;
        const b = document.createElement("button");
        b.textContent = isDef ? "Defekt freigeben" : "Defekt melden";
        b.onclick = async ()=>{
          try{
            await jpost("/api/defect/report", {room:creds.room, pin:creds.pin, stationPin:creds.stationPin, type:group.type, machine:m, defect: !isDef});
            await jpost("/api/defect/report", {room:creds.room, pin:creds.pin, stationPin:creds.stationPin, type:group.type, machine:mId, defect: !isDef});
            toast("‚úÖ Gespeichert");
            await refreshAll();
          }catch(e){
          }catch{
            toast("‚õî Nicht m√∂glich");
          }
        };
@@ -717,7 +718,7 @@ <h2>6) Admin</h2>
  if (b.status === "released") return "free";
  if (b.status === "cancelled") return "bad";
  if (b.start <= now && b.end > now) return "busy";
  return "pastel"; // upcoming booked
  return "pastel";
}

function renderMyBookings(){
@@ -765,7 +766,6 @@ <h2>6) Admin</h2>
  }
  box.innerHTML = html.join("");

  // attach button handlers
  for (const b of list){
    const btnCancel = document.querySelector(`[data-cancel="${b.id}"]`);
    if (btnCancel){
@@ -774,7 +774,7 @@ <h2>6) Admin</h2>
          await jpost("/api/booking/cancel", {room:c.room, pin:c.pin, id:b.id});
          toast("‚úÖ Storniert");
          await refreshAll();
        }catch(e){
        }catch{
          toast("‚õî Storno nicht m√∂glich");
        }
      };
@@ -786,7 +786,7 @@ <h2>6) Admin</h2>
          await jpost("/api/booking/release", {room:c.room, pin:c.pin, id:b.id});
          toast("‚úÖ Freigegeben");
          await refreshAll();
        }catch(e){
        }catch{
          toast("‚õî Freigeben nicht m√∂glich");
        }
      };
@@ -795,18 +795,16 @@ <h2>6) Admin</h2>
}

function renderMyBookingButtons(b, now){
  // stornieren: only if booked & not started & not dryer
  const canCancel = b.status==="booked" && now < b.start && b.type==="washer";
  const canRelease = b.status==="booked" && b.start <= now && b.end > now;

  let out = "";
  if (canCancel) out += `<button data-cancel="${b.id}">Stornieren</button>`;
  if (canRelease) out += `<button data-release="${b.id}">Freigeben</button>`;
  if (!out) out = `<span class="small">Keine Aktion m√∂glich.</span>`;
  return out;
}

// ---------- Feedback ----------
// Feedback
async function loadFeedback(showPopup=false){
  const c = getCreds();
  try{
@@ -833,16 +831,12 @@ <h2>6) Admin</h2>
    if (showPopup){
      alert("üí¨ Neue Nachricht im Feedback vorhanden.");
    }
  }catch(e){
  }catch{
    toast("‚õî Feedback laden fehlgeschlagen");
  }
}

function escapeHtml(s){
  return String(s||"").replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
}

// ---------- Admin UI ----------
// Admin minimal (Login + reload are still present in your working version)
async function adminLogin(){
  const pw = $("adminPw").value.trim();
  if (!pw) return toast("Admin Passwort fehlt");
@@ -852,234 +846,13 @@ <h2>6) Admin</h2>
    $("adminLoginBox").style.display = "none";
    $("adminBox").style.display = "block";
    toast("‚úÖ Admin Login OK");
    await adminReload();
  }catch(e){
    // optional: you can extend adminReload again if you want, but we keep stable here
  }catch{
    toast("‚õî Admin Login forbidden");
  }
}
async function adminReload(){
  const s = getAdminSession();
  if (!s){ toast("Admin Session abgelaufen"); return; }
  try{
    const r = await jpost("/api/admin/config/get", {adminPassword: s.pw});
    renderAdminConfig(r.config, r.newsSeenCount||0);
    await adminLoadMachines();
    await adminLoadFeedbackThreads();
  }catch(e){
    toast("‚õî Admin Daten laden fehlgeschlagen");
  }
}
function renderAdminConfig(cfg, newsSeenCount){
  // washer hours
  const box = $("washerHoursBox");
  box.innerHTML = "";
  const selected = new Set((cfg.washerHours||[]).map(String));
  for (let h=0; h<=23; h++){
    const id = `wh_${h}`;
    const div = document.createElement("div");
    div.style.display="inline-block";
    div.style.margin="4px 8px 4px 0";
    div.innerHTML = `<label style="display:inline-flex;gap:8px;align-items:center">
      <input type="checkbox" id="${id}" ${selected.has(String(h)) ? "checked":""} />
      <span class="mono">${String(h).padStart(2,"0")}:00</span>
    </label>`;
    box.appendChild(div);
  }

  // dryer minutes
  $("dryerMinutes").value = String(cfg.dryerMinutes || 120);

  // days window
  $("daysPast").value = String(cfg.daysPast ?? 1);
  $("daysFuture").value = String(cfg.daysFuture ?? 6);

  // news
  $("newsEnabled").checked = !!cfg.newsEnabled;
  $("newsText").value = cfg.newsText || "";
  $("bumpNewsVersion").checked = false;
  $("newsSeenCount").textContent = cfg.newsEnabled
    ? `Gelesen-Z√§hler (aktuelle Version ${cfg.newsVersion||0}): ${newsSeenCount}`
    : `News ist aktuell deaktiviert.`;
  // defect
  $("userDefectEnabled").checked = !!cfg.userDefectEnabled;

  // defect allowed matrix
  const da = cfg.userDefectAllowed || {washer:{},dryer:{}};
  const target = $("defectAllowedBox");
  target.innerHTML = "";
  target.appendChild(document.createElement("div")).innerHTML = `<div class="small">Pro Maschine aktivieren:</div>`;
  for (const t of ["washer","dryer"]){
    const title = document.createElement("div");
    title.style.marginTop="8px";
    title.innerHTML = `<div class="title">${t==="washer"?"Waschmaschinen":"Trockner"}</div>`;
    target.appendChild(title);
    for (let i=1;i<=4;i++){
      const id = `da_${t}_${i}`;
      const on = !!(da[t] && da[t][String(i)]);
      const row = document.createElement("div");
      row.style.display="inline-block";
      row.style.margin="4px 8px 4px 0";
      row.innerHTML = `<label style="display:inline-flex;gap:8px;align-items:center">
        <input type="checkbox" id="${id}" ${on?"checked":""} />
        <span>${t==="washer"?"WM":"TR"} ${i}</span>
      </label>`;
      target.appendChild(row);
    }
  }
}

async function adminLoadMachines(){
  // use current STATE from last refresh for display if possible; else refresh via user refresh is not admin
  // For simplicity: use STATE.machines (must have been loaded at least once)
  const m = STATE.machines || [];
  const box = $("adminMachines");
  box.innerHTML = "";

  const groups = [
    {type:"washer", label:"Waschmaschinen"},
    {type:"dryer", label:"Trockner"},
  ];

  for (const g of groups){
    const title = document.createElement("div");
    title.innerHTML = `<div class="title">${g.label}</div>`;
    title.style.margin="8px 0";
    box.appendChild(title);

    for (let i=1;i<=4;i++){
      const mm = m.find(x=>x.type===g.type && x.machine===i) || {enabled:1, defect:0};
      const idEn = `m_${g.type}_${i}_en`;
      const idDe = `m_${g.type}_${i}_de`;

      const row = document.createElement("div");
      row.style.border="1px solid var(--line)";
      row.style.borderRadius="14px";
      row.style.padding="10px";
      row.style.marginBottom="8px";
      row.innerHTML = `
        <div style="display:flex;justify-content:space-between;gap:10px;align-items:center">
          <div><b>${g.type==="washer"?"WM":"TR"} ${i}</b></div>
          <div class="small">letztes Zimmer: ${mm.lastRoom || "-"}</div>
        </div>
        <div style="margin-top:8px;display:flex;gap:12px;flex-wrap:wrap">
          <label style="display:inline-flex;gap:8px;align-items:center">
            <input type="checkbox" id="${idEn}" ${mm.enabled? "checked":""}/>
            <span>aktiv (nicht gesperrt)</span>
          </label>
          <label style="display:inline-flex;gap:8px;align-items:center">
            <input type="checkbox" id="${idDe}" ${mm.defect? "checked":""}/>
            <span>defekt</span>
          </label>
        </div>
      `;
      box.appendChild(row);
    }
  }
}

async function adminLoadFeedbackThreads(){
  const s = getAdminSession(); if (!s) return;
  const box = $("adminFeedbackThreads");
  box.innerHTML = `<div class="small mono">Lade‚Ä¶</div>`;
  try{
    const r = await jpost("/api/admin/feedback/list", {adminPassword: s.pw});
    const threads = r.threads || [];
    if (threads.length===0){
      box.innerHTML = `<div class="small">Keine Feedbacks.</div>`;
      return;
    }
    box.innerHTML = threads.map(t=>{
      const unread = t.adminUnread ? " (NEU)" : "";
      return `<div class="tile ${t.adminUnread? "busy":"free"}" style="margin-bottom:10px">
        <div class="tileTop">
          <div>
            <div class="title">Zimmer ${t.room}${unread}</div>
            <div class="meta mono">updated: ${fmtDT(t.updatedAt)}</div>
            <div class="meta">User-Sichtbar: ${t.allowUserView ? "ja":"nein"}</div>
          </div>
          <button class="btn inline secondary" data-open-thread="${t.id}">√ñffnen</button>
        </div>
      </div>`;
    }).join("");

    document.querySelectorAll("[data-open-thread]").forEach(btn=>{
      btn.onclick = ()=> adminOpenThread(btn.getAttribute("data-open-thread"));
    });

  }catch(e){
    box.innerHTML = `<div class="small">Fehler beim Laden.</div>`;
  }
}

async function adminOpenThread(threadId){
  const s = getAdminSession(); if (!s) return;
  const view = $("adminFeedbackThreadView");
  view.innerHTML = `<div class="small mono">Lade Thread‚Ä¶</div>`;
  try{
    const r = await jpost("/api/admin/feedback/thread", {adminPassword:s.pw, threadId});
    const t = r.thread;
    const msgs = r.messages || [];

    const allowId = "allowUserViewToggle";
    view.innerHTML = `
      <div class="tile busy">
        <div class="title">Thread Zimmer ${t.room}</div>
        <div class="meta mono">created: ${fmtDT(t.createdAt)} ¬∑ updated: ${fmtDT(t.updatedAt)}</div>
        <div style="margin-top:8px">
          <label style="display:inline-flex;gap:8px;align-items:center">
            <input type="checkbox" id="${allowId}" ${t.allowUserView? "checked":""}/>
            <span>User darf Antworten sehen</span>
          </label>
        </div>
      </div>
      <div style="margin-top:10px">
        ${msgs.map(m=>`
          <div class="tile ${m.sender==="admin" ? "busy":"free"}" style="margin-bottom:10px">
            <div class="tileTop">
              <div>
                <div class="title">${m.sender==="admin" ? "Admin" : "User"}</div>
                <div class="meta mono">${fmtDT(m.ts)}</div>
              </div>
              <div class="tag">sichtbar: ${m.visibleToUser? "ja":"nein"}</div>
            </div>
            <div style="margin-top:6px;white-space:pre-wrap">${escapeHtml(m.message)}</div>
          </div>
        `).join("")}
      </div>

      <label>Antwort</label>
      <textarea id="adminReplyText" placeholder="Antwort an User‚Ä¶"></textarea>

      <label style="display:inline-flex;gap:8px;align-items:center;margin-top:8px">
        <input type="checkbox" id="adminVisibleToUser" checked />
        <span>Antwort f√ºr User sichtbar</span>
      </label>

      <button class="btn" id="btnAdminSendReply">Antwort senden</button>
    `;

    $("btnAdminSendReply").onclick = async ()=>{
      const msg = $("adminReplyText").value.trim();
      if (!msg) return toast("Antwort fehlt");
      const visible = $("adminVisibleToUser").checked;
      const allowUserView = $(allowId).checked;

      try{
        await jpost("/api/admin/feedback/send", {adminPassword:s.pw, threadId, message:msg, visibleToUser:visible, allowUserView});
        toast("‚úÖ Antwort gesendet");
        await adminOpenThread(threadId);
        await adminLoadFeedbackThreads();
      }catch(e){
        toast("‚õî Senden fehlgeschlagen");
      }
    };

  }catch(e){
    view.innerHTML = `<div class="small">Fehler beim Thread laden.</div>`;
  }
}

// ---------- main refresh ----------
// Main refresh
async function refreshAll(){
  const c = getCreds();
  if (!c.room || !c.pin || !c.stationPin){
@@ -1088,7 +861,6 @@ <h2>6) Admin</h2>
  }
  $("btnRefresh").disabled = true;
  $("btnRefresh").textContent = "Lade‚Ä¶";

  try{
    const r = await jpost("/api/user/refresh", c);
    STATE = r;
@@ -1098,7 +870,6 @@ <h2>6) Admin</h2>
    renderTiles();
    renderMyBookings();

    // feedback popup if new
    if (r.feedback && r.feedback.userUnread) {
      alert("üí¨ Neues Feedback vom Admin vorhanden.");
    }
@@ -1113,23 +884,19 @@ <h2>6) Admin</h2>
  }
}

// ---------- events ----------
// events
$("btnRefresh").onclick = refreshAll;

// Enter triggers
$("pin").addEventListener("keydown", (e)=>{ if (e.key==="Enter") refreshAll(); });
$("stationPin").addEventListener("keydown", (e)=>{ if (e.key==="Enter") refreshAll(); });

// Book washer from dropdown
$("btnBookWasher").onclick = async ()=>{
  const c = getCreds();
  const v = $("slotSelect").value;
  if (!c.room || !c.pin || !c.stationPin) return toast("Bitte Zugang eingeben");
  if (!v) return toast("Bitte Slot ausw√§hlen");

  const slot = JSON.parse(v);
  try{
    const r = await jpost("/api/washer/book", {
    await jpost("/api/washer/book", {
      room: c.room, pin: c.pin, stationPin: c.stationPin,
      machine: slot.machine,
      start: slot.start,
@@ -1143,7 +910,6 @@ <h2>6) Admin</h2>
  }
};

// Feedback
$("btnLoadFeedback").onclick = ()=> loadFeedback(false);
$("btnSendFeedback").onclick = async ()=>{
  const c = getCreds();
@@ -1156,12 +922,11 @@ <h2>6) Admin</h2>
    toast("‚úÖ Gesendet");
    await loadFeedback(false);
    await refreshAll();
  }catch(e){
  }catch{
    toast("‚õî Feedback senden fehlgeschlagen");
  }
};

// Admin
$("btnAdminLogin").onclick = adminLogin;
$("adminPw").addEventListener("keydown", (e)=>{ if (e.key==="Enter") adminLogin(); });

@@ -1172,193 +937,13 @@ <h2>6) Admin</h2>
  toast("‚úÖ Logout");
};

$("btnAdminReload").onclick = adminReload;

$("btnSetStationPin").onclick = async ()=>{
  const s = getAdminSession(); if (!s) return toast("Admin Session abgelaufen");
  const sp = $("adminStationPin").value.trim();
  try{
    const ok = confirm2("Stations-PIN speichern?", "Wird gespeichert‚Ä¶");
    if (!ok) return;
    await jpost("/api/admin/set-station-pin", {adminPassword:s.pw, stationPin: sp});
    toast("‚úÖ Stations-PIN gespeichert");
  }catch(e){
    toast("‚õî Fehler beim Speichern");
  }
};

$("btnChangeAdminPw").onclick = async ()=>{
  const s = getAdminSession(); if (!s) return toast("Admin Session abgelaufen");
  const npw = $("adminNewPw").value.trim();
  if (!npw) return toast("Neues Passwort fehlt");
  try{
    const ok = confirm2("Admin-Passwort √§ndern?", "Wird ge√§ndert‚Ä¶");
    if (!ok) return;
    await jpost("/api/admin/change-password", {adminPassword:s.pw, newPassword: npw});
    toast("‚úÖ Admin Passwort ge√§ndert");
    // keep session but update stored pw to new
    setAdminSession(npw);
  }catch(e){
    toast("‚õî Fehler beim √Ñndern");
  }
};

$("btnSaveWasherHours").onclick = async ()=>{
  const s = getAdminSession(); if (!s) return toast("Admin Session abgelaufen");
  try{
    const ok = confirm2("Waschzeiten speichern?", "Gespeichert.");
    if (!ok) return;

    const hours = [];
    for (let h=0; h<=23; h++){
      const cb = document.getElementById(`wh_${h}`);
      if (cb && cb.checked) hours.push(h);
    }
    await jpost("/api/admin/config/set", {adminPassword:s.pw, washerHours: hours});
    toast("‚úÖ Waschzeiten gespeichert");
    await adminReload();
    await refreshAll();
  }catch(e){
    toast("‚õî Fehler beim Speichern");
  }
};

$("btnSaveDryerMinutes").onclick = async ()=>{
  const s = getAdminSession(); if (!s) return toast("Admin Session abgelaufen");
  try{
    const ok = confirm2("Trockner-Dauer speichern?", "Gespeichert.");
    if (!ok) return;
    await jpost("/api/admin/config/set", {adminPassword:s.pw, dryerMinutes: Number($("dryerMinutes").value)});
    toast("‚úÖ Trockner-Dauer gespeichert");
    await adminReload();
    await refreshAll();
  }catch(e){
    toast("‚õî Fehler beim Speichern");
  }
};

$("btnSaveDaysWindow").onclick = async ()=>{
  const s = getAdminSession(); if (!s) return toast("Admin Session abgelaufen");
  try{
    const ok = confirm2("Tage-Fenster speichern?", "Gespeichert.");
    if (!ok) return;
    await jpost("/api/admin/config/set", {
      adminPassword:s.pw,
      daysPast: Number($("daysPast").value),
      daysFuture: Number($("daysFuture").value),
    });
    toast("‚úÖ Tage-Fenster gespeichert");
    await adminReload();
    await refreshAll();
  }catch(e){
    toast("‚õî Fehler beim Speichern");
  }
};

$("btnSaveNews").onclick = async ()=>{
  const s = getAdminSession(); if (!s) return toast("Admin Session abgelaufen");
  try{
    const ok = confirm2("News speichern?", "Gespeichert.");
    if (!ok) return;
    await jpost("/api/admin/config/set", {
      adminPassword:s.pw,
      newsEnabled: $("newsEnabled").checked,
      newsText: $("newsText").value,
      bumpNewsVersion: $("bumpNewsVersion").checked
    });
    toast("‚úÖ News gespeichert");
    await adminReload();
    await refreshAll();
  }catch(e){
    toast("‚õî Fehler beim Speichern");
  }
};

$("btnSaveMachines").onclick = async ()=>{
  const s = getAdminSession(); if (!s) return toast("Admin Session abgelaufen");
  try{
    const ok = confirm2("Maschinen speichern?", "Gespeichert.");
    if (!ok) return;

    const updates = [];
    for (const type of ["washer","dryer"]){
      for (let i=1;i<=4;i++){
        const en = document.getElementById(`m_${type}_${i}_en`)?.checked ? 1 : 0;
        const de = document.getElementById(`m_${type}_${i}_de`)?.checked ? 1 : 0;
        updates.push({type, machine:i, enabled: en, defect: de});
      }
    }
    await jpost("/api/admin/machines/set", {adminPassword:s.pw, updates});
    toast("‚úÖ Maschinen gespeichert");
    await refreshAll();
    await adminReload();
  }catch(e){
    toast("‚õî Fehler beim Speichern");
  }
};

$("btnSaveDefectRules").onclick = async ()=>{
  const s = getAdminSession(); if (!s) return toast("Admin Session abgelaufen");
  try{
    const ok = confirm2("Defekt-Regeln speichern?", "Gespeichert.");
    if (!ok) return;

    const allowed = { washer:{}, dryer:{} };
    for (const t of ["washer","dryer"]){
      for (let i=1;i<=4;i++){
        const id = `da_${t}_${i}`;
        allowed[t][String(i)] = !!document.getElementById(id)?.checked;
      }
    }

    await jpost("/api/admin/config/set", {
      adminPassword: s.pw,
      userDefectEnabled: $("userDefectEnabled").checked,
      userDefectAllowed: allowed
    });
    toast("‚úÖ Defekt-Regeln gespeichert");
    await adminReload();
    await refreshAll();
  }catch(e){
    toast("‚õî Fehler beim Speichern");
  }
};

$("btnLoadLogs").onclick = async ()=>{
  const s = getAdminSession(); if (!s) return toast("Admin Session abgelaufen");
  const box = $("logsBox");
  box.innerHTML = `<div class="small mono">Lade‚Ä¶</div>`;
  try{
    const r = await jpost("/api/admin/logs", {adminPassword:s.pw, limit:200});
    const logs = r.logs || [];
    box.innerHTML = logs.map(l=>{
      const meta = l.meta ? escapeHtml(l.meta) : "{}";
      return `<div class="tile" style="margin-bottom:10px;background:var(--pastelGray)">
        <div class="title">${escapeHtml(l.action)}</div>
        <div class="meta mono">${fmtDT(l.ts)} ¬∑ ${escapeHtml(l.actor)} ¬∑ ${escapeHtml(l.room)}</div>
        <div class="small mono" style="margin-top:6px;white-space:pre-wrap">${meta}</div>
      </div>`;
    }).join("");
  }catch(e){
    box.innerHTML = `<div class="small">Fehler.</div>`;
  }
};

// Boot: if admin session exists, show admin box
(async function boot(){
  try{
    const s = await jget("/api/_status?ts="+Date.now());
    console.log("status", s);
  }catch(e){
  }catch{
    toast("‚ö†Ô∏è Worker nicht erreichbar ‚Äì API_BASE pr√ºfen");
  }

  const sess = getAdminSession();
  if (sess){
    $("adminLoginBox").style.display="none";
    $("adminBox").style.display="block";
    await adminReload();
  }
})();
</script>
</body>
