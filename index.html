<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Washportal (DEV)</title>
  <style>
    :root{
      --bg:#08111f; --panel:#0f1c2f; --panel2:#10243b; --line:rgba(255,255,255,.08);
      --text:#eaf1ff; --muted:rgba(234,241,255,.70);
      --ok:#2dd4bf; --bad:#ef4444; --warn:#f59e0b; --blue:#60a5fa;
      --btn:#1f2d44; --btn2:#263a59;
      --shadow: 0 18px 50px rgba(0,0,0,.45);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: radial-gradient(1200px 600px at 30% 10%, rgba(45,212,191,.18), transparent 55%),
                  radial-gradient(900px 500px at 85% 35%, rgba(96,165,250,.16), transparent 50%),
                  linear-gradient(180deg, #061022, var(--bg));
      color:var(--text);
    }
    .wrap{max-width:1180px; margin:24px auto 80px; padding:0 16px;}
    .topbar{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:16px;}
    .pill{display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px;
      border:1px solid var(--line); background:rgba(255,255,255,.04); font-size:13px; color:var(--muted)}
    .pill strong{color:var(--text); font-weight:700}
    .pill .dot{width:8px; height:8px; border-radius:99px; background:var(--ok); box-shadow:0 0 0 3px rgba(45,212,191,.15)}
    .err{display:none; margin:10px 0 16px; padding:12px 14px; border-radius:14px; border:1px solid rgba(239,68,68,.35);
      background:rgba(239,68,68,.10); color:#ffd5d5}
    .grid{display:grid; grid-template-columns: 1fr; gap:16px;}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow);
      padding:16px;
    }
    h1{margin:0 0 4px; font-size:20px}
    h2{margin:0 0 12px; font-size:18px}
    .muted{color:var(--muted); font-size:13px}
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end}
    .field{min-width:180px; flex:1}
    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
    input, select, textarea{
      width:100%; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.20); color:var(--text); outline:none;
    }
    textarea{min-height:44px; resize:vertical}
    .btn{
      padding:10px 14px; border-radius:14px; border:1px solid rgba(255,255,255,.12);
      background:linear-gradient(90deg, rgba(96,165,250,.25), rgba(45,212,191,.25));
      color:var(--text); font-weight:700; cursor:pointer;
      transition:transform .05s ease, filter .15s ease;
    }
    .btn:active{transform:translateY(1px)}
    .btn.secondary{background:rgba(255,255,255,.05); font-weight:600}
    .btn.danger{background:rgba(239,68,68,.18); border-color:rgba(239,68,68,.35)}
    .btn.small{padding:8px 10px; border-radius:12px; font-size:13px}
    .machines{
      display:grid; gap:12px;
      grid-template-columns: repeat(4, minmax(0, 1fr));
    }
    @media (max-width: 980px){ .machines{grid-template-columns: repeat(2, minmax(0, 1fr));} }
    @media (max-width: 520px){ .machines{grid-template-columns: 1fr;} }
    .mcard{
      background:rgba(255,255,255,.03); border:1px solid var(--line); border-radius:16px; padding:14px;
      display:flex; flex-direction:column; gap:10px; min-height:150px;
    }
    .mcard.state-free{border-color: rgba(45,212,191,.28); background: rgba(45,212,191,.14); box-shadow: 0 18px 50px rgba(0,0,0,.45), 0 0 0 1px rgba(45,212,191,.10) inset;}
    .mcard.state-busy{border-color: rgba(96,165,250,.30); background: rgba(96,165,250,.14); box-shadow: 0 18px 50px rgba(0,0,0,.45), 0 0 0 1px rgba(96,165,250,.10) inset;}
    .mcard.state-whitecard{border-color: rgba(255,255,255,.35); background: rgba(255,255,255,.20);}
    .mcard.state-defect{border-color: rgba(248,113,113,.55); background: rgba(248,113,113,.22);}


    .mhead{display:flex; justify-content:space-between; align-items:flex-start; gap:10px;}
    .mtitle{font-weight:800}
    .badge{font-size:12px; padding:5px 10px; border-radius:999px; border:1px solid var(--line); color:var(--muted); background:rgba(0,0,0,.15)}
    .badge.ok{color:#c7fffb; border-color:rgba(45,212,191,.35); background:rgba(45,212,191,.10)}
    .badge.busy{color:#dbeafe; border-color:rgba(96,165,250,.35); background:rgba(96,165,250,.10)}
    .badge.bad{color:#ffd5d5; border-color:rgba(239,68,68,.35); background:rgba(239,68,68,.10)}
    .mp{font-size:13px; color:var(--muted); line-height:1.3}
    .mcontrols{margin-top:auto; display:flex; flex-direction:column; gap:10px}
    .inline{display:flex; gap:10px; align-items:center}
    .inline select{flex:1}
    .list{display:flex; flex-direction:column; gap:10px}
    .item{border:1px solid var(--line); background:rgba(255,255,255,.03); border-radius:14px; padding:12px}
    .itemtop{display:flex; justify-content:space-between; gap:10px; align-items:flex-start}
    .item h3{margin:0; font-size:14px}
    .item .meta{margin-top:6px; font-size:13px; color:var(--muted)}
    .divider{height:1px; background:var(--line); margin:10px 0}
    .footer-note{margin-top:14px; font-size:12px; color:rgba(234,241,255,.55)}
  
  .card.machine{position:relative;}
  .card.machine.locked{background:rgba(160,160,160,.22); border-color: rgba(120,120,120,.35);}
  .card.machine.defect{background:rgba(255,80,80,.18); border-color: rgba(255,80,80,.40);}
  .card.machine .mhead{display:flex; align-items:center; justify-content:space-between; gap:10px;}
  .card.machine .mmeta{margin-top:8px; display:flex; flex-direction:column; gap:4px;}
  .card.machine .mcontrols{margin-top:12px; display:flex; flex-wrap:wrap; gap:8px; align-items:center;}
  .badge.bad{background:rgba(255,60,60,.22); border:1px solid rgba(255,60,60,.45);}
  .badge.locked{background:rgba(120,120,120,.22); border:1px solid rgba(120,120,120,.45);}
  .check{display:flex; align-items:center; gap:8px; padding:6px 10px; border:1px solid var(--line); border-radius:12px; background:rgba(255,255,255,.55);}
  .check .cb{width:18px; height:18px;}

</style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="pill"><span class="dot"></span><strong>Washportal</strong></div>
      <div class="pill">PORTAL BUILD: <strong id="portalBuild">2026-02-15 PORTAL</strong></div>
      <div class="pill">Worker: <strong id="workerBuild">-</strong></div>
      <div class="pill">Zimmer: <strong id="roomPill">-</strong></div>
    </div>

    <div id="err" class="err"></div>

    <div class="grid">
      <div class="card">
        <h2>Login</h2>
        <div class="row">
          <div class="field"><label>Zimmer</label><input id="room" inputmode="numeric" placeholder="z.B. 316"></div>
          <div class="field"><label>Persönlicher PIN</label><input id="pin" type="password" inputmode="numeric" placeholder="PIN"></div>
          <div class="field"><label>Stations-PIN</label><input id="stationPin" type="password" inputmode="numeric" placeholder="Stations-PIN"></div>
          <button class="btn" id="saveBtn">Speichern</button>
          <button class="btn secondary" id="refreshBtn">Aktualisieren</button>
        </div>
        <div class="footer-note">Hinweis: Slot-Buchung nutzt deinen persönlichen PIN (Storno/Freigabe nur für dich). Stations-PIN wird zusätzlich geprüft.</div>
      </div>

      <div class="card">
        <h2>Maschinen</h2>
        <div class="muted" id="legend">Grün = frei · Blau = läuft/gebucht · Rot = gesperrt/defekt</div>
        <div class="divider"></div>
        <div class="machines" id="machines"></div>
      </div>

      <div class="card">
        <h2>Meine Buchungen</h2>
        <div class="list" id="myBookings"></div>
      </div>
    </div>
  </div>

<script>
function escapeHtml(s){
  return String(s??"").replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
}

function fmtTime(ts){
  const d=new Date(Number(ts));
  const hh=String(d.getHours()).padStart(2,"0");
  const mm=String(d.getMinutes()).padStart(2,"0");
  return `${hh}:${mm}`;
}

function findLastNext(bookings, kind, machineId){
  const now = Date.now();
  const list = (Array.isArray(bookings)?bookings:[])
    .filter(b=>String(b.kind)===String(kind) && String(b.machineId)===String(machineId) && (b.status==="booked"||b.status==="active"||b.status==="released"));
  const current = list.find(b => Number(b.startAt)<=now && now<Number(b.endAt) && (b.status==="active" || b.status==="booked"));
  const past = list.filter(b => Number(b.endAt)<=now).sort((a,b)=>Number(b.endAt)-Number(a.endAt));
  const last = past[0] || null;
  const future = list.filter(b => Number(b.startAt)>now && (b.status==="booked"||b.status==="active")).sort((a,b)=>Number(a.startAt)-Number(b.startAt));
  const next = future[0] || null;
  return {current,last,next};
}

const HIDDEN_KEY="wp_hidden_bookings_v1";
function getHiddenBookings(){
  try{ return new Set(JSON.parse(localStorage.getItem(HIDDEN_KEY)||"[]")); }catch{ return new Set(); }
}
function hideBooking(id){
  const set=getHiddenBookings();
  set.add(String(id));
  localStorage.setItem(HIDDEN_KEY, JSON.stringify([...set]));
}

async function cancelBooking(b){
  return jpost("/api/booking/cancel", { bookingId: b.id, room: String($("room").value||""), pin: String($("pin").value||""), stationPin: String($("stationPin").value||"") });
}
async function releaseBooking(b){
  return jpost("/api/booking/release", { bookingId: b.id, room: String($("room").value||""), pin: String($("pin").value||""), stationPin: String($("stationPin").value||"") });
}

function renderMyBookings(state){
  const box=$("myBookings");
  const hidden=getHiddenBookings();
  const bookings=Array.isArray(state?.bookings)?state.bookings:[];
  const roomNow=String(state?.room || $("room").value || "");
  const mine=bookings.filter(b=>String(b.room)===roomNow).sort((a,b)=>Number(a.startAt)-Number(b.startAt));
  const now=Date.now();
  box.innerHTML="";
  if(!roomNow){ box.innerHTML = `<div class="muted">Bitte Zimmer eingeben und aktualisieren.</div>`; return; }
  if(mine.length===0){ box.innerHTML = `<div class="muted">Keine Buchungen gefunden.</div>`; return; }

  for(const b of mine){
    const id=String(b.id ?? `${b.kind}-${b.machineId}-${b.startAt}`);
    if(hidden.has(id)) continue;
    const card=document.createElement("div");
    card.className="card booking";
    const title = `${b.kind==="dryer"?"Trockner":"Waschmaschine"} ${b.machineId}`;
    const range = `${fmtDateTime(b.startAt)}–${fmtTime(b.endAt)}`;
    const status = b.status || "—";
    const expired = Number(b.endAt) <= now;
    const top = document.createElement("div");
    top.className="btop";
    top.innerHTML = `<div><strong>${escapeHtml(title)}</strong><div class="muted">${escapeHtml(range)}</div></div><span class="pill2">${escapeHtml(status)}</span>`;
    card.appendChild(top);

    const actions=document.createElement("div");
    actions.className="bactions";

    if(expired){
      const hide=document.createElement("button");
      hide.className="btn ghost";
      hide.textContent="Ausblenden";
      hide.onclick=()=>{ hideBooking(id); renderMyBookings(state); };
      actions.appendChild(hide);
      const note=document.createElement("div");
      note.className="muted";
      note.style.marginTop="6px";
      note.textContent="Abgelaufen – keine Aktion möglich.";
      card.appendChild(actions);
      card.appendChild(note);
    }else{
      if((b.status==="active"||b.status==="released") && Number(b.startAt)<=now){
        const rel=document.createElement("button");
        rel.className="btn";
        rel.textContent="Freigeben";
        rel.onclick=async()=>{ try{ await releaseBooking(b); await refreshAll(); }catch(e){ showErr("⛔ "+e.message); } };
        actions.appendChild(rel);
      }
      if(b.status==="booked" && Number(b.startAt)>now){
        const canc=document.createElement("button");
        canc.className="btn ghost";
        canc.textContent="Stornieren";
        canc.onclick=async()=>{ 
          try{ await cancelBooking(b); await refreshAll(); }
          catch(e){ showErr("⛔ Stornieren nicht möglich: "+e.message); }
        };
        actions.appendChild(canc);
      }
      const hide=document.createElement("button");
      hide.className="btn ghost";
      hide.textContent="Ausblenden";
      hide.onclick=()=>{ hideBooking(id); renderMyBookings(state); };
      actions.appendChild(hide);
      card.appendChild(actions);
    }
    box.appendChild(card);
  }
}

// ---- Zeit/Format-Helpers (global) ----
function pad2(n){ return String(n).padStart(2,"0"); }
function fmtHM(ts){
  const d=new Date(Number(ts));
  return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
}
function fmtDate(dayTs){
  const d=new Date(Number(dayTs));
  return `${pad2(d.getDate())}.${pad2(d.getMonth()+1)}`;
}
function fmtDateTime(ts){
  const d=new Date(Number(ts));
  return `${pad2(d.getDate())}.${pad2(d.getMonth()+1)} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
}
function startOfDay(ts){
  const d = new Date(Number(ts||Date.now()));
  d.setHours(0,0,0,0);
  return d.getTime();
}


  const API = "https://washportal-dev-worker.schluffi1220.workers.dev";
  const $ = (id) => document.getElementById(id);

  function showOk(msg){
    const el = $("err");
    el.style.display = msg ? "block" : "none";
    el.style.borderColor = "rgba(45,212,191,.35)";
    el.style.background = "rgba(45,212,191,.10)";
    el.style.color = "#c7fffb";
    el.textContent = msg || "";
  }

  function showErr(msg){
    const el = $("err");
    el.style.display = msg ? "block" : "none";
    el.style.borderColor = "rgba(239,68,68,.35)";
    el.style.background = "rgba(239,68,68,.10)";
    el.style.color = "#ffd5d5";
    el.textContent = msg || "";
  }


function showToast(msg){
  try{
    const el = document.getElementById("toast");
    if(!el) return;
    el.textContent = msg || "";
    el.style.display = msg ? "block" : "none";
    if(msg){
      clearTimeout(window.__toastT);
      window.__toastT = setTimeout(()=>{ el.style.display="none"; }, 1800);
    }
  }catch{}
}


  function fmtDT(ts){
    const d = new Date(Number(ts));
    if (isNaN(d.getTime())) return "—";
    return d.toLocaleString("de-DE", { weekday:"short", day:"2-digit", month:"2-digit", hour:"2-digit", minute:"2-digit" });
  }

  function loadCreds(){ /* disabled */ }

async function refreshAll(){

    showErr("");
    saveCreds();
    const room = $("room").value.trim();
    const pin = $("pin").value.trim();
    const stationPin = $("stationPin").value.trim();
    $("roomPill").textContent = room || "-";

    if(!room || !pin || !stationPin){
      showErr("Bitte Zimmer, persönlichen PIN und Stations-PIN eintragen.");
      return;
    }
    try{
      const state = await jpost("/api/user/refresh",{ room, pin, stationPin });
      $("workerBuild").textContent = state.build || "-";
      renderMachines(state);
      updateGlobalBookPanel(state);

      renderMyBookings(state);
    }catch(e){
      showErr("⛔ " + e.message);
    }
  }

    const _sb = $("saveBtn"); if(_sb) _sb.onclick = ()=>{ saveCreds(); showErr(""); };
  const _rb = $("refreshBtn"); if(_rb) _rb.onclick = refreshAll;

  loadCreds();
  refreshAll();
</script>
<div id="toast" style="display:none;position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 14px;border-radius:12px;box-shadow:0 10px 20px rgba(0,0,0,.18);font-weight:700;z-index:9999"></div>
</body>
</html>
