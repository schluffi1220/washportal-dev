<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Washportal</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:#111a2b;
      --line:rgba(255,255,255,.10);
      --txt:#e9f1ff;
      --muted:#9cb0d4;

      --greenFill: rgba(34, 197, 94, .26);
      --blueFill:  rgba(59, 130, 246, .28);
      --redFill:   rgba(239, 68, 68, .30);
      --grayFill:  rgba(255,255,255,.06);

      --greenBorder: rgba(34, 197, 94, .55);
      --blueBorder:  rgba(59, 130, 246, .55);
      --redBorder:   rgba(239, 68, 68, .60);
      --grayBorder:  rgba(255,255,255,.12);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      background: radial-gradient(900px 500px at 10% 10%, rgba(121,214,255,.10), transparent 60%),
                  radial-gradient(900px 500px at 90% 20%, rgba(34,197,94,.08), transparent 55%),
                  var(--bg);
      color:var(--txt);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(10px);
      background: rgba(11,18,32,.78);
      border-bottom: 1px solid var(--line);
      padding: 14px 14px;
    }
    .wrap{max-width:980px;margin:0 auto;padding:0 14px}
    h1{margin:0;font-size:18px}
    .sub{margin-top:4px;color:var(--muted);font-size:13px}
    main{padding:14px 0 70px}
    .card{
      background: rgba(17,26,43,.90);
      border:1px solid var(--line);
      border-radius:18px;
      padding:14px;
      box-shadow: 0 12px 30px rgba(0,0,0,.20);
      margin-bottom:12px;
    }
    .card h2{margin:0 0 10px;font-size:14px;color:#d7e6ff}
    label{display:block;color:var(--muted);font-size:12px;margin:10px 0 6px}
    input,select,textarea{
      width:100%;
      background: rgba(255,255,255,.04);
      border:1px solid var(--line);
      color:var(--txt);
      padding:10px 12px;
      border-radius:14px;
      outline:none;
      font-size:14px;
    }
    textarea{min-height:96px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:740px){ .row{grid-template-columns:1fr} }

    .btn{
      width:100%;
      margin-top:10px;
      border:none;
      cursor:pointer;
      border-radius:14px;
      padding:12px 12px;
      font-weight:800;
      background: linear-gradient(135deg, rgba(121,214,255,.95), rgba(34,197,94,.92));
      color:#07101e;
    }
    .btn.secondary{
      background: transparent;
      border:1px solid var(--line);
      color:var(--txt);
      font-weight:700;
    }
    .btn.inline{ width:auto; margin:0; padding:10px 12px; }

    details{
      border:1px solid var(--line);
      border-radius:16px;
      padding:10px 12px;
      background: rgba(255,255,255,.03);
    }
    summary{cursor:pointer;color:#cfe3ff;font-weight:800}

    .toast{
      position:fixed; left:50%; bottom:16px; transform:translateX(-50%);
      background: rgba(17,26,43,.96);
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
      box-shadow: 0 12px 35px rgba(0,0,0,.35);
      max-width: min(92vw, 680px);
      display:none;
      z-index:9999;
      font-size:13px;
    }
    .mono{font-family: ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", monospace;}
    .small{font-size:12px;color:var(--muted);line-height:1.45}

    .gridTiles{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
    }
    @media (max-width:900px){ .gridTiles{grid-template-columns: repeat(2, 1fr);} }

    .tile{
      border:1px solid var(--grayBorder);
      border-radius:18px;
      padding:12px;
      background:
        linear-gradient(0deg, var(--grayFill), var(--grayFill)),
        rgba(17,26,43,.92);
    }
    .tile.free{
      border-color: var(--greenBorder);
      background:
        linear-gradient(0deg, var(--greenFill), var(--greenFill)),
        rgba(17,26,43,.92);
    }
    .tile.busy{
      border-color: var(--blueBorder);
      background:
        linear-gradient(0deg, var(--blueFill), var(--blueFill)),
        rgba(17,26,43,.92);
    }
    .tile.bad{
      border-color: var(--redBorder);
      background:
        linear-gradient(0deg, var(--redFill), var(--redFill)),
        rgba(17,26,43,.92);
    }

    .tileTop{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .title{font-weight:900;font-size:14px}
    .tag{
      font-size:11px;
      border:1px solid var(--line);
      padding:4px 8px;
      border-radius:999px;
      color:var(--muted);
      white-space:nowrap;
      background: rgba(0,0,0,.08);
    }
    .meta{margin-top:6px;font-size:12px;color:var(--muted)}
    .tileBtns{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .tileBtns button{
      border-radius:999px;
      padding:8px 10px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.0);
      color: var(--txt);
      cursor:pointer;
      font-size:12px;
    }

    /* ✅ Slot-Dropdown LESBAR:
       Viele Mobile-Browser rendern Options in einem hellen System-Picker.
       Darum: buchbar = schwarz, disabled = grau. */
    #slotSelect option { color:#000; }
    #slotSelect option:disabled { color:#777; }

    /* Haken-Liste Admin */
    .chkGrid{
      display:grid;
      grid-template-columns: repeat(6, 1fr);
      gap:8px;
      margin-top:10px;
    }
    @media (max-width:740px){ .chkGrid{grid-template-columns: repeat(4, 1fr);} }
    .chk{
      display:flex; align-items:center; gap:8px;
      padding:8px 10px;
      border:1px solid var(--line);
      border-radius:12px;
      background: rgba(0,0,0,.06);
      color: var(--txt);
      font-size:13px;
    }
    .chk input{ width:auto; }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Washportal</h1>
      <div class="sub">Alpha-Stand (Zimmer + PIN + Stations-PIN) · 4 WM · 4 TR · Kachel-UI</div>
    </div>
  </header>

  <main class="wrap">

    <div class="card" id="cardAccess">
      <h2>1) Zugang</h2>
      <div class="row">
        <div>
          <label>Zimmernummer (0–400)</label>
          <input id="room" inputmode="numeric" placeholder="z.B. 316" />
        </div>
        <div>
          <label>PIN (4-stellig)</label>
          <input id="pin" type="password" inputmode="numeric" placeholder="****" />
        </div>
      </div>
      <label>Stations-PIN (4-stellig)</label>
      <input id="stationPin" type="password" inputmode="numeric" placeholder="****" />

      <button class="btn" id="btnRefresh">Aktualisieren</button>

      <div id="newsBoxWrap" style="margin-top:12px; display:none;"></div>
    </div>

    <div class="card">
      <h2>2) Slots buchen</h2>
      <label>Wasch-Slot auswählen</label>
      <select id="slotSelect">
        <option value="">Bitte erst „Aktualisieren“ drücken</option>
      </select>
      <button class="btn" id="btnBookWasher">Buchen</button>
      <div class="small" id="slotHint" style="margin-top:10px"></div>
    </div>

    <div class="card">
      <h2>3) Maschinenübersicht</h2>
      <div class="small" style="margin-bottom:10px">
        Grün = frei · Blau = läuft/gebucht · Rot = defekt/gesperrt · „Zuletzt“ wird angezeigt wenn frei.
      </div>
      <div class="gridTiles" id="tiles"></div>
    </div>

    <div class="card">
      <h2>4) Meine Buchungen</h2>
      <div id="myBookings"></div>
    </div>

    <div class="card">
      <h2>5) Feedback / Antworten</h2>
      <button class="btn secondary" id="btnLoadFeedback">Feedback laden</button>
      <div id="feedbackList" style="margin-top:10px"></div>

      <label>Neue Nachricht</label>
      <textarea id="feedbackText" placeholder="Deine Nachricht…"></textarea>
      <button class="btn" id="btnSendFeedback">Senden</button>
    </div>

    <div class="card">
      <h2>6) Admin</h2>

      <div id="adminLoginBox">
        <label>Admin-Passwort</label>
        <input id="adminPw" type="password" placeholder="initial (falls neu)" />
        <button class="btn" id="btnAdminLogin">Login</button>
        <div class="small" id="adminSessionInfo" style="margin-top:8px"></div>
      </div>

      <div id="adminBox" style="display:none">
        <div class="row">
          <button class="btn secondary" id="btnAdminLogout">Logout</button>
          <button class="btn secondary" id="btnAdminReload">Admin aktualisieren</button>
        </div>

        <details style="margin-top:12px" open>
          <summary>Stations-PIN setzen/ändern</summary>
          <label>Stations-PIN (4-stellig)</label>
          <input id="adminStationPin" type="password" inputmode="numeric" placeholder="1111" />
          <button class="btn" id="btnSetStationPin">Speichern</button>
        </details>

        <details style="margin-top:12px" open>
          <summary>Admin-Passwort ändern</summary>
          <label>Neues Admin-Passwort</label>
          <input id="adminNewPw" type="password" placeholder="Neues Passwort" />
          <button class="btn" id="btnChangeAdminPw">Ändern</button>
          <div class="small" style="margin-top:8px">
            Hinweis: Nach erfolgreichem Ändern wirst du automatisch ausgeloggt.
          </div>
        </details>

        <details style="margin-top:12px" open>
          <summary>Wasch-Slots (Uhrzeiten per Haken)</summary>
          <div class="small">Waschdauer fix 2 Stunden. Wähle Start-Uhrzeiten (0–23).</div>
          <div id="washerHoursBox"></div>
          <button class="btn" id="btnSaveWasherHours">Waschzeiten speichern</button>
        </details>

        <details style="margin-top:12px" open>
          <summary>Trockner-Dauer</summary>
          <label>Dauer</label>
          <select id="dryerMinutes">
            <option value="60">1 Stunde</option>
            <option value="90">1,5 Stunden</option>
            <option value="120">2 Stunden</option>
          </select>
          <button class="btn" id="btnSaveDryerMinutes">Speichern</button>
        </details>

      </div>
    </div>

  </main>

  <div id="toast" class="toast"></div>

<script>
/*** SET THIS ***/
const API_BASE = "https://washportal-dev-worker.schluffi1220.workers.dev"; // <-- DEIN Worker

const $ = (id)=>document.getElementById(id);
function toast(msg){
  const t = $("toast");
  t.textContent = msg;
  t.style.display = "block";
  clearTimeout(window.__t);
  window.__t = setTimeout(()=> t.style.display="none", 3200);
}
function fmtDT(ms){
  const d = new Date(ms);
  return d.toLocaleString("de-DE", { timeZone: "Europe/Berlin" });
}
function fmtTime(ms){
  const d = new Date(ms);
  return d.toLocaleTimeString("de-DE", { timeZone: "Europe/Berlin", hour:"2-digit", minute:"2-digit" });
}
function fmtDate(ms){
  const d = new Date(ms);
  return d.toLocaleDateString("de-DE", { timeZone: "Europe/Berlin" });
}
async function jpost(path, body){
  const r = await fetch(API_BASE + path, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(body||{})
  });
  const data = await r.json().catch(()=> ({}));
  if (!r.ok) throw {status:r.status, data};
  return data;
}
async function jget(path){
  const r = await fetch(API_BASE + path);
  const data = await r.json().catch(()=> ({}));
  if (!r.ok) throw {status:r.status, data};
  return data;
}
function getCreds(){
  return {
    room: $("room").value.trim(),
    pin: $("pin").value.trim(),
    stationPin: $("stationPin").value.trim()
  };
}

// ---------- Admin session (TOKEN vom Worker) ----------
function getAdminSession(){
  try{
    const raw = sessionStorage.getItem("wp_admin_v2");
    if (!raw) return null;
    const o = JSON.parse(raw);
    if (!o.token || !o.expiresAt) return null;
    if (Date.now() > o.expiresAt) return null;
    return o;
  }catch{ return null; }
}
function setAdminSession(token, expiresAt, pwForChange){
  // pwForChange merken wir NUR für "change-password oldPassword"
  // (Kannst du später entfernen – für Alpha ist das okay.)
  sessionStorage.setItem("wp_admin_v2", JSON.stringify({token, expiresAt, pwForChange}));
  renderAdminSessionInfo();
}
function clearAdminSession(){
  sessionStorage.removeItem("wp_admin_v2");
  renderAdminSessionInfo();
}
function renderAdminSessionInfo(){
  const s = getAdminSession();
  const el = $("adminSessionInfo");
  if (!el) return;
  if (!s) { el.textContent=""; return; }
  el.textContent = `Session aktiv bis ${fmtDT(s.expiresAt)} (Timeout 5 Min)`;
}

// ---------- state ----------
let STATE = { config:null, machines:[], bookings:[], feedback:{}, news:{} };

// ---------- slots ----------
function berlinMidnightMs(dayOffset){
  const now = new Date();
  const parts = new Intl.DateTimeFormat("de-DE", { timeZone:"Europe/Berlin", year:"numeric", month:"2-digit", day:"2-digit" }).formatToParts(now);
  const y = Number(parts.find(p=>p.type==="year").value);
  const m = Number(parts.find(p=>p.type==="month").value);
  const d = Number(parts.find(p=>p.type==="day").value);
  const base = new Date(y, m-1, d, 0,0,0);
  base.setDate(base.getDate() + dayOffset);
  return base.getTime();
}
function buildWasherOptions(){
  const cfg = STATE.config || {};
  const machines = [1,2,3,4];
  const hours = (cfg.washerHours || [6,8,10,12,14,16,18,20]).slice();
  const durMs = 120*60*1000;
  const now = Date.now();
  const daysPast = cfg.daysPast ?? 1;
  const daysFuture = cfg.daysFuture ?? 6;

  const washerBookings = (STATE.bookings || []).filter(b => b.type==="washer" && b.status==="booked");
  const byM = {1:[],2:[],3:[],4:[]};
  for (const b of washerBookings){ if (byM[b.machine]) byM[b.machine].push(b); }

  const machineMap = {};
  for (const m of (STATE.machines||[])) if (m.type==="washer") machineMap[m.machine] = m;

  const options = [];
  for (let day = -daysPast; day <= daysFuture; day++){
    const day0 = berlinMidnightMs(day);
    for (const h of hours){
      const start = day0 + h*60*60*1000;
      const end = start + durMs;

      for (const mac of machines){
        const ms = machineMap[mac];
        const disabledMachine = !ms || ms.enabled===0;
        const defect = !!(ms && ms.defect===1);
        const pastNotBookable = !(end > now);

        let booked = false;
        for (const b of (byM[mac]||[])){
          if (!(b.end <= start || b.start >= end)){ booked = true; break; }
        }

        const labelBase = `${fmtDate(start)} ${fmtTime(start)}–${fmtTime(end)} – Waschmaschine ${mac}`;
        let label = labelBase;
        let disabled = false;

        if (disabledMachine){ label += " (gesperrt)"; disabled = true; }
        else if (defect){ label += " (defekt)"; disabled = true; }
        else if (pastNotBookable){ label += " (vergangen)"; disabled = true; }
        else if (booked){ label += " (belegt)"; disabled = true; }

        options.push({machine:mac, start, end, label, disabled});
      }
    }
  }
  options.sort((a,b)=> a.start-b.start || a.machine-b.machine);
  return options;
}

function renderSlotDropdown(){
  const sel = $("slotSelect");
  sel.innerHTML = "";
  const opts = buildWasherOptions();
  if (opts.length===0){
    sel.appendChild(new Option("Keine Slots verfügbar", ""));
    return;
  }
  sel.appendChild(new Option("Bitte auswählen…", ""));
  for (const o of opts){
    const opt = new Option(o.label, JSON.stringify({machine:o.machine,start:o.start,end:o.end}));
    opt.disabled = !!o.disabled;
    sel.appendChild(opt);
  }
  const freeCount = opts.filter(o=>!o.disabled).length;
  $("slotHint").textContent = `Freie Wasch-Slots: ${freeCount} (grau = belegt/defekt/gesperrt/vergangen)`;
}

// ---------- tiles (wie bei dir bereits ok) ----------
function bookingForMachineRunning(type, machine){
  const now = Date.now();
  const bs = (STATE.bookings||[]).filter(b=>b.type===type && b.machine===machine && b.status==="booked");
  return bs.find(b=> b.start <= now && b.end > now) || null;
}
function tileStatus(type, machine){
  const m = (STATE.machines||[]).find(x=>x.type===type && x.machine===machine);
  if (!m) return {cls:"bad", tag:"FEHLT", text:"Nicht vorhanden", sub:"Zuletzt: —"};
  const last = (m.lastRoom && Number(m.lastAt||0)>0)
    ? `Zuletzt: Zimmer ${m.lastRoom} · ${fmtDT(m.lastAt)}`
    : `Zuletzt: —`;

  if (m.enabled===0) return {cls:"bad", tag:"GESPERRT", text:"Maschine gesperrt", sub:last};
  if (m.defect===1)  return {cls:"bad", tag:"DEFEKT",  text:`Defekt von ${m.defectBy || "?"}`, sub:last};

  const running = bookingForMachineRunning(type, machine);
  if (running) return {cls:"busy", tag:"LÄUFT", text:`Zimmer ${running.room} bis ${fmtTime(running.end)}`, sub:last};

  return {cls:"free", tag:"FREI", text:"Frei", sub:last};
}
function renderTiles(){
  const box = $("tiles");
  box.innerHTML = "";
  const groups = [
    {type:"washer", title:"Waschmaschine", machines:[1,2,3,4]},
    {type:"dryer",  title:"Trockner",      machines:[1,2,3,4]},
  ];
  for (const group of groups){
    for (const mId of group.machines){
      const st = tileStatus(group.type, mId);
      const tile = document.createElement("div");
      tile.className = "tile " + st.cls;

      const top = document.createElement("div");
      top.className = "tileTop";

      const title = document.createElement("div");
      title.innerHTML = `
        <div class="title">${group.title} ${mId}</div>
        <div class="meta">${st.text}</div>
        <div class="meta mono">${st.sub}</div>
      `;
      const tag = document.createElement("div");
      tag.className = "tag";
      tag.textContent = st.tag;

      top.appendChild(title);
      top.appendChild(tag);

      tile.appendChild(top);
      box.appendChild(tile);
    }
  }
}

// ---------- my bookings minimal ----------
function renderMyBookings(){
  const box = $("myBookings");
  const c = getCreds();
  if (!c.room){
    box.innerHTML = `<div class="small">Bitte Zugang eingeben und Aktualisieren.</div>`;
    return;
  }
  const list = (STATE.bookings||[]).filter(b=> b.room===c.room);
  if (list.length===0){
    box.innerHTML = `<div class="small">Keine Buchungen.</div>`;
    return;
  }
  box.innerHTML = list.sort((a,b)=>a.start-b.start).map(b=>{
    const title = `${b.type==="washer" ? "Waschmaschine" : "Trockner"} ${b.machine}`;
    const line = `${fmtDate(b.start)} ${fmtTime(b.start)}–${fmtTime(b.end)}`;
    return `
      <div class="tile" style="margin-bottom:10px">
        <div class="title">${title}</div>
        <div class="meta mono">${line}</div>
        <div class="meta">${b.status}</div>
      </div>
    `;
  }).join("");
}

// ---------- Admin: washer hour checkboxes ----------
function renderWasherHoursAdmin(){
  const box = $("washerHoursBox");
  if (!box) return;
  const hrs = (STATE.config?.washerHours || [6,8,10,12,14,16,18,20]).slice().sort((a,b)=>a-b);
  const set = new Set(hrs.map(String));
  const grid = document.createElement("div");
  grid.className = "chkGrid";
  for (let h=0; h<=23; h++){
    const id = "wh_"+h;
    const wrap = document.createElement("label");
    wrap.className = "chk";
    wrap.innerHTML = `<input type="checkbox" id="${id}"> <span>${String(h).padStart(2,"0")}:00</span>`;
    grid.appendChild(wrap);
    setTimeout(()=>{ const cb = $(id); if (cb) cb.checked = set.has(String(h)); }, 0);
  }
  box.innerHTML = "";
  box.appendChild(grid);
}
function readWasherHoursAdmin(){
  const out = [];
  for (let h=0; h<=23; h++){
    const cb = $("wh_"+h);
    if (cb && cb.checked) out.push(h);
  }
  return out;
}

// ---------- Admin login / actions ----------
async function adminLogin(){
  const pw = $("adminPw").value.trim();
  if (!pw) return toast("Admin Passwort fehlt");
  try{
    const r = await jpost("/api/admin/login", {adminPassword: pw});
    // token+expiresAt vom Worker
    setAdminSession(r.token, r.expiresAt, pw);
    $("adminLoginBox").style.display = "none";
    $("adminBox").style.display = "block";
    toast("✅ Admin Login OK");
    // Admin UI initial füllen (aus aktuellem STATE, sonst _status holen)
    if (!STATE.config){
      const st = await jget("/api/_status?ts="+Date.now());
      STATE.config = st.config || STATE.config;
    }
    renderWasherHoursAdmin();
  }catch(e){
    toast("⛔ Admin Login forbidden");
  }
}

async function adminLogout(){
  const s = getAdminSession();
  try{
    if (s?.token) await jpost("/api/admin/logout", {token:s.token});
  }catch{}
  clearAdminSession();
  $("adminBox").style.display = "none";
  $("adminLoginBox").style.display = "block";
  toast("✅ Logout");
}

async function adminReload(){
  const s = getAdminSession();
  if (!s) return toast("⛔ Bitte einloggen");
  try{
    const st = await jget("/api/_status?ts="+Date.now());
    STATE.config = st.config || STATE.config;
    renderWasherHoursAdmin();
    // dryerMinutes selector:
    if (STATE.config?.dryerMinutes) $("dryerMinutes").value = String(STATE.config.dryerMinutes);
    toast("✅ Admin geladen");
  }catch{
    toast("⛔ Admin laden fehlgeschlagen");
  }
}

async function adminSetStationPin(){
  const s = getAdminSession();
  if (!s) return toast("⛔ Bitte einloggen");
  const pin = $("adminStationPin").value.trim();
  if (!/^\d{4}$/.test(pin)) return toast("⛔ PIN muss 4-stellig sein");
  try{
    const r = await jpost("/api/admin/set-station-pin", {token:s.token, stationPin: pin});
    toast("✅ Stations-PIN gespeichert");
  }catch(e){
    toast("⛔ Speichern fehlgeschlagen");
  }
}

async function adminChangePassword(){
  const s = getAdminSession();
  if (!s) return toast("⛔ Bitte einloggen");
  const newPw = $("adminNewPw").value.trim();
  if (!newPw || newPw.length < 4) return toast("⛔ Neues Passwort zu kurz");
  try{
    await jpost("/api/admin/change-password", {
      token: s.token,
      oldPassword: s.pwForChange || $("adminPw").value.trim(),
      newPassword: newPw
    });
    alert("✅ Admin-Passwort geändert. Du wirst ausgeloggt.");
    await adminLogout();
  }catch(e){
    alert("⛔ Passwort ändern fehlgeschlagen (Session abgelaufen? falsches altes Passwort?)");
  }
}

async function adminSaveWasherHours(){
  const s = getAdminSession();
  if (!s) return toast("⛔ Bitte einloggen");
  const hrs = readWasherHoursAdmin();
  if (hrs.length === 0) return toast("⛔ Mindestens eine Uhrzeit wählen");
  try{
    const r = await jpost("/api/admin/save-config", { token: s.token, patch: { washerHours: hrs }});
    STATE.config = r.config || STATE.config;
    toast("✅ Waschzeiten gespeichert");
    renderSlotDropdown(); // User-Dropdown sofort neu
  }catch(e){
    toast("⛔ Speichern fehlgeschlagen");
  }
}

async function adminSaveDryerMinutes(){
  const s = getAdminSession();
  if (!s) return toast("⛔ Bitte einloggen");
  const v = Number($("dryerMinutes").value);
  if (![60,90,120].includes(v)) return toast("⛔ Ungültig");
  try{
    const r = await jpost("/api/admin/save-config", { token: s.token, patch: { dryerMinutes: v }});
    STATE.config = r.config || STATE.config;
    toast("✅ Trockner-Dauer gespeichert");
  }catch{
    toast("⛔ Speichern fehlgeschlagen");
  }
}

// ---------- refresh ----------
async function refreshAll(){
  const c = getCreds();
  if (!c.room || !c.pin || !c.stationPin){
    toast("Bitte Zugang vollständig eingeben");
    return;
  }
  $("btnRefresh").disabled = true;
  $("btnRefresh").textContent = "Lade…";
  try{
    const r = await jpost("/api/user/refresh", c);
    STATE = r;

    renderSlotDropdown();
    renderTiles();
    renderMyBookings();

    toast("✅ Bereit");
  }catch(e){
    const msg = e?.data?.message || e?.data?.error || "Fehler";
    toast("⛔ " + msg);
  }finally{
    $("btnRefresh").disabled = false;
    $("btnRefresh").textContent = "Aktualisieren";
  }
}

// ---------- booking washer ----------
$("btnBookWasher").onclick = async ()=>{
  const c = getCreds();
  const v = $("slotSelect").value;
  if (!c.room || !c.pin || !c.stationPin) return toast("Bitte Zugang eingeben");
  if (!v) return toast("Bitte Slot auswählen");
  const slot = JSON.parse(v);
  try{
    await jpost("/api/washer/book", {
      room: c.room, pin: c.pin, stationPin: c.stationPin,
      machine: slot.machine,
      start: slot.start,
      end: slot.end
    });
    alert("✅ Gebucht!");
    await refreshAll();
  }catch(e){
    const msg = e?.data?.message || e?.data?.error || "Fehler";
    alert("⛔ " + msg);
  }
};

// ---------- feedback (basic) ----------
$("btnLoadFeedback").onclick = async ()=> toast("Feedback laden: kommt aus Worker – wenn Worker ok, bleibt es stabil.");
$("btnSendFeedback").onclick = async ()=> toast("Feedback senden: kommt aus Worker – wenn Worker ok, bleibt es stabil.");

$("btnRefresh").onclick = refreshAll;

// Admin events
$("btnAdminLogin").onclick = adminLogin;
$("adminPw").addEventListener("keydown", (e)=>{ if (e.key==="Enter") adminLogin(); });
$("btnAdminLogout").onclick = adminLogout;
$("btnAdminReload").onclick = adminReload;
$("btnSetStationPin").onclick = adminSetStationPin;
$("btnChangeAdminPw").onclick = adminChangePassword;
$("btnSaveWasherHours").onclick = adminSaveWasherHours;
$("btnSaveDryerMinutes").onclick = adminSaveDryerMinutes;

// Boot: existing session?
(function boot(){
  renderAdminSessionInfo();
  const s = getAdminSession();
  if (s){
    $("adminLoginBox").style.display="none";
    $("adminBox").style.display="block";
  }
})();
</script>
</body>
</html>
