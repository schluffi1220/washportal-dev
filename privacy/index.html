<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Datenschutz</title>

<meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>

<style>
body{font-family:system-ui;background:#0f172a;color:#e5e7eb;margin:0;padding:24px}
.card{background:#111827;border-radius:12px;padding:16px;margin-bottom:14px}
h3{margin:0 0 8px}
.mono{font-family:monospace}
</style>
</head>

<body>

<h2>Datenschutz</h2>

<div class="card">
  <h3>Automatischer Löschzeitpunkt</h3>
  <div id="metaLine">Lade...</div>
  <div id="deleteInfo"></div>
</div>

<div class="card">
  <h3>Registrierte Patientensprecher</h3>
  <div id="psList">Lade...</div>
</div>

<script>
const API_BASE = "https://washportal-dev-worker.schluffi1220.workers.dev";

function pad(n){return String(n).padStart(2,"0");}
function fmt(ts){
  const d=new Date(Number(ts));
  return pad(d.getDate())+"."+pad(d.getMonth()+1)+"."+d.getFullYear()+" "+
         pad(d.getHours())+":"+pad(d.getMinutes());
}

async function loadMeta(){
  const r = await fetch(API_BASE + "/api/privacy/meta", {cache:"no-store"});
  const j = await r.json();

  if(!j.ok) throw new Error("meta failed");

  const del = fmt(j.deleteAt);
  document.getElementById("metaLine").textContent = "Stand: " + del;

  document.getElementById("deleteInfo").innerHTML =
    "Buchungsdaten werden nur so lange gespeichert wie erforderlich. "+
    "Spätestens am <span class='mono'>"+del+"</span> werden sie gelöscht.";

  // ===============================
  // ✅ FIX: kompatibles Rendering
  // ===============================
  const list = document.getElementById("psList");
  const ps = j.patientSpeakers || [];

  if(!ps.length){
    list.textContent = "Noch keine Registrierungen.";
    return;
  }

  list.innerHTML = ps.map(p=>{
    const name =
      p.name ||
      [p.firstName, p.lastName].filter(Boolean).join(" ").trim() ||
      "(ohne Name)";

    const email =
      p.emailMasked ||
      p.email ||
      "(ohne E‑Mail)";

    const status = p.status ? " – " + p.status : "";

    return "• " + name + " (" + email + ")" + status;
  }).join("<br/>");
}

window.addEventListener("DOMContentLoaded", ()=>{
  loadMeta().catch(e=>{
    console.error(e);
    document.getElementById("metaLine").textContent = "Fehler beim Laden";
    document.getElementById("psList").textContent = "Fehler beim Laden";
  });
});
</script>

</body>
</html>
