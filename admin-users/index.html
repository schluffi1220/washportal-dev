<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Washportal Admin</title>
<style>
:root{
  --bg1:#061018; --bg2:#0b2230; --card:#0f1f2b; --card2:#0c1822;
  --text:#e8f1f7; --muted:#9fb3c3; --line:rgba(255,255,255,.08);
  --accent:#26c6da; --accent2:#4f8cff; --good:#1ee2a2; --warn:#f7b955; --bad:#ff5d6c;
}
*{box-sizing:border-box}
body{
  margin:0; font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
  color:var(--text);
  min-height:100vh;
  background:
    radial-gradient(1200px 700px at 20% 15%, rgba(38,198,218,.22), transparent 55%),
    radial-gradient(900px 600px at 70% 35%, rgba(79,140,255,.18), transparent 55%),
    linear-gradient(180deg,var(--bg1),var(--bg2));
}
a{color:var(--accent)}
.container{max-width:1180px;margin:18px auto;padding:0 16px}
.topbar{display:flex;align-items:center;gap:10px;margin-bottom:14px}
.dot{width:9px;height:9px;border-radius:99px;background:var(--good);box-shadow:0 0 0 6px rgba(30,226,162,.12)}
.h1{font-weight:800;letter-spacing:.2px}
.pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:rgba(255,255,255,.04);color:var(--muted);font-size:12px}
.grid{display:grid;gap:14px}
.card{
  border:1px solid var(--line);
  background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
  box-shadow:0 10px 25px rgba(0,0,0,.35);
  border-radius:18px;
  padding:14px;
}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.field{display:flex;flex-direction:column;gap:6px;min-width:220px;flex:1}
label{font-size:12px;color:var(--muted)}
input,select,textarea{
  background:rgba(0,0,0,.22); color:var(--text);
  border:1px solid rgba(255,255,255,.10);
  border-radius:12px; padding:10px 12px; outline:none;
}
textarea{min-height:92px;resize:vertical}
input:focus,select:focus,textarea:focus{border-color:rgba(38,198,218,.55);box-shadow:0 0 0 4px rgba(38,198,218,.12)}
.btn{
  border:1px solid rgba(255,255,255,.14);
  background:linear-gradient(180deg, rgba(79,140,255,.95), rgba(38,198,218,.72));
  color:#061018; font-weight:800;
  padding:10px 14px; border-radius:14px; cursor:pointer;
}
.btn.secondary{
  background:rgba(255,255,255,.05); color:var(--text); font-weight:700;
}
.btn.ghost{background:transparent}
.btn:disabled{opacity:.45;cursor:not-allowed}
.tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
.tab{
  padding:9px 12px;border-radius:999px;border:1px solid var(--line);
  background:rgba(0,0,0,.18); color:var(--muted);
  cursor:pointer; user-select:none;
}
.tab.active{color:var(--text);background:rgba(79,140,255,.18);border-color:rgba(79,140,255,.35)}
.badge{
  display:inline-flex;align-items:center;gap:6px;
  padding:6px 10px;border-radius:999px;font-size:12px;
  border:1px solid var(--line); background:rgba(0,0,0,.18); color:var(--muted);
}
.badge.ok{background:rgba(30,226,162,.12);color:var(--good);border-color:rgba(30,226,162,.25)}
.badge.bad{background:rgba(255,93,108,.12);color:var(--bad);border-color:rgba(255,93,108,.25)}
.badge.warn{background:rgba(247,185,85,.12);color:var(--warn);border-color:rgba(247,185,85,.25)}
.hr{height:1px;background:var(--line);margin:12px 0}
.small{font-size:12px;color:var(--muted);line-height:1.4}
.kv{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:12px;white-space:pre-wrap;background:rgba(0,0,0,.25);padding:10px;border-radius:14px;border:1px solid rgba(255,255,255,.08)}
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:10px;border-bottom:1px solid rgba(255,255,255,.08);text-align:left;font-size:13px}
.table th{color:var(--muted);font-weight:700}
.slotgrid{display:grid;grid-template-columns:repeat(12,minmax(0,1fr));gap:8px}
.slot{
  display:flex;align-items:center;gap:8px;
  padding:10px;border-radius:14px;border:1px solid rgba(255,255,255,.10);
  background:rgba(0,0,0,.16);
}
.slot input{width:16px;height:16px}
.featuregrid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
.feature{
  display:flex;align-items:center;gap:10px;padding:12px;border-radius:16px;
  border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.16)
}
.feature input{width:18px;height:18px}
.preview{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.preview img{max-height:86px;border-radius:14px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.18)}
.hidden{display:none !important}
@media (max-width: 860px){
  .slotgrid{grid-template-columns:repeat(6,minmax(0,1fr))}
  .featuregrid{grid-template-columns:1fr}
}
</style>
</head>
<body>
<div class="container">
  <div class="topbar">
    <span class="dot"></span>
    <div class="h1">Admin</div>
    <span class="pill" id="pillBuild">build: -</span>
    <span class="pill" id="pillConn">nicht verbunden</span>
    <span class="pill">Hinweis: Zugriff mit <b>x-sa-password</b> oder <b>Email-Login</b></span>
  </div>

  <div class="card">
    <div class="row">
      <div class="field" style="min-width:360px;flex:2">
        <label>Worker Base URL</label>
        <input id="apiBase" placeholder="https://...workers.dev"/>
        <div class="small">Wird lokal gespeichert. Keine .workers.de / .worker.de – nur .workers.dev</div>
      </div>
      <div class="field" style="min-width:260px;flex:1">
        <label>SA Password (Header: x-sa-password)</label>
        <input id="saPass" type="password" placeholder="optional"/>
        <div class="small">Wenn falsch → 403. Wird lokal gespeichert.</div>
      </div>
      
      <div class="field" style="min-width:240px;flex:1">
        <label>Email Login</label>
        <input id="loginEmail" placeholder="email@domain.de"/>
        <div class="small">Optional. Nur Admin darf User freischalten/rollen setzen.</div>
      </div>
      <div class="field" style="min-width:220px;flex:1">
        <label>Passwort</label>
        <input id="loginPass" type="password" placeholder="••••••••"/>
        <div class="small">Token wird lokal gespeichert (24h).</div>
      </div>
      <div class="field" style="min-width:220px;flex:0">
        <label>&nbsp;</label>
        <button class="btn secondary" id="btnLogin">Login</button>
      </div>

      <div class="field" style="min-width:220px;flex:0">
        <label>&nbsp;</label>
        <button class="btn" id="btnConnect">Connect</button>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="tabs" id="tabs"></div>

    <!-- CONFIG -->
    <div id="view-config" class="view">
      <div class="row" style="justify-content:space-between">
        <div class="badge" id="cfgStatus">Config</div>
        <div class="row">
          <button class="btn secondary" id="btnCfgLoad">Load</button>
          <button class="btn" id="btnCfgSave">Save</button>
        </div>
      </div>
      <div class="hr"></div>

      <div class="row">
        <div class="field">
          <label>Stations-PIN (Eingabe verdeckt)</label>
          <input id="cfgStationPin" type="password" placeholder="z.B. 1111"/>
          <div class="small">Nach <b>Load</b> zeigen wir unten Klartext (nur Admin-Ansicht).</div>
        </div>
        <div class="field">
          <label>Trockner Minuten (Slot läuft nach Buchung ab)</label>
          <input id="cfgDryerMinutes" type="number" min="10" step="1" placeholder="z.B. 90"/>
        </div>
        <div class="field">
          <label>Retention Days</label>
          <input id="cfgRetentionDays" type="number" min="1" step="1" placeholder="z.B. 30"/>
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label>daysPast (Vergangenheit in Tagen)</label>
          <input id="cfgDaysPast" type="number" min="0" step="1" placeholder="z.B. 7"/>
        </div>
        <div class="field">
          <label>daysFuture (Zukunft in Tagen)</label>
          <input id="cfgDaysFuture" type="number" min="0" step="1" placeholder="z.B. 6"/>
        </div>
        <div class="field">
          <label>Aktuelle Station-PIN (Klartext, nach Load)</label>
          <input id="cfgStationPinClear" disabled placeholder="—"/>
        </div>
      </div>

      <div class="hr"></div>
      <div class="small"><b>Waschslotzeiten</b> (Haken → Start-Stunden 0–23). Dauer wird im Portal automatisch als „bis zum nächsten Slot“ angezeigt.</div>
      <div class="slotgrid" id="slotGrid"></div>
      <div class="small" style="margin-top:6px">Aktiv: <span id="slotActiveText">—</span></div>

      <div class="hr"></div>
      <div class="small"><b>Features</b></div>
      <div class="featuregrid">
        <div class="feature"><input type="checkbox" id="fNews"><div><b>News aktiv</b><div class="small">Portal zeigt News-Banner</div></div></div>
        <div class="feature"><input type="checkbox" id="fFeedback"><div><b>Feedback aktiv</b><div class="small">Portal Feedback-Formular</div></div></div>
        <div class="feature"><input type="checkbox" id="fDefect"><div><b>User darf Defekt melden</b><div class="small">Defekt-Button im Portal</div></div></div>
        <div class="feature"><input type="checkbox" id="fOverbook"><div><b>Trockner überbuchen</b><div class="small">Überbuchen im Portal</div></div></div>
        <div class="feature"><input type="checkbox" id="fWhitecard"><div><b>Whitecard erlaubt</b><div class="small">User kann Whitecard selbst setzen</div></div></div>
        <div class="feature"><input type="checkbox" id="fWasherPopup"><div><b>Washer Popup</b><div class="small">Info-Popup + Bild</div></div></div>
        <div class="feature"><input type="checkbox" id="fDryerPopup"><div><b>Dryer Popup</b><div class="small">Info-Popup + Bild</div></div></div>
        <div class="feature"><input type="checkbox" id="fAllowUserHide"><div><b>User kann alte Buchungen ausblenden</b><div class="small">(Portal localStorage)</div></div></div>
      </div>

      <div class="hr"></div>
      <div class="row">
        <div class="field">
          <label>News Text</label>
          <textarea id="cfgNewsText" placeholder="Kurzer Hinweis..."></textarea>
        </div>
      </div>

      <div class="hr"></div>
      <div class="small"><b>Feedback Zielgruppen</b> (im Portal Drop-Down)</div>
      <div class="row">
        <label class="badge"><input type="checkbox" id="tPS" style="margin-right:8px"> PS</label>
        <label class="badge"><input type="checkbox" id="tSV" style="margin-right:8px"> SV</label>
        <label class="badge"><input type="checkbox" id="tAdmin" style="margin-right:8px"> Admin</label>
        <span class="badge warn">Antworten auf Feedback: INAKTIV (Worker-Route fehlt)</span>
      </div>

      <div class="hr"></div>
      <div class="small"><b>Popup Bilder</b> (wir speichern DataURL direkt in der DB in config.json)</div>
      <div class="row">
        <div class="field">
          <label>Washer Popup Image (URL oder DataURL)</label>
          <input id="cfgWasherImg" placeholder="https://... oder data:image/..."/>
          <div class="row" style="margin-top:8px">
            <input id="fileWasher" type="file" accept="image/*" />
            <button class="btn secondary" id="btnClearWasher">löschen</button>
          </div>
        </div>
        <div class="field">
          <label>Dryer Popup Image (URL oder DataURL)</label>
          <input id="cfgDryerImg" placeholder="https://... oder data:image/..."/>
          <div class="row" style="margin-top:8px">
            <input id="fileDryer" type="file" accept="image/*" />
            <button class="btn secondary" id="btnClearDryer">löschen</button>
          </div>
        </div>
      </div>
      <div class="preview">
        <div class="badge">Preview</div>
        <img id="imgPrevWasher" alt="washer preview" />
        <img id="imgPrevDryer" alt="dryer preview" />
      </div>

      <div class="hr"></div>
      <div class="small"><b>Weitere geplante Admin-Funktionen</b> (UI vorhanden, Worker fehlt noch):</div>
      <div class="row" style="flex-wrap:wrap">
        <span class="badge warn">Maschinen sperren/freigeben (INAKTIV)</span>
        <span class="badge warn">Defekt-Management (INAKTIV)</span>
        <span class="badge warn">Feedback Threads + Antworten (INAKTIV)</span>
        <span class="badge warn">Logs/Protocol/Rooms (INAKTIV)</span>
      </div>
    </div>

    <!-- USERS -->
    <div id="view-users" class="view hidden">
      <div class="row" style="justify-content:space-between">
        <div class="badge" id="usersStatus">Users</div>
        <div class="row">
          <button class="btn secondary" id="btnUsersLoad">Users laden</button>
        </div>
      </div>
      <div class="hr"></div>
      <div class="small">Rollenliste kommt aus der DB (RBAC Snapshot). Du kannst Rollen setzen, auch als SA.</div>
      <div class="hr"></div>
      <table class="table">
        <thead><tr><th>Email</th><th>Status</th><th>Wunsch</th><th>Role</th><th>Aktion</th></tr></thead>
        <tbody id="usersBody"></tbody>
      </table>
      <div class="hr"></div>
      <div class="badge ok">Email-Login/Registrierung: AKTIV (Admin via Token oder SA)</div>
    </div>

    <!-- RBAC -->
    <div id="view-rbac" class="view hidden">
      <div class="row" style="justify-content:space-between">
        <div class="badge" id="rbacStatus">RBAC</div>
        <div class="row">
          <button class="btn secondary" id="btnRbacLoad">RBAC Snapshot</button>
        </div>
      </div>
      <div class="hr"></div>
      <div class="kv" id="rbacOut">—</div>
      <div class="hr"></div>
      <div class="badge warn">Granulare Rechte/Perms editieren: INAKTIV (Routes fehlen)</div>
    </div>

    <!-- PLACEHOLDER TABS -->
    <div id="view-machines" class="view hidden"><div class="badge warn">Machines: INAKTIV (Worker Routes fehlen)</div></div>
    <div id="view-defects" class="view hidden"><div class="badge warn">Defects: INAKTIV (Worker Routes fehlen)</div></div>
    <div id="view-feedback" class="view hidden"><div class="badge warn">Feedback Inbox/Antworten: INAKTIV (Worker Routes fehlen)</div></div>
    <div id="view-logs" class="view hidden"><div class="badge warn">Logs: INAKTIV (Worker Routes fehlen)</div></div>
    <div id="view-rooms" class="view hidden"><div class="badge warn">Rooms / Room-Locks: INAKTIV (Worker Routes fehlen)</div></div>
    <div id="view-privacy" class="view hidden">
      <div class="badge">Privacy Meta</div>
      <div class="hr"></div>
      <button class="btn secondary" id="btnPrivacyLoad">/api/privacy/meta laden</button>
      <div class="hr"></div>
      <div class="kv" id="privacyOut">—</div>
    </div>

    <div class="hr"></div>
    <div class="small" id="msg"></div>
  </div>
</div>

<script>
(() => {
  const el = (id) => document.getElementById(id);
  const msg = (t, kind="") => {
    const m = el("msg");
    m.textContent = t || "";
    m.style.color = kind==="bad" ? "var(--bad)" : kind==="ok" ? "var(--good)" : "var(--muted)";
  };

  let API = "";
  let SA = "";
  let ROUTES = new Set();
  let TOKEN = localStorage.getItem('wp_admin_token') || "";
  
  // Prefill base URL
  try {
    const b = el("base");
    if (b && !b.value) b.value = "https://washportal-dev-worker.schluffi1220.workers.dev";
  } catch(_){
  }
let ROLE_OPTIONS = [];

  function normBase(u){
    u = (u||"").trim();
    u = u.replace(/\/+$/,'');
    if (!u) return "";
    return u;
  }

  async function jfetch(path, opts={}){
    if (!API) throw new Error("Kein Worker gesetzt.");
    const headers = Object.assign({}, opts.headers || {});
    if (SA) headers["x-sa-password"] = SA;
    if (TOKEN) headers["authorization"] = "Bearer " + TOKEN;
    headers["content-type"] = headers["content-type"] || "application/json";
    const res = await fetch(API + path, Object.assign({}, opts, { headers }));
    const ct = res.headers.get("content-type") || "";
    const data = ct.includes("application/json") ? await res.json() : { ok:false, status:res.status, message: await res.text() };
    if (!res.ok) throw Object.assign(new Error(data?.message || "HTTP "+res.status), { data, status: res.status });
    return data;
  }
  const jpost = (path, body) => jfetch(path, { method:"POST", body: JSON.stringify(body||{}) });
  const jget = (path) => jfetch(path, { method:"GET", headers: { "content-type": "text/plain" } });

  function setConn(ok, build=""){
    el("pillConn").textContent = ok ? "verbunden" : "nicht verbunden";
    el("pillConn").className = "pill " + (ok ? "" : "");
    el("pillBuild").textContent = "build: " + (build || "-");
  }

  function setCfgBadge(kind, text){
    const b = document.getElementById("cfgStatus");
    if (!b) return;
    b.textContent = text || "Config";
    b.classList.remove("ok","warn","bad");
    if (kind) b.classList.add(kind);
  }

  function tabButton(key, label, warn=false){
    const b = document.createElement("div");
    b.className = "tab";
    b.dataset.key = key;
    b.textContent = label + (warn ? " (INAKTIV)" : "");
    b.addEventListener("click", () => setTab(key));
    return b;
  }

  function setTab(key){
    for (const t of document.querySelectorAll(".tab")) t.classList.toggle("active", t.dataset.key===key);
    for (const v of document.querySelectorAll(".view")) v.classList.add("hidden");
    el("view-"+key).classList.remove("hidden");
  }

  function buildTabs(){
    const t = el("tabs");
    t.innerHTML = "";
    const active = (k) => ROUTES.has(k);
    // These are "capabilities" based on routes we actually have:
    t.appendChild(tabButton("config","Config", !active("/api/auth/admin/config/get")));
    t.appendChild(tabButton("users","Users", !active("/api/auth/admin/users/list")));
    t.appendChild(tabButton("rbac","RBAC", !active("/api/auth/admin/rbac/snapshot")));
    t.appendChild(tabButton("machines","Machines", true));
    t.appendChild(tabButton("defects","Defects", true));
    t.appendChild(tabButton("feedback","Feedback", true));
    t.appendChild(tabButton("logs","Logs", true));
    t.appendChild(tabButton("rooms","Rooms", true));
    t.appendChild(tabButton("privacy","Privacy", !active("/api/privacy/meta")));
    setTab("config");
  }

  function hoursFromChecks(){
    const hours=[];
    for (let h=0; h<24; h++){
      const cb = el("slot_"+h);
      if (cb && cb.checked) hours.push(h);
    }
    hours.sort((a,b)=>a-b);
    return hours;
  }
  function setChecksFromHours(hours){
    const set = new Set((hours||[]).map(n=>Number(n)));
    for (let h=0; h<24; h++){
      const cb = el("slot_"+h);
      if (cb) cb.checked = set.has(h);
    }
    updateSlotActiveText();
  }
  function updateSlotActiveText(){
    const hours = hoursFromChecks();
    el("slotActiveText").textContent = hours.length ? hours.map(h=>String(h).padStart(2,"0")+":00").join(", ") : "—";
  }
  function initSlotGrid(){
    const g = el("slotGrid");
    g.innerHTML = "";
    for (let h=0; h<24; h++){
      const d = document.createElement("label");
      d.className = "slot";
      d.innerHTML = `<input type="checkbox" id="slot_${h}"><span>${String(h).padStart(2,"0")}:00</span>`;
      g.appendChild(d);
      d.querySelector("input").addEventListener("change", updateSlotActiveText);
    }
  }

  function configToUI(cfg){
    cfg = cfg || {};
    el("cfgDryerMinutes").value = cfg.dryerMinutes ?? cfg.dryerSlotMinutes ?? cfg.dryer_slot_minutes ?? "";
    el("cfgRetentionDays").value = cfg.retentionDays ?? cfg.retention_days ?? "";
    el("cfgDaysPast").value = cfg.daysPast ?? cfg.days_past ?? "";
    el("cfgDaysFuture").value = cfg.daysFuture ?? cfg.days_future ?? "";
    // station pin: masked input empty (we don't re-fill), but show clear if present
    el("cfgStationPinClear").value = cfg.stationPin ?? cfg.station_pin ?? "—";

    const hours = cfg.washerHours ?? cfg.washer_hours ?? cfg.washerSlots ?? cfg.washer_slots ?? [];
    setChecksFromHours(hours);

    const features = cfg.features || cfg;
    el("fNews").checked = !!(features.newsEnabled ?? features.news ?? false);
    el("fFeedback").checked = !!(features.feedbackEnabled ?? features.feedback ?? false);
    el("fDefect").checked = !!(features.userCanReportDefect ?? features.userDefect ?? features.allowDefectReport ?? false);
    el("fOverbook").checked = !!(features.allowOverbook ?? features.overbook ?? false);
    el("fWhitecard").checked = !!(features.whitecardEnabled ?? features.whitecard ?? false);
    el("fWasherPopup").checked = !!(features.showWasherPopup ?? features.washerPopup ?? false);
    el("fDryerPopup").checked = !!(features.showDryerPopup ?? features.dryerPopup ?? false);
    el("fAllowUserHide").checked = true;

    el("cfgNewsText").value = cfg.newsText ?? cfg.news_text ?? "";

    // targets
    const targets = (cfg.feedbackTargets ?? cfg.feedback_targets ?? "ps,sv,admin").toString().toLowerCase();
    el("tPS").checked = targets.includes("ps");
    el("tSV").checked = targets.includes("sv");
    el("tAdmin").checked = targets.includes("admin");

    // images
    el("cfgWasherImg").value = cfg.washerPopupImage ?? cfg.washer_popup_image ?? "";
    el("cfgDryerImg").value = cfg.dryerPopupImage ?? cfg.dryer_popup_image ?? "";
    updatePreviews();
  }

  function uiToConfig(){
    const cfg = {};
    const stationPin = (el("cfgStationPin").value || "").trim();
    if (stationPin) cfg.stationPin = stationPin;

    cfg.dryerMinutes = Number(el("cfgDryerMinutes").value || 0) || 0;
    cfg.retentionDays = Number(el("cfgRetentionDays").value || 0) || 0;
    cfg.daysPast = Number(el("cfgDaysPast").value || 0) || 0;
    cfg.daysFuture = Number(el("cfgDaysFuture").value || 0) || 0;
    cfg.washerHours = hoursFromChecks();

    cfg.features = {
      newsEnabled: el("fNews").checked,
      feedbackEnabled: el("fFeedback").checked,
      userCanReportDefect: el("fDefect").checked,
      allowOverbook: el("fOverbook").checked,
      whitecardEnabled: el("fWhitecard").checked,
      showWasherPopup: el("fWasherPopup").checked,
      showDryerPopup: el("fDryerPopup").checked
    };

    cfg.newsText = el("cfgNewsText").value || "";

    const targets = [];
    if (el("tPS").checked) targets.push("ps");
    if (el("tSV").checked) targets.push("sv");
    if (el("tAdmin").checked) targets.push("admin");
    cfg.feedbackTargets = targets.join(",");

    cfg.washerPopupImage = (el("cfgWasherImg").value||"").trim();
    cfg.dryerPopupImage = (el("cfgDryerImg").value||"").trim();
    return cfg;
  }

  function updatePreviews(){
    const w = el("cfgWasherImg").value.trim();
    const d = el("cfgDryerImg").value.trim();
    const iw = el("imgPrevWasher");
    const id = el("imgPrevDryer");
    iw.src = w || "data:image/gif;base64,R0lGODlhAQABAAAAACw=";
    id.src = d || "data:image/gif;base64,R0lGODlhAQABAAAAACw=";
  }

  async function fileToDataURL(file){
    return await new Promise((resolve,reject)=>{
      const fr=new FileReader();
      fr.onerror=()=>reject(new Error("FileReader error"));
      fr.onload=()=>resolve(String(fr.result||""));
      fr.readAsDataURL(file);
    });
  }

  async function connect(){
    API = normBase(el("apiBase").value);
    SA = (el("saPass").value||"").trim();
    if (!API) { msg("Bitte Worker Base URL setzen.","bad"); return; }

    localStorage.setItem("wp_admin_apiBase", API);
    localStorage.setItem("wp_admin_sa", SA);

    msg("Verbinde...");
    setCfgBadge("warn","Config: (noch nicht geladen)");

    // load routes + status
    const routes = await jget("/api/_routes").catch(async () => ({ ok:false, routes:[] }));
    ROUTES = new Set((routes.routes||[]).map(r => String(r).split(" ").slice(1).join(" ")).filter(Boolean));

    const st = await jget("/api/_status");
    setConn(true, st.build || st.version || "-");
    buildTabs();
    msg("Verbunden. Worker: " + (st.build || "-"), "ok");
    if (ROUTES.has("/api/auth/admin/config/get")) setCfgBadge("warn","Config: bereit (Load klicken)");

    // preload RBAC roles list (optional)
    await loadRbac().catch(()=>{});
  }

  async function loadConfig(){
    const data = await jpost("/api/auth/admin/config/get", {});
    const cfg = data.config || data.cfg || data;
    configToUI(cfg);
    msg("Config geladen.", "ok");
    setCfgBadge("ok","Config: AKTIV");
  }

  async function saveConfig(){
    const cfg = uiToConfig();
    const data = await jpost("/api/auth/admin/config/set", { config: cfg });
    msg("Config gespeichert.", "ok");
    setCfgBadge("ok","Config: gespeichert");
    // reload to show cleartext station pin after set
    await loadConfig();
  }

  async function loadUsers(){
    const data = await jpost("/api/auth/admin/users/list", {});
    const users = data.users || data.items || [];
    const tbody = el("usersBody");
    tbody.innerHTML = "";
    for (const u of users){
      const tr = document.createElement("tr");
      const email = u.email || u.userEmail || "";
      const status = u.status || "";
      const role = u.role || "";
      const sel = document.createElement("select");
      const opts = (ROLE_OPTIONS.length ? ROLE_OPTIONS : [...new Set(users.map(x=>x.role).filter(Boolean))]).sort();
      for (const r of opts){
        const o = document.createElement("option");
        o.value = r; o.textContent = r;
        if (r === role) o.selected = true;
        sel.appendChild(o);
      }
      const btn = document.createElement("button");
      btn.className = "btn secondary";
      btn.textContent = "Role setzen";
      btn.addEventListener("click", async () => {
        btn.disabled = true;
        try{
          await jpost("/api/auth/admin/users/role/set", { email, role: sel.value });
          msg("Rolle gesetzt: "+email+" → "+sel.value, "ok");
          await loadUsers();
        } catch(e){
          msg("Fehler Role set: " + (e.data?.message || e.message), "bad");
        } finally { btn.disabled = false; }
      });
      const wish = (u.requestedRole || "").toString();
      const approve = document.createElement("button");
      approve.className = "btn secondary";
      approve.textContent = "Approve";
      approve.style.marginRight = "8px";
      approve.disabled = (status||"").toLowerCase() === "active";
      approve.addEventListener("click", async () => {
        approve.disabled = true;
        try{
          await jpost("/api/auth/admin/users/approve", { email });
          msg("Approved: " + email, "ok");
          await loadUsers();
        } catch(e){
          msg("Fehler Approve: " + (e.data?.message || e.message), "bad");
        }
      });

      const transfer = document.createElement("button");
      transfer.className = "btn secondary";
      transfer.textContent = "Transfer PS/SV";
      transfer.addEventListener("click", async () => {
        transfer.disabled = true;
        try{
          const r = (wish || sel.value || "").toLowerCase();
          if (r !== "ps" && r !== "sv") throw new Error("Wunschrolle muss ps oder sv sein.");
          await jpost("/api/auth/role/transfer/accept", { role: r, toEmail: email });
          msg("Transfer ausgeführt: " + r + " → " + email, "ok");
          await loadUsers();
        } catch(e){
          msg("Fehler Transfer: " + (e.data?.message || e.message), "bad");
        } finally { transfer.disabled = false; }
      });

      tr.innerHTML = `<td>${escapeHtml(email)}</td><td>${escapeHtml(status)}</td><td>${escapeHtml(wish)}</td>`;
      const tdRole = document.createElement("td"); tdRole.appendChild(sel);
      const tdAct = document.createElement("td");
      tdAct.appendChild(approve);
      tdAct.appendChild(btn);
      tdAct.appendChild(transfer);
      tr.appendChild(tdRole); tr.appendChild(tdAct);
      tbody.appendChild(tr);
    }
    msg("Users geladen: " + users.length, "ok");
  }

  async function loadRbac(){
    const data = await jpost("/api/auth/admin/rbac/snapshot", {});
    el("rbacOut").textContent = JSON.stringify(data, null, 2);
    // extract roles list
    const roles = data.roles || data.roleList || data.availableRoles || [];
    if (Array.isArray(roles) && roles.length){
      ROLE_OPTIONS = roles.map(String);
    } else if (typeof data === "object") {
      // fallback: parse from message or keys
      const txt = JSON.stringify(data);
      // crude: roles: [...] already handled
    }
    msg("RBAC Snapshot ok.", "ok");
    return data;
  }

  async function loadPrivacy(){
    const data = await jget("/api/privacy/meta");
    el("privacyOut").textContent = JSON.stringify(data, null, 2);
    msg("Privacy Meta geladen.", "ok");
  }

  function escapeHtml(s){
    return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  
  async function doLogin(){
    const email = (el("loginEmail").value||"").trim();
    const password = (el("loginPass").value||"").trim();
    if (!email || !password) { msg("Email & Passwort eingeben.", "bad"); return; }
    const data = await jpost("/api/auth/login", { email, password });
    TOKEN = data.token || "";
    localStorage.setItem("wp_admin_token", TOKEN);
    msg("Login ok (Token gespeichert).", "ok");
  }



  function setText(id, v) {
    const x = document.getElementById(id);
    if (x) x.textContent = (v === null || typeof v === "undefined" || v === "") ? "—" : String(v);
  }

  
  const ALL_PERMS = [
    { key:"users.list", label:"Userliste sehen" },
    { key:"users.approve", label:"User freischalten" },
    { key:"users.role.set", label:"Rolle setzen (direkt)" },
    { key:"role.transfer.accept", label:"PS/SV Übergabe" },
    { key:"rbac.snapshot", label:"RBAC Snapshot lesen" },
    { key:"rbac.perm.set", label:"RBAC bearbeiten" }
  ];

  function bool(v){ return String(v) === "1" || v === 1 || v === true; }

  async function setPerm(scope, target, perm, allowed){
    // RBAC ändern: nur SA
    const sa = (el("sa")?.value || el("saPassword")?.value || "").trim();
    if (!sa) { msg("RBAC ändern: nur SA (SA-Passwort oben eingeben).", "bad"); throw new Error("sa_required"); }
  
    const payload = { scope, perm, allowed: !!allowed };
    if (scope === "role") payload.role = target;
    else payload.email = target;
    await jpost("/api/auth/admin/rbac/perm/set", payload);
  }

  async function loadRbacSnapshot() {
    msg("");
    const snap = await jpost("/api/auth/admin/rbac/snapshot", {});
    setText("rbacRaw", JSON.stringify(snap, null, 2));

    const body = el("rbacRolesBody");
    body.innerHTML = "";
    (snap.roles || []).forEach(r => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${escapeHtml(r.role)}</td><td>${escapeHtml(String(r.cnt))}</td>`;
      body.appendChild(tr);
    });

    const ul = await jpost("/api/auth/admin/users/list", {});
    const users = ul.users || [];
    const ps = users.find(u => String(u.role||"").toLowerCase() === "ps" && String(u.status||"").toLowerCase()==="active");
    const sv = users.find(u => String(u.role||"").toLowerCase() === "sv" && String(u.status||"").toLowerCase()==="active");
    setText("rbacPs", ps ? ps.email : "—");
    setText("rbacSv", sv ? sv.email : "—");

    const roleMap = new Map();
    (snap.rolePermissions || []).forEach(rp => {
      const role = String(rp.role||"").toLowerCase();
      const perm = String(rp.perm||"");
      if (!roleMap.has(role)) roleMap.set(role, new Map());
      roleMap.get(role).set(perm, bool(rp.allowed));
    });

    const userMap = new Map();
    (snap.userOverrides || []).forEach(up => {
      const em = String(up.email||"").toLowerCase();
      const perm = String(up.perm||"");
      if (!userMap.has(em)) userMap.set(em, new Map());
      userMap.get(em).set(perm, bool(up.allowed));
    });

    const scope = (el("rbacScope")?.value || "role");
    const target = scope === "user" ? String(el("rbacUserEmail")?.value||"").trim().toLowerCase() : null;

    const roles = ["admin","ps","sv","user"];
    const mbody = el("rbacMatrixBody");
    mbody.innerHTML = "";

    ALL_PERMS.forEach(p => {
      const tr = document.createElement("tr");
      const cells = [];
      cells.push(`<td>${escapeHtml(p.label)}</td>`);
      cells.push(`<td>✅</td>`); // SA

      roles.forEach(role => {
        const allowed = scope === "role"
          ? (roleMap.get(role)?.get(p.key) || false)
          : (target ? (userMap.get(target)?.get(p.key) || false) : false);

        const disabled = (scope === "user" && !target) ? "disabled" : "";
        const checked = allowed ? "checked" : "";
        const saPresent = ((el("sa")?.value||el("saPassword")?.value||"").trim().length>0);
        const dis2 = (!saPresent) ? "disabled" : disabled;
        cells.push(`<td><input type="checkbox" ${checked} ${dis2} data-role="${role}" data-perm="${escapeHtml(p.key)}"/></td>`);
      });

      tr.innerHTML = cells.join("");
      mbody.appendChild(tr);
    });

    mbody.querySelectorAll("input[type=checkbox]").forEach(cb => {
      cb.addEventListener("change", async () => {
        try{
          const perm = cb.getAttribute("data-perm");
          const sc = el("rbacScope").value;
          if (sc === "role") {
            const role = cb.getAttribute("data-role");
            await setPerm("role", role, perm, cb.checked);
          } else {
            const email = String(el("rbacUserEmail").value||"").trim().toLowerCase();
            if (!email) { msg("Bitte User Email für Override angeben.", "bad"); cb.checked = !cb.checked; return; }
            await setPerm("user", email, perm, cb.checked);
          }
          msg("Gespeichert.", "ok");
        } catch(e){
          msg("Fehler Speichern: " + (e.data?.message || e.message), "bad");
          cb.checked = !cb.checked;
        }
      });
    });
  }



  // wire
  initSlotGrid();
  el("btnConnect").addEventListener("click", () => connect().catch(e => msg(e.data?.message || e.message, "bad")));
  el("btnLogin").addEventListener("click", () => doLogin().catch(e => msg(e.data?.message || e.message, "bad")));
  el("btnCfgLoad").addEventListener("click", () => loadConfig().catch(e => msg(e.data?.message || e.message, "bad")));
  el("btnCfgSave").addEventListener("click", () => saveConfig().catch(e => msg(e.data?.message || e.message, "bad")));
  el("btnUsersLoad").addEventListener("click", () => loadUsers().catch(e => msg(e.data?.message || e.message, "bad")));
  el("btnRbacLoad").addEventListener("click", () => loadRbac().catch(e => msg(e.data?.message || e.message, "bad")));
  el("btnPrivacyLoad").addEventListener("click", () => loadPrivacy().catch(e => msg(e.data?.message || e.message, "bad")));

  el("cfgWasherImg").addEventListener("input", updatePreviews);
  el("cfgDryerImg").addEventListener("input", updatePreviews);

  el("btnClearWasher").addEventListener("click", () => { el("cfgWasherImg").value=""; updatePreviews(); });
  el("btnClearDryer").addEventListener("click", () => { el("cfgDryerImg").value=""; updatePreviews(); });

  el("fileWasher").addEventListener("change", async (ev) => {
    const f = ev.target.files?.[0]; if (!f) return;
    el("cfgWasherImg").value = await fileToDataURL(f);
    updatePreviews();
    msg("Washer Bild geladen (DataURL). Nicht vergessen: Save.", "ok");
  });
  el("fileDryer").addEventListener("change", async (ev) => {
    const f = ev.target.files?.[0]; if (!f) return;
    el("cfgDryerImg").value = await fileToDataURL(f);
    updatePreviews();
    msg("Dryer Bild geladen (DataURL). Nicht vergessen: Save.", "ok");
  });

  // restore
  el("apiBase").value = localStorage.getItem("wp_admin_apiBase") || "";
  el("saPass").value = localStorage.getItem("wp_admin_sa") || "";
  buildTabs();
  updatePreviews();
})();
</script>
</body>
</html>
