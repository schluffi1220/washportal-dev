<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Washportal (DEV)</title>
  <style>
    :root{
      --bg:#08111f; --panel:#0f1c2f; --panel2:#10243b; --line:rgba(255,255,255,.08);
      --text:#eaf1ff; --muted:rgba(234,241,255,.70);
      --ok:#2dd4bf; --bad:#ef4444; --warn:#f59e0b; --blue:#60a5fa;
      --btn:#1f2d44; --btn2:#263a59;
      --shadow: 0 18px 50px rgba(0,0,0,.45);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: radial-gradient(1200px 600px at 30% 10%, rgba(45,212,191,.18), transparent 55%),
                  radial-gradient(900px 500px at 85% 35%, rgba(96,165,250,.16), transparent 50%),
                  linear-gradient(180deg, #061022, var(--bg));
      color:var(--text);
    }
    .wrap{max-width:1180px; margin:24px auto 80px; padding:0 16px;}
    .topbar{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:16px;}
    .pill{display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px;
      border:1px solid var(--line); background:rgba(255,255,255,.04); font-size:13px; color:var(--muted)}
    .pill strong{color:var(--text); font-weight:700}
    .pill .dot{width:8px; height:8px; border-radius:99px; background:var(--ok); box-shadow:0 0 0 3px rgba(45,212,191,.15)}
    .err{display:none; margin:10px 0 16px; padding:12px 14px; border-radius:14px; border:1px solid rgba(239,68,68,.35);
      background:rgba(239,68,68,.10); color:#ffd5d5}
    .grid{display:grid; grid-template-columns: 1fr; gap:16px;}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow);
      padding:16px;
    }
    h1{margin:0 0 4px; font-size:20px}
    h2{margin:0 0 12px; font-size:18px}
    .muted{color:var(--muted); font-size:13px}
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end}
    .field{min-width:180px; flex:1}
    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
    input, select, textarea{
      width:100%; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.20); color:var(--text); outline:none;
    }
    textarea{min-height:44px; resize:vertical}
    .btn{
      padding:10px 14px; border-radius:14px; border:1px solid rgba(255,255,255,.12);
      background:linear-gradient(90deg, rgba(96,165,250,.25), rgba(45,212,191,.25));
      color:var(--text); font-weight:700; cursor:pointer;
      transition:transform .05s ease, filter .15s ease;
    }
    .btn:active{transform:translateY(1px)}
    .btn.secondary{background:rgba(255,255,255,.05); font-weight:600}
    .btn.danger{background:rgba(239,68,68,.18); border-color:rgba(239,68,68,.35)}
    .btn.small{padding:8px 10px; border-radius:12px; font-size:13px}
    .machines{
      display:grid; gap:12px;
      grid-template-columns: repeat(4, minmax(0, 1fr));
    }
    @media (max-width: 980px){ .machines{grid-template-columns: repeat(2, minmax(0, 1fr));} }
    @media (max-width: 520px){ .machines{grid-template-columns: 1fr;} }
    .mcard{
      background:rgba(255,255,255,.03); border:1px solid var(--line); border-radius:16px; padding:14px;
      display:flex; flex-direction:column; gap:10px; min-height:150px;
    }
    .mcard.state-free{border-color: rgba(45,212,191,.28); background: rgba(45,212,191,.14); box-shadow: 0 18px 50px rgba(0,0,0,.45), 0 0 0 1px rgba(45,212,191,.10) inset;}
    .mcard.state-busy{border-color: rgba(96,165,250,.30); background: rgba(96,165,250,.14); box-shadow: 0 18px 50px rgba(0,0,0,.45), 0 0 0 1px rgba(96,165,250,.10) inset;}
    .mcard.state-whitecard{border-color: rgba(255,255,255,.35); background: rgba(255,255,255,.20);}
    .mcard.state-defect{border-color: rgba(248,113,113,.55); background: rgba(248,113,113,.22);}


    .mhead{display:flex; justify-content:space-between; align-items:flex-start; gap:10px;}
    .mtitle{font-weight:800}
    .badge{font-size:12px; padding:5px 10px; border-radius:999px; border:1px solid var(--line); color:var(--muted); background:rgba(0,0,0,.15)}
    .badge.ok{color:#c7fffb; border-color:rgba(45,212,191,.35); background:rgba(45,212,191,.10)}
    .badge.busy{color:#dbeafe; border-color:rgba(96,165,250,.35); background:rgba(96,165,250,.10)}
    .badge.bad{color:#ffd5d5; border-color:rgba(239,68,68,.35); background:rgba(239,68,68,.10)}
    .mp{font-size:13px; color:var(--muted); line-height:1.3}
    .mcontrols{margin-top:auto; display:flex; flex-direction:column; gap:10px}
    .inline{display:flex; gap:10px; align-items:center}
    .inline select{flex:1}
    .list{display:flex; flex-direction:column; gap:10px}
    .item{border:1px solid var(--line); background:rgba(255,255,255,.03); border-radius:14px; padding:12px}
    .itemtop{display:flex; justify-content:space-between; gap:10px; align-items:flex-start}
    .item h3{margin:0; font-size:14px}
    .item .meta{margin-top:6px; font-size:13px; color:var(--muted)}
    .divider{height:1px; background:var(--line); margin:10px 0}
    .footer-note{margin-top:14px; font-size:12px; color:rgba(234,241,255,.55)}
  
  .card.machine{position:relative;}
  .card.machine.locked{background:rgba(160,160,160,.22); border-color: rgba(120,120,120,.35);}
  .card.machine.defect{background:rgba(255,80,80,.18); border-color: rgba(255,80,80,.40);}
  .card.machine .mhead{display:flex; align-items:center; justify-content:space-between; gap:10px;}
  .card.machine .mmeta{margin-top:8px; display:flex; flex-direction:column; gap:4px;}
  .card.machine .mcontrols{margin-top:12px; display:flex; flex-wrap:wrap; gap:8px; align-items:center;}
  .badge.bad{background:rgba(255,60,60,.22); border:1px solid rgba(255,60,60,.45);}
  .badge.locked{background:rgba(120,120,120,.22); border:1px solid rgba(120,120,120,.45);}
  .check{display:flex; align-items:center; gap:8px; padding:6px 10px; border:1px solid var(--line); border-radius:12px; background:rgba(255,255,255,.55);}
  .check .cb{width:18px; height:18px;}


    .mbox{padding:12px;border:1px solid rgba(255,255,255,.08);border-radius:14px;background:rgba(255,255,255,.03);margin-bottom:10px}
    .pill{font-size:11px;padding:4px 8px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.10)}

    /* bessere Lesbarkeit in Dropdowns */
    select.select, select.sel{
      background:#f8fafc;
      color:#0b1220;
      font-weight:600;
    }
    select.select option, select.sel option{ color:#0b1220; }
    select.select option:disabled, select.sel option:disabled{ color:#64748b; }

  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="pill"><span class="dot"></span><strong>Washportal</strong></div>
      <div class="pill">PORTAL BUILD: <strong id="portalBuild">2026-02-15 PORTAL</strong></div>
      <div class="pill">Worker: <strong id="workerBuild">-</strong></div>
      <div class="pill">Zimmer: <strong id="roomPill">-</strong></div>
    </div>

    <div id="err" class="err"></div>

    <div class="grid">

      <div class="card" id="newsCard" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
          <h2 style="margin:0">News</h2>
          <span class="badge busy" id="newsBadge">INFO</span>
        </div>
        <div class="divider"></div>
        <div id="newsText" style="white-space:pre-wrap;line-height:1.45"></div>
      </div>

      <div class="card">
        <h2>Login</h2>
        <div class="row">
          <div class="field"><label>Zimmer</label><input id="room" inputmode="numeric" placeholder="z.B. 316"></div>
          <div class="field"><label>Persönlicher PIN</label><input id="pin" type="password" inputmode="numeric" placeholder="PIN" autocomplete="off"></div>
          <div class="field"><label>Stations-PIN</label><input id="stationPin" type="password" inputmode="numeric" placeholder="Stations-PIN" autocomplete="off"></div>
          <button class="btn" id="saveBtn">Speichern</button>
          <button class="btn secondary" id="refreshBtn">Aktualisieren</button>
        </div>
        <div class="footer-note">Hinweis: Slot‑Buchung nutzt deinen persönlichen PIN (Storno/Freigabe nur für dich). Stations‑PIN wird zusätzlich geprüft.</div>
      </div>

      <div class="card" id="quickBookCard">
        <h2>Slots buchen (Waschmaschinen)</h2>
        <div class="muted" style="margin-top:-6px">Wähle je Maschine einen Slot in der Zukunft (oder aktuell laufend) und buche direkt.</div>
        <div class="divider"></div>
        <div id="quickBook"></div>
      </div>

      <div class="card">
        <h2>Maschinenübersicht</h2>
        <div class="muted" id="legend">Grün = frei · Blau = läuft/gebucht · Rot = gesperrt/defekt</div>
        <div class="divider"></div>
        <div id="machines"></div>
      </div>

      <div class="card">
        <h2>Meine Buchungen</h2>
        <div class="list" id="myBookings"></div>
      </div>

      <div class="card" id="feedbackCard" style="display:none">
        <h2>Feedback</h2>
        <div class="muted" style="margin-top:-6px">Geht an die ausgewählte Zielgruppe (PS/SV/Admin), abhängig von der Config.</div>
        <div class="divider"></div>
        <div class="row" id="feedbackTargets" style="flex-wrap:wrap;justify-content:flex-start"></div>
        <div class="field" style="margin-top:10px">
          <label>Nachricht</label>
          <textarea id="fbText" rows="4" placeholder="Was sollen wir wissen?" style="width:100%;padding:12px 12px;border-radius:14px;background:rgba(255,255,255,.04);border:1px solid var(--line);color:var(--text)"></textarea>
        </div>
        <div class="row" style="justify-content:flex-end">
          <button class="btn" id="fbSend">Senden</button>
        </div>
        <div class="muted" id="fbHint"></div>
      </div>

    </div>
</div>
  </div>

<script>
// ---- Zeit/Format-Helpers (global) ----
function pad2(n){ return String(n).padStart(2,"0"); }
function fmtHM(ts){
  const d=new Date(Number(ts));
  return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
}
function fmtTime(ts){ return fmtHM(ts); }
function fmtDate(dayTs){
  const d=new Date(Number(dayTs));
  return `${pad2(d.getDate())}.${pad2(d.getMonth()+1)}`;
}
function fmtDow(ts){
  const d=new Date(Number(ts));
  const wd=['So','Mo','Di','Mi','Do','Fr','Sa'];
  return wd[d.getDay()]||'';
}
function fmtDateTime(ts){
  const d=new Date(Number(ts));
  return `${pad2(d.getDate())}.${pad2(d.getMonth()+1)} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
}

function fmtTime(ts){
  const d=new Date(Number(ts));
  return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
}
function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function startOfDay(ts){
  const d = new Date(Number(ts||Date.now()));
  d.setHours(0,0,0,0);
  return d.getTime();
}


  const API = "https://washportal-dev-worker.schluffi1220.workers.dev";
  const $ = (id) => document.getElementById(id);

  function showOk(msg){
    const el = $("err");
    el.style.display = msg ? "block" : "none";
    el.style.borderColor = "rgba(45,212,191,.35)";
    el.style.background = "rgba(45,212,191,.10)";
    el.style.color = "#c7fffb";
    el.textContent = msg || "";
  }

  function showErr(msg){
    const el = $("err");
    el.style.display = msg ? "block" : "none";
    el.style.borderColor = "rgba(239,68,68,.35)";
    el.style.background = "rgba(239,68,68,.10)";
    el.style.color = "#ffd5d5";
    el.textContent = msg || "";
  }


function showToast(msg){
  try{
    const el = document.getElementById("toast");
    if(!el) return;
    el.textContent = msg || "";
    el.style.display = msg ? "block" : "none";
    if(msg){
      clearTimeout(window.__toastT);
      window.__toastT = setTimeout(()=>{ el.style.display="none"; }, 1800);
    }
  }catch{}
}


  function fmtDT(ts){
    const d = new Date(Number(ts));
    if (isNaN(d.getTime())) return "—";
    return d.toLocaleString("de-DE", { weekday:"short", day:"2-digit", month:"2-digit", hour:"2-digit", minute:"2-digit" });
  }

  function loadCreds(){
    // bewusst keine Persistenz von Zimmer/PIN/Stations-PIN
    if($("room")) $("room").value = "";
    if($("pin")) $("pin").value = "";
    if($("stationPin")) $("stationPin").value = "";
  }
  function saveCreds(){
    // bewusst keine Persistenz von Zimmer/PIN/Stations-PIN
  }

  async function jpost(path, body){
    const r = await fetch(API + path, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(body || {})
    });
    const t = await r.text();
    let data = {};
    try{ data = JSON.parse(t); }catch{ data = { ok:false, error:"bad_json", message:t }; }
    if(!r.ok || data.ok === false){
      const msg = data?.message || data?.error || ("HTTP " + r.status);
      throw new Error(msg);
    }
    return data;
  }

  function buildWasherSlots(cfg){
    const raw = Array.isArray(cfg?.washerHours) ? cfg.washerHours : [];
    const hours = [...new Set(raw.map(x=>Number(x)).filter(x=>Number.isFinite(x) && x>=0 && x<=23))].sort((a,b)=>a-b);
    const daysFuture = Number(cfg?.daysFuture ?? 6);
    const now = Date.now();
    const today0 = startOfDay(now);
    const slots = [];
    if(!hours.length) return slots;

    const firstHour = hours[0];
    for(let day=0; day<=daysFuture; day++){
      const day0 = today0 + day*86400000;
      for(let i=0;i<hours.length;i++){
        const h = hours[i];
        const startAt = day0 + h*3600000;
        let endAt;
        if(i < hours.length-1){
          endAt = day0 + hours[i+1]*3600000;
        }else{
          // letzter Slot des Tages endet am nächsten Tag beim ersten Slot
          endAt = (day0 + 86400000) + firstHour*3600000;
        }
        if(endAt <= now) continue;
        const running = startAt <= now && endAt > now;
        const label = `${fmtDow(startAt)} ${fmtDate(startAt)} ${fmtHM(startAt)}–${fmtHM(endAt)}` + (running ? " (läuft)" : "");
        slots.push({ ts:startAt, startAt, endAt, label, running, disabled:false });
      }
    }
    slots.sort((a,b)=>a.startAt-b.startAt);
    return slots;
  }



  function activeBookingFor(machine, bookings){
    // bookings: global list im Zeitraum; finde aktiv/gebucht für Maschine
    const kind = machine.kind;
    const mid = String(machine.machineId);
    const now = Date.now();
    const rel = (bookings||[]).filter(b => String(b.kind)===kind && String(b.machineId)===mid);
    // Priorität: active/booked, dann released
    const act = rel.find(b => (b.status==="active" || b.status==="booked") && now < Number(b.endAt||0));
    if(act) return act;
    const last = rel.slice().sort((a,b)=>Number(b.endAt||0)-Number(a.endAt||0))[0];
    return last || null;
  }
  function findLastNext(bookings, kind, machineId){
    const now = Date.now();
    const rel = (bookings||[]).filter(b => String(b.kind)===String(kind) && String(b.machineId)===String(machineId))
      .slice()
      .sort((a,b)=>Number(a.startAt||0)-Number(b.startAt||0));
    let current = null, last = null, next = null;
    for(const b of rel){
      const st = Number(b.startAt||0);
      const en = Number(b.endAt||0);
      const active = (b.status==="booked" || b.status==="active") && en > now;
      if(active && st <= now && en > now){
        current = b;
      }
      if(en <= now){
        if(!last || Number(last.endAt||0) < en) last = b;
      }
      if(st > now){
        if(!next || st < Number(next.startAt||0)) next = b;
      }
    }
    // If there's an upcoming booking that already started (time drift), treat as current
    if(!current){
      const maybe = rel.find(b => (b.status==="booked"||b.status==="active") && Number(b.startAt||0) <= now && Number(b.endAt||0) > now);
      if(maybe) current = maybe;
    }
    return { current, last, next };
  }



  function isSlotTaken(bookings, kind, machineId, startAt){
    const s = Number(startAt);
    const e = s + 60*60*1000; // 60 min standard (Portal)
    return (bookings||[]).some(b => String(b.kind)===kind && String(b.machineId)===String(machineId) &&
      (b.status==="booked" || b.status==="active") &&
      Number(b.startAt) === s
    );
  }


  function findSlotBooking(bookings, kind, machineId, startAt){
    const s = Number(startAt);
    return (bookings||[]).find(b => String(b.kind)===String(kind) && String(b.machineId)===String(machineId) &&
      (b.status==="booked" || b.status==="active") &&
      Number(b.startAt) === s
    ) || null;
  }

  
  function renderNews(cfg){
    const card = $("newsCard");
    if(!card) return;
    const enabled = !!(cfg?.newsEnabled || cfg?.newsPsEnabled || cfg?.newsSvEnabled || cfg?.newsAdminEnabled);
    const txt = String(cfg?.newsText||"").trim();
    if(enabled && txt){
      card.style.display = "";
      $("newsText").textContent = txt;
    }else{
      card.style.display = "none";
    }
  }

  function renderQuickBook(state){
    const box = $("quickBook");
    if(!box) return;
    box.innerHTML = "";
    const cfg = state?.config||{};
    const machines = Array.isArray(state?.machines)?state.machines:[];
    const bookings = Array.isArray(state?.bookings)?state.bookings:[];
    const washers = machines.filter(m=>m.kind==="washer").sort((a,b)=>Number(a.machineId)-Number(b.machineId));
    const slots = buildWasherSlots(cfg);

    if(!washers.length){
      box.innerHTML = '<div class="muted">Keine Waschmaschinen gefunden.</div>';
      return;
    }
    if(!slots.length){
      box.innerHTML = '<div class="muted">Keine Wasch-Slots konfiguriert. (Config → washerHours)</div>';
      return;
    }

    const row = document.createElement("div");
    row.className = "row";
    row.style.alignItems = "center";
    row.style.gap = "10px";

    const sel = document.createElement("select");
    sel.className = "select";
    sel.style.flex = "1";
    sel.id = "qb_all";

    const now = Date.now();
    for(const m of washers){
      const og = document.createElement("optgroup");
      og.label = `Waschmaschine ${m.label}`;
      // für diese Maschine: Slotliste (laufend + Zukunft)
      for(const s of slots){
        if(Number(s.endAt) <= now) continue;
        const opt = document.createElement("option");
        const overlaps = bookings.filter(b =>
          String(b.kind)==="washer" &&
          String(b.machineId)===String(m.machineId) &&
          Number(b.startAt)===Number(s.startAt) &&
          (b.status==="active" || b.status==="booked") &&
          Number(b.endAt||0) > now
        );
        const occ = overlaps[0] || null;
        opt.value = JSON.stringify({ kind:"washer", machineId:m.machineId, startAt:s.startAt });
        opt.textContent = s.label + (occ ? `  — BELEGT (Zimmer ${occ.room})` : "");
        if(occ) opt.disabled = true;
        og.appendChild(opt);
      }
      sel.appendChild(og);
    }

    const btn = document.createElement("button");
    btn.className="btn";
    btn.textContent="Buchen";
    btn.onclick = async ()=>{
      const room = $("room").value.trim();
      const pin = $("pin").value.trim();
      const stationPin = $("stationPin").value.trim();
      if(!room || !pin){ return showErr("Zimmer & PIN fehlen."); }
      const v = sel.value;
      if(!v) return;
      const data = JSON.parse(v);
      try{
        await jpost("/api/washer/book",{ room, pin, stationPin, machineId:data.machineId, startAt: Number(data.startAt) });
        await refreshAll();
      }catch(e){ showErr(String(e?.message||e)); }
    };

    const hint = document.createElement("div");
    hint.className="muted";
    hint.style.minWidth="190px";
    hint.textContent="Waschmaschine + Slot auswählen";

    row.appendChild(hint);
    row.appendChild(sel);
    row.appendChild(btn);
    box.appendChild(row);
  }(cfg){
    const card = $("feedbackCard");
    if(!card) return;
    const targets = [];
    if(cfg?.feedbackPsEnabled) targets.push({k:"PS", label:"PS"});
    if(cfg?.feedbackSvEnabled) targets.push({k:"SV", label:"SV"});
    if(cfg?.feedbackAdminEnabled) targets.push({k:"Admin", label:"Admin"});
    if(!targets.length){
      card.style.display="none";
      return;
    }
    card.style.display="";
    const tgtBox = $("feedbackTargets");
    tgtBox.innerHTML="";
    let current = targets[0].k;
    for(const t of targets){
      const b = document.createElement("button");
      b.className="btn secondary";
      b.type="button";
      b.textContent=t.label;
      b.onclick=()=>{
        current=t.k;
        [...tgtBox.querySelectorAll("button")].forEach(x=>x.classList.add("secondary"));
        b.classList.remove("secondary");
      };
      tgtBox.appendChild(b);
    }
    // highlight first
    const first = tgtBox.querySelector("button");
    if(first) first.classList.remove("secondary");
    $("fbSend").onclick = async ()=>{
      const room = $("room").value.trim();
      const pin = $("pin").value.trim();
      const stationPin = $("stationPin").value.trim();
      const msg = String($("fbText").value||"").trim();
      if(!msg) return;
      try{
        await jpost("/api/feedback/submit",{ room, pin, stationPin, target: current, text: msg });
        $("fbText").value="";
        $("fbHint").textContent="Danke! Feedback wurde gesendet.";
        setTimeout(()=>{ $("fbHint").textContent=""; }, 2500);
      }catch(e){
        showErr(String(e?.message||e));
      }
    };
  }

function renderMachines(state){
    const box = $("machines");
    box.innerHTML = "";
    box.className = "machines";
    const cfg = state?.config || {};
    const machines = Array.isArray(state?.machines) ? state.machines : [];
    const bookings = Array.isArray(state?.bookings) ? state.bookings : [];
    const roomNow = String(state?.room || $("room").value || "");

    const washers = machines.filter(m=>m.kind==="washer").sort((a,b)=>Number(a.machineId)-Number(b.machineId));
    const dryers  = machines.filter(m=>m.kind==="dryer").sort((a,b)=>Number(a.machineId)-Number(b.machineId));
    const ordered = [...washers, ...dryers];

    const slots = buildWasherSlots(cfg);

    for(const m of ordered){
      const kindLabel = m.kind==="washer" ? "Waschmaschine" : "Trockner";
      const card = document.createElement("div");
      card.className = "card machine";

      // Status flags
      const isAdminLocked = Number(m.adminLocked||0)===1;
      const isDefect = Number(m.defect||0)===1;
      if(isAdminLocked) card.classList.add("locked");
      if(isDefect) card.classList.add("defect");
      if(Number(m.enabled||0)===0) card.classList.add("disabled");

      const head = document.createElement("div");
      head.className = "mhead";
      head.innerHTML = `<h3>${kindLabel} ${m.label}</h3>`;

      const { current, last, next } = findLastNext(bookings, m.kind, m.machineId);

      const badge = document.createElement("span");
      badge.className = "badge";
      if(isDefect) { badge.classList.add("bad"); badge.textContent = "DEFEKT"; }
      else if(isAdminLocked) { badge.classList.add("locked"); badge.textContent = "GESPERRT"; }
      else if(current) { badge.classList.add("busy"); badge.textContent = (current.kind==="dryer"?"LÄUFT":"BELEGT"); }
      else { badge.classList.add("ok"); badge.textContent = "FREI"; }
      head.appendChild(badge);

      const meta = document.createElement("div");
      meta.className = "mmeta";

      const curLine = document.createElement("div");
      curLine.className = "line";
      if(current){
        const until = fmtDateTime(current.endAt);
        const wc = Number(current.whitecard||0)===1 ? " • WEISSKARTE" : "";
        curLine.textContent = `Aktuell: Zimmer ${current.room} bis ${until}${wc}`;
      }else{
        curLine.textContent = "Aktuell: frei";
      }

      const lastLine = document.createElement("div");
      lastLine.className = "line muted";
      lastLine.textContent = last ? `Zuletzt: Zimmer ${last.room} bis ${fmtDateTime(last.endAt)}` : "Zuletzt: —";

      const nextLine = document.createElement("div");
      nextLine.className = "line muted";
      nextLine.textContent = next ? `Als nächstes: Zimmer ${next.room} ab ${fmtDateTime(next.startAt)}` : "Als nächstes: —";

      meta.appendChild(curLine);
      meta.appendChild(lastLine);
      meta.appendChild(nextLine);

      const controls = document.createElement("div");
      controls.className = "mcontrols";

      const disabled = isAdminLocked || isDefect;

      // Slot/Booking UI
      if(m.kind==="washer"){
        const sel = document.createElement("select");
        sel.className = "sel";
        for(const s of slots){
          const opt = document.createElement("option");
          opt.value = String(s.startAt);
          opt.textContent = s.label;
          // disable if started (worker would reject) OR collision without overbook
          const endAt = s.endAt;
          const overlaps = bookings.filter(b => b.kind==="washer" && String(b.machineId)===String(m.machineId) && (b.status==="booked"||b.status==="active") && !(Number(b.endAt)<=s.startAt || Number(b.startAt)>=endAt));
          const allWhite = overlaps.length>0 && overlaps.every(b=>Number(b.whitecard||0)===1);
          const collides = overlaps.length>0;
          if(s.disabled) opt.disabled = true;
          if(collides && !allWhite) opt.disabled = true;
          if(collides && allWhite) opt.textContent = opt.textContent + " • WEISSKARTE";
          sel.appendChild(opt);
        }

        const wcEnabled = !!cfg.whitecardEnabled;
        const wcWrap = document.createElement("label");
        wcWrap.className = "check";
        wcWrap.style.display = wcEnabled ? "flex" : "none";
        wcWrap.innerHTML = `<input type="checkbox" class="cb"><span>Weißkarte</span>`;
        const wcCb = wcWrap.querySelector("input");

        const btn = document.createElement("button");
        btn.className = "btn small";
        btn.textContent = "Buchen";
        btn.disabled = disabled;
        btn.onclick = async ()=>{
          showErr("");
          const room = $("room").value.trim();
          const pin = $("pin").value.trim();
          const stationPin = $("stationPin").value.trim();
          const startAt = Number(sel.value||0);
          if(!startAt) return showErr("Bitte Slot auswählen.");
          const endAt = startAt + 60*60000;

          const overlaps = bookings.filter(b => b.kind==="washer" && String(b.machineId)===String(m.machineId) && (b.status==="booked"||b.status==="active") && !(Number(b.endAt)<=startAt || Number(b.startAt)>=endAt));
          const allWhite = overlaps.length>0 && overlaps.every(b=>Number(b.whitecard||0)===1);
          const overbook = overlaps.length>0 && allWhite && wcEnabled ? confirm("Diese Maschine ist belegt, aber mit Weißkarte freigegeben. Überbuchen?") : false;

          try{
            await jpost("/api/washer/book",{ room, pin, stationPin, machineId:m.machineId, minutes:60, startAt, whitecard: wcCb?.checked?1:0, overbook });
            await refreshAll();
          }catch(e){ showErr("⛔ " + e.message); }
        };

        controls.appendChild(sel);
        controls.appendChild(wcWrap);
        controls.appendChild(btn);
      }else{
        const wcEnabled = !!cfg.whitecardEnabled;
        const wcWrap = document.createElement("label");
        wcWrap.className = "check";
        wcWrap.style.display = wcEnabled ? "flex" : "none";
        wcWrap.innerHTML = `<input type="checkbox" class="cb"><span>Weißkarte</span>`;
        const wcCb = wcWrap.querySelector("input");

        const btn = document.createElement("button");
        btn.className = "btn small";
        btn.textContent = "Jetzt buchen";
        btn.disabled = disabled;
        btn.onclick = async ()=>{
          showErr("");
          const room = $("room").value.trim();
          const pin = $("pin").value.trim();
          const stationPin = $("stationPin").value.trim();
          try{
            await jpost("/api/dryer/book",{ room, pin, stationPin, machineId:m.machineId, minutes: Number(cfg.dryerMinutes||150), whitecard: wcCb?.checked?1:0 });
            await refreshAll();
          }catch(e){ showErr("⛔ " + e.message); }
        };
        controls.appendChild(wcWrap);
        controls.appendChild(btn);
      }

      // Freigeben: nur eigene aktuelle Buchung
      if(current && String(current.room)===roomNow){
        const rel = document.createElement("button");
        rel.className = "btn small secondary";
        rel.textContent = "Freigeben";
        rel.disabled = disabled;
        rel.onclick = async ()=>{
          showErr("");
          const room = $("room").value.trim();
          const pin = $("pin").value.trim();
          const stationPin = $("stationPin").value.trim();
          try{
            await jpost("/api/booking/release",{ room, pin, stationPin, bookingId: current.id });
            await refreshAll();
          }catch(e){ showErr("⛔ " + e.message); }
        };
        controls.appendChild(rel);
      }

      // Defekt melden (Beschreibung optional)
      const def = document.createElement("button");
      def.className = "btn small danger";
      def.textContent = "Defekt";
      def.onclick = async ()=>{
        showErr("");
        const room = $("room").value.trim();
        const pin = $("pin").value.trim();
        const stationPin = $("stationPin").value.trim();
        const text = prompt("Defekt melden (optional Beschreibung):") ?? "";
        try{
          await jpost("/api/defect/report",{ room, pin, stationPin, machineId: m.machineId, kind: m.kind, text });
          await refreshAll();
        }catch(e){ showErr("⛔ " + e.message); }
      };
      controls.appendChild(def);

      card.appendChild(head);
      card.appendChild(meta);
      card.appendChild(controls);
      box.appendChild(card);
    }
  }

function fmtHM(ts){
  const d = new Date(Number(ts||0));
  if(!Number.isFinite(d.getTime())) return "–";
  return d.toLocaleTimeString("de-DE",{hour:"2-digit",minute:"2-digit"});
}

function updateGlobalBookPanel(state){
  const panel = document.getElementById("globalBookPanel");
  if(!panel) return;

  const cfg = state?.config || {};
  const kindSel = document.getElementById("gbKind");
  const machSel = document.getElementById("gbMachine");
  const slotSel = document.getElementById("gbSlot");
  const minSel = document.getElementById("gbMinutes");
  const wc = document.getElementById("gbWhitecard");
  const btn = document.getElementById("gbBookBtn");

  // Weißkarte nur wenn enabled
  const wcEnabled = !!cfg.whitecardEnabled;
  wc.disabled = !wcEnabled;
  if(!wcEnabled) wc.checked = false;

  const kind = kindSel.value;

  // Machines list
  machSel.innerHTML = "";
  const machines = (state?.machines||[]).filter(x => String(x.kind)===String(kind));
  for(const m of machines){
    const o=document.createElement("option");
    o.value = String(m.machineId);
    o.textContent = `${kind==="dryer"?"T":"W"}${m.label||m.machineId}`;
    if(!m.enabled) o.textContent += " (defekt)";
    machSel.appendChild(o);
  }

  // Slots
  slotSel.innerHTML = "";
  if(kind === "dryer"){
    // Trockner: Start sofort
    const o=document.createElement("option");
    o.value = String(Date.now());
    o.textContent = `Sofort (${fmtDateTime(Date.now())})`;
    slotSel.appendChild(o);
    minSel.value = String(cfg.dryerMinutes || 150);
  } else {
    const slots = buildWasherSlots(cfg);
    const bookings = Array.isArray(state?.bookings) ? state.bookings : [];
    for(const s of slots){
      const o=document.createElement("option");
      const ts = Number(s.ts ?? s.startAt ?? 0);
      o.value = String(ts);
      let label = String(s.label || "");
      const b = findSlotBooking(bookings, "washer", machSel.value, ts);
      if(b){
        // belegt: nur wählbar, wenn Weißkarte am bestehenden Slot aktiv ist
        const wcActive = !!Number(b.whitecard||0);
        if(wcActive && wcEnabled){
          o.dataset.whitecard = "1";
          label += " • Weißkarte";
          // bleibt wählbar -> Überbuchung bestätigen wir später
        } else {
          o.disabled = true;
          label += " • belegt";
        }
      }
      o.textContent = label;
      slotSel.appendChild(o);
    }
    if(!slotSel.value && slots.length) slotSel.value = String(slots[0].ts);
  }

  // Hook change to rebuild
  if(!kindSel._hooked){
    kindSel._hooked = true;
    kindSel.addEventListener("change", ()=>updateGlobalBookPanel(window.__STATE__));
    machSel.addEventListener("change", ()=>updateGlobalBookPanel(window.__STATE__));
  }

  if(!btn._hooked){
    btn._hooked = true;
    btn.addEventListener("click", async ()=>{
      const kind = kindSel.value;
      const machineId = machSel.value;
      const startAt = Number(slotSel.value||0);
      const minutes = Number(minSel.value||60);
      const whitecard = !!wc.checked;

      if(!machineId) return toast("⛔ Maschine fehlt");
      if(kind==="washer" && !startAt) return toast("⛔ Slot fehlt");

      const payload = { room, pin, stationPin, machineId, minutes, whitecard };
      if(kind==="washer") payload.startAt = startAt;
      if(kind==="dryer") payload.startAt = startAt;

      // überbuchen nur wenn Slot opt. WEISSKARTE markiert (Portal markiert das in Slot-Auswahl)
      const selOpt = slotSel?.options?.[slotSel.selectedIndex];
      if(selOpt && selOpt.dataset && selOpt.dataset.whitecard==="1"){
        const ok = confirm("Dieser Slot ist mit Weißkarte freigegeben. Überbuchen?");
        if(!ok) return;
        payload.overbook = true;
      }

      const url = kind==="dryer" ? "/api/dryer/book" : "/api/washer/book";
      await jpost(url, payload);
      toast("✅ Gebucht", 1200);
      await refreshAll();
    });
  }
}



  function renderMyBookings(state){
    const box = $("myBookings");
    if(!box) return;
    box.innerHTML = "";
    const room = String($("room").value||"").trim();
    const bookings = Array.isArray(state?.bookings) ? state.bookings : [];
    const mine = bookings
      .filter(b=>String(b.room||"")===room)
      .sort((a,b)=>Number(a.startAt||0)-Number(b.startAt||0));
    if(!mine.length){
      box.innerHTML = '<div class="muted">Keine aktiven/kommenden Buchungen.</div>';
      return;
    }
    const pin = String($("pin").value||"").trim();
    const stationPin = String($("stationPin").value||"").trim();

    for(const b of mine){
      const item = document.createElement("div");
      item.className = "mbox";
      const kindLabel = b.kind==="dryer" ? "Trockner" : "Waschmaschine";
      const when = `${fmtDateTime(b.startAt)}–${fmtTime(b.endAt)}`;
      const wc = Number(b.whitecard||0)===1 ? " • WEISSKARTE" : "";
      const st = (b.status||"active");
      item.innerHTML = `
        <div class="row" style="justify-content:space-between;gap:10px;align-items:center">
          <div>
            <div style="font-weight:700">${kindLabel} ${escapeHtml(String(b.machineId||""))}</div>
            <div class="muted" style="margin-top:2px">${escapeHtml(when)}${wc}</div>
          </div>
          <div class="row" style="gap:8px;align-items:center">
            <span class="pill">${escapeHtml(st)}</span>
            <button class="secondary tiny" data-act="release">Freigeben</button>
            <button class="tiny" data-act="cancel" style="margin-left:8px">Stornieren</button>
          </div>
        </div>`;
      const btnRelease = item.querySelector('[data-act="release"]');
      const btnCancel  = item.querySelector('[data-act="cancel"]');
      if(btnRelease) btnRelease.onclick = async ()=>{
        try{
          await jpost("/api/booking/release", { room, pin, stationPin, bookingId: b.bookingId || b.id || null, kind:b.kind, machineId:b.machineId, startAt:b.startAt });
          await refreshAll();
        }catch(e){ showErr("⛔ " + (e.message||e)); }
      };
      if(btnCancel) btnCancel.onclick = async ()=>{
        try{
          await jpost("/api/booking/cancel", { room, pin, stationPin, bookingId: b.bookingId || b.id || null, kind:b.kind, machineId:b.machineId, startAt:b.startAt });
          await refreshAll();
        }catch(e){ showErr("⛔ " + (e.message||e)); }
      };
      box.appendChild(item);
    }
  }

async function refreshAll(){

    showErr("");
    saveCreds();
    const room = $("room").value.trim();
    const pin = $("pin").value.trim();
    const stationPin = $("stationPin").value.trim();
    $("roomPill").textContent = room || "-";

    if(!room || !pin || !stationPin){
      showErr("Bitte Zimmer, persönlichen PIN und Stations-PIN eintragen.");
      return;<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Admin – Washportal</title>
<style>
  :root{
    color-scheme: dark;
    --bg:#070b12;
    --card:rgba(255,255,255,.035);
    --card2:rgba(255,255,255,.055);
    --line:rgba(255,255,255,.10);
    --txt:#e7eefc;
    --muted:rgba(231,238,252,.68);
    --good:#42d392;
    --warn:#ffcc66;
    --bad:#ff6b6b;
    --accent:#5aa7ff;
    --shadow: 0 12px 40px rgba(0,0,0,.35);
    --r:16px;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;background:radial-gradient(1200px 700px at 10% -10%, rgba(90,167,255,.18), transparent 60%),radial-gradient(800px 600px at 110% 0%, rgba(66,211,146,.10), transparent 55%),var(--bg);color:var(--txt)}
  a{color:inherit}
  .wrap{max-width:1200px;margin:0 auto;padding:14px}
  header{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:12px}
  .brand{display:flex;gap:10px;align-items:center}
  .logo{width:36px;height:36px;border-radius:12px;background:linear-gradient(135deg, rgba(90,167,255,.95), rgba(66,211,146,.8));box-shadow:var(--shadow)}
  h1{font-size:14px;margin:0;font-weight:900;letter-spacing:.4px}
  .sub{font-size:11px;color:var(--muted);margin-top:1px}
  .pills{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
  .pill{font-size:11px;padding:6px 9px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.03)}
  .pill.ok{border-color:rgba(66,211,146,.35)}
  .pill.bad{border-color:rgba(255,107,107,.35)}
  .grid{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:980px){.grid{grid-template-columns:340px 1fr}}
  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow)}
  .card .hd{padding:12px 12px 0 12px}
  .card .bd{padding:12px}
  .card h2{margin:0;font-size:12px;letter-spacing:.3px}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  label{display:block;font-size:11px;color:var(--muted);margin:0 0 6px 2px}
  input,select,textarea,button{width:100%;border-radius:14px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.05);color:var(--txt);padding:10px 11px;font-size:13px}
  textarea{min-height:120px;resize:vertical}
  button{cursor:pointer;background:linear-gradient(180deg, rgba(90,167,255,.25), rgba(90,167,255,.10));border-color:rgba(90,167,255,.35)}
  button.secondary{background:rgba(255,255,255,.05);border-color:rgba(255,255,255,.14)}
  button.danger{background:linear-gradient(180deg, rgba(255,107,107,.22), rgba(255,107,107,.10));border-color:rgba(255,107,107,.35)}
  button.good{background:linear-gradient(180deg, rgba(66,211,146,.20), rgba(66,211,146,.09));border-color:rgba(66,211,146,.35)}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
  .tab{padding:8px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.03);font-size:12px;cursor:pointer}
  .tab.active{border-color:rgba(90,167,255,.5);background:rgba(90,167,255,.12)}
  .muted{color:var(--muted)}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:11px;white-space:pre-wrap;word-break:break-word;background:rgba(0,0,0,.22);border-radius:14px;padding:10px;border:1px solid rgba(255,255,255,.10);max-height:320px;overflow:auto}
  table{width:100%;border-collapse:separate;border-spacing:0 8px}
  td,th{padding:10px 10px;font-size:12px;text-align:left;vertical-align:top}
  th{color:var(--muted);font-weight:700}
  tr{background:rgba(255,255,255,.03);border:1px solid var(--line)}
  tr td:first-child, tr th:first-child{border-top-left-radius:14px;border-bottom-left-radius:14px}
  tr td:last-child, tr th:last-child{border-top-right-radius:14px;border-bottom-right-radius:14px}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  .tiny{font-size:11px;padding:7px 9px;border-radius:12px}
  .toast{position:fixed;left:50%;bottom:14px;transform:translateX(-50%);background:rgba(0,0,0,.75);border:1px solid rgba(255,255,255,.18);backdrop-filter:blur(10px);padding:10px 12px;border-radius:14px;max-width:92vw;z-index:9999;font-size:12px}
  .split{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:1100px){.split{grid-template-columns:1fr 1fr}}

.grid2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
@media(max-width:900px){.grid2{grid-template-columns:1fr}}

    .hoursgrid{display:grid;grid-template-columns:repeat(12, minmax(0,1fr));gap:8px}
    .hourbox{display:flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid rgba(255,255,255,.12);border-radius:12px;background:rgba(0,0,0,.12)}
    .hourbox input{width:16px;height:16px}
    .check2{display:flex;gap:10px;align-items:center;padding:10px 12px;border:1px solid rgba(255,255,255,.12);border-radius:14px;background:rgba(0,0,0,.12);cursor:pointer}
    .check2 input{width:18px;height:18px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>Washportal Admin</h1>
        <div class="sub">Accounts + RBAC + Betrieb · funktioniert mit <span class="muted">Worker_full.js</span></div>
      </div>
    </div>
    <div class="pills">
      <span id="pillAuth" class="pill bad">nicht verbunden</span>
      <span id="pillUser" class="pill">–</span>
      <span id="pillRole" class="pill">–</span>
      <span id="pillBuild" class="pill">build: –</span>
    </div>
  </header>

  <div class="grid">
    <!-- left: connection + auth -->
    <div class="card">
      <div class="hd"><h2>Verbindung & Login</h2></div>
      <div class="bd">
        <div style="margin-bottom:10px">
          <label>API Base (Worker URL)</label>
          <input id="baseUrl" placeholder="https://<dein-worker>.workers.dev" />
        </div>

        <div class="split">
          <div>
            <label>Super-Admin Passwort (Header: x-sa-password)</label>
            <input id="sa" type="password" placeholder="optional, aber empfohlen" />
            <div class="actions" style="margin-top:8px">
              <button class="secondary tiny" id="btnMeSa">SA → /api/auth/me</button>
            </div>
            <div class="muted" style="font-size:11px;margin-top:6px">SA ist für Bootstrap/RBAC/Config gedacht. Token-Login ist für normale Admin-User.</div>
          </div>

          <div>
            <label>Token (Bearer)</label>
            <input id="token" placeholder="wird nach Login gesetzt" />
            <div class="actions" style="margin-top:8px">
              <button class="secondary tiny" id="btnMeToken">Token → /api/auth/me</button>
              <button class="secondary tiny" id="btnLogout">Logout</button>
            </div>
          </div>
        </div>

        <hr style="border:none;border-top:1px solid var(--line);margin:12px 0">

        <div class="split">
          <div>
            <h2 style="margin:0 0 8px 0">Login</h2>
            <label>Email</label><input id="loginEmail" placeholder="admin@example.com" />
            <label style="margin-top:8px">Passwort</label><input id="loginPw" type="password" placeholder="••••••••" />
            <div class="actions" style="margin-top:8px">
              <button class="tiny" id="btnLogin">Login</button>
            </div>
          </div>

          <div>
            <h2 style="margin:0 0 8px 0">Registrieren</h2>
            <label>Email</label><input id="regEmail" placeholder="neu@example.com" />
            <label style="margin-top:8px">Passwort (min. 8)</label><input id="regPw" type="password" placeholder="••••••••" />
            <div class="actions" style="margin-top:8px">
              <button class="good tiny" id="btnRegister">Account anlegen</button>
            </div>
            <div class="muted" style="font-size:11px;margin-top:6px">Der <b>allererste</b> Account wird automatisch <b>admin + aktiv</b>. Danach landen neue Accounts in <b>pending</b> (Freigabe im Tab „Users“).</div>
          </div>
        </div>

        <hr style="border:none;border-top:1px solid var(--line);margin:12px 0">

        <h2 style="margin:0 0 8px 0">Stations-PIN</h2>
        <div class="split">
          <div>
            <label>Neue PIN</label><input id="stationPin1" type="password" placeholder="mind. 4" />
          </div>
          <div>
            <label>Wiederholen</label><input id="stationPin2" type="password" placeholder="…" />
            <div class="muted" id="stationPinCurrent" style="margin-top:6px">Aktuelle PIN: <span id="pinCurrent">–</span></div>
          </div>
        </div>
        <div class="actions" style="margin-top:8px">
          <button class="tiny" id="btnStationPin">PIN setzen</button>
          <button class="secondary tiny" id="btnRoutes">/api/_routes</button>
          <button class="secondary tiny" id="btnStatus">/api/_status</button>
        </div>
      </div>
    </div>

    <!-- right: app -->
    <div class="card">
      <div class="hd"><h2>Konsole</h2></div>
      <div class="bd">
        <div class="tabs" id="tabs">
          <div class="tab active" data-tab="dash">Dashboard</div>
          <div class="tab" data-tab="users">Users</div>
          <div class="tab" data-tab="rbac">RBAC</div>
          <div class="tab" data-tab="config">Config</div>
          <div class="tab" data-tab="bookings">Bookings</div>
          <div class="tab" data-tab="logs">Logs</div>
          <div class="tab" data-tab="rooms">Rooms</div>
        </div>

        <div id="viewDash">
          <div class="row">
            <div style="flex:1">
              <h2 style="margin:0 0 8px 0">Quick Actions</h2>
              <div class="actions">
                <button class="secondary tiny" id="btnMe">/api/auth/me</button>
                <button class="secondary tiny" id="btnLoadUsers">Users laden</button>
                <button class="secondary tiny" id="btnLoadRbac">RBAC Snapshot</button>
                <button class="secondary tiny" id="btnCfgLoad">Config laden</button>
                <button class="secondary tiny" id="btnBkLoad">Bookings laden</button>
                <button class="secondary tiny" id="btnLogsLoad">Logs laden</button>
              </div>
              <div class="muted" style="font-size:11px;margin-top:8px">
                Tipp: Wenn du <b>SA</b> nutzt, trägst du das Passwort links ein – es wird automatisch in <code>x-sa-password</code> gesendet.
              </div>
            </div>
          </div>
        </div>

        <div id="viewUsers" style="display:none">
          <div class="actions" style="margin-bottom:8px">
            <button class="secondary tiny" id="btnUsersRefresh">Refresh</button>
          </div>
          <div id="usersHost" class="mono">—</div>
        </div>

        <div id="viewRbac" style="display:none">
          <div class="actions" style="margin-bottom:8px">
            <select id="rbacRole" style="max-width:260px"></select>
            <button class="secondary tiny" id="btnRbacLoadRole">Role laden</button>
            <button class="tiny" id="btnRbacSave">Speichern</button>
          </div>
          <div id="rbacHost"></div>
        </div>

        <div id="viewConfig" style="display:none">
          <div class="actions" style="margin-bottom:10px;align-items:flex-end">
            <button class="secondary tiny" id="btnCfgRefresh">Refresh</button>
            <button class="tiny" id="btnCfgSave">Speichern</button>
          </div>

          
          <div class="card" style="margin-bottom:10px">
            <h2 style="margin:0 0 10px 0">Config (grafisch)</h2>

            <div class="grid2">
              <div>
                <label>daysPast <span class="muted">(Vergangenheit in Tagen)</span></label>
                <input id="cfgDaysPast" type="number" min="0" step="1" placeholder="z.B. 7"/>
              </div>
              <div>
                <label>daysFuture <span class="muted">(Zukunft in Tagen)</span></label>
                <input id="cfgDaysFuture" type="number" min="0" step="1" placeholder="z.B. 6"/>
              </div>

              <div>
                <label>dryerMinutes <span class="muted">(Trockner Dauer)</span></label>
                <input id="cfgDryerMinutes" type="number" min="1" step="1" placeholder="z.B. 150"/>
              </div>
              <div>
                <label>Wasch-Slots (washerHours)</label>
                <input id="cfgWasherHoursText" type="text" placeholder="z.B. 6,8,10,12,14,16,18,20"/>
                <div class="muted" style="font-size:11px;margin-top:6px">Komma-separierte Stunden (0–23). Haken unten werden automatisch synchronisiert.</div>
              </div>

              <div class="card" style="grid-column:1 / -1; padding:12px; background:rgba(255,255,255,.04)">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                  <div style="font-weight:700">Wasch-Slots auswählen</div>
                  <div class="row" style="gap:8px">
                    <button class="secondary tiny" id="cfgHoursStd">Standard</button>
                    <button class="secondary tiny" id="cfgHoursClear">Alle aus</button>
                  </div>
                </div>
                <div id="cfgWasherHoursGrid" class="hoursgrid"></div>
                <div id="cfgHoursText" class="muted" style="margin-top:8px">Aktiv: –</div>
              </div>

              <div class="card" style="grid-column:1 / -1; padding:12px; background:rgba(255,255,255,.04)">
                <div style="font-weight:700;margin-bottom:8px">Features</div>
                <div class="grid2" style="gap:10px">
                  <label class="check2"><input id="cfgWhitecardEnabled" type="checkbox"/><span>Weißkarte aktiv</span></label>
                  <label class="check2"><input id="cfgPortalDebugEnabled" type="checkbox"/><span>Portal Debug</span></label>
                  <label class="check2"><input id="cfgNewsEnabled" type="checkbox"/><span>News/Info Banner</span></label>
                  <label class="check2"><input id="cfgChatEnabled" type="checkbox"/><span>Chat aktiv</span></label>
                  <label class="check2"><input id="cfgWasherPopup" type="checkbox"/><span>Washer Popup</span></label>
                  <label class="check2"><input id="cfgDryerPopup" type="checkbox"/><span>Dryer Popup</span></label>
                  <div style="grid-column:1 / -1; height:1px; background:rgba(255,255,255,.06); margin:6px 0"></div>
                  <div class="muted" style="grid-column:1 / -1; font-size:11px; margin-top:-2px">Zielgruppen (optional): wer sieht Feedback/News</div>
                  <label class="check2"><input id="cfgFeedbackPsEnabled" type="checkbox"/><span>Feedback für PS</span></label>
                  <label class="check2"><input id="cfgFeedbackSvEnabled" type="checkbox"/><span>Feedback für SV</span></label>
                  <label class="check2"><input id="cfgFeedbackAdminEnabled" type="checkbox"/><span>Feedback für Admin</span></label>
                  <label class="check2"><input id="cfgNewsPsEnabled" type="checkbox"/><span>News für PS</span></label>
                  <label class="check2"><input id="cfgNewsSvEnabled" type="checkbox"/><span>News für SV</span></label>
                  <label class="check2"><input id="cfgNewsAdminEnabled" type="checkbox"/><span>News für Admin</span></label>

                </div>
              </div>

              <div style="grid-column:1 / -1">
                <label>newsText <span class="muted">(nur wenn News aktiv)</span></label>
                <textarea id="cfgNewsText" style="min-height:84px" placeholder="Kurzer Hinweis…"></textarea>
              </div>
            </div>

            <div class="muted" style="font-size:11px;margin-top:10px">
              Tipp: Du kannst unten jederzeit auch das Raw-JSON bearbeiten – Form &amp; JSON synchronisieren sich.
            </div>
          </div>
<label>Config JSON (Raw)</label>
          <textarea id="cfgRaw" spellcheck="false"></textarea>
          <div class="muted" style="font-size:11px;margin-top:6px">Wird gespeichert nach <code>/api/auth/admin/config/set</code>.</div>
        </div>

        <div id="viewBookings" style="display:none">
          <div class="actions" style="margin-bottom:8px">
            <input id="bkMachine" placeholder="machine (optional), z.B. 1" style="max-width:220px"/>
            <select id="bkStatus" style="max-width:220px">
              <option value="">status (alle)</option>
              <option value="booked">booked</option>
              <option value="cancelled">cancelled</option>
              <option value="released">released</option>
            </select>
            <button class="secondary tiny" id="btnBkRefresh">Refresh</button>
            <button class="secondary tiny" id="btnBkCsv">CSV Export</button>
          </div>
          <div id="bkHost"></div>
        </div>

        <div id="viewLogs" style="display:none">
          <div class="actions" style="margin-bottom:8px">
            <input id="logQ" placeholder="Suche (action/actor/room/meta)" />
            <button class="secondary tiny" id="btnLogsRefresh">Refresh</button>
            <button class="secondary tiny" id="btnLogsCsv">CSV Export</button>
          </div>
          <div id="logsHost"></div>
        </div>

        <div id="viewRooms" style="display:none">
          <div class="actions" style="margin-bottom:8px">
            <button class="secondary tiny" id="btnRoomsRefresh">Refresh</button>
          </div>
          <div class="split">
            <div>
              <h2 style="margin:0 0 8px 0">Zimmer sperren</h2>
              <label>Zimmer</label><input id="roomId" placeholder="z.B. 203" />
              <label style="margin-top:8px">Message (optional)</label><input id="roomMsg" placeholder="z.B. Bitte an Rezeption wenden" />
              <div class="actions" style="margin-top:8px">
                <button class="danger tiny" id="btnRoomBlock">Sperren</button>
                <button class="good tiny" id="btnRoomUnblock">Entsperren</button>
              </div>
            </div>
            <div>
              <h2 style="margin:0 0 8px 0">Aktueller Status</h2>
              <div id="roomsHost" class="mono">—</div>
            </div>
          </div>
        </div>

        <hr style="border:none;border-top:1px solid var(--line);margin:12px 0">
        <h2 style="margin:0 0 8px 0">Output</h2>
        <div id="out" class="mono">—</div>
      </div>
    </div>
  </div>
</div>

<div id="toast" class="toast" style="display:none"></div>

<script>
const $ = (sel)=>{
  if(!sel) return null;
  if(typeof sel === 'string' && (sel.startsWith('#') || sel.startsWith('.'))) return document.querySelector(sel);
  return document.getElementById(sel);
};
const state = { me:null, perms:{} , rbac:{catalog:[], role:null, current:new Set()} };

function toast(msg){
  const el=$('toast'); el.textContent=String(msg||''); el.style.display='';
  clearTimeout(toast._t); toast._t=setTimeout(()=>el.style.display='none', 2200);
}
function base(){
  let u = String($('baseUrl').value||'').trim();
  u = u.replace(/\/+$/,'');
  return u;
}
function headers(includeAuth=true){
  const h = { 'Content-Type':'application/json' };
  const sa = String($('sa').value||'').trim();
  if(sa) h['x-sa-password'] = sa;
  if(includeAuth){
    const t = String($('token').value||'').trim();
    if(t) h['authorization'] = 'Bearer ' + t;
  }
  return h;
}
async function api(path, opts={}){
  const url = base()+path;
  const method = (opts.method || (opts.body===undefined ? 'GET' : 'POST')).toUpperCase();
  const init = { method, headers: {...headers(opts.noAuth?false:true), ...(opts.headers||{})} };
  if(method!=='GET' && method!=='HEAD' && opts.body!==undefined){
    init.body = (typeof opts.body==='string') ? opts.body : JSON.stringify(opts.body);
  }
  const res = await fetch(url, init);
  const txt = await res.text();
  let j; try{ j = JSON.parse(txt); }catch{ j = {raw: txt}; }
  if(!res.ok){
    const msg = (j?.message || j?.error || j?.raw || ('HTTP '+res.status));
    const err = new Error(msg); err.status=res.status; err.url=url; err.payload=j; throw err;
  }
  return j;
}
function setOut(obj){
  $('out').textContent = JSON.stringify(obj, null, 2);
  const build = obj?.build || obj?.data?.build || '–';
  $('pillBuild').textContent = 'build: ' + build;
}
function setAuthPills(ok){
  $('pillAuth').textContent = ok ? 'verbunden' : 'nicht verbunden';
  $('pillAuth').className = 'pill ' + (ok ? 'ok' : 'bad');
  $('pillUser').textContent = state.me?.user?.email || '–';
  $('pillRole').textContent = state.me?.user?.roleLabel || state.me?.user?.role || '–';
}
function can(key){
  if(state.me?.perms?.['sa.all']) return true;
  return !!state.me?.perms?.[key];
}

async function loadMe(){
  try{
    const j = await api('/api/auth/me', {method:'GET'});
    state.me = j;
    setOut(j);
    setAuthPills(true);
    toast('me geladen');
    // Nach Login/SA-Check direkt Config laden (zeigt u.a. Stations-PIN)
    try{ await loadConfig(); }catch(_e){}
  }catch(e){
    state.me=null;
    setAuthPills(false);
    toast('me Fehler: ' + e.message);
    setOut({error:true,status:e.status,url:e.url,payload:e.payload});
  }
}

async function doLogin(){
  const email = String($('loginEmail').value||'').trim();
  const password = String($('loginPw').value||'').trim();
  if(!email || !password) return toast('Email + Passwort');
  try{
    const j = await api('/api/ps/login', {body:{email,password}, noAuth:true});
    $('token').value = j.token || '';
    localStorage.setItem('wp_admin_token', $('token').value);
    toast('Login ok ('+(j.role||'')+')');
    setOut(j);
    await loadMe();
  }catch(e){
    toast('Login Fehler: '+e.message);
    setOut({error:true,status:e.status,url:e.url,payload:e.payload});
  }
}
async function doRegister(){
  const email = String($('regEmail').value||'').trim();
  const password = String($('regPw').value||'').trim();
  if(!email || !password) return toast('Email + Passwort');
  try{
    const j = await api('/api/ps/register', {body:{email,password}, noAuth:true});
    toast('Registriert: '+(j.status||''));
    setOut(j);
  }catch(e){
    toast('Register Fehler: '+e.message);
    setOut({error:true,status:e.status,url:e.url,payload:e.payload});
  }
}
function doLogout(){
  $('token').value='';
  localStorage.removeItem('wp_admin_token');
  state.me=null;
  setAuthPills(false);
  toast('Logout');
}
async function setStationPin(){
  const p1=String($('stationPin1').value||'').trim();
  const p2=String($('stationPin2').value||'').trim();
  if(p1.length<4) return toast('PIN zu kurz');
  if(p1!==p2) return toast('PIN stimmt nicht');
  try{
    const j = await api('/api/admin/set-station-pin', {body:{pin:p1}});
    $('stationPin1').value=''; $('stationPin2').value='';
    toast('Stations-PIN gesetzt');
    setOut(j);
  }catch(e){
    toast('PIN Fehler: '+e.message);
    setOut({error:true,status:e.status,url:e.url,payload:e.payload});
  }
}
async function loadUsers(){
  try{
    const j = await api('/api/auth/admin/users/list', {body:{}});
    setOut(j);
    renderUsers(j.users||[]);
  }catch(e){
    toast('Users Fehler: '+e.message);
    setOut({error:true,status:e.status,url:e.url,payload:e.payload});
    $('usersHost').textContent='—';
  }
}
function renderUsers(users){
  if(!users.length){ $('usersHost').textContent='(keine)'; return; }
  // nice table
  const rows = users.map(u=>{
    const actions = [];
    if(can('users.write')){
      if(u.status==='pending') actions.push(`<button class="good tiny" data-act="approve" data-id="${u.id}">Approve</button>`);
      actions.push(`<button class="danger tiny" data-act="disable" data-id="${u.id}">Disable</button>`);
      actions.push(`<button class="secondary tiny" data-act="role" data-id="${u.id}" data-email="${u.email}">Role</button>`);
    }
    return `<tr>
      <td style="width:260px"><div><b>${escapeHtml(u.email)}</b></div><div class="muted" style="font-size:11px">${escapeHtml(u.id)}</div></td>
      <td>${pill(u.status)}<div class="muted" style="font-size:11px;margin-top:6px">role: <b>${escapeHtml(u.role)}</b></div></td>
      <td class="muted">${fmt(u.createdAt)}<br>${u.approvedAt?('approved: '+fmt(u.approvedAt)):'—'}</td>
      <td style="width:260px"><div class="actions">${actions.join(' ')||'<span class="muted">—</span>'}</div></td>
    </tr>`;
  }).join('');
  $('usersHost').innerHTML = `<table>
    <thead><tr><th>User</th><th>Status</th><th>Zeiten</th><th>Aktionen</th></tr></thead>
    <tbody>${rows}</tbody>
  </table>`;
  $('usersHost').querySelectorAll('button[data-act]').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const act=btn.dataset.act, id=btn.dataset.id;
      try{
        if(act==='approve'){
          const j = await api('/api/auth/admin/users/approve', {body:{userId:id, approve:true}});
          setOut(j); toast('approved'); await loadUsers();
        }
        if(act==='disable'){
          const ok = confirm('User wirklich deaktivieren?'); if(!ok) return;
          const j = await api('/api/auth/admin/users/approve', {body:{userId:id, approve:false}});
          setOut(j); toast('disabled'); await loadUsers();
        }
        if(act==='role'){
          const role = prompt('Neue Rolle (Admin/PS/SV/User):','admin');
          if(!role) return;
          const j = await api('/api/auth/admin/users/set-role', {body:{userId:id, role}});
          setOut(j); toast('role gesetzt'); await loadUsers();
        }
      }catch(e){
        toast('Aktion Fehler: '+e.message);
        setOut({error:true,status:e.status,url:e.url,payload:e.payload});
      }
    });
  });
}

async function loadRbacSnapshot(){
  try{
    const j = await api('/api/auth/admin/rbac/snapshot', {body:{}});
    setOut(j);
    state.rbac.catalog = j.catalog || [];
    // roles from snapshot fallback
    const roles = (j.roles && j.roles.length) ? j.roles : ['Admin','PS','SV','User'];
    const sel=$('rbacRole');
    sel.innerHTML = roles.map(r=>`<option value="${escapeHtml(r)}">${escapeHtml(r)}</option>`).join('');
    sel.value = roles.includes(sel.value)?sel.value:roles[0];
    state.rbac.role = sel.value;
    await loadRbacRole();
    toast('RBAC geladen');
  }catch(e){
    toast('RBAC Fehler: '+e.message);
    setOut({error:true,status:e.status,url:e.url,payload:e.payload});
  }
}
async function loadRbacRole(){
  const role = String($('rbacRole').value||'').trim();
  if(!role) return;
  state.rbac.role = role;
  try{
    const j = await api('/api/auth/admin/rbac/role/get', {body:{role}});
    setOut(j);
    state.rbac.current = new Set((j.perms||[]).filter(x=>x.allowed).map(x=>String(x.permKey)));
    renderRbac(j.perms||[]);
  }catch(e){
    toast('Role Fehler: '+e.message);
    setOut({error:true,status:e.status,url:e.url,payload:e.payload});
  }
}
function renderRbac(perms){
  const groups = {};
  for(const p of perms){
    const g = p.permGroup || 'Sonstiges';
    if(!groups[g]) groups[g]=[];
    groups[g].push(p);
  }
  const html = Object.keys(groups).sort().map(g=>{
    const items = groups[g].map(p=>{
      const checked = state.rbac.current.has(p.permKey) ? 'checked' : '';
      return `<div style="display:flex;align-items:center;justify-content:space-between;gap:10px;padding:8px 10px;border:1px solid rgba(255,255,255,.10);border-radius:14px;background:rgba(255,255,255,.03);margin-bottom:8px">
        <div>
          <div><b>${escapeHtml(p.permLabel)}</b></div>
          <div class="muted" style="font-size:11px">${escapeHtml(p.permKey)}</div>
        </div>
        <label style="margin:0;display:flex;align-items:center;gap:8px">
          <input type="checkbox" data-perm="${escapeHtml(p.permKey)}" ${checked} style="width:18px;height:18px"/>
          <span class="muted" style="font-size:11px">allowed</span>
        </label>
      </div>`;
    }).join('');
    return `<div style="margin-bottom:12px">
      <h2 style="margin:0 0 8px 0">${escapeHtml(g)}</h2>
      ${items}
    </div>`;
  }).join('');
  $('rbacHost').innerHTML = html || '<div class="muted">—</div>';
  $('rbacHost').querySelectorAll('input[type=checkbox][data-perm]').forEach(cb=>{
    cb.addEventListener('change', ()=>{
      const k=cb.dataset.perm;
      if(cb.checked) state.rbac.current.add(k); else state.rbac.current.delete(k);
    });
  });
}
async function saveRbacRole(){
  const role = String($('rbacRole').value||'').trim();
  if(!role) return toast('Role fehlt');
  if(!$('sa').value.trim() && !can('rbac.write')) return toast('Keine Berechtigung');
  try{
    const permKeys = Array.from(state.rbac.current.values()).sort();
    const j = await api('/api/auth/admin/rbac/role/set', {body:{role, permKeys}});
    setOut(j);
    toast('Gespeichert');
    await loadRbacSnapshot();
  }catch(e){
    toast('Save Fehler: '+e.message);
    setOut({error:true,status:e.status,url:e.url,payload:e.payload});
  }
}


  function cfgSetForm(cfg){
    const get=(k,def)=> (cfg && typeof cfg[k] !== "undefined") ? cfg[k] : def;
    $("#cfgDaysPast").value = String(get("daysPast", 7));
    $("#cfgDaysFuture").value = String(get("daysFuture", 6));
    $("#cfgDryerMinutes").value = String(get("dryerMinutes", 150));

    const hours = Array.isArray(get("washerHours", [6,8,10,12,14,16,18,20])) ? get("washerHours", []) : [];
    setHoursUI(hours);
    updateHoursPretty();

    $("#cfgWhitecardEnabled").checked = !!get("whitecardEnabled", false);
    $("#cfgPortalDebugEnabled").checked = !!get("portalDebugEnabled", false);
    $("#cfgNewsEnabled").checked = !!get("newsEnabled", false);
    $("#cfgChatEnabled").checked = !!get("chatEnabled", false);
    $("#cfgWasherPopup").checked = !!get("washerPopup", false);
    $("#cfgDryerPopup").checked = !!get("dryerPopup", false);
    $("#cfgFeedbackPsEnabled").checked = !!get("feedbackPsEnabled", false);
    $("#cfgFeedbackSvEnabled").checked = !!get("feedbackSvEnabled", false);
    $("#cfgFeedbackAdminEnabled").checked = !!get("feedbackAdminEnabled", false);
    $("#cfgNewsPsEnabled").checked = !!get("newsPsEnabled", false);
    $("#cfgNewsSvEnabled").checked = !!get("newsSvEnabled", false);
    $("#cfgNewsAdminEnabled").checked = !!get("newsAdminEnabled", false);

    $("#cfgNewsText").value = String(get("newsText",""));
    syncFormToRaw();
  }
  function cfgGetForm(){
    const n=(id,def)=> {
      const v = Number($("#"+id).value);
      return Number.isFinite(v) ? v : def;
    };
    return {
      daysPast: n("cfgDaysPast", 7),
      daysFuture: n("cfgDaysFuture", 6),
      dryerMinutes: n("cfgDryerMinutes", 150),
      washerHours: getHoursFromUI(),

      newsEnabled: $("#cfgNewsEnabled").checked,
      newsText: String($("#cfgNewsText").value||""),
      chatEnabled: $("#cfgChatEnabled").checked,

      whitecardEnabled: $("#cfgWhitecardEnabled").checked,
      portalDebugEnabled: $("#cfgPortalDebugEnabled").checked,
      washerPopup: $("#cfgWasherPopup").checked,
      dryerPopup: $("#cfgDryerPopup").checked
    };
  }
  function cfgMergeRawWithForm(){
    let raw = {};
    try { raw = JSON.parse($("#cfgRaw").value || "{}"); } catch {}
    const form = cfgGetForm();
    const merged = { ...raw, ...form };
    $("#cfgRaw").value = JSON.stringify(merged, null, 2);
    return merged;
  }
  function initHoursGrid(){
    const host = $("#cfgWasherHoursGrid");
    if(!host || host.dataset.ready==="1") return;
    host.dataset.ready="1";
    host.innerHTML="";
    for(let h=0; h<=23; h++){
      const box=document.createElement("label");
      box.className="hourbox";
      box.innerHTML = `<input type="checkbox" data-hour="${h}"><span>${String(h).padStart(2,"0")}:00</span>`;
      host.appendChild(box);
    }
    $("#cfgHoursStd")?.addEventListener("click", (e)=>{ e.preventDefault(); setHoursUI([6,8,10,12,14,16,18,20]); });
    $("#cfgHoursClear")?.addEventListener("click", (e)=>{ e.preventDefault(); setHoursUI([]); });
    host.addEventListener("change", ()=>{ syncHoursToText();
    updateHoursPretty(); syncFormToRaw(); });
    $("#cfgWasherHoursText")?.addEventListener("input", ()=>{ syncTextToHours(); syncFormToRaw(); });
  }

  function parseHoursText(){
    const txt = String($("#cfgWasherHoursText")?.value||"").trim();
    if(!txt) return [];
    const parts = txt.split(/[,;\s]+/).map(s=>s.trim()).filter(Boolean);
    const out=[];
    for(const p of parts){
      const n=Number(p);
      if(Number.isFinite(n) && n>=0 && n<=23) out.push(Math.trunc(n));
    }
    return Array.from(new Set(out)).sort((a,b)=>a-b);
  }
  function setHoursUI(hours){
    initHoursGrid();
    const set = new Set((hours||[]).map(n=>Number(n)));
    // checkboxes
    $("#cfgWasherHoursGrid")?.querySelectorAll("input[data-hour]")?.forEach(cb=>{
      const h=Number(cb.dataset.hour);
      cb.checked = set.has(h);
    });
    // text
    $("#cfgWasherHoursText").value = (Array.from(set).sort((a,b)=>a-b)).join(",");
    syncFormToRaw();
  }
  function getHoursFromUI(){
    initHoursGrid();
    const set=[];
    $("#cfgWasherHoursGrid")?.querySelectorAll("input[data-hour]")?.forEach(cb=>{
      if(cb.checked) set.push(Number(cb.dataset.hour));
    });
    return set.sort((a,b)=>a-b);
  }

  function updateHoursPretty(){
    const hours = getHoursFromUI();
    const el = $("#cfgHoursText");
    if(!el) return;
    if(!hours.length){ el.textContent = "Aktiv: –"; return; }
    el.textContent = "Aktiv: " + hours.map(h=>String(h).padStart(2,"0")+":00").join(", ");
  }
function syncHoursToText(){
    $("#cfgWasherHoursText").value = getHoursFromUI().join(",");
    updateHoursPretty();
  }
  function syncTextToHours(){
    const hours = parseHoursText();
    const set = new Set(hours);
    $("#cfgWasherHoursGrid")?.querySelectorAll("input[data-hour]")?.forEach(cb=>{
      cb.checked = set.has(Number(cb.dataset.hour));
    });
  }

  function syncFormToRaw(){
    // merge form over raw
    cfgMergeRawWithForm();
    // disable newsText when news disabled (UX)
    const en=$("#cfgNewsEnabled")?.checked;
    const nt=$("#cfgNewsText");
    if(nt){ nt.disabled = !en; nt.style.opacity = en ? "1" : ".6"; }
  }

  function cfgFormBind(){
    initHoursGrid();
    const ids=[
      "cfgDaysPast","cfgDaysFuture","cfgDryerMinutes",
      "cfgWhitecardEnabled","cfgPortalDebugEnabled","cfgNewsEnabled","cfgChatEnabled","cfgWasherPopup","cfgDryerPopup","cfgFeedbackPsEnabled","cfgFeedbackSvEnabled","cfgFeedbackAdminEnabled","cfgNewsPsEnabled","cfgNewsSvEnabled","cfgNewsAdminEnabled",
      "cfgNewsText"
    ];
    for (const id of ids){
      const el=$("#"+id);
      if(!el) continue;
      el.addEventListener("input", ()=>syncFormToRaw());
      el.addEventListener("change", ()=>syncFormToRaw());
    }
    $("#cfgRaw").addEventListener("input", ()=>{
      try{ const cfg=JSON.parse($("#cfgRaw").value||"{}"); cfgSetForm(cfg); } catch {}
    });
    syncFormToRaw();
  }

async function cfgLoad(){
  try{
    const j = await api('/api/auth/admin/config/get', {body:{}});
    setOut(j);
    $('cfgRaw').value = JSON.stringify(j.config||{}, null, 2);
    cfgSetForm(j.config||{});
    try{
      const cfgObj = (j && typeof j==='object') ? (j.config||j||{}) : {};
      const pin = cfgObj.stationPinPlain || cfgObj.stationPin || '';
      const pinHash = cfgObj.stationPinHash || '';
      const stationPinSet = !!(j.stationPinSet || (pinHash && String(pinHash).trim()));
      const el=$('#pinCurrent');
      if(el) el.textContent = pin ? String(pin) : (stationPinSet ? 'gesetzt (nicht auslesbar)' : '–');
    }catch(_e){}
    toast('Config geladen');
  }catch(e){
    toast('Config Fehler: '+e.message);
    setOut({error:true,status:e.status,url:e.url,payload:e.payload});
  }
}
async function cfgSave(){
  try{
    const raw = $('cfgRaw').value || "{}";
    const cfg = JSON.parse(raw);
    const j = await api('/api/auth/admin/config/set', {body:{config:cfg}});
    setOut(j);
    $('cfgRaw').value = JSON.stringify(j.config||{}, null, 2);
    toast('Config gespeichert');
  }catch(e){
    toast('Save Fehler: '+e.message);
    setOut({error:true,status:e.status,url:e.url,payload:e.payload});
  }
}

async function loadBookings(){
  try{
    const machine = String($('bkMachine').value||'').trim();
    const status = String($('bkStatus').value||'').trim();
    const j = await api('/api/auth/admin/bookings/list', {body:{machine,status}});
    setOut(j);
    renderBookings(j.bookings||[]);
    toast('Bookings: '+(j.bookings||[]).length);
  }catch(e){
    toast('Bookings Fehler: '+e.message);
    setOut({error:true,status:e.status,url:e.url,payload:e.payload});
    $('bkHost').innerHTML='<div class="muted">—</div>';
  }
}
function renderBookings(items){
  if(!items.length){ $('bkHost').innerHTML='<div class="muted">Keine Buchungen</div>'; return; }
  const canCancel = can('bookings.delete');
  const rows = items.map(b=>{
    const btn = canCancel ? `<button class="danger tiny" data-id="${b.id}">Cancel</button>` : `<span class="muted">—</span>`;
    return `<tr>
      <td><b>${escapeHtml(b.id)}</b><div class="muted" style="font-size:11px">${escapeHtml(b.type)} · machine ${b.machine} · room ${escapeHtml(b.room)}</div></td>
      <td>${pill(b.status)} ${b.whitecard?`<span class="pill ok">whitecard</span>`:''}</td>
      <td class="muted">${fmt(b.start)} → ${fmt(b.end)}<br>created: ${fmt(b.createdAt)}</td>
      <td style="width:140px"><div class="actions">${btn}</div></td>
    </tr>`;
  }).join('');
  $('bkHost').innerHTML = `<table>
    <thead><tr><th>Booking</th><th>Status</th><th>Zeit</th><th>Aktion</th></tr></thead>
    <tbody>${rows}</tbody>
  </table>`;
  $('bkHost').querySelectorAll('button[data-id]').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const id=btn.dataset.id;
      const reason = prompt('Storno-Grund (optional):','') || '';
      try{
        const j = await api('/api/auth/admin/bookings/cancel', {body:{bookingId:id, reason}});
        setOut(j); toast('storniert'); await loadBookings();
      }catch(e){
        toast('Cancel Fehler: '+e.message);
        setOut({error:true,status:e.status,url:e.url,payload:e.payload});
      }
    });
  });
}
async function downloadCsv(path, body, filename){
  const res = await fetch(base()+path, {method:'POST', headers: headers(true), body: JSON.stringify(body||{})});
  if(!res.ok){
    const j = await res.json().catch(()=>({}));
    throw new Error(j.message || j.error || ('HTTP '+res.status));
  }
  const blob = await res.blob();
  const url = URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url; a.download=filename;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}
async function downloadBookingsCsv(){
  const machine = String($('bkMachine').value||'').trim();
  try{
    await downloadCsv('/api/auth/admin/bookings/export', {machine}, `bookings_${machine||'all'}.csv`);
    toast('CSV geladen');
  }catch(e){ toast('CSV Fehler: '+e.message); }
}

async function loadLogs(){
  try{
    const q = String($('logQ').value||'').trim();
    const j = await api('/api/auth/admin/logs/list', {body:{q, limit:200}});
    setOut(j);
    renderLogs(j.logs||[]);
    toast('Logs: '+(j.logs||[]).length);
  }catch(e){
    toast('Logs Fehler: '+e.message);
    setOut({error:true,status:e.status,url:e.url,payload:e.payload});
    $('logsHost').innerHTML='<div class="muted">—</div>';
  }
}
function renderLogs(items){
  if(!items.length){ $('logsHost').innerHTML='<div class="muted">Keine Logs</div>'; return; }
  const rows = items.map(l=>{
    return `<tr>
      <td style="width:190px" class="muted">${fmt(l.ts)}</td>
      <td><b>${escapeHtml(l.action)}</b><div class="muted" style="font-size:11px">actor: ${escapeHtml(l.actor)} · room: ${escapeHtml(l.room)}</div></td>
      <td><div class="mono" style="max-height:120px">${escapeHtml(JSON.stringify(l.meta||{}, null, 0))}</div></td>
    </tr>`;
  }).join('');
  $('logsHost').innerHTML = `<table>
    <thead><tr><th>Zeit</th><th>Event</th><th>Meta</th></tr></thead>
    <tbody>${rows}</tbody>
  </table>`;
}
async function downloadLogsCsv(){
  const q = String($('logQ').value||'').trim();
  try{
    await downloadCsv('/api/auth/admin/logs/export', {q}, `logs.csv`);
    toast('CSV geladen');
  }catch(e){ toast('CSV Fehler: '+e.message); }
}

async function roomsRefresh(){
  try{
    const j = await api('/api/auth/room/control/list', {body:{}});
    setOut(j);
    $('roomsHost').textContent = JSON.stringify(j.rooms||[], null, 2);
  }catch(e){
    toast('Rooms Fehler: '+e.message);
    setOut({error:true,status:e.status,url:e.url,payload:e.payload});
    $('roomsHost').textContent='—';
  }
}
async function roomSet(blocked){
  const room = String($('roomId').value||'').trim();
  const message = String($('roomMsg').value||'').trim();
  if(!room) return toast('Zimmer fehlt');
  try{
    const j = await api('/api/auth/room/control', {body:{room, blocked, message}});
    setOut(j);
    toast(blocked?'gesperrt':'entsperrt');
    await roomsRefresh();
  }catch(e){
    toast('Room Fehler: '+e.message);
    setOut({error:true,status:e.status,url:e.url,payload:e.payload});
  }
}

function fmt(ms){
  const n=Number(ms||0); if(!n) return '—';
  return new Date(n).toLocaleString();
}
function escapeHtml(s){
  return String(s??'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));
}
function pill(status){
  const s=String(status||'');
  const cls = s==='active' || s==='approved' || s==='booked' ? 'ok' : (s==='pending' ? '' : 'bad');
  return `<span class="pill ${cls}">${escapeHtml(s||'-')}</span>`;
}

function switchTab(name){
  document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active', t.dataset.tab===name));
  const views = {
    dash:'viewDash', users:'viewUsers', rbac:'viewRbac', config:'viewConfig', bookings:'viewBookings', logs:'viewLogs', rooms:'viewRooms'
  };
  Object.entries(views).forEach(([k,id])=>$(id).style.display = (k===name)?'':'none');
}

// Wire
window.addEventListener('DOMContentLoaded', ()=>{
document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click', ()=>switchTab(t.dataset.tab)));

$('btnLogin').addEventListener('click', doLogin);
$('btnRegister').addEventListener('click', doRegister);
$('btnLogout').addEventListener('click', doLogout);

$('btnMe').addEventListener('click', loadMe);
$('btnMeSa').addEventListener('click', loadMe);
$('btnMeToken').addEventListener('click', loadMe);

$('btnStationPin').addEventListener('click', setStationPin);
$('btnRoutes').addEventListener('click', async ()=>{ try{ setOut(await api('/api/_routes',{method:'GET'})); toast('routes'); }catch(e){ toast(e.message); }});
$('btnStatus').addEventListener('click', async ()=>{ try{ setOut(await api('/api/_status',{method:'GET'})); toast('status'); }catch(e){ toast(e.message); }});

$('btnLoadUsers').addEventListener('click', ()=>{ switchTab('users'); loadUsers(); });
$('btnUsersRefresh').addEventListener('click', loadUsers);

$('btnLoadRbac').addEventListener('click', ()=>{ switchTab('rbac'); loadRbacSnapshot(); });
$('btnRbacLoadRole').addEventListener('click', loadRbacRole);
$('btnRbacSave').addEventListener('click', saveRbacRole);

$('btnCfgLoad').addEventListener('click', ()=>{ switchTab('config'); cfgLoad(); });
$('btnCfgRefresh').addEventListener('click', cfgLoad);
$('btnCfgSave').addEventListener('click', cfgSave);

$('btnBkLoad').addEventListener('click', ()=>{ switchTab('bookings'); loadBookings(); });
$('btnBkRefresh').addEventListener('click', loadBookings);
$('btnBkCsv').addEventListener('click', downloadBookingsCsv);

$('btnLogsLoad').addEventListener('click', ()=>{ switchTab('logs'); loadLogs(); });
$('btnLogsRefresh').addEventListener('click', loadLogs);
$('btnLogsCsv').addEventListener('click', downloadLogsCsv);

$('btnRoomsRefresh').addEventListener('click', roomsRefresh);
$('btnRoomBlock').addEventListener('click', ()=>roomSet(true));
$('btnRoomUnblock').addEventListener('click', ()=>roomSet(false));

// Init
try{ cfgFormBind(); }catch(e){ console.warn(e); }

// Restore
(function boot(){
  $('token').value = localStorage.getItem('wp_admin_token') || '';
  const prev = localStorage.getItem('wp_admin_base') || '';
  if(prev) $('baseUrl').value = prev;
  $('baseUrl').addEventListener('change', ()=>localStorage.setItem('wp_admin_base', $('baseUrl').value.trim()));
})()});
;
</script>
</body>
</html>

    }
    try{
      const state = await jpost("/api/user/refresh",{ room, pin, stationPin });
      $("workerBuild").textContent = state.build || "-";
      renderNews(state.config||{});
      renderQuickBook(state);
      renderMachines(state);
      renderMyBookings(state);
      renderFeedback(state.config||{});
    }catch(e){
      showErr("⛔ " + e.message);
    }
  }

    const _sb = $("saveBtn"); if(_sb) _sb.onclick = ()=>{ saveCreds(); showErr(""); };
  const _rb = $("refreshBtn"); if(_rb) _rb.onclick = refreshAll;

  loadCreds();
  refreshAll();
</script>
<div id="toast" style="display:none;position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 14px;border-radius:12px;box-shadow:0 10px 20px rgba(0,0,0,.18);font-weight:700;z-index:9999"></div>
</body>
</html>
