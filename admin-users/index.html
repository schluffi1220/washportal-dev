<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Washportal – Admin-User RBAC Editor (SA)</title>
<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:16px;background:#0b0f14;color:#e7eef7}
input,select,button,textarea{font:inherit;padding:10px;border-radius:10px;border:1px solid #223042;background:#0f1621;color:#e7eef7}
button{cursor:pointer}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.card{border:1px solid #223042;border-radius:14px;padding:12px;margin:12px 0;background:#0f1621}
h1{font-size:18px;margin:0 0 8px 0}
h2{font-size:15px;margin:0 0 8px 0}
.small{opacity:.8;font-size:12px}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
.perms{max-height:52vh;overflow:auto;border:1px solid #223042;border-radius:12px;padding:10px}
.perm{display:flex;gap:10px;align-items:flex-start;padding:6px 0;border-bottom:1px dashed #223042}
.perm:last-child{border-bottom:none}
code{background:#0b0f14;padding:2px 6px;border-radius:8px}
.ok{color:#7CFC9A}
.bad{color:#ff7b7b}
</style>
</head>
<body>
<h1>Admin-User RBAC Editor (SA)</h1>
<div class="small">Nur Rollen/Perms bearbeiten. Auth via <code>x-sa-password</code> + Body. Kein Login nötig.</div>

<div class="card">
  <div class="row">
    <label class="small">Worker Base
      <input id="base" style="min-width:340px" value="https://washportal-dev-worker.schluffi1220.workers.dev"/>
    </label>
    <label class="small">SA Passwort
      <input id="sa" type="password" style="min-width:240px" placeholder="SA Passwort"/>
    </label>
    <button id="btnStatus">Status</button>
    <button id="btnLoad">RBAC Snapshot laden</button>
  </div>
  <div id="statusOut" class="small"></div>
</div>

<div class="grid">
  <div class="card">
    <h2>Rolle auswählen</h2>
    <div class="row">
      <select id="roleSel" style="min-width:220px"></select>
      <button id="btnAll">Alle an</button>
      <button id="btnNone">Alle aus</button>
      <button id="btnSave">Rolle speichern</button>
    </div>
    <div class="small">Speichert in <code>/api/admin/auth/rbac/role/bulk</code>.</div>
    <div id="saveOut" class="small"></div>
  </div>

  <div class="card">
    <h2>Debug</h2>
    <pre id="debug" class="small" style="white-space:pre-wrap;margin:0"></pre>
  </div>
</div>

<div class="card">
  <h2>Permissions (Katalog)</h2>
  <div id="permsWrap" class="perms"></div>
</div>

<script>
const $ = (id)=>document.getElementById(id);

function hdrs(){
  const pw = $("sa").value || "";
  return {
    "content-type":"application/json",
    "x-sa-password": pw
  };
}
async function jpost(path, body){
  const base = $("base").value.replace(/\/$/,'');
  const res = await fetch(base+path, {method:"POST", headers: hdrs(), body: JSON.stringify(body||{})});
  const txt = await res.text();
  let data; try{ data = JSON.parse(txt);}catch(e){ data={ok:false,error:"bad_json",raw:txt}; }
  if(!res.ok) throw {status:res.status, data};
  return data;
}

let SNAP = null; // snapshot
let CATALOG = []; // [{permKey,title,label,permGroup,sort}]
let ROLE_PERMS = []; // [{role,permKey,allowed}]
let ROLE = "";

function normRole(r){ return String(r||"").trim().toLowerCase(); }

function buildRoleList(){
  const roles = new Set();
  (SNAP?.users||[]).forEach(u=>{ if(u.role) roles.add(normRole(u.role)); if(u.role2) roles.add(normRole(u.role2)); });
  (ROLE_PERMS||[]).forEach(rp=>roles.add(normRole(rp.role)));
  const list=[...roles].filter(Boolean).sort();
  const sel=$("roleSel"); sel.innerHTML="";
  for(const r of list){ const o=document.createElement("option"); o.value=r; o.textContent=r; sel.appendChild(o); }
  ROLE = sel.value || list[0] || "admin";
  if(!sel.value && ROLE){ sel.value = ROLE; }
}

function rolePermMap(role){
  role = normRole(role);
  const m = {};
  for(const rp of (ROLE_PERMS||[])){
    if(normRole(rp.role)===role) m[String(rp.permKey)] = !!rp.allowed;
  }
  return m;
}

function renderPerms(){
  const wrap=$("permsWrap");
  wrap.innerHTML="";
  if(!CATALOG.length){ wrap.textContent="(kein Katalog)"; return; }
  const map = rolePermMap(ROLE);
  const items = [...CATALOG].sort((a,b)=>{
    const ga=String(a.permGroup||""); const gb=String(b.permGroup||"");
    if(ga!==gb) return ga.localeCompare(gb);
    const sa=Number(a.sort||0), sb=Number(b.sort||0);
    if(sa!==sb) return sa-sb;
    return String(a.permKey).localeCompare(String(b.permKey));
  });

  for(const p of items){
    const row=document.createElement("div");
    row.className="perm";
    const cb=document.createElement("input");
    cb.type="checkbox";
    cb.checked=!!map[p.permKey];
    cb.dataset.perm=p.permKey;

    const meta=document.createElement("div");
    meta.innerHTML = `<div><b>${(p.title||p.label||p.permKey)}</b></div>
                      <div class="small"><code>${p.permKey}</code> <span style="opacity:.7">(${p.permGroup||"-"})</span></div>`;
    row.appendChild(cb); row.appendChild(meta);
    wrap.appendChild(row);
  }
}

function setAll(val){
  [...$("permsWrap").querySelectorAll("input[type=checkbox]")].forEach(cb=>cb.checked=val);
}

async function loadSnapshot(){
  $("saveOut").textContent="";
  $("debug").textContent="Lade RBAC Snapshot…";
  try{
    SNAP = await jpost("/api/auth/admin/rbac/snapshot", { saPassword: $("sa").value||"" });
    CATALOG = SNAP.permsCatalog || SNAP.perms || [];
    ROLE_PERMS = SNAP.rolePerms || [];
    buildRoleList();
    renderPerms();
    $("debug").textContent = JSON.stringify({build: SNAP.build, users:(SNAP.users||[]).length, permsCatalog:CATALOG.length, rolePerms:ROLE_PERMS.length}, null, 2);
  }catch(e){
    $("debug").textContent = JSON.stringify(e, null, 2);
  }
}

async function saveRole(){
  const role = normRole($("roleSel").value);
  const perms = [...$("permsWrap").querySelectorAll("input[type=checkbox]")].map(cb=>({
    permKey: cb.dataset.perm,
    allowed: !!cb.checked
  }));
  $("saveOut").textContent="Speichere…";
  try{
    const out = await jpost("/api/auth/admin/rbac/role/bulk", { saPassword: $("sa").value||"", role, perms });
    $("saveOut").innerHTML = `<span class="ok">OK</span> • ${perms.length} perms • build ${out.build||""}`;
    // refresh rolePerms local from response if included
    if(out.rolePerms) ROLE_PERMS = out.rolePerms;
  }catch(e){
    $("saveOut").innerHTML = `<span class="bad">FEHLER</span> • ` + (e?.data?.message || e?.data?.error || e?.status || "unknown");
    $("debug").textContent = JSON.stringify(e, null, 2);
  }
}

$("btnStatus").onclick = async ()=>{
  const base=$("base").value.replace(/\/$/,'');
  $("statusOut").textContent="…";
  try{
    const r = await fetch(base+"/api/_status?ts="+Date.now());
    const j = await r.json();
    $("statusOut").innerHTML = (j.ok?'<span class="ok">OK</span>':'<span class="bad">FEHLER</span>') + " • " + JSON.stringify(j);
  }catch(e){
    $("statusOut").innerHTML = '<span class="bad">FEHLER</span> • ' + String(e);
  }
};

$("btnLoad").onclick = loadSnapshot;

$("roleSel").onchange = ()=>{
  ROLE = $("roleSel").value;
  renderPerms();
};

$("btnAll").onclick = ()=>setAll(true);
$("btnNone").onclick = ()=>setAll(false);
$("btnSave").onclick = saveRole;
</script>
</body>
</html>
