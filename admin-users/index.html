<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Washportal – Benutzerverwaltung & RBAC (Admin/SA)</title>
<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:16px;background:#0b0f14;color:#e7eef7}
input,select,button,textarea{font:inherit;padding:10px;border-radius:10px;border:1px solid #223042;background:#0f1621;color:#e7eef7}
button{cursor:pointer}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.card{border:1px solid #223042;border-radius:14px;padding:12px;margin:12px 0;background:#0f1621}
h1{font-size:18px;margin:0 0 8px 0}
h2{font-size:15px;margin:0 0 8px 0}
.small{opacity:.8;font-size:12px}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:12px}
.bad{color:#ff7b7b}
.ok{color:#7bff9d}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid #223042;text-align:left;vertical-align:top}
code{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:12px}
.pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #223042;font-size:12px;opacity:.95}
.pill.ps{border-color:#4a7bd8}
.pill.sv{border-color:#7a60ff}
.pill.admin{border-color:#ffbf60}
.pill.user{border-color:#4bd38a}
.pill.sa{border-color:#ff6bd6}
hr{border:none;border-top:1px solid #223042;margin:12px 0}
</style>
</head>
<body>
  <h1>Benutzerverwaltung (primär Admin-User)</h1>
  <div class="small">
    Nutzt deine BASE (Cloudflare Worker). Admin/PS/SV arbeiten über <b>Bearer Token</b>, SA zusätzlich über <b>x-sa-password</b>.
  </div>

  <div class="card">
    <h2>Verbindung</h2>
    <div class="row">
      <label class="small">BASE<br/>
        <input id="base" style="min-width:360px" value="https://washportal-dev-worker.schluffi1220.workers.dev"/>
      </label>
      <label class="small">Bearer Token (Admin/PS/SV/SA)<br/>
        <input id="token" style="min-width:360px" placeholder="Bearer Token (optional)"/>
      </label>
      <label class="small">SA Passwort (optional)<br/>
        <input id="sa" type="password" style="min-width:240px" placeholder="x-sa-password"/>
      </label>
    </div>
    <div class="row">
      <button id="btnStatus">/api/_status</button>
      <button id="btnMe">/api/auth/me</button>
      <button id="btnUsers">Benutzer laden</button>
      <span id="statusOut" class="small"></span>
    </div>
    <pre id="meOut" class="small" style="white-space:pre-wrap;margin:10px 0 0 0"></pre>
  </div>

  <div class="grid">
    <div class="card">
      <h2>Benutzer</h2>
      <div class="row">
        <label class="small">Filter (E-Mail / Name / Rolle)<br/>
          <input id="filter" placeholder="z.B. 203, müller, ps, admin…" style="min-width:320px"/>
        </label>
        <button id="btnApplyFilter">Filter</button>
      </div>

      <div class="small" id="usersHint">Noch nicht geladen.</div>
      <div style="overflow:auto;max-height:60vh;margin-top:8px">
        <table id="usersTbl">
          <thead>
            <tr>
              <th>E-Mail</th>
              <th>Name</th>
              <th>Rolle</th>
              <th>Status</th>
              <th>Aktion</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="small" id="usersOut"></div>
    </div>

    <div class="card">
      <h2>Hinweise zur Rechte-Logik</h2>
      <ul class="small">
        <li><b>Admin</b>: kann Rollen setzen (User/Admin/PS/SV) – wie gefordert.</li>
        <li><b>PS/SV</b>: sollen primär nur Übergabe sehen (dein Worker hat die Transfer-Logik in <code>/api/auth/admin/users/set-role</code> integriert).</li>
        <li><b>SA</b>: kann zusätzlich RBAC-Katalog & direkte Perms pflegen (separates RBAC-Tool empfehlenswert).</li>
      </ul>
      <hr/>
      <div class="small">
        Rollen-Mapping:
        <ul>
          <li><code>admin</code> = Admin</li>
          <li><code>ps</code> = PS</li>
          <li><code>ps_deputy</code> = SV</li>
          <li><code>user</code> = User</li>
          <li><code>super_admin</code>/<code>superadmin</code> = SA</li>
        </ul>
      </div>
      <pre id="debug" class="small" style="white-space:pre-wrap"></pre>
    </div>
  </div>

<script>
const $ = (id)=>document.getElementById(id);

function baseUrl(){
  return ($("base").value || "").replace(/\/$/,'');
}
function headersJson(){
  const h = {"content-type":"application/json"};
  const t = ($("token").value || "").trim();
  const sa = ($("sa").value || "").trim();
  if(t){
    const raw = t.trim();
    const looksJwt = (raw.split(".").length >= 3) && raw.length > 20;
    if(looksJwt){
      h["authorization"] = raw.toLowerCase().startsWith("bearer ") ? raw : ("Bearer " + raw);
    }
  }
  if(sa) h["x-sa-password"] = sa;
  return h;
}
async function jget(path){
  const res = await fetch(baseUrl()+path, {method:"GET", headers: headersJson()});
  const txt = await res.text();
  let data; try{ data = JSON.parse(txt);}catch(e){ data={ok:false,error:"bad_json",raw:txt}; }
  if(!res.ok) throw {status:res.status, data};
  return data;
}
async function jpost(path, body){
  const res = await fetch(baseUrl()+path, {method:"POST", headers: headersJson(), body: JSON.stringify(body||{})});
  const txt = await res.text();
  let data; try{ data = JSON.parse(txt);}catch(e){ data={ok:false,error:"bad_json",raw:txt}; }
  if(!res.ok) throw {status:res.status, data};
  return data;
}

function roleLabel(role){
  role = String(role||"").toLowerCase();
  if(role==="ps") return ["PS","ps"];
  if(role==="ps_deputy") return ["SV","sv"];
  if(role==="admin") return ["Admin","admin"];
  if(role==="user" || !role) return ["User","user"];
  if(role==="super_admin" || role==="superadmin") return ["SA","sa"];
  return [role, "user"];
}
function pill(role){
  const [lbl, cls] = roleLabel(role);
  return `<span class="pill ${cls}">${lbl}</span>`;
}

let USERS = [];
let ME = null;

function canSeeActions(){
  const r = String(ME?.user?.role||"").toLowerCase();
  // SA/Admin/PS/SV may open the page; but only Admin/SA should be able to change roles here.
  return ["admin","super_admin","superadmin"].includes(r);
}

function renderUsers(){
  const q = ($("filter").value||"").trim().toLowerCase();
  const tbody = $("usersTbl").querySelector("tbody");
  tbody.innerHTML = "";

  const filtered = (USERS||[]).filter(u=>{
    if(!q) return true;
    const s = [
      u.email, u.firstName, u.lastName, u.role, u.role2, u.status
    ].map(x=>String(x||"").toLowerCase()).join(" ");
    return s.includes(q);
  });

  $("usersHint").textContent = `Geladen: ${USERS.length} • angezeigt: ${filtered.length}`;

  const allowActions = canSeeActions();

  for(const u of filtered){
    const tr = document.createElement("tr");
    const name = [u.firstName,u.lastName].filter(Boolean).join(" ").trim();
    tr.innerHTML = `
      <td><code>${(u.email||"")}</code></td>
      <td>${name || "<span class='small'>(ohne Name)</span>"}</td>
      <td>${pill(u.role)} ${u.role2?("<span class='small'>+ "+pill(u.role2)+"</span>"):""}</td>
      <td>${u.status || ""}</td>
      <td></td>
    `;

    const td = tr.querySelector("td:last-child");

    if(allowActions){
      const sel = document.createElement("select");
      sel.innerHTML = `
        <option value="">Rolle setzen…</option>
        <option value="user">User</option>
        <option value="admin">Admin</option>
        <option value="ps">PS</option>
        <option value="ps_deputy">SV</option>
      `;
      const btn = document.createElement("button");
      btn.textContent = "Speichern";
      btn.onclick = async ()=>{
        const role = sel.value;
        if(!role) return;
        if(!confirm(`Rolle von ${u.email} wirklich auf "${role}" setzen?`)) return;
        td.querySelectorAll("button,select").forEach(x=>x.disabled=true);
        try{
          const out = await jpost("/api/auth/admin/users/set-role", { userId: u.id, role });
          $("usersOut").innerHTML = `<span class="ok">OK</span> • build ${out.build||""}`;
          await loadUsers(false);
        }catch(e){
          $("usersOut").innerHTML = `<span class="bad">FEHLER</span> • ` + (e?.data?.message||e?.data?.error||e?.status||"unknown");
          $("debug").textContent = JSON.stringify(e, null, 2);
        }finally{
          td.querySelectorAll("button,select").forEach(x=>x.disabled=false);
        }
      };

      td.appendChild(sel);
      td.appendChild(document.createTextNode(" "));
      td.appendChild(btn);
    }else{
      td.innerHTML = `<span class="small">Keine Admin-Rechte für Rollenänderung.</span>`;
    }

    tbody.appendChild(tr);
  }
}

async function loadMe(){
  $("meOut").textContent = "…";
  try{
    ME = await jget("/api/auth/me");
    $("meOut").textContent = JSON.stringify(ME, null, 2);
  }catch(e){
    $("meOut").textContent = JSON.stringify(e, null, 2);
    ME = null;
  }
}

async function loadUsers(render=true){
  $("usersOut").textContent = "";
  try{
    const out = await jpost("/api/auth/admin/users/list", {});
    USERS = out.users || [];
    if(render) renderUsers();
  }catch(e){
    $("usersOut").innerHTML = `<span class="bad">FEHLER</span> • ` + (e?.data?.message||e?.data?.error||e?.status||"unknown");
    $("debug").textContent = JSON.stringify(e, null, 2);
  }
}

$("btnStatus").onclick = async ()=>{
  $("statusOut").textContent="…";
  try{
    const out = await jget("/api/_status?ts="+Date.now());
    $("statusOut").innerHTML = (out.ok?'<span class="ok">OK</span>':'<span class="bad">FEHLER</span>') + " • build " + (out.build||"");
  }catch(e){
    $("statusOut").innerHTML = '<span class="bad">FEHLER</span> • ' + (e?.data?.message||e?.data?.error||e?.status||String(e));
  }
};

$("btnMe").onclick = loadMe;

$("btnUsers").onclick = async ()=>{
  await loadMe();
  await loadUsers(true);
};

$("btnApplyFilter").onclick = renderUsers;
$("filter").addEventListener("keydown",(ev)=>{ if(ev.key==="Enter") renderUsers(); });
</script>
</body>
</html>
