<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Washportal Admin</title>
<style>
:root{
  --bg1:#061018; --bg2:#0b2230; --card:#0f1f2b; --card2:#0c1822;
  --text:#e8f1f7; --muted:#9fb3c3; --line:rgba(255,255,255,.08);
  --accent:#26c6da; --accent2:#4f8cff; --good:#1ee2a2; --warn:#f7b955; --bad:#ff5d6c;
}
*{box-sizing:border-box}
body{
  margin:0; font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
  color:var(--text);
  min-height:100vh;
  background:
    radial-gradient(1200px 700px at 20% 15%, rgba(38,198,218,.22), transparent 55%),
    radial-gradient(900px 600px at 70% 35%, rgba(79,140,255,.18), transparent 55%),
    linear-gradient(180deg,var(--bg1),var(--bg2));
}
a{color:var(--accent)}
.container{max-width:1180px;margin:18px auto;padding:0 16px}
.topbar{display:flex;align-items:center;gap:10px;margin-bottom:14px}
.dot{width:9px;height:9px;border-radius:99px;background:var(--good);box-shadow:0 0 0 6px rgba(30,226,162,.12)}
.h1{font-weight:800;letter-spacing:.2px}
.pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:rgba(255,255,255,.04);color:var(--muted);font-size:12px}
.grid{display:grid;gap:14px}
.card{
  border:1px solid var(--line);
  background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
  box-shadow:0 10px 25px rgba(0,0,0,.35);
  border-radius:18px;
  padding:14px;
}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.field{display:flex;flex-direction:column;gap:6px;min-width:220px;flex:1}
label{font-size:12px;color:var(--muted)}
input,select,textarea{
  background:rgba(0,0,0,.22); color:var(--text);
  border:1px solid rgba(255,255,255,.10);
  border-radius:12px; padding:10px 12px; outline:none;
}
textarea{min-height:92px;resize:vertical}
input:focus,select:focus,textarea:focus{border-color:rgba(38,198,218,.55);box-shadow:0 0 0 4px rgba(38,198,218,.12)}
.btn{
  border:1px solid rgba(255,255,255,.14);
  background:linear-gradient(180deg, rgba(79,140,255,.95), rgba(38,198,218,.72));
  color:#061018; font-weight:800;
  padding:10px 14px; border-radius:14px; cursor:pointer;
}
.btn.secondary{
  background:rgba(255,255,255,.05); color:var(--text); font-weight:700;
}
.btn.ghost{background:transparent}
.btn:disabled{opacity:.45;cursor:not-allowed}
.tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
.tab{
  padding:9px 12px;border-radius:999px;border:1px solid var(--line);
  background:rgba(0,0,0,.18); color:var(--muted);
  cursor:pointer; user-select:none;
}
.tab.active{color:var(--text);background:rgba(79,140,255,.18);border-color:rgba(79,140,255,.35)}
.badge{
  display:inline-flex;align-items:center;gap:6px;
  padding:6px 10px;border-radius:999px;font-size:12px;
  border:1px solid var(--line); background:rgba(0,0,0,.18); color:var(--muted);
}
.badge.ok{background:rgba(30,226,162,.12);color:var(--good);border-color:rgba(30,226,162,.25)}
.badge.bad{background:rgba(255,93,108,.12);color:var(--bad);border-color:rgba(255,93,108,.25)}
.badge.warn{background:rgba(247,185,85,.12);color:var(--warn);border-color:rgba(247,185,85,.25)}
.hr{height:1px;background:var(--line);margin:12px 0}
.small{font-size:12px;color:var(--muted);line-height:1.4}
.kv{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:12px;white-space:pre-wrap;background:rgba(0,0,0,.25);padding:10px;border-radius:14px;border:1px solid rgba(255,255,255,.08)}
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:10px;border-bottom:1px solid rgba(255,255,255,.08);text-align:left;font-size:13px}
.table th{color:var(--muted);font-weight:700}
.slotgrid{display:grid;grid-template-columns:repeat(12,minmax(0,1fr));gap:8px}
.slot{
  display:flex;align-items:center;gap:8px;
  padding:10px;border-radius:14px;border:1px solid rgba(255,255,255,.10);
  background:rgba(0,0,0,.16);
}
.slot input{width:16px;height:16px}
.featuregrid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
.feature{
  display:flex;align-items:center;gap:10px;padding:12px;border-radius:16px;
  border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.16)
}
.feature input{width:18px;height:18px}
.preview{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.preview img{max-height:86px;border-radius:14px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.18)}
.hidden{display:none !important}
@media (max-width: 860px){
  .slotgrid{grid-template-columns:repeat(6,minmax(0,1fr))}
  .featuregrid{grid-template-columns:1fr}
}
</style>
</head>
<body>
<div class="container">
  <div class="topbar">
    <span class="dot"></span>
    <div class="h1">Admin</div>
    <span class="pill" id="pillBuild">build: -</span>
    <span class="pill" id="pillConn">nicht verbunden</span>
    <span class="pill">Hinweis: Zugriff mit <b>x-sa-password</b> oder <b>Email-Login</b></span>
  </div>

  <div class="card">
    <div class="row">
      <div class="field" style="min-width:360px;flex:2">
        <label>Worker Base URL</label>
        <input id="apiBase" placeholder="https://...workers.dev"/>
        <div class="small">Wird lokal gespeichert. Keine .workers.de / .worker.de – nur .workers.dev</div>
      </div>
      <div class="field" style="min-width:260px;flex:1">
        <label>SA Password (Header: x-sa-password)</label>
        <input id="saPass" type="password" placeholder="optional"/>
        <div class="small">Wenn falsch → 403. Wird lokal gespeichert.</div>
      </div>
      
      <div class="field" style="min-width:240px;flex:1">
        <label>Email Login</label>
        <input id="loginEmail" placeholder="email@domain.de"/>
        <div class="small">Optional. Nur Admin darf User freischalten/rollen setzen.</div>
      </div>
      <div class="field" style="min-width:220px;flex:1">
        <label>Passwort</label>
        <input id="loginPass" type="password" placeholder="••••••••"/>
        <div class="small">Token wird lokal gespeichert (24h).</div>
      </div>
      <div class="field" style="min-width:220px;flex:0">
        <label>&nbsp;</label>
        <button class="btn secondary" id="btnLogin">Login</button>
      </div>

      <div class="field" style="min-width:220px;flex:0">
        <label>&nbsp;</label>
        <button class="btn" id="btnConnect">Connect</button>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="tabs" id="tabs"></div>

    <!-- CONFIG -->
    <div id="view-config" class="view">
      <div class="row" style="justify-content:space-between">
        <div class="badge" id="cfgStatus">Config</div>
        <div class="row">
          <button class="btn secondary" id="btnCfgLoad">Load</button>
          <button class="btn" id="btnCfgSave">Save</button>
        </div>
      </div>
      <div class="hr"></div>

      <div class="row">
        <div class="field">
          <label>Stations-PIN (Eingabe verdeckt)</label>
          <input id="cfgStationPin" type="password" placeholder="z.B. 1111"/>
          <div class="small">Nach <b>Load</b> zeigen wir unten Klartext (nur Admin-Ansicht).</div>
        </div>
        <div class="field">
          <label>Trockner Minuten (Slot läuft nach Buchung ab)</label>
          <input id="cfgDryerMinutes" type="number" min="10" step="1" placeholder="z.B. 90"/>
        </div>
        <div class="field">
          <label>Retention Days</label>
          <input id="cfgRetentionDays" type="number" min="1" step="1" placeholder="z.B. 30"/>
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label>daysPast (Vergangenheit in Tagen)</label>
          <input id="cfgDaysPast" type="number" min="0" step="1" placeholder="z.B. 7"/>
        </div>
        <div class="field">
          <label>daysFuture (Zukunft in Tagen)</label>
          <input id="cfgDaysFuture" type="number" min="0" step="1" placeholder="z.B. 6"/>
        </div>
        <div class="field">
          <label>Aktuelle Station-PIN (Klartext, nach Load)</label>
          <input id="cfgStationPinClear" disabled placeholder="—"/>
        </div>
      </div>

      <div class="hr"></div>
      <div class="small"><b>Waschslotzeiten</b> (Haken → Start-Stunden 0–23). Dauer wird im Portal automatisch als „bis zum nächsten Slot“ angezeigt.</div>
      <div class="slotgrid" id="slotGrid"></div>
      <div class="small" style="margin-top:6px">Aktiv: <span id="slotActiveText">—</span></div>

      <div class="hr"></div>
      <div class="small"><b>Features</b></div>
      <div class="featuregrid">
        <div class="feature"><input type="checkbox" id="fNews"><div><b>News aktiv</b><div class="small">Portal zeigt News-Banner</div></div></div>
        <div class="feature"><input type="checkbox" id="fFeedback"><div><b>Feedback aktiv</b><div class="small">Portal Feedback-Formular</div></div></div>
        <div class="feature"><input type="checkbox" id="fDefect"><div><b>User darf Defekt melden</b><div class="small">Defekt-Button im Portal</div></div></div>
        <div class="feature"><input type="checkbox" id="fOverbook"><div><b>Trockner überbuchen</b><div class="small">Überbuchen im Portal</div></div></div>
        <div class="feature"><input type="checkbox" id="fWhitecard"><div><b>Whitecard erlaubt</b><div class="small">User kann Whitecard selbst setzen</div></div></div>
        <div class="feature"><input type="checkbox" id="fWasherPopup"><div><b>Washer Popup</b><div class="small">Info-Popup + Bild</div></div></div>
        <div class="feature"><input type="checkbox" id="fDryerPopup"><div><b>Dryer Popup</b><div class="small">Info-Popup + Bild</div></div></div>
        <div class="feature"><input type="checkbox" id="fAllowUserHide"><div><b>User kann alte Buchungen ausblenden</b><div class="small">(Portal localStorage)</div></div></div>
      </div>

      <div class="hr"></div>
      <div class="row">
        <div class="field">
          <label>News Text</label>
          <textarea id="cfgNewsText" placeholder="Kurzer Hinweis..."></textarea>
        </div>
      </div>

      <div class="hr"></div>
      <div class="small"><b>Feedback Zielgruppen</b> (im Portal Drop-Down)</div>
      <div class="row">
        <label class="badge"><input type="checkbox" id="tPS" style="margin-right:8px"> PS</label>
        <label class="badge"><input type="checkbox" id="tSV" style="margin-right:8px"> SV</label>
        <label class="badge"><input type="checkbox" id="tAdmin" style="margin-right:8px"> Admin</label>
        <span class="badge warn">Antworten auf Feedback: INAKTIV (Worker-Route fehlt)</span>
      </div>

      <div class="hr"></div>
      <div class="small"><b>Popup Bilder</b> (wir speichern DataURL direkt in der DB in config.json)</div>
      <div class="row">
        <div class="field">
          <label>Washer Popup Image (URL oder DataURL)</label>
          <input id="cfgWasherImg" placeholder="https://... oder data:image/..."/>
          <div class="row" style="margin-top:8px">
            <input id="fileWasher" type="file" accept="image/*" />
            <button class="btn secondary" id="btnClearWasher">löschen</button>
          </div>
        </div>
        <div class="field">
          <label>Dryer Popup Image (URL oder DataURL)</label>
          <input id="cfgDryerImg" placeholder="https://... oder data:image/..."/>
          <div class="row" style="margin-top:8px">
            <input id="fileDryer" type="file" accept="image/*" />
            <button class="btn secondary" id="btnClearDryer">löschen</button>
          </div>
        </div>
      </div>
      <div class="preview">
        <div class="badge">Preview</div>
        <img id="imgPrevWasher" alt="washer preview" />
        <img id="imgPrevDryer" alt="dryer preview" />
      </div>

      <div class="hr"></div>
      <div class="small"><b>Weitere geplante Admin-Funktionen</b> (UI vorhanden, Worker fehlt noch):</div>
      <div class="row" style="flex-wrap:wrap">
        <span class="badge warn">Maschinen sperren/freigeben (INAKTIV)</span>
        <span class="badge warn">Defekt-Management (INAKTIV)</span>
        <span class="badge warn">Feedback Threads + Antworten (INAKTIV)</span>
        <span class="badge warn">Logs/Protocol/Rooms (INAKTIV)</span>
      </div>
    </div>

    <!-- USERS -->
    <div id="view-users" class="view hidden">
      <div class="row" style="justify-content:space-between">
        <div class="badge" id="usersStatus">Users</div>
        <div class="row">
          <button class="btn secondary" id="btnUsersLoad">Users laden</button>
        </div>
      </div>
      <div class="hr"></div>
      <div class="small">Rollenliste kommt aus der DB (RBAC Snapshot). Du kannst Rollen setzen, auch als SA.</div>
      <div class="hr"></div>
      <table class="table">
        <thead><tr><th>Email</th><th>Status</th><th>Wunsch</th><th>Role</th><th>Aktion</th></tr></thead>
        <tbody id="usersBody"></tbody>
      </table>
      <div class="hr"></div>
      <div class="badge ok">Email-Login/Registrierung: AKTIV (Admin via Token oder SA)</div>
    </div>

    
    <!-- BOOKINGS -->
    <div id="view-bookings" class="view hidden">
      <div class="row" style="justify-content:space-between">
        <div class="badge" id="bookingsStatus">Bookings</div>
        <div class="row">
          <input id="bookingsRoom" placeholder="Room (optional)" style="width:160px"/>
          <button class="btn secondary" id="btnBookingsLoad">Load</button>
          <button class="btn secondary" id="btnBookingsCsv">CSV</button>
        </div>
      </div>
      <div class="hr"></div>
      <div class="small">Stornierung nur mit Recht <b>bookings.cancel.any</b>. Storno wird im Log mit Actor gespeichert.</div>
      <div class="hr"></div>
      <div style="overflow:auto">
        <table class="table" id="bookingsTable">
          <thead>
            <tr>
              <th>Start</th><th>Ende</th><th>Type</th><th>Machine</th><th>Room</th><th>Status</th><th>ID</th><th>Aktion</th>
            </tr>
          </thead>
          <tbody id="bookingsBody"></tbody>
        </table>
      </div>
    </div>

<!-- RBAC -->
    <div id="view-rbac" class="view hidden">
      <div class="row" style="justify-content:space-between">
        <div class="badge" id="rbacStatus">RBAC</div>
        <div class="row">
          <button class="btn secondary" id="btnRbacLoad">RBAC Snapshot</button>
        </div>
      </div>
      <div class="hr"></div>
      <div class="kv" id="rbacOut">—</div>
      <div class="hr"></div>
      <div class="small">Rollenrechte (Pro Rolle). Änderungen sind <b>nur als SA</b> möglich.</div>
      <div class="hr"></div>
      <div style="overflow:auto">
        <table class="table" id="rbacMatrix">
          <thead>
            <tr><th>Permission</th><th>SA</th><th>Admin</th><th>PS</th><th>SV</th><th>User</th></tr>
          </thead>
          <tbody id="rbacMatrixBody"></tbody>
        </table>
      </div>

      <div class="hr"></div>
      <div class="badge" id="rbacPermHint">Rechte/Perms: —</div>
    </div>

    <!-- PLACEHOLDER TABS -->
    <div id="view-machines" class="view hidden">

  <div class="row" style="gap:10px; align-items:center; flex-wrap:wrap">
    <button class="btn" id="btnMachinesLoad">Machines laden</button>
    <input class="input" id="machinesRoom" placeholder="Room (optional)" style="max-width:240px"/>
    <div class="muted">Bearbeiten: via RBAC-Perm <code>machines.write</code> (oder SA).</div>
  </div>
  <div class="card" style="margin-top:12px">
    <div class="card-h">Machines</div>
    <div class="card-b">
      <table class="table" id="tblMachines">
        <thead><tr><th>Room</th><th>Kind</th><th>ID</th><th>Label</th><th>Min</th><th>Enabled</th><th>Defekt</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

</div></div>
    <div id="view-defects" class="view hidden">

  <div class="row" style="gap:10px; align-items:center; flex-wrap:wrap">
    <button class="btn" id="btnDefectsLoad">Defekte laden</button>
    <input class="input" id="defectsRoom" placeholder="Room (optional)" style="max-width:240px"/>
  </div>
  <div class="card" style="margin-top:12px">
    <div class="card-h">Defekte</div>
    <div class="card-b">
      <table class="table" id="tblDefects">
        <thead><tr><th>Zeit</th><th>Room</th><th>Kind</th><th>Machine</th><th>Text</th><th>Status</th><th>Aktion</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

</div></div>
    <div id="view-feedback" class="view hidden">

  <div class="row" style="gap:10px; align-items:center; flex-wrap:wrap">
    <button class="btn" id="btnFeedbackLoad">Feedback laden</button>
  </div>
  <div class="card" style="margin-top:12px">
    <div class="card-h">Feedback</div>
    <div class="card-b">
      <table class="table" id="tblFeedback">
        <thead><tr><th>Zeit</th><th>Room</th><th>Message</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

</div></div>
    <div id="view-logs" class="view hidden">
      <div class="row" style="justify-content:space-between">
        <div class="badge" id="logsStatus">Logs</div>
        <div class="row">
          <input id="logsAction" placeholder="action filter (optional)" style="width:200px"/>
          <button class="btn secondary" id="btnLogsLoad">Load</button>
          <button class="btn secondary" id="btnLogsCsv">CSV</button>
        </div>
      </div>
      <div class="hr"></div>
      <div style="overflow:auto">
        <table class="table" id="logsTable">
          <thead>
            <tr><th>Zeit</th><th>Action</th><th>Actor</th><th>Role</th><th>Target</th><th>Meta</th></tr>
          </thead>
          <tbody id="logsBody"></tbody>
        </table>
      </div>
    </div>
    <div id="view-rooms" class="view hidden">

  <div class="row" style="gap:10px; align-items:center; flex-wrap:wrap">
    <button class="btn" id="btnRoomsLoad">Rooms laden</button>
  </div>
  <div class="card" style="margin-top:12px">
    <div class="card-h">Rooms</div>
    <div class="card-b">
      <table class="table" id="tblRooms">
        <thead><tr><th>ID</th><th>Name</th><th>Active</th><th>Aktion</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="row" style="gap:10px; margin-top:12px; flex-wrap:wrap">
        <input class="input" id="roomId" placeholder="room-id" style="max-width:180px"/>
        <input class="input" id="roomName" placeholder="Name" style="max-width:260px"/>
        <label class="row" style="gap:8px"><input type="checkbox" id="roomActive" checked/> aktiv</label>
        <button class="btn" id="btnRoomSave">Room speichern</button>
      </div>
    </div>
  </div>

</div></div>
    <div id="view-privacy" class="view hidden">
      <div class="badge">Privacy Meta</div>
      <div class="hr"></div>
      <button class="btn secondary" id="btnPrivacyLoad">/api/privacy/meta laden</button>
      <div class="hr"></div>
      <div class="kv" id="privacyOut">—</div>
    </div>

    <div class="hr"></div>
    <div class="small" id="msg"></div>
  </div>
</div>

<script>
(() => {
  const el = (id) => document.getElementById(id);
  const msg = (t, kind="") => {
    const m = el("msg");
    m.textContent = t || "";
    m.style.color = kind==="bad" ? "var(--bad)" : kind==="ok" ? "var(--good)" : "var(--muted)";
  };

  let API = "";
  let SA = "";
  let ROUTES = new Set();
  let TOKEN = localStorage.getItem('wp_admin_token') || "";
  
  // Prefill base URL
  try {
    const b = el("base");
    if (b && !b.value) b.value = "https://washportal-dev-worker.schluffi1220.workers.dev";
  } catch(_){
  }
let ROLE_OPTIONS = [];

  const RBAC_PERMS = [
    { key:"users.list", label:"users.list – Userliste sehen" },
    { key:"users.approve", label:"users.approve – User freischalten" },
    { key:"users.role.set", label:"users.role.set – Rollen setzen (SA only)" },
    { key:"role.transfer.accept", label:"role.transfer.accept – PS/SV Übergabe" },

    { key:"bookings.read", label:"bookings.read – Buchungen sehen" },
    { key:"bookings.cancel.any", label:"bookings.cancel.any – Buchungen stornieren (Admin)" },
    { key:"bookings.csv.export", label:"bookings.csv.export – Buchungen CSV Download" },

    { key:"logs.read", label:"logs.read – Logs sehen" },
    { key:"logs.csv.export", label:"logs.csv.export – Logs CSV Download" },

    { key:"config.get", label:"config.get – Config lesen" },
    { key:"config.set", label:"config.set – Config ändern" },


    { key:"machines.read", label:"machines.read – Machines sehen" },
    { key:"machines.write", label:"machines.write – Machines ändern" },

    { key:"defects.read", label:"defects.read – Defekte sehen" },
    { key:"defects.clear", label:"defects.clear – Defekte freigeben" },

    { key:"feedback.read", label:"feedback.read – Feedback sehen" },

    { key:"rooms.read", label:"rooms.read – Rooms sehen" },
    { key:"rooms.write", label:"rooms.write – Rooms ändern" },

    { key:"rbac.snapshot", label:"rbac.snapshot – RBAC Snapshot lesen" },
    { key:"rbac.perm.set", label:"rbac.perm.set – RBAC ändern (SA only)" }
  ];

  function bool(v){ return String(v)==="1" || v===1 || v===true; }

  function canEditRbacPerms(){
    return ROUTES.has("/api/auth/admin/rbac/perm/set") && !!SA;
  }

  async function setRolePerm(role, perm, allowed){
    // Worker enforces SA-only
    await jpost("/api/auth/admin/rbac/perm/set", { scope:"role", role, perm, allowed: !!allowed });
  }

  function renderRbacMatrix(data){
    const hint = el("rbacPermHint");
    if (hint){
      const active = ROUTES.has("/api/auth/admin/rbac/perm/set");
      hint.classList.remove("ok","warn","bad");
      hint.classList.add(active ? (SA ? "ok":"warn") : "warn");
      hint.textContent = active
        ? (SA ? "Rechte/Perms: AKTIV (SA)" : "Rechte/Perms: gesperrt (nur SA-Passwort eingeben)")
        : "Rechte/Perms: INAKTIV (Route fehlt)";
    }

    const roleMap = new Map(); // role -> perm -> allowed
    (data.rolePermissions || []).forEach(rp => {
      const role = String(rp.role||"").toLowerCase();
      const perm = String(rp.perm||"");
      if (!roleMap.has(role)) roleMap.set(role, new Map());
      roleMap.get(role).set(perm, bool(rp.allowed));
    });

    const roles = ["admin","ps","sv","user"];
    let body = el("rbacMatrixBody") || el("rbacRolesBody");
    if (!body) {
      // Create tbody dynamically if missing (older HTML)
      const tbl = el("rbacMatrix") || document.querySelector("table#rbacMatrix");
      if (tbl) {
        let tb = tbl.querySelector("tbody");
        if (!tb) { tb = document.createElement("tbody"); tbl.appendChild(tb); }
        tb.id = "rbacMatrixBody";
        body = tb;
      }
    }
    if (!body) { msg("RBAC Matrix DOM fehlt (rbacMatrixBody).", "bad"); return; }
    body.innerHTML = "";
    // debug
    // console.log("renderRbacMatrix", snap);

    const editable = canEditRbacPerms();

    for (const p of RBAC_MATRIX_PERMS){
      const tr = document.createElement("tr");
      const cells = [];
      cells.push(`<td>${escapeHtml(p.label)}</td>`);
      cells.push(`<td>✅</td>`); // SA always
      for (const r of roles){
        const checked = roleMap.get(r)?.get(p.key) ? "checked" : "";
        const dis = editable ? "" : "disabled";
        cells.push(`<td><input type="checkbox" ${checked} ${dis} data-role="${r}" data-perm="${escapeHtml(p.key)}"></td>`);
      }
      tr.innerHTML = cells.join("");
      body.appendChild(tr);
    }

    // wire changes
    body.querySelectorAll("input[type=checkbox]").forEach(cb => {
      cb.addEventListener("change", async () => {
        try{
          const role = cb.getAttribute("data-role");
          const perm = cb.getAttribute("data-perm");
          await setRolePerm(role, perm, cb.checked);
          msg("Gespeichert.", "ok");
        } catch(e){
          msg("Fehler: " + (e.data?.message || e.message), "bad");
          cb.checked = !cb.checked;
        }
      });
    });
  }


  function normBase(u){
    u = (u||"").trim();
    u = u.replace(/\/+$/,'');
    if (!u) return "";
    return u;
  }

  async function jfetch(path, opts={}){
    if (!API) throw new Error("Kein Worker gesetzt.");
    const headers = Object.assign({}, opts.headers || {});
    if (SA) headers["x-sa-password"] = SA;
    if (TOKEN) headers["authorization"] = "Bearer " + TOKEN;
    headers["content-type"] = headers["content-type"] || "application/json";
    const res = await fetch(API + path, Object.assign({}, opts, { headers }));
    const ct = res.headers.get("content-type") || "";
    const data = ct.includes("application/json") ? await res.json() : { ok:false, status:res.status, message: await res.text() };
    if (!res.ok) throw Object.assign(new Error(data?.message || "HTTP "+res.status), { data, status: res.status });
    return data;
  }
  const jpost = (path, body) => jfetch(path, { method:"POST", body: JSON.stringify(body||{}) });
  const jget = (path) => jfetch(path, { method:"GET", headers: { "content-type": "text/plain" } });

  function setConn(ok, build=""){
    el("pillConn").textContent = ok ? "verbunden" : "nicht verbunden";
    el("pillConn").className = "pill " + (ok ? "" : "");
    el("pillBuild").textContent = "build: " + (build || "-");
  }

  function setCfgBadge(kind, text){
    const b = document.getElementById("cfgStatus");
    if (!b) return;
    b.textContent = text || "Config";
    b.classList.remove("ok","warn","bad");
    if (kind) b.classList.add(kind);
  }

  function tabButton(key, label, warn=false){
    const b = document.createElement("div");
    b.className = "tab";
    b.dataset.key = key;
    b.textContent = label + (warn ? " (INAKTIV)" : "");
    b.addEventListener("click", () => setTab(key));
    return b;
  }

  function setTab(key){
    for (const t of document.querySelectorAll(".tab")) t.classList.toggle("active", t.dataset.key===key);
    for (const v of document.querySelectorAll(".view")) v.classList.add("hidden");
    el("view-"+key).classList.remove("hidden");
  }

  function buildTabs(){
    const t = el("tabs");
    t.innerHTML = "";
    const active = (k) => ROUTES.has(k);
    // These are "capabilities" based on routes we actually have:
    t.appendChild(tabButton("config","Config", !active("/api/auth/admin/config/get")));
    t.appendChild(tabButton("users","Users", !active("/api/auth/admin/users/list")));
    t.appendChild(tabButton("rbac","RBAC", !active("/api/auth/admin/rbac/snapshot")));
    t.appendChild(tabButton("bookings","Bookings", !active("/api/auth/admin/bookings/list")));
    t.appendChild(tabButton("machines","Machines", true));
    t.appendChild(tabButton("defects","Defects", true));
    t.appendChild(tabButton("feedback","Feedback", true));
    t.appendChild(tabButton("logs","Logs", !active("/api/auth/admin/logs/list")));
    t.appendChild(tabButton("rooms","Rooms", true));
    t.appendChild(tabButton("privacy","Privacy", !active("/api/privacy/meta")));
    setTab("config");
  }

  function hoursFromChecks(){
    const hours=[];
    for (let h=0; h<24; h++){
      const cb = el("slot_"+h);
      if (cb && cb.checked) hours.push(h);
    }
    hours.sort((a,b)=>a-b);
    return hours;
  }
  function setChecksFromHours(hours){
    const set = new Set((hours||[]).map(n=>Number(n)));
    for (let h=0; h<24; h++){
      const cb = el("slot_"+h);
      if (cb) cb.checked = set.has(h);
    }
    updateSlotActiveText();
  }
  function updateSlotActiveText(){
    const hours = hoursFromChecks();
    el("slotActiveText").textContent = hours.length ? hours.map(h=>String(h).padStart(2,"0")+":00").join(", ") : "—";
  }
  function initSlotGrid(){
    const g = el("slotGrid");
    g.innerHTML = "";
    for (let h=0; h<24; h++){
      const d = document.createElement("label");
      d.className = "slot";
      d.innerHTML = `<input type="checkbox" id="slot_${h}"><span>${String(h).padStart(2,"0")}:00</span>`;
      g.appendChild(d);
      d.querySelector("input").addEventListener("change", updateSlotActiveText);
    }
  }

  function configToUI(cfg){
    cfg = cfg || {};
    el("cfgDryerMinutes").value = cfg.dryerMinutes ?? cfg.dryerSlotMinutes ?? cfg.dryer_slot_minutes ?? "";
    el("cfgRetentionDays").value = cfg.retentionDays ?? cfg.retention_days ?? "";
    el("cfgDaysPast").value = cfg.daysPast ?? cfg.days_past ?? "";
    el("cfgDaysFuture").value = cfg.daysFuture ?? cfg.days_future ?? "";
    // station pin: masked input empty (we don't re-fill), but show clear if present
    el("cfgStationPinClear").value = cfg.stationPin ?? cfg.station_pin ?? "—";

    const hours = cfg.washerHours ?? cfg.washer_hours ?? cfg.washerSlots ?? cfg.washer_slots ?? [];
    setChecksFromHours(hours);

    const features = cfg.features || cfg;
    el("fNews").checked = !!(features.newsEnabled ?? features.news ?? false);
    el("fFeedback").checked = !!(features.feedbackEnabled ?? features.feedback ?? false);
    el("fDefect").checked = !!(features.userCanReportDefect ?? features.userDefect ?? features.allowDefectReport ?? false);
    el("fOverbook").checked = !!(features.allowOverbook ?? features.overbook ?? false);
    el("fWhitecard").checked = !!(features.whitecardEnabled ?? features.whitecard ?? false);
    el("fWasherPopup").checked = !!(features.showWasherPopup ?? features.washerPopup ?? false);
    el("fDryerPopup").checked = !!(features.showDryerPopup ?? features.dryerPopup ?? false);
    el("fAllowUserHide").checked = true;

    el("cfgNewsText").value = cfg.newsText ?? cfg.news_text ?? "";

    // targets
    const targets = (cfg.feedbackTargets ?? cfg.feedback_targets ?? "ps,sv,admin").toString().toLowerCase();
    el("tPS").checked = targets.includes("ps");
    el("tSV").checked = targets.includes("sv");
    el("tAdmin").checked = targets.includes("admin");

    // images
    el("cfgWasherImg").value = cfg.washerPopupImage ?? cfg.washer_popup_image ?? "";
    el("cfgDryerImg").value = cfg.dryerPopupImage ?? cfg.dryer_popup_image ?? "";
    updatePreviews();
  }

  function uiToConfig(){
    const cfg = {};
    const stationPin = (el("cfgStationPin").value || "").trim();
    if (stationPin) cfg.stationPin = stationPin;

    cfg.dryerMinutes = Number(el("cfgDryerMinutes").value || 0) || 0;
    cfg.retentionDays = Number(el("cfgRetentionDays").value || 0) || 0;
    cfg.daysPast = Number(el("cfgDaysPast").value || 0) || 0;
    cfg.daysFuture = Number(el("cfgDaysFuture").value || 0) || 0;
    cfg.washerHours = hoursFromChecks();

    cfg.features = {
      newsEnabled: el("fNews").checked,
      feedbackEnabled: el("fFeedback").checked,
      userCanReportDefect: el("fDefect").checked,
      allowOverbook: el("fOverbook").checked,
      whitecardEnabled: el("fWhitecard").checked,
      showWasherPopup: el("fWasherPopup").checked,
      showDryerPopup: el("fDryerPopup").checked
    };

    cfg.newsText = el("cfgNewsText").value || "";

    const targets = [];
    if (el("tPS").checked) targets.push("ps");
    if (el("tSV").checked) targets.push("sv");
    if (el("tAdmin").checked) targets.push("admin");
    cfg.feedbackTargets = targets.join(",");

    cfg.washerPopupImage = (el("cfgWasherImg").value||"").trim();
    cfg.dryerPopupImage = (el("cfgDryerImg").value||"").trim();
    return cfg;
  }

  function updatePreviews(){
    const w = el("cfgWasherImg").value.trim();
    const d = el("cfgDryerImg").value.trim();
    const iw = el("imgPrevWasher");
    const id = el("imgPrevDryer");
    iw.src = w || "data:image/gif;base64,R0lGODlhAQABAAAAACw=";
    id.src = d || "data:image/gif;base64,R0lGODlhAQABAAAAACw=";
  }

  async function fileToDataURL(file){
    return await new Promise((resolve,reject)=>{
      const fr=new FileReader();
      fr.onerror=()=>reject(new Error("FileReader error"));
      fr.onload=()=>resolve(String(fr.result||""));
      fr.readAsDataURL(file);
    });
  }

  async function connect(){
    API = normBase(el("apiBase").value);
    SA = (el("saPass").value||"").trim();
    if (!API) { msg("Bitte Worker Base URL setzen.","bad"); return; }

    localStorage.setItem("wp_admin_apiBase", API);
    localStorage.setItem("wp_admin_sa", SA);

    msg("Verbinde...");
    setCfgBadge("warn","Config: (noch nicht geladen)");

    // load routes + status
    const routes = await jget("/api/_routes").catch(async () => ({ ok:false, routes:[] }));
    ROUTES = new Set((routes.routes||[]).map(r => String(r).split(" ").slice(1).join(" ")).filter(Boolean));

    const st = await jget("/api/_status");
    setConn(true, st.build || st.version || "-");
    buildTabs();
    msg("Verbunden. Worker: " + (st.build || "-"), "ok");
    if (ROUTES.has("/api/auth/admin/config/get")) setCfgBadge("warn","Config: bereit (Load klicken)");

    // preload RBAC roles list (optional)
    await loadRbac().catch(()=>{});
  }

  async function loadConfig(){
    const data = await jpost("/api/auth/admin/config/get", {});
    const cfg = data.config || data.cfg || data;
    configToUI(cfg);
    msg("Config geladen.", "ok");
    setCfgBadge("ok","Config: AKTIV");
  }

  async function saveConfig(){
    const cfg = uiToConfig();
    const data = await jpost("/api/auth/admin/config/set", { config: cfg });
    msg("Config gespeichert.", "ok");
    setCfgBadge("ok","Config: gespeichert");
    // reload to show cleartext station pin after set
    await loadConfig();
  }

  async function loadUsers(){
    const data = await jpost("/api/auth/admin/users/list", {});
    const users = data.users || data.items || [];
    const tbody = el("usersBody");
    tbody.innerHTML = "";
    // debug
    // console.log("renderRbacMatrix", snap);
    for (const u of users){
      const tr = document.createElement("tr");
      const email = u.email || u.userEmail || "";
      const status = u.status || "";
      const role = u.role || "";
      const sel = document.createElement("select");
      const opts = (ROLE_OPTIONS.length ? ROLE_OPTIONS : [...new Set(users.map(x=>x.role).filter(Boolean))]).sort();
      for (const r of opts){
        const o = document.createElement("option");
        o.value = r; o.textContent = r;
        if (r === role) o.selected = true;
        sel.appendChild(o);
      }
      const btn = document.createElement("button");
      btn.className = "btn secondary";
      btn.textContent = "Role setzen";
      btn.addEventListener("click", async () => {
        btn.disabled = true;
        try{
          await jpost("/api/auth/admin/users/role/set", { email, role: sel.value });
          msg("Rolle gesetzt: "+email+" → "+sel.value, "ok");
          await loadUsers();
        } catch(e){
          msg("Fehler Role set: " + (e.data?.message || e.message), "bad");
        } finally { btn.disabled = false; }
      });
      const wish = (u.requestedRole || "").toString();
      const approve = document.createElement("button");
      approve.className = "btn secondary";
      approve.textContent = "Approve";
      approve.style.marginRight = "8px";
      approve.disabled = (status||"").toLowerCase() === "active";
      approve.addEventListener("click", async () => {
        approve.disabled = true;
        try{
          await jpost("/api/auth/admin/users/approve", { email });
          msg("Approved: " + email, "ok");
          await loadUsers();
        } catch(e){
          msg("Fehler Approve: " + (e.data?.message || e.message), "bad");
        }
      });

      const transfer = document.createElement("button");
      transfer.className = "btn secondary";
      transfer.textContent = "Transfer PS/SV";
      transfer.addEventListener("click", async () => {
        transfer.disabled = true;
        try{
          const r = (wish || sel.value || "").toLowerCase();
          if (r !== "ps" && r !== "sv") throw new Error("Wunschrolle muss ps oder sv sein.");
          await jpost("/api/auth/role/transfer/accept", { role: r, toEmail: email });
          msg("Transfer ausgeführt: " + r + " → " + email, "ok");
          await loadUsers();
        } catch(e){
          msg("Fehler Transfer: " + (e.data?.message || e.message), "bad");
        } finally { transfer.disabled = false; }
      });

      tr.innerHTML = `<td>${escapeHtml(email)}</td><td>${escapeHtml(status)}</td><td>${escapeHtml(wish)}</td>`;
      const tdRole = document.createElement("td"); tdRole.appendChild(sel);
      const tdAct = document.createElement("td");
      tdAct.appendChild(approve);
      tdAct.appendChild(btn);
      tdAct.appendChild(transfer);
      tr.appendChild(tdRole); tr.appendChild(tdAct);
      tbody.appendChild(tr);
    }
    msg("Users geladen: " + users.length, "ok");
  }

  async function loadRbac(){
    const data = await jpost("/api/auth/admin/rbac/snapshot", {});
    
    window.__lastRbacSnap = data;
el("rbacOut").textContent = JSON.stringify(data, null, 2);
    // extract roles list
    const roles = data.roles || data.roleList || data.availableRoles || [];
    if (Array.isArray(roles) && roles.length){
      ROLE_OPTIONS = roles.map(r => (typeof r === "string" ? r : (r && (r.role || r.name)))).filter(Boolean).map(String);
    } else if (typeof data === "object") {
      // fallback: parse from message or keys
      const txt = JSON.stringify(data);
      // crude: roles: [...] already handled
    }
    try { if (typeof renderRbacMatrix==="function") renderRbacMatrix(data); } catch(e){ msg("RBAC Matrix Fehler: "+(e.message||e), "bad"); console.error(e);} 
    msg("RBAC Snapshot ok.", "ok");
    return data;
  }

  async function loadPrivacy(){
    const data = await jget("/api/privacy/meta");
    el("privacyOut").textContent = JSON.stringify(data, null, 2);
    msg("Privacy Meta geladen.", "ok");
  }

  function escapeHtml(s){
    return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  
  async function doLogin(){
    const email = (el("loginEmail").value||"").trim();
    const password = (el("loginPass").value||"").trim();
    if (!email || !password) { msg("Email & Passwort eingeben.", "bad"); return; }
    const data = await jpost("/api/auth/login", { email, password });
    TOKEN = data.token || "";
    localStorage.setItem("wp_admin_token", TOKEN);
    msg("Login ok (Token gespeichert).", "ok");
  }



  function setText(id, v) {
    const x = document.getElementById(id);
    if (x) x.textContent = (v === null || typeof v === "undefined" || v === "") ? "—" : String(v);
  }

  
    const RBAC_MATRIX_PERMS = [
    // Users / Auth / RBAC
    { key:"users.list", label:"Userliste sehen" },
    { key:"users.approve", label:"User freischalten" },
    { key:"users.role.set", label:"Rolle setzen (direkt)" },
    { key:"role.transfer.accept", label:"PS/SV Übergabe" },
    { key:"rbac.snapshot", label:"RBAC Snapshot lesen" },
    { key:"rbac.perm.set", label:"RBAC bearbeiten" },

    // Bookings (Admin)
    { key:"bookings.read", label:"Buchungen ansehen" },
    { key:"bookings.cancel.any", label:"Buchungen stornieren (Admin)" },
    { key:"bookings.csv.export", label:"Buchungen CSV-Download" },

    // Logs (Admin)
    { key:"logs.read", label:"Logs ansehen" },
    { key:"logs.csv.export", label:"Logs CSV-Download" },

    // Prepared (coming soon)
    { key:"machines.read", label:"Maschinen ansehen (vorbereitet)" },
    { key:"machines.edit", label:"Maschinen bearbeiten (vorbereitet)" },
    { key:"defects.read", label:"Defekte ansehen (vorbereitet)" },
    { key:"defects.clear", label:"Defekte freigeben/auflösen (vorbereitet)" },
    { key:"feedback.read", label:"Feedback ansehen (vorbereitet)" },
    { key:"rooms.read", label:"Rooms ansehen (vorbereitet)" },
    { key:"rooms.edit", label:"Rooms bearbeiten (vorbereitet)" },
    { key:"config.get", label:"Config lesen (vorbereitet)" },
    { key:"config.set", label:"Config schreiben (vorbereitet)" }
  ];

  function bool(v){ return String(v) === "1" || v === 1 || v === true; }

  async function setPerm(scope, target, perm, allowed){
    // RBAC ändern: nur SA
    const sa = (el("saPass")?.value || el("saPassword")?.value || "").trim();
    if (!sa) { msg("RBAC ändern: nur SA (SA-Passwort oben eingeben).", "bad"); throw new Error("sa_required"); }
  
    const payload = { scope, perm, allowed: !!allowed };
    if (scope === "role") payload.role = target;
    else payload.email = target;
    await jpost("/api/auth/admin/rbac/perm/set", payload);
  }

  async function loadRbacSnapshot() {
    msg("");
    const snap = await jpost("/api/auth/admin/rbac/snapshot", {});
    
    window.__lastRbacSnap = data;
setText("rbacRaw", JSON.stringify(snap, null, 2));

    const body = el("rbacRolesBody");
    body.innerHTML = "";
    // debug
    // console.log("renderRbacMatrix", snap);
    (data.roles || []).forEach(r => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${escapeHtml(r.role)}</td><td>${escapeHtml(String(r.cnt))}</td>`;
      body.appendChild(tr);
    });

    const ul = await jpost("/api/auth/admin/users/list", {});
    const users = ul.users || [];
    const ps = users.find(u => String(u.role||"").toLowerCase() === "ps" && String(u.status||"").toLowerCase()==="active");
    const sv = users.find(u => String(u.role||"").toLowerCase() === "sv" && String(u.status||"").toLowerCase()==="active");
    setText("rbacPs", ps ? ps.email : "—");
    setText("rbacSv", sv ? sv.email : "—");

    const roleMap = new Map();
    (data.rolePermissions || []).forEach(rp => {
      const role = String(rp.role||"").toLowerCase();
      const perm = String(rp.perm||"");
      if (!roleMap.has(role)) roleMap.set(role, new Map());
      roleMap.get(role).set(perm, bool(rp.allowed));
    });

    const userMap = new Map();
    (data.userOverrides || []).forEach(up => {
      const em = String(up.email||"").toLowerCase();
      const perm = String(up.perm||"");
      if (!userMap.has(em)) userMap.set(em, new Map());
      userMap.get(em).set(perm, bool(up.allowed));
    });

    const scope = (el("rbacScope")?.value || "role");
    const target = scope === "user" ? String(el("rbacUserEmail")?.value||"").trim().toLowerCase() : null;

    const roles = ["admin","ps","sv","user"];
    const mbody = el("rbacMatrixBody");
    mbody.innerHTML = "";
    // debug
    // console.log("renderRbacMatrix", snap);

    RBAC_PERMS.forEach(p => {
      const tr = document.createElement("tr");
      const cells = [];
      cells.push(`<td>${escapeHtml(p.label)}</td>`);
      cells.push(`<td>✅</td>`); // SA

      roles.forEach(role => {
        const allowed = scope === "role"
          ? (roleMap.get(role)?.get(p.key) || false)
          : (target ? (userMap.get(target)?.get(p.key) || false) : false);

        const disabled = (scope === "user" && !target) ? "disabled" : "";
        const checked = allowed ? "checked" : "";
        const saPresent = ((el("saPass")?.value||el("saPassword")?.value||"").trim().length>0);
        const dis2 = (!saPresent) ? "disabled" : disabled;
        cells.push(`<td><input type="checkbox" ${checked} ${dis2} data-role="${role}" data-perm="${escapeHtml(p.key)}"/></td>`);
      });

      tr.innerHTML = cells.join("");
      mbody.appendChild(tr);
    });

    mbody.querySelectorAll("input[type=checkbox]").forEach(cb => {
      cb.addEventListener("change", async () => {
        try{
          const perm = cb.getAttribute("data-perm");
          const sc = el("rbacScope").value;
          if (sc === "role") {
            const role = cb.getAttribute("data-role");
            await setPerm("role", role, perm, cb.checked);
          } else {
            const email = String(el("rbacUserEmail").value||"").trim().toLowerCase();
            if (!email) { msg("Bitte User Email für Override angeben.", "bad"); cb.checked = !cb.checked; return; }
            await setPerm("user", email, perm, cb.checked);
          }
          msg("Gespeichert.", "ok");
        } catch(e){
          msg("Fehler Speichern: " + (e.data?.message || e.message), "bad");
          cb.checked = !cb.checked;
        }
      });
    });
  }



  // wire
  initSlotGrid();
  el("btnConnect").addEventListener("click", () => connect().catch(e => msg(e.data?.message || e.message, "bad")));
  el("saPass")?.addEventListener("input", () => { SA = (el("saPass").value||"").trim(); try { if (window.__lastRbacSnap) renderRbacMatrix(window.__lastRbacSnap); } catch(_){} });
  el("btnLogin").addEventListener("click", () => doLogin().catch(e => msg(e.data?.message || e.message, "bad")));
  el("btnCfgLoad").addEventListener("click", () => loadConfig().catch(e => msg(e.data?.message || e.message, "bad")));
  el("btnCfgSave").addEventListener("click", () => saveConfig().catch(e => msg(e.data?.message || e.message, "bad")));
  // BOOKINGS
  async function loadBookings(){
    try{
      msg("", "");
      const room = (el("bookingsRoom").value||"").trim();
      const data = await jpost("/api/auth/admin/bookings/list", { room, limit: 200 });
      const rows = data.rows || [];
      const body = el("bookingsBody");
      body.innerHTML = "";
      for (const r of rows){
        const tr = document.createElement("tr");
        const d1 = r.startAt ? new Date(Number(r.startAt)).toLocaleString() : "";
        const d2 = r.endAt ? new Date(Number(r.endAt)).toLocaleString() : "";
        const status = String(r.status||"");
        const canCancel = ROUTES.has("/api/auth/admin/booking/cancel");
        tr.innerHTML = `
          <td>${escapeHtml(d1)}</td>
          <td>${escapeHtml(d2)}</td>
          <td>${escapeHtml(String(r.type||""))}</td>
          <td>${escapeHtml(String(r.machine||""))}</td>
          <td>${escapeHtml(String(r.room||""))}</td>
          <td>${escapeHtml(status)}</td>
          <td class="mono">${escapeHtml(String(r.id||""))}</td>
          <td>
            <button class="btn secondary" data-act="cancelBooking" data-id="${escapeHtml(String(r.id||""))}">Stornieren</button>
          </td>
        `;
        body.appendChild(tr);
      }
      // wire cancel
      body.querySelectorAll('[data-act="cancelBooking"]').forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          try{
            const id = btn.dataset.id;
            const reason = prompt("Storno-Grund (wird geloggt):", "");
            if(reason===null) return;
            await jpost("/api/auth/admin/booking/cancel", { id, reason: String(reason||"").trim() });
            await loadBookings();
            msg("Storniert & geloggt.", "ok");
          }catch(e){
            msg(e.data?.message || e.message, "bad");
          }
        });
      });

      el("bookingsStatus").textContent = "Bookings: " + rows.length;
    }catch(e){
      msg(e.data?.message || e.message, "bad");
    }
  }

  async function bookingsCsv(){
    try{
      const room = (el("bookingsRoom").value||"").trim();
      const r = await fetch(BASE()+"/api/auth/admin/bookings/csv", {
        method:"POST",
        headers: headers(),
        body: JSON.stringify({ room, limit: 2000 })
      });
      if(!r.ok) throw new Error("CSV fehlgeschlagen ("+r.status+")");
      const blob = await r.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "bookings.csv";
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 2000);
    }catch(e){
      msg(e.message, "bad");
    }
  }

  // LOGS
  async function loadLogs(){
    try{
      const action = (el("logsAction").value||"").trim();
      const data = await jpost("/api/auth/admin/logs/list", { action, limit: 200 });
      const rows = data.rows || [];
      const body = el("logsBody");
      body.innerHTML = "";
      for (const r of rows){
        const t = r.createdAt ? new Date(Number(r.createdAt)).toLocaleString() : "";
        const meta = r.meta ? JSON.stringify(r.meta) : "";
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(t)}</td>
          <td>${escapeHtml(String(r.action||""))}</td>
          <td>${escapeHtml(String(r.actorEmail||""))}</td>
          <td>${escapeHtml(String(r.actorRole||""))}</td>
          <td class="mono">${escapeHtml(String(r.targetId||""))}</td>
          <td class="mono">${escapeHtml(meta)}</td>
        `;
        body.appendChild(tr);
      }
      el("logsStatus").textContent = "Logs: " + rows.length;
    }catch(e){
      msg(e.data?.message || e.message, "bad");
    }
  }

  async function logsCsv(){
    try{
      const r = await fetch(BASE()+"/api/auth/admin/logs/csv", {
        method:"POST",
        headers: headers(),
        body: JSON.stringify({ limit: 2000 })
      });
      if(!r.ok) throw new Error("CSV fehlgeschlagen ("+r.status+")");
      const blob = await r.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "logs.csv";
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 2000);
    }catch(e){
      msg(e.message, "bad");
    }
  }


  el("btnUsersLoad").addEventListener("click", () => loadUsers().catch(e => msg(e.data?.message || e.message, "bad")));
  el("btnBookingsLoad").addEventListener("click", () => loadBookings());
  el("btnBookingsCsv").addEventListener("click", () => bookingsCsv());
  el("btnLogsLoad").addEventListener("click", () => loadLogs());
  el("btnLogsCsv").addEventListener("click", () => logsCsv());
  el("btnRbacLoad").addEventListener("click", () => loadRbac().catch(e => msg(e.data?.message || e.message, "bad")));
  el("btnPrivacyLoad").addEventListener("click", () => loadPrivacy().catch(e => msg(e.data?.message || e.message, "bad")));

  el("cfgWasherImg").addEventListener("input", updatePreviews);
  el("cfgDryerImg").addEventListener("input", updatePreviews);

  el("btnClearWasher").addEventListener("click", () => { el("cfgWasherImg").value=""; updatePreviews(); });
  el("btnClearDryer").addEventListener("click", () => { el("cfgDryerImg").value=""; updatePreviews(); });

  el("fileWasher").addEventListener("change", async (ev) => {
    const f = ev.target.files?.[0]; if (!f) return;
    if (f.size > 250*1024) {
  msg("Bild zu groß für DB (D1). Bitte kleineres Bild wählen (<=250KB) oder eine https:// Bild-URL eintragen.", "bad");
  ev.target.value = "";
  return;
}
el("cfgWasherImg").value = await fileToDataURL(f);
    updatePreviews();
    msg("Washer Bild geladen (DataURL). Nicht vergessen: Save.", "ok");
  });
  el("fileDryer").addEventListener("change", async (ev) => {
    const f = ev.target.files?.[0]; if (!f) return;
    if (f.size > 250*1024) {
  msg("Bild zu groß für DB (D1). Bitte kleineres Bild wählen (<=250KB) oder eine https:// Bild-URL eintragen.", "bad");
  ev.target.value = "";
  return;
}
el("cfgDryerImg").value = await fileToDataURL(f);
    updatePreviews();
    msg("Dryer Bild geladen (DataURL). Nicht vergessen: Save.", "ok");
  });

  // restore
  el("apiBase").value = localStorage.getItem("wp_admin_apiBase") || "";
  el("saPass").value = localStorage.getItem("wp_admin_sa") || "";
  buildTabs();
  updatePreviews();
})();

// ===== Admin extra tabs (Machines / Defects / Feedback / Rooms) =====
async function loadMachines(){
  const room = (document.getElementById("machinesRoom")?.value||"").trim();
  const data = await jpost("/api/auth/admin/machines/list", { room });
  const tbody = document.querySelector("#tblMachines tbody");
  if(!tbody) return;
  tbody.innerHTML = "";
  (data.rows||[]).forEach(r=>{
    const tr=document.createElement("tr");
    tr.innerHTML = `
      <td>${esc(r.room||"")}</td>
      <td>${esc((r.kind||"").toUpperCase())}</td>
      <td>${esc(String(r.machineId||""))}</td>
      <td>${esc(r.label||"")}</td>
      <td>${r.minutes==null?"":esc(String(r.minutes))}</td>
      <td>${r.enabled? "✅":"—"}</td>
      <td>${r.defective? "⚠️":"—"}</td>
    `;
    tbody.appendChild(tr);
  });
  toast(`Machines geladen: ${(data.rows||[]).length}`);
}
async function loadDefects(){
  const room = (document.getElementById("defectsRoom")?.value||"").trim();
  const data = await jpost("/api/auth/admin/defects/list", { room });
  const tbody = document.querySelector("#tblDefects tbody");
  if(!tbody) return;
  tbody.innerHTML="";
  (data.rows||[]).forEach(r=>{
    const tr=document.createElement("tr");
    const status = r.clearedAt ? `frei (${esc(r.clearedBy||"")})` : "offen";
    tr.innerHTML = `
      <td>${fmtTs(r.createdAt)}</td>
      <td>${esc(r.room||"")}</td>
      <td>${esc((r.kind||""))}</td>
      <td>${esc(String(r.machine??""))}</td>
      <td>${esc(r.message||"")}</td>
      <td>${status}</td>
      <td>${r.clearedAt? "" : `<button class="btn btn-xs" data-defect-id="${esc(r.id)}">Freigeben</button>`}</td>
    `;
    tbody.appendChild(tr);
  });
  tbody.querySelectorAll("button[data-defect-id]").forEach(btn=>{
    btn.addEventListener("click", async ()=>{
      const id = btn.getAttribute("data-defect-id");
      await jpost("/api/auth/admin/defects/clear", { id });
      await loadDefects();
    });
  });
  toast(`Defekte geladen: ${(data.rows||[]).length}`);
}
async function loadFeedback(){
  const data = await jpost("/api/auth/admin/feedback/list", {});
  const tbody = document.querySelector("#tblFeedback tbody");
  if(!tbody) return;
  tbody.innerHTML="";
  (data.rows||[]).forEach(r=>{
    const tr=document.createElement("tr");
    tr.innerHTML = `
      <td>${fmtTs(r.createdAt)}</td>
      <td>${esc(r.room||"")}</td>
      <td>${esc(r.message||"")}</td>
    `;
    tbody.appendChild(tr);
  });
  toast(`Feedback geladen: ${(data.rows||[]).length}`);
}
async function loadRooms(){
  const data = await jpost("/api/auth/admin/rooms/list", {});
  const tbody = document.querySelector("#tblRooms tbody");
  if(!tbody) return;
  tbody.innerHTML="";
  (data.rows||[]).forEach(r=>{
    const tr=document.createElement("tr");
    tr.innerHTML = `
      <td>${esc(r.id)}</td>
      <td>${esc(r.name)}</td>
      <td>${r.active? "✅":"—"}</td>
      <td><button class="btn btn-xs" data-room-edit="${esc(r.id)}">Edit</button></td>
    `;
    tbody.appendChild(tr);
  });
  tbody.querySelectorAll("button[data-room-edit]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-room-edit");
      const row = (data.rows||[]).find(x=>x.id===id);
      if(!row) return;
      document.getElementById("roomId").value = row.id;
      document.getElementById("roomName").value = row.name;
      document.getElementById("roomActive").checked = !!row.active;
      toast("Room in Formular übernommen");
    });
  });
  toast(`Rooms geladen: ${(data.rows||[]).length}`);
}
async function saveRoom(){
  const id = (document.getElementById("roomId")?.value||"").trim();
  const name = (document.getElementById("roomName")?.value||"").trim();
  const active = !!document.getElementById("roomActive")?.checked;
  await jpost("/api/auth/admin/rooms/set", { id, name, active });
  await loadRooms();
}

// hook buttons if present
setTimeout(()=>{
  document.getElementById("btnMachinesLoad")?.addEventListener("click", loadMachines);
  document.getElementById("btnDefectsLoad")?.addEventListener("click", loadDefects);
  document.getElementById("btnFeedbackLoad")?.addEventListener("click", loadFeedback);
  document.getElementById("btnRoomsLoad")?.addEventListener("click", loadRooms);
  document.getElementById("btnRoomSave")?.addEventListener("click", saveRoom);
}, 0);

</script>
</body>
</html>
