<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Benutzerverwaltung (Admin-User) – mobile first</title>
<style>
  :root{color-scheme:dark;}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;background:#070b12;color:#e7eefc}
  .wrap{max-width:1100px;margin:0 auto;padding:14px}
  h1{font-size:16px;margin:0 0 10px 0;font-weight:700;opacity:.95}
  .card{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:12px}
  .grid{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:920px){.grid{grid-template-columns:1.2fr .8fr}}
  label{font-size:12px;opacity:.85;display:block;margin-bottom:6px}
  input,select,button,textarea{width:100%;box-sizing:border-box;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.12);color:#e7eefc;border-radius:12px;padding:10px 12px;font-size:14px}
  button{cursor:pointer}
  .btnrow{display:flex;gap:8px;flex-wrap:wrap}
  .btnrow button{width:auto;padding:8px 10px;font-size:12px;border-radius:10px}
  .row{display:grid;grid-template-columns:1fr;gap:10px}
  @media(min-width:720px){.row{grid-template-columns:1fr 1fr 1fr}}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:12px;white-space:pre-wrap;word-break:break-word;background:rgba(0,0,0,.25);border-radius:12px;padding:10px;border:1px solid rgba(255,255,255,.08);max-height:260px;overflow:auto}
  .pill{display:inline-block;padding:4px 8px;border-radius:999px;font-size:11px;border:1px solid rgba(255,255,255,.16);opacity:.9}
  .toast{position:fixed;left:50%;bottom:14px;transform:translateX(-50%);background:rgba(0,0,0,.75);border:1px solid rgba(255,255,255,.16);backdrop-filter:blur(8px);padding:10px 12px;border-radius:12px;max-width:92vw;z-index:9999}
  .tabs{display:flex;gap:8px;overflow:auto;padding:8px 0;margin-bottom:10px}
  .tab{padding:8px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.03);font-size:12px;white-space:nowrap}
  .tab.active{background:rgba(255,255,255,.10)}
  .section{display:none}
  .section.active{display:block}
  .permbar{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px}
  @media(min-width:720px){.permbar{grid-template-columns:220px 1fr 160px}}
  .permList{margin-top:10px;display:grid;gap:10px}
  .group{border:1px solid rgba(255,255,255,.10);border-radius:14px;padding:10px;background:rgba(255,255,255,.02)}
  .group h3{margin:0 0 6px 0;font-size:12px;opacity:.9}
  .permRow{display:grid;grid-template-columns:28px 1fr;gap:10px;align-items:start;padding:8px;border-radius:12px}
  .permRow:hover{background:rgba(255,255,255,.04)}
  .permKey{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;opacity:.92}
  .permTitle{font-size:12px;opacity:.85;margin-top:2px}
  input[type="checkbox"]{width:22px;height:22px;accent-color:#7aa2ff}
  .smallNote{font-size:12px;opacity:.8}
</style>
</head>
<body>
<div class="wrap">
  <h1>Benutzerverwaltung (Admin-User) – mobile first</h1>

  <div class="tabs" id="tabs">
    <button class="tab active" data-tab="users">Benutzer</button>
    <button class="tab" data-tab="rbac">Rollen &amp; Rechte</button>
  </div>

  <div class="grid">
    <div class="card">
      <div class="row">
        <div>
          <label>BASE</label>
          <input id="base" value="https://washportal-dev-worker.schluffi1220.workers.dev"/>
          <div class="smallNote" style="margin-top:6px;opacity:.75">Alle Admin-Funktionen laufen über diese Worker-BASE.</div>
        </div>
        <div>
          <label>Bearer Token (optional)</label>
          <input id="token" placeholder="optional (Admin/PS/SV Token)"/>
          <div class="smallNote" style="margin-top:6px;opacity:.75">Wenn leer, kannst du trotzdem per SA-Header arbeiten.</div>
        </div>
        <div>
          <label>SA Passwort</label>
          <input id="sa" type="password" placeholder="••••••••"/>
          <div class="smallNote" style="margin-top:6px;opacity:.75">Wird per <b>x-sa-password</b> gesendet.</div>
        </div>
      </div>

      <div class="btnrow" style="margin-top:10px">
        <button id="btnStatus">/api/_status</button>
        <button id="btnMe">/api/auth/me</button>
        <button id="btnSa">SA-Login</button>
        <button id="btnUsers">Benutzer laden</button>
        <button id="btnSnap">RBAC laden</button>
      </div>

      <div style="margin-top:10px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <span class="pill" id="pillBuild">build: –</span>
        <span class="pill" id="pillAuth">auth: –</span>
      </div>

      <div class="mono" id="out" style="margin-top:10px">{}</div>
    </div>

    <div class="card" id="hintCard">
      <b>Hinweise</b>
      <ul style="margin:8px 0 0 18px;opacity:.9;font-size:12px;line-height:1.45">
        <li><b>PS &amp; SV nur einmal:</b> Erzwingt der Worker beim Rollen setzen (PS→SV→User).</li>
        <li><b>Rechte:</b> Im Tab <b>Rollen &amp; Rechte</b> kannst du RolePerms pro Rolle setzen (SA empfohlen).</li>
        <li><b>Mobile:</b> 1-Spalte, große Checkboxen, scrollbare Gruppen.</li>
      </ul>
    </div>
  </div>

  <div class="card section active" id="sec-users" style="margin-top:12px">
    <b>Benutzer</b>
    <div class="smallNote" style="margin-top:6px">Rollen ändern: Dropdown pro User → Speichern.</div>
    <div id="usersList" style="margin-top:10px;display:grid;gap:10px"></div>
  </div>

  <div class="card section" id="sec-rbac" style="margin-top:12px">
    <b>Rollen &amp; Rechte (RBAC)</b>
    <div class="smallNote" style="margin-top:6px">RBAC laden → Rolle wählen → Häkchen setzen → Speichern.</div>

    <div class="permbar">
      <div>
        <label>Rolle</label>
        <select id="roleSel">
          <option value="admin">Admin</option>
          <option value="ps">PS</option>
          <option value="sv">SV</option>
          <option value="user">User</option>
          <option value="sa">SA</option>
          <option value="vs">VS</option>
        </select>
      </div>
      <div>
        <label>Permission suchen</label>
        <input id="permSearch" placeholder="z.B. bookings, logs, delete"/>
      </div>
      <div style="display:flex;gap:8px;align-items:end">
        <button id="btnSnap2">RBAC laden</button>
        <button id="btnSaveRole">Speichern</button>
      </div>
    </div>

    <div id="rbacMeta" class="smallNote" style="margin-top:10px;opacity:.85"></div>
    <div id="permList" class="permList"></div>
    <div id="permEmpty" class="smallNote" style="margin-top:8px;opacity:.75;display:none">Keine Rechte gefunden (Filter?)</div>
  </div>
</div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const state = {
    me: null,
    snapshot: null,
    catalog: [],
    rolePerms: {},
    currentRole: "admin",
    roleDraft: {}, // permKey -> bool
    users: []
  };

  function toast(msg){
    const el=document.createElement('div');
    el.className='toast';
    el.textContent=msg;
    document.body.appendChild(el);
    setTimeout(()=>{el.remove();}, 2600);
  }

  function base(){ return ($('base').value||"").trim().replace(/\/+$/,''); }

  function headers(){
    const h = {'content-type':'application/json'};
    const t = ($('token').value||"").trim();
    const sa = ($('sa').value||"").trim();
    // only set Authorization if it looks like a token (JWT has dots)
    if(t && (t.includes('.') || t.length>40)) h['authorization'] = 'Bearer ' + t;
    if(sa) h['x-sa-password'] = sa;
    return h;
  }

  async function api(path, opts={}){
    const url = base()+path;
    const res = await fetch(url, {
      method: opts.method || 'POST',
      headers: {...headers(), ...(opts.headers||{})},
      body: opts.body === undefined ? undefined : (typeof opts.body==='string'? opts.body : JSON.stringify(opts.body))
    });
    const txt = await res.text();
    let json;
    try{ json = JSON.parse(txt); }catch{ json = {raw: txt}; }
    if(!res.ok){
      throw new Error((json && json.data && json.data.message) || (json && json.message) || ('HTTP '+res.status));
    }
    return json;
  }

  function setOut(obj){
    $('out').textContent = JSON.stringify(obj, null, 2);
    const build = obj?.build || obj?.data?.build || state.snapshot?.build || "–";
    $('pillBuild').textContent = 'build: ' + build;
  }

  function setAuth(ok){
    $('pillAuth').textContent = 'auth: ' + (ok ? 'ok' : '–');
  }

  function normalizeCatalog(snap){
    const c = snap.catalog || snap.permCatalog || snap.permsCatalog || [];
    // normalize to {permKey,title,permGroup,sort}
    return c.map(p=>({
      permKey: p.permKey || p.key || p.name || p.id,
      title: p.title || p.label || p.description || '',
      permGroup: p.permGroup || p.group || 'Sonstiges',
      sort: (p.sort===0 || p.sort) ? p.sort : 999
    })).filter(p=>!!p.permKey);
  }

  function normalizeRolePerms(snap){
    if(snap.rolePerms && !Array.isArray(snap.rolePerms)) return snap.rolePerms;
    // build from rows
    const rows = snap.rolePermsRows || [];
    const m = {};
    for(const r of rows){
      const role = r.role;
      if(!m[role]) m[role] = {};
      m[role][r.permKey] = !!r.allowed;
    }
    return m;
  }

  function renderUsers(){
    const host = $('usersList');
    host.innerHTML = '';
    for(const u of state.users){
      const card = document.createElement('div');
      card.className = 'group';
      card.innerHTML = `
        <div style="display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap">
          <div>
            <div style="font-weight:700">${escapeHtml(u.firstName||'')} ${escapeHtml(u.lastName||'')}</div>
            <div class="smallNote">${escapeHtml(u.email||'')}</div>
            <div class="smallNote">Status: ${escapeHtml(u.status||'')}</div>
          </div>
          <div style="min-width:220px;display:grid;gap:8px">
            <select data-user="${escapeAttr(u.id)}" class="rolePick">
              ${roleOption(u.role)}
            </select>
            <button data-user="${escapeAttr(u.id)}" class="saveRoleBtn">Rolle speichern</button>
          </div>
        </div>
      `;
      host.appendChild(card);
    }
    host.querySelectorAll('.saveRoleBtn').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const userId = btn.getAttribute('data-user');
        const sel = host.querySelector(`select.rolePick[data-user="${cssEscape(userId)}"]`);
        const role = sel.value;
        try{
          const j = await api('/api/auth/admin/users/set-role', {body:{userId, role}});
          setOut(j);
          toast('Rolle gespeichert');
          await loadUsers();
        }catch(e){ toast('Fehler: '+e.message); }
      });
    });
  }

  function roleOption(current){
    const roles = [
      ['user','User'],
      ['ps','PS'],
      ['ps_deputy','SV'],
      ['admin','Admin'],
      ['super_admin','SA'],
      ['superadmin','SA']
    ];
    return roles.map(([v,label])=>`<option value="${v}" ${v===current?'selected':''}>${label}</option>`).join('');
  }

  function cssEscape(s){ return s.replace(/"/g,'\\"'); }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }
  function escapeAttr(s){ return escapeHtml(s); }

  function buildDraftForRole(roleKey){
    const perms = state.rolePerms[roleKey] || {};
    const d = {};
    for(const p of state.catalog){
      d[p.permKey] = !!perms[p.permKey];
    }
    state.roleDraft = d;
  }

  function renderPerms(){
    const role = state.currentRole;
    const filter = ($('permSearch').value||'').trim().toLowerCase();
    const list = $('permList');
    list.innerHTML = '';
    $('permEmpty').style.display = 'none';

    // group + sort
    const groups = new Map();
    for(const p of state.catalog){
      if(filter){
        const hay = (p.permKey+' '+p.title+' '+p.permGroup).toLowerCase();
        if(!hay.includes(filter)) continue;
      }
      if(!groups.has(p.permGroup)) groups.set(p.permGroup, []);
      groups.get(p.permGroup).push(p);
    }
    const groupNames = Array.from(groups.keys()).sort((a,b)=>a.localeCompare(b,'de'));
    let rendered = 0;

    for(const g of groupNames){
      const items = groups.get(g).sort((a,b)=>(a.sort-b.sort) || a.permKey.localeCompare(b.permKey));
      const box = document.createElement('div');
      box.className = 'group';
      box.innerHTML = `<h3>${escapeHtml(g)}</h3>`;
      for(const p of items){
        const row = document.createElement('div');
        row.className = 'permRow';
        const checked = !!state.roleDraft[p.permKey];
        row.innerHTML = `
          <div><input type="checkbox" data-perm="${escapeAttr(p.permKey)}" ${checked?'checked':''}></div>
          <div>
            <div class="permKey">${escapeHtml(p.permKey)}</div>
            <div class="permTitle">${escapeHtml(p.title || '')}</div>
          </div>
        `;
        box.appendChild(row);
        rendered++;
      }
      list.appendChild(box);
    }

    if(rendered===0){
      $('permEmpty').style.display = 'block';
    }

    list.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
      cb.addEventListener('change', ()=>{
        const k = cb.getAttribute('data-perm');
        state.roleDraft[k] = cb.checked;
      });
    });

    const total = state.catalog.length;
    $('rbacMeta').textContent = `Rolle: ${role} • Permissions: ${total} • angezeigt: ${rendered}`;
  }

  async function loadStatus(){
    try{
      const j = await api('/api/_status', {method:'GET'});
      setOut(j);
      toast('Status ok');
    }catch(e){ toast('Status Fehler: '+e.message); }
  }

  async function loadMe(){
    try{
      const j = await api('/api/auth/me', {method:'GET'});
      state.me = j;
      setOut(j);
      setAuth(true);
      toast('auth ok');
    }catch(e){
      setAuth(false);
      toast('auth Fehler: '+e.message);
    }
  }

  async function saLogin(){
    // SA-Login is basically /me with x-sa-password
    await loadMe();
  }

  async function loadUsers(){
    try{
      const j = await api('/api/auth/admin/users/list', {body:{}});
      state.users = j.users || j.data?.users || [];
      setOut(j);
      toast(`Benutzer: ${state.users.length}`);
      renderUsers();
    }catch(e){ toast('Users Fehler: '+e.message); }
  }

  async function loadSnapshot(){
    try{
      const j = await api('/api/auth/admin/rbac/snapshot', {body:{}});
      state.snapshot = j;
      state.catalog = normalizeCatalog(j);
      state.rolePerms = normalizeRolePerms(j);
      setOut(j);
      toast(`${state.catalog.length} Rechte geladen`);
      // keep current role
      buildDraftForRole(state.currentRole);
      renderPerms();
    }catch(e){ toast('RBAC Fehler: '+e.message); }
  }

  async function saveRolePerms(){
    try{
      const role = state.currentRole;
      // send only allowed=true entries to keep DB small
      const allowed = Object.entries(state.roleDraft).filter(([,v])=>!!v).map(([k])=>k);
      const j = await api('/api/auth/admin/rbac/role/set', {body:{role, allowed}});
      setOut(j);
      toast('Rechte gespeichert');
      await loadSnapshot();
    }catch(e){ toast('Speichern Fehler: '+e.message); }
  }

  // Tabs
  function setTab(tab){
    document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active', t.dataset.tab===tab));
    $('sec-users').classList.toggle('active', tab==='users');
    $('sec-rbac').classList.toggle('active', tab==='rbac');
  }
  document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click', ()=>setTab(t.dataset.tab)));

  // Events
  $('btnStatus').addEventListener('click', loadStatus);
  $('btnMe').addEventListener('click', loadMe);
  $('btnSa').addEventListener('click', saLogin);
  $('btnUsers').addEventListener('click', loadUsers);
  $('btnSnap').addEventListener('click', ()=>{ setTab('rbac'); loadSnapshot(); });
  $('btnSnap2').addEventListener('click', loadSnapshot);
  $('btnSaveRole').addEventListener('click', saveRolePerms);

  $('roleSel').addEventListener('change', ()=>{
    state.currentRole = $('roleSel').value; // IMPORTANT: values are lowercase keys
    buildDraftForRole(state.currentRole);
    renderPerms();
  });
  $('permSearch').addEventListener('input', ()=>renderPerms());
  $('sa').addEventListener('keydown', (e)=>{ if(e.key==='Enter') saLogin(); });

  // init
  state.currentRole = $('roleSel').value;
})();
</script>
</body>
</html>
