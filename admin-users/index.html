<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Washportal Admin</title>
<style>
  :root{--bg:#0b1220;--card:#0f1a2e;--muted:#9fb0cc;--text:#e8f0ff;--line:rgba(255,255,255,.08);
        --btn:#2b6cff;--btn2:#21c37a;--danger:#ff4d4d;}
  *{box-sizing:border-box;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
  body{margin:0;background:linear-gradient(180deg,#071021,#0b1220);color:var(--text);}
  .wrap{max-width:1100px;margin:24px auto;padding:0 16px;}
  .top{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:rgba(255,255,255,.03);color:var(--text)}
  .field{flex:1;min-width:240px}
  .btn{padding:10px 14px;border-radius:12px;border:1px solid var(--line);background:var(--btn);color:white;cursor:pointer;font-weight:600}
  .btn.secondary{background:rgba(255,255,255,.06)}
  .btn.good{background:var(--btn2)}
  .btn.danger{background:rgba(255,77,77,.15);color:#ffd0d0}
  .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
  .card{background:rgba(255,255,255,.03);border:1px solid var(--line);border-radius:16px;padding:14px;margin-top:14px}
  .msg{margin-top:10px;color:var(--muted);white-space:pre-wrap}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left;font-size:14px}
  select{padding:8px 10px;border-radius:10px;border:1px solid var(--line);background:rgba(255,255,255,.03);color:var(--text)}
  .small{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <h1 style="margin:0 0 10px 0;font-size:20px;">Admin</h1>
  <div class="top card">
    <div class="field">
      <label>Worker Base URL (.workers.dev)</label>
      <input id="worker" placeholder="https://washportal-dev-worker.schluffi1220.workers.dev"/>
      <div class="small">Wird lokal gespeichert. Keine .workers.de / .worker.de.</div>
    </div>
    <div class="field">
      <label>SA Password (optional)</label>
      <input id="sa" type="password" placeholder="x-sa-password"/>
      <div class="small">Wenn gesetzt, nutzt Admin SA-Header (ohne Login-Token).</div>
    </div>
    <div class="field">
      <label>Bearer Token (optional)</label>
      <input id="token" type="password" placeholder="wird nach Login gesetzt"/>
      <div class="small">Oder per /api/ps/login aus früheren Versionen.</div>
    </div>
    <div class="row">
      <button class="btn secondary" id="save">Speichern</button>
      <button class="btn" id="me">/api/auth/me</button>
      <button class="btn good" id="load">Users laden</button>
      <button class="btn secondary" id="snap">RBAC Snapshot</button>
    </div>
    <div id="msg" class="msg"></div>
  </div>

  <div class="card">
    <h2 style="margin:0;font-size:16px;">Users</h2>
    <div class="small">Rollenliste kommt aus der DB (Snapshot). Du kannst Rollen setzen, auch als SA.</div>
    <div id="users"></div>
  </div>
</div>

<script>
const $ = (id)=>document.getElementById(id);
const LS = {
  get:(k,d="")=>{try{return localStorage.getItem(k)??d}catch{return d}},
  set:(k,v)=>{try{localStorage.setItem(k,v)}catch{}}
};
function normBase(u){
  u = String(u||"").trim();
  if(!u) return "";
  u = u.replace(/\/+$/,"");
  return u;
}
function assertWorkersDev(base){
  if(!base) return "Worker URL fehlt";
  try{
    const u=new URL(base);
    if(!u.hostname.endsWith(".workers.dev")) return "Worker URL muss auf .workers.dev enden";
  }catch(e){ return "Worker URL ungültig"; }
  return "";
}
function headers(){
  const h={"Content-Type":"application/json"};
  const sa = $("sa").value.trim();
  const tok = $("token").value.trim();
  if(sa) h["X-SA-Password"]=sa;
  else if(tok) h["Authorization"]="Bearer "+tok;
  return h;
}
async function j(method,path,body){
  const base = normBase($("worker").value);
  const err = assertWorkersDev(base);
  if(err) throw new Error(err);
  const url = base + path;
  const opt={method,headers:headers()};
  if(body!==undefined) opt.body=JSON.stringify(body);
  const res = await fetch(url,opt);
  const txt = await res.text();
  let data; try{data=JSON.parse(txt)}catch{data={ok:false,error:"non_json",status:res.status,text:txt.slice(0,500)}}
  if(!res.ok || data?.ok===false) {
    const m = data?.message || data?.error || res.statusText;
    throw new Error(`${res.status} ${m}`);
  }
  return data;
}
function setMsg(s){ $("msg").textContent = s || ""; }
let roleOptions = [];
function roleSelect(current){
  const sel=document.createElement("select");
  for(const r of roleOptions){
    const o=document.createElement("option");
    o.value=r; o.textContent=r;
    if(String(current||"")===r) o.selected=true;
    sel.appendChild(o);
  }
  // If current role not in options, include it
  if(current && !roleOptions.includes(current)){
    const o=document.createElement("option");
    o.value=current; o.textContent=current+" (db)";
    o.selected=true;
    sel.insertBefore(o, sel.firstChild);
  }
  return sel;
}
async function loadSnapshot(){
  const snap = await j("POST","/api/auth/admin/rbac/snapshot",{});
  // Worker returns roles array or rolesFromUsers etc; be tolerant
  const roles = snap.roles || snap?.data?.roles || snap?.rolesAll || [];
  if(Array.isArray(roles) && roles.length){
    roleOptions = roles.map(x=>String(x)).filter(Boolean);
  } else if (Array.isArray(snap?.rolesFromUsers?.results)){
    roleOptions = snap.rolesFromUsers.results.map(r=>String(r.role||"")).filter(Boolean);
  } else {
    roleOptions = [];
  }
  setMsg(`RBAC Snapshot ok. Rollen: ${roleOptions.join(", ") || "(keine gefunden)"}`);
}
async function loadUsers(){
  if(!roleOptions.length) await loadSnapshot().catch(()=>{});
  const out = await j("POST","/api/auth/admin/users/list",{});
  const users = out.users || out.results || out?.data?.users || [];
  const div=$("users"); div.innerHTML="";
  if(!users.length){ div.innerHTML="<div class='small'>Keine Users gefunden.</div>"; return; }
  const table=document.createElement("table");
  table.innerHTML="<thead><tr><th>Email</th><th>Status</th><th>Rolle</th><th>Aktion</th></tr></thead>";
  const tb=document.createElement("tbody");
  for(const u of users){
    const tr=document.createElement("tr");
    const email=String(u.email||"");
    const status=String(u.status||"");
    const role=String(u.role||"");
    const id=String(u.id||u.userId||"");
    tr.innerHTML=`<td>${email}</td><td>${status}</td><td></td><td></td>`;
    const sel = roleSelect(role);
    tr.children[2].appendChild(sel);
    const btn=document.createElement("button");
    btn.className="btn secondary";
    btn.textContent="Rolle setzen";
    btn.onclick=async()=>{
      try{
        await j("POST","/api/auth/admin/users/set-role",{userId:id, role:sel.value});
        setMsg(`Rolle gesetzt: ${email} → ${sel.value}`);
        await loadUsers();
      }catch(e){ setMsg("Fehler: "+e.message); }
    };
    tr.children[3].appendChild(btn);
    tb.appendChild(tr);
  }
  table.appendChild(tb);
  div.appendChild(table);
}
function loadSaved(){
  $("worker").value = LS.get("wp_admin_worker","https://washportal-dev-worker.schluffi1220.workers.dev");
  $("sa").value = LS.get("wp_admin_sa","");
  $("token").value = LS.get("wp_admin_token","");
}
function save(){
  const base = normBase($("worker").value);
  const err = assertWorkersDev(base);
  if(err){ setMsg(err); return; }
  LS.set("wp_admin_worker",base);
  LS.set("wp_admin_sa",$("sa").value.trim());
  LS.set("wp_admin_token",$("token").value.trim());
  setMsg("Gespeichert.");
}
document.addEventListener("DOMContentLoaded", ()=>{
  loadSaved();
  $("save").onclick=save;
  $("snap").onclick=()=>loadSnapshot().catch(e=>setMsg("Fehler: "+e.message));
  $("load").onclick=()=>loadUsers().catch(e=>setMsg("Fehler: "+e.message));
  $("me").onclick=async()=>{
    try{
      const me = await j("GET","/api/auth/me");
      setMsg("ME: "+JSON.stringify(me,null,2));
    }catch(e){ setMsg("Fehler: "+e.message); }
  };
  // autosave on change
  ["worker","sa","token"].forEach(id=>{
    $(id).addEventListener("change", save);
    $(id).addEventListener("blur", save);
  });
});
</script>
</body>
</html>
