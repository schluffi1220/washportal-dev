<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Washportal – Benutzerverwaltung & RBAC (Admin/SA)</title>
<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:16px;background:#0b0f14;color:#e7eef7}
input,select,button,textarea{font:inherit;padding:10px;border-radius:10px;border:1px solid #223042;background:#0f1621;color:#e7eef7}
button{cursor:pointer}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.card{border:1px solid #223042;border-radius:14px;padding:12px;margin:12px 0;background:#0f1621}
h1{font-size:18px;margin:0 0 8px 0}
h2{font-size:15px;margin:0 0 8px 0}
.small{opacity:.8;font-size:12px}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:12px}
.bad{color:#ff7b7b}
.ok{color:#7bff9d}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid #223042;text-align:left;vertical-align:top}
code{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:12px}
.pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #223042;font-size:12px;opacity:.95}
.pill.ps{border-color:#4a7bd8}
.pill.sv{border-color:#7a60ff}
.pill.admin{border-color:#ffbf60}
.pill.user{border-color:#4bd38a}
.pill.sa{border-color:#ff6bd6}
hr{border:none;border-top:1px solid #223042;margin:12px 0}

  .permList{ margin-top:12px; display:grid; gap:10px; }
  .permGroup{ border:1px solid #e5e7eb; border-radius:14px; padding:10px; background:#fff; }
  .permGroup h3{ margin:0 0 8px 0; font-size:14px; }
  .permItem{ display:flex; align-items:flex-start; gap:10px; padding:8px; border-radius:12px; }
  .permItem:hover{ background:#f8fafc; }
  .permItem input{ margin-top:3px; transform:scale(1.1); }
  .permMeta{ display:flex; flex-direction:column; gap:2px; }
  .permKey{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px; color:#475569;}
  .permTitle{ font-size:13px; }

</style>
</head>
<body>
  <h1>Benutzerverwaltung (primär Admin-User)</h1>
  <div class="small">
    Nutzt deine BASE (Cloudflare Worker). Admin/PS/SV arbeiten über <b>Bearer Token</b>, SA zusätzlich über <b>x-sa-password</b>.
  </div>

  <div class="card">
    <h2>Verbindung</h2>
    <div class="row">
      <label class="small">BASE<br/>
        <input id="base" style="min-width:360px" value="https://washportal-dev-worker.schluffi1220.workers.dev"/>
      </label>
      <label class="small">Bearer Token (Admin/PS/SV/SA)<br/>
        <input id="token" style="min-width:360px" placeholder="Bearer Token (optional)"/>
      </label>
      <label class="small">SA Passwort (optional)<br/>
        <input id="sa" type="password" style="min-width:240px" placeholder="x-sa-password"/>
      </label>
    </div>
    <div class="row">
      <button id="btnStatus">/api/_status</button>
      <button id="btnMe">/api/auth/me</button>
      <button class="btn" id="btnSaLogin">SA-Login</button>
      <button id="btnUsers">Benutzer laden</button>
      <span id="statusOut" class="small"></span>
    </div>
    <pre id="meOut" class="small" style="white-space:pre-wrap;margin:10px 0 0 0"></pre>
  </div>

  <div class="grid">
    <div class="card">
      <h2>Benutzer</h2>
      <div class="row">
        <label class="small">Filter (E-Mail / Name / Rolle)<br/>
          <input id="filter" placeholder="z.B. 203, müller, ps, admin…" style="min-width:320px"/>
        </label>
        <button id="btnApplyFilter">Filter</button>
      </div>

      <div class="small" id="usersHint">Noch nicht geladen.</div>
      <div style="overflow:auto;max-height:60vh;margin-top:8px">
        <table id="usersTbl">
          <thead>
            <tr>
              <th>E-Mail</th>
              <th>Name</th>
              <th>Rolle</th>
              <th>Status</th>
              <th>Aktion</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="small" id="usersOut"></div>
    </div>

    <div class="card">
      <h2>Hinweise zur Rechte-Logik</h2>
      <ul class="small">
        <li><b>Admin</b>: kann Rollen setzen (User/Admin/PS/SV) – wie gefordert.</li>
        <li><b>PS/SV</b>: sollen primär nur Übergabe sehen (dein Worker hat die Transfer-Logik in <code>/api/auth/admin/users/set-role</code> integriert).</li>
        <li><b>SA</b>: kann zusätzlich RBAC-Katalog & direkte Perms pflegen (separates RBAC-Tool empfehlenswert).</li>
      </ul>
      <hr/>
      <div class="small">
        Rollen-Mapping:
        <ul>
          <li><code>admin</code> = Admin</li>
          <li><code>ps</code> = PS</li>
          <li><code>ps_deputy</code> = SV</li>
          <li><code>user</code> = User</li>
          <li><code>super_admin</code>/<code>superadmin</code> = SA</li>
        </ul>
      </div>
      <pre id="debug" class="small" style="white-space:pre-wrap"></pre>
    </div>
  </div>

<script>
const $ = (id)=>document.getElementById(id);

function baseUrl(){
  return ($("base").value || "").replace(/\/$/,'');
}
function headersJson(){
  const h = {"content-type":"application/json"};
  const t = ($("token").value || "").trim();
  const sa = ($("sa").value || "").trim();
  if(t){
    const raw = t.trim();
    const looksJwt = (raw.split(".").length >= 3) && raw.length > 20;
    if(looksJwt){
      h["authorization"] = raw.toLowerCase().startsWith("bearer ") ? raw : ("Bearer " + raw);
    }
  }
  if(sa) h["x-sa-password"] = sa;
  return h;
}
async function jget(path){
  const res = await fetch(baseUrl()+path, {method:"GET", headers: headersJson()});
  const txt = await res.text();
  let data; try{ data = JSON.parse(txt);}catch(e){ data={ok:false,error:"bad_json",raw:txt}; }
  if(!res.ok) throw {status:res.status, data};
  return data;
}
async function jpost(path, body){
  const res = await fetch(baseUrl()+path, {method:"POST", headers: headersJson(), body: JSON.stringify(body||{})});
  const txt = await res.text();
  let data; try{ data = JSON.parse(txt);}catch(e){ data={ok:false,error:"bad_json",raw:txt}; }
  if(!res.ok) throw {status:res.status, data};
  return data;
}

function roleLabel(role){
  role = String(role||"").toLowerCase();
  if(role==="ps") return ["PS","ps"];
  if(role==="ps_deputy") return ["SV","sv"];
  if(role==="admin") return ["Admin","admin"];
  if(role==="user" || !role) return ["User","user"];
  if(role==="super_admin" || role==="superadmin") return ["SA","sa"];
  return [role, "user"];
}
function pill(role){
  const [lbl, cls] = roleLabel(role);
  return `<span class="pill ${cls}">${lbl}</span>`;
}

let USERS = [];
let ME = null;

function canSeeActions(){
  const r = String(ME?.user?.role||"").toLowerCase();
  // SA/Admin/PS/SV may open the page; but only Admin/SA should be able to change roles here.
  return ["admin","super_admin","superadmin"].includes(r);
}

function renderUsers(){
  const q = ($("filter").value||"").trim().toLowerCase();
  const tbody = $("usersTbl").querySelector("tbody");
  tbody.innerHTML = "";

  const filtered = (USERS||[]).filter(u=>{
    if(!q) return true;
    const s = [
      u.email, u.firstName, u.lastName, u.role, u.role2, u.status
    ].map(x=>String(x||"").toLowerCase()).join(" ");
    return s.includes(q);
  });

  $("usersHint").textContent = `Geladen: ${USERS.length} • angezeigt: ${filtered.length}`;

  const allowActions = canSeeActions();

  for(const u of filtered){
    const tr = document.createElement("tr");
    const name = [u.firstName,u.lastName].filter(Boolean).join(" ").trim();
    tr.innerHTML = `
      <td><code>${(u.email||"")}</code></td>
      <td>${name || "<span class='small'>(ohne Name)</span>"}</td>
      <td>${pill(u.role)} ${u.role2?("<span class='small'>+ "+pill(u.role2)+"</span>"):""}</td>
      <td>${u.status || ""}</td>
      <td></td>
    `;

    const td = tr.querySelector("td:last-child");

    if(allowActions){
      const sel = document.createElement("select");
      sel.innerHTML = `
        <option value="">Rolle setzen…</option>
        <option value="user">User</option>
        <option value="admin">Admin</option>
        <option value="ps">PS</option>
        <option value="ps_deputy">SV</option>
      `;
      const btn = document.createElement("button");
      btn.textContent = "Speichern";
      btn.onclick = async ()=>{
        const role = sel.value;
        if(!role) return;
        if(!confirm(`Rolle von ${u.email} wirklich auf "${role}" setzen?`)) return;
        td.querySelectorAll("button,select").forEach(x=>x.disabled=true);
        try{
          const out = await jpost("/api/auth/admin/users/set-role", { userId: u.id, role });
          $("usersOut").innerHTML = `<span class="ok">OK</span> • build ${out.build||""}`;
          await loadUsers(false);
        }catch(e){
          $("usersOut").innerHTML = `<span class="bad">FEHLER</span> • ` + (e?.data?.message||e?.data?.error||e?.status||"unknown");
          $("debug").textContent = JSON.stringify(e, null, 2);
        }finally{
          td.querySelectorAll("button,select").forEach(x=>x.disabled=false);
        }
      };

      td.appendChild(sel);
      td.appendChild(document.createTextNode(" "));
      td.appendChild(btn);
    }else{
      td.innerHTML = `<span class="small">Keine Admin-Rechte für Rollenänderung.</span>`;
    }

    tbody.appendChild(tr);
  }
}

async function loadMe(){
  $("meOut").textContent = "…";
  try{
    ME = await jget("/api/auth/me");
    $("meOut").textContent = JSON.stringify(ME, null, 2);
  }catch(e){
    $("meOut").textContent = JSON.stringify(e, null, 2);
    ME = null;
  }
}

async function loadUsers(render=true){
  $("usersOut").textContent = "";
  try{
    const out = await jpost("/api/auth/admin/users/list", {});
    USERS = out.users || [];
    if(render) renderUsers();
  }catch(e){
    $("usersOut").innerHTML = `<span class="bad">FEHLER</span> • ` + (e?.data?.message||e?.data?.error||e?.status||"unknown");
    $("debug").textContent = JSON.stringify(e, null, 2);
  }
}

$("btnStatus").onclick = async ()=>{
  $("statusOut").textContent="…";
  try{
    const out = await jget("/api/_status?ts="+Date.now());
    $("statusOut").innerHTML = (out.ok?'<span class="ok">OK</span>':'<span class="bad">FEHLER</span>') + " • build " + (out.build||"");
  }catch(e){
    $("statusOut").innerHTML = '<span class="bad">FEHLER</span> • ' + (e?.data?.message||e?.data?.error||e?.status||String(e));
  }
};

$("btnMe").onclick = loadMe;

$("btnUsers").onclick = async ()=>{
  await loadMe();
  await loadUsers(true);
};

$("btnApplyFilter").onclick = renderUsers;
$("filter").addEventListener("keydown",(ev)=>{ if(ev.key==="Enter") renderUsers(); });

  const btnSaLogin = document.getElementById('btnSaLogin');
  if (btnSaLogin){
    btnSaLogin.addEventListener('click', async () => {
      // SA login is "stateless": we just test that the SA header works.
      await loadMe();
      toast('SA-Login geprüft (siehe Ausgabe).');
    });
  }

  // Allow Enter to trigger SA-Login check
  const saInput = document.getElementById('saPw');
  if (saInput){
    saInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        btnSaLogin?.click();
      }
    });
  }


// -----------------------------
// RBAC Editor (Role Perms)
// -----------------------------
let _rbacSnapshot = null;

function groupCatalogRows(rows){
  const groups = new Map();
  for (const r of (rows||[])){
    const g = (r.permGroup || "Sonstiges").toString();
    if (!groups.has(g)) groups.set(g, []);
    groups.get(g).push(r);
  }
  // sort by group then sort index
  for (const [g, arr] of groups){
    arr.sort((a,b)=> (Number(a.sort||0) - Number(b.sort||0)) || String(a.permKey).localeCompare(String(b.permKey)));
  }
  return Array.from(groups.entries()).sort((a,b)=> a[0].localeCompare(b[0]));
}

function getRoleAllowedSet(role){
  const set = new Set();
  const list = (_rbacSnapshot?.rolePerms || []).filter(x => String(x.role||"") === role && Number(x.allowed||0) === 1);
  for (const it of list) set.add(String(it.permKey||""));
  return set;
}

function renderRolePerms(){
  const role = document.getElementById("roleSelect").value;
  const q = (document.getElementById("permSearch").value || "").trim().toLowerCase();
  const catalog = _rbacSnapshot?.permsCatalog || [];
  const allowed = getRoleAllowedSet(role);

  const permList = document.getElementById("permList");
  permList.innerHTML = "";

  if (!catalog.length){
    permList.innerHTML = '<div class="muted">Noch kein RBAC geladen. Klicke „RBAC laden“.</div>';
    return;
  }

  const grouped = groupCatalogRows(catalog);
  let shown = 0;

  for (const [groupName, rows] of grouped){
    const groupWrap = document.createElement("div");
    groupWrap.className = "permGroup";

    const h = document.createElement("h3");
    h.textContent = groupName;
    groupWrap.appendChild(h);

    let anyInGroup = false;

    for (const r of rows){
      const key = String(r.permKey||"");
      const title = String(r.title||"");
      const hay = (key + " " + title + " " + groupName).toLowerCase();
      if (q && !hay.includes(q)) continue;

      anyInGroup = true;
      shown++;

      const item = document.createElement("label");
      item.className = "permItem";

      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.dataset.permKey = key;
      cb.checked = allowed.has(key);

      const meta = document.createElement("div");
      meta.className = "permMeta";

      const t = document.createElement("div");
      t.className = "permTitle";
      t.textContent = title || key;

      const k = document.createElement("div");
      k.className = "permKey";
      k.textContent = key;

      meta.appendChild(t);
      meta.appendChild(k);

      item.appendChild(cb);
      item.appendChild(meta);

      groupWrap.appendChild(item);
    }

    if (anyInGroup) permList.appendChild(groupWrap);
  }

  document.getElementById("rbacHint").textContent =
    shown ? `Anzeige: ${shown} Berechtigungen (Rolle: ${role})` : `Keine Treffer für „${q}“.`;
}

async function loadRbacSnapshot(){
  const res = await api("/api/auth/admin/rbac/snapshot", {}, "POST");
  if (!res.ok) throw new Error(res.message || res.error || "rbac_snapshot_failed");
  _rbacSnapshot = res;
  renderRolePerms();
}

async function saveRolePerms(){
  if (!_rbacSnapshot) await loadRbacSnapshot();
  const role = document.getElementById("roleSelect").value;

  const keys = [];
  document.querySelectorAll('#permList input[type="checkbox"][data-perm-key]').forEach(cb=>{
    if (cb.checked) keys.push(cb.dataset.permKey);
  });

  const res = await api("/api/auth/admin/rbac/role/set", { role, permKeys: keys }, "POST");
  if (!res.ok) throw new Error(res.message || res.error || "role_set_failed");

  // reload snapshot to reflect changes
  await loadRbacSnapshot();
}

document.getElementById("btnLoadRbac")?.addEventListener("click", async ()=>{
  try { setMsg("RBAC wird geladen…"); await loadRbacSnapshot(); setMsg("RBAC geladen."); }
  catch(e){ setErr(String(e.message||e)); }
});

document.getElementById("btnSaveRolePerms")?.addEventListener("click", async ()=>{
  try { setMsg("Speichere Rechte…"); await saveRolePerms(); setMsg("Rechte gespeichert."); }
  catch(e){ setErr(String(e.message||e)); }
});

document.getElementById("btnResetView")?.addEventListener("click", ()=>{
  document.getElementById("permSearch").value = "";
  renderRolePerms();
});

document.getElementById("roleSelect")?.addEventListener("change", renderRolePerms);
document.getElementById("permSearch")?.addEventListener("input", ()=>{ 
  // debounce light
  window.clearTimeout(window.__permT);
  window.__permT = window.setTimeout(renderRolePerms, 120);
});

</script>
</body>
</html>
