<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Benutzerverwaltung</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial; margin:18px; color:#eaeaea; background:#111316;}
    a{color:inherit}
    input,select,button{padding:9px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.06);color:#eaeaea}
    button{cursor:pointer}
    button:disabled{opacity:.5; cursor:not-allowed}
    .muted{opacity:.8}
    .top{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .card{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);border-radius:16px;padding:14px;margin:12px 0}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,.08);text-align:left;vertical-align:top}
    .badge{padding:2px 8px;border-radius:999px;font-size:12px}
    .b-active{background:rgba(0,255,0,.14)}
    .b-pending{background:rgba(255,200,0,.16)}
    .b-disabled{background:rgba(255,0,0,.14)}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .rowbtns{display:flex;gap:8px;flex-wrap:wrap}
    .primary{background:#2d7ef7;border-color:#2d7ef7;color:#fff}
    .permgrid{display:grid;grid-template-columns:1fr;gap:6px}
    @media (min-width:900px){.permgrid{grid-template-columns:1fr 1fr}}
    .perm{display:flex;gap:10px;align-items:flex-start;padding:6px;border:1px solid rgba(255,255,255,.08);border-radius:12px}
    .perm input{margin-top:3px}
    .details{background:rgba(255,255,255,.04);padding:10px;border-radius:14px;border:1px dashed rgba(255,255,255,.14)}
  
    .primary{background:#2d7ef7;border-color:#2d7ef7;color:#fff}
    .permgrid{display:grid;grid-template-columns:1fr;gap:6px}
    @media (min-width:900px){.permgrid{grid-template-columns:1fr 1fr}}
    .perm{display:flex;gap:10px;align-items:flex-start;padding:6px;border:1px solid rgba(255,255,255,.08);border-radius:12px}
    .perm input{margin-top:3px}
    .details{background:rgba(255,255,255,.03);padding:10px;border-radius:14px;border:1px solid rgba(255,255,255,.08)}
    .muted{opacity:.8}

  </style>
</head>
<body>

  <div class="muted">
    Washportal ·
    <a href="https://schluffi1220.github.io/washportal-dev/">← Portal</a>
    ·
    <a href="https://schluffi1220.github.io/washportal-dev/privacy/">Datenschutz</a>
  </div>

  <h2>Benutzerverwaltung</h2>

  <div class="card">
    <div class="top">
      <input id="adminPw" type="password" placeholder="Super-Admin Passwort" />
      <button id="btnLoad">Liste laden</button>
      <span id="msg" class="muted"></span>
    </div>
    <div class="muted" style="margin-top:8px">
      Freischalten deaktiviert automatisch den bisherigen aktiven Patientensprecher / Stellvertreter derselben Rolle.
    </div>
  </div>

  <div class="card">
    <div class="top" style="justify-content:space-between">
      <h3 style="margin:0">Registrierungen</h3>
      <select id="filterRole">
        <option value="">Alle Rollen</option>
        <option value="ps">Patientensprecher</option>
        <option value="ps_deputy">Stellvertreter</option>
        <option value="admin">Admin</option>
      </select>
    </div>
    <div id="tbl" style="margin-top:8px"></div>
  </div>

  <script>
  const API_BASE = "https://washportal-dev-worker.schluffi1220.workers.dev";

  const $ = (id)=>document.getElementById(id);
  const esc = (s)=>String(s??"").replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));

  function badge(status){
    if (status==="active") return `<span class="badge b-active">active</span>`;
    if (status==="disabled") return `<span class="badge b-disabled">disabled</span>`;
    return `<span class="badge b-pending">pending</span>`;
  }
  function roleLabel(r){
    if (r==="ps") return "Patientensprecher";
    if (r==="ps_deputy") return "Stellv. Patientensprecher";
    if (r==="admin") return "Admin";
    return r || "";
  }

  async function jpost(path, body){
    const r = await fetch(API_BASE + path, {
      method:"POST",
      headers:{"content-type":"application/json"},
      body: JSON.stringify(body||{})
    });
    const t = await r.text();
    let data={}; try{ data=t?JSON.parse(t):{} }catch(_){ data={raw:t} }
    if (!r.ok) throw {status:r.status,data};
    return data;
  }

  let __users = [];
  let __perms = [];
  let __userPerms = []; // rows {userId,permKey,allowed}

  function userPermMap(){
    const m = new Map();
    for (const row of (__userPerms||[])){
      if (!m.has(row.userId)) m.set(row.userId, new Map());
      m.get(row.userId).set(row.permKey, !!row.allowed);
    }
    return m;
  }

  async function loadUsers(){
    const pw = ($("adminPw").value||"").trim();
    if (!pw) return ($("msg").textContent="⛔ Admin-Passwort fehlt");
    $("msg").textContent = "lade…";
    try{
      const res = await jpost("/api/admin/auth/users/list", { adminPassword: pw });
      __users = res.users || [];
      __perms = res.perms || [];
      __userPerms = res.userPerms || [];
      $("msg").textContent = `ok (${__users.length})`;
      render();
    }catch(e){
      console.error(e);
      $("msg").textContent = `⛔ Fehler (HTTP ${e?.status||"?"})`;
      $("tbl").innerHTML = "";
    }
  }

  function render(){
    const f = $("filterRole").value;
    const users = f ? __users.filter(u=>u.role===f || u.role2===f) : __users;
    const permByUser = userPermMap();

    const rows = users.map(u=>{
      const approveDisabled = u.status === "active";
      const codeDisabled = u.status !== "active";

      const detailId = `d_${u.id}`;
      const roleSelId = `r_${u.id}`;
      const role2SelId = `r2_${u.id}`;

      const permRows = __perms.map(p=>{
        const on = permByUser.get(u.id)?.get(p.permKey) ?? true; // default true
        const cid = `p_${u.id}_${p.permKey.replace(/[^a-zA-Z0-9_-]/g,"_")}`;
        return `<label class="perm">
          <input type="checkbox" id="${cid}" data-user="${esc(u.id)}" data-perm="${esc(p.permKey)}" ${on?"checked":""}/>
          <span class="mono">${esc(p.permKey)}</span> <span class="muted">– ${esc(p.label||"")}</span>
        </label>`;
      }).join("");

      return `<tr>
        <td class="mono">${esc(u.id)}</td>
        <td>${esc(u.firstName||"")} ${esc(u.lastName||"")}</td>
        <td>${esc(u.email||"")}</td>
        <td>
          <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
            <select id="${roleSelId}">
              ${["admin","ps","ps_deputy"].map(r=>`<option value="${r}" ${u.role===r?"selected":""}>${roleLabel(r)}</option>`).join("")}
            </select>
            <span class="muted small">+ Zweitrolle</span>
            <select id="${role2SelId}">
              <option value="">(keine)</option>
              ${["admin","ps","ps_deputy"].map(r=>`<option value="${r}" ${u.role2===r?"selected":""}>${roleLabel(r)}</option>`).join("")}
            </select>
          </div>
        </td>
        <td>${badge(u.status)}</td>
        <td>
          <div class="rowbtns">
            <button ${approveDisabled?"disabled":""} onclick="approve('${esc(u.id)}')">Freischalten</button>
            <button ${codeDisabled?"disabled":""} onclick="genCode('${esc(u.id)}')">Login-Code</button>
            <button onclick="toggleDetails('${detailId}')">Details</button>
            <button class="primary" onclick="saveUser('${esc(u.id)}')">Speichern</button>
          </div>
          <div id="${detailId}" class="details" style="display:none;margin-top:10px">
            <div class="small muted" style="margin-bottom:8px">Berechtigungen (Haken entfernen = Zugriff sperren):</div>
            <div class="permgrid">${permRows}</div>
          </div>
        </td>
      </tr>`;
    }).join("");

    $("tbl").innerHTML = `
      <table>
        <thead>
          <tr>
            <th>ID</th><th>Name</th><th>Email</th><th>Rolle</th><th>Status</th><th>Aktionen</th>
          </tr>
        </thead>
        <tbody>${rows || `<tr><td colspan="6" class="muted">Keine Nutzer.</td></tr>`}</tbody>
      </table>
    `;
  }

  function toggleDetails(id){
    const el = document.getElementById(id);
    if (!el) return;
    el.style.display = (el.style.display==="none" || !el.style.display) ? "block" : "none";
  }

  async function approve(userId){
    const pw = ($("adminPw").value||"").trim();
    try{
      await jpost("/api/admin/auth/users/approve", { adminPassword: pw, userId });
      await loadUsers();
      alert("✅ freigeschaltet");
    }catch(e){
      alert("⛔ Freischalten fehlgeschlagen");
      console.error(e);
    }
  }

  async function genCode(userId){
    const pw = ($("adminPw").value||"").trim();
    try{
      const r = await jpost("/api/admin/auth/users/issue-code", { adminPassword: pw, userId });
      alert("Login-Code: " + r.code + "
Gültig bis: " + new Date(r.expiresAt).toLocaleString("de-DE"));
    }catch(e){
      alert("⛔ Code erstellen fehlgeschlagen");
      console.error(e);
    }
  }

  async function saveUser(userId){
    const pw = ($("adminPw").value||"").trim();
    if (!pw) return alert("Admin-Passwort fehlt");

    // roles
    const role = document.getElementById(`r_${userId}`)?.value || "";
    const role2 = document.getElementById(`r2_${userId}`)?.value || "";
    try{
      await jpost("/api/admin/auth/users/set-role", { adminPassword: pw, userId, role, role2 });
    }catch(e){
      alert("⛔ Rolle speichern fehlgeschlagen");
      console.error(e);
      return;
    }

    // perms (send one-by-one, safe + simple)
    const boxes = document.querySelectorAll(`input[type="checkbox"][data-user="${CSS.escape(userId)}"]`);
    try{
      for (const b of boxes){
        const permKey = b.getAttribute("data-perm");
        const allowed = b.checked;
        await jpost("/api/admin/auth/users/set-perm", { adminPassword: pw, userId, permKey, allowed });
      }
      await loadUsers();
      alert("✅ gespeichert");
    }catch(e){
      alert("⛔ Berechtigungen speichern fehlgeschlagen");
      console.error(e);
    }
  }

  window.loadUsers = loadUsers;
  window.approve = approve;
  window.genCode = genCode;
  window.toggleDetails = toggleDetails;
  window.saveUser = saveUser;

</script>

</body>
</html>
