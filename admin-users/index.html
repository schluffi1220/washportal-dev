<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Washportal – Admin (Benutzer, Rollen & Rechte)</title>
<style>
:root{--bg:#0b0f14;--panel:#0f1621;--border:#223042;--txt:#e7eef7;--muted:#9fb0c5;--ok:#28d17c;--bad:#ff5a6a;--warn:#ffcc66}
*{box-sizing:border-box}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:16px;background:var(--bg);color:var(--txt)}
a{color:inherit}
input,select,button,textarea{font:inherit;padding:8px;border-radius:10px;border:1px solid var(--border);background:var(--panel);color:var(--txt);width:100%}
button{cursor:pointer;white-space:nowrap}
small{color:var(--muted)}
h1{font-size:20px;margin:0 0 10px}
h2{font-size:16px;margin:0 0 10px}
.card{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid var(--border);border-radius:18px;padding:14px}
.grid{display:grid;grid-template-columns:1fr;gap:12px}
@media(min-width:980px){.grid{grid-template-columns:1.15fr .85fr}}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.row > *{flex:1 1 220px}
.row.compact > *{flex:0 0 auto}
.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:12px;white-space:pre-wrap;word-break:break-word}
.pills{display:flex;gap:8px;flex-wrap:wrap}
.pill{padding:4px 10px;border:1px solid var(--border);border-radius:999px;color:var(--muted);font-size:12px}
.pill.ok{border-color:rgba(40,209,124,.5);color:var(--ok)}
.pill.bad{border-color:rgba(255,90,106,.5);color:var(--bad)}
.topnav{position:sticky;top:0;background:rgba(11,15,20,.9);backdrop-filter:blur(10px);padding:10px 0;z-index:5}
.tabs{display:flex;gap:8px;overflow:auto;padding-bottom:6px}
.tab{flex:0 0 auto;padding:10px 12px;border-radius:999px;border:1px solid var(--border);background:transparent;color:var(--muted)}
.tab.active{background:rgba(255,255,255,.06);color:var(--txt);border-color:rgba(255,255,255,.18)}
.toastWrap{position:fixed;left:16px;right:16px;bottom:16px;display:flex;flex-direction:column;gap:8px;z-index:50}
.toast{border:1px solid var(--border);background:rgba(15,22,33,.96);border-radius:14px;padding:10px 12px;display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
.toast strong{display:block;font-size:13px}
.toast small{display:block}
.toast.ok{border-color:rgba(40,209,124,.45)}
.toast.bad{border-color:rgba(255,90,106,.45)}
.kv{display:grid;grid-template-columns:120px 1fr;gap:8px;align-items:center}
.kv div:first-child{color:var(--muted);font-size:12px}
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:10px 8px;border-bottom:1px solid rgba(34,48,66,.7);text-align:left;vertical-align:top}
.table th{color:var(--muted);font-weight:600;font-size:12px}
.miniBtn{padding:6px 8px;font-size:12px}
.badge{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid var(--border);font-size:12px}
.badge.role{color:#d6e5ff}
.section{display:none}
.section.active{display:block}
.permGroup{border:1px solid rgba(34,48,66,.7);border-radius:14px;padding:10px;margin:8px 0;background:rgba(15,22,33,.6)}
.permRow{display:flex;gap:10px;align-items:flex-start;padding:8px 0;border-top:1px solid rgba(34,48,66,.5)}
.permRow:first-child{border-top:none}
.permKey{flex:1 1 auto}
.permKey b{font-size:12px}
.permKey small{display:block;margin-top:2px}
.permRow input[type="checkbox"]{width:20px;height:20px;flex:0 0 auto;margin-top:2px}

@media (max-width: 900px){
  .grid2{ grid-template-columns: 1fr !important; }
  .topRow{ grid-template-columns: 1fr !important; }
  .helpPanel{ display:none !important; }
  .tabs{ position: sticky; top:0; background: rgba(10,12,18,.95); z-index: 50; padding-bottom: 6px; }
  button{ padding: 14px 14px; font-size: 16px; }
  input, select{ font-size: 16px; padding: 12px; }
  .card{ border-radius: 16px; }
}

</style>
</head>
<body>
<div class="topnav">
  <h1>Benutzerverwaltung (Admin-User) – mobile first</h1>
  <div class="tabs" id="tabs">
    <button class="tab active" data-tab="users">Benutzer</button>
    <button class="tab" data-tab="rbac">Rollen & Rechte</button>
    <button class="tab" data-tab="config">Konfig</button>
    <button class="tab" data-tab="bookings">Buchungen</button>
    <button class="tab" data-tab="logs">Logs</button>
    <button class="tab" data-tab="locks">Zimmersperren</button>
    <button class="tab" data-tab="news">News</button>
    <button class="tab" data-tab="feedback">Feedback</button>
    <button class="tab" data-tab="chat">Chat</button>
    <button class="tab" data-tab="media">Bilder</button>
    <button class="tab" data-tab="whitecard">Whitecard</button>
  </div>
</div>

<div class="grid">
  <div class="card">
    <h2>Verbindung</h2>
    <div class="row">
      <div>
        <div class="kv"><div>BASE</div><div><input id="base" value="https://washportal-dev-worker.schluffi1220.workers.dev"/></div></div>
        <small>Alle Admin-Funktionen laufen über diese Worker-BASE (CORS aktiv).</small>
      </div>
      <div>
        <div class="kv"><div>Bearer Token</div><div><input id="bearer" placeholder="optional (Admin/PS/SV Token)"/></div></div>
        <small>Wenn leer, kannst du trotzdem per SA-Header arbeiten.</small>
      </div>
      <div>
        <div class="kv"><div>SA Passwort</div><div><input id="sa" type="password" placeholder="optional (SA)"/></div></div>
        <small>SA wird per <span class="mono">x-sa-password</span> gesendet.</small>
      </div>
    </div>
    <div class="row compact" style="margin-top:10px">
      <button class="miniBtn" id="btnStatus">/api/_status</button>
      <button class="miniBtn" id="btnMe">/api/auth/me</button>
      <button class="miniBtn" id="btnSaLogin">SA-Login</button>
      <button class="miniBtn" id="btnUsers">Benutzer laden</button>
      <button class="miniBtn" id="btnRbac">RBAC laden</button>
    </div>
    <div class="pills" style="margin-top:10px">
      <span class="pill" id="pillBuild">build: –</span>
      <span class="pill" id="pillAuth">auth: –</span>
    </div>
    <div class="mono" id="out" style="margin-top:10px;max-height:240px;overflow:auto"></div>
  </div>

  <div class="card">
    <h2>Hinweise</h2>
    <ul style="margin:0;padding-left:18px;color:var(--muted)">
      <li><b>PS & SV nur einmal:</b> Das erzwingt der Worker beim Rollen setzen (PS→SV→User).</li>
      <li><b>Rechte:</b> Im Tab <b>Rollen & Rechte</b> kannst du RolePerms pro Rolle setzen (SA empfohlen).</li>
      <li><b>Mobile:</b> Tabellen werden als Cards/kompakte Zeilen dargestellt. Am PC wird’s breiter.</li>
    </ul>
  </div>
</div>

<!-- SECTIONS -->
<div class="section active" id="sec-users" style="margin-top:12px">
  <div class="card">
    <div class="row">
      <div><h2>Benutzer</h2><small>Rollen setzen / User anzeigen</small></div>
      <div><input id="userFilter" placeholder="Filter (E-Mail / Name / Rolle)"/></div>
      <div><button id="btnFilter">Filter</button></div>
    </div>
    <div id="usersWrap" style="margin-top:8px"></div>
  </div>
</div>

<div class="section" id="sec-rbac" style="margin-top:12px">
  <div class="card">
    <div class="row">
      <div>
        <h2>Rollen & Rechte (RBAC)</h2>
        <small>SA empfohlen. Änderungen wirken sofort.</small>
      </div>
      <div>
        <select id="rbacRole">
          <option value="admin">Admin</option>
          <option value="ps">PS</option>
          <option value="ps_deputy">SV</option>
          <option value="user">User</option>
          <option value="super_admin">SA</option>
        </select>
      </div>
      <div><input id="permSearch" placeholder="Permission suchen (z.B. bookings, logs, delete)"/></div>
      <div class="row compact">
        <button class="miniBtn" id="btnRbacLoad2">RBAC laden</button>
        <button class="miniBtn" id="btnRbacSave">Speichern</button>
      </div>
    </div>
    <div id="rbacWrap" style="margin-top:10px"></div>
  </div>
</div>

<!-- placeholders -->
<div class="section" id="sec-config" style="margin-top:12px"><div class="card"><h2>Konfig</h2><small>kommt als nächstes – wird nach Rechten sichtbar/änderbar.</small></div></div>
<div class="section" id="sec-bookings" style="margin-top:12px"><div class="card"><h2>Buchungen</h2><small>kommt als nächstes – inkl. Filter M1/M2/M3 und Storno.</small></div></div>
<div class="section" id="sec-logs" style="margin-top:12px"><div class="card"><h2>Logs</h2><small>kommt als nächstes – alle Änderungen, Buchungen, Konfig, etc.</small></div></div>
<div class="section" id="sec-locks" style="margin-top:12px"><div class="card"><h2>Zimmersperren</h2><small>kommt als nächstes – PIN-unabhängig, inkl. Nachricht + Verlauf.</small></div></div>
<div class="section" id="sec-news" style="margin-top:12px"><div class="card"><h2>News</h2><small>kommt als nächstes – Sender PS/SV oder Admin auswählbar.</small></div></div>
<div class="section" id="sec-feedback" style="margin-top:12px"><div class="card"><h2>Feedback</h2><small>kommt als nächstes – Empfänger PS/SV+Admin oder nur Admin.</small></div></div>
<div class="section" id="sec-chat" style="margin-top:12px"><div class="card"><h2>Chat</h2><small>kommt als nächstes – globaler Toggle (Admin kann aus, PS/SV nicht wieder an).</small></div></div>
<div class="section" id="sec-media" style="margin-top:12px"><div class="card"><h2>Bilder</h2><small>kommt als nächstes – Upload Waschmaschine/Trockner + Popup-Haken.</small></div></div>
<div class="section" id="sec-whitecard" style="margin-top:12px"><div class="card"><h2>Whitecard</h2><small>kommt als nächstes – Überbuchung + weiße Kachel.</small></div></div>

<div class="toastWrap" id="toasts"></div>

<script>
const $ = (id)=>document.getElementById(id);

function toast(type, title, msg){
  const wrap = $("toasts");
  const el = document.createElement("div");
  el.className = "toast " + (type||"");
  el.innerHTML = `<div><strong>${escapeHtml(title||"")}</strong><small>${escapeHtml(msg||"")}</small></div>
                  <button class="miniBtn" aria-label="close">✕</button>`;
  el.querySelector("button").onclick = ()=>el.remove();
  wrap.appendChild(el);
  setTimeout(()=>{ if(el.isConnected) el.remove(); }, 5200);
}

function escapeHtml(s){ return String(s??"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }

function getBase(){ return ($("base").value||"").replace(/\/$/,""); }
function looksLikeToken(v){
  if(!v) return false;
  // crude JWT-ish check
  return v.split(".").length >= 3 || v.length > 40;
}

async function api(path, opts={}){
  const url = getBase() + path;
  const headers = new Headers(opts.headers||{});
  headers.set("content-type","application/json");
  const sa = $("sa").value?.trim();
  if(sa) headers.set("x-sa-password", sa);

  const bearer = $("bearer").value?.trim();
  if(bearer && looksLikeToken(bearer)) headers.set("authorization","Bearer " + bearer);

  const res = await fetch(url, { ...opts, headers, mode:"cors" });
  const txt = await res.text();
  let data; try{ data = JSON.parse(txt); }catch{ data = { raw: txt }; }
  return { ok: res.ok, status: res.status, data };
}

function showOut(obj){
  $("out").textContent = JSON.stringify(obj, null, 2);
  if(obj?.data?.build) $("pillBuild").textContent = "build: " + obj.data.build;
}

let SNAPSHOT = null;

async function loadStatus(){
  const r = await api("/api/_status", { method:"GET" });
  showOut(r.data || r);
  if(r.ok) toast("ok","Status","Worker erreichbar");
  else toast("bad","Status",`HTTP ${r.status}`);
}

async function loadMe(){
  const r = await api("/api/auth/me",{ method:"GET" });
  showOut(r.data || r);
  $("pillAuth").textContent = "auth: " + (r.ok ? "ok" : "no");
  if(!r.ok) toast("bad","Auth",`/me: HTTP ${r.status}`);
  else toast("ok","Auth","/me ok");
  return r;
}

async function saLogin(){
  // SA-Login ist ein Schnelltest: wenn /me klappt, ist SA Header ok.
  const r = await loadMe();
  try { await loadRbac(); } catch(e) {}
  try { activateTab('rbac'); } catch(e) {}
  return r;
}

function normalizeUser(u){
  const roleMap = { admin:"Admin", ps:"PS", ps_deputy:"SV", user:"User", super_admin:"SA", superadmin:"SA" };
  return {
    id: u.id, email: u.email||"", name: [u.firstName,u.lastName].filter(Boolean).join(" ").trim(),
    role: u.role, roleLabel: roleMap[u.role] || u.role || "?", status: u.status||""
  };
}

function renderUsers(list){
  const wrap = $("usersWrap");
  wrap.innerHTML = "";
  if(!list?.length){
    wrap.innerHTML = `<small>Keine Benutzer geladen.</small>`;
    return;
  }
  // mobile-friendly rows
  const table = document.createElement("table");
  table.className = "table";
  table.innerHTML = `<thead><tr><th>E-Mail</th><th>Name</th><th>Rolle</th><th>Status</th><th>Aktion</th></tr></thead>`;
  const tb = document.createElement("tbody");
  for(const u0 of list){
    const u = normalizeUser(u0);
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHtml(u.email)}</td>
      <td>${escapeHtml(u.name||"")}</td>
      <td><span class="badge role">${escapeHtml(u.roleLabel)}</span></td>
      <td>${escapeHtml(u.status||"")}</td>
      <td>
        <div class="row compact" style="gap:8px">
          <select data-id="${u.id}" class="roleSel">
            <option value="user">User</option>
            <option value="ps">PS</option>
            <option value="ps_deputy">SV</option>
            <option value="admin">Admin</option>
          </select>
          <button class="miniBtn saveRole" data-id="${u.id}">Speichern</button>
        </div>
      </td>`;
    tb.appendChild(tr);
    tr.querySelector(".roleSel").value = u.role || "user";
  }
  table.appendChild(tb);
  wrap.appendChild(table);

  wrap.querySelectorAll(".saveRole").forEach(btn=>{
    btn.onclick = async ()=>{
      const id = btn.getAttribute("data-id");
      const sel = wrap.querySelector(`select.roleSel[data-id="${id}"]`);
      const role = sel.value;
      const r = await api("/api/auth/admin/users/set-role", { method:"POST", body: JSON.stringify({ id:Number(id), role }) });
      showOut(r.data || r);
      if(r.ok) toast("ok","Rolle gesetzt",`User ${id} → ${role}`);
      else toast("bad","Fehler", r.data?.data?.message || r.data?.message || ("HTTP "+r.status));
    };
  });
}

async function loadUsers(){
  const r = await api("/api/auth/admin/users/list", { method:"POST", body: JSON.stringify({}) });
  showOut(r.data || r);
  if(!r.ok){ toast("bad","Benutzer", `HTTP ${r.status}`); return; }
  const users = r.data?.data?.users || r.data?.users || r.data?.data || [];
  window.__users = users;
  toast("ok","Benutzer","geladen");
  applyUserFilter();
}

function applyUserFilter(){
  const q = ($("userFilter").value||"").toLowerCase().trim();
  const list = (window.__users || []);
  if(!q){ renderUsers(list); return; }
  const f = list.filter(u=>{
    const s = [u.email,u.firstName,u.lastName,u.role,u.role2,u.status].filter(Boolean).join(" ").toLowerCase();
    return s.includes(q);
  });
  renderUsers(f);
}

function groupPerms(catalog){
  // catalog: array of {key, name/label, desc/description}
  const groups = {};
  for(const p of catalog){
    const k = p.key || p.perm || p.name;
    if(!k) continue;
    const g = k.split(".")[0];
    (groups[g] ||= []).push({ key:k, desc: p.description||p.desc||p.label||"" });
  }
  for(const g of Object.keys(groups)){
    groups[g].sort((a,b)=>a.key.localeCompare(b.key));
  }
  return groups;
}

function renderRbac(){
  const wrap = $("rbacWrap");
  wrap.innerHTML = "";
  if(!SNAPSHOT){
    wrap.innerHTML = `<small>Noch nichts geladen. Klick <b>RBAC laden</b>.</small>`;
    return;
  }
  const role = $("rbacRole").value;
  const rolePerms = (SNAPSHOT.rolePerms && (SNAPSHOT.rolePerms[role] || SNAPSHOT.rolePerms[role.replace("_","")] )) || SNAPSHOT.roles?.[role] || {};
  const catalog = SNAPSHOT.catalog || SNAPSHOT.permCatalog || [];
  if(!catalog.length){
    wrap.innerHTML = `<div style="padding:10px;border:1px solid rgba(255,204,102,.35);border-radius:14px;background:rgba(255,204,102,.06)"><b style="color:var(--warn)">Keine Permissions im Katalog gefunden.</b><br><small>Das heißt: In <span class="mono">auth_permissions</span> sind 0 Einträge. Deploy bitte <b>Worker_FIXED_v10.js</b> und klicke danach erneut <b>RBAC laden</b>.</small></div>`;
    return;
  }
  const q = ($("permSearch").value||"").toLowerCase().trim();

  const groups = groupPerms(catalog);
  const keys = Object.keys(groups).sort();

  for(const g of keys){
    const box = document.createElement("div");
    box.className = "permGroup";
    box.innerHTML = `<div class="row compact" style="justify-content:space-between">
        <b>${escapeHtml(g)}</b>
        <small>${groups[g].length} perms</small>
      </div>`;
    let any = false;
    for(const p of groups[g]){
      if(q && !p.key.toLowerCase().includes(q) && !(p.desc||"").toLowerCase().includes(q)) continue;
      any = true;
      const row = document.createElement("div");
      row.className = "permRow";
      const checked = !!rolePerms[p.key];
      row.innerHTML = `
        <input type="checkbox" data-perm="${escapeHtml(p.key)}" ${checked?"checked":""}/>
        <div class="permKey">
          <b class="mono">${escapeHtml(p.key)}</b>
          ${p.desc?`<small>${escapeHtml(p.desc)}</small>`:""}
        </div>`;
      box.appendChild(row);
    }
    if(any) wrap.appendChild(box);
  }

  if(!wrap.children.length){
    wrap.innerHTML = `<small>Nichts gefunden für diesen Filter.</small>`;
  }
}

async function loadRbac(){
  const r = await api("/api/auth/admin/rbac/snapshot", { method:"GET" });
  showOut(r.data || r);
  if(!r.ok){ toast("bad","RBAC", `HTTP ${r.status}`); return; }

  const d = r.data?.data || r.data || {};
  // catalog can come as catalog/permCatalog/permsCatalog/results...
  const catalog =
    (d.catalog && (d.catalog.results||d.catalog)) ||
    (d.permCatalog && (d.permCatalog.results||d.permCatalog)) ||
    (d.permsCatalog && (d.permsCatalog.results||d.permsCatalog)) ||
    [];

  // role perms can come as map OR as rows [{role,permKey,allowed}]
  let rolePerms = d.rolePerms || d.roles || d.role_perms || {};
  if (Array.isArray(rolePerms)) {
    const map = {};
    for (const row of rolePerms) {
      const rr = String(row.role||"");
      if(!map[rr]) map[rr] = {};
      map[rr][String(row.permKey)] = !!row.allowed;
    }
    rolePerms = map;
  }
  if (Array.isArray(d.rolePermsRows)) {
    // ignore; already mapped by worker v9
  }

  SNAPSHOT = {
    build: d.build,
    users: d.users || [],
    catalog,
    rolePerms,
    userPerms: d.userPerms || {}
  };

  toast("ok","RBAC","geladen");
  renderRbac();
}

async function saveRbac(){
  if(!SNAPSHOT){ toast("bad","RBAC","Bitte zuerst RBAC laden"); return; }
  const role = $("rbacRole").value;
  const wrap = $("rbacWrap");
  const perms = {};
  wrap.querySelectorAll("input[type=checkbox][data-perm]").forEach(cb=>{
    perms[cb.getAttribute("data-perm")] = cb.checked;
  });
  const r = await api("/api/auth/admin/rbac/role/set", { method:"POST", body: JSON.stringify({ role, perms }) });
  showOut(r.data || r);
  if(r.ok){ toast("ok","RBAC","gespeichert"); await loadRbac(); }
  else toast("bad","RBAC", r.data?.data?.message || r.data?.message || ("HTTP "+r.status));
}

function setTab(name){
  document.querySelectorAll(".tab").forEach(b=>b.classList.toggle("active", b.dataset.tab===name));
  document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
  const sec = $("sec-"+name);
  if(sec) sec.classList.add("active");
}

document.querySelectorAll(".tab").forEach(b=>{
  b.onclick = ()=>setTab(b.dataset.tab);
});

$("btnStatus").onclick = loadStatus;
$("btnMe").onclick = loadMe;
$("btnSaLogin").onclick = saLogin;
$("btnUsers").onclick = loadUsers;
$("btnRbac").onclick = loadRbac;
$("btnRbacLoad2").onclick = loadRbac;
$("btnRbacSave").onclick = saveRbac;
$("btnFilter").onclick = applyUserFilter;
$("userFilter").addEventListener("input", ()=>applyUserFilter());
$("permSearch").addEventListener("input", ()=>renderRbac());
$("rbacRole").addEventListener("change", ()=>renderRbac());
$("sa").addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ e.preventDefault(); saLogin(); } });

</script>
</body>
</html>
